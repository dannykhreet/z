<?xml version="1.0" encoding="utf-8" ?>
<Grid 
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    x:Class="EZGO.Maui.Controls.DataTemplates.LinearItemTemplate"
    xmlns:buttons="clr-namespace:Syncfusion.Maui.Buttons;assembly=Syncfusion.Maui.Buttons"
    xmlns:classes="clr-namespace:EZGO.Maui.Classes"
    xmlns:controls="clr-namespace:EZGO.Maui.Controls"
    xmlns:customButtons="clr-namespace:EZGO.Maui.Controls.Buttons"
    x:Name="ListItemViewCell"
    BackgroundColor="White">
    <Grid.ColumnDefinitions>
        <ColumnDefinition Width="160" />
        <ColumnDefinition Width="*" />
        <ColumnDefinition Width="Auto" />
    </Grid.ColumnDefinitions>

    <Grid.GestureRecognizers>
        <TapGestureRecognizer Command="{Binding DetailCommand, Source={x:Reference ListItemViewCell}}" CommandParameter="{Binding .}" />
    </Grid.GestureRecognizers>

    <!--  Item Start  -->
    <StackLayout
        Grid.Column="0"
        CompressedLayout.IsHeadless="True"
        Spacing="0">

        <!--  Status Line  -->
        <BoxView HeightRequest="5">

            <BoxView.BackgroundColor>
                <MultiBinding Converter="{StaticResource AuditScoreColorConverter}">
                    <Binding Path="Score" />
                    <Binding Path="ScoreColorCalculator" Source="{x:Reference ListItemViewCell}" />
                    <Binding Path="FilterStatus" />
                </MultiBinding>
            </BoxView.BackgroundColor>
        </BoxView>

        <!--  Item Image  -->
        <controls:CustomImageOnline
            Aspect="AspectFill"
            HeightRequest="105"
            ImageUrl="{Binding DisplayPicture}"
            IsOpaque="True" />
    </StackLayout>

    <!--  Item Name  -->
    <Label
        Grid.Column="1"
        Padding="20,0,0,0"
        LineBreakMode="TailTruncation"
        MaxLines="5"
        Text="{Binding Name}"
        VerticalOptions="Center" />

    <!--  Item Buttons  -->
    <StackLayout
        Grid.Row="0"
        Grid.Column="2"
        Padding="0,0,15,0"
        Orientation="Horizontal"
        Spacing="5"
        VerticalOptions="Center">

        <!--  Machine status  -->
        <buttons:SfButton
            x:Name="MachineStatus"
            Background="{Binding TaskMachineStatus, Converter={StaticResource StatusToColorConverter}}"
            InputTransparent="True"
            IsVisible="{Binding PlannedTime, Converter={StaticResource IsNullConverter}, ConverterParameter=False}"
            Style="{StaticResource WhiteBorderButton}">
            <buttons:SfButton.Content>
                <DataTemplate>
                    <Label
                        FontSize="20"
                        HorizontalOptions="CenterAndExpand"
                        LineBreakMode="TailTruncation"
                        Text="{Binding PlannedTime}"
                        TextColor="White"
                        VerticalOptions="CenterAndExpand" />
                </DataTemplate>
            </buttons:SfButton.Content>
        </buttons:SfButton>

        <!--  Deeplink  -->
        <AbsoluteLayout
            x:Name="DeepLinkButton"
            IsVisible="{Binding DeepLinkId, Converter={StaticResource IsNullConverter}, ConverterParameter=False}"
            VerticalOptions="Center">
            <!--  Deeplink button  -->
            <customButtons:DeepLinkButton
                Command="{Binding DeepLinkCommand, Source={x:Reference ListItemViewCell}}"
                CommandParameter="{Binding .}"
                FontSize="24"
                InitialBorderColor="{StaticResource GreyColor}"
                IsValid="{Binding IsDeepLinkValid}"
                Style="{StaticResource GreyBorderButton}"
                VerticalOptions="Center" />

            <!--  badge  -->
            <Label
                x:Name="deepLinkBadge"
                Margin="33,-8,0,0"
                FontFamily="FAS"
                FontSize="Small"
                HorizontalOptions="CenterAndExpand"
                HorizontalTextAlignment="Center"
                IsVisible="{Binding DeepLinkCompletionIsRequired}"
                Text="{x:Static classes:IconFont.Asterisk}"
                TextColor="{StaticResource RedColor}"
                VerticalOptions="CenterAndExpand">
                <Label.Triggers>
                    <DataTrigger
                        Binding="{Binding CompletedDeeplinkId, Converter={StaticResource IsNullConverter}}"
                        TargetType="Label"
                        Value="True">
                        <Setter Property="TextColor" Value="{StaticResource RedColor}" />
                    </DataTrigger>
                    <DataTrigger
                        Binding="{Binding CompletedDeeplinkId, Converter={StaticResource IsNullConverter}}"
                        TargetType="Label"
                        Value="False">
                        <Setter Property="TextColor" Value="{StaticResource GreenColor}" />
                    </DataTrigger>
                </Label.Triggers>
            </Label>
        </AbsoluteLayout>

        <!--  Actions  -->
        <customButtons:ActionButton
            ActionBubbleCount="{Binding ActionBubbleCount}"
            Command="{Binding ActionCommand, Source={x:Reference ListItemViewCell}}"
            CommandParameter="{Binding .}"
            IconSize="24"
            Style="{StaticResource ActionBorderButton}" />

        <!--  Skip  -->
        <customButtons:SkipButton
            ButtonColor="{StaticResource GreyColor}"
            ButtonInitColor="{StaticResource GreyColor}"
            Command="{Binding SkipCommand, Source={x:Reference ListItemViewCell}}"
            CommandParameter="{Binding .}"
            FilterStatus="{Binding FilterStatus}"
            IconColor="{StaticResource GreyColor}"
            IsBlocked="{Binding IsStageLocked}"
            IsSkippedTextVisible="False" />


        <!--  Not Ok  -->
        <AbsoluteLayout IsVisible="{Binding IsScoreButtonVisible, Source={x:Reference ListItemViewCell}, Converter={StaticResource ReverseBooleanConverter}}">
            <customButtons:ThumbDownButton
                ButtonColor="{StaticResource GreyColor}"
                ButtonInitColor="{StaticResource GreyColor}"
                Command="{Binding NotOkCommand, Source={x:Reference ListItemViewCell}}"
                CommandParameter="{Binding .}"
                IconColor="{StaticResource GreyColor}"
                IsBlocked="{Binding IsStageLocked}"
                Status="{Binding FilterStatus}"
                Style="{StaticResource GreyBorderButton}" />

            <!--  Picture proof indicators  -->
            <BoxView
                x:Name="thumbsDownVerticalBoxView"
                IsVisible="{Binding HasPictureProof}"
                Color="{StaticResource GreyColor}" />
            <BoxView
                x:Name="thumbsDownHorizontalBoxView"
                IsVisible="{Binding HasPictureProof}"
                Color="{StaticResource GreyColor}" />

            <!--  Camera icon  -->
            <Label
                x:Name="icon"
                FontFamily="{StaticResource MaterialFontFamily}"
                FontSize="Small"
                HorizontalOptions="Center"
                HorizontalTextAlignment="Center"
                IsVisible="{Binding HasPictureProof}"
                Text="{x:Static classes:IconFont.CameraAlt}"
                TextColor="{StaticResource GreyColor}" />

            <!--  badge  -->
            <buttons:SfButton
                Margin="30,-5,0,0"
                Background="{StaticResource RedColor}"
                CornerRadius="12"
                HeightRequest="16"
                IsVisible="{Binding IsThumbsDownBadgeVisible}"
                Stroke="White"
                StrokeThickness="1"
                WidthRequest="16">
                <buttons:SfButton.Content>
                    <DataTemplate>
                        <Label
                            FontFamily="{StaticResource MaterialFontFamily}"
                            FontSize="10"
                            HorizontalOptions="CenterAndExpand"
                            HorizontalTextAlignment="Center"
                            Text="{x:Static classes:IconFont.CameraAlt}"
                            TextColor="White"
                            VerticalOptions="CenterAndExpand"
                            VerticalTextAlignment="Center" />
                    </DataTemplate>
                </buttons:SfButton.Content>
            </buttons:SfButton>
        </AbsoluteLayout>


        <!--  Ok  -->
        <AbsoluteLayout IsVisible="{Binding IsScoreButtonVisible, Source={x:Reference ListItemViewCell}, Converter={StaticResource ReverseBooleanConverter}}">
            <customButtons:ThumbUpButton
                Style="{StaticResource GreyBorderButton}"
                Command="{Binding OkCommand, Source={x:Reference ListItemViewCell}}"
                ButtonInitColor="{StaticResource GreyColor}"
                IconColor="{StaticResource GreyColor}"
                CommandParameter="{Binding .}"
                Status="{Binding FilterStatus}"
                IsBlocked="{Binding IsStageLocked}" />

            <!--  Picture proof indicators  -->
            <BoxView
                x:Name="thumbsUpVerticalBoxView"
                IsVisible="{Binding HasPictureProof}"
                Color="{StaticResource GreyColor}" />
            <BoxView
                x:Name="thumbsUpHorizontalBoxView"
                IsVisible="{Binding HasPictureProof}"
                Color="{StaticResource GreyColor}" />

            <!--  badge  -->
            <buttons:SfButton
                Margin="30,-5,0,0"
                Background="{StaticResource GreenColor}"
                CornerRadius="12"
                HeightRequest="16"
                IsVisible="{Binding IsThumbsUpBadgeVisible}"
                Stroke="White"
                StrokeThickness="1"
                WidthRequest="16">
                <buttons:SfButton.Content>
                    <DataTemplate>
                        <Label
                            FontFamily="{StaticResource MaterialFontFamily}"
                            FontSize="10"
                            HorizontalOptions="CenterAndExpand"
                            HorizontalTextAlignment="Center"
                            Text="{x:Static classes:IconFont.CameraAlt}"
                            TextColor="White"
                            VerticalOptions="CenterAndExpand"
                            VerticalTextAlignment="Center" />
                    </DataTemplate>
                </buttons:SfButton.Content>
            </buttons:SfButton>
        </AbsoluteLayout>

        <AbsoluteLayout IsVisible="{Binding IsScoreButtonVisible, Source={x:Reference ListItemViewCell}}">

            <!--  Score Button  -->
            <customButtons:ScoreButton
                ColorCalculator="{Binding ScoreColorCalculator, Source={x:Reference ListItemViewCell}}"
                Command="{Binding OpenPopupCommand, Source={x:Reference ListItemViewCell}}"
                CommandParameter="{Binding .}"
                EmptyBackgroundColor="{StaticResource GreyColor}"
                Score="{Binding Score}"
                Style="{StaticResource GreyBorderButton}" />

            <!--  badge  -->
            <buttons:SfButton
                Margin="30,-5,0,0"
                CornerRadius="12"
                HeightRequest="16"
                IsVisible="{Binding IsScoreBadgeVisible}"
                Stroke="White"
                StrokeThickness="1"
                WidthRequest="16">
                <buttons:SfButton.Background>
                    <MultiBinding Converter="{StaticResource AuditScoreColorConverter}">
                        <Binding Path="Score" />
                        <Binding Path="ScoreColorCalculator" Source="{x:Reference ListItemViewCell}" />
                        <Binding Path="FilterStatus" />
                    </MultiBinding>
                </buttons:SfButton.Background>
                <buttons:SfButton.Content>
                    <DataTemplate>
                        <Label
                            FontFamily="{StaticResource MaterialFontFamily}"
                            FontSize="10"
                            HorizontalOptions="CenterAndExpand"
                            HorizontalTextAlignment="Center"
                            Text="{x:Static classes:IconFont.CameraAlt}"
                            TextColor="White"
                            VerticalOptions="CenterAndExpand"
                            VerticalTextAlignment="Center" />
                    </DataTemplate>
                </buttons:SfButton.Content>
            </buttons:SfButton>

            <!--  Camera icon  -->
            <Label
                AbsoluteLayout.LayoutBounds="0.5, 1, -1, -1"
                AbsoluteLayout.LayoutFlags="PositionProportional"
                FontFamily="{StaticResource MaterialFontFamily}"
                FontSize="Small"
                HorizontalOptions="Center"
                HorizontalTextAlignment="Center"
                IsVisible="{Binding HasPictureProof}"
                Text="{x:Static classes:IconFont.CameraAlt}"
                TextColor="{StaticResource GreyColor}"
                TranslationX="-1"
                TranslationY="20"
                VerticalOptions="End" />
        </AbsoluteLayout>
    </StackLayout>
</Grid>
