<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="EZGO.Maui.Views.Audits.AuditSlidePage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:auditModels="clr-namespace:EZGO.Maui.Core.Models.Audits;assembly=EZGO.Maui.Core"
    xmlns:behaviors="clr-namespace:EZGO.Maui.Behaviors"
    xmlns:buttons="clr-namespace:Syncfusion.Maui.Buttons;assembly=Syncfusion.Maui.Buttons"
    xmlns:classes="clr-namespace:EZGO.Maui.Classes"
    xmlns:controls="clr-namespace:EZGO.Maui.Controls"
    xmlns:custom="clr-namespace:EZGO.Maui.Controls.ChecklistsOpenFields"
    xmlns:customButtons="clr-namespace:EZGO.Maui.Controls.Buttons"
    xmlns:customLabels="clr-namespace:EZGO.Maui.Controls.CustomLabels"
    xmlns:customProgressBar="clr-namespace:EZGO.Maui.Controls.ProgressBar"
    xmlns:datatemplates="clr-namespace:EZGO.Maui.Controls.DataTemplates"
    xmlns:ios="clr-namespace:Microsoft.Maui.Controls.PlatformConfiguration.iOSSpecific;assembly=Microsoft.Maui.Controls"
    xmlns:listview="clr-namespace:Syncfusion.Maui.ListView;assembly=Syncfusion.Maui.ListView"
    xmlns:panCardView="clr-namespace:PanCardView;assembly=PanCardView"
    xmlns:popup="clr-namespace:Syncfusion.Maui.Popup;assembly=Syncfusion.Maui.Popup"
    xmlns:popups="clr-namespace:EZGO.Maui.Controls.Popup"
    xmlns:processors="clr-namespace:PanCardView.Processors;assembly=PanCardView"
    xmlns:settings="clr-namespace:EZGO.Maui.Core.Classes;assembly=EZGO.Maui.Core"
    xmlns:tasks="clr-namespace:EZGO.Maui.Core.Models.Tasks;assembly=EZGO.Maui.Core"
    xmlns:viewCells="clr-namespace:EZGO.Maui.Controls.ViewCells"
    xmlns:viewCellsTemplates="clr-namespace:EZGO.Maui.Controls.ViewCells.Templates"
    x:Name="Page"
    Title="AuditSlidePage"
    ios:Page.UseSafeArea="True"
    HideSoftInputOnTapped="True"
    NavigationPage.HasBackButton="True"
    NavigationPage.HasNavigationBar="false">
    <ContentPage.Resources>

        <ResourceDictionary>

            <!--  Slide Item Template  -->
            <DataTemplate
                x:Key="CarouselItem"
                x:Name="Test"
                x:DataType="tasks:BasicTaskTemplateModel">
                <viewCells:TaskCarouselViewCell
                    CardPropertyWidth="{Binding BindingContext.DeviceFormat.PropertyWidth, Source={x:Reference Page}}"
                    CardWidth="{Binding BindingContext.DeviceFormat.ItemWidth, Source={x:Reference Page}}"
                    DetailCommand="{Binding BindingContext.DetailCommand, Source={x:Reference Page}}"
                    FullCardWidth="{Binding BindingContext.DeviceFormat.FullWidth, Source={x:Reference Page}}"
                    IsExtraInfoVisible="False"
                    PropertyCommand="{Binding BindingContext.OpenPopupCommand, Source={x:Reference Page}}" />
            </DataTemplate>

            <DataTemplate x:Key="SignButton">
                <viewCellsTemplates:SignButtonTemplate
                    CompleteText="{classes:Translate COMPLETE_AUDIT_BUTTON_TEXT}"
                    FontSize="30"
                    HeightRequest="450"
                    HorizontalOptions="CenterAndExpand"
                    IsSignatureRequired="{Binding BindingContext.IsSignatureRequired, Source={x:Reference Page}}"
                    SignCommand="{Binding BindingContext.SignCommand, Source={x:Reference Page}}"
                    SignText="{classes:Translate AUDIT_TASKS_SIGN_TEXT}"
                    TasksDone="{Binding BindingContext.OpenFields.TasksDone, Source={x:Reference Page}}"
                    TextHorizontalOption="Center"
                    VerticalOptions="CenterAndExpand"
                    WidthRequest="{Binding BindingContext.DeviceFormat.ItemWidth, Source={x:Reference Page}}" />
            </DataTemplate>

            <DataTemplate x:Key="ChecklistProperty">
                <custom:OpenChecklistFields
                    HeightRequest="450"
                    HorizontalOptions="CenterAndExpand"
                    IsFromSlideView="True"
                    PropertyList="{Binding BindingContext.OpenFields.PropertyList, Source={x:Reference Page}}"
                    SpanCount="1"
                    VerticalOptions="CenterAndExpand"
                    WidthRequest="{Binding BindingContext.DeviceFormat.ItemWidth, Source={x:Reference Page}}" />
            </DataTemplate>

            <classes:ChecklistSlideDataTemplateSelector
                x:Key="AuditSlideDataTemplateSelector"
                CarouselItemTemplate="{StaticResource CarouselItem}"
                ChecklistPropertyTemplate="{StaticResource ChecklistProperty}"
                SignButtonTemplate="{StaticResource SignButton}" />
        </ResourceDictionary>

    </ContentPage.Resources>


    <Grid>

        <!--  Task property popup  -->
        <popups:TaskPropertyPopupView ContentBindingContext="{Binding PropertyEditViewModel}" IsOpen="{Binding IsPopupOpen}" />

        <!--  Audit score popup  -->
        <popup:SfPopup
            x:Name="ScorePopup"
            Margin="0"
            Background="White"
            HeightRequest="75"
            IsOpen="{Binding IsScorePopupOpen}"
            ShowFooter="False"
            ShowHeader="False"
            ShowOverlayAlways="False"
            WidthRequest="{Binding ScoreWidth}">
            <popup:SfPopup.PopupStyle>
                <popup:PopupStyle CornerRadius="20" />
            </popup:SfPopup.PopupStyle>
            <popup:SfPopup.ContentTemplate>
                <DataTemplate>
                    <StackLayout Padding="0">
                        <listview:SfListView
                            Margin="0"
                            Padding="5"
                            CachingStrategy="RecycleTemplate"
                            ItemSpacing="3"
                            ItemsSource="{Binding Scores}"
                            Orientation="Horizontal">
                            <listview:SfListView.ItemTemplate>
                                <DataTemplate x:DataType="auditModels:ScoreModel">
                                    <buttons:SfButton
                                        Margin="0,10,0,0"
                                        Background="{Binding Color}"
                                        Clicked="Score_Clicked"
                                        Command="{Binding BindingContext.TaskScoreCommand, Source={x:Reference Page}}"
                                        CommandParameter="{Binding Number}"
                                        Style="{StaticResource ScoreButton}"
                                        VerticalOptions="Start">
                                        <buttons:SfButton.Content>
                                            <DataTemplate>
                                                <Label
                                                    FontSize="Medium"
                                                    HorizontalOptions="CenterAndExpand"
                                                    Text="{Binding Number}"
                                                    TextColor="White"
                                                    VerticalOptions="CenterAndExpand" />
                                            </DataTemplate>
                                        </buttons:SfButton.Content>
                                    </buttons:SfButton>
                                </DataTemplate>
                            </listview:SfListView.ItemTemplate>
                        </listview:SfListView>
                    </StackLayout>
                </DataTemplate>
            </popup:SfPopup.ContentTemplate>
        </popup:SfPopup>

        <!--  Action/Comment popup  -->
        <popups:TaskCommentActionPopup
            AbsoluteLayout.LayoutBounds="0,0,1,1"
            AbsoluteLayout.LayoutFlags="WidthProportional,HeightProportional"
            HeightRequest="85"
            IsOpen="{Binding BindingContext.IsActionPopupOpen, Source={x:Reference Page}}"
            NewActionCommand="{Binding BindingContext.NavigateToNewActionCommand, Source={x:Reference Page}}"
            NewCommentCommand="{Binding BindingContext.NavigateToNewCommentCommand, Source={x:Reference Page}}"
            ShowFooter="False"
            ShowHeader="False"
            WidthRequest="400" />

        <!--  Change photo proof status status popup  -->
        <popups:PictureProofChangeStatusPopup
            CancelButtonCommand="{Binding BindingContext.CloseChangeStatusPopupCommand, Source={x:Reference Page}}"
            FooterHeight="80"
            HeaderHeight="45"
            IsOpen="{Binding IsChangeStatusPopupOpen}"
            KeepButtonCommand="{Binding BindingContext.KeepButtonChangeStatusPopupCommand, Source={x:Reference Page}}"
            MinimumHeightRequest="200"
            RemoveButtonCommand="{Binding BindingContext.RemoveButtonChangeStatusPopupCommand, Source={x:Reference Page}}"
            WidthRequest="500" />

        <!--  Skip task popup  -->
        <popups:SkipTaskPopup
            CancelButtonCommand="{Binding BindingContext.CloseSkipTaskPopupCommand, Source={x:Reference Page}}"
            FooterHeight="80"
            HeaderHeight="45"
            IsOpen="{Binding IsSkipTaskPopupOpen}"
            MinimumHeightRequest="200"
            ShowFooter="True"
            SubmitButtonCommand="{Binding BindingContext.SubmitSkipTaskPopupCommand, Source={x:Reference Page}}"
            WidthRequest="500" />

        <Grid
            x:Name="MainGrid"
            HorizontalOptions="Fill"
            StyleClass="bg-lightgrey"
            VerticalOptions="Fill">
            <Grid.RowDefinitions>
                <RowDefinition Height="80" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <Grid
                Grid.Row="0"
                ColumnSpacing="0"
                RowSpacing="0"
                StyleClass="header, bg-white, m-0, pr-15">

                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="120" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="280" />
                </Grid.ColumnDefinitions>

                <!--  Back Button  -->
                <customButtons:BackButton Grid.Column="0" Command="{Binding CancelCommand}" />

                <!--  Title  -->
                <ScrollView Grid.Column="1">
                    <customLabels:TitleLabel Text="{Binding Title}" />
                </ScrollView>

                <!--  Audit Progress Linear Bar  -->
                <customProgressBar:CustomLinearProgressBar
                    Grid.Column="2"
                    IsLabelVisible="True"
                    Score="{Binding Score}" />
                <!--#endregion-->

            </Grid>

            <!--  Detail Page  -->
            <Grid
                Grid.Row="1"
                RowSpacing="0"
                HorizontalOptions="Fill"
                VerticalOptions="Fill">
                <Grid.RowDefinitions>
                    <RowDefinition Height="0.70*" />
                    <RowDefinition Height="0.13*" />
                    <RowDefinition Height="0.17*" />
                </Grid.RowDefinitions>

                <panCardView:CoverFlowView
                    x:Name="CoverFlow"
                    Grid.Row="0"
                    Margin="0,0,0,0"
                    IsCyclical="False"
                    IsRightToLeftFlowDirectionEnabled="{Binding Source={x:Static settings:Settings.IsRightToLeftLanguage}}"
                    ItemTemplate="{StaticResource AuditSlideDataTemplateSelector}"
                    ItemsSource="{Binding FilteredTaskTemplates}"
                    SelectedItem="{Binding SelectedTask, Mode=TwoWay}"
                    SelectedIndex="{Binding CurrentIndex}">

                    <x:Arguments>
                        <processors:CoverFlowProcessor OpacityFactor="0.25" ScaleFactor="0.50" />
                    </x:Arguments>
                    <panCardView:CoverFlowView.Behaviors>
                        <behaviors:CornerFlowViewShiftAsMarginBehavior x:Name="CarouselViewBehaviours" Margin="50" />
                    </panCardView:CoverFlowView.Behaviors>
                </panCardView:CoverFlowView>

                <!--  Tags  -->
                <listview:SfListView
                    Grid.Row="1"
                    Margin="40,0,40,0"
                    HeightRequest="55"
                    HorizontalOptions="FillAndExpand"
                    ItemSize="166"
                    ItemsSource="{Binding SelectedTask.Tags}"
                    Orientation="Horizontal"
                    ScrollBarVisibility="Never"
                    SelectionMode="None"
                    VerticalOptions="Start">
                    <listview:SfListView.ItemTemplate>
                        <datatemplates:TagDataTemplate />
                    </listview:SfListView.ItemTemplate>

                </listview:SfListView>

                <!--  Buttons  -->
                <controls:TaskSlideButtonsStackLayout
                    x:Name="Buttons"
                    Grid.Row="2"
                    Margin="0,10,0,0"
                    ActionBubbleCount="{Binding SelectedTask.ActionBubbleCount}"
                    ActionButtonCommand="{Binding BindingContext.ActionCommand, Source={x:Reference Page}}"
                    ColorCalculator="{Binding ColorCalculator}"
                    HasExtraInformation="{Binding SelectedTask.HasExtraInformation}"
                    HasPictureProof="{Binding SelectedTask.HasPictureProof}"
                    HasStepsOrWorkInstructions="{Binding SelectedTask.HasStepsOrWorkInstructions}"
                    HorizontalOptions="Center"
                    IsScoreBadgeVisible="{Binding SelectedTask.IsScoreBadgeVisible}"
                    IsThumbsDownBadgeVisible="{Binding SelectedTask.IsThumbsDownBadgeVisible}"
                    IsThumbsUpBadgeVisible="{Binding SelectedTask.IsThumbsUpBadgeVisible}"
                    IsVisible="{Binding HasButtons}"
                    OpenScoreCommand="{Binding OpenScoreCommand}"
                    Score="{Binding SelectedTask.Score}"
                    ScoreType="{Binding ScoreType}"
                    SkipButtonCommand="{Binding BindingContext.TaskSkippedCommand, Source={x:Reference Page}}"
                    StepsCommand="{Binding BindingContext.StepsCommand, Source={x:Reference Page}}"
                    TaskStatus="{Binding SelectedTask.FilterStatus}"
                    ThumbsDownButtonCommand="{Binding TaskNotOkCommand}"
                    ThumbsUpButtonCommand="{Binding BindingContext.TaskOkCommand, Source={x:Reference Page}}"
                    VerticalOptions="StartAndExpand" />
            </Grid>



            <!--  Message Center  -->
            <controls:MessageCenter Grid.Row="1" />

        </Grid>

        <!--  Busy Indicator  -->
        <customProgressBar:CustomCircularIndicator IsBusy="{Binding IsBusy}" IsVisible="{Binding IsBusy}" />

    </Grid>

</ContentPage>
