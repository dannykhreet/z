@model PdfChecklistCompletedViewModel
@{
    Layout = null;

    var tz = User.FindFirst(System.Security.Claims.ClaimTypes.Country)?.Value ?? "Europe/Amsterdam";
    TimeZoneInfo timezone = TZConvert.EzFindTimeZoneInfoById(tz);

    string getIconColor(string state)
    {
        switch (state.ToLower())
        {
            case "ok":
                return "bg-green ok-status";
            case "not ok":
                return "bg-red notok-status";
            case "skipped":
                return "bg-warning skipped-status";
            default:
                return "bg-lightGray";
        }
    }
    string getIcon(string state)
    {
        switch (state.ToLower())
        {
            case "ok":
                return "fa-thumbs-up status-icon";
            case "not ok":
                return "fa-thumbs-down status-icon";
            case "skipped":
                return "fa-forward status-icon";
            default:
                return "fa-question";
        }
    }

    var completedDate = TimeZoneInfo.ConvertTime(Model.CompletedAt, timezone);
            
}
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>@(Model?.CmsLanguage.GetValue(LanguageKeys.PdfChecklistCompleted.Title, "Completed checklist") ?? "Completed checklist") @Model.Checklist.Name</title>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="/plugins/fontawesome-pro-6.5.2-web/css/all.min.css" />
    <script src="~/lib/vendor/jquery/dist/jquery.min.js"></script>
    <!-- Bootstrap -->
    <link href="~/lib/vendor/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1337.0.min.js"></script>
    <script src="/js/ezgomediafetcher.js"></script>

    <style>
        body {
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,'Noto Sans Malayalam','Noto Sans KR','Noto Sans Thai',"Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";
        }

        hr {
            border-top: 2px solid #8E8E8E7F;
        }

        h1, h5 {
            color: black;
            font-weight: 600;
        }

        p {
            color: black;
        }

        strong {
            font-weight: 600;
        }

        * {
            -webkit-print-color-adjust: exact !important; /* Chrome, Safari 6 – 15.3, Edge */
            color-adjust: exact !important; /* Firefox 48 – 96 */
            print-color-adjust: exact !important; /* Firefox 97+, Safari 15.4+ */
        }

        .narrow {
            border-top: 1px solid #00a054;
        }

        .header {
            position: relative;
            background-color: #00a054;
            height: 100px;
            width: 100%;
            display: block;
        }

        .header .title {
            font-size: 20px;
            margin:10px;
            color: #FFFFFF;
            font-weight: bolder;
        }

        .header .subtitle {
            font-size: 14px;
            margin-left: 10px;
            margin-right: 10px;
            color: #FFFFFF;
        }

        .header .score {
            font-size: 12px;
            text-align: right;
            margin-right: 10px;
            margin-left: 10px;
            color: #FFFFFF;
            font-weight: bolder;
        }

        .footer {
            position: relative;
            background-color: #00a054;
            height: 100px;
            width: 100%;
            display: block;
        }

            .footer .title {
                font-size: 20px;
                margin: 10px;
                color: #FFFFFF;
                font-weight: bolder;
            }

            .footer .subtitle {
                font-size: 14px;
                margin-left: 10px;
                margin-right: 10px;
                color: #FFFFFF;
            }

        .tag {
            padding:4px;
            margin:2px;
            border-radius: 0.25rem;
            font-size: 12px;
            display: inline-block;
            font-weight: bolder;
            color: #FFFFFF
        }

        .openfield {
            margin: 2px;
        }

            .openfield .title {
                font-size: 12px;
                font-weight: bolder;
            }

            .openfield .value {
                font-size: 12px;
            }

        .title {
            color: black;
        }
        .tags-container {
            margin-top:5px;
            display: block;
            position: relative;
        }

        .tasks-container {
            margin-top: 5px;
            display: block;
            position: relative;
        }

        .stage-container {
            margin-top: 5px;
            display: block;
            position: relative;
            color: white;
        }

        .stageHeader {
            min-height: 24px;
            font-size: 18px;
        }

        .openfields-container {
            margin-top: 5px;
            display: block;
            position: relative;
        }

        .properties-container {
            display: block;
            position: relative;
        }

        .image-container {
            position: relative;
            display:inline-block;
        }

        .image-wrapper {
            width: 100%;
            min-width: 245px;
        }

        .signature-image-container .image-wrapper  {
            vertical-align: middle;
            text-align: center;
        }

        .image-wrapper img {
            max-height: 100%;
            max-width: 245px;
            min-width: 245px;
        }

        .action-image-wrapper { 
            align-self: center;
            max-height: 245px;
            max-width: 245px;
            display: inline-block;
        }

        .action-image-wrapper img {
            max-height: 100%;
            max-width: 245px;
            min-width: 245px;
        }

        .actioncomment-image-container {
            position: relative;
            display: block;

        }

        .actioncomment-image-container .image-wrapper {
            max-height: 400px;
            max-width: 400px;
            position: relative;
            display: inline-block;
            align-content: center; 
            text-align: center;     
            vertical-align: top;
            margin: 2px;
        }

       .actioncomment-image-container .image-wrapper img {
            max-height: 400px;
            max-width: 400px;
        }

        .signature-image-container .image-wrapper {
            position: relative;
            display: inline-block;
            align-content: center;
            text-align: center;
            vertical-align: top;
        }

        .signature-image-container .image-wrapper img {
            max-height: 100%;
            max-width: 80%;
            display: inline-block;
            /*border: 1px solid #00a054;*/
        }

        .item-number-container {
            position: absolute;
            left:0px;
            top:0px;
            width: 35px;
            height: 35px;
            background-color: #00a054;
            color: #FFFFFF;
            text-align:center;
            font-size:20px;
            vertical-align: middle;
            font-weight: bolder;
            border: 2px solid #FFFFFF;
        }

        .property { 
            position: relative;
            display: inline-block;
            margin-left: 2px;
            height: 100px;
            width: 100px;
            overflow: hidden;
        }

        .property-wrapper {
            display:table;
       
        }

        .property-title {
            margin-top: 2px;
            width: 100px;
            text-align: center;
            font-size: 10px;
            font-weight: bolder;
            height:25px;
            vertical-align: middle;
            line-height: normal;
            display: inline-table;
            overflow: hidden; 

        }

        .property-value {
            width: 100px;
            text-align: center;
            font-size: 10px;
            height: 50px;
            vertical-align: middle;
            line-height:normal;
            display: inline-table;
            overflow: hidden;
        }

        .property-date {
            width: 100px;
            text-align: center;
            font-size: 10px;
            height: 10px;
            vertical-align: middle;
            line-height: normal;
            display: inline-table;
            overflow: hidden;
        }

        .item-details {
            display:inline-block;
            vertical-align: top;
            width: calc(100vw - 350px) !important;

        }

        .item-details-name {
            font-weight: bolder;
        }

        .item-container {
            position: relative;
            display: block;
            vertical-align: top;
        }

        .item-main {
            position:relative;
            display: block;
            margin-top: 3px;
        }

        .item-main .image-container {
           width:250px; 
        }

        .item-score {
            display: flex;
            justify-content: flex-end;
        }

        .rounded-circle {
            border-radius: 50% !important;
            min-width: 35px;
            min-height: 35px;
            max-width: 35px;
            max-height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #FFFFFF;
            font-size:20px;
            align-self: center;
        }

        .status .status-icon {
            font-size: 18px;
        }

        .status .text-white {
            color: #ffffff;
        }

        .status .ok-status {
            width: 35px;
            height: 35px;
            padding: 3px 3px 3px 3px;
        }

        .status .notok-status {
            width: 35px;
            height: 35px;
            padding: 3px 3px 3px 3px;
        }

        .status .skipped-status {
            width: 35px;
            height: 35px;
            padding: 3px 3px 3px 3px;
            color: #fff !important;
        }

        .status .action-status {
            width: 35px;
            height: 35px;
            padding: 3px 3px 3px 3px;
            color: #fff !important;
        }

        .status .score {
            color: #fff;
            font-weight:bolder;
            width: 35px;
            height: 35px;
            padding: 3px;
        }

        .statusPPOverlay {
            position: absolute;
            right: -7px;
            top: -7px;
            width: 20px;
            height: 20px;
            border: 1px solid white;
            border-radius: 10px;
            background-color: #28A745;
            color: white;
            font-size: 12px;
            text-align: center;
            vertical-align: middle;
        }

        .bg-warning {
            background-color: #FFC107 !important;
        }

        .bg-red {
            background-color: #dc3545;
        }

        .bg-green {
            background-color: #28a745;
        }


        .picture-proof-container {
            text-align: right;
            align-content: flex-end;
            position: relative;
        }

        .picture-proof {
            margin-left: 5px;
            margin-top: 5px;
            height: 400px;
            width:400px;
            text-align: left;
            display: inline-block;
            position:relative;
        }

        .picture-proof img {
            max-width: 400px;
            max-height: 400px;
            object-fit: cover;
            object-position: center
        }

        .picture-proof-icon {
            align-self: center;
            margin-left: 20%;
        }

        .task-actions-comment-container {
            position: relative;
            color: black;
        }

        .task-actions-comment-container .actioncomment-item-number-container {
            position: relative;
            width: 35px;
            height: 35px;
            background-color: #00a054;
            color: #FFFFFF;
            text-align: center;
            font-size: 20px;
            vertical-align: middle;
            font-weight: bolder;
            display:inline-block;
        }

        .task-actions-comment-container .task-title {
            position:relative;
            height: 50px;
        }

        .task-actions-comment-container .task-title span {
            margin-left: 5px;

        }

        .task-actions-comment-container .title {
            font-weight:bolder;
            color: black;
        }

        .signature-container {
            position:relative;
            display: block;
        }

        .signature-container .title {
            font-weight:bolder;
        }

        .signature-container .signature-signed {
            font-weight: bolder;
            text-align: center;
        }

        .page-break-inside-avoid {
            page-break-inside: avoid;
        }

        .tag-wrapper {
            padding-left: 5px;
            padding-right: 5px;
        }
    </style>
</head>
<body class="p-3">
    <!-- Header -->
    <div class="row">
        <div class="col-12 mt-4"><h1>@Model.Checklist.Name</h1></div>
    </div>
    <div class="row"style="color: black;font-size: 16px;">
        @if (Model.Checklist != null && Model.Checklist.Signatures != null && Model.Checklist.Signatures.Count>0 && Model.Checklist.IsCompleted)
        {
            DateTime SignedDate = TimeZoneInfo.ConvertTime(Model.Checklist.Signatures[0].SignedAt.Value, timezone);

            <div class="col-auto"><strong>Date:</strong> @SignedDate.ToLocaleFullDateShortTimeString(Model.Locale)</div>
            <div class="col"><strong>Completed by:</strong> @Model.Checklist.Signatures.First().SignedBy</div>
        }
        else
        {
            DateTime ModifiedDate = TimeZoneInfo.ConvertTime(Model.Checklist.ModifiedAt.Value, timezone);

            <div class="col-auto"><strong>Ongoing</strong> </div>
            <div class="col"><strong>Last change:</strong> @ModifiedDate.ToLocaleFullDateShortTimeString(Model.Locale) by @Model.Checklist.ModifiedBy</div>
        }
    </div>


    @if (Model.ApplicationSettings.Features?.TagsEnabled == true)
    {
        @if (Model.Checklist.Tags != null && Model.Checklist.Tags.Count > 0)
        {
            <!-- Tags -->
            <div class="tags-container">
            @foreach (var tag in Model.Checklist.Tags)
            {
                <div class="tag" style="background-color: @tag.ColorCode">
                    <div class="tag-wrapper">
                        <i class="@(!String.IsNullOrEmpty(tag.IconStyle) ? "fa-" + tag.IconStyle : "fa-solid") @(!String.IsNullOrEmpty(tag.IconName) ? "fa-" + tag.IconName : "fa-question")"></i>
                        <span>@tag.Name</span>
                    </div>
                </div>
            }
            </div>
        }
    }

    <!-- Open fields -->
    @if (Model.Checklist.OpenFieldsProperties != null && Model.Checklist.OpenFieldsProperties.Count > 0)
    {
        <div class="page-break-inside-avoid">
            <h5 class="py-2" style="font-weight: 600">Open fields</h5>
            <div class="row">
                @for (int i = 0; i < Model.Checklist.OpenFieldsProperties.Count; i++)
                {
                    <div class="col-6">
                        <div class="row" style="height: 100%">
                            <div class="col-6" style="overflow-wrap: anywhere;align-content: center;height:100%">
                                <label class="title">
                                    @Model.Checklist.OpenFieldsProperties[i].TitleDisplay:
                                </label>
                            </div>
                            <div class="col-5" style="color: #8E8E8E; text-align: center; align-content: center;overflow-wrap: anywhere;height:100%">
                                <span class="value"> @Model.Checklist.OpenFieldsPropertyUserValues.Where(m => m.TemplatePropertyId.Equals(Model.Checklist.OpenFieldsProperties[i].Id)).FirstOrDefault()?.UserValueString</span>
                            </div>
                            <div class="col-1">@(Model.Checklist.OpenFieldsProperties[i].IsRequired.HasValue && Model.Checklist.OpenFieldsProperties[i].IsRequired.Value ? "*" : "")</div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
    <hr />
    <!-- Tasks -->
    
    @if(Model?.ApplicationSettings?.Features?.ChecklistStagesEnabled != null && Model.ApplicationSettings.Features.ChecklistStagesEnabled.Value == true && Model.Checklist.Stages != null && Model.Checklist.Stages.Count > 0)
    {
        foreach(var stage in Model.Checklist.Stages)
        {
            var stageTasks = Model.Checklist.Tasks.Where(t => stage.TaskIds != null && stage.TaskIds.Contains(Convert.ToInt32(t.Id))).ToList();
            var stageHeaderStatusColor = stage.Status == "done" ? "#1CD95E" : "#364C59";

            <div class="stage-container mb-3" style="border: 2px solid @stageHeaderStatusColor">
                <div class="stageHeader page-break-inside-avoid" style="align-content: center;background-color: @stageHeaderStatusColor">
                    <div class="row">
                        <div class="col">
                            <div>
                                @if ((stage.Signatures != null && stage.Signatures.Count > 0) && (stage.BlockNextStagesUntilCompletion && stage.LockStageAfterCompletion))
                                {
                                    <div class="pl-3" style="display: inline-block">
                                        <i class="fa-solid fa-signature"></i>
                                    </div>

                                    <div class="pl-3" style="display: inline-block">
                                        <i class="fa-solid fa-lock"></i>
                                    </div>
                                }
                                else if (stage.BlockNextStagesUntilCompletion && stage.LockStageAfterCompletion)
                                {
                                    <div class="pl-3" style="display: inline-block">
                                        <i class="fa-solid fa-lock"></i>
                                    </div>
                                }
                                else if (stage.Signatures != null && stage.Signatures.Count > 0)
                                {
                                    <div class="pl-3" style="display: inline-block">
                                        <i class="fa-solid fa-signature"></i>
                                    </div>
                                }
                                else
                                {
                                    <div class="pl-3" style="display: inline-block">
                                        <i class="fa-regular fa-lightbulb-on"></i>
                                    </div>
                                }
                                <div class="pl-3" style="display: inline-block">
                                    @stage.Name &nbsp;
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                @if (Model.ApplicationSettings.Features?.TagsEnabled == true && stage.Tags != null && stage.Tags.Count > 0)
                {
                    <div class="col-12 p-1 pt-3 pl-3" style="height: auto; align-self: center">
                        <div class="tag-container">
                            @foreach (var tag in stage.Tags)
                            {
                                <div class="tag" style="background-color: @tag.ColorCode">
                                    <div class="tag-wrapper">
                                        <i class="@(!String.IsNullOrEmpty(tag.IconStyle) ? "fa-" + tag.IconStyle : "fa-solid") @(!String.IsNullOrEmpty(tag.IconName) ? "fa-" + tag.IconName : "fa-question")"></i>
                                        <span>@tag.Name</span>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }

                @if(stageTasks != null && stageTasks.Count>0)
                {
                    <div class="stageTasks p-3">
                        @foreach (var checklistItem in stageTasks)
                        {
                            <div class="row">
                                <div class="col-auto">
                                    <div style="display: inline-block;"><h5 style="font-weight: 600">@(Model.Checklist.Tasks.IndexOf(checklistItem) + 1) </h5></div>
                                </div>
                                <div class="col">
                                    <div style="display: inline-block;"><h5 style="font-weight: 600">@checklistItem.Name</h5></div>
                                </div>
                            </div>

                            <div class="item-container page-break-inside-avoid">
                                @{
                                    string mediaImageUrl = Constants.General.ImageUnavailableUrl;

                                    if (!string.IsNullOrEmpty(checklistItem.Picture))
                                    {
                                        mediaImageUrl = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, checklistItem.Picture);
                                    }
                                    else if (!string.IsNullOrEmpty(checklistItem.VideoThumbnail))
                                    {
                                        mediaImageUrl = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, checklistItem.VideoThumbnail);
                                    }
                                }

                                <div class="item-main">
                                    <div class="row">
                                        <div class="image-container col-auto mr-3">
                                            <div class="image-wrapper"><img data-src="@mediaImageUrl" /></div>
                                        </div>
                                        @{
                                            bool itemHasTags = (Model.ApplicationSettings.Features?.TagsEnabled == true && checklistItem.Tags != null && checklistItem.Tags.Count > 0);
                                            bool itemHasOnlyTagsNoSignatures = !(checklistItem.Signature != null && checklistItem.Signature.SignedAt.HasValue && !string.IsNullOrEmpty(checklistItem.Signature.SignedBy)) && itemHasTags;
                                        }
                                        <div class="item-details col">
                                            <div class="row" style="height: 100%; color: black ">
                                                @if(checklistItem.Signature != null && checklistItem.Signature.SignedAt.HasValue && !string.IsNullOrEmpty(checklistItem.Signature.SignedBy))
                                                {
                                                    <div class="col-12 item-details-name p-1 pl-3" style="height: auto; align-self: @(itemHasTags ? "flex-end" : "center ")">
                                                        Marked on <div style="display: inline-block; font-weight: 400">@TimeZoneInfo.ConvertTime(checklistItem.Signature.SignedAt.Value, timezone).ToLocaleFullDateShortTimeString(Model.Locale) by @checklistItem.Signature.SignedBy</div>
                                                    </div>
                                                }
                                                @if (itemHasTags)
                                                {
                                                    <div class="col-12 p-1 pl-3" style="height: auto; align-self: @(itemHasOnlyTagsNoSignatures ? "center" : "flex-start")">
                                                        <div class="tag-container">
                                                            @foreach (var tag in checklistItem.Tags)
                                                            {
                                                                <div class="tag" style="background-color: @tag.ColorCode">
                                                                    <div class="tag-wrapper">
                                                                        <i class="@(!String.IsNullOrEmpty(tag.IconStyle) ? "fa-" + tag.IconStyle : "fa-solid") @(!String.IsNullOrEmpty(tag.IconName) ? "fa-" + tag.IconName : "fa-question")"></i>
                                                                        <span>@tag.Name</span>
                                                                    </div>
                                                                </div>
                                                            }
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        </div>

                                        <div class="item-score status col-2">
                                            @if (checklistItem.ActionsCount > 0 || checklistItem.CommentCount > 0)
                                            {
                                                <span class="rounded-circle action-status bg-warning status-icon mx-2"><i class="fa fa-bolt-lightning"></i></span>
                                                @:&nbsp;
                                            }
                                            @if (!string.IsNullOrEmpty(checklistItem.Status))
                                            {
                                                <div style="position: relative; align-self: center">
                                                    <span class="rounded-circle status-icon @getIconColor(checklistItem.Status) text-white"><i class="fa @getIcon(checklistItem.Status)" title="@checklistItem.Status"></i></span>
                                                    @if (checklistItem.PictureProof != null && checklistItem.PictureProof.Media != null && checklistItem.PictureProof.Media.Count > 0)
                                                    {
                                                        var iconColor = getIconColor(checklistItem.Status);
                                                        <div class="statusPPOverlay @iconColor" style="width: 20px; height: 20px; padding: 0px;">
                                                            <i class="fas fa-camera"></i>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>

                                @if (checklistItem.Properties != null && checklistItem.Properties.Count() > 0)
                                {
                                    <div class="properties-container pt-3">

                                        @for (int i = 0; i < checklistItem.Properties.Count(); i++)
                                        {
                                            var templateProperty = checklistItem.Properties[i];
                                            var possibePropertyValue = checklistItem.PropertyUserValues.Where(x => x.PropertyId == templateProperty.PropertyId && x.TemplatePropertyId == templateProperty.Id).FirstOrDefault();
                                            if (possibePropertyValue != null && possibePropertyValue.Id > 0)
                                            {
                                                string color = "";

                                                DateTime propertyDate = TimeZoneInfo.ConvertTime(possibePropertyValue.CreatedAt.ToLocalTime(), timezone);

                                                if (possibePropertyValue.RegisteredAt != null)
                                                {
                                                    propertyDate = TimeZoneInfo.ConvertTime(possibePropertyValue.RegisteredAt.Value.ToLocalTime(), timezone);
                                                }
                                                color = WebApp.Helpers.PropertyHelpers.GetStatusColor(templateProperty, possibePropertyValue);

                                                <div class="property" style="border: 1px solid @color; color: @color">
                                                    <div class="property-wrapper">
                                                        @if (templateProperty.IsRequired == true)
                                                        {
                                                            <i class="fa-solid fa-asterisk m-1" style="color: red; position: absolute; top: -1px; right: -1px;"></i>
                                                        }
                                                        <div class="property-title">
                                                            @if (!String.IsNullOrEmpty(templateProperty.TitleDisplay))
                                                            {
                                                                <span>@templateProperty.TitleDisplay</span>
                                                            }
                                                            else
                                                            {
                                                                <span>@templateProperty.Property.ShortName</span>
                                                            }
                                                        </div>

                                                        <div class="property-value" data-fulltext="@possibePropertyValue.UserValueString">
                                                            @if (possibePropertyValue.UserValueBool == null && possibePropertyValue.UserValueDate == null &&
                                                           possibePropertyValue.UserValueDecimal == null && possibePropertyValue.UserValueInt == null &&
                                                           possibePropertyValue.UserValueString == null && possibePropertyValue.UserValueTime == null)
                                                            {
                                                                <span>Not measured</span>
                                                            }
                                                            else
                                                            {
                                                                <span>
                                                                    @possibePropertyValue.UserValueBool
                                                                    @possibePropertyValue.UserValueDate
                                                                    @(possibePropertyValue.UserValueDecimal / 1.000000000000000000000000000000000m)
                                                                    @possibePropertyValue.UserValueInt
                                                                    @possibePropertyValue.UserValueString
                                                                    @possibePropertyValue.UserValueTime
                                                                </span>
                                                                @if (!string.IsNullOrEmpty(templateProperty.PropertyValueDisplay))
                                                                {
                                                                    @templateProperty.PropertyValueDisplay
                                                                    ;
                                                                }
                                                                else if (templateProperty.PropertyValue != null)
                                                                {
                                                                    @templateProperty.PropertyValue.ValueSymbol
                                                                    ;
                                                                }
                                                            }

                                                        </div>
                                                        <div class="property-date">
                                                            <span>@propertyDate.ToString("dd MMM yyyy") @propertyDate.ToString("H:mm")</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                        }
                                    </div>
                                }

                                <!-- Picture proof -->
                                @if (checklistItem.PictureProof != null && checklistItem.PictureProof.Media != null && checklistItem.PictureProof.Media.Count > 0)
                                {
                                    var startColor = 250;
                                    var endColor = 230;
                                    var difference = startColor - endColor;
                                    var stepSize = difference / (double)checklistItem.PictureProof.Media.Count;

                                    var pictureProofColor = (int)(startColor);
                                    for (int i = 0; i < checklistItem.PictureProof.Media.Count; i++)
                                    {
                                        DateTime pictureProofDate = TimeZoneInfo.ConvertTime(checklistItem.PictureProof.Media[i].PictureTakenUtc.ToLocalTime(), timezone);
                                        string ppPicture = Constants.General.ImageUnavailableUrl;

                                        if (!string.IsNullOrEmpty(checklistItem.PictureProof.Media[i].UriPart))
                                        {
                                            ppPicture = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, checklistItem.PictureProof.Media[i].UriPart);
                                        }

                                        var iconColor = getIconColor(checklistItem.Status);

                                        <div class="row">
                                            <div class="col-auto mr-3" style="width:250px; display: flex; justify-content: center">
                                                <div class="picture-proof-icon"><a class="rounded-circle status-icon @iconColor text-white" style="font-size: 14px"><i class="fas fa-camera status-icon"></i></a></div>
                                            </div>
                                            <div class="col" style="align-self: center; color: black">
                                                <div><strong>Created:</strong> @pictureProofDate.ToLocaleFullDateShortTimeString(Model.Locale) by @checklistItem.PictureProof.Media[i].UserFullName</div>
                                            </div>
                                            <div class="col-auto">
                                                <div class="image-container"><div class="image-wrapper" style="text-align: right;"><img data-src="@ppPicture" /></div></div>
                                            </div>
                                        </div>
                                    }

                                }
                            </div>

                            <!-- Actions linked to checklist item -->
                            var linkedActions = (Model.Actions != null && Model.Actions.Count > 0) ? Model.Actions.Where(a => a.TaskId == checklistItem.Id).ToList() : null;
                            @if (linkedActions != null && linkedActions.Count > 0)
                            {
                                <div class="actions-container">

                                <div class="task-actions-comment-container">
                            
                                    @foreach (var action in linkedActions)
                                    {
                                        <div class="row"> 
                                            <div class="col py-2">
                                                <div class="title" style="display: inline-block">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PdfAuditCompleted.ActionComment, "Comment") ?? "Comment"):</div>
                                                @Html.Raw(action.Comment.Replace(System.Environment.NewLine, "<br />").Replace("\n\r", "<br />").Replace("\n", "<br />").Replace("\r", "<br />"))
                                            </div>
                                        </div>
                            
                                        <div class="row">
                                            <div class="col py-2">
                                                <div class="title" style="display: inline-block">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PdfAuditCompleted.ActionAction, "Action") ?? "Action"):</div>
                                                @Html.Raw(action.Description.Replace(System.Environment.NewLine, "<br />").Replace("\n\r", "<br />").Replace("\n", "<br />").Replace("\r", "<br />"))
                                            </div>
                                        </div>
                            
                                        <div class="row">
                                            <div class="col py-1">
                                                <div class="title" style="display: inline-block">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PdfAuditCompleted.ActionAuthor, "Author") ?? "Author"):</div>
                                                @action.CreatedBy
                                            </div>
                            
                                        </div>

                                        DateTime actionCreated = TimeZoneInfo.ConvertTime(action.CreatedAt.ToLocalTime(), timezone);
                                        <div class="row">
                                            <div class="col py-1">
                                                <div class="title" style="display: inline-block">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PdfAuditCompleted.ActionDate, "Date") ?? "Date"):</div>
                                                @actionCreated.ToLocaleFullDateShortTimeString(Model.Locale)
                                            </div>
                            
                                        </div>
                                        
                                        @if (!action.CreatedAt.Equals(action.ModifiedAt))
                                        {
                                            DateTime actionModified = TimeZoneInfo.ConvertTime(action.ModifiedAt.ToLocalTime(), timezone);
                                            <div class="row">
                                                <div class="col py-1">
                                                    <div class="title">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PdfAuditCompleted.ActionModificationDate, "Modification date") ?? "Modification date"):</div>
                                                    @actionModified.ToLocaleFullDateShortTimeString(Model.Locale)
                                                </div>
                                            </div>
                                        }
                            
                            
                                        <div class="row">
                                            <div class="col py-1">
                                                <div class="title" style="display: inline-block">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PdfAuditCompleted.ActionDueDate, "Due date") ?? "Due date"):</div>
                                                @action.DueDate.ToLocaleFullDateShortTimeString(Model.Locale)
                                            </div>
                                        </div>
                            
                            
                                        @if (Model.ApplicationSettings.Features?.TagsEnabled == true)
                                        {
                                            @if (action.Tags != null && action.Tags.Count > 0)
                                            {
                                        
                                                <div class="tag-container py-2">
                                                    @foreach (var tag in action.Tags)
                                                    {
                                                        <div class="tag" style="background-color: @tag.ColorCode">
                                                            <div class="tag-wrapper">
                                                                <i class="@(!String.IsNullOrEmpty(tag.IconStyle) ? "fa-" + tag.IconStyle : "fa-solid") @(!String.IsNullOrEmpty(tag.IconName) ? "fa-" + tag.IconName : "fa-question")"></i>
                                                                <span>@tag.Name</span>
                                                            </div>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        }

                                        if ((action.Images != null || action.VideoThumbNails != null) && (action.Images.Count > 0 || action.VideoThumbNails.Count > 0))
                                        {
                                            <div class="actioncomment-image-container">
                                                @foreach (var image in action.Images)
                                                {
                                                    string actionImageUrl = Constants.General.ImageUnavailableUrl;
                                                    if (!string.IsNullOrEmpty(image))
                                                    {
                                                        actionImageUrl = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, image);
                                                        actionImageUrl = actionImageUrl.Replace("/media/media", "/media"); //fix for incorrect data in db
                                                    }
                                                    <div class="action-image-wrapper">
                                                        <img data-src="@actionImageUrl" />
                                                    </div>
                                                }
                                                @foreach (var videoThumbnail in action.VideoThumbNails)
                                                {
                                                    string actionVideoThumbnailUrl = Constants.General.ImageUnavailableUrl;
                                                    if (!string.IsNullOrEmpty(videoThumbnail))
                                                    {
                                                        actionVideoThumbnailUrl = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, videoThumbnail);
                                                        actionVideoThumbnailUrl = actionVideoThumbnailUrl.Replace("/media/media", "/media"); //fix for incorrect data in db
                                                    }
                                                    <div class="action-image-wrapper">
                                                        <img data-src="@actionVideoThumbnailUrl" />
                                                    </div>
                                                }
                                            </div>  
                                        }

                                    }

                                    </div>

                            </div>
                            }

                            <!-- Comments linked to checklist item -->
                            var linkedComments = (Model.Comments != null && Model.Comments.Count > 0) ? Model.Comments.Where(a => a.TaskId == checklistItem.Id).ToList() : null;
                            @if (linkedComments != null && linkedComments.Count > 0)
                            {
                                <div style="break-after:page"></div>
                                <div class="actions-container">

                                    <div class="task-actions-comment-container">


                                        @foreach (var comment in linkedComments)
                                        {
                                            <div class="row py-2">
                                                <div class="title" style="display: inline-block">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PdfAuditCompleted.CommentComment, "Comment") ?? "Comment"):</div>
                                                @Html.Raw(comment.CommentText.Replace(System.Environment.NewLine, "<br />").Replace("\n\r", "<br />").Replace("\n", "<br />").Replace("\r", "<br />"))
                                            </div>
                                            <div class="row py-1">
                                                <div class="title" style="display: inline-block">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PdfAuditCompleted.CommentAuthor, "Author") ?? "Author"):</div>
                                                @comment.CreatedBy
                                            </div>

                                            DateTime commentCreated = TimeZoneInfo.ConvertTime(comment.CreatedAt.ToLocalTime(), timezone);
                                            <div class="row py-1">
                                                <div class="title" style="display: inline-block">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PdfAuditCompleted.CommentDate, "Date") ?? "Date"):</div>
                                                @commentCreated.ToLocaleFullDateShortTimeString(Model.Locale)
                                            </div>

                                            @if (!comment.CreatedAt.Equals(comment.ModifiedAt))
                                            {
                                                DateTime commentModified = TimeZoneInfo.ConvertTime(comment.ModifiedAt.ToLocalTime(), timezone);
                                                <div class="row py-1">
                                                    <div class="title" style="display: inline-block">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PdfAuditCompleted.CommentModificationDate, "Modification date") ?? "Modification date"):</div>
                                                    @commentModified.ToLocaleFullDateShortTimeString(Model.Locale)
                                                </div>
                                            }

                                            @if (Model.ApplicationSettings.Features?.TagsEnabled == true)
                                            {
                                                @if (comment.Tags != null && comment.Tags.Count > 0)
                                                {
                                        
                                                    <div class="tag-container py-2">
                                                        @foreach (var tag in comment.Tags)
                                                        {
                                                            <div class="tag" style="background-color: @tag.ColorCode">
                                                                <div class="tag-wrapper">
                                                                    <i class="@(!String.IsNullOrEmpty(tag.IconStyle) ? "fa-" + tag.IconStyle : "fa-solid") @(!String.IsNullOrEmpty(tag.IconName) ? "fa-" + tag.IconName : "fa-question")"></i>
                                                                    <span>@tag.Name</span>
                                                                </div>
                                                            </div>
                                                        }
                                                    </div>
                                                }
                                            }

                                            if(comment.Attachments != null && comment.Attachments.Count > 0)
                                            {
                                                <div class="actioncomment-image-container">
                                                    @foreach (var attachment in comment.Attachments)
                                                    {
                                                        string commentImageUrl = Constants.General.ImageUnavailableUrl;
                                                        if (!string.IsNullOrEmpty(attachment))
                                                        {
                                                            commentImageUrl = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, attachment);
                                                            commentImageUrl = commentImageUrl.Replace("/media/media", "/media"); //fix for incorrect data in db
                                                        }
                                                        <div class="action-image-wrapper">
                                                            <img data-src="@commentImageUrl" />
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        }
                                    </div>

                                </div>
                            }
                            <hr />


                        }
                    </div>
                }
                
                @if(stage.Status == "done" && stage.Signatures != null && stage.Signatures.Count>0)
                {
                    @if ((stage.UseShiftNotes && !string.IsNullOrEmpty(stage.ShiftNotes)) || (stage.Signatures.Where(s => !string.IsNullOrEmpty(s.SignatureImage)).Count() > 0))
                    {
                    <div class="d-flex checklistItem mb-2 mt-2" style="position: relative; flex-direction: column; color: black">
                        <div id="extraStageInfo-@stage.Id" class="row p-2" style="">
                            @if(stage.UseShiftNotes && !string.IsNullOrEmpty(stage.ShiftNotes) && stage.Signatures.Where(s => !string.IsNullOrEmpty(s.SignatureImage)).Count() > 0)
                            {
                                if (stage.Signatures.Count == 1)
                                {
                                    var signaturePicture = WebApp.Logic.Constants.General.ImageUnavailableUrl;
                                    if (!string.IsNullOrEmpty(stage.Signatures[0].SignatureImage))
                                    {
                                        signaturePicture = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, stage.Signatures[0].SignatureImage);
                                    }
                                    <div class="col-3" style="text-align: center">
                                        <div style="border: 1px solid #8E8E8E7F">
                                            <img data-src="@signaturePicture" style="width:100px;margin: auto" class="d-block" />
                                            <div>@stage.Signatures[0].SignedBy</div>
                                        </div>
                                    </div>

                                    <div class="col-9">
                                        @stage.ShiftNotes
                                    </div>
                                }
                                else if(stage.Signatures.Count == 2)
                                {
                                    var signaturePicture = WebApp.Logic.Constants.General.ImageUnavailableUrl;
                                    if (!string.IsNullOrEmpty(stage.Signatures[0].SignatureImage))
                                    {
                                        signaturePicture = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, stage.Signatures[0].SignatureImage);
                                    }

                                    <div class="col-3" style="text-align: center">
                                        <div style="border: 1px solid #8E8E8E7F">
                                            <img data-src="@signaturePicture" style="width:50%;height: 125px;margin: auto" class="d-block" />
                                            <div>@stage.Signatures[0].SignedBy</div>
                                        </div>
                                    </div>

                                    var signaturePicture2 = WebApp.Logic.Constants.General.ImageUnavailableUrl;
                                    if (!string.IsNullOrEmpty(stage.Signatures[1].SignatureImage))
                                    {
                                        signaturePicture2 = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, stage.Signatures[1].SignatureImage);
                                    }

                                    <div class="col-3" style="text-align: center">
                                        <div style="border: 1px solid #8E8E8E7F">
                                            <img data-src="@signaturePicture2" style="width:50%;height: 125px;margin: auto" class="d-block" />
                                            <div>@stage.Signatures[1].SignedBy</div>
                                        </div>
                                    </div>

                                    <div class="col-6">
                                        @stage.ShiftNotes
                                    </div>
                                }
                            }
                            else if(stage.UseShiftNotes && !string.IsNullOrEmpty(stage.ShiftNotes))
                            {
                                <div class="col-12">
                                    @stage.ShiftNotes
                                </div>
                            }
                            else if (stage.Signatures.Where(s => !string.IsNullOrEmpty(s.SignatureImage)).Count() > 0)
                            {
                                if (stage.Signatures.Count == 1)
                                {
                                    var signaturePicture = WebApp.Logic.Constants.General.ImageUnavailableUrl;
                                    if (!string.IsNullOrEmpty(stage.Signatures[0].SignatureImage))
                                    {
                                        signaturePicture = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, stage.Signatures[0].SignatureImage);
                                    }

                                    <div class="col-12" style="text-align: center">
                                        <div style="border: 1px solid #8E8E8E7F">
                                            <img data-src="@signaturePicture" style="width:50%; height: 125px;margin: auto" class="d-block" />
                                            <div>@stage.Signatures[0].SignedBy</div>
                                        </div>
                                    </div>
                                }
                                else if(stage.Signatures.Count == 2)
                                {
                                    var signaturePicture = WebApp.Logic.Constants.General.ImageUnavailableUrl;
                                    if (!string.IsNullOrEmpty(stage.Signatures[0].SignatureImage))
                                    {
                                        signaturePicture = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, stage.Signatures[0].SignatureImage);
                                    }

                                    <div class="col-6" style="text-align: center">
                                        <div style="border: 1px solid #8E8E8E7F">
                                            <img data-src="@signaturePicture" style="width:50%;height: 125px;margin: auto" class="d-block" />
                                            <div>@stage.Signatures[0].SignedBy</div>
                                        </div>
                                    </div>

                                    var signaturePicture2 = WebApp.Logic.Constants.General.ImageUnavailableUrl;
                                    if (!string.IsNullOrEmpty(stage.Signatures[1].SignatureImage))
                                    {
                                        signaturePicture2 = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, stage.Signatures[1].SignatureImage);
                                    }

                                    <div class="col-6" style="text-align: center">
                                        <div style="border: 1px solid #8E8E8E7F">
                                            <img data-src="@signaturePicture2" style="width:50%;height: 125px;margin: auto; " class="d-block" />
                                            <div>@stage.Signatures[1].SignedBy</div>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                    }
                }

            </div>
        }


        @foreach (var checklistItem in Model.Checklist.Tasks.Where(t => Model.Checklist.Stages.Where(s => s.TaskIds != null && s.TaskIds.Contains(Convert.ToInt32(t.Id))).Count() == 0).ToList())
        {
            <div class="page-break-inside-avoid">
                <div class="row">
                    <div class="col-auto">
                        <div style="display: inline-block;"><h5 style="font-weight: 600">@(Model.Checklist.Tasks.IndexOf(checklistItem) + 1) </h5></div>
                    </div>
                    <div class="col">
                        <div style="display: inline-block;"><h5 style="font-weight: 600">@checklistItem.Name</h5></div>
                    </div>
                </div>

                <div class="item-container">
                    @{
                        string mediaImageUrl = Constants.General.ImageUnavailableUrl;

                        if (!string.IsNullOrEmpty(checklistItem.Picture))
                        {
                            mediaImageUrl = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, checklistItem.Picture);
                        }
                        else if (!string.IsNullOrEmpty(checklistItem.VideoThumbnail))
                        {
                            mediaImageUrl = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, checklistItem.VideoThumbnail);
                        }
                    }

                    <div class="item-main">
                        <div class="row">
                            <div class="image-container col-auto mr-3">
                                <div class="image-wrapper"><img data-src="@mediaImageUrl" /></div>
                            </div>
                            @{
                                bool itemHasTags = (Model.ApplicationSettings.Features?.TagsEnabled == true && checklistItem.Tags != null && checklistItem.Tags.Count > 0);
                                bool itemHasOnlyTagsNoSignatures = !(checklistItem.Signature != null && checklistItem.Signature.SignedAt.HasValue && !string.IsNullOrEmpty(checklistItem.Signature.SignedBy)) && itemHasTags;
                            }
                            <div class="item-details col">
                                <div class="row" style="height: 100%; color: black ">
                                    @if (checklistItem.Signature != null && checklistItem.Signature.SignedAt.HasValue && !string.IsNullOrEmpty(checklistItem.Signature.SignedBy))
                                    {
                                        <div class="col-12 item-details-name p-1 pl-3" style="height: auto; align-self: @(itemHasTags ? "flex-end" : "center ")">
                                            Marked on <div style="display: inline-block; font-weight: 400">@TimeZoneInfo.ConvertTime(checklistItem.Signature.SignedAt.Value, timezone).ToLocaleFullDateShortTimeString(Model.Locale) by @checklistItem.Signature.SignedBy</div>
                                        </div>
                                    }
                                    @if (itemHasTags)
                                    {
                                        <div class="col-12 p-1 pl-3" style="height: auto; align-self: @(itemHasOnlyTagsNoSignatures ? "center" : "flex-start")">
                                            <div class="tag-container">
                                                @foreach (var tag in checklistItem.Tags)
                                                {
                                                    <div class="tag" style="background-color: @tag.ColorCode">
                                                        <div class="tag-wrapper">
                                                            <i class="@(!String.IsNullOrEmpty(tag.IconStyle) ? "fa-" + tag.IconStyle : "fa-solid") @(!String.IsNullOrEmpty(tag.IconName) ? "fa-" + tag.IconName : "fa-question")"></i>
                                                            <span>@tag.Name</span>
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>

                            <div class="item-score status col-2">
                                @if (checklistItem.ActionsCount > 0 || checklistItem.CommentCount > 0)
                                {
                                    <span class="rounded-circle action-status bg-warning status-icon mx-2"><i class="fa fa-bolt-lightning"></i></span>
                                    @:&nbsp;
                                }
                                @if (!string.IsNullOrEmpty(checklistItem.Status))
                                {
                                    <div style="position: relative; align-self: center">
                                        <span class="rounded-circle status-icon @getIconColor(checklistItem.Status) text-white"><i class="fa @getIcon(checklistItem.Status)" title="@checklistItem.Status"></i></span>
                                        @if (checklistItem.PictureProof != null && checklistItem.PictureProof.Media != null && checklistItem.PictureProof.Media.Count > 0)
                                        {
                                            var iconColor = getIconColor(checklistItem.Status);
                                            <div class="statusPPOverlay @iconColor" style="width: 20px; height: 20px; padding: 0px;">
                                                <i class="fas fa-camera"></i>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    @if (checklistItem.Properties != null && checklistItem.Properties.Count() > 0)
                    {
                        <div class="properties-container pt-3">

                            @for (int i = 0; i < checklistItem.Properties.Count(); i++)
                            {
                                var templateProperty = checklistItem.Properties[i];
                                var possibePropertyValue = checklistItem.PropertyUserValues.Where(x => x.PropertyId == templateProperty.PropertyId && x.TemplatePropertyId == templateProperty.Id).FirstOrDefault();
                                if (possibePropertyValue != null && possibePropertyValue.Id > 0)
                                {
                                    string color = "";

                                    DateTime propertyDate = TimeZoneInfo.ConvertTime(possibePropertyValue.CreatedAt.ToLocalTime(), timezone);

                                    if (possibePropertyValue.RegisteredAt != null)
                                    {
                                        propertyDate = TimeZoneInfo.ConvertTime(possibePropertyValue.RegisteredAt.Value.ToLocalTime(), timezone);
                                    }

                                    color = WebApp.Helpers.PropertyHelpers.GetStatusColor(templateProperty, possibePropertyValue);

                                    <div class="property" style="border: 1px solid @color; color: @color">

                                        <div class="property-wrapper">
                                            @if (templateProperty.IsRequired == true)
                                            {
                                                <i class="fa-solid fa-asterisk m-1" style="color: red; position: absolute; top: -1px; right: -1px;"></i>
                                            }
                                            <div class="property-title">
                                                @if (!String.IsNullOrEmpty(templateProperty.TitleDisplay))
                                                {
                                                    <span>@templateProperty.TitleDisplay</span>
                                                }
                                                else
                                                {
                                                    <span>@templateProperty.Property.ShortName</span>
                                                }
                                            </div>

                                            <div class="property-value" data-fulltext="@possibePropertyValue.UserValueString">
                                                @if (possibePropertyValue.UserValueBool == null && possibePropertyValue.UserValueDate == null &&
                                               possibePropertyValue.UserValueDecimal == null && possibePropertyValue.UserValueInt == null &&
                                               possibePropertyValue.UserValueString == null && possibePropertyValue.UserValueTime == null)
                                                {
                                                    <span>Not measured</span>
                                                }
                                                else
                                                {
                                                    <span>
                                                        @possibePropertyValue.UserValueBool
                                                        @possibePropertyValue.UserValueDate
                                                        @(possibePropertyValue.UserValueDecimal / 1.000000000000000000000000000000000m)
                                                        @possibePropertyValue.UserValueInt
                                                        @possibePropertyValue.UserValueString
                                                        @possibePropertyValue.UserValueTime
                                                    </span>
                                                    @if (!string.IsNullOrEmpty(templateProperty.PropertyValueDisplay))
                                                    {
                                                        @templateProperty.PropertyValueDisplay
                                                        ;
                                                    }
                                                    else if (templateProperty.PropertyValue != null)
                                                    {
                                                        @templateProperty.PropertyValue.ValueSymbol
                                                        ;
                                                    }
                                                }

                                            </div>
                                            <div class="property-date">
                                                <span>@propertyDate.ToString("dd MMM yyyy") @propertyDate.ToString("H:mm")</span>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                    }

                    <!-- Picture proof -->
                    @if (checklistItem.PictureProof != null && checklistItem.PictureProof.Media != null && checklistItem.PictureProof.Media.Count > 0)
                    {
                        var startColor = 250;
                        var endColor = 230;
                        var difference = startColor - endColor;
                        var stepSize = difference / (double)checklistItem.PictureProof.Media.Count;

                        var pictureProofColor = (int)(startColor);
                        for (int i = 0; i < checklistItem.PictureProof.Media.Count; i++)
                        {
                            DateTime pictureProofDate = TimeZoneInfo.ConvertTime(checklistItem.PictureProof.Media[i].PictureTakenUtc.ToLocalTime(), timezone);
                            string ppPicture = Constants.General.ImageUnavailableUrl;

                            if (!string.IsNullOrEmpty(checklistItem.PictureProof.Media[i].UriPart))
                            {
                                ppPicture = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, checklistItem.PictureProof.Media[i].UriPart);
                            }

                            var iconColor = getIconColor(checklistItem.Status);

                            <div class="row">
                                <div class="col-auto mr-3" style="width:250px; display: flex; justify-content: center">
                                    <div class="picture-proof-icon"><a class="rounded-circle status-icon @iconColor text-white" style="font-size: 14px"><i class="fas fa-camera status-icon"></i></a></div>
                                </div>
                                <div class="col" style="align-self: center; color: black">
                                    <div><strong>Created:</strong> @pictureProofDate.ToLocaleFullDateShortTimeString(Model.Locale) by @checklistItem.PictureProof.Media[i].UserFullName</div>
                                </div>
                                <div class="col-auto">
                                    <div class="image-container"><div class="image-wrapper" style="text-align: right;"><img data-src="@ppPicture" /></div></div>
                                </div>
                            </div>
                        }

                    }
                </div>

                <!-- Actions linked to checklist item -->
                @{
                    var linkedActions = (Model.Actions != null && Model.Actions.Count > 0) ? Model.Actions.Where(a => a.TaskId == checklistItem.Id).ToList() : null;
                }
                @if (linkedActions != null && linkedActions.Count > 0)
                {
                    <div class="actions-container">

                        <div class="task-actions-comment-container">

                            @foreach (var action in linkedActions)
                            {
                                <div class="row">
                                    <div class="col py-2">
                                        <div class="title" style="display: inline-block">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PdfAuditCompleted.ActionComment, "Comment") ?? "Comment"):</div>
                                        @Html.Raw(action.Comment.Replace(System.Environment.NewLine, "<br />").Replace("\n\r", "<br />").Replace("\n", "<br />").Replace("\r", "<br />"))
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col py-2">
                                        <div class="title" style="display: inline-block">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PdfAuditCompleted.ActionAction, "Action") ?? "Action"):</div>
                                        @Html.Raw(action.Description.Replace(System.Environment.NewLine, "<br />").Replace("\n\r", "<br />").Replace("\n", "<br />").Replace("\r", "<br />"))
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col py-1">
                                        <div class="title" style="display: inline-block">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PdfAuditCompleted.ActionAuthor, "Author") ?? "Author"):</div>
                                        @action.CreatedBy
                                    </div>

                                </div>


                                DateTime actionCreated = TimeZoneInfo.ConvertTime(action.CreatedAt.ToLocalTime(), timezone);
                                <div class="row">
                                    <div class="col py-1">
                                        <div class="title" style="display: inline-block">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PdfAuditCompleted.ActionDate, "Date") ?? "Date"):</div>
                                        @actionCreated.ToLocaleFullDateShortTimeString(Model.Locale)
                                    </div>

                                </div>

                                @if (!action.CreatedAt.Equals(action.ModifiedAt))
                                {
                                    DateTime actionModified = TimeZoneInfo.ConvertTime(action.ModifiedAt.ToLocalTime(), timezone);
                                    <div class="row">
                                        <div class="col py-1">
                                            <div class="title">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PdfAuditCompleted.ActionModificationDate, "Modification date") ?? "Modification date"):</div>
                                            @actionModified.ToLocaleFullDateShortTimeString(Model.Locale)
                                        </div>
                                    </div>
                                }


                                <div class="row">
                                    <div class="col py-1">
                                        <div class="title" style="display: inline-block">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PdfAuditCompleted.ActionDueDate, "Due date") ?? "Due date"):</div>
                                        @action.DueDate.ToLocaleFullDateShortTimeString(Model.Locale)
                                    </div>
                                </div>


                                @if (Model.ApplicationSettings.Features?.TagsEnabled == true)
                                {
                                    @if (action.Tags != null && action.Tags.Count > 0)
                                    {

                                        <div class="tag-container py-2">
                                            @foreach (var tag in action.Tags)
                                            {
                                                <div class="tag" style="background-color: @tag.ColorCode">
                                                    <div class="tag-wrapper">
                                                        <i class="@(!String.IsNullOrEmpty(tag.IconStyle) ? "fa-" + tag.IconStyle : "fa-solid") @(!String.IsNullOrEmpty(tag.IconName) ? "fa-" + tag.IconName : "fa-question")"></i>
                                                        <span>@tag.Name</span>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }
                                }

                                if ((action.Images != null || action.VideoThumbNails != null) && (action.Images.Count > 0 || action.VideoThumbNails.Count > 0))
                                {
                                    <div class="actioncomment-image-container">
                                        @foreach (var image in action.Images)
                                        {
                                            string actionImageUrl = Constants.General.ImageUnavailableUrl;
                                            if (!string.IsNullOrEmpty(image))
                                            {
                                                actionImageUrl = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, image);
                                                actionImageUrl = actionImageUrl.Replace("/media/media", "/media"); //fix for incorrect data in db
                                            }
                                            <div class="action-image-wrapper">
                                                <img data-src="@actionImageUrl" />
                                            </div>
                                        }
                                        @foreach (var videoThumbnail in action.VideoThumbNails)
                                        {
                                            string actionVideoThumbnailUrl = Constants.General.ImageUnavailableUrl;
                                            if (!string.IsNullOrEmpty(videoThumbnail))
                                            {
                                                actionVideoThumbnailUrl = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, videoThumbnail);
                                                actionVideoThumbnailUrl = actionVideoThumbnailUrl.Replace("/media/media", "/media"); //fix for incorrect data in db
                                            }
                                            <div class="action-image-wrapper">
                                                <img data-src="@actionVideoThumbnailUrl" />
                                            </div>
                                        }
                                    </div>
                                }

                            }

                        </div>

                    </div>
                }

                <!-- Comments linked to checklist item -->
                @{
                    var linkedComments = (Model.Comments != null && Model.Comments.Count > 0) ? Model.Comments.Where(a => a.TaskId == checklistItem.Id).ToList() : null;
                }
                @if (linkedComments != null && linkedComments.Count > 0)
                {
                    <div style="break-after:page"></div>
                    <div class="actions-container">

                        <div class="task-actions-comment-container">


                            @foreach (var comment in linkedComments)
                            {
                                <div class="row py-2">
                                    <div class="title" style="display: inline-block">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PdfAuditCompleted.CommentComment, "Comment") ?? "Comment"):</div>
                                    @Html.Raw(comment.CommentText.Replace(System.Environment.NewLine, "<br />").Replace("\n\r", "<br />").Replace("\n", "<br />").Replace("\r", "<br />"))
                                </div>
                                <div class="row py-1">
                                    <div class="title" style="display: inline-block">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PdfAuditCompleted.CommentAuthor, "Author") ?? "Author"):</div>
                                    @comment.CreatedBy
                                </div>

                                DateTime commentCreated = TimeZoneInfo.ConvertTime(comment.CreatedAt.ToLocalTime(), timezone);
                                <div class="row py-1">
                                    <div class="title" style="display: inline-block">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PdfAuditCompleted.CommentDate, "Date") ?? "Date"):</div>
                                    @commentCreated.ToLocaleFullDateShortTimeString(Model.Locale)
                                </div>

                                @if (!comment.CreatedAt.Equals(comment.ModifiedAt))
                                {
                                    DateTime commentModified = TimeZoneInfo.ConvertTime(comment.ModifiedAt.ToLocalTime(), timezone);
                                    <div class="row py-1">
                                        <div class="title" style="display: inline-block">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PdfAuditCompleted.CommentModificationDate, "Modification date") ?? "Modification date"):</div>
                                        @commentModified.ToLocaleFullDateShortTimeString(Model.Locale)
                                    </div>
                                }

                                @if (Model.ApplicationSettings.Features?.TagsEnabled == true)
                                {
                                    @if (comment.Tags != null && comment.Tags.Count > 0)
                                    {

                                        <div class="tag-container py-2">
                                            @foreach (var tag in comment.Tags)
                                            {
                                                <div class="tag" style="background-color: @tag.ColorCode">
                                                    <div class="tag-wrapper">
                                                        <i class="@(!String.IsNullOrEmpty(tag.IconStyle) ? "fa-" + tag.IconStyle : "fa-solid") @(!String.IsNullOrEmpty(tag.IconName) ? "fa-" + tag.IconName : "fa-question")"></i>
                                                        <span>@tag.Name</span>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }
                                }

                                if (comment.Attachments != null && comment.Attachments.Count > 0)
                                {
                                    <div class="actioncomment-image-container">
                                        @foreach (var attachment in comment.Attachments)
                                        {
                                            string commentImageUrl = Constants.General.ImageUnavailableUrl;
                                            if (!string.IsNullOrEmpty(attachment))
                                            {
                                                commentImageUrl = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, attachment);
                                                commentImageUrl = commentImageUrl.Replace("/media/media", "/media"); //fix for incorrect data in db
                                            }
                                            <div class="action-image-wrapper">
                                                <img data-src="@commentImageUrl" />
                                            </div>
                                        }
                                    </div>
                                }
                            }
                        </div>

                    </div>
                }
            </div>
            <hr />

        }
    }
    else if (Model.Checklist != null && Model.Checklist.Tasks != null && Model.Checklist.Tasks.Count > 0)
    {
        <div class="tasks-container">

            @foreach (var checklistItem in Model.Checklist.Tasks)
            {
                <div class="page-break-inside-avoid">
                    <div class="row">
                        <div class="col-auto">
                            <div style="display: inline-block;"><h5 style="font-weight: 600">@(Model.Checklist.Tasks.IndexOf(checklistItem) + 1) </h5></div>
                        </div>
                        <div class="col">
                            <div style="display: inline-block;"><h5 style="font-weight: 600">@checklistItem.Name</h5></div>
                        </div>
                    </div>

                    <div class="item-container">
                        @{
                            string mediaImageUrl = Constants.General.ImageUnavailableUrl;

                            if (!string.IsNullOrEmpty(checklistItem.Picture))
                            {
                                mediaImageUrl = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, checklistItem.Picture);
                            } 
                            else if (!string.IsNullOrEmpty(checklistItem.VideoThumbnail))
                            {
                                mediaImageUrl = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, checklistItem.VideoThumbnail);
                            }
                        }

                        <div class="item-main">
                            <div class="row">
                                <div class="image-container col-auto mr-3">
                                    <div class="image-wrapper"><img data-src="@mediaImageUrl" /></div>
                                </div>

                                @{
                                    bool itemHasTags = (Model.ApplicationSettings.Features?.TagsEnabled == true && checklistItem.Tags != null && checklistItem.Tags.Count > 0);
                                    bool itemHasOnlyTagsNoSignatures = !(checklistItem.Signature != null && checklistItem.Signature.SignedAt.HasValue && !string.IsNullOrEmpty(checklistItem.Signature.SignedBy)) && itemHasTags;
                                }

                                <div class="item-details col">

                                    <div class="row" style="height: 100%; color: black ">

                                        @if (checklistItem.Signature != null && checklistItem.Signature.SignedAt.HasValue && !string.IsNullOrEmpty(checklistItem.Signature.SignedBy))
                                        {
                                            <div class="col-12 item-details-name p-1 pl-3" style="height: auto; align-self: @(itemHasTags ? "flex-end" : "center ")">
                                                Marked on <div style="display: inline-block; font-weight: 400">@TimeZoneInfo.ConvertTime(checklistItem.Signature.SignedAt.Value, timezone).ToLocaleFullDateShortTimeString(Model.Locale) by @checklistItem.Signature.SignedBy</div>
                                            </div>
                                        }

                                        @if (itemHasTags)
                                        {
                                            <div class="col-12 p-1 pl-3" style="height: auto; align-self: @(itemHasOnlyTagsNoSignatures ? "center" : "flex-start")">
                                                <div class="tag-container">
                                                    @foreach (var tag in checklistItem.Tags)
                                                    {
                                                        <div class="tag" style="background-color: @tag.ColorCode">
                                                            <div class="tag-wrapper">
                                                                <i class="@(!String.IsNullOrEmpty(tag.IconStyle) ? "fa-" + tag.IconStyle : "fa-solid") @(!String.IsNullOrEmpty(tag.IconName) ? "fa-" + tag.IconName : "fa-question")"></i>
                                                                <span>@tag.Name</span>
                                                            </div>
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>

                                <div class="item-score status col-2">
                                    @if (checklistItem.ActionsCount > 0 || checklistItem.CommentCount > 0)
                                    {
                                        <span class="rounded-circle action-status bg-warning status-icon mx-2"><i class="fa fa-bolt-lightning"></i></span>
                                        @:&nbsp;
                                    }
                                    @if (!string.IsNullOrEmpty(checklistItem.Status))
                                    {
                                        <div style="position: relative; align-self: center">
                                            <span class="rounded-circle status-icon @getIconColor(checklistItem.Status) text-white"><i class="fa @getIcon(checklistItem.Status)" title="@checklistItem.Status"></i></span>
                                            @if (checklistItem.PictureProof != null && checklistItem.PictureProof.Media != null && checklistItem.PictureProof.Media.Count > 0)
                                            {
                                                var iconColor = getIconColor(checklistItem.Status);
                                                <div class="statusPPOverlay @iconColor" style="width: 20px; height: 20px; padding: 0px;">
                                                    <i class="fas fa-camera"></i>
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>

                        @if (checklistItem.Properties != null && checklistItem.Properties.Count() > 0)
                        {
                            <div class="properties-container pt-3">

                                @for (int i = 0; i < checklistItem.Properties.Count(); i++)
                                {
                                    var templateProperty = checklistItem.Properties[i];
                                    var possibePropertyValue = checklistItem.PropertyUserValues.Where(x => x.PropertyId == templateProperty.PropertyId && x.TemplatePropertyId == templateProperty.Id).FirstOrDefault();
                                    if (possibePropertyValue != null && possibePropertyValue.Id > 0)
                                    {
                                        string color = "";

                                        DateTime propertyDate = TimeZoneInfo.ConvertTime(possibePropertyValue.CreatedAt.ToLocalTime(), timezone);

                                        if (possibePropertyValue.RegisteredAt != null)
                                        {
                                            propertyDate = TimeZoneInfo.ConvertTime(possibePropertyValue.RegisteredAt.Value.ToLocalTime(), timezone);
                                        }

                                        color = WebApp.Helpers.PropertyHelpers.GetStatusColor(templateProperty, possibePropertyValue);

                                        <div class="property" style="border: 1px solid @color; color: @color">
                                            <div class="property-wrapper">
                                                @if (templateProperty.IsRequired == true)
                                                {
                                                    <i class="fa-solid fa-asterisk m-1" style="color: red; position: absolute; top: -1px; right: -1px;"></i>
                                                }

                                                <div class="property-title">
                                                    @if (!String.IsNullOrEmpty(templateProperty.TitleDisplay))
                                                    {
                                                        <span>@templateProperty.TitleDisplay</span>
                                                    }
                                                    else
                                                    {
                                                        <span>@templateProperty.Property.ShortName</span>
                                                    }
                                                </div>

                                                <div class="property-value" data-fulltext="@possibePropertyValue.UserValueString">
                                                    @if (possibePropertyValue.UserValueBool == null && possibePropertyValue.UserValueDate == null &&
                                                    possibePropertyValue.UserValueDecimal == null && possibePropertyValue.UserValueInt == null &&
                                                    possibePropertyValue.UserValueString == null && possibePropertyValue.UserValueTime == null)
                                                    {
                                                        <span>Not measured</span>
                                                    }
                                                    else
                                                    {
                                                        <span>
                                                            @possibePropertyValue.UserValueBool
                                                            @possibePropertyValue.UserValueDate
                                                            @(possibePropertyValue.UserValueDecimal / 1.000000000000000000000000000000000m)
                                                            @possibePropertyValue.UserValueInt
                                                            @possibePropertyValue.UserValueString
                                                            @possibePropertyValue.UserValueTime
                                                        </span>
                                                        @if (!string.IsNullOrEmpty(templateProperty.PropertyValueDisplay))
                                                        {
                                                            @templateProperty.PropertyValueDisplay
                                                            ;
                                                        }
                                                        else if (templateProperty.PropertyValue != null)
                                                        {
                                                            @templateProperty.PropertyValue.ValueSymbol
                                                            ;
                                                        }
                                                    }

                                                </div>
                                                <div class="property-date">
                                                    <span>@propertyDate.ToString("dd MMM yyyy") @propertyDate.ToString("H:mm")</span>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                }
                            </div>
                        }

                        <!-- Picture proof -->
                        @if (checklistItem.PictureProof != null && checklistItem.PictureProof.Media != null && checklistItem.PictureProof.Media.Count > 0)
                        {
                            var startColor = 250;
                            var endColor = 230;
                            var difference = startColor - endColor;
                            var stepSize = difference / (double)checklistItem.PictureProof.Media.Count;

                            var pictureProofColor = (int)(startColor);
                            for (int i = 0; i < checklistItem.PictureProof.Media.Count; i++)
                            {
                                DateTime pictureProofDate = TimeZoneInfo.ConvertTime(checklistItem.PictureProof.Media[i].PictureTakenUtc.ToLocalTime(), timezone);
                                string ppPicture = Constants.General.ImageUnavailableUrl;

                                if (!string.IsNullOrEmpty(checklistItem.PictureProof.Media[i].UriPart))
                                {
                                    ppPicture = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, checklistItem.PictureProof.Media[i].UriPart);
                                }

                                var iconColor = getIconColor(checklistItem.Status);

                                <div class="row">
                                    <div class="col-auto mr-3" style="width:250px; display: flex; justify-content: center">
                                        <div class="picture-proof-icon"><a class="rounded-circle status-icon @iconColor text-white" style="font-size: 14px"><i class="fas fa-camera status-icon"></i></a></div>
                                    </div>
                                    <div class="col" style="align-self: center; color: black">
                                        <div><strong>Created:</strong> @pictureProofDate.ToLocaleFullDateShortTimeString(Model.Locale) by @checklistItem.PictureProof.Media[i].UserFullName</div>
                                    </div>
                                    <div class="col-auto">
                                        <div class="image-container"><div class="image-wrapper" style="text-align: right;"><img data-src="@ppPicture" /></div></div>
                                    </div>
                                </div>
                            }

                        }
                    </div>

                    <!-- Actions linked to checklist item -->
                    @{
                        var linkedActions = (Model.Actions != null && Model.Actions.Count > 0) ? Model.Actions.Where(a => a.TaskId == checklistItem.Id).ToList() : null;
                    }
                    @if (linkedActions != null && linkedActions.Count > 0)
                    {
                        <div class="actions-container">

                        <div class="task-actions-comment-container">
                            
                            @foreach (var action in linkedActions)
                            {
                                <div class="row"> 
                                    <div class="col py-2">
                                        <div class="title" style="display: inline-block">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PdfAuditCompleted.ActionComment, "Comment") ?? "Comment"):</div>
                                        @Html.Raw(action.Comment.Replace(System.Environment.NewLine, "<br />").Replace("\n\r", "<br />").Replace("\n", "<br />").Replace("\r", "<br />"))
                                    </div>
                                </div>
                            
                                <div class="row">
                                    <div class="col py-2">
                                        <div class="title" style="display: inline-block">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PdfAuditCompleted.ActionAction, "Action") ?? "Action"):</div>
                                        @Html.Raw(action.Description.Replace(System.Environment.NewLine, "<br />").Replace("\n\r", "<br />").Replace("\n", "<br />").Replace("\r", "<br />"))
                                    </div>
                                </div>
                            
                                <div class="row">
                                    <div class="col py-1">
                                        <div class="title" style="display: inline-block">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PdfAuditCompleted.ActionAuthor, "Author") ?? "Author"):</div>
                                        @action.CreatedBy
                                    </div>
                            
                                </div>


                                    DateTime actionCreated = TimeZoneInfo.ConvertTime(action.CreatedAt.ToLocalTime(), timezone);
                                    <div class="row">
                                        <div class="col py-1">
                                            <div class="title" style="display: inline-block">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PdfAuditCompleted.ActionDate, "Date") ?? "Date"):</div>
                                            @actionCreated.ToLocaleFullDateShortTimeString(Model.Locale)
                                        </div>

                                    </div>

                                    @if (!action.CreatedAt.Equals(action.ModifiedAt))
                                    {
                                        DateTime actionModified = TimeZoneInfo.ConvertTime(action.ModifiedAt.ToLocalTime(), timezone);
                                        <div class="row">
                                            <div class="col py-1">
                                                <div class="title">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PdfAuditCompleted.ActionModificationDate, "Modification date") ?? "Modification date"):</div>
                                                @actionModified.ToLocaleFullDateShortTimeString(Model.Locale)
                                            </div>
                                        </div>
                                    }
                            
                            
                                <div class="row">
                                    <div class="col py-1">
                                        <div class="title" style="display: inline-block">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PdfAuditCompleted.ActionDueDate, "Due date") ?? "Due date"):</div>
                                        @action.DueDate.ToLocaleFullDateShortTimeString(Model.Locale)
                                    </div>
                                </div>
                            
                            
                                @if (Model.ApplicationSettings.Features?.TagsEnabled == true)
                                {
                                    @if (action.Tags != null && action.Tags.Count > 0)
                                    {
                                        
                                        <div class="tag-container py-2">
                                            @foreach (var tag in action.Tags)
                                            {
                                                <div class="tag" style="background-color: @tag.ColorCode">
                                                    <div class="tag-wrapper">
                                                        <i class="@(!String.IsNullOrEmpty(tag.IconStyle) ? "fa-" + tag.IconStyle : "fa-solid") @(!String.IsNullOrEmpty(tag.IconName) ? "fa-" + tag.IconName : "fa-question")"></i>
                                                        <span>@tag.Name</span>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }
                                }

                                if ((action.Images != null || action.VideoThumbNails != null) && (action.Images.Count > 0 || action.VideoThumbNails.Count > 0))
                                {
                                    <div class="actioncomment-image-container">
                                        @foreach (var image in action.Images)
                                        {
                                            string actionImageUrl = Constants.General.ImageUnavailableUrl;
                                            if (!string.IsNullOrEmpty(image))
                                            {
                                                actionImageUrl = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, image);
                                                actionImageUrl = actionImageUrl.Replace("/media/media", "/media"); //fix for incorrect data in db
                                            }
                                            <div class="action-image-wrapper">
                                                <img data-src="@actionImageUrl" />
                                            </div>
                                        }
                                        @foreach (var videoThumbnail in action.VideoThumbNails)
                                        {
                                            string actionVideoThumbnailUrl = Constants.General.ImageUnavailableUrl;
                                            if (!string.IsNullOrEmpty(videoThumbnail))
                                            {
                                                actionVideoThumbnailUrl = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, videoThumbnail);
                                                actionVideoThumbnailUrl = actionVideoThumbnailUrl.Replace("/media/media", "/media"); //fix for incorrect data in db
                                            }
                                            <div class="action-image-wrapper">
                                                <img data-src="@actionVideoThumbnailUrl" />
                                            </div>
                                        }
                                    </div>  
                                }

                            }
                            </div>

                    </div>
                    }

                    <!-- Comments linked to checklist item -->
                    @{
                        var linkedComments = (Model.Comments != null && Model.Comments.Count > 0) ? Model.Comments.Where(a => a.TaskId == checklistItem.Id).ToList() : null;
                    }
                    @if (linkedComments != null && linkedComments.Count > 0)
                    {
                        <div style="break-after:page"></div>
                        <div class="actions-container">

                            <div class="task-actions-comment-container">


                                @foreach (var comment in linkedComments)
                                {
 
                                    <div class="row py-2">
                                        <div class="title" style="display: inline-block">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PdfAuditCompleted.CommentComment, "Comment") ?? "Comment"):</div>
                                        @Html.Raw(comment.CommentText.Replace(System.Environment.NewLine, "<br />").Replace("\n\r", "<br />").Replace("\n", "<br />").Replace("\r", "<br />"))
                                    </div>
                                    <div class="row py-1">
                                        <div class="title" style="display: inline-block">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PdfAuditCompleted.CommentAuthor, "Author") ?? "Author"):</div>
                                        @comment.CreatedBy
                                    </div>

                                    DateTime commentCreated = TimeZoneInfo.ConvertTime(comment.CreatedAt.ToLocalTime(), timezone);
                                    <div class="row py-1">
                                        <div class="title" style="display: inline-block">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PdfAuditCompleted.CommentDate, "Date") ?? "Date"):</div>
                                        @commentCreated.ToLocaleFullDateShortTimeString(Model.Locale)
                                    </div>

                                    @if (!comment.CreatedAt.Equals(comment.ModifiedAt))
                                    {
                                        DateTime commentModified = TimeZoneInfo.ConvertTime(comment.ModifiedAt.ToLocalTime(), timezone);
                                        <div class="row py-1">
                                            <div class="title" style="display: inline-block">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PdfAuditCompleted.CommentModificationDate, "Modification date") ?? "Modification date"):</div>
                                            @commentModified.ToLocaleFullDateShortTimeString(Model.Locale)
                                        </div>
                                    }

                                    @if (Model.ApplicationSettings.Features?.TagsEnabled == true)
                                    {
                                        @if (comment.Tags != null && comment.Tags.Count > 0)
                                        {
                                        
                                            <div class="tag-container py-2">
                                                @foreach (var tag in comment.Tags)
                                                {
                                                    <div class="tag" style="background-color: @tag.ColorCode">
                                                        <div class="tag-wrapper">
                                                            <i class="@(!String.IsNullOrEmpty(tag.IconStyle) ? "fa-" + tag.IconStyle : "fa-solid") @(!String.IsNullOrEmpty(tag.IconName) ? "fa-" + tag.IconName : "fa-question")"></i>
                                                            <span>@tag.Name</span>
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        }
                                    }

                                    if(comment.Attachments != null && comment.Attachments.Count > 0)
                                    {
                                        <div class="actioncomment-image-container">
                                            @foreach (var attachment in comment.Attachments)
                                            {
                                                string commentImageUrl = Constants.General.ImageUnavailableUrl;
                                                if (!string.IsNullOrEmpty(attachment))
                                                {
                                                    commentImageUrl = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, attachment);
                                                    commentImageUrl = commentImageUrl.Replace("/media/media", "/media"); //fix for incorrect data in db
                                                }
                                                <div class="action-image-wrapper">
                                                    <img data-src="@commentImageUrl" />
                                                </div>
                                            }
                                        </div>
                                    }
                                }
                            </div>

                        </div>
                        }

                </div>
                <hr />

            }
        </div>
    }


        @if (Model.Checklist.Signatures != null && Model.Checklist.IsCompleted && (Model.Checklist.IsSignatureRequired || Model.Checklist.IsDoubleSignatureRequired))
        {
            
            <div class="signature-container page-break-inside-avoid">
            <h5 class="title">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PdfAuditCompleted.Signatures, "Signatures") ?? "Signatures")</h5>
            
            @{
                var signedAt = Model.Checklist.Signatures != null && Model.Checklist.Signatures.Count > 0 ? Model.Checklist.Signatures.First().SignedAt : null;
            }
            <div class="row pb-2">
                <div class="col-12">
                    <div class="">
                        <p class="mb-0">Checklist: @Model.Checklist.Name</p>
                        @if(signedAt != null)
                        {
                            DateTime SignedDate = TimeZoneInfo.ConvertTime(signedAt.Value, timezone);
                            <span style="color: #8E8E8E">Date: @SignedDate.ToLocaleFullDateShortTimeString(Model.Locale)</span>
                        }
                    </div>
                </div>
            </div>

            <div class="row">
                @foreach (var signature in Model.Checklist.Signatures)
                {
                    var sigpic = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, signature.SignatureImage);

                    <div class="col-6">
                        <div class=signature-image-container>
                            @if (!string.IsNullOrEmpty(signature.SignatureImage))
                            {
                                <div class="image-wrapper" style="border: 1px solid #8E8E8E7F">
                                    <img class="signature-image" data-src="@sigpic" />
                                    <div class="signature-signed">@signature.SignedBy</div>
                                </div>
                            }
                            else
                            {
                                <div class="image-wrapper" style="border: 1px solid #8E8E8E7F">
                                    <div style="max-height: 100%;min-height: 200px;max-width: 80%;display: inline-block;"></div>
                                    <div class="signature-signed">@signature.SignedBy</div>
                                </div>
                            }
                        </div>
                    </div>
                }
                </div>
            </div>
        }
        else if(Model.Checklist.IsCompleted == true && !Model.Checklist.IsDoubleSignatureRequired && !Model.Checklist.IsSignatureRequired)
        {
            <div class="signature-container page-break-inside-avoid">
                <h5 class="title">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PdfAuditCompleted.Signatures, "Signatures") ?? "Signatures")</h5>
            
                @{
                    var signedAt = Model.Checklist.Signatures != null && Model.Checklist.Signatures.Count > 0 ? Model.Checklist.Signatures.First().SignedAt : null;
                }
                <div class="row pb-2">
                    <div class="col-12">
                        <div class="">
                            <p class="mb-0">Checklist: @Model.Checklist.Name</p>
                            @if(signedAt != null)
                            {
                                DateTime SignedDate = TimeZoneInfo.ConvertTime(signedAt.Value, timezone);
                                <span style="color: #8E8E8E">Date: @SignedDate.ToLocaleFullDateShortTimeString(Model.Locale)</span>
                            }
                        </div>
                    </div>
                </div>
            
            </div>
        }
        else if(Model.Checklist.IsCompleted == false && Model.Checklist.IsDoubleSignatureRequired)
        {
            <div style="break-after:page"></div>
       
            <div class="signature-container">
            <h5 class="title">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PdfAuditCompleted.Signatures, "Signatures") ?? "Signatures")</h5>

            <div class="row pb-2">
                <div class="col-12">
                    <div class="">
                        <p class="mb-0">Checklist: @Model.Checklist.Name</p>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-6">
                    <div class=signature-image-container>
                        <div class="image-wrapper" style="border: 1px solid #8E8E8E7F">
                            <div style="max-height: 100%;min-height: 200px;max-width: 80%;display: inline-block;"></div>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class=signature-image-container>
                        <div class="image-wrapper" style="border: 1px solid #8E8E8E7F">
                            <div style="max-height: 100%;min-height: 200px; max-width: 80%;display: inline-block;"></div>
                        </div>
                    </div>
                </div>
                </div>
            </div>
        }
        else if(Model.Checklist.IsCompleted == false && Model.Checklist.IsSignatureRequired && !Model.Checklist.IsDoubleSignatureRequired)
        {
            <div style="break-after:page"></div>
       
            <div class="signature-container">
                <h5 class="title">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PdfAuditCompleted.Signatures, "Signatures") ?? "Signatures")</h5>

                <div class="row pb-2">
                    <div class="col-12">
                        <div class="">
                        <p class="mb-0">Checklist: @Model.Checklist.Name</p>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6">
                        <div class=signature-image-container>
                            <div class="image-wrapper" style="border: 1px solid #8E8E8E7F">
                                <div style="max-height: 100%;min-height: 200px;max-width: 80%;display: inline-block;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
        else if(Model.Checklist.IsCompleted == false && !Model.Checklist.IsSignatureRequired && !Model.Checklist.IsDoubleSignatureRequired)
        {
            <div style="break-after:page"></div>

            <div class="signature-container">
                <h5 class="title">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PdfAuditCompleted.Signatures, "Signatures") ?? "Signatures")</h5>

                <div class="row pb-2">
                    <div class="col-12">
                        <div class="">
                            <p class="mb-0">Checklist: @Model.Checklist.Name</p>
                        </div>
                    </div>
                </div>
            </div>
        }

    <input type="text" id="dummyfocus" style="width:0px;height:0px;border: 0px;margin:0px;padding:0px;"/>
   
    <script>
        ezgomediafetcher.preloadImagesAndVideos();

        var checklistImgs = document.images,
            checklistImgsLength = checklistImgs.length,
            checklistImgsCounter = 0,
            checklistImgsLoaded = false,
            checklistImgsCheckerInterval = null;

        [].forEach.call(checklistImgs, function (img) {
            if (img.complete && $(img).attr('src') != undefined && ($(img).attr('src').includes('normal_unavailable_image.png') || $(img).attr('src').startsWith('blob:')))
                incrementCounter();
            else
                img.addEventListener('load', incrementCounter, false);
        });

        function incrementCounter() {
            checklistImgsCounter++;
            if (checklistImgsCounter === checklistImgsLength) {
                checklistImgsLoaded = true
            }
        }
        //print functionality, make sure page is fully loaded, scrolldown, focus on dummy element to force render if not already occured, add print to stack, set timeout with close so page will auto close. 
        // window.onload = function () {
        //     setTimeout(() => {
        //         window.scrollTo(0, document.body.scrollHeight);
        //         dummyfocus.focus();
        //         setTimeout(() => {
        //             window.print();  
        //         });
        //         setTimeout(function () { window.close(); }, 2000);
        //     }, 1000);
        // };

        window.onload = function () {
            // window.scrollTo(0, document.body.scrollHeight);
            // dummyfocus.focus();
            checklistImgsCheckerInterval = setInterval(() => {
                if (!checklistImgsLoaded) {
                    //do nothing
                }
                else {
                    clearInterval(checklistImgsCheckerInterval);
                    setTimeout(() => {
                        window.print();
                    });
                    setTimeout(function () { window.close(); }, 2000);
                }

            }, 1000);
        }
    </script>
</body>
</html>


