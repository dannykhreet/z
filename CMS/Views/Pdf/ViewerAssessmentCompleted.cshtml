@model PdfAssessmentCompletedViewModel
@{
    Layout = null;

    var colorCalculator = new WebApp.Logic.Services.DefaultScoreColorCalculator();
    var tz = User.FindFirst(System.Security.Claims.ClaimTypes.Country)?.Value ?? "Europe/Amsterdam";
    TimeZoneInfo timezone = TZConvert.EzFindTimeZoneInfoById(tz);


    if (Model.Assessment != null && Model.Assessment.Tags != null & Model.Assessment.Tags.Count > 0)
    {
        Model.Assessment.Tags = Model.Assessment.Tags.OrderBy(t => t.Id).ToList();
        if (Model.Assessment.SkillInstructions != null && Model.Assessment.SkillInstructions.Count > 0)
        {
            foreach (var skillInstruction in Model.Assessment.SkillInstructions)
            {
                if (skillInstruction.Tags != null && skillInstruction.Tags.Count > 0)
                {
                    skillInstruction.Tags = skillInstruction.Tags.OrderBy(t => t.Id).ToList();
                }
            }
        }
    }

    string unknownColor = "#EAF0F6";

    string redColor = "#ED5554";
    double redMinScore = 0.0d;
    double redMaxScore = 1.9d;

    string yellowColor = "#FDC02F";
    double yellowMinScore = 2.0d;
    double yellowMaxScore = 3.5d;

    string greenColor = "#1CD95E";
    double greenMinScore = 3.6d;
    double greenMaxScore = 5.0d;

    //Make sure to round score to 1 digit before using this
    string GetAssessmentScoreStyle(double score)
    {
        if (redMinScore <= score && score <= redMaxScore)
        {
            return $"background-color: {redColor}";
        }
        else if (yellowMinScore <= score && score <= yellowMaxScore)
        {
            return $"background-color: {yellowColor}";
        }
        else if (greenMinScore <= score && score <= greenMaxScore)
        {
            return $"background-color: {greenColor}";
        }

        return $"background-color: {unknownColor}";
    }
}
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    @{
        var documentTitle = "";
        if(Model.Assessment.IsCompleted)
        {
            documentTitle = "Completed assessment: " + Model.Assessment.Name;
        }
        else
        {
            documentTitle = "Open assessment: " + Model.Assessment.Name;
        }
    }
    <title>@documentTitle</title>
    <link rel="stylesheet" href="/css/pdf.css" />
    <partial name="_pdfCss" /> @*above link doesnt work on docker for some reason*@

    <!-- Font Awesome -->
    <link rel="stylesheet" href="/plugins/fontawesome-pro-6.5.2-web/css/all.min.css" />
    <script src="~/lib/vendor/jquery/dist/jquery.min.js"></script>
    <!-- Bootstrap -->
    <link href="~/lib/vendor/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1337.0.min.js"></script>
    <script src="/js/ezgomediafetcher.js"></script>
    <style>

        body {
        font-family: "Source Sans Pro",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";
        font-size: 18px;
        white-space: nowrap;
        margin: 0 1rem 0 1rem;
        }

        table {
        table-layout: fixed;
        border-collapse: separate;
        border-spacing: 0px;
        padding: 0px;
        margin: 0px;
        }

        strong {
        font-weight: 600;
        }

        .pdfTable {
        width: 100%;
        height: auto;
        margin: 0;
        border-collapse: collapse;
        table-layout: fixed;
        page-break-inside: avoid;
        }

        td {
        background-size: 100% 100%;
        background-position-x: 0;
        background-position-y: 0;
        word-wrap: break-word;
        white-space: normal;
        overflow: hidden;
        }

        tr {
        padding-left: 2rem;
        }

        .btn {
        display: inline-block;
        font-weight: 400;
        color: #212529;
        text-align: center;
        vertical-align: middle;
        cursor: pointer;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        background-color: transparent;
        border: 1px solid transparent;
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        line-height: 1.5;
        border-radius: 0.25rem;
        transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .signatureimg {
        width: 25%;
        height: 25%;
        padding-bottom: 10px;
        }

    </style>

    <!-- Tags -->
    <style>
        .card {
        position: relative;
        display: -ms-flexbox;
        display: flex;
        -ms-flex-direction: column;
        flex-direction: column;
        min-width: 0;
        word-wrap: break-word;
        background-color: #ffffff;
        background-clip: border-box;
        border: 0 solid rgba(0, 0, 0, 0.125);
        border-radius: 0.25rem;
        }

        .tag-card {
        display: inline-block;
        width: 9em;
        color: white;
        align-content: center;
        align-items: center;
        }

        .tag-wrapper {
        width: 100%;
        width: -moz-available;
        width: -webkit-fill-available;
        display: flex;
        height: 2.6em;
        line-height: 1.1;
        }

        .tag-span {
        text-align: center;
        align-self: center;
        display: inline-block;
        width: 100%;
        width: -moz-available;
        width: -webkit-fill-available;
        }

        .nav-icon {
        float: left;
        display: inline-block;
        }

        .card {
        box-shadow: none;
        border-radius: 10px;
        }
    </style>

    <!-- Picture proof and icon colors -->
    <style>

        .rounded-circle {
        border-radius: 50% !important;
        min-width: 40px;
        min-height: 40px;
        max-width: 40px;
        max-height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        }

        .status-icon {
        font-size: 1.3em;
        }

        .text-white {
        color: #ffffff;
        }

        .ok-status {
        width: 40px;
        height: 40px;
        padding: 10px 10px 10px 10px;
        }

        .notok-status {
        width: 40px;
        height: 40px;
        padding: 10px 10px 10px 10px;
        }

        .skipped-status {
        width: 40px;
        height: 40px;
        padding: 10px 10px 10px 10px;
        color: #fff !important;
        background-color: #ffc107 !important;
        }

        .action-status {
        width: 40px;
        height: 40px;
        padding: 10px 10px 10px 10px;
        color: #fff !important;
        background-color: #ffc107 !important;
        }

        .bg-red {
        background-color: #dc3545;
        }

        .bg-orange {
        background-color: #ffc107;
        }

        .bg-warning {
        background-color: #ffc107;
        }

        .bg-green {
        background-color: #28a745;
        }

        .d-flex {
        display: -ms-flexbox !important;
        display: flex !important;
        }

        .justify-content-between {
        -ms-flex-pack: justify !important;
        justify-content: space-between !important;
        }

        .align-items-center {
        -ms-flex-align: center !important;
        align-items: center !important;
        }

        .align-items-end {
        -ms-flex-align: end !important;
        align-items: flex-end !important;
        }

        .overlaytop {
        position: absolute;
        padding: 0px;
        margin: 0px;
        top: 0;
        left: 0;
        width: 3em;
        height: 3em;
        line-height: 3em;
        vertical-align: middle;
        text-align: center;
        background: #00a054;
        color: white;
        }

        .overlaytop2 {
        position: absolute;
        padding: 0px;
        margin: 0px;
        top: 0;
        left: 0;
        width: 2rem;
        height: 2rem;
        line-height: 2rem;
        font-size: 0.67rem;
        vertical-align: middle;
        text-align: center;
        background: #00a054;
        color: white;
        }

        .overlaybottom {
        position: absolute;
        padding: 0px;
        margin: 0px;
        left: 0;
        bottom: 0;
        width: 2em;
        height: 2em;
        line-height: 2em;
        vertical-align: middle;
        text-align: center;
        background: black;
        color: white;
        }


        .score {
        color: #fff;
        width: 40px;
        height: 40px;
        padding: 10px;
        font-size: 23px;
        }

        .score-large {
        color: #fff;
        width: 40px;
        height: 40px;
        padding: 10px;
        font-size: 23px;
        }

    </style>
    <style>
        .strong-text-and-inline {
            display: inline-block;
            font-weight: 600;
        }

        .imageWrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
        }
    </style>
    <style>

        .my-circle {
            display: inline-block;
            border-radius: 60px;
            padding: 0.8em 1.1em;
            background-color: #3f903f;
            color: #fff;
        }

            .my-circle i {
                font-size: 20px;
            }

        .status-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff !important;
            flex-grow: 0;
            flex-shrink: 0;
        }

        .status-icon {
            font-size: 18px;
            display: flex;
            margin: auto;
        }

        .status-circle-big {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff !important;
            flex-grow: 0;
            flex-shrink: 0;
        }

        .status-icon-big {
            font-size: 2em;
            display: flex;
            margin: auto;
        }
    </style>
</head>
<body>
    <div>
        <div class="row">
            <div class="col-12">
                <div class="row">
                    <div class="col-12">
                        <h1 style="font-weight: 600;max-width: calc(100%);text-overflow:ellipsis;white-space:nowrap;word-wrap:break-word;overflow:hidden;display:block">@Model.Assessment.Name</h1>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <h2 style="max-width: calc(100%);text-overflow:ellipsis;white-space:nowrap;word-wrap:break-word;overflow:hidden;display:block">@Model.Assessment.Description</h2>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6">
                        <div>
                            <div class="strong-text-and-inline">
                                Completed for
                            </div>: @Model.Assessment.CompletedFor
                        </div>
                        <div style="text-wrap: wrap;word-wrap:break-word; width: 100%">
                            @{
                                var assessmentAssessors = string.Join(", ", Model.Assessment.Assessors.Select(a => a.Name));
                                if(string.IsNullOrEmpty(assessmentAssessors))
                                {
                                    assessmentAssessors = "-";
                                }
                            }
                            <div class="strong-text-and-inline">
                                Assessors
                            </div>: @(assessmentAssessors)
                        </div>
                    </div>
                    <div class="col-6" style="text-align: left">
                        <div>
                            <div class="strong-text-and-inline">
                                Started
                            </div>:
                            @if (Model.Assessment.StartDate.HasValue)
                            {
                                DateTime StartDate = TimeZoneInfo.ConvertTime(Model.Assessment.StartDate.Value, timezone);
                                @StartDate.ToString("dddd, MMMM d, yyyy, HH:mm")
                            }
                            else
                            {
                                @:-
                            }
                        </div>
                        <div>
                            <div class="strong-text-and-inline">
                                Ended
                            </div>:
                            @if (Model.Assessment.IsCompleted == true && Model.Assessment.EndDate.HasValue)
                            {
                                DateTime EndDate = TimeZoneInfo.ConvertTime(Model.Assessment.EndDate.Value, timezone);
                                @EndDate.ToString("dddd, MMMM d, yyyy, HH:mm")
                            }
                            else
                            {
                                @:-
                            }
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="strong-text-and-inline">
                                    Assessment score
                                </div>:
                                @{
                                    List<double> averages = new List<double>();
                                    foreach (var skillInstruction in Model.Assessment.SkillInstructions)
                                    {
                                        averages.Add(((double)skillInstruction.TotalScore.Value / (double)(skillInstruction.InstructionItems?.Count ?? 1)));
                                    }

                                    int totalInstructions = 0;
                                    foreach (var skillInstruction in Model.Assessment.SkillInstructions)
                                    {
                                        totalInstructions += skillInstruction.InstructionItems?.Count ?? 1;
                                    }

                                    var assessmentScore = (Model.Assessment.TotalScore.HasValue ? Math.Round(((double)Model.Assessment.TotalScore.Value / totalInstructions), 2) : 1.0d);
                                }
                                @if (Model.Assessment.IsCompleted != null && Model.Assessment.IsCompleted == true)
                                {
                                    @(string.Format("{0:0.00}", Math.Round(assessmentScore, 2)))
                                }
                                else
                                {
                                    @:-
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tags -->
        @if (Model.ApplicationSettings.Features?.TagsEnabled == true)
        {
            @if (Model.Assessment.Tags != null && Model.Assessment.Tags.Count > 0)
            {
                <div class="row">
                    <div class="col-12">
                        <div style="padding-top: 0.75rem; padding-right: 2rem; padding-bottom: 1rem; text-wrap: wrap;word-wrap:break-word;">
                            @foreach (var tag in Model.Assessment.Tags)
                            {
                                <div class="card column m-1 tag-card" style="background-color: @tag.ColorCode; margin: 0.25rem">
                                    <div class="tag-wrapper" style="">
                                        <i style="margin-top: auto; margin-bottom: auto; margin-left: 0.5rem; margin-right: 0px" class="nav-icon my-auto ml-2 mr-0 @(!String.IsNullOrEmpty(tag.IconStyle) ? "fa-" + tag.IconStyle : "fa-solid") @(!String.IsNullOrEmpty(tag.IconName) ? "fa-" + tag.IconName : "fa-question")"></i>
                                        <span style="margin-top: auto; margin-bottom: auto; margin-right: 0.5rem" class="my-auto mr-2 tag-span">@tag.Name</span>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        }

        <!-- Assessment items -->
        @if (Model.Assessment != null && Model.Assessment.SkillInstructions != null && Model.Assessment.SkillInstructions.Count > 0)
        {
            @foreach (var skillInstruction in Model.Assessment.SkillInstructions)
            {
                <div class="row pt-3">
                    <div class="col-12">
                        <div class="row pb-2">
                            <div class="col-auto" style="font-weight: 600">@(Model.Assessment.SkillInstructions.IndexOf(skillInstruction) + 1)</div>
                            <div class="col" style="font-weight: 600;text-wrap:wrap;word-wrap:break-word">@skillInstruction.Name</div>
                            <div class="col-auto">

                                <div style="text-align:right;padding-right: 0.75rem">
                                    <div class="align-items-center">
                                        @{
                                            var relevantInstructionItems = skillInstruction.InstructionItems?.Where(i => i.IsCompleted.HasValue && i.IsCompleted.Value == true && i.Score != null).ToList();
                                            var instructionScore = Math.Round((double)skillInstruction.TotalScore.Value / relevantInstructionItems?.Count() ?? 1, 1);
                                            bool allInstructionItemsScored = skillInstruction.InstructionItems != null && skillInstruction.InstructionItems.Count > 0 && relevantInstructionItems.Count == skillInstruction.InstructionItems.Count;
                                        }
                                        @if (allInstructionItemsScored)
                                        {
                                            <span class="status-circle text-white" style="justify-self: right; @(GetAssessmentScoreStyle(Math.Round(instructionScore, 1)))">
                                                <span class="status-icon">@(string.Format("{0:0.0}", Math.Round(instructionScore, 1)))</span>
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="status-circle" style="background-color: #EAF0F6; justify-self: right">
                                                <span class="status-icon"></span>
                                            </span>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-3">
                                @{
                                    string mediaImageUrl = Constants.General.ImageUnavailableUrl;

                                    if (!string.IsNullOrEmpty(skillInstruction.Picture))
                                    {
                                        mediaImageUrl = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, skillInstruction.Picture);
                                    }
                                }
                                <div class="imageWrapper"><img style="" data-src="@mediaImageUrl" /></div>
                            </div>
                            <div class="col-9 instructionItemDetails" style="display:flex;flex-direction:column;color:#8E8E8E">
                                <div class="row"style="">
                                    <div class="col-12">
                                        <div style="text-wrap:wrap;word-wrap:break-word;color:#000000">
                                            @skillInstruction.Description
                                        </div>
                                    </div>
                                </div>
                                <div class="row"style="">
                                    <div class="col-12">
                                        @{
                                            var instructionAssessors = string.Join(", ", skillInstruction.Assessors.Select(a => a.Name));
                                            if(string.IsNullOrEmpty(instructionAssessors))
                                            {
                                                instructionAssessors = "-";
                                            }
                                        }
                                        <div style="text-wrap:wrap;word-wrap:break-word;">
                                            Assessors: @(instructionAssessors)
                                        </div>
                                    </div>
                                </div>
                                <div class="row"style="">
                                    <div class="col-12">
                                        <div style="text-wrap:wrap;word-wrap:break-word;">
                                            Started: 
                                            @if (skillInstruction.StartDate.HasValue)
                                            {
                                                DateTime StartDate = TimeZoneInfo.ConvertTime(skillInstruction.StartDate.Value, timezone);
                                                @StartDate.ToString("dddd, MMM d, yyyy, HH:mm")
                                            }
                                            else
                                            {
                                                @:-
                                            }
                                        </div>
                                    </div>
                                </div>
                                <div class="row"style="">
                                    <div class="col-12">
                                        <div style="text-wrap:wrap;word-wrap:break-word;">
                                            Ended:
                                            @if (skillInstruction.IsCompleted == true && skillInstruction.EndDate.HasValue)
                                            {
                                                DateTime maxCompletedItemTime = skillInstruction.InstructionItems.Select(item => item.CompletedAt.HasValue ? item.CompletedAt.Value : DateTime.MinValue).Max();
                                                DateTime trueEndDate = skillInstruction.EndDate.Value >= maxCompletedItemTime ? skillInstruction.EndDate.Value : maxCompletedItemTime;
                                                DateTime EndDate = TimeZoneInfo.ConvertTime(trueEndDate, timezone);
                                                @EndDate.ToString("dddd, MMM d, yyyy, HH:mm")
                                            }
                                            else
                                            {
                                                @:-
                                            }
                                        </div>
                                    </div>
                                </div>
                                @if (Model.ApplicationSettings.Features?.TagsEnabled == true)
                                {
                                    @if (skillInstruction.Tags != null && skillInstruction.Tags.Count > 0)
                                    {
                                        <div class="row">
                                            <div class="col-12">
                                                <div style="padding-top: 1rem; padding-bottom: 1rem; padding-right: 1rem; text-wrap: wrap;word-wrap:break-word;">
                                                    @foreach (var tag in skillInstruction.Tags)
                                                    {
                                                        <div class="card column m-1 tag-card" style="background-color: @tag.ColorCode; margin: 0.25rem">
                                                            <div class="tag-wrapper" style="">
                                                                <i style="margin-top: auto; margin-bottom: auto; margin-left: 0.5rem; margin-right: 0px" class="nav-icon my-auto ml-2 mr-0 @(!String.IsNullOrEmpty(tag.IconStyle) ? "fa-" + tag.IconStyle : "fa-solid") @(!String.IsNullOrEmpty(tag.IconName) ? "fa-" + tag.IconName : "fa-question")"></i>
                                                                <span style="margin-top: auto; margin-bottom: auto; margin-right: 0.5rem" class="my-auto mr-2 tag-span">@tag.Name</span>
                                                            </div>
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    }
                                }
                            </div>
                        </div>

                        @if (skillInstruction.InstructionItems != null)
                        {
                            @foreach (var instructionItem in skillInstruction.InstructionItems)
                            {
                                <div class="row pt-3" style="margin-left: 3rem;color:#8E8E8E">
                                    @{
                                        string instructionItemImageUrl = Constants.General.ImageUnavailableUrl;
                                        if (!string.IsNullOrEmpty(instructionItem.Picture))
                                        {
                                            instructionItemImageUrl = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, instructionItem.Picture);
                                        }
                                        else if (!string.IsNullOrEmpty(instructionItem.VideoThumbnail))
                                        {
                                            instructionItemImageUrl = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, instructionItem.VideoThumbnail);
                                        }
                                    }
                                    <div class="col-3 pl-2" style="text-align:right">
                                        <div class="imageWrapper"><img style="" data-src="@instructionItemImageUrl" /></div>
                                    </div>
                                    <div class="col" style="display:flex;">
                                        <div style="align-self: center">
                                            <div class="row" style="color:#000000">
                                                <div class="col-12">
                                                    <div style="text-wrap:wrap;word-wrap:break-word;font-weight: 600">
                                                        @instructionItem.Name
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row" style="">
                                                <div class="col-12">
                                                    <div style="text-wrap:wrap;word-wrap:break-word;color: #000000">
                                                        @instructionItem.Description
                                                    </div>
                                                </div>
                                            </div>
                                            @if (instructionItem.Assessor != null && (instructionItem.ModifiedAt.HasValue || instructionItem.CompletedAt.HasValue || instructionItem.ScoredAt.HasValue) &&
                                                 instructionItem.Score != null && instructionItem.Score != 0)
                                            {
                                                <div class="row" style="">
                                                    <div class="col-12">
                                                        <div style="text-wrap:wrap;word-wrap:break-word;">
                                                            Assessor: @if(instructionItem != null && instructionItem.Assessor != null) {@instructionItem.Assessor.Name}
                                                            @if (instructionItem.CompletedAt.HasValue) {
                                                            DateTime ItemCompletedAtDate = TimeZoneInfo.ConvertTime(instructionItem.CompletedAt.Value, timezone);
                                                            @(", " + ItemCompletedAtDate.ToString("MMM d, yyyy, HH:mm"))
                                                            }
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                    <div class="col-auto" style="display: flex">
                                        <div style="text-align:right;padding-right: 0.75rem;align-self: center;">
                                            <div class="align-items-center">
                                                @if (instructionItem.Score != null && instructionItem.Score != 0)
                                                {
                                                    <span class="status-circle text-white" style="@GetAssessmentScoreStyle(instructionItem.Score.Value)">
                                                        <span class="status-icon">@instructionItem.Score.Value</span>
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="status-circle" style="background-color: #EAF0F6">
                                                        <span class="status-icon"></span>
                                                    </span>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>

                <hr />
            }
        }
        <!-- Signatures -->
        <div class="p-3">
            <div class="row">
                <div class="col-12">
                    <div class="row">
                        <div class="col-12 pl-0">
                            <h2 style="font-weight:600">Signatures</h2>
                        </div>
                    </div>
                    <div class="row pb-3">
                        <div class="col-6 pl-0">
                            <div>Assessment: @Model.Assessment.Name</div>
                            <div>Completed for: @Model.Assessment.CompletedFor</div>
                        </div>
                        @if (Model.Assessment.IsCompleted != null && Model.Assessment.IsCompleted == true)
                        {
                            <div class="col-6 pr-0">
                                <div class="row">
                                    <div class="col" style="display: flex; align-items: center; justify-content: right;max-width: calc(100% - 80px);">
                                        <div class="mb-0" style="display: inline-block; font-weight: 600; text-align:right">
                                            <div style="text-align: center">Average score of assessment:</div>
                                        </div>
                                    </div>
                                    <div class="col-auto" style="display: flex;justify-content: right">
                                        <div>
                                            <span class="status-circle-big text-white" style="@(GetAssessmentScoreStyle(Math.Round(assessmentScore, 1)))">
                                                <span class="status-icon-big" style="font-size: 21px">@(string.Format("{0:0.0}", Math.Round(assessmentScore, 1)))</span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                    @if (Model.Assessment.Signatures != null && Model.Assessment.Signatures.Count > 0)
                    {
                        <div class="row my-3" style="border: 1px solid #8E8E8E80">
                            @{
                                var signatureColClass = Model.Assessment.Signatures.Count == 1 ? "col-12" : "col-6";
                                var completedForSignature = Model.Assessment.Signatures.Where(s => s.SignedById == Model.Assessment.CompletedForId).FirstOrDefault();
                                var assessorSignature = Model.Assessment.Signatures.Except(new List<EZGO.Api.Models.Signature>() { completedForSignature }).FirstOrDefault();
                            }
                            @if (assessorSignature != null)
                            {
                                var sigpic = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, assessorSignature.SignatureImage);

                                <div class="@signatureColClass float-left pl-3" style="text-align: center">
                                    <span class="d-inline-block" style="width:100px;">Last assessor</span>
                                    @if (!string.IsNullOrEmpty(assessorSignature.SignatureImage))
                                    {
                                        <img src="/images/media-loading.gif" data-src="@sigpic" style="height:80px;margin: auto" class="d-block" />
                                    }
                                    else
                                    {
                                        <i class="fa-solid fa-signature d-block" style="font-size:60px;color:#93C54B;margin: auto"></i>
                                    }
                                    <span class="d-inline-block" style="width:100px;">@assessorSignature.SignedBy</span>
                                </div>
                            }
                            @if (completedForSignature != null)
                            {
                                var sigpic = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, completedForSignature.SignatureImage);

                                <div class="@signatureColClass float-left pl-3" style="text-align: center">
                                    <span class="d-inline-block" style="width:100px;">Completed for</span>
                                    @if (!string.IsNullOrEmpty(completedForSignature.SignatureImage))
                                    {
                                        <img src="/images/media-loading.gif" data-src="@sigpic" style="height:80px;margin: auto" class="d-block" />
                                    }
                                    else
                                    {
                                        <i class="fa-solid fa-signature d-block" style="font-size:60px;color:#93C54B;margin: auto"></i>
                                    }
                                    <span class="d-inline-block" style="width:100px;">@completedForSignature.SignedBy</span>
                                </div>
                            }
                        </div>
                    }
                    else if (Model.Assessment.IsCompleted)
                    {
                        <div class="row" style="border: 1px solid #8E8E8E80; text-align: center">
                            <div class="col-12 pt-2">
                                <i class="fa-solid fa-signature d-block" style="font-size:60px;color:#93C54B;margin: auto"></i>
                            </div>
                            <div class="col-12 pb-2">
                                <span class="d-inline-block" style="">@Model.Assessment.Assessor</span>
                            </div>
                        </div>
                    }

                    else if (!Model.Assessment.IsCompleted)
                    {

                        <div class="row" style="border: 1px solid #8E8E8E80; text-align: center">
                            <div class="col-12 pt-3 pb-3" style="vertical-align: middle; min-height: 100px">
                                <h2 style="color: #8E8E8E; padding-top: 3rem; padding-bottom: 3rem">Assessment not yet completed</h2>
                            </div>
                        </div>
                    }
                </div>
                </div>
            </div>
        </div>

    <script>
        var assessmentImgs = document.images,
            assessmentImgsLength = assessmentImgs.length,
            assessmentImgsCounter = 0,
            assessmentImgsLoaded = false,
            assessmentImgsCheckerInterval = null;

        $(assessmentImgs).each(function(index, img) {
            if (img.complete && $(img).attr('src') != undefined && ($(img).attr('src').includes('normal_unavailable_image.png') || $(img).attr('src').startsWith('blob:')))
            {
                incrementCounter();
            }
            else
            {
                console.log(img);
                console.log(img.complete);
                img.addEventListener('load', incrementCounter, false);
            }
        })

        function incrementCounter() {
            assessmentImgsCounter++;
            if (assessmentImgsCounter === assessmentImgsLength) {
                assessmentImgsLoaded = true
            }
        }

        function checkAssessmentImgsLoaded() {
            if (!assessmentImgsLoaded) {
                //do nothing
            }
            else {
                clearInterval(assessmentImgsCheckerInterval);
                setTimeout(() => {
                    window.print();
                });
                setTimeout(function () { window.close(); }, 2000);
            }
        }

        checkAssessmentImgsLoaded();
        window.onload = function () {
            assessmentImgsCheckerInterval = setInterval(() => {
                checkAssessmentImgsLoaded();
            }, 1000);
        }

        ezgomediafetcher.preloadImagesAndVideos();
    </script>
</body>
</html>
