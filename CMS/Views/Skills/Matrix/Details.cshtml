@model WebApp.ViewModels.SkillsViewModel
@using WebApp.Logic
@{
    Layout = "_Layout_template";
    ViewData["Title"] = @Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.SkillMatrixDetailsTitle, "Skill matrix details") ?? "Skill matrix details";
}

@section CSS{
    <style>
        #instructions {
            top: 0px;
            position: absolute;
            z-index: 3;
        }

        .card {
            margin-bottom: 0px !important;
        }

        .customArrow {
            width: 100%;
            position: absolute;
            height: 0px;
            width: 0px;
            display: block;
            transition: top 200ms;
            border-bottom: 20px #93C54B solid;
            border-left: 20px transparent solid;
            border-right: 20px transparent solid;
            margin-top: -21px;
        }

        .pencil-action {
            height: 45px;
            width: 45px;
            margin-top: 15px;
            margin-right: 15px;
            font-size: 25px;
            color: #364c59;
            cursor: pointer;
        }

            .pencil-action svg {
                margin-top: 3px;
                margin-left: 11px;
            }

        .modal {
            padding: 0 !important;
        }

        .value-placeholder {
            height: 70px;
            border: 1px dashed #fff;
            width: 115px;
            margin: 10px 15px 0px 0px;
            cursor: pointer;
        }

            .value-placeholder span {
                font-weight: 700;
                font-size: 1.2rem;
            }

            .value-placeholder.active {
                border: solid 1px silver;
                background-color: lightgray;
            }

        .paperclip {
            height: 160px;
            background-color: #8ea968;
            text-align: center;
            color: #fff;
        }

            .paperclip i {
                margin-top: 25px;
            }

                .paperclip i::after {
                    display: block;
                    font-size: 26px;
                    font-style: normal;
                    font-weight: 600;
                }

        .addclip {
            height: 130px;
            text-align: center;
            color: #93C54B;
            cursor: pointer;
        }

            .addclip:hover {
                border: dashed 1px #93C54B;
                background-color: #93c54b1f;
            }

            .addclip i {
                margin-top: 39px;
            }

                .addclip i::after {
                    display: block;
                    font-size: 26px;
                    font-style: normal;
                    font-weight: 600;
                }

        .addvalue {
            height: 70px;
            text-align: center;
            color: #93C54B;
            cursor: pointer;
            width: 115px;
        }

            .addvalue i {
                margin-top: 20px;
            }

                .addvalue i::after {
                    display: block;
                    font-size: 26px;
                    font-style: normal;
                    font-weight: 600;
                }

        .nav-pills .nav-link.active, .nav-pills .show > .nav-link {
            color: #fff;
            background-color: #93C54B;
        }

        .nav-pills .nav-link:not(.active):hover {
            color: #93C54B;
        }

        ::-webkit-scrollbar {
            -webkit-appearance: none;
            width: 10px;
            height: 10px !important;
        }

        .itemlist .card {
            width: 12rem;
        }

            .itemlist .card .card-body {
                font-size: 9.5pt;
                color: #6c757d !important;
            }

                .itemlist .card .card-body p {
                    padding-bottom: 0px;
                }

            .itemlist .card:hover {
                box-shadow: 0 .5rem 1rem rgba(0,0,0,.15) !important;
            }

        v.list-inline-item {
            padding: 5px;
        }

        .controls {
            position: absolute;
            bottom: 0px;
            margin: 15px;
        }

        .main-image-pencil {
            background: #93c54b;
            width: 35px;
            height: 35px;
            margin: 10px;
            opacity: 0.8;
            z-index: 1;
            color: #fff;
            border: solid 1px #333333 !important;
            cursor: pointer;
        }

            .main-image-pencil i {
                width: 35px;
                height: 33px;
                position: relative;
                display: flex;
            }

            .main-image-pencil:hover {
                border: solid 1px #fff !important;
            }

        .itemlist .pencil {
            background: #333333;
            width: 35px;
            height: 35px;
            margin: 10px;
            opacity: 0.8;
            z-index: 1;
            position: absolute;
            left: 70px;
            top: 105px;
            color: #fff;
            border: solid 1px #333333 !important;
            cursor: pointer;
        }

            .itemlist .pencil i {
                width: 35px;
                height: 33px;
                position: relative;
                display: flex;
            }

            .itemlist .pencil:hover {
                border: solid 1px #fff !important;
            }

        .itemlist .ui-state-highlight {
            height: 240px;
            line-height: 1.2em;
            width: 12rem;
            margin-right: 22px;
            background-color: rgba(241,241,241,0.52) !important;
            border: dashed 1px rgb(191,191,191);
            margin-top: 6px;
        }

        .itemlist .valuePropHolder {
            width: 100px;
            height: 60px;
            border-radius: 6px;
            float: left;
            margin-right: 18px;
            border: 1px solid rgb(214,214,214);
        }

        .itemlist .card-link {
            position: relative;
            display: flex;
            height: 160px;
            margin: -1px;
            border: solid 1px rgba(0,0,0,0);
        }

            .itemlist .card-link img {
                object-fit: cover;
                width: 100%;
                height: 160px;
                border-top-left-radius: 10px;
                border-top-right-radius: 10px;
            }

        .btn-light:not(:disabled):not(.disabled).active, .btn-light:not(:disabled):not(.disabled):active, .show > .btn-light.dropdown-toggle {
            color: #fff !important;
            background-color: #93C54B;
            border-color: #d3d9df;
        }

        .tpl {
            display: none;
        }

        .list-group-item:last-child {
            margin-bottom: 0;
            border-bottom-right-radius: 0rem;
            border-bottom-left-radius: 0rem;
        }

        @@media print {
            .pagebreak {
                page-break-after: always !important;
                break-after: always !important;
            }

            #mainCol {
                display: block !important;
                position: relative !important;
                width: auto !important;
                height: auto !important;
                overflow: visible !important;
                margin-left: 0 !important;
            }

            .content-wrapper {
                background-color: #fff !important;
            }
        }

        .dropdown-item.active, .dropdown-item:active {
            color: #fff;
            text-decoration: none;
            background-color: #93C54B;
        }

        .form-group {
            margin-bottom: 0.5rem;
        }

        .nav-pills .nav-link.active, .nav-pills .show > .nav-link {
            color: #fff;
            background-color: #93C54B;
        }

        #ChangeSkillOrderModal .changeSkillOrderSkill {
            border: solid 1px transparent;
            border-radius: 10px;
            background-color: #FFF;
        }

            #ChangeSkillOrderModal .changeSkillOrderSkill:hover {
                border: solid 1px #93c54b;
                box-shadow: 0 .425rem .75rem rgba(0,0,0,.075) !important;
                color: #93c54b !important;
            }

        .noselect {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            cursor: pointer;
        }

        .default-target {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: inline-block;
            border: 1px solid rgb(210, 210, 210);
            font-size: 22px !important;
            outline: 0 !important;
        }


        .item-target {
            display: flex;
        }

        .btn-green-selected {
            background-color: green;
            font-size: 22px;
            font-weight: 400;
            color: white;
        }

        .btn-red-selected {
            background-color: rgb(203,0,0);
            font-size: 22px !important;
            font-weight: 400;
            color: white;
        }

        .btn-clear-selected {
            background-color: #ffffff;
            font-size: 22px;
            font-weight: 400;
            color: white;
        }

        .btn-orangered-selected {
            background-color: orangered;
            font-size: 22px;
            font-weight: 400;
            color: white;
        }

        .btn-orange-selected {
            background-color: orange;
            font-size: 22px;
            font-weight: 400;
            color: white;
        }

        .btn-orangegreen-selected {
            background-color: rgb(141,163,5);
            font-size: 22px;
            font-weight: 400;
            color: white;
        }

        .btn-white-selected {
            background-color: #D9D9D9;
            font-size: 52px;
            font-weight: 400;
            color: white;
        }
    </style>

    <style>
        .gap-too-low {
            background-color: #D55F5E;
            color: white;
        }

        .gap-high-enough {
            background-color: #61AB5C;
            color: white;
        }
    </style>

    <style>


        .userProfilePicture {
            min-width: 40px;
            width: 40px;
            height: 40px;
            top: 0px;
            background-size: cover;
            border-radius: 50%;
        }


        .userProfilePictureSmall {
            width: 17px;
            height: 17px;
            background-size: cover;
            border-radius: 50%;
        }
    </style>

    <!-- Custom daterange picker -->
    <style>
        .daterangepicker.single .drp-calendar {
            float: none !important; 
            display: block; 
            margin: 0 auto; 
            padding-left: 40px;
            padding-right: 40px;
            width: auto !important;
            max-width: 100%; 
        }

        #datepicker-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0,0,0,0.5); 
            z-index: 1040; 
            display: none;
            opacity: 0; 
            transition: opacity 0.15s linear;
        }

            #datepicker-backdrop.show {
                display: block;
                opacity: 1; 
            }
        </style>
        <style>


        .daterangepicker .drp-buttons .btn.customConfirmButton,
        .daterangepicker .drp-buttons .btn.customCloseButton,
        .daterangepicker .drp-buttons .btn.deleteUserSkillValueButton,
        .daterangepicker .drp-buttons .btn.notRequiredForThisPersonButton,
        .daterangepicker .drp-buttons .btn.requiredForThisPersonButton {
            font-weight: 400;
        }

        .daterangepicker .drp-buttons button.customConfirmButton,
        .daterangepicker .drp-buttons button.notRequiredForThisPersonButton,
        .daterangepicker .drp-buttons button.requiredForThisPersonButton {
            background-color: #93C54B;
            color: white;
            border: 2px solid #93C54B;
            border-radius: 4px;
        }

        .datepicker-header {
            background-color: #F5FAED;
        }

        .daterangepicker td.active,
        .daterangepicker td.active:hover,
        .daterangepicker td.start-date,
        .daterangepicker td.end-date,
        .daterangepicker td.start-date.end-date {
            background: none !important;
            border: none !important;
            color: inherit !important;
            padding: 0;
        }

            .daterangepicker td.active span,
            .daterangepicker td.start-date span,
            .daterangepicker td.end-date span,
            .daterangepicker td.start-date.end-date span {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 36px;
                height: 36px;
                line-height: 36px;
                border-radius: 50%;
                background-color: #93C54B;
                color: white;
                font-weight: bold;
                box-sizing: border-box;
                transition: background-color 0.2s;
            }

        .daterangepicker .calendar-table th, 
        .daterangepicker .calendar-table td {
            font-size: 14px;
            font-weight: 400;
        }

        .daterangepicker td span {
            pointer-events: none;
        }

        .daterangepicker td.available span:hover {
            cursor: pointer;
        }

        .daterangepicker {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .currentUserSkillValueDatePicker span {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 36px;
            height: 36px;
            line-height: 36px;
            border-radius: 50%;
            border: 1px solid #93C54B;
            background-color: #FFFFFF00;
            box-sizing: border-box;
            transition: background-color 0.2s;
        }

        .daterangepicker td.available:hover,
        .daterangepicker th.available:hover {
            background: none !important;
            border: none !important;
            color: inherit !important;
        }

        .daterangepicker td.available:not(.active):hover span {
            background-color: #ccc;
            color: black;
            width: 36px;
            height: 36px;
            line-height: 36px;
            border-radius: 50%;
            display: inline-block;
            text-align: center;
            box-sizing: border-box;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .daterangepicker td {
            height: 48px !important;
        }

    </style>

    <!-- Datepicker custom date controls-->
    <style>
        .daterangepicker select.monthselect, 
        .daterangepicker select.yearselect {
            width: auto;
        }

        .daterangepicker th.month {
            text-align: left;
        }

        .daterangepicker .calendar-table thead tr th.month select {
            appearance: none; /* remove default OS styling */
            -webkit-appearance: none;
            -moz-appearance: none;
            background-color: #fff; /* white background */
            border: 1px solid #A6A6A6; /* thin border */
            border-radius: 4px; /* rounded corners */
            padding: 2px 10px; /* small padding for readability */
            font-size: 14px;
            color: #333;
            outline: none; /* remove focus outline */
        }

            /* optional: subtle hover/focus effects */
            .daterangepicker .calendar-table thead tr th.month select:hover {
                border-color: #999;
            }

            .daterangepicker .calendar-table thead tr th.month select:focus {
                border-color: #0077cc;
                box-shadow: 0 0 0 2px rgba(0, 119, 204, 0.2);
            }

        .daterangepicker .calendar-table thead tr th.month select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background: white url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10"><polygon points="0,0 10,0 5,5" fill="%23333"/></svg>') no-repeat right 6px center;
            background-size: 10px 10px;
            padding-right: 20px; /* space for arrow */
        }

        .daterangepicker .calendar-table th{
            cursor: default;
        }

        .daterangepicker .calendar-table th select,
        .daterangepicker .calendar-table th.next,
        .daterangepicker .calendar-table th.prev {
            cursor: pointer;
        }

        .daterangepicker {
            box-shadow: 0 .5rem 1rem rgba(0, 0, 0, 0.5);
        }

        .daterangepicker {
            opacity: 0;
            transition: opacity 0.15s ease-out;
        }

            .daterangepicker.showPicker {
                opacity: 1;
            }

        </style>

    <link rel="stylesheet" href="/css/matrix/matrix.css" />
    <link rel="stylesheet" href="/css/matrix/matrix-hover.css" />
    <link rel="stylesheet" href="/css/matrix/matrix-buttons.css" />
}

<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-0">
            <div class="col-sm-6">
                <a asp-controller="skills" asp-action="matrixindex"><i class="fa fa-arrow-left"></i> @(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.NavBackTitle, "Back to skill matrices overview") ?? "Back to skill matrices overview")</a>
                <h1>@Model.CurrentSkillsMatrix.Name</h1>
                <h6>@Model.CurrentSkillsMatrix.Description</h6>
            </div>

            <div class="col-sm-6 d-flex flex-row-reverse">
                <button id="btnChangeUserGroups" class="btn btn-ezgo btn-sm mr-2 shadow-sm mt-auto">
                    <i class="fa fa-people-group pr-1"></i> @(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.BtnAddOrChangeUserGroups, "Edit user groups") ?? "Edit user groups")
                </button>

                <button id="btnAddChangeBehaviourSkills" class="btn btn-ezgo btn-sm mr-2 shadow-sm mt-auto">
                    <i class="fa fa-graduation-cap pr-1"></i> @(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.BtnAddOrChangeSkills, "Edit skills") ?? "Edit skills")
                </button>
                
                <button id="btnChangeSkillOrder" class="btn btn-ezgo btn-sm mr-2 shadow-sm mt-auto">
                    <i class="fa fa-sort pr-1"></i> @(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.BtnChangeSkillOrder, "Skill ordering") ?? "Skill ordering")
                </button>

                <button id="btnViewModalLegend" class="btn btn-ezgo btn-sm mr-2 shadow-sm mt-auto" style="background-color: #93C54B; border-color: #93C54B; color: white;">
                    <i class="fa fa-table-list pr-1"></i> @(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.BtnViewMatrixLegend, "View matrix legend") ?? "View matrix legend")
                </button>
                
                <a class="btn btn-ezgo btn-sm btn-outline mr-2 shadow-sm mt-auto" onclick="window.open('/pdf/viewer/matrix/@(Model.CurrentSkillsMatrix.Id)', '_blank', 'toolbar=no,top=10,left=10,width=' + (screen.availWidth-10) + ',height=' + (screen.availHeight-10) + '');">
                    <i class="fa fa-print"></i>
                </a>
            </div>
        </div>
    </div><!-- /.container-fluid -->
</section>

<section id="contentDiv" class="content">
    @if (Model.CurrentUser.Role.ToLower().Equals("manager"))
    {
        <div class="popUp hidePopUp popUpScore" data-containertype="score_choice">
            <div class="arrowUp"></div><div class='item btn-clear' data-actionvalue="0"></div><div class='item btn-red' data-actionvalue="1">1</div><div class='item btn-orangered' data-actionvalue="2">2</div><div class='item btn-orange' data-actionvalue="3">3</div><div class='item btn-orangegreen' data-actionvalue="4">4</div><div class='item btn-green' data-actionvalue="5">5</div>
        </div>
    }

    <div id="matrixBody" style="width: 100%;height: calc(100vh - 175px); overflow: auto; position: relative">
        @if (Model.CurrentSkillsMatrix.NumberOfMandatorySkills == 0 && Model.CurrentSkillsMatrix.NumberOfOperationalSkills == 0)
        {
            <div>@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.NumberOfOperationalSkillsTitle, "Please select or create one or more mandatory / operational skills.") ?? "Please select or create one or more mandatory / operational skills.")</div>
        }

        @if (Model.CurrentSkillsMatrix.NumberOfUserGroups == 0)
        {
            <div>@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.NumberOfUserGroupsTitle, "Please select or create one or more user groups.") ?? "Please select or create one or more user groups.")</div>
        }

        @{
            int colspan = 0;
        }

        <!-- Matrix Preview (Only user groups added!) -->
        @if (Model.CurrentSkillsMatrix.NumberOfUserGroups > 0 && Model.CurrentSkillsMatrix.NumberOfMandatorySkills == 0 && Model.CurrentSkillsMatrix.NumberOfOperationalSkills == 0)
        {
            <table>
                <tr>
                    <td rowspan="1" colspan="3"></td>
                    @foreach (var usergroup in Model.CurrentSkillsMatrix.UserGroups)
                    {
                        <td class="rowtitle" colspan="@usergroup.Users.Count()"><span>@(usergroup.Name)</span></td>
                        <td rowspan="5"></td>
                    }
                </tr>

                <tr>
                    <td></td>
                    <td style="vertical-align: bottom; padding: 0">
                        <div>
                            <span style="width: 35px; display: inline-block; line-height: 35px" class="vertical">
                                @(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.SkillMatrixRequiredLabel, "Required") ?? "Required")
                            </span>
                            <span style="width: 35px; display: inline-block; line-height: 35px" class="vertical">
                                @(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.SkillMatrixAchievedLabel, "Achieved") ?? "Achieved")
                            </span>
                            <span style="width: 35px; display: inline-block; line-height: 35px" class="vertical">
                                @(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.SkillMatrixGapLabel, "Gap") ?? "Gap")
                            </span>
                        </div>
                    </td>

                    <td></td>
                    @foreach (var usergroup in Model.CurrentSkillsMatrix.UserGroups)
                    {
                        @if (usergroup.Users.Count == 0)
                        {
                            <td style="background: #f1f3f1"></td>
                        }
                        else
                        {
                            @foreach (var profile in usergroup.Users)
                            {
                                colspan++;
                                <td class="user-title" style="border-left: 1px solid rgb(210,210,210)">
                                    <div>
                                        <span class="d-inline vertical">@profile.FirstName @profile.LastName</span>
                                    </div>
                                    <img class="user-img" loading="lazy" src="/images/media-loading.gif" data-src="@(WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, profile.Picture))">
                                </td>
                            }
                        }
                    }
                </tr>

                <tr><td colspan="@colspan"></td></tr>

                <tr class="skillsrow" style="opacity: 0.3">
                    <td class="rowtitle" rowspan="1">
                        <span class="vertical">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.MandatorySkillsTitle, "Mandatory skills") ?? "Mandatory skills")</span>
                    </td>

                    <td class="goalcell">
                        <div class="goaldiv">
                            <div class="matrix-tooltip">
                                <span data-containertype="goal_value">0</span>
                                <span class="tooltiptext shadow">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.MatrixGoalValue, "Goal of mandatory skills") ?? "Goal of mandatory skills")</span>
                            </div>

                            <div class="matrix-tooltip">
                                <span data-containertype="result_value">0</span>
                                <span class="tooltiptext shadow">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.MatrixResultTitle, "Result of mandatory skills") ?? "Result of mandatory skills")</span>
                            </div>

                            <div class="matrix-tooltip">
                                <span data-containertype="difference_value">0</span>
                                <span class="tooltiptext shadow">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.MatrixDifferenceValue, "Difference between goal and result") ?? "Difference between goal and result")</span>
                            </div>
                        </div>
                    </td>

                    <td class="endcell skillcell" style="width: 125px">
                        <div></div>
                        <small></small>
                    </td>

                    @foreach (var usergroup in Model.CurrentSkillsMatrix.UserGroups)
                    {
                        @if (usergroup.Users.Count == 0)
                        {
                            <td class="buttoncellEmpty" style="background: #f1f3f1"></td>
                        }
                        else
                        {
                            @foreach (var profile in usergroup.Users)
                            {
                                string tdClass = "";
                                if (profile == usergroup.Users.First())
                                {
                                    tdClass += "buttonstartcell ";
                                }
                                else if (profile == usergroup.Users.Last())
                                {
                                    tdClass += "buttonendcell ";
                                }
                                <td class="buttoncell @tdClass"><button class="btn circlebtn" type="button"></button></td>
                            }
                        }
                    }
                </tr>

                <tr class="spacerow"><td colspan="@colspan"></td></tr>
            </table>
        }

        <!-- Matrix Preview (Only user skills added!) -->
        @if (Model.CurrentSkillsMatrix.NumberOfUserGroups == 0 && (Model.CurrentSkillsMatrix.NumberOfMandatorySkills != 0 || Model.CurrentSkillsMatrix.NumberOfOperationalSkills != 0))
        {
            <table>
                <tr style="opacity: 0.3">
                    <td rowspan="1" colspan="3"></td>
                    <td class="rowtitle" colspan="5"><span>@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.UserGroupTitle, "User group") ?? "User group")</span></td>
                </tr>

                <tr style="opacity: 0.3">
                    <td></td>
                    <td style="vertical-align: bottom; padding: 0">
                        <div>
                            <span style="width: 35px; display: inline-block; line-height: 35px" class="vertical">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.MatrixGoalTitle, "Goal") ?? "Goal")</span>
                            <span style="width: 35px; display: inline-block; line-height: 35px" class="vertical">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.MatrixResultTitle, "Result") ?? "Result")</span>
                            <span style="width: 35px; display: inline-block; line-height: 35px" class="vertical">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.MatrixDeltaTitle, "Delta") ?? "Delta")</span>
                        </div>
                    </td>

                    <td></td>
                    @for (int i = 0; i < 5; i++)
                    {
                        <td class="user-title user-title-endcell" style="border-left: 1px solid rgb(210,210,210)">
                            <div>
                                <span class="d-inline vertical">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.UsernameTitle, "Username") ?? "Username")</span>
                            </div>
                            <img class="user-img" loading="lazy" src="/images/user-placeholder.jpg">
                        </td>
                    }
                </tr>

                <tr><td colspan="5"></td></tr>

                @{
                    bool isHeader = true;
                }

                @if (Model.CurrentSkillsMatrix.MandatorySkills != null)
                {
                    @foreach (var skillset in Model.CurrentSkillsMatrix.MandatorySkills.OrderBy(s => s.Index))
                    {
                        <tr class="skillsrow" data-containertype="mandatory_skill_row">
                            @if (isHeader)
                            {
                                <td class="rowtitle" rowspan="@Model.CurrentSkillsMatrix.MandatorySkills.Count()"><span class="vertical">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.MandatorySkillsTitle, "Mandatory skills") ?? "Mandatory skills")</span></td>
                                isHeader = false;
                            }

                            <td class="goalcell">
                                <div class="goaldiv"><div class="matrix-tooltip"><span data-containertype="goal_value">@skillset.Goal</span><span class="tooltiptext shadow">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.MatrixGoalValue, "Goal of mandatory skills") ?? "Goal of mandatory skills")</span></div><div class="matrix-tooltip"><span data-containertype="result_value">@skillset.Result</span><span class="tooltiptext shadow">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.MatrixResultValue, "Result of mandatory skills") ?? "Result of mandatory skills")</span></div><div class="matrix-tooltip"><span data-containertype="difference_value">@skillset.GoalResultDifference</span><span class="tooltiptext shadow">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.MatrixDifferenceValue, "Difference between goal and result") ?? "Difference between goal and result")</span></div></div>
                            </td>

                            <td class="endcell skillcell">
                                <div>@skillset.Name</div>
                                <small>@skillset.Description</small>
                            </td>

                            @for (int i = 0; i < 5; i++)
                            {
                                var score = -1;
                                var endClass = "";
                                if (i == 4)
                                {
                                    endClass = " buttonendcell ";
                                }
                                switch (score)
                                {
                                    case 0:
                                        <td class="buttoncell @endClass" data-containertype="value"><button class="btn circlebtn" type="button" data-popup="thumbs" data-value="0" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice"></button></td>
                                        break;
                                    case 1:
                                        <td class="buttoncell @endClass" data-containertype="value"><button class="btn circlebtn btn-red thumbsdown" type="button" data-popup="thumbs" data-value="1" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice"></button></td>
                                        break;
                                    case 2:
                                        <td class="buttoncell @endClass" data-containertype="value"><button class="btn circlebtn btn-green thumbsup" type="button" data-popup="thumbs" data-value="2" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice"></button></td>
                                        break;
                                    case 5:
                                        <td class="buttoncell @endClass" data-containertype="value"><button class="btn circlebtn btn-orange warning" type="button" data-popup="thumbs" data-value="5" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice"></button></td>
                                        break;
                                    default:
                                        <td class="buttoncell @endClass" data-containertype="value"><button class="btn circlebtn" type="button" data-popup="thumbs" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice"></button></td>
                                        break;
                                }
                            }
                        </tr>
                    }
                }
                @{
                    bool isHeaderr = true;
                }
                @if (Model.CurrentSkillsMatrix.OperationalSkills != null)
                {
                    @foreach (var skillset in Model.CurrentSkillsMatrix.OperationalSkills.OrderBy(s => s.Index))
                    {
                        <tr class="skillsrow" data-containertype="operational_skill_row">
                            @if (isHeaderr)
                            {
                                <td class="rowtitle" rowspan="@Model.CurrentSkillsMatrix.OperationalSkills.Count()"><span class="vertical">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.OperationalSkills, "Operational skills") ?? "Operational skills")</span></td>
                                isHeaderr = false;
                            }

                            <td class="goalcell">
                                <div class="goaldiv"><div data-containertype="goal_value">@skillset.Goal</div><div data-containertype="result_value">@skillset.Result</div><div data-containertype="difference_value">@skillset.GoalResultDifference</div></div>
                            </td>

                            <td class="endcell skillcell">
                                <div class="matrix-tooltip">
                                    <div>@skillset.Name</div>
                                    <small>@skillset.Description</small>
                                    <span class="tooltiptext shadow">@skillset.Name - @skillset.SkillAssessmentName</span>
                                </div>
                            </td>

                            @for (int i = 0; i < 5; i++)
                            {
                                var score = -1;
                                var endClass = "";
                                if (i == 4)
                                {
                                    endClass = " buttonendcell ";
                                }
                                switch (score)
                                {
                                    case 0:
                                        <td class="buttoncell @endClass" data-containertype="value"><button class="btn circlebtn" style="font-size:22px !important;" type="button" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice"></button></td>
                                        break;
                                    case 1:
                                        <td class="buttoncell @endClass" data-containertype="value"><button class="btn circlebtn btn-red" style="font-size:22px !important;" type="button" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice" data-value="@score">@score</button></td>
                                        break;
                                    case 2:
                                        <td class="buttoncell @endClass" data-containertype="value"><button class="btn circlebtn btn-orangered" style="font-size:22px !important;" type="button" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice" data-value="@score">@score</button></td>
                                        break;
                                    case 3:
                                        <td class="buttoncell @endClass" data-containertype="value"><button class="btn circlebtn btn-orange" style="font-size:22px !important;" type="button" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice" data-value="@score">@score</button></td>
                                        break;
                                    case 4:
                                        <td class="buttoncell @endClass" data-containertype="value"><button class="btn circlebtn btn-orangegreen" style="font-size:22px !important;" type="button" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice" data-value="@score">@score</button></td>
                                        break;
                                    case 5:
                                        <td class="buttoncell @endClass" data-containertype="value"><button class="btn circlebtn btn-green" style="font-size:22px !important;" type="button" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice" data-value="@score">@score</button></td>
                                        break;
                                    default:
                                        <td class="buttoncell @endClass" data-containertype="value"><button class="btn circlebtn" style="font-size:22px !important;" type="button" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice"></button></td>
                                        break;
                                }
                            }
                        </tr>
                    }
                }

                <tr class="spacerow"><td colspan="@colspan"></td></tr>
            </table>
        }

        <!-- Matrix display (User Groups and User Skills both added!) -->
        @if (Model.CurrentSkillsMatrix.NumberOfUserGroups != 0 && (Model.CurrentSkillsMatrix.NumberOfMandatorySkills != 0 || Model.CurrentSkillsMatrix.NumberOfOperationalSkills != 0))
        {
            <table>
                <tr>
                    <td rowspan="1" colspan="3" id="matrixSpacer2"></td>
                    @{
                        int rowspan = (Model.CurrentSkillsMatrix.MandatorySkills != null ? Model.CurrentSkillsMatrix.MandatorySkills.Count() : 0) +
                        (Model.CurrentSkillsMatrix.OperationalSkills != null ? Model.CurrentSkillsMatrix.OperationalSkills.Count() : 0) + 11;

                        foreach (var usergroup in Model.CurrentSkillsMatrix.UserGroups)
                        {
                                <td class="rowtitle" colspan="@(usergroup.Users.Count())"><span>@(usergroup.Name)</span></td>
                                <td rowspan="@rowspan"></td>
                        }
                    }
                </tr>

                <tr class="text-center">
                    <td></td>
                    <td style="vertical-align: bottom; padding: 0">
                        <div>
                            <span style="width: 35px; display: inline-block; line-height: 35px" class="vertical">
                                @(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.SkillMatrixRequiredLabel, "Required") ?? "Required")
                            </span>
                            <span style="width: 35px; display: inline-block; line-height: 35px" class="vertical">
                                @(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.SkillMatrixAchievedLabel, "Achieved") ?? "Achieved")
                            </span>
                            <span style="width: 35px; display: inline-block; line-height: 35px" class="vertical">
                                @(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.SkillMatrixGapLabel, "Gap") ?? "Gap")
                            </span>
                        </div>
                    </td>

                    <td id="matrixSpacer1"></td>
                    @{
                        int collspan = 0;
                    }

                    @if (Model.CurrentSkillsMatrix.UserGroups != null)
                    {
                        @foreach (var usergroup in Model.CurrentSkillsMatrix.UserGroups)
                        {
                            collspan++;
                            @if (usergroup.Users.Count == 0)
                            {
                                <td style="background: #f1f3f1"></td>
                            }
                            else
                            {
                                foreach (var userprofile in usergroup.Users)
                                {
                                    collspan++;
                                    <td class="user-title" style="border: 1px solid rgb(210,210,210); cursor: pointer" data-containertype="user" data-id="@userprofile.Id" onclick="matrix.showUserSkillValuesModal(@Model.CurrentSkillsMatrix.Id, @userprofile.UserProfileId, '@userprofile.LastName, @userprofile.FirstName')">
                                        <div class="user-title-content">
                                            <div>
                                                <span class="d-inline vertical" data-containertype="username" data-id="@userprofile.Id">
                                                    @(string.Format("{0} {1}", userprofile.FirstName, userprofile.LastName))
                                                </span>
                                            </div>

                                            @if (string.IsNullOrEmpty(userprofile.Picture) || userprofile.Picture == "emptyprofile")
                                            {
                                                <img class="user-img" loading="lazy" src="/images/user-placeholder.jpg">
                                            }
                                            else
                                            {
                                                <img class="user-img" loading="lazy" src="/images/media-loading.gif" data-src="@(WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, userprofile.Picture))">
                                            }
                                        </div>
                                    </td>
                                }
                            }
                        }
                    }
                </tr>

                <tr>
                    <td colspan="@collspan"></td>
                </tr>

                @{
                    bool isHeader = true;
                }

                @if (Model.CurrentSkillsMatrix.MandatorySkills != null && Model.ApplicationSettings.Features.SkillMatrixMandatorySkills != null && Model.ApplicationSettings.Features.SkillMatrixMandatorySkills.Value)
                {
                    @foreach (var skillset in Model.CurrentSkillsMatrix.MandatorySkills.OrderBy(s => s.Index))
                    {
                        <tr class="skillsrow" data-containertype="mandatory_skill_row">
                            @if (isHeader)
                            {
                                <td class="rowtitle" rowspan="@Model.CurrentSkillsMatrix.MandatorySkills.Count()"><span class="vertical">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.MandatorySkillsTitle, "Mandatory skills") ?? "Mandatory skills")</span></td>
                                isHeader = false;
                            }

                            <td class="goalcell">
                                <div class="goaldiv">
                                    <div class="matrix-tooltip">
                                        <div data-containertype="default_target_value" style="display: none">0</div>
                                        <span data-containertype="goal_value">@skillset.Goal</span>
                                        <span class="tooltiptext shadow">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.MatrixGoalValue, "Goal of mandatory skills") ?? "Goal of mandatory skills")</span>
                                    </div>
                                    <div class="matrix-tooltip"><span data-containertype="result_value">@skillset.Result</span>
                                        <span class="tooltiptext shadow">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.MatrixResultValue, "Result of mandatory skills") ?? "Result of mandatory skills")</span>
                                    </div>
                                    <div class="matrix-tooltip"><span data-containertype="difference_value">@skillset.GoalResultDifference</span>
                                        <span class="tooltiptext shadow">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.MatrixDifferenceValue, "Difference between goal and result") ?? "Difference between goal and result")</span>
                                    </div>
                                </div>
                            </td>

                            <td class="endcell skillcell matrixmandatoryskill">
                                <div>@skillset.Name</div>
                                <small>@skillset.Description</small>
                            </td>

                            @foreach (var usergroup in Model.CurrentSkillsMatrix.UserGroups)
                            {
                                @if (usergroup.Users.Count == 0)
                                {
                                    <td class="buttoncellEmpty" style="background: #f1f3f1"></td>
                                }
                                else
                                {
                                    foreach (var userprofile in usergroup.Users)
                                    {
                                        int score = -1;
                                        @if (skillset.Values != null)
                                        {
                                            var found = skillset.Values.Where(m => m.UserId.Equals(userprofile.UserProfileId));
                                            if (found != null && found.Any())
                                            {
                                                score = (int)found.FirstOrDefault().Score;
                                            }
                                        }

                                        string statusclass = score == 1 ? "btn-red thumbsdown" : score == 2 ? "btn-green thumbsup" : score == 5 ? "btn-orange warning" : "";
                                        int[] validScores = new[] { 0, 1, 2, 5 };
                                        string dataValueAttr = validScores.Contains(score) ? $"data-value={score}" : "";

                                        <td class="buttoncell" data-containertype="value">
                                            <button class="btn circlebtn @statusclass" type="button" data-popup="thumbs" @dataValueAttr data-userid="@userprofile.UserProfileId" data-usergroupid="@usergroup.Id" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice"></button>
                                        </td>
                                    }
                                }
                            }
                        </tr>
                    }
                }

                <tr class="spacerow">
                    <td colspan="@collspan"></td>
                </tr>

                @{
                    isHeader = true;
                }

                @if (Model.CurrentSkillsMatrix.OperationalSkills != null && Model.ApplicationSettings.Features.SkillMatrixOperationalSkills != null && Model.ApplicationSettings.Features.SkillMatrixOperationalSkills.Value)
                {
                    @foreach (var skillset in Model.CurrentSkillsMatrix.OperationalSkills.OrderBy(s => s.Index))
                    {
                        <tr class="skillsrow" data-containertype="operational_skill_row">
                            @if (isHeader)
                            {
                                <td class="rowtitle" rowspan="@Model.CurrentSkillsMatrix.OperationalSkills.Count()"><span class="vertical">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.OperationalSkills, "Operational skills") ?? "Operational skills")</span></td>
                                isHeader = false;
                            }

                            <td class="goalcell">
                                <div class="goaldiv">
                                    <div data-containertype="goal_value">@skillset.Goal</div>
                                    <div data-containertype="default_target_value" style="display: none">@skillset.DefaultTarget</div>
                                    <div data-containertype="result_value">@skillset.Result</div>
                                    <div data-containertype="difference_value">@skillset.GoalResultDifference</div>
                                </div>
                            </td>

                            <td class="endcell skillcell matrixoperationalskill">
                                <div class="matrix-tooltip">
                                    <div>@skillset.Name</div>
                                    <small>@skillset.Description</small>
                                    <span class="tooltiptext shadow">@skillset.Name - @skillset.SkillAssessmentName</span>
                                </div>
                            </td>

                            @foreach (var usergroup in Model.CurrentSkillsMatrix.UserGroups)
                            {
                                @if (usergroup.Users.Count == 0)
                                {
                                    <td class="buttoncellEmpty" style="background: #f1f3f1"></td>
                                }
                                else
                                {
                                    foreach (var userprofile in usergroup.Users)
                                    {
                                        int score = -1;
                                        decimal decimalScore = -1;
                                        bool expired = false;
                                        bool almostExpired = false;
                                        @if (skillset.Values != null)
                                        {
                                            var found = skillset.Values?
                                            .Where(m => m.UserId.Equals(userprofile.UserProfileId))
                                            .OrderByDescending(s => s.ValueDate)
                                            .ToList();

                                            if (found != null && found.Any())
                                            {
                                                var firstFound = found.FirstOrDefault();

                                                if (firstFound != null)
                                                {
                                                    decimalScore = firstFound.Score;
                                                    // Round according to your setting
                                                    score = Model.ApplicationSettings?.Features?.EnableMatrixScoreStandard == true
                                                                    ? (int)Math.Round(decimalScore, MidpointRounding.AwayFromZero)  // Standard rounding
                                                                    : (int)Math.Floor(decimalScore);                                // Always round down
                                                    
                                                    if (score != 0 && skillset.ExpiryInDays.HasValue && firstFound.ValueDate != DateTime.MinValue)
                                                    {
                                                        if (firstFound.ValueDate.AddDays(skillset.ExpiryInDays.Value) < DateTime.UtcNow)
                                                        {
                                                            expired = true;
                                                        }
                                                        else if (skillset.NotificationWindowInDays.HasValue && ((skillset.NotificationWindowInDays.Value > skillset.ExpiryInDays.Value) || (firstFound.ValueDate.AddDays(skillset.ExpiryInDays.Value - skillset.NotificationWindowInDays.Value) < DateTime.UtcNow)))
                                                        {
                                                            almostExpired = true;
                                                        }
                                                    }
                                                }
                                            }
                                        }

                                        string color = score == 0 ? "" : score == 1 ? "btn-red" : score == 2 ? "btn-orangered" : score == 3 ? "btn-orange" : score == 4 ? "btn-orangegreen" : score == 5 ? "btn-green" : "";
                                        bool showWarning = almostExpired || expired;
                                        string warningmessage = expired ? "Operational skill expired" : almostExpired ? "Operational almost expired" : "";
                                        string warningbackgroundcolor = expired ? "#FFFFFF" : almostExpired ? "#FFF0D4" : "";
                                        var applicability = Model.Applicabilities.Where(a => a.UserSkillId == skillset.UserSkillId && a.UserId == userprofile.UserProfileId).FirstOrDefault();
                                        <td class="buttoncell" data-containertype="value" @(decimalScore > 0 ? $"title={decimalScore}" : "")>
                                            <div style="position: relative; display: inline-block">
                                                <button 
                                                    class="btn circlebtn @color" 
                                                    style="font-size:22px !important;" 
                                                    type="button" 
                                                    data-popup="score" 
                                                    data-userid="@userprofile.UserProfileId" 
                                                    data-usergroupid="@usergroup.Id" 
                                                    data-skillid="@skillset.UserSkillId" 
                                                    data-actiontype="user_value_choice" 
                                                    data-customtarget="@(applicability != null ? applicability.CustomTarget.ToString().ToLowerInvariant() : skillset.DefaultTarget)"
                                                    data-isapplicable="@(applicability != null ? applicability.IsApplicable.ToString().ToLowerInvariant() : "false")"
                                                    @(decimalScore > 0 ? $"data-value={score}" : "")>@(score > 0 ? score : "")
                                                </button>
                                                @if (showWarning)
                                                {
                                                    <div title="@warningmessage" class="circlebtn btn-orange" style="position: absolute; border: 1px solid #ffa500; height: 19px; width: 19px; right: -2px; bottom: -2px; border-radius: 19px; float: right; font-size: 19px; background: url(/images/icons/v2/warning.png) center / 10px no-repeat, @warningbackgroundcolor;"></div>
                                                }
                                            </div>
                                        </td>
                                    }
                                }
                            }
                        </tr>
                    }
                }

                <tr id="operationalBehaviourStart" class="spacerow">
                    <td colspan="@collspan">
                        @if (Model.ApplicationSettings.Features.SkillMatrixOperationalBehaviour != null && Model.ApplicationSettings.Features.SkillMatrixOperationalBehaviour.Value)
                        {
                            <a onclick="minimizeOperationalBehaviours(this)" class="align-middle" style="color: rgb(147, 197, 75); border-radius: 20px; border: 2px solid rgb(153, 153, 153); display: block; text-align: center; vertical-align: middle; height: 24px; width: 24px"><i id="minimizeOperationalBehaviourButton" class="fas fa-plus-square"></i></a>
                        }
                    </td>
                </tr>

                @{
                    isHeader = true;
                }
                
                <tr class="spacerow">
                    <td colspan="@collspan"></td>
                </tr>
            </table>
        }
        <br /><br /><br /></br /> <!-- spacers added for popup issue --->

        <div id="matrixUsersOverlay" style="position: absolute; display:none; z-index: 4">
            <table style="table-layout: fixed">
                <tr>
                    @{
                        int rowspanOverlay = (Model.CurrentSkillsMatrix.MandatorySkills != null ? Model.CurrentSkillsMatrix.MandatorySkills.Count() : 0) +
                        (Model.CurrentSkillsMatrix.OperationalSkills != null ? Model.CurrentSkillsMatrix.OperationalSkills.Count() : 0) +
                        (Model.CurrentSkillsMatrix.OperationalBehaviours != null ? Model.CurrentSkillsMatrix.OperationalBehaviours.Count() : 0) + 6;

                        foreach (var usergroup in Model.CurrentSkillsMatrix.UserGroups)
                        {
                                <td class="rowtitle" colspan="@(usergroup.Users.Count())"><span>@(usergroup.Name)</span></td>
                                <td rowspan="@rowspanOverlay"></td>
                        }
                    }
                </tr>

                <tr>
                    @foreach (var usergroup in Model.CurrentSkillsMatrix.UserGroups)
                    {
                        @if (usergroup.Users.Count == 0)
                        {
                            <td style="background: #f1f3f1"></td>
                        }
                        else
                        {
                            @foreach (var profile in usergroup.Users)
                            {
                                colspan++;
                                <td class="userOverlay user-title-endcell" style="border: 1px solid rgb(210,210,210)">
                                    <div class="user-title-overlay-content">
                                        <div>
                                            <span class="d-inline vertical" data-containertype="username" data-id="@profile.Id">
                                                @(
                                            string.Format("{0} {1}", profile.FirstName, profile.LastName)
                                        )
                                            </span>
                                        </div>
                                        @if (string.IsNullOrEmpty(profile.Picture) || profile.Picture == "emptyprofile")
                                        {
                                            <img class="user-img" loading="lazy" src="/images/user-placeholder.jpg">
                                        }
                                        else
                                        {
                                            <img class="user-img" loading="lazy" src="/images/media-loading.gif" data-src="@(WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, profile.Picture))">
                                        }
                                    </div>
                                </td>
                            }
                        }
                    }
                </tr>
            </table>
        </div>

        <div id="matrixSkillsOverlay" style="position: absolute; display:none; z-index:5">
            @{
                bool useSpacer = false;
            }

            <table style="table-layout: fixed">
                <tr>
                    <td style="background-color: #F1F3F1" id="greySpacer">
                    </td>
                </tr>

                @if (Model.ApplicationSettings.Features.SkillMatrixMandatorySkills != null && Model.ApplicationSettings.Features.SkillMatrixMandatorySkills.Value)
                {
                    useSpacer = true;
                    @foreach (var skillset in Model.CurrentSkillsMatrix.MandatorySkills.OrderBy(s => s.Index))
                    {
                        <tr class="skillsrow" data-containertype="mandatory_skill_row">
                            <td class="endcell skillcell matrixmandatoryskilloverlay" style="height: 59px">
                                <div>@skillset.Name</div>
                                <small>@skillset.Description</small>
                            </td>
                        </tr>
                    }
                }

                @if (Model.ApplicationSettings.Features.SkillMatrixOperationalSkills != null && Model.ApplicationSettings.Features.SkillMatrixOperationalSkills.Value)
                {
                    if (useSpacer)
                    {
                        <tr class="spacerow" style="background-color: #F1F3F1"><td></td></tr>
                        useSpacer = false;
                    }
                    useSpacer = true;
                    @foreach (var skillset in Model.CurrentSkillsMatrix.OperationalSkills.OrderBy(s => s.Index))
                    {
                        <tr class="skillsrow" data-containertype="operational_skill_row">
                            <td class="endcell skillcell matrixoperationalskilloverlay" style="height: 59px">
                                <div class="matrix-tooltip">
                                    <div>@skillset.Name</div>
                                    <small>@skillset.Description</small>
                                </div>
                            </td>
                        </tr>
                    }
                }

                <tr id="matrixSkillsOverlayOBStart" class="spacerow" style=" background-color: #F1F3F1; height: 35px"><td></td></tr>
                
                <tr id="matrixSkillsOverlayOBEnd"><td></td></tr>
            </table>
        </div>
    </div>
</section>


<!-- Modal -->
<div class="modal fade" id="AddChangeSkillBehaviourModal" data-backdrop="static" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.AddOrChangeSkillTitle, "Add or Change Skill (Operational or Mandatory)") ?? "Add or Change Skill (Operational or Mandatory)")</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body">
                <div class="row">
                    <div class="col-12">
                        <div class="form-group input-group">
                            <select class="form-control" id="dialog_skillselection">
                                @if (Model.UserSkills != null && Model.UserSkills.Count > 0)
                                {
                                    var idsInMatrix = Model.CurrentSkillsMatrix.MandatorySkills != null ? Model.CurrentSkillsMatrix.MandatorySkills.Select(x => x.UserSkillId).ToList() : new List<int>();
                                    if (Model.CurrentSkillsMatrix.OperationalSkills != null)
                                    {
                                        idsInMatrix.AddRange(Model.CurrentSkillsMatrix.OperationalSkills.Select(x => x.UserSkillId).ToList());
                                    }

                                    <option value="" title="Please select an existing skill">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.SelectSkillTitle, "Please select an existing skill.") ?? "Please select an existing skill.")</option>
                                    <optgroup label="In matrix" id="opt_skill_in_matrix">
                                        @foreach (var item in Model.UserSkills.Where(x => x.SkillType == EZGO.Api.Models.Enumerations.SkillTypeEnum.Mandatory && idsInMatrix.Contains(x.Id)).OrderBy(y => y.Name))
                                        {
                                            <option value="@item.Id.ToString()" title="@item.Description" data-inmatrix="true" data-userskillid="@item.Id" data-store="@item.ToJsonFromObject()">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.OptionMandatorySkill, "Mandatory Skill") ?? "Mandatory Skill") - @item.Name</option>
                                        }

                                        @foreach (var item in Model.UserSkills.Where(x => x.SkillType == EZGO.Api.Models.Enumerations.SkillTypeEnum.Operational && idsInMatrix.Contains(x.Id)).OrderBy(y => y.Name))
                                        {
                                            <option value="@item.Id.ToString()" title="@item.Description" data-inmatrix="true" data-userskillid="@item.Id" data-store="@item.ToJsonFromObject()">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.OptionOperationalSkill, "Operational Skill") ?? "Operational Skill") - @item.Name</option>
                                        }
                                    </optgroup>

                                    <optgroup label="Not in matrix" id="opt_skill_not_in_matrix">
                                        @foreach (var item in Model.UserSkills.Where(x => x.SkillType == EZGO.Api.Models.Enumerations.SkillTypeEnum.Mandatory && !idsInMatrix.Contains(x.Id)).OrderBy(y => y.Name))
                                        {
                                            <option value="@item.Id.ToString()" title="@item.Description" data-inmatrix="false" data-userskillid="@item.Id" data-store="@item.ToJsonFromObject()">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.OptionMandatorySkill, "Mandatory Skill") ?? "Mandatory Skill") - @item.Name</option>
                                        }

                                        @foreach (var item in Model.UserSkills.Where(x => x.SkillType == EZGO.Api.Models.Enumerations.SkillTypeEnum.Operational && !idsInMatrix.Contains(x.Id)).OrderBy(y => y.Name))
                                        {
                                            <option value="@item.Id.ToString()" title="@item.Description" data-inmatrix="false" data-userskillid="@item.Id" data-store="@item.ToJsonFromObject()">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.OptionOperationalSkill, "Operational Skill") ?? "Operational Skill") - @item.Name</option>
                                        }
                                    </optgroup>
                                }
                                else
                                {
                                    <option value="" title="No skill available, please select create new">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.OptionNoSkillsAvailable, "No skills available.") ?? "No skills available.")</option>
                                }
                            </select>

                            <div class="input-group-append" style="display: none">
                                <button class="btn btn-default" title="New" id="btn_new_skill" onclick=""><i class="fas fa-plus"></i></button>
                                @if (Model.UserSkills != null && Model.UserSkills.Count > 0)
                                {
                                    <button class="btn btn-default" title="Edit" id="btn_edit_skill" onclick=""><i class="fas fa-edit"></i></button>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <div data-containertype="dialog_skilldetails">
                    <div class="row">
                        <div class="form-group col-12">
                            <label for="dialog_skillname">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.DialogSkillName, "Name") ?? "Name")</label><input type="text" class="form-control" name="dialog_skillname" id="dialog_skillname" />
                        </div>
                    </div>

                    <div id="skill_in_matrix_container" class="row pb-2">
                        <div class="col-12">
                            <div class="btn-group btn-group-sm btn-group-toggle pt-1" data-toggle="buttons" style="display:flex;vertical-align: middle; border-radius: 10px">
                                <label id="skill_in_matrix_label" class="btn btn-light text-muted py-4" style="flex:1;font-weight: 400; border-top-left-radius: 10px; border-bottom-left-radius: 10px">
                                    <input type="radio" checked name="skill_in_matrix" id="skill_in_matrix_true">
                                    <div class="row" style="align-items: center">
                                        <div class="col-auto" style="text-align: right; min-width: 80px">
                                            <i class="fa-solid fa-border-outer" style="font-size: 31px;vertical-align: middle; padding-right: 8px"></i>
                                        </div>
                                        <div class="col" style="text-align: left">
                                            <span style="font-weight: 600">
                                                @(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.SkillInMatrix, "In Matrix") ?? "In Matrix")
                                            </span>
                                            <br />
                                            <span>
                                                Edit and add this skill to this matrix.
                                            </span>
                                        </div>
                                    </div>
                                    
                                </label>

                                <label id="skill_in_matrix_false_label" class="btn btn-light text-muted py-4" style="flex:1;font-weight: 400; border-top-right-radius: 10px; border-bottom-right-radius: 10px">
                                    <input type="radio" name="skill_in_matrix" id="skill_in_matrix_false">

                                    <div class="row" style="align-items: center">
                                        <div class="col-auto" style="text-align: right; min-width: 80px">
                                            <i class="fa-solid fa-border-none" style="font-size: 31px;vertical-align: middle; padding-right: 8px"></i>
                                        </div>
                                        <div class="col" style="text-align: left">
                                            <span style="font-weight: 600">
                                                Not in matrix
                                            </span>
                                            <br />
                                            <span>
                                                Edit this skill without adding it to this matrix.
                                            </span>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group col-12">
                            <label for="dialog_skilldescription">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.DialogSkillDescription, "Description") ?? "Description")</label><input type="text" class="form-control" name="dialog_skilldescription" id="dialog_skilldescription" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <div class="btn-group btn-group-sm btn-group-toggle pt-1" data-toggle="buttons" style="display:flex;vertical-align: middle">
                                <label id="dialog_type_1_label" class="btn btn-light text-muted py-4" style="flex:1;font-weight: 400; border-top-left-radius: 10px; border-bottom-left-radius: 10px">
                                    <input type="radio" checked name="dialog_type" id="dialog_type_1">
                                        <i class="fa-regular fa-seal-exclamation" style="font-size: 31px;vertical-align: middle; padding-right: 8px"></i>
                                    <span style="font-weight: 600">
                                        @(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.OptionMandatorySkill, "Mandatory skill") ?? "Mandatory skill")
                                    </span>
                                </label>

                                <label id="dialog_type_2_label" class="btn btn-light text-muted py-4" style="flex:1;font-weight: 400; border-top-right-radius: 10px; border-bottom-right-radius: 10px">
                                    <input type="radio" name="dialog_type" id="dialog_type_2">
                                    <i class="fa-regular fa-seal" style="font-size: 31px;vertical-align: middle; padding-right: 8px"></i>
                                    <span style="font-weight: 600">
                                        @(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.OptionOperationalSkill, "Operational skill") ?? "Operational skill")
                                    </span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="row pt-2">
                        <div id="expiry_in_days_container" class="form-group col-4">
                            <label for="" title="Expiry in days after creation">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.DialogExpiryInDays, "Expiry in days") ?? "Expiry in days")</label>
                            <input type="number" class="form-control" name="dialog_expiryindays" id="dialog_expiryindays" min="0" />
                        </div>

                        <div id="notification_window_container" class="form-group col-4">
                            <label for="" title="Notification window when data is expiring">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.DialogNotificationWindowDays, "Notification window in days") ?? "Notification window in days")</label>
                            <input type="number" class="form-control" name="dialog_notification_window_days" id="dialog_notification_window_days" min="0" />
                        </div>

                        <div id="default_target_container" class="form-group col-6" style="display: none">
                            <div class="row">
                                <div class="col-auto d-flex" style="align-items: end;padding-bottom: 8px;">
                                    <label for="default_target" title="Default target">Default target</label>
                                </div>
                                <div class="col d-flex" style="flex-wrap: wrap; user-select:none">

                                    <div id="defaultTarget-1" data-value="1" class='item-target btn-red m-1'>1</div>
                                    <div id="defaultTarget-2" data-value="2" class='item-target btn-orangered m-1'>2</div>
                                    <div id="defaultTarget-3" data-value="3" class='item-target btn-orange m-1'>3</div>
                                    <div id="defaultTarget-4" data-value="4" class='item-target btn-orangegreen m-1'>4</div>
                                    <div id="defaultTarget-5" data-value="5" class='item-target btn-green m-1'>5</div>
                                </div>
                            </div>
                        </div>

                        <div id="required_goal_container" class="form-group col-4">
                            <label for="" title="Aimed number of users that completed this operational/mandatory skill">
                                @(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.SkillMatrixRequiredLabel, "Required") ?? "Required")
                            </label>
                            <input type="number" class="form-control" name="dialog_goal" id="dialog_goal" min="0" />
                        </div>
                    </div>

                    <div class="row pt-2">
                        <div class="form-group col-4">
                            <label for="" style="display: none">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.DialogValidFrom, "Valid from") ?? "Valid from")</label>
                            <input type="date" class="form-control" name="dialog_validfrom" id="dialog_validfrom" disabled style="display: none" />
                        </div>

                        <div class="form-group col-4">
                            <label for="" style="display: none">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.DialogValidTo, "Valid to") ?? "Valid to")</label>
                            <input type="date" class="form-control" name="dialog_validto" id="dialog_validto" disabled style="display: none" />
                        </div>
                    </div>

                    <div class="row" id="modal_assessment_container" style="display: none">
                        <div class="form-group col-md-12">
                            <label for="modal_assessment_choice">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.SelectAssessmentTitle, "Select Assessment") ?? "Select Assessment")</label>
                            @if (Model.SkillAssessmentTemplates != null)
                            {
                                <select id="modal_assessment_choice" class="form-control">
                                    <option value=""></option>
                                    @foreach (var item in Model.SkillAssessmentTemplates)
                                    {
                                        <option value="@item.Id">@item.Name</option>
                                    }
                                </select>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button id="btnDeleteUserSkill" type="button" class="btn btn-danger btn-sm" disabled>Delete</button>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal" data-action="close">@(Model?.CmsLanguage.GetValue(LanguageKeys.Skills.BtnClose, "Close") ?? "Close")</button>
                <button type="button" class="btn btn-ezgo btn-sm" data-action="update" id="skill_update_matrix" disabled>@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.BtnUpdate, "Update") ?? "Update")</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="AddChangeUserGroupModal" data-backdrop="static" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.AddOrChangeUserGroupsTitle, "Add or Change user groups") ?? "Add or Change user groups")</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close" data-actiontype="close_modal">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body">
                <div class="row">
                    <div class="form-group input-group col-md-12">
                        @*TODO replace with groups call*@
                        <select id="group_choice" class="form-control">
                            @if (Model.UserGroups != null)
                            {
                                var idsInMatrix = Model.CurrentSkillsMatrix.UserGroups != null ? Model.CurrentSkillsMatrix.UserGroups.Select(x => x.UserGroupId).ToList() : new List<int>();
                                var groupsInMatrix = Model.UserGroups.Where(x => idsInMatrix.Contains(x.Id)).OrderBy(y => y.Name).ToList();
                                var groupsNotInMatrix = Model.UserGroups.Where(x => !idsInMatrix.Contains(x.Id)).OrderBy(y => y.Name).ToList();

                                <option value="" title="Please select a group">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.OptionSelectAnExistingGroup, "Please select an existing group.") ?? "Please select an existing group.")</option>
                                <optgroup label="In Matrix" id="opt_group_in_matrix">
                                    @foreach (var item in groupsInMatrix)
                                    {
                                        <option value="@item.Id" title="@item.Description" data-inmatrix="true" data-store="@item.ToJsonFromObject()">@item.Name</option>
                                    }
                                </optgroup>

                                <optgroup label="Not in Matrix" id="opt_group_not_in_matrix">
                                    @foreach (var item in groupsNotInMatrix)
                                    {
                                        <option value="@item.Id" title="@item.Description" data-inmatrix="false" data-store="@item.ToJsonFromObject()">@item.Name</option>
                                    }
                                </optgroup>
                            }
                            else
                            {
                                <option value="" title="No group available">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.OptionNoGroupAvailable, "No groups available, create a new one.") ?? "No groups available, create a new one.")</option>
                            }
                        </select>

                        <div class="input-group-append" style="display: none">
                            <button type="button" class="btn btn-default" title="New" id="btn_add_group"><i class="fa fa-plus"></i></button>
                            <button type="button" class="btn btn-default" title="Change" id="btn_change_group"><i class="fa fa-edit"></i></button>
                        </div>
                    </div>

                    <div class="row col-md-12" data-containertype="group_details" style="display:none;">
                        <div class="form-group col-md-4">
                            <label for="">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.GroupName, "Group name") ?? "Group name")</label>
                            <input type="text" id="group_name" name="group_name" class="form-control" />
                        </div>

                        <div class="form-group col-md-7" style="padding-left: 13px">
                            <label for="">@(Model?.CmsLanguage.GetValue(LanguageKeys.Skills.GroupDesctiprion, "Group description") ?? "Group description")</label>
                            <input type="text" id="group_description" name="group_name" class="form-control" />
                        </div>

                        <div class="form-group col-md-1 align-self-md-center" data-containertype="in_matrix_container">
                            <label for="">In Matrix</label>
                            <input type="checkbox" id="group_in_matrix" name="group_in_matrix" class="form-control" style="accent-color: #93C54B" />
                        </div>

                        <div class="col-md-12" data-containertype="change_group_buttons">
                            <button id="btn_save_group" class="btn btn-ezgo btn-sm">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.BtnSaveGropu, "Save group") ?? "Save group")</button>
                            <button id="btn_cancel_group" class="btn btn-ezgo btn-sm">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.BtnCancel, "Cancel") ?? "Cancel")</button>
                        </div>
                    </div>
                </div>

                <div class="row" data-containertype="group_user_details">
                    <div class="col-4">
                        <div class="row">
                            <div class="input-group border-light" style="margin: 7px; padding-right: 5px;">
                                <input type="text" id="searchpersonexecute" name="searchpersonexecute" class="form-control" data-action="search_person" />
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-default"><i class="fas fa-search" title="Search"></i></button>
                                    <button type="button" class="btn btn-default" id="clear_search_btn" title="Reset search"><i class="fas fa-sync"></i></button>
                                </div>
                            </div>
                        </div>

                        <div class="row input-group" style="margin: 5px;">
                            <div style="max-height: 500px; overflow: auto;">
                                <ul style="width:100%;margin-left:0px;padding-left:0px;" data-containertype="group_all_users">
                                    @if (Model.Users != null)
                                    {
                                        foreach (var user in Model.Users)
                                        {
                                            var picture = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, user.Picture);

                                            <li class="list-group-item" data-lastname="@user.LastName" data-firstname="@user.FirstName" data-id="@user.Id" data-containertype="user_choice" data-action="user_choice" style="margin-left: 5px; margin-right: 5px; cursor: pointer; ">
                                                <div class="row">
                                                    <div class="col-md-9" data-containertype="user_choice_name"><img class="user-img" src="/images/media-loading.gif" data-src="@picture" style="width:25px;height:25px;" loading="lazy" />&nbsp;&nbsp;<span>@user.LastName, @user.FirstName</span></div>
                                                    <div class="col-md-3" style="text-align:right;"><button data-actiontype="add_user_to_group" data-id="@user.Id" class="btn btn-sm btn-ezgo">>></button></div>
                                                </div>
                                            </li>
                                        }
                                    }
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="col-8">
                        <div style="margin-top: 7px; height: 620px; max-height: 620px; overflow: auto; " class="border rounded">
                            <ul style="margin-left:0px;padding-left:0px;" data-containertype="group_users">
                                @if (Model.Users != null)
                                {
                                    @foreach (var user in Model.Users)
                                    {
                                        var picture = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, user.Picture);
                                        var possibleMatrixUsers = Model.MatrixUsers.Where(x => x.UserProfileId == user.Id);

                                        <li class="list-group-item" data-lastname="@user.LastName" data-firstname="@user.FirstName" data-groupid="@(possibleMatrixUsers != null && possibleMatrixUsers.Any() ? possibleMatrixUsers.Select(x => x.GroupId).ToList().ToJsonFromObject() : "")" data-id="@user.Id" data-containertype="user_chosen" data-action="user_chosen" style="margin-left: 5px; margin-right: 5px; cursor: pointer; ">
                                            <div class="row">
                                                <div class="col-md-9" data-containertype="user_chosen_name">
                                                    <img class="user-img" src="/images/media-loading.gif" data-src="@picture" style="width:25px;height:25px;" loading="lazy" />&nbsp;&nbsp;<span>@user.LastName, @user.FirstName</span>
                                                </div>

                                                <div class="col-md-3" data-actiontype="remove_user_from_group" data-id="@user.Id" style="text-align:right;">
                                                    <i class="far fa-trash-alt red"></i>
                                                </div>
                                            </div>
                                        </li>
                                    }
                                }
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button id="btnDeleteUserGroup" type="button" class="btn btn-danger btn-sm" disabled>Delete</button>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal" data-action="close">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.BtnClose, "Close") ?? "Close")</button>
                <button type="button" class="btn btn-ezgo btn-sm" data-action="update">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.BtnUpdate, "Update") ?? "Update")</button>
            </div>
        </div>
    </div>
</div>

<!-- Matrix Legend Modal - Dynamic content loaded from configuration -->
<div class="modal fade" id="MatrixLegendModal" tabindex="-1" role="dialog" aria-labelledby="matrixLegendModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="matrixLegendModalTitle">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.MatrixLegendTitle, "Matrix legend") ?? "Matrix legend")</h4>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body" id="matrixLegendModalBody">
                <!-- Mandatory Skills Section - Dynamic -->
                @if (Model.ApplicationSettings.Features.SkillMatrixMandatorySkills != null && Model.ApplicationSettings.Features.SkillMatrixMandatorySkills.Value)
                {
                    <h5>@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.MatrixMandatorySkills, "Mandatory skills") ?? "Mandatory skills")</h5>
                    <div id="legendMandatorySkills" class="mb-4">
                        <!-- Dynamic mandatory skills will be loaded here -->
                        <div class="row">
                            <div class="col-4 d-flex align-items-center mb-2">
                                <button class="btn circlebtn m-2 legend-btn-mandatory" data-skill-level-id="1" type="button" style="cursor: default; background-color: #DDF7DD; border-color: #008000; color: #008000;"><i class="fa fa-thumbs-up"></i></button>
                                <span class="legend-label-mandatory" data-skill-level-id="1">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.ValueMastersTheSkill, "Masters the skill") ?? "Masters the skill")</span>
                            </div>
                            <div class="col-4 d-flex align-items-center mb-2">
                                <button class="btn circlebtn m-2 legend-btn-mandatory" data-skill-level-id="2" type="button" style="cursor: default; background-color: #FFF0D4; border-color: #FFA500; color: #FFA500;"><i class="fa fa-exclamation-triangle"></i></button>
                                <span class="legend-label-mandatory" data-skill-level-id="2">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.ValueAlmostExpired, "Almost expired") ?? "Almost expired")</span>
                            </div>
                            <div class="col-4 d-flex align-items-center mb-2">
                                <button class="btn circlebtn m-2 legend-btn-mandatory" data-skill-level-id="3" type="button" style="cursor: default; background-color: #FFEAEA; border-color: #CB0000; color: #CB0000;"><i class="fa fa-exclamation-triangle"></i></button>
                                <span class="legend-label-mandatory" data-skill-level-id="3">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.ValueExpired, "Expired") ?? "Expired")</span>
                            </div>
                        </div>
                    </div>
                }

                <!-- Operational Skills Section - Dynamic -->
                @if (Model.ApplicationSettings.Features.SkillMatrixOperationalSkills != null && Model.ApplicationSettings.Features.SkillMatrixOperationalSkills.Value)
                {
                    <h5>@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.MatrixOperationalSkillsTitle, "Operational skills") ?? "Operational skills")</h5>
                    <div id="legendOperationalSkills" class="mb-4">
                        <!-- Dynamic operational skills will be loaded here -->
                        <div class="row">
                            <div class="col-6 d-flex align-items-center mb-2">
                                <button class="btn circlebtn m-2 legend-btn-operational" data-skill-level-id="1" type="button" style="font-size:22px !important; cursor: default; background-color: #FFEAEA; border-color: #CB0000; color: #CB0000;">1</button>
                                <span class="legend-label-operational" data-skill-level-id="1">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.ValueNoKnowTheTheory, "Doesn't know the theory") ?? "Doesn't know the theory")</span>
                            </div>
                            <div class="col-6 d-flex align-items-center mb-2">
                                <button class="btn circlebtn m-2 legend-btn-operational" data-skill-level-id="2" type="button" style="font-size:22px !important; cursor: default; background-color: #FFE4DA; border-color: #FF4500; color: #FF4500;">2</button>
                                <span class="legend-label-operational" data-skill-level-id="2">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.ValueKnowTheTheory, "Knows the theory") ?? "Knows the theory")</span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6 d-flex align-items-center mb-2">
                                <button class="btn circlebtn m-2 legend-btn-operational" data-skill-level-id="3" type="button" style="font-size:22px !important; cursor: default; background-color: #FFF0D4; border-color: #FFA500; color: #FFA500;">3</button>
                                <span class="legend-label-operational" data-skill-level-id="3">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.ValueStandardSituations, "Is able to apply this in the standard situations") ?? "Is able to apply this in the standard situations")</span>
                            </div>
                            <div class="col-6 d-flex align-items-center mb-2">
                                <button class="btn circlebtn m-2 legend-btn-operational" data-skill-level-id="4" type="button" style="font-size:22px !important; cursor: default; background-color: #F2F5DD; border-color: #8DA304; color: #8DA304;">4</button>
                                <span class="legend-label-operational" data-skill-level-id="4">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.ValueNonStandardConditions, "Is able to apply this in the non-standard conditions") ?? "Is able to apply this in the non-standard conditions")</span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6 d-flex align-items-center mb-2">
                                <button class="btn circlebtn m-2 legend-btn-operational" data-skill-level-id="5" type="button" style="font-size:22px !important; cursor: default; background-color: #DDF7DD; border-color: #008000; color: #008000;">5</button>
                                <span class="legend-label-operational" data-skill-level-id="5">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.ValueCanEducateOthers, "Can educate others") ?? "Can educate others")</span>
                            </div>
                        </div>
                    </div>
                }

                <!-- Operational Behavior Section - Static (not customizable) -->
                @if (Model.ApplicationSettings.Features.SkillMatrixOperationalBehaviour != null && Model.ApplicationSettings.Features.SkillMatrixOperationalBehaviour.Value)
                {
                    <h5>@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.MatrixOperationalBehaviorTitle, "Operational behavior (generated statistics)") ?? "Operational behavior (generated statistics)")</h5>
                    <div class="row">
                        <div class="col-6 d-flex align-items-center mb-2">
                            <button style="cursor: default;" class="btn circlebtn king m-2" type="button" title="The King with 80-100% score of total"></button>
                            <span>@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.ValueTheKingScoreOfTotal, "The King with a score of above 100%") ?? "The King with a score of above 100%")</span>
                        </div>
                        <div class="col-6 d-flex align-items-center mb-2">
                            <button style="cursor: default;" class="btn circlebtn champion m-2" type="button" title="Champion with 60-80% score of total"></button>
                            <span>@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.ValueChampionScoreOfTotal, "Champion with a score between 90 - 100%") ?? "Champion with a score between 90 - 100%")</span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-6 d-flex align-items-center mb-2">
                            <button style="cursor: default;" class="btn circlebtn spoton m-2" type="button" title="Spot On with 40-60% score of total"></button>
                            <span>@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.ValueSpotOnScoreOfTotal, "Spot On with a score of 60 - 90%") ?? "Spot On with a score of 60 - 90%")</span>
                        </div>
                        <div class="col-6 d-flex align-items-center mb-2">
                            <button style="cursor: default;" class="btn circlebtn risingstar m-2" type="button" title="Rising Star with 20-40% score of total"></button>
                            <span>@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.ValueRisingStarScoreOfTotal, "Rising Star with a score between 20 - 60%") ?? "Rising Star with a score between 20 - 60%")</span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 d-flex align-items-center mb-2">
                            <button style="cursor: default;" class="btn circlebtn powerup m-2" type="button" title="Power Up with 0-20% score of total"></button>
                            <span>@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.ValuePowerUpScoreOfTotal, "Power Up with a score between 0 - 20%") ?? "Power Up with a score between 0 - 20%")</span>
                        </div>
                    </div>
                }
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal" data-action="close">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.BtnClose, "Close") ?? "Close")</button>
            </div>
        </div>
    </div>
</div>




<!-- Modal -->
<div class="modal fade" id="UserSkillValuesModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
        <div id="UserSkillValuesModalContent" class="modal-content">

        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="CustomTargetModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-md" role="document">

        <div class="modal-content">
            <div class="modal-header">
                <div class="row" style="width: 100%;">
                    <div class="col">
                        <div class="row">
                            <div class="col-12">
                                <h4 class="modal-title">Set Custom target</h4>
                            </div>
                            <div class="col-12">
                                <h6 id="customTargetOperationalSkillName">Skill name</h6>
                            </div>
                        </div>
                    </div>
                    <div class="col-auto">
                        <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="modal-body">
                <div class="row" style="background-color: #93C54B1A; border-radius: 10px">
                    <div class="col-12">

                        <div class="col d-flex py-2" style="flex-wrap: wrap; user-select:none; justify-content: space-evenly">

                            <div id="customDefaultTarget-1" data-value="1" class='item-custom-target btn-red m-1'>1</div>
                            <div id="customDefaultTarget-2" data-value="2" class='item-custom-target btn-orangered m-1'>2</div>
                            <div id="customDefaultTarget-3" data-value="3" class='item-custom-target btn-orange m-1'>3</div>
                            <div id="customDefaultTarget-4" data-value="4" class='item-custom-target btn-orangegreen m-1'>4</div>
                            <div id="customDefaultTarget-5" data-value="5" class='item-custom-target btn-green m-1'>5</div>
                            <div id="customDefaultTarget--1" data-value="-1" class='item-custom-target btn-white m-1'>&times;</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-danger btn-sm resetToDefaultTargetButton">Reset to default target</button>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal" data-action="close">@(Model?.CmsLanguage.GetValue(LanguageKeys.Skills.BtnClose, "Close") ?? "Close")</button>
                <button type="button" class="btn btn-ezgo btn-sm configureCustomTargetButton">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.BtnUpdate, "Update") ?? "Update")</button>
            </div>
        </div>
    </div>
</div>



<!-- Modal -->
<div class="modal fade" id="ChangeSkillOrderModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content" style="background-color: #f1f3f1">
            <div class="modal-header">
                <h4 class="modal-title" id="ChangeSkillOrderTitle">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.ChangeSkillOrder, "Change skill order") ?? "Change skill order")</h4>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body" id="ChangeSkillOrderBody">
                <h5>@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.MandatorySkillsTitle, "Mandatory skills") ?? "Mandatory skills")</h5>
                <div id="ChangeSkillOrderMandatorySkills" class="noselect">
                    @foreach (var skill in Model.CurrentSkillsMatrix.MandatorySkills.OrderBy(s => s.Index))
                    {

                        <div class="mb-1 mt-1 p-1 changeSkillOrderSkill col-12" style="" data-matrixid="@Model.CurrentSkillsMatrix.Id" data-userskillid="@skill.UserSkillId" data-relationid="@skill.Id" data-index="@skill.Index" data-ischanged="false" data-container="mandatorySkill">
                            <div class="col-2">
                                <small data-container="index_display_mandatory">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.IndexNr, "Index nr: ") ?? "Index nr: ")@skill.Index</small>
                            </div>

                            <div class="col-9">
                                <h6>@skill.Name</h6>
                            </div>
                        </div>
                    }
                </div>

                <h5 class="pt-2 mt-2">Operational skills</h5>
                <div id="ChangeSkillOrderOperationalSkills" class="noselect">
                    @foreach (var skill in Model.CurrentSkillsMatrix.OperationalSkills.OrderBy(s => s.Index))
                    {
                        <div class="mb-1 mt-1 p-1 changeSkillOrderSkill col-12" style="" data-matrixid="@Model.CurrentSkillsMatrix.Id" data-userskillid="@skill.UserSkillId" data-relationid="@skill.Id" data-index="@skill.Index" data-ischanged="false" data-container="operationalSkill">
                            <div class="col-2">
                                <small data-container="index_display_operational">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.IndexNr, "Index nr: ") ?? "Index nr: ")@skill.Index</small>
                            </div>

                            <div class="col-9">
                                <h6>@skill.Name</h6>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal" data-action="close">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.BtnClose, "Close") ?? "Close")</button>
                <button class="btn btn-ezgo btn-sm mr-2 shadow-sm mt-auto" id="save_indices">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.BtnSave, "Save") ?? "Save")</button>
            </div>
        </div>
    </div>
</div>


@section Scripts{
    <script src="/js/ezgoUtils.js"></script>
    <script src="/js/matrix.js"></script>
    <script>
        matrix.language = {
            userSkills: '@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.MatrixUserSkillModalUserSkills, "User skills - ") ?? "User skills - ")',
            expiryInDays: '@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.MatrixUserSkillModalExpiryInDays, "Expiry in days: ") ?? "Expiry in days: ")',
            expiryInDaysNotSet: '@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.MatrixUserSkillModalExpiryInDaysNotSet, "Expiry in days: not set") ?? "Expiry in days: not set")',
            expiryWarningInDays: '@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.MatrixUserSkillModalExpiryWarningInDays, "expiry warning in days: ") ?? "expiry warning in days: ")',
            expiryWarningInDaysNotSet: '@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.MatrixUserSkillModalExpiryWarningInDaysNotSet, "expiry warning in days: not set") ?? "expiry warning in days: not set")',
            certifiedAt: '@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.MatrixUserSkillModalCertifiedAt, "Certified at") ?? "Certified at")',
            confirm: '@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.MatrixUserSkillModalConfirm, "Confirm") ?? "Confirm")',
            cancel: '@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.BtnCancel, "Cancel") ?? "Cancel")',
            keepOldScores: '@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.MatrixUserSkillModalKeepOldScoresBtn, "Keep old scores") ?? "Keep old scores")',
            removeOldScores: '@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.MatrixUserSkillModalRemoveOldScoresBtn, "Remove old scores") ?? "Remove old scores")',
            keepOldScoresDialogueBody: '@(Html.Raw(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.MatrixUserSkillModalKeepOldScoresMessageBody, "The assessment template that is connected to this skill has been changed.<br />The scores from the new assessment will be used for everybody who has completed it already.<br /> Do you want to keep the old scores for users who have not completed the new assessment yet?") ?? "The assessment template that is connected to this skill has been changed.<br />The scores from the new assessment will be used for everybody who has completed it already.<br /> Do you want to keep the old scores for users who have not completed the new assessment yet?"))',
        };

        function printSkillAssessment() {
            var t = $('#itemlist li').eq(15).append('<div style="height:170px;page-break-after: always !important;page-break: always !important;" class="pagebreak"></div>');
            var result = $('ul.list-group li.active').map(function (i, opt) {
                return $(opt).text();
            }).toArray().join(' -> ');
            $("#mainCol").animate({ scrollTop: $('#mainCol').prop("scrollHeight") }, 1000);
            $('#areaprintlist').text(': ' + result);
            $('#mainCol').css('height', 'auto !important');
            $('.content-wrapper').removeClass('main-bg-color');
            $('.main-footer').hide();
            setTimeout(function () {
                window.print();
                t.remove();
                $('.content-wrapper').addClass('main-bg-color');
                $('#mainCol').css('height', 'height:calc(100vh - 175px)');
                $('#areaprintlist').text('');
                $('#mainCol').scrollTop(0);
            }, 1000);
        }

        matrix.init(@Model.CurrentSkillsMatrix.Id);
        function minimizeOperationalBehaviours(e) {
            if ($('#minimizeOperationalBehaviourButton').hasClass("fa-minus-square")) {
                $('.operationalbehaviour').fadeOut();
                $('.operationalbehaviouroverlay').fadeOut();

                $('#minimizeOperationalBehaviourButton').removeClass('fa-minus-square');
                $('#minimizeOperationalBehaviourButton').addClass('fa-plus-square');
                $(e).css('color', 'rgb(147, 197, 75)');

                $('.operationalbehaviour').remove();
                $('.operationalbehaviouroverlay').remove();
            }
            else {
                $.ajax({
                    type: "GET",
                    url: '/skillmatrices/operationalbehaviour/' + matrix.currentMatrixId,
                    success: function (data) {
                        if (data != null) {
                            $('.operationalbehaviour').remove();
                            $('.operationalbehaviouroverlay').remove();
                            $('#operationalBehaviourStart').after(data);

                            $('.operationalbehaviour').fadeIn();
                            $('#minimizeOperationalBehaviourButton').removeClass('fa-plus-square');
                            $('#minimizeOperationalBehaviourButton').addClass('fa-minus-square');
                            $(e).css('color', 'rgb(147, 197, 75)');

                            $('.matrixoperationalbehaviour').each(function (index, elem) {
                                var obName = $(elem).data('name');
                                var obDescription = $(elem).data('description');

                                $('#matrixSkillsOverlayOBEnd').before(
                                `<tr class="skillsrow operationalbehaviouroverlay">
                                    <td class="endcell skillcell matrixoperationalbehaviouroverlay" style="height: 59px">
                                        <div>{{name}}</div>
                                        <small>{{description}}</small>
                                    </td>
                                </tr>`
                                .replaceAll('{{name}}', obName).replaceAll('{{description}}', obDescription));
                            });
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        toastr.error(jqXHR.responseText + ' (' + jqXHR.status + ')');
                    },
                    contentType: "application/json; charset=utf-8"
                });
            }
        }

        ezgomediafetcher.preloadImagesAndVideos();
    </script>
}