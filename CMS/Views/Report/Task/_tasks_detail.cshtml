@model CompletedTaskViewModel
@using WebApp.Models.Checklist
@using System.Text
@using WebApp.Models.Shared
@{
    var tz = User.FindFirst(System.Security.Claims.ClaimTypes.Country)?.Value ?? "Europe/Amsterdam";
    TimeZoneInfo timezone = TZConvert.EzFindTimeZoneInfoById(tz);

    string getIconColor(string state)
    {
        switch (state.ToLower())
        {
            case "ok":
                return "bg-green";
            case "not ok":
                return "bg-red";
            case "skipped":
                return "bg-warning";
            default:
                return "bg-lightGray";
        }
    }
    string getIcon(string state)
    {
        switch (state.ToLower())
        {
            case "ok":
                return "fa-thumbs-up status-icon";
            case "not ok":
                return "fa-thumbs-down status-icon";
            case "skipped":
                return "fa-forward status-icon";
            default:
                return "fa-question";
        }
    }

}

@foreach (var completedTask in @Model.CompletedTasks)
{

    <div id="completedTask-@completedTask.Id" data-id="@completedTask.Id" class="list-group-item d-flex justify-content-start align-items-center linkableTask" style="padding: .50rem .75rem;">
        <!-- Media display -->
        @{
            var picture = WebApp.Logic.Constants.General.ImageUnavailableUrl;
            if (!string.IsNullOrEmpty(completedTask.Picture))
            {
                var imgUrl = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, completedTask.Picture);

                <a href="/images/media-loading.gif" data-href="@imgUrl" data-fancybox="completedtasks" data-caption="@completedTask.Name" style="min-height: 100%">
                    <img style="object-fit: cover; object-position: center; height: 70px; width: 80px; float: left;" loading="lazy" src="/images/media-loading.gif" data-src="@imgUrl" />
                </a>
            }
            else if (!string.IsNullOrEmpty(completedTask.VideoThumbnail))
            {
                var thumbnailUrl = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, completedTask.VideoThumbnail);
                var videoUrl = completedTask.Video;
                if (!videoUrl.StartsWith("https:"))
                {
                    videoUrl = WebApp.Helpers.MediaHelpers.GetMediaVideoUrl(Model.ApplicationSettings, completedTask.Video);
                }

                <a href="#itemVideo-@(completedTask.Id)" data-fancybox="postImageFancybox-@completedTask.Id">
                    <img style="object-fit: cover; object-position: center; height: 70px; width: 80px; float: left;" loading="lazy" src="/images/media-loading.gif" data-src="@thumbnailUrl" />
                </a>

                <video src="/images/media-loading.mp4" data-src="@videoUrl" controls id="itemVideo-@(completedTask.Id)" style="display:none;">
                    @(Model?.CmsLanguage.GetValue(LanguageKeys.FrameWork.BrowserNoSupporForHTML5, "Your browser doesn't support HTML5 video tag.") ?? "Your browser doesn't support HTML5 video tag.")
                </video>
            }
            else
            {
                <a href="/images/media-loading.gif" data-href="@picture" data-fancybox="completedtasks" data-caption="@completedTask.Name">
                    <img style="object-fit: cover; object-position: center; height: 70px; width: 80px; float: left;" loading="lazy" src="/images/media-loading.gif" data-src="@picture" />
                </a>
            }
        }

        <div class="mx-2 width-available">
            <span style="float:left;clear:left;position:relative;font-weight: 800">@completedTask.Name</span>
            <span style="float:left;clear:left;position:relative;">@(Model?.CmsLanguage.GetValue(LanguageKeys.Dashboard.DueAt, "Due at") ?? "Due at") @completedTask.DueAt.Value.ToLocaleFullDateShortTimeString(Model.Locale)</span>
            @if (completedTask.Signature != null && completedTask.Signature.SignedAt != null)
            {
                <span style="float:left;clear:left;position:relative;">
                    @(Model?.CmsLanguage?.GetValue(LanguageKeys.Dashboard.CompletedBy, "Completed by") ?? "Completed by") @completedTask.Signature.SignedBy @(Model?.CmsLanguage.GetValue(LanguageKeys.Dashboard.At, "at") ?? "at") @TimeZoneInfo.ConvertTime(completedTask.Signature.SignedAt.Value, timezone).ToLocaleFullDateShortTimeString(Model.Locale)
                </span>
            }

            @if (!string.IsNullOrEmpty(completedTask.Comment))
            {
                <span style="float:left;clear:left;position:relative;">@(Model?.CmsLanguage.GetValue(LanguageKeys.Task.ReasonForSkippingThisTask, "Reason behind skipping this task") ?? "Reason behind skipping this task"): @completedTask.Comment</span>
            }

            @if (completedTask != null && completedTask.Properties != null)
            {
                <span style="float:left;clear:left;position:relative;">
                    @if (Model.EnablePropertyTiles)
                    {
                        <partial name="~/Views/Shared/_property_tiles.cshtml" model="@(new SharedTaskViewModel() { SharedTaskModel = completedTask.ToJsonFromObject().ToObjectFromJson<SharedTaskModel>(), Locale = Model.Locale})" />
                    }
                    else
                    {
                        @(WebApp.Helpers.CompletedItemDisplayHelpers.GetPropertiesAsString(completedTask, timezone, Model.Locale))
                    }
                </span>
            }

            @if (completedTask?.Tags?.Count > 0 && Model.ApplicationSettings?.Features?.TagsEnabled == true)
            {
                <div class="row m-1" style="float:left;clear:left;position:relative;">
                    @foreach (var tag in completedTask.Tags)
                    {
                        <div class="card column m-1 tag-card" style="background-color: @tag.ColorCode; border-radius: .5em;">
                            <div class="tag-wrapper" style="color:white;">
                                <i class="nav-icon my-1 ml-3 mr-0 @(!String.IsNullOrEmpty(tag.IconStyle) ? "fa-" + tag.IconStyle : "fa-solid") @(!String.IsNullOrEmpty(tag.IconName) ? "fa-" + tag.IconName : "fa-question")"></i>
                                <span class="my-1 ml-1 mr-3 tag-span" style="font-size:.78rem;">@tag.Name</span>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>

        @if (completedTask.ActionsCount > 0 || completedTask.CommentCount > 0)
        {
            <a href="/action/taskactions/@completedTask.Id/@completedTask.TemplateId/true" class="status-circle bg-warning m-1" style="flex-basis: 40px; flex-grow: 0; flex-shrink: 0;"><i class="fa fa-bolt-lightning status-icon"></i></a>
        }

        @if (completedTask.PictureProof != null)
        {
            <a onclick="showPictureProofData(@completedTask.Id)" style="background-color: lightgray; cursor: pointer" class="status-circle m-1"><i class="fas fa-camera status-icon"></i></a>
        }
        <span class="status-circle @getIconColor(completedTask.Status)"><i class="fa @getIcon(completedTask.Status)" title="@completedTask.Status"></i></span>
    </div>

    @if (completedTask.PictureProof != null)
    {
        <div role="dialog" tabindex="-1" class="modal fade h-100" data-backdrop="static" id="pictureProofData-@completedTask.Id">
            <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title" id="exampleModalLongTitle">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PictureProof.PictureProofTitle, "Picture Proof") ?? "Picture Proof")</h4>
                        <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>

                    <div class="modal-body" style="display: flex; justify-content: center">
                        <div id="pictureProofBody">
                            <h5>
                                @(Model?.CmsLanguage?.GetValue(LanguageKeys.PictureProof.PictureProofTitle, "Picture Proof") ?? "Picture Proof") @(Model?.CmsLanguage?.GetValue(LanguageKeys.PictureProof.TakenAt, "taken at") ?? "taken at") @TimeZoneInfo.ConvertTime(completedTask.PictureProof.ProofTakenUtc, timezone).ToLocaleGeneralDateLongTimeString(Model.Locale)
                            </h5>

                            @foreach (var ppMedia in completedTask.PictureProof.Media)
                            {
                                var ppPicture = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, ppMedia.UriPart);
                                <div style="height: 80px">
                                    <a href="/images/media-loading.gif" data-href="@ppPicture" data-fancybox="items-@completedTask.Id" data-caption="">
                                        <img class="mr-1" style="object-fit: cover; object-position: center; height: 70px; width: 80px; float: left;" src="/images/media-loading.gif" data-src="@ppPicture" />
                                    </a>
                                    <p class="pl-2">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PictureProof.PictureProofItem, "Picture Proof item") ?? "Picture Proof item") @ppMedia.ItemName @(Model?.CmsLanguage?.GetValue(LanguageKeys.PictureProof.TakenBy, "taken by") ?? "taken by") @ppMedia.UserFullName @(Model?.CmsLanguage?.GetValue(LanguageKeys.PictureProof.At, "at") ?? "at") @TimeZoneInfo.ConvertTime(ppMedia.PictureTakenUtc, timezone).ToLocaleGeneralDateLongTimeString(Model.Locale)</p>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal" data-action="close">@(Model?.CmsLanguage.GetValue(LanguageKeys.Checklist.BtnClose, "Close") ?? "Close")</button>
                    </div>
                </div>
            </div>
        </div>
    }
}