@model WebApp.ViewModels.UserProfileViewModel
@using WebApp.Models.User
@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    Dictionary<string, string> CmsLanguage = Model.CmsLanguage;

    List<SelectListItem> SelectedRoles = new List<SelectListItem>
{
        new SelectListItem { Value = "basic", Text = CmsLanguage?.GetValue(LanguageKeys.User.Basic, "Basic") ?? "Basic" },
        new SelectListItem { Value = "shift_leader", Text = CmsLanguage?.GetValue(LanguageKeys.User.ShiftLeader, "Shift Leader") ?? "Shift Leader" },
        new SelectListItem { Value = "manager", Text = CmsLanguage?.GetValue(LanguageKeys.User.Manager, "Manager") ?? "Manager" }
    };

    var picture = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, Model.UserProfile.Picture);
    if (string.IsNullOrEmpty(Model.UserProfile.Picture))
    {
        picture = @"/assets/img/normal_unavailable_image.png";
    }
}

<form id="user_profile_form">
    <div class="row pt-1">
        <div class="col-lg-12">
            <div class="col-12 p-0 pb-3">
                <div class="row card-group">
                    <div class="col-sm-3 col-md-3">
                        <div class="card h-100" style="width:100%;height:238px;display:flex;">
                            <div class="card-body">
                                <div style="text-align: center; width: 100%; height: 100%">
                                    <div style="text-align: center; align-content: center; width: 100%; height: 100%">
                                        <div style="width:100%; height:100%; display: inline-flex; position:relative; align-self: center; ">
                                            <img src="/images/media-loading.gif" data-src="@picture" id="user_image" style="width: 100%; height: 100%; border-radius: 5px;" />
                                            <div class="controls d-print-none" style="position:absolute;bottom:0px;">
                                                <input class="d-none" type="file" id="uploaderTemplate" accept="image/*" name="photo" onchange="profile.previewFile(this);" data-preview="#user_image" data-type="image" required="">
                                                <a href="#" onclick="$('#uploaderTemplate').trigger('click'); return false;">
                                                    <div class="border rounded-circle float-right d-lg-flex justify-content-lg-center shadow main-image-pencil" style="background-color: #93C54B; margin-left: 4px; margin-bottom: 6px; height: 33px; width: 35px">
                                                        <i class="fa fa-paperclip d-lg-flex justify-content-center align-items-center align-content-center" style="font-size: 20px; color: #FFFFFF"></i>
                                                    </div>
                                                </a>
                                                <a href="#" data-selector="deletemedia" data-type="template" onclick="profile.removeFile(this);" data-preview="#user_image">
                                                    <div class="border rounded-circle float-left d-lg-flex justify-content-lg-center shadow main-image-pencil" style="background-color: #93C54B; margin-left: 10px; margin-bottom: 10px; height: 33px; width: 35px">
                                                        <i class="fa fa-trash d-lg-flex justify-content-center align-items-center align-content-center" style="font-size: 20px; color: #FFFFFF"></i>
                                                    </div>
                                                </a>
                                                <video id="dialogVideo" controls="" style="display:none;">
                                                </video>
                                            </div>
                                        </div>
                                    </div>
                                    <!--img src="@picture" id="user_image" class="rounded-circle" width="100" height="100" onerror="this.onerror = null; this.src = '/assets/img/normal_unavailable_image.png';" />-->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-9 col-md-9">
                        <div class="card h-100">
                            <div class="card-body">
                                @if (Model != null || Model.UserProfile.Id > 0)
                                {
                                    <div class="row">
                                        <div class="col">
                                            <small class="card-text text-muted">@(Model?.CmsLanguage?.GetValue(LanguageKeys.User.UserId, "User ID") ?? "User ID"): @Model.UserProfile.Id @(Model.CurrentUser.IsServiceAccount && !string.IsNullOrEmpty(Model.UserProfile.UserGUID) ? Html.Raw(string.Concat("(", Model.UserProfile.UserGUID, ")")) : "")</small>
                                        </div>
                                        <div class="col">
                                            <div style="float:right">
                                                <small id="changedOn" class="card-text text-muted">
                                                    @if (Model.UserProfile != null && Model.UserProfile.ModifiedAt != null)
                                                    {
                                                        @((Model?.CmsLanguage?.GetValue(LanguageKeys.Auditing.LastModifiedAt, "Last modified on ") ?? "Last modified on ") + Model.UserProfile.ModifiedAt)
                                                    }
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                }
                                <div class="row">
                                    <div class="col pb-2">
                                        @Html.TextBoxFor(m => m.UserProfile.FirstName, null, new { @maxlength = "100", @class = "form-control form-control-sm", placeholder = CmsLanguage?.GetValue(LanguageKeys.User.FirstName, "First name") ?? "First name", @type = "text" })
                                    </div>
                                    <div class="col">
                                        @Html.TextBoxFor(m => m.UserProfile.LastName, null, new { @maxlength = "100", @class = "form-control form-control-sm", placeholder = CmsLanguage?.GetValue(LanguageKeys.User.LastName, "Last name") ?? "Last name", @type = "text", required = "true" })
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col pb-2">
                                        @Html.TextBoxFor(m => m.UserProfile.Email, null, new { @class = "form-control form-control-sm", placeholder = CmsLanguage?.GetValue(LanguageKeys.User.Email, "Email address") ?? "Email address", @type = "text" })
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col pb-2">
                                        @Html.TextBoxFor(m => m.UserProfile.UPN, null, new { @class = "form-control form-control-sm", placeholder = CmsLanguage?.GetValue(LanguageKeys.User.UPN, "UPN") ?? "UPN", @type = "text" })
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col pb-2">
                                        <select asp-for="UserProfile.Role" class="form-control form-control-sm" asp-items="@SelectedRoles"></select>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col pb-2">
                                        @Html.TextBoxFor(m => m.UserProfile.UserName, null, new { @maxlength = "150", @class = "form-control form-control-sm", placeholder = CmsLanguage?.GetValue(LanguageKeys.User.UserName, "User name") ?? "User name", @type = "text", required = "true" })
                                    </div>
                                </div>
                                @{
                                    if (Model == null || Model.UserProfile.Id <= 0)

                                    {
                                        <div class="row">
                                            <div class="col pb-2">
                                                @Html.TextBoxFor(m => m.UserProfile.Password, null, new { @class = "form-control form-control-sm", placeholder = CmsLanguage?.GetValue(LanguageKeys.User.DialogPasswordPlaceholder, "Password") ?? "Password", @type = "password", required = "true" })
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col pb-2">
                                                @Html.TextBoxFor(m => m.UserProfile.PasswordConfirmation, null, new { @class = "form-control form-control-sm", placeholder = CmsLanguage?.GetValue(LanguageKeys.User.DialogConfirmPasswordPlaceholder, "Password Confirmation") ?? "Password Confirmation", @type = "password", required = "true" })
                                            </div>
                                        </div>
                                    }

                                }
                                @if (Model.CurrentUser.IsServiceAccount)
                                {
                                    bool isManager = !Model.UserProfile.Role.IsNullOrEmpty() && Model.UserProfile.Role.Equals("manager");
                                    <!-- TRANSLATION -->
                                    string onlyManagerCanBeTagManager = isManager ? null : "Only manager accounts can be flagged as a tag manager";

                                    <div class="row">
                                        <div class="col pb-2">
                                            <div class="custom-control custom-switch">
                                                <input type="checkbox" class="custom-control-input" id="is_tag_manager" @(Model.UserProfile.IsTagManager == true ? "checked" : null) @(!Model.UserProfile.Role.IsNullOrEmpty() && Model.UserProfile.Role.Equals("manager") ? "" : "disabled")>
                                                <label style="font-weight: 400" class="custom-control-label card-text" for="is_tag_manager" title="@onlyManagerCanBeTagManager" )>Tag manager</label> <!-- TRANSLATION -->
                                            </div>
                                        </div>
                                    </div>
                                }
                                
                                @if (Model.ApplicationSettings?.Features?.MarketSapEnabled.HasValue == true && Model.ApplicationSettings?.Features?.MarketSapEnabled == true)
                                {
                                    <div class="row">
                                        <div class="col pb-2">
                                            @Html.TextBoxFor(m => m.UserProfile.SapPmUsername, null, new { @maxlength = "12", @class = "form-control form-control-sm", placeholder = "SAP Pm " + CmsLanguage?.GetValue(LanguageKeys.User.UserName, "User name") ?? "User name", @type = "text" })
                                        </div>
                                    </div>
                                }

                            </div>
                        </div>
                    </div>
                </div>
            </div>

            @if (Model.ApplicationSettings?.Features?.UserExtendedDetailsEnabled.HasValue == true && Model.ApplicationSettings?.Features?.UserExtendedDetailsEnabled == true)
            {
                <div class="col-12 p-0">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">@(CmsLanguage?.GetValue(LanguageKeys.User.UserExtendedDataExtendedDetails, "Extended details") ?? "Extended details")</h3>
                        </div>
                        <div class="card-body">
                            @*
                                //Will be enabled lateron: 
                                <div class="row">
                                <div class="col pb-2">
                                    @Html.TextAreaFor(m => m.UserProfile.UserExtendedDetails.Bio, 3, 40, new { @maxlength = "150", @class = "form-control form-control-sm", placeholder = "Bio", @type = "text", required = "true" })
                                </div>
                            </div>
                        *@
                            <div class="row">
                                <div class="col pb-2">
                                    @Html.TextAreaFor(m => m.UserProfile.UserExtendedDetails.Description, 3, 40, new { @maxlength = "150", @class = "form-control form-control-sm", placeholder = (CmsLanguage?.GetValue(LanguageKeys.User.UserExtendedDataDescription, "Description") ?? "Description"), @type = "text", required = "true" })
                                </div>
                            </div> 
                            <div class="row">
                                <div class="col pb-2">
                                    @Html.TextBoxFor(m => m.UserProfile.UserExtendedDetails.EmployeeId, null, new { @maxlength = "90", @class = "form-control form-control-sm", placeholder = (CmsLanguage?.GetValue(LanguageKeys.User.UserExtendedDataEmployeeIdentifierCode, "Employee Identifier/Code") ?? "Employee Identifier/Code"), @type = "text", required = "true" })
                                </div>
                            </div>
                            <div class="row">
                                <div class="col pb-2">
                                    @Html.TextBoxFor(m => m.UserProfile.UserExtendedDetails.EmployeeFunction, null, new { @maxlength = "90", @class = "form-control form-control-sm", placeholder = (CmsLanguage?.GetValue(LanguageKeys.User.UserExtendedDataEmployeeFunction, "Employee Function") ?? "Employee Function"), @type = "text", required = "true" })
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }

            <div class="col-12 p-0">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">@(CmsLanguage?.GetValue(LanguageKeys.User.AccessLevelTitle, "Access level") ?? "Access level")</h3>
                    </div>

                    <div class="card-body p-3">
                        <div style="margin-bottom:5px;text-align:right;">
                            <input class="btn btn-ezgo btn-sm" type="button" id="choose_allowed_areas_button" value="@(CmsLanguage?.GetValue(LanguageKeys.User.ProfileChangeButton, "Change Allowed Areas") ?? "Change Allowed Areas")" />
                        </div>

                        <div class="card">
                            <div class="card-body" style="max-height:190px;overflow-y:auto;" id="user_allowed_areas">
                                @if (Model.UserProfile.DisplayAreas != null)
                                {
                                    @foreach (AllowedAreaModel item in Model.UserProfile.DisplayAreas)
                                    {
                                        <span class="badge badge-primary" data-areaid="@item.Id" data-name="@item.Name" title="@item.FullDisplayName">@item.Name</span>
                                    }
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            @if (Model.EnableRoleManagement && Model.UserProfile != null && Model.UserProfile.Role != "basic" && Model.UserProfile.Role != "shift_leader" && Model.UserProfile.Id > 0) //only management with manager/shiftleaders
            {
                <div class="col-12 p-0">
                    <div class="card">
                        <div class="card-header">
                            <!-- TRANSLATION -->
                            <h3 class="card-title" title="Roles give access to certain parts of the CMS.">Roles</h3>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                @{
                                    SortedList<int, string> descriptions = new SortedList<int, string>();
                                    descriptions.Add((int)EZGO.Api.Models.Enumerations.RoleTypeEnum.ExtendedUserManager, "Can add/change extended user details.");
                                    descriptions.Add((int)EZGO.Api.Models.Enumerations.RoleTypeEnum.TagManager, "Can manage tags, see tag module.");
                                    descriptions.Add((int)EZGO.Api.Models.Enumerations.RoleTypeEnum.RoleManager, "Can manage roles of users.");
                                    descriptions.Add((int)EZGO.Api.Models.Enumerations.RoleTypeEnum.Viewer, "Can only view data.");
                                    descriptions.Add((int)EZGO.Api.Models.Enumerations.RoleTypeEnum.UserManager, "Can manage users.");

                                    SortedList<int, string> titles = new SortedList<int, string>();
                                    titles.Add((int)EZGO.Api.Models.Enumerations.RoleTypeEnum.ExtendedUserManager, "Extended user details manager");
                                    titles.Add((int)EZGO.Api.Models.Enumerations.RoleTypeEnum.TagManager, "Tag manager");
                                    titles.Add((int)EZGO.Api.Models.Enumerations.RoleTypeEnum.RoleManager, "Role manager");
                                    titles.Add((int)EZGO.Api.Models.Enumerations.RoleTypeEnum.Viewer, "Viewer");
                                    titles.Add((int)EZGO.Api.Models.Enumerations.RoleTypeEnum.UserManager, "User manager");
                                }
                                @foreach (EZGO.Api.Models.Enumerations.RoleTypeEnum r in Enum.GetValues(typeof(EZGO.Api.Models.Enumerations.RoleTypeEnum)))
                                {
                                    //exclude certain items that can not be set. This can be because of limitation or not (fully) implemented yet.
                                    if (!new[] { EZGO.Api.Models.Enumerations.RoleTypeEnum.Staff, EZGO.Api.Models.Enumerations.RoleTypeEnum.ServiceAccount, 
                                                 EZGO.Api.Models.Enumerations.RoleTypeEnum.Basic, EZGO.Api.Models.Enumerations.RoleTypeEnum.Manager,
                                                 EZGO.Api.Models.Enumerations.RoleTypeEnum.ShiftLeader, EZGO.Api.Models.Enumerations.RoleTypeEnum.SuperUser,
                                                 EZGO.Api.Models.Enumerations.RoleTypeEnum.TagManager, EZGO.Api.Models.Enumerations.RoleTypeEnum.Viewer,
                                                 EZGO.Api.Models.Enumerations.RoleTypeEnum.ExtendedUserManager }.Contains(r))
                                    {
                                        <div class="col-md-4">
                                            <div class="custom-control custom-switch">
                                                <input type="checkbox" value="@Convert.ToInt32(r)" class="custom-control-input" id="chk_roles_@Convert.ToInt32(r)" name="chk_roles" @(Model.UserProfile != null && Model.UserProfile.Roles != null && Model.UserProfile.Roles.Contains(r) == true ? "checked" : null)>
                                                <label style="font-weight: 400" class="custom-control-label card-text" for="chk_roles_@Convert.ToInt32(r)" title="@(descriptions.Keys.Where(x => x == (int)r).Any() ? descriptions[(int)r].ToString() : r.ToString())">@(titles.Keys.Where(x => x == (int)r).Any() ? titles[(int)r].ToString() : r.ToString())</label> <!-- TRANSLATION -->
                                            </div>
                                        </div>
                                    }
                                  
                                }
                                
                            </div>
                        </div>
                    </div>
                </div>
            }

            <div class="col-12 p-0" data-container="auditing_data_container" style="display:none;">
                <div class="row card-group">
                    <div class="@if (Model.EnablingAuditing) { <text>col-4</text> } else { <text>col-12</text> } ">
                        <div class="card" style="height: calc(100vh - 195px);">
                            <div class="card-header">
                                <h3 class="card-title">@((CmsLanguage?.GetValue(LanguageKeys.User.RecentChangesByUser, "Recent changes by ") ?? "Recent changes by ") + Model.UserProfile.FirstName + " " + Model.UserProfile.LastName)</h3>
                            </div>

                            <div class="card-body p-3" style="overflow:auto;">
                                <div id="auditing-log-by-user"></div>
                                <div style="margin:12px 20px 5px 20px; text-align: center;">
                                    <input class="btn btn-ezgo btn-sm" type="button" id="btnLoadMoreAuditingByUser" value="@(CmsLanguage?.GetValue(LanguageKeys.User.LoadMoreAuditing, "More") ?? "More")" />
                                </div>
                            </div>
                        </div>
                    </div>

                    @if (Model.EnablingAuditing)
                    {
                        <div class="col-8">
                            <div class="card" style="height: calc(100vh - 195px);">
                                <div class="card-header h5">Details</div> <!-- TRANSLATION -->

                                <div class="card-body" style="overflow: auto;">
                                    <div id="auditingDetails">
                                        @(CmsLanguage?.GetValue(LanguageKeys.Auditing.SelectAChange, "Select a change to view a detailed descritpion") ?? "Select a change to view a detailed descritpion")
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <input type="hidden" id="allowed_area_ids" value="@String.Join(",", Model.UserProfile.DisplayAreas != null ? Model.UserProfile.DisplayAreas.Select(x => x.Id) : new List<int>())" />
    <input type="hidden" id="Picture" value="@Model.UserProfile.Picture" />
</form>
<div id="user_area_choice">
    <!-- div with areas to choose from -->
    <!-- on every click of item get all checked items from tree view, get all ids from those items and regenerate the allowed_area_ids based on those titems, And regenerate the user allowed aeras list.  -->
</div>


