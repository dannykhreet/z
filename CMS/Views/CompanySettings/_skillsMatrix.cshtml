@model WebApp.ViewModels.CompanySettingsViewModel

<!-- Right Content Area -->
<div class="col-9 p-4" style="border-radius: 8px; max-width:100%">
    <!-- Rounding Options Section -->
    <div class="btn-group btn-group-toggle" data-toggle="buttons" style="display: flex; justify-content: space-between;">
        <!-- Use Round Down -->
        <label id="RoundDown_label" class="btn work-instructions-option @(Model.ApplicationSettings?.Features?.EnableMatrixScoreStandard == false ? "active" : "")">
            <input type="radio" name="RoundDown" id="RoundDown" value="RoundDown" @(Model.ApplicationSettings?.Features?.EnableMatrixScoreStandard == false ? "checked" : "") />
            <div class="option-content">
                <i id="RoundDown_icon" class="fa-solid fa-arrow-down-from-line"></i>
                <div class="option-text">
                    <strong>@(Model?.CmsLanguage.GetValue(LanguageKeys.Setting.EnableSkillMatrixTitle, "Round down") ?? "Round down") </strong><br>
                    <span>@(Model?.CmsLanguage.GetValue(LanguageKeys.Setting.EnableSkillMatrixDescription, "The score from an assessment will always be rounded down.") ?? "The score from an assessment will always be rounded down.")</span>
                </div>
            </div>
        </label>

        <!-- Use Standard Round  -->
        <label id="do_not_RoundDown_label" class="btn work-instructions-option @(Model.ApplicationSettings?.Features?.EnableMatrixScoreStandard == true ? "active" : "")">
            <input type="radio" name="RoundDown" id="donotRoundDown" value="donotRoundDown" @(Model.ApplicationSettings?.Features?.EnableMatrixScoreStandard == true ? "checked" : "") />
            <div class="option-content">
                <i id="RoundDown_icon" class="fa-solid fa-arrows-from-line"></i>
                <div class="option-text">
                    <strong>@(Model?.CmsLanguage.GetValue(LanguageKeys.Setting.DisableSkillMatrixTitle, "Standard rounding") ?? "Standard rounding") </strong><br>
                    <span>@(Model?.CmsLanguage.GetValue(LanguageKeys.Setting.DisableSkillMatrixDescription, "Scores below .5 round down, scores of .5 or above round up.") ?? "Scores below .5 round down, scores of .5 or above round up.")</span>
                </div>
            </div>
        </label>
    </div>

    <!-- Legend Customization Section -->
    <div class="mt-4 p-4" style="background-color: #f8f9fa; border-radius: 8px;">
        <h5 class="mb-3">
            <i class="fa fa-palette mr-2"></i>
            @(Model?.CmsLanguage.GetValue(LanguageKeys.Setting.CustomizeLegendTitle, "Customize skill color codes and skill level text") ?? "Customize skill color codes and skill level text")
        </h5>

        <!-- Mandatory Skills Section -->
        <div class="mb-4">
            <h6 class="text-muted mb-3">@(Model?.CmsLanguage.GetValue(LanguageKeys.Setting.MandatorySkillsTitle, "Mandatory skills") ?? "Mandatory skills")</h6>

            <!-- Masters the skill -->
            <div class="legend-item-row d-flex align-items-center mb-2" data-skill-type="mandatory" data-skill-level-id="1">
                <div class="legend-icon-preview mr-3" style="position: relative;">
                    <button class="btn circlebtn btn-green legend-preview-btn" type="button" data-icon-class="thumbsup" style="width: 40px; height: 40px; cursor: pointer;"><i class="fa fa-thumbs-up"></i></button>
                    <span class="legend-edit-indicator" style="position: absolute; bottom: -2px; right: -2px; background: #93C54B; border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center;">
                        <i class="fa fa-pencil" style="font-size: 8px; color: white;"></i>
                    </span>
                </div>
                <input type="text" class="form-control legend-label-input" value="@(Model?.CmsLanguage.GetValue(LanguageKeys.Skills.ValueMastersTheSkill, "Masters the skill") ?? "Masters the skill")" style="flex: 1;" />
            </div>

            <!-- Almost expired -->
            <div class="legend-item-row d-flex align-items-center mb-2" data-skill-type="mandatory" data-skill-level-id="2">
                <div class="legend-icon-preview mr-3" style="position: relative;">
                    <button class="btn circlebtn btn-orange legend-preview-btn" type="button" data-icon-class="warning" style="width: 40px; height: 40px; cursor: pointer;"><i class="fa fa-exclamation-triangle"></i></button>
                    <span class="legend-edit-indicator" style="position: absolute; bottom: -2px; right: -2px; background: #93C54B; border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center;">
                        <i class="fa fa-pencil" style="font-size: 8px; color: white;"></i>
                    </span>
                </div>
                <input type="text" class="form-control legend-label-input" value="@(Model?.CmsLanguage.GetValue(LanguageKeys.Skills.ValueAlmostExpired, "Almost expired") ?? "Almost expired")" style="flex: 1;" />
            </div>

            <!-- Expired -->
            <div class="legend-item-row d-flex align-items-center mb-2" data-skill-type="mandatory" data-skill-level-id="3">
                <div class="legend-icon-preview mr-3" style="position: relative;">
                    <button class="btn circlebtn btn-red legend-preview-btn" type="button" data-icon-class="warning" style="width: 40px; height: 40px; cursor: pointer;"><i class="fa fa-exclamation-triangle"></i></button>
                    <span class="legend-edit-indicator" style="position: absolute; bottom: -2px; right: -2px; background: #93C54B; border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center;">
                        <i class="fa fa-pencil" style="font-size: 8px; color: white;"></i>
                    </span>
                </div>
                <input type="text" class="form-control legend-label-input" value="@(Model?.CmsLanguage.GetValue(LanguageKeys.Skills.ValueExpired, "Expired") ?? "Expired")" style="flex: 1;" />
            </div>
        </div>

        <!-- Operational Skills Section -->
        <div class="mb-3">
            <h6 class="text-muted mb-3">@(Model?.CmsLanguage.GetValue(LanguageKeys.Setting.OperationalSkillsTitle, "Operational skills") ?? "Operational skills")</h6>

            <!-- Score 1 - Doesn't know the theory -->
            <div class="legend-item-row d-flex align-items-center mb-2" data-skill-type="operational" data-skill-level-id="1" data-score-value="1">
                <div class="legend-icon-preview mr-3" style="position: relative;">
                    <button class="btn circlebtn btn-red legend-preview-btn legend-score-btn" type="button" style="width: 40px; height: 40px; font-size: 18px; cursor: pointer;">1</button>
                    <span class="legend-edit-indicator" style="position: absolute; bottom: -2px; right: -2px; background: #93C54B; border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center;">
                        <i class="fa fa-pencil" style="font-size: 8px; color: white;"></i>
                    </span>
                </div>
                <input type="text" class="form-control legend-label-input" value="@(Model?.CmsLanguage.GetValue(LanguageKeys.Skills.ValueNoKnowTheTheory, "Doesn't know the theory") ?? "Doesn't know the theory")" style="flex: 1;" />
            </div>

            <!-- Score 2 - Knows the theory -->
            <div class="legend-item-row d-flex align-items-center mb-2" data-skill-type="operational" data-skill-level-id="2" data-score-value="2">
                <div class="legend-icon-preview mr-3" style="position: relative;">
                    <button class="btn circlebtn btn-orangered legend-preview-btn legend-score-btn" type="button" style="width: 40px; height: 40px; font-size: 18px; cursor: pointer;">2</button>
                    <span class="legend-edit-indicator" style="position: absolute; bottom: -2px; right: -2px; background: #93C54B; border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center;">
                        <i class="fa fa-pencil" style="font-size: 8px; color: white;"></i>
                    </span>
                </div>
                <input type="text" class="form-control legend-label-input" value="@(Model?.CmsLanguage.GetValue(LanguageKeys.Skills.ValueKnowTheTheory, "Knows the theory") ?? "Knows the theory")" style="flex: 1;" />
            </div>

            <!-- Score 3 - Standard situations -->
            <div class="legend-item-row d-flex align-items-center mb-2" data-skill-type="operational" data-skill-level-id="3" data-score-value="3">
                <div class="legend-icon-preview mr-3" style="position: relative;">
                    <button class="btn circlebtn btn-orange legend-preview-btn legend-score-btn" type="button" style="width: 40px; height: 40px; font-size: 18px; cursor: pointer;">3</button>
                    <span class="legend-edit-indicator" style="position: absolute; bottom: -2px; right: -2px; background: #93C54B; border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center;">
                        <i class="fa fa-pencil" style="font-size: 8px; color: white;"></i>
                    </span>
                </div>
                <input type="text" class="form-control legend-label-input" value="@(Model?.CmsLanguage.GetValue(LanguageKeys.Skills.ValueStandardSituations, "Is able to apply this in the standard situations") ?? "Is able to apply this in the standard situations")" style="flex: 1;" />
            </div>

            <!-- Score 4 - Non-standard conditions -->
            <div class="legend-item-row d-flex align-items-center mb-2" data-skill-type="operational" data-skill-level-id="4" data-score-value="4">
                <div class="legend-icon-preview mr-3" style="position: relative;">
                    <button class="btn circlebtn btn-orangegreen legend-preview-btn legend-score-btn" type="button" style="width: 40px; height: 40px; font-size: 18px; cursor: pointer;">4</button>
                    <span class="legend-edit-indicator" style="position: absolute; bottom: -2px; right: -2px; background: #93C54B; border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center;">
                        <i class="fa fa-pencil" style="font-size: 8px; color: white;"></i>
                    </span>
                </div>
                <input type="text" class="form-control legend-label-input" value="@(Model?.CmsLanguage.GetValue(LanguageKeys.Skills.ValueNonStandardConditions, "Is able to apply this in the non-standard conditions") ?? "Is able to apply this in the non-standard conditions")" style="flex: 1;" />
            </div>

            <!-- Score 5 - Can educate others -->
            <div class="legend-item-row d-flex align-items-center mb-2" data-skill-type="operational" data-skill-level-id="5" data-score-value="5">
                <div class="legend-icon-preview mr-3" style="position: relative;">
                    <button class="btn circlebtn btn-green legend-preview-btn legend-score-btn" type="button" style="width: 40px; height: 40px; font-size: 18px; cursor: pointer;">5</button>
                    <span class="legend-edit-indicator" style="position: absolute; bottom: -2px; right: -2px; background: #93C54B; border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center;">
                        <i class="fa fa-pencil" style="font-size: 8px; color: white;"></i>
                    </span>
                </div>
                <input type="text" class="form-control legend-label-input" value="@(Model?.CmsLanguage.GetValue(LanguageKeys.Skills.ValueCanEducateOthers, "Can educate others") ?? "Can educate others")" style="flex: 1;" />
            </div>
        </div>
    </div>
</div>

<!-- Color Picker Modal -->
<div class="modal fade" id="LegendColorPickerModal" tabindex="-1" role="dialog" aria-labelledby="LegendColorPickerModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="LegendColorPickerModalTitle">
                    @(Model?.CmsLanguage.GetValue(LanguageKeys.Setting.CustomizeLegendItemTitle, "Customize skill level text and color codes for") ?? "Customize skill level text and color codes for")
                    <strong id="legendItemTitle"></strong>
                </h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Level Text Input -->
                <div class="form-group mb-4">
                    <label for="legendLevelText">@(Model?.CmsLanguage.GetValue(LanguageKeys.Setting.LevelTextLabel, "Level text") ?? "Level text")</label>
                    <input type="text" class="form-control" id="legendLevelText" placeholder="Enter skill level text" />
                </div>

                <div class="row">
                    <!-- Color of the number/icon -->
                    <div class="col-md-6">
                        <label>@(Model?.CmsLanguage.GetValue(LanguageKeys.Setting.ColorOfNumberLabel, "Color of the number") ?? "Color of the number")</label>
                        <div class="color-picker-container mb-3">
                            <div class="color-picker-gradient" id="iconColorPicker" style="width: 100%; height: 200px; border-radius: 8px; cursor: crosshair; position: relative; background: linear-gradient(to bottom, white, transparent), linear-gradient(to right, transparent, var(--picker-hue, #ff0000)); background-color: var(--picker-hue, #ff0000);">
                                <div class="color-picker-handle" id="iconColorHandle" style="position: absolute; width: 20px; height: 20px; border: 3px solid white; border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 3px rgba(0,0,0,0.5); pointer-events: none;"></div>
                            </div>
                            <input type="range" class="form-range mt-2 color-hue-slider" id="iconHueSlider" min="0" max="360" value="120" style="width: 100%; background: linear-gradient(to right, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000); height: 12px; border-radius: 6px; -webkit-appearance: none; appearance: none;">
                        </div>
                        <div class="row mt-2">
                            <div class="col-4">
                                <label class="small text-muted">Hex</label>
                                <input type="text" class="form-control form-control-sm" id="iconColorHex" value="#52AC52" style="border-color: #93C54B;" />
                            </div>
                            <div class="col-2">
                                <label class="small text-muted">R</label>
                                <input type="number" class="form-control form-control-sm" id="iconColorR" value="82" min="0" max="255" />
                            </div>
                            <div class="col-2">
                                <label class="small text-muted">G</label>
                                <input type="number" class="form-control form-control-sm" id="iconColorG" value="172" min="0" max="255" />
                            </div>
                            <div class="col-2">
                                <label class="small text-muted">B</label>
                                <input type="number" class="form-control form-control-sm" id="iconColorB" value="82" min="0" max="255" />
                            </div>
                        </div>
                    </div>

                    <!-- Color of the background -->
                    <div class="col-md-6">
                        <label>@(Model?.CmsLanguage.GetValue(LanguageKeys.Setting.ColorOfBackgroundLabel, "Color of the background") ?? "Color of the background")</label>
                        <div class="color-picker-container mb-3">
                            <div class="color-picker-gradient" id="bgColorPicker" style="width: 100%; height: 200px; border-radius: 8px; cursor: crosshair; position: relative; background: linear-gradient(to bottom, white, transparent), linear-gradient(to right, transparent, var(--picker-hue, #ff0000)); background-color: var(--picker-hue, #ff0000);">
                                <div class="color-picker-handle" id="bgColorHandle" style="position: absolute; width: 20px; height: 20px; border: 3px solid white; border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 3px rgba(0,0,0,0.5); pointer-events: none;"></div>
                            </div>
                            <input type="range" class="form-range mt-2 color-hue-slider" id="bgHueSlider" min="0" max="360" value="120" style="width: 100%; background: linear-gradient(to right, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000); height: 12px; border-radius: 6px; -webkit-appearance: none; appearance: none;">
                        </div>
                        <div class="row mt-2">
                            <div class="col-4">
                                <label class="small text-muted">Hex</label>
                                <input type="text" class="form-control form-control-sm" id="bgColorHex" value="#E5F3E5" style="border-color: #93C54B;" />
                            </div>
                            <div class="col-2">
                                <label class="small text-muted">R</label>
                                <input type="number" class="form-control form-control-sm" id="bgColorR" value="229" min="0" max="255" />
                            </div>
                            <div class="col-2">
                                <label class="small text-muted">G</label>
                                <input type="number" class="form-control form-control-sm" id="bgColorG" value="243" min="0" max="255" />
                            </div>
                            <div class="col-2">
                                <label class="small text-muted">B</label>
                                <input type="number" class="form-control form-control-sm" id="bgColorB" value="229" min="0" max="255" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Live Preview -->
                <div class="mt-4 text-center">
                    <div class="legend-preview-circle" id="colorPreviewCircle" style="width: 60px; height: 60px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; border: 2px solid; margin: 0 auto;">
                        <span id="previewContent">4</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
                    @(Model?.CmsLanguage.GetValue(LanguageKeys.Shared.BtnClose, "Close") ?? "Close")
                </button>
                <button type="button" class="btn btn-ezgo btn-sm" id="btnConfirmLegendColor">
                    @(Model?.CmsLanguage.GetValue(LanguageKeys.Shared.BtnConfirm, "Confirm") ?? "Confirm")
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        // Debounce timer
        let debounceTimer;
        let currentEditingItem = null;
        let legendConfiguration = null;

        // Load legend configuration on page load
        loadLegendConfiguration();

        // Event handler for label clicks (rounding options)
        $('.btn-group-toggle').off('click', 'label').on('click', 'label', function (e) {
            e.preventDefault();
            e.stopPropagation();

            clearTimeout(debounceTimer);

            debounceTimer = setTimeout(() => {
                $('.btn-group-toggle label').removeClass('active');
                $(this).addClass('active');

                let settingValue;

                if ($(this).attr('id') === 'RoundDown_label') {
                    settingValue = false;
                    $('#RoundDown').prop('checked', false);
                    $('#donotRoundDown').prop('checked', true);
                } else if ($(this).attr('id') === 'do_not_RoundDown_label') {
                    settingValue = true;
                    $('#RoundDown').prop('checked', true);
                    $('#donotRoundDown').prop('checked', false);
                }

                updateWorkInstructionChangesStatus(settingValue);
            }, 300);
        });

        // Initialize Work Instructions state properly
        initializeWorkInstructions();

        function initializeWorkInstructions() {
            $('#RoundDown_label').removeClass('active');
            $('#do_not_RoundDown_label').removeClass('active');

            if ($('#RoundDown').is(':checked')) {
                $('#RoundDown_label').addClass('active');
            } else if ($('#donotRoundDown').is(':checked')) {
                $('#do_not_RoundDown_label').addClass('active');
            }
        }

        function updateWorkInstructionChangesStatus(settingValue) {
            $.ajax({
                url: '/CompanySettings/UpdateSkillMatrixChangeScoreStyle',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(settingValue),
                success: function (response) {
                    toastr.success('@(Model?.CmsLanguage.GetValue(LanguageKeys.CompanySetting.NotifyEndUserSkillMatrixChangeDoneCorrectly, "Skill matrix setting updated correctly") ?? "Skill matrix setting updated correctly")');
                },
                error: function (xhr, status, error) { }
            });
        }

        // Load legend configuration from API
        function loadLegendConfiguration() {
            $.ajax({
                url: '/companysettings/legend',
                type: 'GET',
                success: function (response) {
                    legendConfiguration = response;
                    applyLegendConfiguration(response);
                },
                error: function (xhr, status, error) {
                    console.error('Failed to load legend configuration:', error);
                    // Use defaults on error
                    legendConfiguration = getDefaultLegendConfiguration();
                }
            });
        }

        // Apply legend configuration to UI
        function applyLegendConfiguration(config) {
            if (!config) return;

            // Icon class mapping from config iconClass to Font Awesome class
            var iconClassMapping = {
                'thumbsup': 'fa-thumbs-up',
                'thumbsdown': 'fa-thumbs-down',
                'warning': 'fa-exclamation-triangle'
            };

            // Apply mandatory skills
            if (config.mandatorySkills) {
                config.mandatorySkills.forEach(function (item) {
                    var row = $('.legend-item-row[data-skill-type="mandatory"][data-skill-level-id="' + item.skillLevelId + '"]');
                    if (row.length) {
                        row.find('.legend-label-input').val(item.label);
                        var btn = row.find('.legend-preview-btn');
                        btn.css({
                            'background-color': item.backgroundColor,
                            'border-color': item.iconColor,
                            'color': item.iconColor
                        });
                        // Update icon if iconClass is specified
                        if (item.iconClass) {
                            var faClass = iconClassMapping[item.iconClass] || 'fa-' + item.iconClass;
                            var icon = btn.find('i');
                            if (icon.length) {
                                icon.removeClass('fa-thumbs-up fa-thumbs-down fa-exclamation-triangle');
                                icon.addClass(faClass);
                            }
                            btn.attr('data-icon-class', item.iconClass);
                        }
                    }
                });
            }

            // Apply operational skills
            if (config.operationalSkills) {
                config.operationalSkills.forEach(function (item) {
                    var row = $('.legend-item-row[data-skill-type="operational"][data-skill-level-id="' + item.skillLevelId + '"]');
                    if (row.length) {
                        row.find('.legend-label-input').val(item.label);
                        var btn = row.find('.legend-preview-btn');
                        btn.css({
                            'background-color': item.backgroundColor,
                            'border-color': item.iconColor,
                            'color': item.iconColor
                        });
                    }
                });
            }
        }

        // Get default legend configuration
        function getDefaultLegendConfiguration() {
            return {
                mandatorySkills: [
                    { skillLevelId: 1, label: 'Masters the skill', iconColor: '#008000', backgroundColor: '#DDF7DD', iconClass: 'thumbsup' },
                    { skillLevelId: 2, label: 'Almost expired', iconColor: '#FFA500', backgroundColor: '#FFF0D4', iconClass: 'warning' },
                    { skillLevelId: 3, label: 'Expired', iconColor: '#CB0000', backgroundColor: '#FFEAEA', iconClass: 'thumbsdown' }
                ],
                operationalSkills: [
                    { skillLevelId: 1, label: "Doesn't know the theory", iconColor: '#CB0000', backgroundColor: '#FFEAEA', scoreValue: 1 },
                    { skillLevelId: 2, label: 'Knows the theory', iconColor: '#FF4500', backgroundColor: '#FFE4DA', scoreValue: 2 },
                    { skillLevelId: 3, label: 'Is able to apply this in the standard situations', iconColor: '#FFA500', backgroundColor: '#FFF0D4', scoreValue: 3 },
                    { skillLevelId: 4, label: 'Is able to apply this in the non-standard conditions', iconColor: '#8DA304', backgroundColor: '#F2F5DD', scoreValue: 4 },
                    { skillLevelId: 5, label: 'Can educate others', iconColor: '#008000', backgroundColor: '#DDF7DD', scoreValue: 5 }
                ]
            };
        }

        // Legend item click handler - open color picker modal
        $('.legend-preview-btn').on('click', function () {
            var row = $(this).closest('.legend-item-row');
            var skillType = row.data('skill-type');
            var skillLevelId = row.data('skill-level-id');
            var scoreValue = row.data('score-value');
            var iconClass = $(this).data('icon-class');
            var currentLabel = row.find('.legend-label-input').val();

            currentEditingItem = {
                row: row,
                skillType: skillType,
                skillLevelId: skillLevelId,
                scoreValue: scoreValue,
                iconClass: iconClass
            };

            // Find current configuration
            var currentItem = null;
            if (legendConfiguration) {
                var skillList = skillType === 'mandatory' ? legendConfiguration.mandatorySkills : legendConfiguration.operationalSkills;
                if (skillList) {
                    currentItem = skillList.find(function (item) { return item.skillLevelId === skillLevelId; });
                }
            }

            // Set modal title
            var titleText = skillType === 'operational' ? 'Score ' + scoreValue + ' operational skills' : currentLabel;
            $('#legendItemTitle').text(titleText);

            // Set current values
            $('#legendLevelText').val(currentLabel);

            if (currentItem) {
                setColorPickerValue('icon', currentItem.iconColor);
                setColorPickerValue('bg', currentItem.backgroundColor);
            }

            // Update preview
            updateColorPreview();

            // Show preview content based on skill type and icon
            if (skillType === 'operational' && scoreValue) {
                $('#previewContent').text(scoreValue);
            } else if (iconClass === 'thumbsup') {
                $('#previewContent').html('<i class="fa fa-thumbs-up"></i>');
            } else if (iconClass === 'warning') {
                $('#previewContent').html('<i class="fa fa-exclamation-triangle"></i>');
            } else {
                $('#previewContent').html('<i class="fa fa-thumbs-up"></i>');
            }

            $('#LegendColorPickerModal').modal('show');
        });

        // Confirm button handler
        $('#btnConfirmLegendColor').on('click', function () {
            if (!currentEditingItem) return;

            var newLabel = $('#legendLevelText').val();
            var newIconColor = $('#iconColorHex').val();
            var newBgColor = $('#bgColorHex').val();

            // Update UI
            var row = currentEditingItem.row;
            row.find('.legend-label-input').val(newLabel);
            var btn = row.find('.legend-preview-btn');
            btn.css({
                'background-color': newBgColor,
                'border-color': newIconColor,
                'color': newIconColor
            });
            // Also update the icon color inside the button
            btn.find('i').css('color', newIconColor);

            // Update configuration
            if (legendConfiguration) {
                var skillList = currentEditingItem.skillType === 'mandatory' ? legendConfiguration.mandatorySkills : legendConfiguration.operationalSkills;
                if (skillList) {
                    var item = skillList.find(function (item) { return item.skillLevelId === currentEditingItem.skillLevelId; });
                    if (item) {
                        item.label = newLabel;
                        item.iconColor = newIconColor;
                        item.backgroundColor = newBgColor;
                    }
                }
            }

            // Save to server
            saveLegendConfiguration();

            $('#LegendColorPickerModal').modal('hide');
        });

        // Save legend configuration
        function saveLegendConfiguration() {
            if (!legendConfiguration) return;

            $.ajax({
                url: '/companysettings/legend',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(legendConfiguration),
                success: function (response) {
                    toastr.success('@(Model?.CmsLanguage.GetValue(LanguageKeys.CompanySetting.LegendUpdatedSuccessfully, "Legend configuration updated successfully") ?? "Legend configuration updated successfully")');
                },
                error: function (xhr, status, error) {
                    console.error('Failed to save legend configuration:', error);
                    toastr.error('@(Model?.CmsLanguage.GetValue(LanguageKeys.CompanySetting.LegendUpdateFailed, "Failed to update legend configuration") ?? "Failed to update legend configuration")');
                }
            });
        }

        // Label input change handler - debounced save
        $('.legend-label-input').on('change', function () {
            var row = $(this).closest('.legend-item-row');
            var skillType = row.data('skill-type');
            var skillLevelId = row.data('skill-level-id');
            var newLabel = $(this).val();

            if (legendConfiguration) {
                var skillList = skillType === 'mandatory' ? legendConfiguration.mandatorySkills : legendConfiguration.operationalSkills;
                if (skillList) {
                    var item = skillList.find(function (item) { return item.skillLevelId === skillLevelId; });
                    if (item) {
                        item.label = newLabel;
                    }
                }
            }

            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(function () {
                saveLegendConfiguration();
            }, 500);
        });

        // Color picker functionality
        function setColorPickerValue(prefix, hexColor) {
            if (!hexColor || hexColor.length !== 7) return;

            var r = parseInt(hexColor.substr(1, 2), 16);
            var g = parseInt(hexColor.substr(3, 2), 16);
            var b = parseInt(hexColor.substr(5, 2), 16);

            $('#' + prefix + 'ColorHex').val(hexColor.toUpperCase());
            $('#' + prefix + 'ColorR').val(r);
            $('#' + prefix + 'ColorG').val(g);
            $('#' + prefix + 'ColorB').val(b);

            // Update hue slider based on color
            var hsv = rgbToHsv(r, g, b);
            $('#' + prefix + 'HueSlider').val(hsv.h);

            updatePickerGradient(prefix, hsv.h);
            updatePickerHandle(prefix, hsv.s, hsv.v);
        }

        function updateColorPreview() {
            var iconColor = $('#iconColorHex').val();
            var bgColor = $('#bgColorHex').val();
            $('#colorPreviewCircle').css({
                'background-color': bgColor,
                'border-color': iconColor,
                'color': iconColor
            });
        }

        function updatePickerGradient(prefix, hue) {
            var hueColor = hsvToRgb(hue, 1, 1);
            var hexColor = rgbToHex(hueColor.r, hueColor.g, hueColor.b);
            $('#' + prefix + 'ColorPicker').css('--picker-hue', hexColor);
        }

        function updatePickerHandle(prefix, s, v) {
            var x = s * 100;
            var y = (1 - v) * 100;
            $('#' + prefix + 'ColorHandle').css({
                'left': x + '%',
                'top': y + '%'
            });
        }

        // Hue slider change
        $('.color-hue-slider').on('input', function () {
            var prefix = $(this).attr('id').replace('HueSlider', '').toLowerCase();
            var hue = parseInt($(this).val());
            updatePickerGradient(prefix, hue);

            // Recalculate color
            var s = parseFloat($('#' + prefix + 'ColorHandle').css('left')) / $('#' + prefix + 'ColorPicker').width();
            var v = 1 - (parseFloat($('#' + prefix + 'ColorHandle').css('top')) / $('#' + prefix + 'ColorPicker').height());
            s = Math.max(0, Math.min(1, s || 0.5));
            v = Math.max(0, Math.min(1, v || 0.5));

            var rgb = hsvToRgb(hue, s, v);
            updateColorInputs(prefix, rgb.r, rgb.g, rgb.b);
            updateColorPreview();
        });

        // Color picker click/drag
        $('.color-picker-gradient').on('mousedown', function (e) {
            var picker = $(this);
            var prefix = picker.attr('id').replace('ColorPicker', '').toLowerCase();

            function updateFromMouse(e) {
                var rect = picker[0].getBoundingClientRect();
                var x = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
                var y = Math.max(0, Math.min(1, (e.clientY - rect.top) / rect.height));

                $('#' + prefix + 'ColorHandle').css({
                    'left': (x * 100) + '%',
                    'top': (y * 100) + '%'
                });

                var hue = parseInt($('#' + prefix + 'HueSlider').val());
                var rgb = hsvToRgb(hue, x, 1 - y);
                updateColorInputs(prefix, rgb.r, rgb.g, rgb.b);
                updateColorPreview();
            }

            updateFromMouse(e);

            $(document).on('mousemove.colorpicker', updateFromMouse);
            $(document).on('mouseup.colorpicker', function () {
                $(document).off('.colorpicker');
            });
        });

        // RGB input change
        $('#iconColorR, #iconColorG, #iconColorB, #bgColorR, #bgColorG, #bgColorB').on('input', function () {
            var id = $(this).attr('id');
            var prefix = id.includes('icon') ? 'icon' : 'bg';
            var r = parseInt($('#' + prefix + 'ColorR').val()) || 0;
            var g = parseInt($('#' + prefix + 'ColorG').val()) || 0;
            var b = parseInt($('#' + prefix + 'ColorB').val()) || 0;
            updateColorInputs(prefix, r, g, b);
            updateColorPreview();
        });

        // Hex input change
        $('#iconColorHex, #bgColorHex').on('input', function () {
            var hex = $(this).val();
            if (hex.length === 7 && hex.charAt(0) === '#') {
                var prefix = $(this).attr('id').includes('icon') ? 'icon' : 'bg';
                setColorPickerValue(prefix, hex);
                updateColorPreview();
            }
        });

        function updateColorInputs(prefix, r, g, b) {
            r = Math.max(0, Math.min(255, r));
            g = Math.max(0, Math.min(255, g));
            b = Math.max(0, Math.min(255, b));

            $('#' + prefix + 'ColorR').val(r);
            $('#' + prefix + 'ColorG').val(g);
            $('#' + prefix + 'ColorB').val(b);
            $('#' + prefix + 'ColorHex').val(rgbToHex(r, g, b));
        }

        // Color conversion utilities
        function rgbToHex(r, g, b) {
            return '#' + [r, g, b].map(function (x) {
                var hex = x.toString(16);
                return hex.length === 1 ? '0' + hex : hex;
            }).join('').toUpperCase();
        }

        function rgbToHsv(r, g, b) {
            r /= 255; g /= 255; b /= 255;
            var max = Math.max(r, g, b), min = Math.min(r, g, b);
            var h, s, v = max;
            var d = max - min;
            s = max === 0 ? 0 : d / max;
            if (max === min) {
                h = 0;
            } else {
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            return { h: h * 360, s: s, v: v };
        }

        function hsvToRgb(h, s, v) {
            var r, g, b;
            h = h / 360;
            var i = Math.floor(h * 6);
            var f = h * 6 - i;
            var p = v * (1 - s);
            var q = v * (1 - f * s);
            var t = v * (1 - (1 - f) * s);
            switch (i % 6) {
                case 0: r = v; g = t; b = p; break;
                case 1: r = q; g = v; b = p; break;
                case 2: r = p; g = v; b = t; break;
                case 3: r = p; g = q; b = v; break;
                case 4: r = t; g = p; b = v; break;
                case 5: r = v; g = p; b = q; break;
            }
            return {
                r: Math.round(r * 255),
                g: Math.round(g * 255),
                b: Math.round(b * 255)
            };
        }
    });
</script>

<style>
    /* Circle button styles */
    .circlebtn {
        width: 48px;
        height: 48px;
        border-radius: 50% !important;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid rgb(210,210,210);
        font-size: 22px !important;
        outline: 0 !important;
    }

    .circlebtn i {
        font-size: 18px;
    }

    .legend-item-row {
        padding: 8px 12px;
        background-color: white;
        border-radius: 8px;
        margin-bottom: 8px;
        transition: box-shadow 0.2s;
    }

    .legend-item-row:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .legend-label-input {
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        padding: 8px 12px;
    }

    .legend-label-input:focus {
        border-color: #93C54B;
        box-shadow: 0 0 0 2px rgba(147, 197, 75, 0.2);
    }

    .legend-preview-btn {
        transition: transform 0.2s;
    }

    .legend-preview-btn:hover {
        transform: scale(1.1);
    }

    .color-hue-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: white;
        cursor: pointer;
        border: 2px solid #93C54B;
        box-shadow: 0 0 3px rgba(0, 0, 0, 0.3);
    }

    .color-hue-slider::-moz-range-thumb {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: white;
        cursor: pointer;
        border: 2px solid #93C54B;
        box-shadow: 0 0 3px rgba(0, 0, 0, 0.3);
    }

    .color-picker-gradient::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(to bottom, transparent, black);
        border-radius: 8px;
        pointer-events: none;
    }
</style>
