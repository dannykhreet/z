@model WebApp.ViewModels.ActionViewModel

@{
    Dictionary<string, string> CmsLanguage = Model?.CmsLanguage;
    Layout = "_Layout_template";
    ViewData["Title"] = CmsLanguage?.GetValue(LanguageKeys.Action.OverViewTitle, "Action overview") ?? "Action overview";
    int? taskId = Model?.TaskId > 0 ? Model?.TaskId : new Nullable<int>();
}

@section CSS{
    <style>
        .text-danger {
            color: #dc3545 !important;
        }

        #contentBody .card.results {
            transition: transform .2s; /* Animation */
        }

            #contentBody .card.isaction {
                border-bottom: solid 2px #a8a8a8;
            }

            #contentBody .card.isresolved {
                border-bottom: solid 2px #93c54b;
                color: #93c54b !important;
            }

            #contentBody .card.isoverdue {
                border-bottom: solid 2px #dc3545;
                color: #dc3545 !important;
            }

            #contentBody .card.results:hover {
                border-top: solid 1px #93c54b;
                border-left: solid 1px #93c54b;
                border-right: solid 1px #93c54b;
                box-shadow: 0 .425rem .75rem rgba(0,0,0,.075) !important;
                color: #93c54b !important;
            }

            #contentBody .card.results a:hover {
                color: #808080 !important;
            }

        #contentBody img.img-fluid {
            border-radius: 5px;
            border: solid 1px #bfbfbf;
        }

        .imgcontainer {
            border-radius: 0.25em;
            overflow: hidden;
            width: 100%;
            height: 100%;
            position: relative; /* If you want text inside of it */
        }

        #contentBody .imgcontainer > img {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            object-fit: cover;
            height: 100%;
            width: 100%;
        }

        .fa-stack {
            font-size: 1.0em;
            color: #bfbfbf;
        }

        .fa stack i {
            vertical-align: middle;
        }

        div.dropdown-menu.show {
            transform: none !important;
            top: auto !important;
        }
    </style>
}

<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-0">
            @if(Model?.UseTaskIdFiltering == true)
            {
                @if (Model?.GoBack == true)
                {
                    <div class="col-sm-6">
                        <a id="goBackToCompletedItems" href="/report/task/completed"><i class="fa fa-arrow-left"></i> <div id="goBackToCompletedItemsDescription" style="display: inline-block">Back to completed items</div></a>
                        &nbsp;
                        <h1 id="overviewHeaderTitle">@(CmsLanguage?.GetValue(LanguageKeys.Action.OverViewTitle, "Action overview") ?? "Action overview")</h1>
                    </div>
                }
                else
                {
                    
                    <div class="col-sm-6">
                        <h1 id="overviewHeaderTitle">@(CmsLanguage?.GetValue(LanguageKeys.Action.OverViewTitle, "Action overview") ?? "Action overview")</h1>
                    </div>
                }
            }
            else {
                <div class="col-sm-3">
                    &nbsp;
                    <h1 id="overviewHeaderTitle">@(CmsLanguage?.GetValue(LanguageKeys.Action.OverViewTitle, "Action overview") ?? "Action overview")</h1>
                </div>
                <div class="col-sm-3 align-self-end">
                    @if (Model?.GoBack == true)
                    {
                        <a id="goBackToCompletedItems" href="#" onclick="goBack()"><i class="fa fa-arrow-left"></i> Back to completed items</a>
                    }
                </div>
            }
            <div class="col-sm-6 d-flex flex-row-reverse">
                @if (Model?.ApplicationSettings?.Features?.ActionOnTheSportEnabled == true && !taskId.HasValue)
                {
                    <a asp-controller="action" asp-action="new" class="btn btn-ezgo btn-sm mr-2 shadow-sm mt-auto">@(CmsLanguage?.GetValue(LanguageKeys.Action.AddActionButton, "Add action") ?? "Add action")</a>
                }

                @if (Model?.ApplicationSettings?.Features?.ExportAdvancedEnabled == true || Model?.ApplicationSettings?.Features?.ExportEnabled == true)
                {
                    <button class="btn btn-secondary btn-sm btn-outline mr-2 shadow-sm mt-auto" data-export="actions" title="@(Model?.CmsLanguage?.GetValue(LanguageKeys.Action.ExportActionsTitle, "Export actions") ?? "Export actions")"><i class="fa fa-file-excel"></i></button>
                }
                @if (Model?.ApplicationSettings?.Features?.ExportAdvancedEnabled == true || Model?.ApplicationSettings?.Features?.ExportEnabled == true)
                {
                    <button class="btn btn-secondary btn-sm btn-outline mr-2 shadow-sm mt-auto" data-export="comments" title="@(Model?.CmsLanguage?.GetValue(LanguageKeys.Action.ExportCommentsTitle, "Export comments") ?? "Export comments")"><i class="fa fa-file-excel"></i></button>
                }
            </div>        
        </div>
    </div><!-- /.container-fluid -->
</section>

<section class="content">
    <div class="container-fluid">
        <div class="row pt-1" style="height:calc(100vh - 165px);">
            <div id="actionFiltersBlock" class="col-xl-3 d-none d-xl-inline-block" style="padding-right: 15px">
                <div class="card card-filter h-100">
                    <div class="card-header pb-0 d-flex" style="border-bottom: none;width:100%">
                        <h3 class="card-title d-flex" style="width:100%">@(CmsLanguage?.GetValue(LanguageKeys.Filters.CardTitle, "Filters") ?? "Filters")</h3>

                        <div class="card-tools">
                            <div class="input-group input-group-sm">
                                <div class="input-group-append">
                                    <button type="button" class="btn" onclick="reset3DFilters()" title="@(Model?.CmsLanguage.GetValue(LanguageKeys.Filters.ResetHover, "Reset filters") ?? "Reset filters")"><i class="fas fa-undo"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card-body pt-0">
                        <partial name="_filters_block" model="Model.Filter" />
                    </div>
                </div>
            </div>

            <div class="col-lg-12 col-xl-9" style="padding-left: 7.5px">
                <div class="card template-searchbar" style="margin-left: 0px">
                    <div class="card-header d-flex" style="margin-left:-11px; height: 55px">
                        <div style="display: flex; height: 100%; width: 100%; align-items: center">
                            <h3 class="card-title d-none d-sm-inline-block" style="width:100%">

                                <span id="counterLabel">@(CmsLanguage?.GetValue(LanguageKeys.Action.ListTitle, "Actions") ?? "Actions")</span>(<span id="totalCounter">total</span>)
                            </h3>
                        </div>

                        <div class="actionFilterInlineWrapper d-xl-none" style="width: 100%;text-align: right; padding-right: 10px">
                            <div class="collapseFilter collapse">
                                <button class="btn btn-secondary btn-sm btn-outline mr-2 shadow-sm mt-auto" style="width: 80px" onclick="showInlineTagFilterModal()">Filter tags</button>
                            </div>
                        </div>
                        <div class="actionFilterInlineWrapper" style="width: auto; text-align: right">
                            <div class="card-tools" style="width: 236px; display: inline-block">
                                <div class="input-group input-group-sm">
                                    <input type="text" placeholder="@(CmsLanguage?.GetValue(LanguageKeys.Action.Search, "Search") ?? "Search")" class="form-control float-right" id="actionSearchBox" data-boxtype="search">

                                    <div class="input-group-append">
                                        <button type="submit" class="btn btn-default"><i class="fas fa-search"></i></button>
                                        <button type="button" class="btn btn-default d-block d-xl-none" data-bs-toggle="collapse" data-bs-target=".collapseFilter"><i class="fas fa-filter"></i></button>
                                        <button type="button" class="btn btn-default d-xl-none" onclick="reset3DFilters()" title="@(Model?.CmsLanguage?.GetValue(LanguageKeys.Filters.ResetHover, "Reset filters") ?? "Reset filters")" data-action="resetfilters"><i class="fas fa-undo"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="actionFilterInlineWrapper d-xl-none" style="padding-left: 5px; padding-right: 5px">
                        <div class="card-header collapse collapseFilter">
                            <partial name="_filters_inline" model="Model.Filter" />
                        </div>
                    </div>
                </div>

                <div id="contentBody" class="pr-3" style="height: calc(100vh - 252px);overflow:auto; padding-left: 0px">
                    
                    <div class="row no-gutters" id="contentCol">
                        <partial name="_overview" model="@Model" />
                    </div>
                    <div style="display: flex; align-items: center; justify-content: center">
                        <img id="actionOverviewLoader" style="width: 100px; height: 100px" src="/images/feed-loading.gif" />
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Modal tags filter -->
<div class="modal fade" id="modalTagsFilter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="exampleModalLongTitle">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Tags.TagsTagsFiltering, "Tags filtering") ?? "Tags filtering")</h4>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body" style="display: flex; justify-content: center">
                <div id="tagsModalBody" style="overflow-x: scroll">
                    <div class="col-12 p-0 pb-3" data-item="steps-view">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Tags.TagsMainTitle, "Tags") ?? "Tags")</h3>
                            </div>
                            <div class="card-body px-3 pb-3 pt-0">
                                <partial name="_tags_filtering_block" model="Model.Filter" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="applyTagsFilterButton" type="button" class="btn btn-ezgo btn-sm">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Filters.ApplyButton, "Apply") ?? "Apply") </button>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal" data-action="close">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Checklist.BtnClose, "Close") ?? "Close")</button>
            </div>
        </div>
    </div>
</div>

<input asp-for="CurrentUser.Id" type="hidden" />

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    
    <script src="/js/ezgoUtils.js"></script>
    <script src="/js/3dfilter.js"></script>

    @if (Model?.ApplicationSettings?.Features?.AnalyticsEnabled == true)
    {
        <script src="~/js/analytics.js"></script>
        <script>ezgoAnalytics.init('action');</script>
    }

    @if (Model?.ApplicationSettings?.Features?.ExportAdvancedEnabled == true || Model?.ApplicationSettings?.Features?.ExportEnabled == true)
    {
        <script src="/js/export.js?@(DateTime.Now.ToString("ddMMyyyyHHmmss"))"></script>
        <partial name="~/Views/Shared/_export_language_settings.cshtml" model="@Model" />
    }
    <script src="/js/areafilter_v2.js"></script>

    <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
    <script>
        //show/hide go back button
        // if (history.length == 1) {
        //     $('#goBackToCompletedItems').hide();
        // }
            areaFilter_v2.init('/config/getareatree', '', true);
        var ezgoActionOverview = {
            actionFilters: {
                limit: 20,
                offset: 0,
                filterText: "", //also for comment
                tagids: [], //also for comment
                status: [],
                involvement: "",
                assignedUserIds: [],
                assignedAreaIds: [],
                createdFrom: null, //also for comment
                createdTo: null, //also for comment
                resolvedFrom: null,
                resolvedTo: null,
                overdueFrom: null,
                overdueTo: null,
                actionType: "action",
                hasUnviewedComments: null,
                parentAreaId: null,
                taskId: @(taskId == null ? "null" : taskId.ToString())
            },
            lastActionOverviewLocation: window.location.pathname + window.location.search,
            useTaskActions: @Model?.UseTaskIdFiltering.ToString().ToLower(),
            loadingMore: false,
            actionsLoaded: false,
            mostRecentRequest: null,
            mostRecentCountsRequest: null
        };

        //setup action filter defaults
        $(document).ready(function () {

            
            if (ezgoActionOverview.useTaskActions) {
                $('#actionFiltersBlock').removeClass('d-xl-inline-block');
                $('.actionFilterInlineWrapper').hide();
            }

            var filters = localStorage.getItem('actionfilters');
            if (filters !== null) {
                var filtersJson = JSON.parse(filters);
                if (filtersJson != null && Object.hasOwn(filtersJson, 'scrollYPosition')) {
                    //old filters active, clear localstorage and don't init from old filterobj
                    localStorage.setItem('actionfilters', JSON.stringify(ezgoActionOverview.actionFilters));
                }
                else {
                    ezgoActionOverview.actionFilters = filtersJson;

                    ezgoActionOverview.actionFilters.offset = 0;

                    //apply filters
                    $('#actionSearchBox').val(ezgoActionOverview.actionFilters.filterText);

                    if (ezgoActionOverview.actionFilters.createdFrom != "" && ezgoActionOverview.actionFilters.createdTo != "" && ezgoActionOverview.actionFilters.createdFrom != null && ezgoActionOverview.actionFilters.createdTo != null) {
                        $('#creationDateFilter').val(moment(ezgoActionOverview.actionFilters.createdFrom, "DD-MM-YYYY").format("DD MMM YYYY") + ' - ' + moment(ezgoActionOverview.actionFilters.createdTo, "DD-MM-YYYY").format("DD MMM YYYY"));
                        $('#creationDateFilterInline').val(moment(ezgoActionOverview.actionFilters.createdFrom, "DD-MM-YYYY").format("DD MMM YYYY") + ' - ' + moment(ezgoActionOverview.actionFilters.createdTo, "DD-MM-YYYY").format("DD MMM YYYY"));
                    }
                
                    if(ezgoActionOverview.actionFilters.resolvedFrom != "" && ezgoActionOverview.actionFilters.resolvedTo != "" && ezgoActionOverview.actionFilters.resolvedFrom != null && ezgoActionOverview.actionFilters.resolvedTo != null) {
                        $('#resolutionDateFilter').val(moment(ezgoActionOverview.actionFilters.resolvedFrom, "DD-MM-YYYY").format("DD MMM YYYY") + ' - ' + moment(ezgoActionOverview.actionFilters.resolvedTo, "DD-MM-YYYY").format("DD MMM YYYY"));
                        $('#resolutionDateFilterInline').val(moment(ezgoActionOverview.actionFilters.resolvedFrom, "DD-MM-YYYY").format("DD MMM YYYY") + ' - ' + moment(ezgoActionOverview.actionFilters.resolvedTo, "DD-MM-YYYY").format("DD MMM YYYY"));
                    }

                    if(ezgoActionOverview.actionFilters.overdueFrom != "" && ezgoActionOverview.actionFilters.overdueTo != "" && ezgoActionOverview.actionFilters.overdueFrom != null && ezgoActionOverview.actionFilters.overdueTo != null) {
                        $('#dueDateFilter').val(moment(ezgoActionOverview.actionFilters.overdueFrom, "DD-MM-YYYY").format("DD MMM YYYY") + ' - ' + moment(ezgoActionOverview.actionFilters.overdueTo, "DD-MM-YYYY").format("DD MMM YYYY"));
                        $('#dueDateFilterInline').val(moment(ezgoActionOverview.actionFilters.overdueFrom, "DD-MM-YYYY").format("DD MMM YYYY") + ' - ' + moment(ezgoActionOverview.actionFilters.overdueTo, "DD-MM-YYYY").format("DD MMM YYYY"));
                    }

                    if ($("#tagsfilter")[0] != null && ezgoActionOverview.actionFilters.tagids != null && ezgoActionOverview.actionFilters.tagids.length) {
                        $('[id^="filter-tag-"]').each(function (index, elem) {
                            if (ezgoActionOverview.actionFilters.tagids.includes(+$(elem).data('tag'))) {
                                $(elem).show();
                                toggleStyle(+$(elem).data('tag'));
                            }
                        });

                    }

                    if (ezgoActionOverview.actionFilters.actionType != undefined && ezgoActionOverview.actionFilters.actionType != '') { 
                        $('#actionTypeFilter').val(ezgoActionOverview.actionFilters.actionType);
                        $('#actionTypeFilter').trigger('change');
                        $('#actionTypeFilterInline').val(ezgoActionOverview.actionFilters.actionType);
                        $('#actionTypeFilterInline').trigger('change');
                    }

                    //add involvement filter
                    if (ezgoActionOverview.actionFilters.involvement != "") {
                        $('#involvementFilter').val(ezgoActionOverview.actionFilters.involvement);
                        $('#involvementFilter').trigger('change');
                        $('#involvementFilterInline').val(ezgoActionOverview.actionFilters.involvement);
                        $('#involvementFilterInline').trigger('change');
                    }

                    //add status filter
                    if (ezgoActionOverview.actionFilters.status != "") {
                        $('#statusFilter').val(ezgoActionOverview.actionFilters.status);
                        $('#statusFilter').trigger('change');
                        $('#statusFilterInline').val(ezgoActionOverview.actionFilters.status);
                        $('#statusFilterInline').trigger('change');
                    }

                    //add unviewed comments filter
                    if (ezgoActionOverview.actionFilters.hasUnviewedComments == true || ezgoActionOverview.actionFilters.hasUnviewedComments == null) {
                        var unviewedCommentsValue = "";
                        if(ezgoActionOverview.actionFilters.hasUnviewedComments == true) {
                            unviewedCommentsValue = "unviewed";
                        }
                        $('#unviewedCommentsFilter').val(unviewedCommentsValue);
                        $('#unviewedCommentsFilter').trigger('change');
                        $('#unviewedCommentsFilterInline').val(unviewedCommentsValue);
                        $('#unviewedCommentsFilterInline').trigger('change');
                    }

                    //add resources filter
                    if (ezgoActionOverview.actionFilters.assignedAreaIds && ezgoActionOverview.actionFilters.assignedAreaIds.length) {
                        $('#resourceFilter option').each(function () {
                            var optionValue = $(this).val();
                            if (optionValue.startsWith('area') && ezgoActionOverview.actionFilters.assignedAreaIds.includes(optionValue.substr(4, optionValue.length))) {
                                $(this).prop('selected', true);
                            }
                        });
                        $('#resourceFilterInline option').each(function () {
                            var optionValue = $(this).val();
                            if (optionValue.startsWith('area') && ezgoActionOverview.actionFilters.assignedAreaIds.includes(optionValue.substr(4, optionValue.length))) {
                                $(this).prop('selected', true);
                            }
                        });
                    }
                    if (ezgoActionOverview.actionFilters.assignedUserIds && ezgoActionOverview.actionFilters.assignedUserIds.length) {
                        $('#resourceFilter option').each(function () {
                            var optionValue = $(this).val();
                            if (optionValue.startsWith('user') && ezgoActionOverview.actionFilters.assignedUserIds.includes(optionValue.substr(4, optionValue.length))) {
                                $(this).prop('selected', true);
                            }
                        });
                        $('#resourceFilterInline option').each(function () {
                            var optionValue = $(this).val();
                            if (optionValue.startsWith('user') && ezgoActionOverview.actionFilters.assignedUserIds.includes(optionValue.substr(4, optionValue.length))) {
                                $(this).prop('selected', true);
                            }
                        });
                    }


                    //areafilter init
                    if (ezgoActionOverview.actionFilters.parentAreaId != undefined && ezgoActionOverview.actionFilters.parentAreaId !== 0) {
                        //open area tree sections
                        var level = $('#areatree li a[data-id="' + ezgoActionOverview.actionFilters.parentAreaId + '"]').parent('li').data('level') === undefined ? 0 : $('#areatree li a[data-id="' + ezgoActionOverview.actionFilters.parentAreaId + '"]').parent('li').data('level');
                        var pid = $('#areatree a[data-id="' + ezgoActionOverview.actionFilters.parentAreaId + '"]');
                        areaFilter_v2.selectAreaNode(pid[0]);
                        for (i = 0; i < level; i++) {
                            pid = areaFilter_v2.nextSibling(pid);
                        }
                        //make areatree parent li's child anchors bold
                        var areaElem = $('#areatree a[data-id="' + ezgoActionOverview.actionFilters.parentAreaId + '"]');
                        var areaElemParentLi = areaElem.closest('ul').closest('li');
                        while (areaElemParentLi.length) {
                            $(areaElemParentLi.children('a')[0]).css("font-weight", "700");
                            areaElemParentLi = areaElemParentLi.closest('ul').closest('li');
                        }

                        //open inline area tree sections
                        var inlineLevel = $('#inlineAreaTree li a[data-id="' + ezgoActionOverview.actionFilters.parentAreaId + '"]').parent('li').data('level') === undefined ? 0 : $('#inlineAreaTree li a[data-id="' + ezgoActionOverview.actionFilters.parentAreaId + '"]').parent('li').data('level');
                        var inlinePid = $('#inlineAreaTree a[data-id="' + ezgoActionOverview.actionFilters.parentAreaId + '"]');

                        areaFilter_v2.selectAreaNode(inlinePid[0]);
                        for (i = 0; i < inlineLevel; i++) {
                            inlinePid = areaFilter_v2.nextSibling(inlinePid);
                        }

                        //make inline area tree parent li's child anchors bold
                        var inlineAreaElem = $('#inlineAreaTree a[data-id="' + ezgoActionOverview.actionFilters.parentAreaId + '"]');
                        var inlineAreaElemParentLi = inlineAreaElem.closest('ul').closest('li');
                        while (inlineAreaElemParentLi.length) {
                            $(inlineAreaElemParentLi.children('a')[0]).css("font-weight", "700");
                            inlineAreaElemParentLi = inlineAreaElemParentLi.closest('ul').closest('li');
                        }
                    }


                }
            }


            ezgomediafetcher.preloadVisibleImagesAndVideos();

            $('#totalCounter').html('Loading...');

            $("#actionSearchBox").on("keyup", function () {
                //reset3DFilters();
                var value = $("#actionSearchBox").val().toLowerCase();
                
                //apply filter to global filter object
                ezgoActionOverview.actionFilters.filterText = value;
                
                localStorage.setItem('actionfilters', JSON.stringify(ezgoActionOverview.actionFilters));

                $('#contentCol').html('');
                $('#totalCounter').html('Loading...');
                
                ezgoActionOverview.actionsLoaded = false;
                //reset offset since filters changed
                ezgoActionOverview.actionFilters.offset = 0;

                loadActions();
                loadActionCounts();

                //$('#back-to-top').click();
                ezgomediafetcher.preloadVisibleImagesAndVideos();
            });

            //set action type event handler
            $('#actionTypeFilter').on('change', function () {
                var actionTypeValue = $('#actionTypeFilter').val();
                showCorrectFiltersForType(actionTypeValue);
                //apply filter to global filter object
                ezgoActionOverview.actionFilters.actionType = actionTypeValue;
                
                localStorage.setItem('actionfilters', JSON.stringify(ezgoActionOverview.actionFilters));

                $('#contentCol').html('');
                $('#totalCounter').html('Loading...');
                
                ezgoActionOverview.actionsLoaded = false;
                //reset offset since filters changed
                ezgoActionOverview.actionFilters.offset = 0;

                loadActions();
                loadActionCounts();

                ezgomediafetcher.preloadVisibleImagesAndVideos();
            });

            $('#actionTypeFilterInline').on('change', function (e) {
                $('#actionTypeFilter').val($('#actionTypeFilterInline').val());
                $('#actionTypeFilter').trigger('change');
                $('#actionTypeFilter').trigger('change');
            });

            //has unviewed comments
            $('#unviewedCommentsFilter').on('change', function (e) {
                var unviewedCommentsValue = $('#unviewedCommentsFilter').val();
                if (unviewedCommentsValue == "unviewed") {
                    ezgoActionOverview.actionFilters.hasUnviewedComments = true;
                }
                else {
                    ezgoActionOverview.actionFilters.hasUnviewedComments = null;
                }

                $('#contentCol').html('');
                
                $('#totalCounter').html('Loading...');
                
                ezgoActionOverview.actionsLoaded = false;
                //reset offset since filters changed
                ezgoActionOverview.actionFilters.offset = 0;

                loadActions();
                loadActionCounts();

                localStorage.setItem('actionfilters', JSON.stringify(ezgoActionOverview.actionFilters));
            });

            $('#unviewedCommentsFilterInline').on('change', function (e) {
                $('#unviewedCommentsFilter').val($('#unviewedCommentsFilterInline').val());
                $('#unviewedCommentsFilter').trigger('change');
                $('#unviewedCommentsFilter').trigger('change');
            });

            //status filter
            $('#statusFilter').on('change', function (e) {
                var statusValue = $('#statusFilter').val();

                ezgoActionOverview.actionFilters.status = statusValue;
                
                $('#contentCol').html('');
                
                $('#totalCounter').html('Loading...');
                
                ezgoActionOverview.actionsLoaded = false;
                //reset offset since filters changed
                ezgoActionOverview.actionFilters.offset = 0;

                loadActions();
                loadActionCounts();

                localStorage.setItem('actionfilters', JSON.stringify(ezgoActionOverview.actionFilters));
            });

            $('#statusFilterInline').on('change', function (e) {
                $('#statusFilter').val($('#statusFilterInline').val());
                $('#statusFilter').trigger('change');
                $('#statusFilter').trigger('change');
            });

            //involvement filter
            $('#involvementFilter').on('change', function (e) {
                var involvementValue = $('#involvementFilter').val();
                
                ezgoActionOverview.actionFilters.involvement = involvementValue;
                
                $('#contentCol').html('');
                
                $('#totalCounter').html('Loading...');
                
                ezgoActionOverview.actionsLoaded = false;
                //reset offset since filters changed
                ezgoActionOverview.actionFilters.offset = 0;

                loadActions();
                loadActionCounts();

                localStorage.setItem('actionfilters', JSON.stringify(ezgoActionOverview.actionFilters));
            });

            $('#involvementFilterInline').on('change', function (e) {
                $('#involvementFilter').val($('#involvementFilterInline').val());
                $('#involvementFilter').trigger('change');
                $('#involvementFilter').trigger('change');
            });

            //resource filter
            $('#resourceFilter').on('change', function (e) {
                var resources = $('#resourceFilter').val();

                ezgoActionOverview.actionFilters.assignedUserIds = resources.filter(r => r.startsWith('user')).map(r => r.substr(4, r.length));
                ezgoActionOverview.actionFilters.assignedAreaIds = resources.filter(r => r.startsWith('area')).map(r => r.substr(4, r.length));
                
                $('#contentCol').html('');
                
                $('#totalCounter').html('Loading...');
                
                ezgoActionOverview.actionsLoaded = false;
                //reset offset since filters changed
                ezgoActionOverview.actionFilters.offset = 0;

                loadActions();
                loadActionCounts();

                localStorage.setItem('actionfilters', JSON.stringify(ezgoActionOverview.actionFilters));
            });

            $('#resourceFilterInline').on('change', function (e) {
                $('#resourceFilter').val($('#resourceFilterInline').val());
                $('#resourceFilter').trigger('change');
                $('#resourceFilter').trigger('change');
            });

            $('#areatree').on('click', 'a', function () {
                var areaDeselected = +$(this).data('id') != areaid;
                if (areaDeselected) {
                    ezgoActionOverview.actionFilters.parentAreaId = null;
                }
                else {
                    ezgoActionOverview.actionFilters.parentAreaId = $(this).data('id');
                }

                $('#contentCol').html('');

                $('#totalCounter').html('Loading...');

                ezgoActionOverview.actionsLoaded = false;
                //reset offset since filters changed
                ezgoActionOverview.actionFilters.offset = 0;

                loadActions();
                loadActionCounts();

                localStorage.setItem('actionfilters', JSON.stringify(ezgoActionOverview.actionFilters));
            });

            @if (Model?.ApplicationSettings?.Features?.TagsEnabled == true)
            {
                <text>
                    $('.btn-tagsfilter').on('click', function () {
                        //set all selected tags off
                        $('.modal-filter-tag').each(function (index, elem) {
                            var id = $(elem).data('id');
                            if ($(elem).children('div')[0] != null && $($(elem).children('div')[0]).hasClass('selected-tag')) {
                                toggleStyle($(elem).data('id'));
                            }
                        });
                        
                        //set correct tags on
                        if ($("#tagsfilter")[0] != null && ezgoActionOverview.actionFilters.tagids != null && ezgoActionOverview.actionFilters.tagids.length) {
                            $('[id^="filter-tag-"]').each(function (index, elem) {
                                if (ezgoActionOverview.actionFilters.tagids.includes(+$(elem).data('tag'))) {
                                    $(elem).show();
                                    toggleStyle(+$(elem).data('tag'));
                                }

                            });
                        }

                        $('#modalTagsFilter').modal('show');
                    });

                    $('#applyTagsFilterButton').on('click', function(e) {
                        var modalFilterTags = $('.modal-filter-tag');
                        var selectedTagsToApply = [];
                        $(modalFilterTags).each(function (index, tagElem) {
                            var tagId = $(tagElem).data('id');
                            if ($($(this).children()[0]).hasClass('selected-tag')) {
                                $(`#filter-tag-${tagId}`).css('display', 'flex');
                                selectedTagsToApply.push(tagId);
                            }
                            else {
                                $(`#filter-tag-${tagId}`).css('display', 'none');
                            }
                        });

                        ezgoActionOverview.actionFilters.tagids = selectedTagsToApply;

                        $('#contentCol').html('');
                        
                        $('#totalCounter').html('Loading...');
                        
                        ezgoActionOverview.actionsLoaded = false;
                        //reset offset since filters changed
                        ezgoActionOverview.actionFilters.offset = 0;

                        loadActions();
                        loadActionCounts();
                        
                        localStorage.setItem('actionfilters', JSON.stringify(ezgoActionOverview.actionFilters));

                        ezgomediafetcher.preloadVisibleImagesAndVideos();

                        $('#modalTagsFilter').modal('hide');
                    });

                </text>

            }

            @if (Model?.ApplicationSettings?.Features?.AnalyticsEnabled == true)
            {
                <text>
                    $("#actionSearchBox").on("focusout", function () {
                        var value = $(this).val().toLowerCase();

                        if (value.length > 0) {
                            ezgoAnalytics.customLog("Search", "Search used", "action", "search value:" + value);
                        }
                    });

                    $("#statusFilter").on("hide.bs.select", function () {
                        var value = $(this).val();

                        if (value && value.length > 0) {
                            ezgoAnalytics.customLog("custom", "filter status", "action", "filter value:" + value);
                        }
                    });

                    $("#involvementFilter").on("hide.bs.select", function () {
                        var value = $(this).val();

                        if (value && value.length > 0) {
                            ezgoAnalytics.customLog("custom", "filter involvement", "action", "filter value:" + value);
                        }
                    });
                </text>
            }

            initializeDateRangePickers();

            // apply filters from BaseViewModel.FiltersPreset
            var strJson = '@Html.Raw(Model?.FiltersPreset ?? "")';
            if (strJson.length) {
                var presetfilters = JSON.parse(strJson);
                reset3DFilters();
                if (presetfilters) {
                    for (var key in presetfilters) {
                        let presetFilterValue = presetfilters[key];
                        if (key == "actiontype") {
                            $('#actionTypeFilter').val(presetFilterValue);
                            $('#actionTypeFilter').trigger('change');
                            $('#actionTypeFilterInline').val(presetFilterValue);
                            $('#actionTypeFilterInline').trigger('change')
                            ;
                            ezgoActionOverview.actionFilters.actionType = presetFilterValue;
                            
                            showCorrectFiltersForType(presetFilterValue);

                        }
                        else if(key == "actionstatus") {
                            $('#statusFilter').val(presetFilterValue);
                            $('#statusFilter').trigger('change');
                            $('#statusFilterInline').val(presetFilterValue);
                            $('#statusFilterInline').trigger('change');

                            ezgoActionOverview.actionFilters.status = presetFilterValue;
                        }
                        else if(key == "unviewedcomments")
                        {
                            $('#unviewedCommentsFilter').val(presetFilterValue);
                            $('#unviewedCommentsFilter').trigger('change');
                            $('#unviewedCommentsFilterInline').val(presetFilterValue);
                            $('#unviewedCommentsFilterInline').trigger('change');

                            if (presetFilterValue == "unviewed") {
                                ezgoActionOverview.actionFilters.hasUnviewedComments = true;
                            }
                            else {
                                ezgoActionOverview.actionFilters.hasUnviewedComments = null;
                            }
                        }
                        else if(key == "involvement") {
                            //available values "all", "started", "involved", "my"
                            $('#involvementFilter').val(presetFilterValue);
                            $('#involvementFilter').trigger('change');
                            $('#involvementFilterInline').val(presetFilterValue);
                            $('#involvementFilterInline').trigger('change');

                            ezgoActionOverview.actionFilters.involvement = presetFilterValue;
                        }
                    }
                    
                    localStorage.setItem('actionfilters', JSON.stringify(ezgoActionOverview.actionFilters));
                }
            }
            
            //show tooltips of resourceFilter options
            $('button[data-id="resourceFilter"]').on('click', function (e) {
                $('#resourceFilter option').each(function () {
                    var id = '#' + $(this).attr('data-bs-select');
                    var title = $(id).attr('title');
                    if (title == undefined || title == '') {
                        $(id).attr('title', $(this).attr('title'));
                    }
                });
            });
            
            //show tooltips of resourceFilterInline options
            $('button[data-id="resourceFilterInline"]').on('click', function (e) {
                $('#resourceFilterInline option').each(function () {
                    var id = '#' + $(this).attr('data-bs-select');
                    var title = $(id).attr('title');
                    if (title == undefined || title == '') {
                        $(id).attr('title', $(this).attr('title'));
                    }
                });
            });

            loadActions();
            loadActionCounts();

            localStorage.setItem('last_action_overview_location', ezgoActionOverview.lastActionOverviewLocation);
            if ($('#goBackToCompletedItems').length) {
                let actionOverviewLocation = window.location.origin;
                let localStorageItem = localStorage.getItem('last_completed_overview_location');
                if (localStorageItem != null && localStorageItem != undefined) {
                    actionOverviewLocation += localStorageItem;
                    if (localStorageItem.includes('audit')) {
                        $('#goBackToCompletedItemsDescription').html('Back to completed audits');
                    }
                    else if (localStorageItem.includes('checklist')) {
                        $('#goBackToCompletedItemsDescription').html('Back to completed checklists');
                    }
                    else if (localStorageItem.includes('tasks')) {
                        $('#goBackToCompletedItemsDescription').html('Back to completed tasks');
                    }
                }
                else {
                    actionOverviewLocation += '/report/task/completed';
                    $('#goBackToCompletedItemsDescription').html('Back to completed tasks');
                }
                $('#goBackToCompletedItems').attr('href', actionOverviewLocation);
            }
        });

        function goBack() {
            history.back();
        }

        function loadActionCounts() {
            if (ezgoActionOverview.useTaskActions) {
                var cntr = $('#contentCol .results:visible').length;
                $('#totalCounter').html(cntr);
                return;
            }
            var loadActionCountsRequestURL = "";
            var countsUrl = '/action/getactioncounts';
            var urlParams = [];

            if (ezgoActionOverview.actionFilters.filterText != "") {
                urlParams.push("filterText=" + encodeURIComponent(ezgoActionOverview.actionFilters.filterText));
            }

            if (ezgoActionOverview.actionFilters.tagids && ezgoActionOverview.actionFilters.tagids.length > 0) {
                urlParams.push("tagids=" + ezgoActionOverview.actionFilters.tagids.join(","));
            }

            if (ezgoActionOverview.actionFilters.status && ezgoActionOverview.actionFilters.status.length > 0) {
                urlParams.push("status=" + ezgoActionOverview.actionFilters.status.join(","));
            }

            if (ezgoActionOverview.actionFilters.involvement != "") {
                urlParams.push("involvement=" + ezgoActionOverview.actionFilters.involvement);
            }

            if (ezgoActionOverview.actionFilters.assignedUserIds && ezgoActionOverview.actionFilters.assignedUserIds.length>0) {
                urlParams.push("assignedUserIds=" + ezgoActionOverview.actionFilters.assignedUserIds.toString());
            }

            if (ezgoActionOverview.actionFilters.assignedAreaIds && ezgoActionOverview.actionFilters.assignedAreaIds.length>0) {
                urlParams.push("assignedAreaIds=" + ezgoActionOverview.actionFilters.assignedAreaIds.toString());
            }

            if (ezgoActionOverview.actionFilters.hasUnviewedComments != null) {
                urlParams.push("hasUnviewedComments=" + ezgoActionOverview.actionFilters.hasUnviewedComments.toString());
            }

            if (ezgoActionOverview.actionFilters.createdFrom != "" && ezgoActionOverview.actionFilters.createdTo != "" && ezgoActionOverview.actionFilters.createdFrom != null && ezgoActionOverview.actionFilters.createdTo != null) {
                urlParams.push("createdFrom=" + ezgoActionOverview.actionFilters.createdFrom);
                urlParams.push("createdTo=" + ezgoActionOverview.actionFilters.createdTo);
            }

            if (ezgoActionOverview.actionFilters.resolvedFrom != "" && ezgoActionOverview.actionFilters.resolvedTo != "" && ezgoActionOverview.actionFilters.resolvedFrom != null && ezgoActionOverview.actionFilters.resolvedTo != null) {
                urlParams.push("resolvedFrom=" + ezgoActionOverview.actionFilters.resolvedFrom);
                urlParams.push("resolvedTo=" + ezgoActionOverview.actionFilters.resolvedTo);
            }

            if (ezgoActionOverview.actionFilters.overdueFrom != "" && ezgoActionOverview.actionFilters.overdueTo != "" && ezgoActionOverview.actionFilters.overdueFrom != null && ezgoActionOverview.actionFilters.overdueTo != null) {
                urlParams.push("overdueFrom=" + ezgoActionOverview.actionFilters.overdueFrom);
                urlParams.push("overdueTo=" + ezgoActionOverview.actionFilters.overdueTo);
            }

            if (ezgoActionOverview.actionFilters.parentAreaId != null && ezgoActionOverview.actionFilters.parentAreaId > 0) {
                urlParams.push("parentAreaId=" + ezgoActionOverview.actionFilters.parentAreaId);
            }

            if (ezgoActionOverview.actionFilters.actionType != "") {
                urlParams.push("type=" + ezgoActionOverview.actionFilters.actionType);
            }

            if (urlParams.length > 0) {
                loadActionCountsRequestURL = countsUrl + '?' + urlParams.join('&');
            }
            else {
                loadActionCountsRequestURL = countsUrl;
            }

            if (ezgoActionOverview.mostRecentCountsRequest != null) {
                ezgoActionOverview.mostRecentCountsRequest.abort();
            }

            //get statistics
            ezgoActionOverview.mostRecentCountsRequest = $.ajax({
                type: "GET",
                url: loadActionCountsRequestURL,
                success: function (data) {
                    //set total 
                    $('#totalCounter').html(data);
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    if (jqXHR.statusText == "abort") {
                        return;
                    }
                    else { 
                        toastr.error(jqXHR.responseText + ' (' + jqXHR.status + ')');
                    }
                }
            });
        }

        function loadActions() {
            if (ezgoActionOverview.useTaskActions) {
                $('#actionOverviewLoader').hide();
                
                var amountOfActions = $('#actionCounter').val();
                
                ezgoActionOverview.actionsLoaded = true;
                
                $('#actionCounter').remove();
                    
                ezgoActionOverview.loadingMore = false;

                ezgomediafetcher.preloadVisibleImagesAndVideos();
                return;
            }
            
            var loadActionsRequestURL = "";
            var url = '/action/getactions';
            var urlParams = [];
            if (ezgoActionOverview.actionsLoaded) {
                return;
            }
            $('#actionOverviewLoader').show();
 
            if (ezgoActionOverview.actionFilters.filterText != "") {
                urlParams.push("filterText=" + encodeURIComponent(ezgoActionOverview.actionFilters.filterText));
            }

            if (ezgoActionOverview.actionFilters.tagids && ezgoActionOverview.actionFilters.tagids.length > 0) {
                urlParams.push("tagids=" + ezgoActionOverview.actionFilters.tagids.join(","));
            }

            if (ezgoActionOverview.actionFilters.status && ezgoActionOverview.actionFilters.status.length > 0) {
                urlParams.push("status=" + ezgoActionOverview.actionFilters.status.join(","));
            }

            if (ezgoActionOverview.actionFilters.involvement != "") {
                urlParams.push("involvement=" + ezgoActionOverview.actionFilters.involvement);
            }

            if (ezgoActionOverview.actionFilters.assignedUserIds && ezgoActionOverview.actionFilters.assignedUserIds.length>0) {
                urlParams.push("assignedUserIds=" + ezgoActionOverview.actionFilters.assignedUserIds.toString());
            }

            if (ezgoActionOverview.actionFilters.assignedAreaIds && ezgoActionOverview.actionFilters.assignedAreaIds.length>0) {
                urlParams.push("assignedAreaIds=" + ezgoActionOverview.actionFilters.assignedAreaIds.toString());
            }

            if (ezgoActionOverview.actionFilters.hasUnviewedComments != null) {
                urlParams.push("hasUnviewedComments=" + ezgoActionOverview.actionFilters.hasUnviewedComments.toString());
            }

            if (ezgoActionOverview.actionFilters.createdFrom != "" && ezgoActionOverview.actionFilters.createdTo != "" && ezgoActionOverview.actionFilters.createdFrom != null && ezgoActionOverview.actionFilters.createdTo != null) {
                urlParams.push("createdFrom=" + ezgoActionOverview.actionFilters.createdFrom);
                urlParams.push("createdTo=" + ezgoActionOverview.actionFilters.createdTo);
            }

            if (ezgoActionOverview.actionFilters.resolvedFrom != "" && ezgoActionOverview.actionFilters.resolvedTo != "" && ezgoActionOverview.actionFilters.resolvedFrom != null && ezgoActionOverview.actionFilters.resolvedTo != null) {
                urlParams.push("resolvedFrom=" + ezgoActionOverview.actionFilters.resolvedFrom);
                urlParams.push("resolvedTo=" + ezgoActionOverview.actionFilters.resolvedTo);
            }

            if (ezgoActionOverview.actionFilters.overdueFrom != "" && ezgoActionOverview.actionFilters.overdueTo != "" && ezgoActionOverview.actionFilters.overdueFrom != null && ezgoActionOverview.actionFilters.overdueTo != null) {
                urlParams.push("overdueFrom=" + ezgoActionOverview.actionFilters.overdueFrom);
                urlParams.push("overdueTo=" + ezgoActionOverview.actionFilters.overdueTo);
            }

            if (ezgoActionOverview.actionFilters.parentAreaId != null && ezgoActionOverview.actionFilters.parentAreaId > 0) {
                urlParams.push("parentAreaId=" + ezgoActionOverview.actionFilters.parentAreaId);
            }

            if (ezgoActionOverview.actionFilters.actionType != "") {
                urlParams.push("type=" + ezgoActionOverview.actionFilters.actionType);
            }

            if (ezgoActionOverview.actionFilters.limit > 0) {
                urlParams.push("limit=" + ezgoActionOverview.actionFilters.limit);
            }

            if (ezgoActionOverview.actionFilters.offset > 0) {
                urlParams.push("offset=" + ezgoActionOverview.actionFilters.offset);
            }

            if (urlParams.length > 0) {
                loadActionsRequestURL = url + '?' + urlParams.join('&');
            }
            else {
                loadActionsRequestURL = url;
            }

            if (ezgoActionOverview.mostRecentRequest != null) {
                ezgoActionOverview.mostRecentRequest.abort();
            }

            ezgoActionOverview.mostRecentRequest = $.ajax({
                type: "GET",
                url: loadActionsRequestURL,
                success: function (data) {
                    $('#actionOverviewLoader').hide();
                    $('#contentCol').append(data);
                    
                    var amountOfActions = $('#actionCounter').val();
                    
                    if (amountOfActions < 20) {
                        ezgoActionOverview.actionsLoaded = true;
                    }
                    $('#actionCounter').remove();
                    
                    ezgoActionOverview.loadingMore = false;
                    ezgoActionOverview.actionFilters.offset += 20;

                    ezgomediafetcher.preloadVisibleImagesAndVideos();

                },
                error: function (jqXHR, textStatus, errorThrown) {
                    if (jqXHR.statusText == "abort") {
                        return;
                    }
                    else { 
                        toastr.error(jqXHR.responseText + ' (' + jqXHR.status + ')');
                    }
                    $('#actionOverviewLoader').hide();
                }
            });
        }

        function reset3DFilters() {

            ezgoActionOverview.actionFilters = {
                limit: 20,
                offset: 0,
                filterText: "", //also for comment
                tagids: [], //also for comment
                status: [],
                involvement: "",
                assignedUserIds: [],
                assignedAreaIds: [],
                createdFrom: null, //also for comment
                createdTo: null, //also for comment
                resolvedFrom: null,
                resolvedTo: null,
                overdueFrom: null,
                overdueTo: null,
                actionType: "action",
                hasUnviewedComments: null,
                parentAreaId: null
            }

            localStorage.setItem('actionfilters', JSON.stringify(ezgoActionOverview.actionFilters));

            //show filters
            //involvement
            $('#involvementFilterContainer').show();
            //comment status
            $('#unviewedCommentsFilterContainer').show();
            //resources
            $('#resourceFilterContainer').show();
            //resolutiondate
            $('#resolutionDateFilterContainer').show();
            //duedate
            $('#dueDateFilterContainer').show();
            //status
            $('#statusFilterContainer').show();
            //set counter label
            $('#counterLabel').html('Actions');
            //set header text
            $('#overviewHeaderTitle').html('@(CmsLanguage?.GetValue(LanguageKeys.Action.OverViewTitle, "Action overview") ?? "Action overview")');

            //reset date filters
            $('#creationDateFilter').val('');
            $('#resolutionDateFilter').val('');
            $('#dueDateFilter').val('');

            //reset type filter
            $('#actionTypeFilter').val('action');
            $('#actionTypeFilter').trigger('change');
            $('#actionTypeFilterInline').val('action');
            $('#actionTypeFilterInline').trigger('change');

            //reset text filter
            $('#actionSearchBox').val('');

            //reset tags filter
            $('[id^="filter-tag-"]').each(function (index, elem) {
                $(elem).hide();
            });

            //reset status filter
            $('#statusFilter').val([]);
            $('#statusFilter').trigger('change');
            $('#statusFilterInline').val([]);
            $('#statusFilterInline').trigger('change');

            //reset involvement filter
            $('#involvementFilter').val('all');
            $('#involvementFilter').trigger('change');
            $('#involvementFilterInline').val('all');
            $('#involvementFilterInline').trigger('change');

            //reset resources filter
            $('#resourceFilter').val([]);
            $('#resourceFilter').trigger('change');
            $('#resourceFilterInline').val([]);
            $('#resourceFilterInline').trigger('change');

            //reset has unviewed comments filter
            $('#unviewedCommentsFilter').val('');
            $('#unviewedCommentsFilter').trigger('change');
            $('#unviewedCommentsFilterInline').val('');
            $('#unviewedCommentsFilterInline').trigger('change');

            $('#parentAreaFilter').show();
            
            //reset area id filter
            areaFilter_v2.reset('block');

            $('.modal-filter-tag').each(function (index, elem) {
                var id = $(elem).data('id');
                if ($(elem).children('div')[0] != null && $($(elem).children('div')[0]).hasClass('selected-tag')) {
                    toggleStyle($(elem).data('id'));
                }
            });

            $('#contentCol').html('');
            
            $('#totalCounter').html('Loading...');
            
            ezgoActionOverview.actionsLoaded = false;

            //reset offset since filters changed
            ezgoActionOverview.actionFilters.offset = 0;

            loadActions();
            loadActionCounts();

            // return to top
            $('#back-to-top').click();
            
            ezgomediafetcher.preloadVisibleImagesAndVideos();
        }

        function showCorrectFiltersForType(actionTypeValue) {
            if (actionTypeValue == 'comment') { 
                //hide filters
                //involvement
                $('#involvementFilterContainer').hide();
                ezgoActionOverview.actionFilters.involvement = "";
                $('#involvementFilter').val('all');
                $('#involvementFilter').trigger('change');

                //comment status
                $('#unviewedCommentsFilterContainer').hide();
                ezgoActionOverview.actionFilters.hasUnviewedComments = null;
                $('#unviewedCommentsFilter').val('');
                $('#unviewedCommentsFilter').trigger('change');

                //resources
                $('#resourceFilterContainer').hide();
                ezgoActionOverview.actionFilters.assignedUserIds = [];
                ezgoActionOverview.actionFilters.assignedAreaIds = [];
                $('#resourceFilter').val([]);
                $('#resourceFilter').trigger('change');

                //resolutiondate
                $('#resolutionDateFilterContainer').hide();
                ezgoActionOverview.actionFilters.resolvedFrom = null;
                $('#resolutionDateFilter').val('');

                //duedate
                $('#dueDateFilterContainer').hide();
                ezgoActionOverview.actionFilters.overdueFrom = null;
                $('#dueDateFilter').val('');

                //status
                $('#statusFilterContainer').hide();
                ezgoActionOverview.actionFilters.status = [];
                $('#statusFilter').val([]);
                $('#statusFilter').trigger('change');


                var tree = $('#areatree');
                tree.find('a').css('font-weight', '400');
                tree.find('ul:not(:first)').hide();
                ezgoActionOverview.actionFilters.parentAreaId = null;

                //parent area filter
                $('#parentAreaFilter').hide();

                //set counter label
                $('#counterLabel').html('Comments');
                //set header text
                $('#overviewHeaderTitle').html('Comment overview');
            }
            else if(actionTypeValue == 'action') {
                //show filters
                //involvement
                $('#involvementFilterContainer').show();
                //comment status
                $('#unviewedCommentsFilterContainer').show();
                //resources
                $('#resourceFilterContainer').show();
                //resolutiondate
                $('#resolutionDateFilterContainer').show();
                //duedate
                $('#dueDateFilterContainer').show();
                //status
                $('#statusFilterContainer').show();
                //parent area filter
                $('#parentAreaFilter').show();
                //set counter label
                $('#counterLabel').html('Actions');
                //set header text
                $('#overviewHeaderTitle').html('@(CmsLanguage?.GetValue(LanguageKeys.Action.OverViewTitle, "Action overview") ?? "Action overview")');
            }
        }

        //not used
        function apply3DFilter() {
            // set single filters indicating active/inactive

            //does nothing?
            $('a.tdfilter').each(function () {
                var result = checkFilterActive($(this));
                if (result) {
                    $(this).addClass('active');
                } else {
                    $(this).removeClass('active');
                }
            });

            $('select.tdfilter').each(function () {
                var filtergroup = $(this).data('filtergroup');
                var filterarray = getFilterGroup(filtergroup);
                // set values
                $(this).val(filterarray);

                // Then refresh
                $(this).trigger('change');
            });

            // reflect found number in counter
            var cntr = $('#contentCol .results:visible').length;
            $('#totalCounter').html(cntr);


            ezgomediafetcher.preloadVisibleImagesAndVideos();
        }
        
        //not used
        function applyTextFilter() {
            var value = $("#actionSearchBox").val().toLowerCase();
            $("#contentCol div.results").filter(function (index, item) {
                var itemInFilter = checkItemInFilter($(this));
                if (itemInFilter && $(this).data('actiontext').toLowerCase().indexOf(value) > -1) {
                    $(this).show();
                }
                else {
                    $(this).hide();
                }
            });
        }
        
        //not used
        function applyDateRangeFilters() {
            if ($('#creationDateFilter').val() != "" && $('#creationDateFilter').val().includes(" - ")) {
                var creationDateRange = $('#creationDateFilter').val().split(" - ");
                var creationDateFrom = moment(creationDateRange[0], "DD-MM-YYYY");
                var creationDateTo = moment(creationDateRange[1], "DD-MM-YYYY");

                $("#contentCol div.results:visible").filter(function (index, item) {
                    var creationDate = moment($(this).data('actioncreationdate'), "DD-MM-YYYY");
                    if ((creationDateFrom.isBefore(creationDate, 'day') && creationDateTo.isAfter(creationDate, 'day')) || creationDateTo.isSame(creationDate, 'day') || creationDateFrom.isSame(creationDate, 'day')) {
                        $(this).show();
                    }
                    else {
                        $(this).hide();
                    }
                });
            }

            if ($('#resolutionDateFilter').val() != "" && $('#resolutionDateFilter').val().includes(" - ")) {
                var resolutionDateRange = $('#resolutionDateFilter').val().split(" - ");
                var resolutionDateFrom = moment(resolutionDateRange[0], "DD-MM-YYYY");
                var resolutionDateTo = moment(resolutionDateRange[1], "DD-MM-YYYY");

                $("#contentCol div.results:visible").filter(function (index, item) {
                    var resolutionDate = moment($(this).data('actionresolutiondate'), "DD-MM-YYYY");
                        if ((resolutionDateFrom.isBefore(resolutionDate, 'day') && resolutionDateTo.isAfter(resolutionDate, 'day')) || resolutionDateTo.isSame(resolutionDate, 'day') || resolutionDateFrom.isSame(resolutionDate, 'day')) {
                        $(this).show();
                    }
                    else {
                        $(this).hide();
                    }
                });
            }


            if ($('#dueDateFilter').val() != "" && $('#dueDateFilter').val().includes(" - ")) {
                var dueDateRange = $('#dueDateFilter').val().split(" - ");
                var dueDateFrom = moment(dueDateRange[0], "DD-MM-YYYY");
                var dueDateTo = moment(dueDateRange[1], "DD-MM-YYYY");

                $("#contentCol div.results:visible").filter(function (index, item) {
                    var dueDate = moment($(this).data('actionduedate'), "DD-MM-YYYY");
                    if ((dueDateFrom.isBefore(dueDate, 'day') && dueDateTo.isAfter(dueDate, 'day')) || dueDateTo.isSame(dueDate, 'day') || dueDateFrom.isSame(dueDate, 'day')) {
                        $(this).show();
                    }
                    else {
                        $(this).hide();
                    }
                });
            }
        }
        
        //not used
        function applyTagsFilter() {
            var selectedTags = [];
            $('[id^="filter-tag-"]').each(function (index, elem) {
                if ($(elem).css("display") != "none") {
                    selectedTags.push($(elem).data('tag'));
                }
            });

            ezgoActionOverview.actionFilters.tagids = selectedTags;

            if (selectedTags != null && selectedTags.length) {
                $("#contentCol div.results:visible").filter(function (index, elem) {
                    var card = $(elem);
                    var tags = String(card.data('tags')).split(',');
                    if (!tags.some(item => selectedTags.includes(+item))) {
                        card.hide();
                    }
                });
            }
        }
        
        //not used
        function applyActionTypeFilter() {
            var selectedFilter = $('#actionTypeFilter').val();

            $("#contentCol div.results:visible").filter(function (index, elem) {
                var card = $(elem);
                var actionFilterType = String(card.data('actiontype'));
                if (selectedFilter == '') {
                    //dont hide anything
                }
                else if (actionFilterType != selectedFilter) {
                    card.hide();
                }
                if (selectedFilter == 'action') {
                    $('#counterLabel').html('Actions');
                }
                else if (selectedFilter == 'comment') {
                    $('#counterLabel').html('Comments');
                }
            });
        }

        function initializeDateRangePickers() {
            $('#creationDateFilter').daterangepicker({
                autoUpdateInput: false,
                showDropdowns: true,
                opens: 'center', drops: 'up',
                locale: {
                    format: 'DD MMM YYYY',
                    firstDay: 1,
                    cancelLabel: 'Clear'
                }
            });

            $('#creationDateFilterInline').daterangepicker({
                autoUpdateInput: false,
                showDropdowns: true,
                opens: 'center', drops: 'down',
                locale: {
                    format: 'DD MMM YYYY',
                    firstDay: 1,
                    cancelLabel: 'Clear'
                }
            });

            $('#creationDateFilter').on('apply.daterangepicker', function (ev, picker) {
                $(this).val(picker.startDate.format('DD MMM YYYY') + ' - ' + picker.endDate.format('DD MMM YYYY'));
                $('#creationDateFilterInline').val(picker.startDate.format('DD MMM YYYY') + ' - ' + picker.endDate.format('DD MMM YYYY'));

                ezgoActionOverview.actionFilters.createdFrom = picker.startDate.format("DD-MM-YYYY");
                ezgoActionOverview.actionFilters.createdTo = picker.endDate.format("DD-MM-YYYY");

                $('#contentCol').html('');
                
                $('#totalCounter').html('Loading...');
                
                ezgoActionOverview.actionsLoaded = false;
                //reset offset since filters changed
                ezgoActionOverview.actionFilters.offset = 0;

                loadActions();
                loadActionCounts();
                localStorage.setItem('actionfilters', JSON.stringify(ezgoActionOverview.actionFilters));

                ezgomediafetcher.preloadVisibleImagesAndVideos();
            });

            $('#creationDateFilterInline').on('apply.daterangepicker', function (ev, picker) {
                $('#creationDateFilterInline').val(picker.startDate.format('DD MMM YYYY') + ' - ' + picker.endDate.format('DD MMM YYYY'));
                $('#creationDateFilter').val(picker.startDate.format('DD MMM YYYY') + ' - ' + picker.endDate.format('DD MMM YYYY'));
                $('#creationDateFilter').trigger('apply.daterangepicker', [picker]);
            });

            $('#creationDateFilter').on('cancel.daterangepicker', function (ev, picker) {
                $(this).val('');
                $('#creationDateFilterInline').val('');
                
                ezgoActionOverview.actionFilters.createdFrom = "";
                ezgoActionOverview.actionFilters.createdTo = "";

                $('#contentCol').html('');
                
                $('#totalCounter').html('Loading...');
                
                ezgoActionOverview.actionsLoaded = false;
                //reset offset since filters changed
                ezgoActionOverview.actionFilters.offset = 0;

                loadActions();
                loadActionCounts();
                localStorage.setItem('actionfilters', JSON.stringify(ezgoActionOverview.actionFilters));

                ezgomediafetcher.preloadVisibleImagesAndVideos();
            });
            
            $('#creationDateFilterInline').on('cancel.daterangepicker', function (ev, picker) {
                $('#creationDateFilterInline').val('');
                $('#creationDateFilter').val('');
                $('#creationDateFilter').trigger('cancel.daterangepicker', [picker]);
            });

            $('#resolutionDateFilter').daterangepicker({
                autoUpdateInput: false,
                showDropdowns: true,
                opens: 'center', drops: 'up',
                locale: {
                    format: 'DD MMM YYYY',
                    firstDay: 1,
                    cancelLabel: 'Clear'
                }
            });

            $('#resolutionDateFilterInline').daterangepicker({
                autoUpdateInput: false,
                showDropdowns: true,
                opens: 'center', drops: 'down',
                locale: {
                    format: 'DD MMM YYYY',
                    firstDay: 1,
                    cancelLabel: 'Clear'
                }
            });

            $('#resolutionDateFilter').on('apply.daterangepicker', function (ev, picker) {
                $(this).val(picker.startDate.format('DD MMM YYYY') + ' - ' + picker.endDate.format('DD MMM YYYY'));
                $('#resolutionDateFilterInline').val(picker.startDate.format('DD MMM YYYY') + ' - ' + picker.endDate.format('DD MMM YYYY'));
                
                ezgoActionOverview.actionFilters.resolvedFrom = picker.startDate.format("DD-MM-YYYY");
                ezgoActionOverview.actionFilters.resolvedTo = picker.endDate.format("DD-MM-YYYY");

                $('#contentCol').html('');
                
                $('#totalCounter').html('Loading...');
                
                ezgoActionOverview.actionsLoaded = false;
                //reset offset since filters changed
                ezgoActionOverview.actionFilters.offset = 0;

                loadActions();
                loadActionCounts();

                localStorage.setItem('actionfilters', JSON.stringify(ezgoActionOverview.actionFilters));

                ezgomediafetcher.preloadVisibleImagesAndVideos();
            });

            $('#resolutionDateFilterInline').on('apply.daterangepicker', function (ev, picker) {
                $('#resolutionDateFilterInline').val(picker.startDate.format('DD MMM YYYY') + ' - ' + picker.endDate.format('DD MMM YYYY'));
                $('#resolutionDateFilter').val(picker.startDate.format('DD MMM YYYY') + ' - ' + picker.endDate.format('DD MMM YYYY'));
                $('#resolutionDateFilter').trigger('apply.daterangepicker', [picker]);
            });

            $('#resolutionDateFilter').on('cancel.daterangepicker', function (ev, picker) {
                $(this).val('');
                $('#resolutionDateFilterInline').val('');

                ezgoActionOverview.actionFilters.resolvedFrom = "";
                ezgoActionOverview.actionFilters.resolvedTo = "";

                $('#contentCol').html('');
                
                $('#totalCounter').html('Loading...');
                
                ezgoActionOverview.actionsLoaded = false;
                //reset offset since filters changed
                ezgoActionOverview.actionFilters.offset = 0;

                loadActions();
                loadActionCounts();

                localStorage.setItem('actionfilters', JSON.stringify(ezgoActionOverview.actionFilters));

                ezgomediafetcher.preloadVisibleImagesAndVideos();
            });
            
            $('#resolutionDateFilterInline').on('cancel.daterangepicker', function (ev, picker) {
                $('#resolutionDateFilterInline').val('');
                $('#resolutionDateFilter').val('');
                $('#resolutionDateFilter').trigger('cancel.daterangepicker', [picker]);
            });

            $('#dueDateFilter').daterangepicker({
                autoUpdateInput: false,
                showDropdowns: true,
                opens: 'center', drops: 'up',
                locale: {
                    format: 'DD MMM YYYY',
                    firstDay: 1,
                    cancelLabel: 'Clear'
                }
            });

            $('#dueDateFilterInline').daterangepicker({
                autoUpdateInput: false,
                showDropdowns: true,
                opens: 'center', drops: 'down',
                locale: {
                    format: 'DD MMM YYYY',
                    firstDay: 1,
                    cancelLabel: 'Clear'
                }
            });

            $('#dueDateFilter').on('apply.daterangepicker', function (ev, picker) {
                $(this).val(picker.startDate.format('DD MMM YYYY') + ' - ' + picker.endDate.format('DD MMM YYYY'));
                $('#dueDateFilterInline').val(picker.startDate.format('DD MMM YYYY') + ' - ' + picker.endDate.format('DD MMM YYYY'));
                
                ezgoActionOverview.actionFilters.overdueFrom = picker.startDate.format("DD-MM-YYYY");
                ezgoActionOverview.actionFilters.overdueTo = picker.endDate.format("DD-MM-YYYY");

                $('#contentCol').html('');
                
                $('#totalCounter').html('Loading...');
                
                ezgoActionOverview.actionsLoaded = false;
                //reset offset since filters changed
                ezgoActionOverview.actionFilters.offset = 0;

                loadActions();
                loadActionCounts();

                localStorage.setItem('actionfilters', JSON.stringify(ezgoActionOverview.actionFilters));

                ezgomediafetcher.preloadVisibleImagesAndVideos();
            });

            $('#dueDateFilterInline').on('apply.daterangepicker', function (ev, picker) {
                $('#dueDateFilterInline').val(picker.startDate.format('DD MMM YYYY') + ' - ' + picker.endDate.format('DD MMM YYYY'));
                $('#dueDateFilter').val(picker.startDate.format('DD MMM YYYY') + ' - ' + picker.endDate.format('DD MMM YYYY'));
                $('#dueDateFilter').trigger('apply.daterangepicker', [picker]);
            });

            $('#dueDateFilter').on('cancel.daterangepicker', function (ev, picker) {
                $(this).val('');
                $('#dueDateFilterInline').val('');

                ezgoActionOverview.actionFilters.overdueFrom = "";
                ezgoActionOverview.actionFilters.overdueTo = "";

                $('#contentCol').html('');
                
                $('#totalCounter').html('Loading...');
                
                ezgoActionOverview.actionsLoaded = false;
                //reset offset since filters changed
                ezgoActionOverview.actionFilters.offset = 0;

                loadActions();
                loadActionCounts();

                localStorage.setItem('actionfilters', JSON.stringify(ezgoActionOverview.actionFilters));

                ezgomediafetcher.preloadVisibleImagesAndVideos();
            });
            
            $('#dueDateFilterInline').on('cancel.daterangepicker', function (ev, picker) {
                $('#dueDateFilterInline').val('');
                $('#dueDateFilter').val('');
                $('#dueDateFilter').trigger('cancel.daterangepicker', [picker]);
            });
        }

        $('#contentBody').on('scroll', function () {
            //if at bottom, load more actions
            if ($('#contentBody').scrollTop() + $('#contentBody')[0].offsetHeight + 50 >= $('#contentBody')[0].scrollHeight && !ezgoActionOverview.loadingMore && !ezgoActionOverview.actionsLoaded) {
                ezgoActionOverview.loadingMore = true;

                loadActions();
            }

            ezgomediafetcher.preloadVisibleImagesAndVideos();
        });
        
        @if(Model?.ApplicationSettings?.Features?.TagsEnabled == true)
        {
            <text>
                function showInlineTagFilterModal() {
                    $('#modalTagsFilter').modal('show');
                }
            </text>
        }

        //areafilter fix
        areaid = ezgoActionOverview.actionFilters.parentAreaId;
    </script>
}