@model WebApp.ViewModels.TaskViewModel
@{
    string getIconColor(string state)
    {
        switch (state.ToLower())
        {
            case "ok":
                return "bg-green";
            case "not ok":
                return "bg-red";
            case "skipped":
                return "bg-warning";
            default:
                return "bg-lightGray";
        }
    }

    string getIcon(string state)
    {
        switch (state.ToLower())
        {
            case "ok":
                return "fa-thumbs-up status-icon";
            case "not ok":
                return "fa-thumbs-down status-icon";
            case "skipped":
                return "fa-forward status-icon";
            default:
                return "fa-question";
        }
    }

    string IsRequired = Model?.CmsLanguage?.GetValue(LanguageKeys.Task.DeepLinkIsRequired, "is required") ?? "is required";
    IsRequired = IsRequired[0].ToString().ToUpper() + IsRequired.Substring(1);

    var tz = User.FindFirst(System.Security.Claims.ClaimTypes.Country)?.Value ?? "Europe/Amsterdam";
    TimeZoneInfo timezone = TZConvert.EzFindTimeZoneInfoById(tz);

    Layout = "_Layout_template";
    ViewData["Title"] = Model?.CmsLanguage?.GetValue(LanguageKeys.Task.TaskDetailsTitle, "Task details") ?? "Task details";
}

@section CSS {
    <link rel="stylesheet" href="/plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css" />

    <style>
        #instructions {
            top: 0px;
            position: absolute;
            z-index: 3;
        }

        .card {
            margin-bottom: 0px !important;
        }

        .customArrow {
            width: 100%;
            position: absolute;
            height: 0px;
            width: 0px;
            display: block;
            transition: top 200ms;
            border-bottom: 20px #93C54B solid;
            border-left: 20px transparent solid;
            border-right: 20px transparent solid;
            margin-top: -21px;
        }

        .pencil-action {
            height: 45px;
            width: 45px;
            margin-top: 15px;
            margin-right: 15px;
            font-size: 25px;
            color: #364c59;
            cursor: pointer;
        }

            .pencil-action svg {
                margin-top: 3px;
                margin-left: 11px;
            }

        .modal {
            padding: 0 !important;
        }

        .value-placeholder {
            height: 70px;
            border: 1px dashed #fff;
            width: 115px;
            margin: 10px 15px 0px 0px;
            cursor: pointer;
        }

            .value-placeholder span {
                font-weight: 700;
                font-size: 1.2rem;
            }

            .value-placeholder.active {
                border: solid 1px silver;
                background-color: lightgray;
            }

        .paperclip {
            height: 160px;
            background-color: #8ea968;
            text-align: center;
            color: #fff;
        }

            .paperclip i {
                margin-top: 25px;
            }

                .paperclip i::after {
                    display: block;
                    font-size: 26px;
                    font-style: normal;
                    font-weight: 600;
                }

        .addclip {
            height: 130px;
            text-align: center;
            color: #93C54B;
            cursor: pointer;
        }

            .addclip:hover {
                border: dashed 1px #93C54B;
                background-color: #93c54b1f;
                border-radius: 10px;
            }

            .addclip i {
                margin-top: 39px;
            }

                .addclip i::after {
                    display: block;
                    font-size: 26px;
                    font-style: normal;
                    font-weight: 600;
                }

        .addvalue {
            height: 70px;
            text-align: center;
            color: #93C54B;
            cursor: pointer;
            width: 115px;
        }

            .addvalue i {
                margin-top: 12px;
            }

                .addvalue i::after {
                    display: block;
                    font-size: 26px;
                    font-style: normal;
                    font-weight: 600;
                }

        .nav-pills .nav-link.active, .nav-pills .show > .nav-link {
            color: #fff;
            background-color: #93C54B;
        }

        .nav-pills .nav-link:not(.active):hover {
            color: #93C54B;
        }

        @@media print {
            .pagebreak {
                page-break-after: always !important;
                break-after: always !important;
            }

            #mainCol {
                display: block !important;
                position: relative !important;
                width: auto !important;
                height: auto !important;
                overflow: visible !important;
                margin-left: 0 !important;
            }

            .content-wrapper {
                background-color: #fff !important;
            }
        }

        .itemlist .card {
            width: 12rem;
        }

            .itemlist .card .card-body {
                font-size: 9.5pt;
                color: #6c757d !important;
            }

                .itemlist .card .card-body p {
                    padding-bottom: 0px;
                }

            .itemlist .card:hover {
                box-shadow: 0 .5rem 1rem rgba(0,0,0,.15) !important;
            }

        v.list-inline-item {
            padding: 5px;
        }

        .controls {
            position: absolute;
            bottom: 0px;
            margin: 15px;
        }

        .main-image-pencil {
            background: #93c54b;
            width: 35px;
            height: 35px;
            margin: 10px;
            opacity: 0.8;
            z-index: 1;
            color: #fff;
            border: solid 1px #333333 !important;
            cursor: pointer;
        }

            .main-image-pencil i {
                width: 35px;
                height: 33px;
                position: relative;
                display: flex;
            }

            .main-image-pencil:hover {
                border: solid 1px #fff !important;
            }

        .itemlist .pencil {
            background: #333333;
            width: 35px;
            height: 35px;
            margin: 10px;
            opacity: 0.8;
            z-index: 1;
            position: absolute;
            left: 70px;
            top: 105px;
            color: #fff;
            border: solid 1px #333333 !important;
            cursor: pointer;
        }

            .itemlist .pencil i {
                width: 35px;
                height: 33px;
                position: relative;
                display: flex;
            }

            .itemlist .pencil:hover {
                border: solid 1px #fff !important;
            }

        .itemlist .ui-state-highlight {
            height: 240px;
            line-height: 1.2em;
            width: 12rem;
            margin-right: 22px;
            background-color: rgba(241,241,241,0.52) !important;
            border: dashed 1px rgb(191,191,191);
            margin-top: 6px;
        }

        .itemlist .valuePropHolder {
            width: 100px;
            height: 60px;
            border-radius: 6px;
            float: left;
            margin-right: 18px;
            border: 1px solid rgb(214,214,214);
        }

        .itemlist .card-link {
            position: relative;
            display: flex;
            height: 160px;
            margin: -1px;
            border: solid 1px rgba(0,0,0,0);
        }

            .itemlist .card-link img {
                object-fit: cover;
                width: 100%;
                height: 160px;
                border-top-left-radius: 10px;
                border-top-right-radius: 10px;
            }

        #editStepModalContent img.main-img {
            border-radius: 5px;
            border: solid 1px #ced4da;
        }

        .btn-light:not(:disabled):not(.disabled).active, .btn-light:not(:disabled):not(.disabled):active, .show > .btn-light.dropdown-toggle {
            color: #fff !important;
            background-color: #93C54B;
            border-color: #d3d9df;
        }

        .tpl {
            display: none;
        }

        .list-group-item:last-child {
            margin-bottom: 0;
            border-bottom-right-radius: 0rem;
            border-bottom-left-radius: 0rem;
        }

        .ui-autocomplete {
            position: absolute;
            top: 100%;
            left: 0;
            z-index: 1000;
            display: none;
            float: left;
            min-width: 160px;
            padding: 5px 0;
            margin: 2px 0 0;
            list-style: none;
            font-size: 14px;
            text-align: left;
            background-color: #ffffff;
            border: 1px solid #cccccc;
            border: 1px solid rgba(0, 0, 0, 0.15);
            border-radius: 4px;
            -webkit-box-shadow: 0 6px 12px rgba(0, 0, 0, 0.175);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.175);
            background-clip: padding-box;
        }

            .ui-autocomplete > li > div {
                display: block;
                padding: 3px 20px;
                clear: both;
                font-weight: normal;
                line-height: 1.42857143;
                color: #333333;
                white-space: nowrap;
            }

        .ui-state-hover,
        .ui-state-active,
        .ui-state-focus {
            text-decoration: none;
            color: #262626;
            background-color: #f5f5f5;
            cursor: pointer;
        }

        .ui-helper-hidden-accessible {
            border: 0;
            clip: rect(0 0 0 0);
            height: 1px;
            margin: -1px;
            overflow: hidden;
            padding: 0;
            position: absolute;
            width: 1px;
        }

        .custom-checkbox .custom-control-input:checked ~ .custom-control-label::before,
        .custom-checkbox .custom-control-input:indeterminate ~ .custom-control-label::before {
            background-color: #93C54B;
            border-color: #93c54b1f;
        }

        .custom-control-input:checked ~ .custom-control-label::before {
            color: #fff;
            border-color: #93c54b1f;
            background-color: #93C54B;
            box-shadow: none;
        }

        .popover {
            border: 0;
            box-shadow: rgba(0, 0, 0, 0.125) 0px 0px 1px 0px, rgba(0, 0, 0, 0.2) 0px 1px 3px 0px;
        }

        <!-- Completed tasks -->
        .my-circle {
            display: inline-block;
            border-radius: 60px;
            padding: 0.8em 1.1em;
            background-color: #3f903f;
            color: #fff;
        }

        .my-circle i {
            font-size: 20px;
        }

        .circle-container {
            display: flex;
            width: 100%;
            justify-content: center;
        }

        .status-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff !important;
            flex-grow: 0;
            flex-shrink: 0;
            font-size: 2em;
        }

        .status-circle-action {
            position: absolute;
            left: calc(50% - 65px - .7em);
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff !important;
            flex-grow: 0;
            flex-shrink: 0;
            font-size: 1.2em;
        }

        .status-circle-pp {
            position: absolute;
            left: calc(50% + 30px + .2em);
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff !important;
            flex-grow: 0;
            flex-shrink: 0;
            font-size: 1.2em;
        }

        .status-icon {
            display: flex;
            margin: auto;
        }
    </style>
}

<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                @if (Model.SharedTemplateId > 0)
                {
                    <a asp-controller="inbox" asp-action="index"><i class="fa fa-arrow-left"></i> @(Model?.CmsLanguage?.GetValue(LanguageKeys.Shared.NavBackToInboxTitle, "Back to inbox") ?? "Back to inbox")</a>
                }
                else
                {
                    <a asp-controller="task" asp-action="index"><i class="fa fa-arrow-left"></i> @(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.NavBackTitle, "Back to task overview") ?? "Back to task overview")</a>
                }
                <h1>@(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.Title, "Task overview") ?? "Task overview")</h1>
            </div>

            <div class="col-sm-6 d-flex  flex-row-reverse">
                <button id="btnSaveTemplate" class="btn btn-ezgo btn-sm mr-2 shadow-sm mt-auto" onclick="ezgolist.save()" data-tracking="enabled" data-tracking-name="save">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.BtnSave, "Save") ?? "Save")</button>

                <form id="frmDelete" method="post" action='/task/delete/@Model?.CurrentTaskTemplate?.Id' class="mt-auto">
                    <button type="button" id="btnDeleteTemplate" class="btn btn-danger btn-sm mr-2 shadow-sm mt-auto" onclick="ezgolist.delete()" data-tracking="enabled" data-tracking-name="delete">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.BtnDelete, "Delete") ?? "Delete")</button>
                </form>

                <form id="frmDuplicate" method="post" action='/task/duplicate/@Model?.CurrentTaskTemplate?.Id' class="mt-auto">
                    <button type="button" id="btnDuplicateTemplate" class="btn btn-ezgo btn-sm btn-outline mr-2 shadow-sm mt-auto btn-disabled-during-changes" onclick="ezgolist.duplicate()" data-tracking="enabled" data-tracking-name="duplicate">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.BtnDuplicate, "Duplicate") ?? "Duplicate")</button>
                </form>

                @if (Model.ApplicationSettings?.Features?.TemplateSharingEnabled == true)
                {
                    <button id="btnShareTemplate" data-type="task" data-templateid="@Model.CurrentTaskTemplate.Id" class="btn btn-ezgo btn-sm mr-2 shadow-sm mt-auto btn-disabled-during-changes" onclick="$('#template-share-modal').modal('show')">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Shared.ShareButtonTitle, "Share") ?? "Share")</button>
                }

                @if (Model.SharedTemplateId > 0)
                {
                    <button class="btn btn-ezgo btn-sm btn-outline mr-2 shadow-sm mt-auto" disabled="disabled"><i class="fa fa-print"></i></button>
                }
                else
                {
                    <button class="btn btn-ezgo btn-sm btn-outline mr-2 shadow-sm mt-auto btn-disabled-during-changes" @(Model.CurrentTaskTemplate.Id == 0 ? "disabled=\"disabled\"" : "") onclick="window.open('/pdf/viewer/tasktemplate/@(Model.CurrentTaskTemplate.Id)', '_blank', 'toolbar=no,top=10,left=10,width=' + (screen.availWidth-10) + ',height=' + (screen.availHeight-10) + '');" data-tracking="enabled" data-tracking-name="create pdf"><i class="fa fa-print"></i></button>
                }

                @if (Model.EnableJsonExtraction) //enable json extraction, for now
                {
                    <partial name="~/Views/Shared/_extraction_data.cshtml" model="Model.ExtractionData" />
                }
            </div>
        </div>
    </div>
</section>

<input type="hidden" id="currentTemplateItemId" />

<section class="content">
    <div class="container-fluid">
        <div id="mainCol" class="row pt-1" style="height:calc(100vh - 175px);overflow:auto;">
            <div class="col-lg-12">
                <div class="col-12 p-0">
                    <div id="fileSizeAlert-template" class="alert alert-danger d-none">
                        @(Model?.CmsLanguage?.GetValue(LanguageKeys.FrameWork.FileSizeTooBig, "File size for this media file is too big!") ?? "File size for this media file is too big!")
                        <button type="button" class="close" onclick="$(this).closest('div.alert').hide()" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>

                    <div class="row card-group">
                        <div class="col-sm-4 col-md-5 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <div id="templateDropZone" data-drop="true" class="card h-100" style="width:100%;height:238px;display:flex;border-radius: 5px;">
                                        <a href="/assets/img/normal_unavailable_image.png" data-fancybox="steps" data-caption="">
                                            <img id="TemplateImage" src="" style="width:100%;object-fit: cover; object-position: center; height:20.3rem;border-radius: 5px;" class="img-fluid" alt="...">
                                        </a>

                                        <div class="controls d-print-none" style="position:absolute;bottom:0px;">
                                            <input class="d-none" type="file" id="uploaderTemplate" accept="video/*,image/*" name="photo" onchange="ezgolist.previewFileEx(this);" onclick="this.value=null" data-preview="#TemplateImage" data-templateid="0" data-type="item" required>
                                            <a href="#" onclick="$('#uploaderTemplate').trigger('click'); return false;">
                                                <div class="border rounded-circle float-right d-lg-flex justify-content-lg-center shadow main-image-pencil">
                                                    <i class="fa fa-paperclip d-lg-flex justify-content-center align-items-center align-content-center" style="font-size: 20px;"></i>
                                                </div>
                                            </a>

                                            <a href="#" data-selector="deletemedia" data-type="template">
                                                <div class="border rounded-circle float-left d-lg-flex justify-content-lg-center shadow main-image-pencil">
                                                    <i class="fa fa-trash d-lg-flex justify-content-center align-items-center align-content-center" style="font-size: 20px;"></i>
                                                </div>
                                            </a>

                                            <video id="dialogVideo" controls style="display:none;"></video>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-sm-8 col-md-7 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <small data-type="cid" class="card-text text-muted">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.TaskId, "Task ID") ?? "Task ID"): </small>

                                    <div style="float:right">
                                        <small id="changedOn" class="card-text text-muted">
                                            @if (Model.CurrentTaskTemplate != null && Model.CurrentTaskTemplate.ModifiedAt != null)
                                            {
                                                @((Model?.CmsLanguage?.GetValue(LanguageKeys.Auditing.LastModifiedAt, "Last modified on ") ?? "Last modified on ") + Model.CurrentTaskTemplate.ModifiedAt)
                                            }
                                        </small>
                                    </div>

                                    <div class="row mx-0 align-items-center">
                                        @if (Model != null && Model.ApplicationSettings != null && Model.ApplicationSettings.Features != null && Model.ApplicationSettings.Features.RequiredProof.Value)
                                        {
                                            <div class="col px-0">
                                                <input id="txtTemplateName" maxlength="240" name="txtTemplateName" type="text" class="form-control form-control-sm" required onblur="ezgolist.setDetails(this)" placeholder="@(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.ItemTitlePlaceholder, "Enter a title for this task") ?? "Enter a title for this task")" />
                                            </div>

                                            <div class="col-auto pl-2">
                                                <div class="custom-control custom-switch">
                                                    <input type="checkbox" class="custom-control-input" id="enablePictureProof">
                                                    <label style="font-weight: 400" class="custom-control-label card-text text-muted" for="enablePictureProof">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PictureProof.PictureProofTitle, "Picture Proof") ?? "Picture Proof")</label>
                                                </div>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="col-12 px-0">
                                                <input id="txtTemplateName" maxlength="240" name="txtTemplateName" type="text" class="form-control form-control-sm" required onblur="ezgolist.setDetails(this)" placeholder="@(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.ItemTitlePlaceholder, "Enter a title for this task") ?? "Enter a title for this task")" />
                                            </div>
                                        }
                                    </div>

                                    <textarea id="txtTemplateDescription" name="txtTemplateDescription" class="form-control form-control-sm mt-2" onblur="ezgolist.setDetails(this)" placeholder="@(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.ItemDescPlaceholder, "Enter a description for this task") ?? "Enter a description for this task")"></textarea>

                                    <div class="row pt-3">
                                        <div class="col-md-12 col-lg-12">
                                            <span class="card-text text-muted">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.RoleTitle, "Select a role for this task") ?? "Select a role for this task")</span>

                                            <div class="btn-group btn-group-sm btn-group-toggle pt-1" data-toggle="buttons" style="display:flex;">
                                                <label class="btn btn-light text-muted" style="flex:1;">
                                                    <input type="radio" name="role" id="role1" value="basic" onclick="ezgolist.setDetails(this)"> @(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.OptionBasic, "Basic user") ?? "Basic user")
                                                </label>

                                                <label class="btn btn-light text-muted" style="flex:1;">
                                                    <input type="radio" name="role" id="role2" value="shift_leader" onclick="ezgolist.setDetails(this)"> @(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.OptionShiftLeader, "Shift leader") ?? "Shift leader")
                                                </label>

                                                <label class="btn btn-light text-muted" style="flex:1;">
                                                    <input type="radio" name="role" id="role3" value="manager" onclick="ezgolist.setDetails(this)"> @(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.OptionManager, "Manager") ?? "Manager")
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    @if (Model?.ApplicationSettings?.Features != null && ((Model.ApplicationSettings.Features.AuditsEnabled ?? false) || (Model.ApplicationSettings.Features.ChecklistsEnabled ?? false)))
                                    {
                                        <div class="row pt-3">
                                            <div class="col-md-12 col-lg-4 d-none">
                                                <h6>@(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.ConnectTitle, "Connect this task") ?? "Connect this task")</h6>
                                            </div>

                                            <div class="col-md-12 col-lg-12">
                                                <span class="card-text text-muted">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.ConnectTitle, "Connect this task") ?? "Connect this task")</span>
                                                <div class="btn-group btn-group-sm btn-group-toggle" data-toggle="buttons" style="display:flex;">
                                                    <label class="btn btn-light text-muted" style="flex:1;">
                                                        <input type="radio" name="deeplink" id="deeplink1" value="none" onclick="deeplink.hideAll();ezgolist.setDetails(this)"> @(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.OptionNoConnect, "Do not connect") ?? "Do not connect")
                                                    </label>

                                                    @if (Model.ApplicationSettings.Features.AuditsEnabled ?? false)
                                                    {
                                                        <label class="btn btn-light text-muted" style="flex:1;">
                                                            <input type="radio" name="deeplink" id="deeplink2" value="audit" onclick="deeplink.showAudit();ezgolist.setDetails(this)"> @(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.OptionConnectAudit, "Connect to audit") ?? "Connect to audit")
                                                        </label>
                                                    }

                                                    @if (Model.ApplicationSettings.Features.ChecklistsEnabled ?? false)
                                                    {
                                                        <label class="btn btn-light text-muted" style="flex:1;">
                                                            <input type="radio" name="deeplink" id="deeplink3" value="checklist" onclick="deeplink.showChecklist();ezgolist.setDetails(this)"> @(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.OptionConnectChecklist, "Connect to checklist") ?? "Connect to checklist")
                                                        </label>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    }

                                    <div class="row pt-3" id="rowDeeplinkAudit">
                                        <div class="col-md-10">
                                            <div id="deeplinkAuditTag" class="d-none" style="overflow: hidden;font-size:14px;font-weight:bolder;min-height:40px">
                                                <div style="color: #1f2d3d; background-color: #93C54B;border-color:#d3d9df;border-radius: .25rem;min-height:25px;text-align:center;">
                                                    <div id="deeplinkAuditLabel" style="margin-top:5px;" data-auditid="0"></div>
                                                </div>
                                            </div>
                                            <input type="text" id="tagsAudit" placeholder="@(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.ConnectSearchPlaceholder, "Type a name to search...") ?? "Type a name to search...")" class="form-control form-control-sm" />
                                        </div>
                                        <div class="col-md-2">
                                            <i id="deeplinkAuditRemoveBtn" class="fa fa-times float-left" onclick="deeplink.removeAuditTag()" style="cursor:pointer;margin-top:5px;"></i>
                                            <div class="custom-control custom-switch float-right">
                                                <input type="checkbox" class="custom-control-input" id="deepLinkAuditIsRequired">
                                                <label style="font-weight: 400" class="custom-control-label card-text text-muted" for="deepLinkAuditIsRequired" style="max-width:">@(IsRequired)</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row pt-3" id="rowDeeplinkChecklist">
                                        <div class="col-md-10">
                                            <div id="deeplinkChecklistTag" class="d-none" style="overflow: hidden;font-size:14px;font-weight:bolder;min-height:40px">
                                                <div style="color: #1f2d3d; background-color: #93C54B;border-color:#d3d9df;border-radius: .25rem;min-height:25px;text-align:center;">
                                                    <div id="deeplinkChecklistLabel" data-checklistid="0" style="margin-top:5px;"></div>
                                                </div>
                                            </div>
                                            <input type="text" id="tagsChecklist" placeholder="@(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.ConnectSearchPlaceholder, "Type a name to search...") ?? "Type a name to search...")" class="form-control form-control-sm" />
                                        </div>
                                        <div class="col-md-2">
                                            <i id="deeplinkChecklistRemoveBtn" class="fa fa-times float-left" onclick="deeplink.removeChecklistTag()" style="cursor:pointer;margin-top:5px;"></i>
                                            <div class="custom-control custom-switch float-right">
                                                <input type="checkbox" class="custom-control-input" id="deepLinkChecklistIsRequired">
                                                <label style="font-weight: 400" class="custom-control-label card-text text-muted" for="deepLinkChecklistIsRequired" style="max-width:">@(IsRequired)</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAGS -->
                @if (Model.ApplicationSettings.Features?.TagsEnabled == true)
                {
                    <div class="col-12 p-0 pb-3" data-item="steps-view">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">@(Model.CmsLanguage?.GetValue(LanguageKeys.Tags.TagsMainTitle, "Tags") ?? "Tags")</h3>
                            </div>

                            <div class="card-body px-3 pb-3 pt-0">
                                <partial name="_tags_block" model="Model.Tags" />
                            </div>
                        </div>
                    </div>
                }

                <!-- INSTRUCTIONS -->
                <div class="col-12 p-0 pb-3" data-item="steps-view">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.InstructionDialogTitle, "Instructions") ?? "Instructions")</h3>
                        </div>

                        <div class="card-body p-3">
                            <ul id="instructionlist" class="list-inline card-group pt3 itemlist"></ul>
                        </div>
                    </div>
                </div>

                <!-- VALUE PROPERTIES -->
                <div class="col-12 p-0 pb-3" data-item="property-view">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.ValuePropertiesTitle, "Value properties") ?? "Value properties")</h3>
                        </div>

                        <div class="card-body p-3">
                            <div class="row">
                                <div class="col-md-12 col-lg-6">
                                    <ul id="valueProps"></ul>
                                    <partial name="~/Views/Shared/_value_properties.cshtml" />
                                </div>

                                <div class="col-md-12 col-lg-6">
                                    <span class="card-text text-muted">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.MachineStatusTitle, "Machine status") ?? "Machine status")</span>
                                    <div class="btn-group btn-group-sm btn-group-toggle" data-toggle="buttons" style="display:flex;">
                                        <label class="btn btn-light text-muted" style="flex:1;">
                                            <input type="radio" name="machinestatus" id="machinestatus1" value="not_applicable" onclick="ezgolist.setDetails(this)"> @(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.OptionNotApplicable, "Not applicable") ?? "Not applicable")
                                        </label>

                                        <label class="btn btn-light text-muted" style="flex:1;">
                                            <input type="radio" name="machinestatus" id="machinestatus2" value="stopped" onclick="ezgolist.setDetails(this)"> @(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.OptionStopped, "Stopped") ?? "Stopped")
                                        </label>

                                        <label class="btn btn-light text-muted" style="flex:1;">
                                            <input type="radio" name="machinestatus" id="machinestatus3" value="running" onclick="ezgolist.setDetails(this)"> @(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.OptionRunning, "Running") ?? "Running")
                                        </label>
                                    </div>

                                    <span class="card-text text-muted">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.PlannedTimeTitle, "Planned time") ?? "Planned time")</span>
                                    <div class="form-inline">
                                        <div class="input-group input-group-sm">
                                            <input type="number" id="plannedtime" onblur="ezgolist.setDetails(this)" min="0" max="999" style="width:125px;" class="form-control form-control-sm" />
                                            <div class="input-group-append">
                                                <div class="input-group-text">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.PlannedTimeMinutesTitle, "minutes") ?? "minutes")</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AREAS -->
                <div class="col-12 p-0 pb-3">
                    <div class="card">
                        <div class="card-header">
                            @(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.AreaTitle, "Areas") ?? "Areas")
                            <span id="areaprintlist"></span>
                        </div>

                        <div class="card-body p-0 d-print-none" style="overflow-x:auto;" id="areasScrollDiv">
                            <div id="areascard" class="d-flex clearfix" style="height:231px;"></div>
                        </div>
                    </div>
                </div>

                <!-- RECURRENCE -->
                <div class="col-12 p-0 pb-3">
                    <div class="card">
                        <div class="card-header">
                            @(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.TemplateRecurrenceTitle, "Recurrence") ?? "Recurrence")
                        </div>

                        <div class="card-body">
                            <partial name="~/Views/Task/_recurrence_multitype.cshtml" model="@Model.Recurrency" />
                        </div>
                    </div>
                </div>

                <!-- LAST COMPLETED TASKS -->
                @if (Model.CurrentTaskTemplate.Id > 0)
                {
                    <div class="col-12 p-0 pb-3">
                        <div class="card">
                            <div class="card-header h5">
                                <div class="row">
                                    <div class="col-sm-6">
                                        @(Model?.CmsLanguage.GetValue(LanguageKeys.Dashboard.StatsTaskCompletedTitleTimeFrame, "Completed tasks last 30 days") ?? "Completed tasks last 30 days")
                                    </div>

                                    <div class="col-sm-6">                                    </div>
                                </div>
                            </div>

                            <div class="card-body p-3" style="overflow-x:auto">
                                <div class="row">
                                    @if (Model.CompletedTasks != null && Model.CompletedTasks.Count > 0)
                                    {
                                        var forLoopMaxI = Model.CompletedTasks.Count > 5 ? 5 : Model.CompletedTasks.Count;
                                        for (int i = 0; i < forLoopMaxI; i++)
                                        {
                                            if (Model.CompletedTasks != null)
                                            {
                                                <div class="col-sm-2 p-1">
                                                    <div class="m-1 p-2" style="background-color: rgb(241, 243, 240); border-radius: 10px; height: 100%">
                                                        <div class="row" style="height: 100px">
                                                            <div class="col-12 pt-3 circle-container" style="text-align: center">
                                                                @if (Model.CompletedTasks[i].ActionsCount > 0 || Model.CompletedTasks[i].CommentCount > 0)
                                                                {
                                                                    <div class="status-circle-action bg-warning mx-1">
                                                                        <i class="fa fa-bolt-lightning status-icon"></i>
                                                                    </div>
                                                                }

                                                                <span class="@getIconColor(Model.CompletedTasks[i].Status) status-circle mx-1">
                                                                    <i class="fa @getIcon(Model.CompletedTasks[i].Status) status-icon" title="@Model.CompletedTasks[i].Status"></i>
                                                                </span>

                                                                @if (Model.CompletedTasks[i].PictureProof != null)
                                                                {
                                                                    <a style="background-color: lightgray;" class="status-circle-pp mx-1">
                                                                        <i class="fas fa-camera status-icon"></i>
                                                                    </a>
                                                                }
                                                            </div>
                                                        </div>

                                                        <div class="row">
                                                            <div class="col-12">
                                                                <strong>@Model.CompletedTasks[i].Name</strong>
                                                            </div>
                                                        </div>

                                                        @if (Model.CompletedTasks[i].Signature != null)
                                                        {
                                                            <div class="row">
                                                                <div class="col-12">
                                                                    @(Model?.CmsLanguage?.GetValue(LanguageKeys.Dashboard.CompletedBy, "Completed by") ?? "Completed by"): @Model.CompletedTasks[i].Signature.SignedBy
                                                                </div>
                                                            </div>

                                                            <div class="row">
                                                                <div class="col-12">
                                                                    @{
                                                                        DateTime SignedDate = TimeZoneInfo.ConvertTime(Model.CompletedTasks[i].Signature.SignedAt.Value, timezone);
                                                                    }
                                                                    @SignedDate.ToLocaleFullDateShortTimeString(Model.Locale)
                                                                </div>
                                                            </div>
                                                        }
                                                    </div>
                                                </div>
                                            }
                                        }
                                        //more tasks div
                                        <div class="col-sm-2 p-1">
                                            <a href="/report/task/completed?templateId=@Model.CurrentTaskTemplate.Id">
                                                <div class="m-1 p-3" style="background-color: rgb(163, 193, 97); border-radius: 10px; height: 100%; color: white">
                                                    <div class="row" style="height: 100px; text-align: center">
                                                        <div class="col-12" style="font-size: 50px">
                                                            <i class="fa-solid fa-clock-rotate-left"></i>
                                                        </div>
                                                    </div>

                                                    <div class="row" style="text-align: center; font-size: 17px">
                                                        <div class="col-12">
                                                            <strong>@(Model?.CmsLanguage.GetValue(LanguageKeys.LastCompletedItems.LastCompleted, "Last completed") ?? "Last completed")</strong>
                                                            <br />
                                                            @(Model?.CmsLanguage.GetValue(LanguageKeys.LastCompletedItems.Tasks, "tasks") ?? "tasks")
                                                        </div>
                                                    </div>
                                                </div>
                                            </a>
                                        </div>

                                    }
                                    else @if (Model.CurrentTaskTemplate.Id > 0)
                                    {
                                        <div class="col-10">
                                            @(Model?.CmsLanguage.GetValue(LanguageKeys.LastCompletedItems.NoCompletedTasksFound, "No completed tasks found") ?? "No completed tasks found")
                                        </div>

                                        <div class="col-2 p-1">
                                            <a href="/report/task/completed">
                                                <div class="m-1 p-3" style="background-color: rgb(163, 193, 97); border-radius: 10px; height: 100%; color: white">
                                                    <div class="row" style="height: 100px; text-align: center">
                                                        <div class="col-12" style="font-size: 50px">
                                                            <i class="fa-solid fa-clock-rotate-left"></i>
                                                        </div>
                                                    </div>

                                                    <div class="row" style="text-align: center; font-size: 17px">
                                                        <div class="col-12">
                                                            <strong>@(Model?.CmsLanguage.GetValue(LanguageKeys.LastCompletedItems.LastCompleted, "Last completed") ?? "Last completed")</strong>
                                                            <br />
                                                            @(Model?.CmsLanguage.GetValue(LanguageKeys.LastCompletedItems.Tasks, "tasks") ?? "tasks")
                                                        </div>
                                                    </div>
                                                </div>
                                            </a>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</section>

<partial name="~/Views/Shared/_auditing_history.cshtml" model="@(new AuditingLogViewModel { ItemType="task",TemplateId=Model.CurrentTaskTemplate.Id, EnablingAuditing = Model.EnablingAuditing})" />

<div role="dialog" tabindex="-1" class="modal fade h-100" data-backdrop="static" id="editTemplateStepDetailModal">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered" role="document">
        <div class="modal-content" id="editStepModalContent">
            <div class="modal-header">
                <h4 class="modal-title">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.InstructionTitle, "Instruction") ?? "Instruction") (1/3)</h4>
            </div>

            <div class="modal-body">
                <div id="fileSizeAlert-intruction" class="alert alert-danger d-none">
                    @(Model?.CmsLanguage?.GetValue(LanguageKeys.FrameWork.FileSizeTooBig, "File size for this media file is too big!") ?? "File size for this media file is too big!")
                    <button type="button" class="close" onclick="$(this).closest('div.alert').hide()" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <div class="row">
                    <div id="instructionDropZone" data-drop="true" class="col-12">
                        <img id="stepImage" src="@Constants.General.ImageUnavailableUrl" style="width:100%;object-fit: cover; object-position: center; height:20rem;border-radius: 5px;" class="img-fluid w-100" />
                        <div class="controls" style="position:absolute;bottom:0px;">
                            <input class="d-none" type="file" accept="video/*,image/*" id="uploaderItemStep" name="photo" onchange="ezgolist.previewFileEx(this);" onclick="this.value=null" data-preview="#stepImage" data-templateid="0" data-templatestepid="0" data-type="instruction" required>
                            <a href="#" onclick="$('#uploaderItemStep').trigger('click'); return false;">
                                <div class="border rounded-circle float-right d-lg-flex justify-content-lg-center shadow main-image-pencil">
                                    <i class="fa fa-paperclip d-lg-flex justify-content-center align-items-center align-content-center" style="font-size: 20px;"></i>
                                </div>
                            </a>

                            <a href="#" data-selector="deletemedia" data-type="step">
                                <div class="border rounded-circle float-left d-lg-flex justify-content-lg-center shadow main-image-pencil">
                                    <i class="fa fa-trash d-lg-flex justify-content-center align-items-center align-content-center" style="font-size: 20px;"></i>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <div class="form-group w-100">
                            <textarea id="txtStepDescription" class="form-control-sm form-control" placeholder="@(Model?.CmsLanguage?.GetValue(LanguageKeys.Checklist.InstructionDescPlaceholder, "Enter a description for the instruction...") ?? "Enter a description for the instruction...")"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <input type="hidden" id="currentTemplateItemStepId" />
                <button id="btnDeleteStep" class="btn btn-danger btn-sm mr-auto" type="button" data-stepid="0" onclick="ezgolist.deleteItemStep()">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.DialogDelete, "Delete") ?? "Delete")</button>
                <button class="btn btn-light" type="button" onclick="ezgolist.previousTemplateStep()">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.DialogPrevStep, "previous step") ?? "previous step")</button>
                <button type="button" class="btn btn-ezgo btn-sm" data-dismiss="modal">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.DialogClose, "close") ?? "close")</button>
                <button class="btn btn-light" type="button" onclick="ezgolist.nextTemplateStep()">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.DialogNextStep, "next step") ?? "next step")</button>
            </div>
        </div>
    </div>
</div>

@if (Model.ApplicationSettings?.Features?.TemplateSharingEnabled == true)
{
    <partial name="~/Views/Shared/_template_sharing_modal.cshtml" model="@(new TemplateSharingViewModel{ CmsLanguage = Model.CmsLanguage, Companies = Model.CompaniesInHolding })" />
}

<!-- Modal -->
<div class="modal fade" id="AddWorkInstructionModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="exampleModalLongTitle">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.AvailableWorkInstrucitons, "Available workinstructions") ?? "Available workinstructions")</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body">
                <div class="row m-1"><input type="text" id="searchworkinstructions" name="searchworkinstructions" placeholder="@(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.Search, "Search") ?? "Search")" class="form-control" data-action="search_workinstructions" /></div>
                <div id="AddWorkInstructionModalBody">
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal" data-action="close">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.BtnClose, "Close") ?? "Close")</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal add link to task template -->
@if (Model.TaskTemplateAttachmentsEnabled == true)
{
    <div class="modal" id="AddTaskTemplateLinkAttachmentModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.ItemAddLinkModalTitle, "Add link to task template") ?? "Add link to task template")</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <div class="modal-body">
                    <p>@(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.ItemAddLinkModalInsertLinkHere, "Insert link here: ") ?? "Insert link here: ")</p>
                    <input id="AddTaskTemplateLinkAttachmentInput" class="form-control form-control-sm" type="url" placeholder="https://www.ezfactory.nl/" required />
                    <div id="TaskTemplateLinkAttachmentInvalidError" style="display: none">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.ItemAddLinkModalValidationError, "The URL that you entered is invalid.") ?? "The URL that you entered is invalid.")</div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-ezgo" onclick="ezgolist.addLinkAttachmentToTaskTemplate()">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.ItemAddLinkModalSaveChanges, "Save changes") ?? "Save changes")</button>
                    <button type="button" class="btn btn-light" data-dismiss="modal">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.ItemAddLinkModalClose, "Close") ?? "Close")</button>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script src="/js/deeplink.js"></script>
    <script src="/js/ezgoprops.js"></script>
    <script src="/js/ezgolist.js"></script>
    <script src="/js/ezgoUtils.js"></script>

    @if (Model.ApplicationSettings.Features.AnalyticsEnabled.HasValue && Model.ApplicationSettings.Features.AnalyticsEnabled.Value)
    {
        <script src="~/js/analytics.js"></script>
        <script>ezgoAnalytics.init('task');</script>
    }

    <script>
        ezgolist.workInstructionsEnabled = @(Json.Serialize(Model.ApplicationSettings.Features.WorkInstructions != null && Model.ApplicationSettings.Features.WorkInstructions.Value));
        ezgolist.taskTemplateAttachmentsEnabled = @(Json.Serialize(Model.TaskTemplateAttachmentsEnabled));
        ezgolist._isNewTemplate = @(Json.Serialize(Model.IsNewTemplate));
        ezgolist.currentWorkInstructionTemplates = @Html.Raw(Model.WorkInstructions.ToJsonFromObject());
        ezgolist.sharedTemplateId = @(Model.SharedTemplateId);
        ezgolist.getListUrl = @(Model.SharedTemplateId > 0 ? Html.Raw("'/task/getsharedtemplate/'") : Html.Raw("'/task/gettemplate/'"));
        ezgolist.placeholderImageUrl = '@(Constants.General.ImageUnavailableUrl)';
        ezgolist.mediaUrl = '@(string.IsNullOrEmpty(Model.ApplicationSettings?.MediaLocations?.ImageMediaBaseUri) ? Constants.General.MediaUrl : Model.ApplicationSettings?.MediaLocations?.ImageMediaBaseUri)';

        ezgolist.language = {
            listtype: '',
            listtypeId: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.TaskId, "task ID") ?? "task ID")))',
            addItem: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.InstructionAddItem, "Add task item").Replace("{{listtype}}", "task") ?? "Add task item")))',
            addItemLower: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.InstructionAddItemLower, "add item") ?? "add item")))',
            nextItem: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.InstructionNextItem, "next item") ?? "next item")))',
            addpdf: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.ItemAddPdf, "Add PDF") ?? "Add PDF")))',
            addlink: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.ItemAddLink, "Add link") ?? "Add link")))',
            assignButton: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.Checklist.AssignButton, "Assign") ?? "Assign")))',
            addinstruction: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.AddInstruction, "Add instruction") ?? "Add instruction")))',
            addworkinstruction: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.AddWorkInstruction, "Add workinstruction") ?? "Add workinstruction")))',
            addStep: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.DialogAddStep, "add step") ?? "add step")))',
            nextStep: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.DialogNextStep, "next step") ?? "next step")))',
            confirmationleavemessage: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.ConfirmationLeaveMessage, "It looks like you have been editing something.If you leave before saving, your changes will be lost.") ?? "It looks like you have been editing something.If you leave before saving, your changes will be lost.")))',
            ppEnable: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.PictureProof.Enable, "Enable") ?? "Enable")))',
            ppDisable: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.PictureProof.Disable, "Disable") ?? "Disable")))',
            ppForAllItems: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.PictureProof.PictureProofForAllItems, "picture proof for all items?") ?? "picture proof for all items?")))',
            instructionCounterLabel: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.EzgoList.ItemCounterLabel, "Instruction") ?? "Instruction")))',
            sharingSuccess: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.Shared.SharingSuccess, "picture proof for all items?") ?? "picture proof for all items?")))',
            sharingFailed: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.Shared.SharingFailed, "picture proof for all items?") ?? "picture proof for all items?")))',

            optionYes: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage.GetValue(LanguageKeys.Action.OptionYes, "Yes") ?? "Yes")))',
            optionNo: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage.GetValue(LanguageKeys.Action.OptionNo, "No") ?? "No")))',

            deleteAuditItem: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.EzgoList.DeleteAuditItem, "Delete audit item?") ?? "Delete audit item?")))',
            deleteChecklistItem: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.EzgoList.DeleteChecklistItem, "Delete checklist item?") ?? "Delete checklist item?")))',
            deleteWorkInstructionItem: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.EzgoList.DeleteWorkInstructionItem, "Delete workinstruction item?") ?? "Delete workinstruction item?")))',

            deleteAuditInstruction: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.EzgoList.DeleteAuditItemInstruction, "Delete instruction from this audit item?") ?? "Delete instruction from this audit item?")))',
            deleteChecklistInstruction: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.EzgoList.DeleteChecklistItemInstruction, "Delete instruction from this checklist item?") ?? "Delete instruction from this checklist item?")))',
            deleteTaskInstruction: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.EzgoList.DeleteTaskInstruction, "Delete instruction from this task?") ?? "Delete instruction from this task?")))',

            deleteAuditTemplate: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.EzgoList.DeleteAuditTemplate, "Delete this audit template?") ?? "Delete this audit template?")))',
            deleteChecklistTemplate: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.EzgoList.DeleteChecklistTemplate, "Delete this checklist template?") ?? "Delete this checklist template?")))',
            deleteSkillAssessmentTemplate: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.EzgoList.DeleteSkillAssessmentTemplate, "Delete this skillassessment template?") ?? "Delete this skillassessment template?")))',
            deleteTaskTemplate: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.EzgoList.DeleteTaskTemplate, "Delete this task template?") ?? "Delete this task template?")))',
            deleteWorkInstructionTemplate: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.EzgoList.DeleteWorkInstructionTemplate, "Delete this workinstruction template?") ?? "Delete this workinstruction template?")))'
        };

        ezgolist.init(
            @Model.CurrentTaskTemplate?.Id,
            @Model.CurrentTaskTemplate?.CompanyId,
            'task',
            @Model.PropertyStructureVersion
        );

        ezgoprops.language = {
            addproperty: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.Task.BtnAddProperty, "Add property") ?? "Add property")))'
        };

        ezgoprops.init({
            proptype: 'task',
            templateid: @Model.CurrentTaskTemplate?.Id,
            propertiesEnabled: @(Model.ApplicationSettings != null && Model.ApplicationSettings.Features != null && Model.ApplicationSettings.Features.AuditsPropertyValueRegistrationEnabled.HasValue ? Model.ApplicationSettings.Features.AuditsPropertyValueRegistrationEnabled.Value.ToString().ToLower() : false.ToString().ToLower()),
            propertyStructureVersion: @Model.PropertyStructureVersion
        });

        $('body').on('ezgolistChanged', function (e) {
            if (ezgolist._hasChanged) {
                $('.btn-disabled-during-changes').attr('disabled', 'disabled')
            }
            else {
                $('.btn-disabled-during-changes').removeAttr('disabled');
            }
        });

        function printTaskTemplate() {
            var t = $('#itemlist li').eq(15).append('<div style="height:170px;page-break-after: always !important;page-break: always !important;" class="pagebreak"></div>');
            var result = $('ul.list-group li.active').map(function (i, opt) {
                return $(opt).text();
            }).toArray().join(' -> ');

            $("#mainCol").animate({ scrollTop: $('#mainCol').prop("scrollHeight") }, 1000);
            $('#areaprintlist').text(': ' + result);
            $('#mainCol').css('height', 'auto !important');
            $('.content-wrapper').removeClass('main-bg-color');
            $('.main-footer').hide();

            setTimeout(function () {
                window.print();
                t.remove();
                $('.content-wrapper').addClass('main-bg-color');
                $('#mainCol').css('height', 'height:calc(100vh - 175px)');
                $('#areaprintlist').text('');
                $('#mainCol').scrollTop(0);
            }, 1000);
        }

        deeplink.init();

        // Start Recurrency
        // set day-all-shifts checkbox state
        function checkshift(shiftname) {
            var $master = $('input[data-master = ' + shiftname + ']');
            var $masterParent = $master.closest('li.shiftday');
            var masterid = $master.prop('id');
            var checked = $masterParent.find('input[data-slave = ' + masterid + ']:checked').length;
            var present = $masterParent.find('input[data-slave = ' + masterid + ']').length

            $master.prop('indeterminate', false);

            if (checked == present) {
                $master.prop('checked', true);
            } else if (checked == 0) {
                $master.prop('checked', false);
            } else {
                $master.prop('indeterminate', true);
            }

            updatecheckboxallshifts();
        }

        function updatecheckboxallshifts() {
            var allshifts = $('input[data-master = all-shifts]');
            var daysParent = $("#shiftlist");
            var dayschecked = daysParent.find('input[data-slave = all-shifts]:checked').length;
            var daysindeterminate = daysParent.find('input[data-slave = all-shifts]:indeterminate').length;
            var daystotal = daysParent.find('input[data-slave = all-shifts]').length;

            allshifts.prop('indeterminate', false);

            if (dayschecked == daystotal) {
                allshifts.prop('checked', true);
            } else if (dayschecked + daysindeterminate == 0) {
                allshifts.prop('checked', false);
            } else {
                allshifts.prop('indeterminate', true);
            }
        }

        function setonlyonceshift(fromdateName, uncheck = true) {
            $('input[id*=_shiftname][value*=_once]').closest('li.shiftday').addClass('d-none');
            $('input[id*=_shiftname][value=' + fromdateName + '_once]').closest('li.shiftday').removeClass('d-none');
            if (uncheck) {
                $('input[data-group-id*="_once"]').prop('checked', false);
            }
        }

        function setonlyonceshiftfromdate(date, uncheck = true) {
            var weekdays = new Array(7);
            weekdays[0] = "sunday";
            weekdays[1] = "monday";
            weekdays[2] = "tuesday";
            weekdays[3] = "wednesday";
            weekdays[4] = "thursday";
            weekdays[5] = "friday";
            weekdays[6] = "saturday";

            var a = new Date(date);
            var r = weekdays[a.getDay()];

            setonlyonceshift(r, uncheck);
            resetallshiftcheckboxes();
        }

        //Post the recurrency and receive the json
        function postrecurrency(event) {
            //set recurrencyIsUpToDate to false in case template is saved before recurrency is set.
            ezgolist.recurrencyIsUpToDate = false;
            if (event != null) event.preventDefault();

            var frm = $('form#recurrence-form');
            var jqxhr = $.post(frm[0].action, frm.serialize(), function (data) {
                if (ezgolist.tmpl.AreaId != 'undefined') {
                    data.AreaId = ezgolist.tmpl.AreaId;
                };

                ezgolist.tmpl.Recurrency = data;
                ezgolist.tmpl.RecurrencyType = data.RecurrencyType
            }).fail(function (data) {
                data.responseJSON.forEach((error) => {
                    toastr.warning(error);
                });
            }).always(function () {
                //set ezgolist.recurrencyIsUpToDate to true and call ezgolist.tryDelayedSave() in case the ezgolist.save() function was called before the recurrency was set
                ezgolist.recurrencyIsUpToDate = true;
                ezgolist.tryDelayedSave();
            });
        }

        function resetallshiftcheckboxes() {
            $('li.shiftday').each(function () {
                var shiftname = $(this).find('input[data-shiftname = shiftname]').prop('value');
                checkshift(shiftname);
            });
        }

        function clearstartdate() {
            $('#Schedule_StartDate').prop('value', '');
            $('#startdateinput').prop('value', '');
            postrecurrency(null);
        }

        function clearenddate() {
            $('#Schedule_EndDate').prop('value', '');
            $('#enddateinput').prop('value', '');
            postrecurrency(null);
        }
        // End recurrency

        $('document').ready(function () {
            // START Recurrency
            // defaults

            ezgolist._hasChanged = false;
            resetallshiftcheckboxes();
            setonlyonceshiftfromdate(new Date(), false);

            $('input[type=radio][name*=MonthRecurrencyType]').each(function () {
                if ($(this).is(':checked')) {
                    $(this).closest('li').nextUntil('ul').toggleClass('li-hide');
                }
            });

            $('#specific_choosen_day').val($('#Schedule_Day').val());
            // end defaults

            //make a click on a (shift)day select all shifts for that day
            $(document).on('click', 'input.shiftmaster', function () {
                toggledayshifts(this);
                updatecheckboxallshifts();
            });

            //toggle all shifts for that day
            function toggledayshifts(control) {
                var $master = $(control);
                var $parent = $(control).closest('li.shiftday');
                var $children = $parent.find("input." + $master.prop('id'));

                $children.each(function () {
                    $(this).prop('checked', $master.is(':checked'));
                });
            }

            //set the state of a (shift)day checkbox when clicking a shift
            $(document).on('click', 'input.shift', function () {
                var shiftname = $(this).closest('.shiftday').find('input[id*=_shiftname]').val();
                checkshift(shiftname);
            });

            //click on all shifts to select every shift of every day
            $(document).on('click', 'input.all-shifts', function () {
                var $master = $(this);
                var $parent = $("#shiftlist");
                var $children = $parent.find("input.shiftmaster");

                $children.each(function () {
                    $(this).prop('indeterminate', false);
                    $(this).prop('checked', $master.is(':checked'));

                    toggledayshifts(this);
                });
            });

            // recurrency type select
            $(document).on('click', 'a.recurrency', function () {
                var recurrency = $(this).data('value');
                $('#RecurrencyType').prop('value', recurrency);
                $('#forever').removeClass('d-none');

                $('input[data-group-id^= Shifts]').prop('checked', false);
                ezgolist.tmpl.Recurrency.Shifts.length = 0;
                switch (recurrency) {
                    case "shifts":
                        break;

                    case "week":
                        break;

                    case "month":
                        if ($('#Schedule_Day').val() > 31) {
                            $('#specific_choosen_day').val(31); //default to max value in month
                            $('#Schedule_Day').val(31);
                        } else {
                            $('#specific_choosen_day').val($('#Schedule_Day').val());
                        }
                        break;

                    case "periodday":
                        $('#periode_day').val($('#Schedule_Day').val());
                        break;

                    case "dynamicday":
                        $('#dynamic_day').val($('#Schedule_Day').val());
                        break;

                    default:
                        $('#forever').addClass('d-none');
                        break;
                }
                resetallshiftcheckboxes();
            });

            // forever or fixed period
            $(document).on('click', 'input[name*=recurrence-options]', function () {
                var myvalue = $(this).prop('value');
                if (myvalue === 'forever') {
                    $('#Schedule_StartDate').prop('value', '');
                    $('#startdateinput').prop('value', '');
                    $('#Schedule_EndDate').prop('value', '');
                    $('#enddateinput').prop('value', '');
                }
            });

            $(document).on('change', 'select[id^=month]', function () {
                value = $(this).val();
                $('select[id^=month]').val(value);
            });

            $(document).on('change', 'select[id^=week]', function () {
                value = $(this).val();
                $('input[id^=week]').prop('value', value);
            });

            $(document).on('change', 'input[type=radio][name*=MonthRecurrencyType]', function () {
                $('input[type=radio][name*=MonthRecurrencyType]').not(this).closest('li').nextUntil('ul').toggleClass('li-hide');
                $(this).closest('li').nextUntil('ul').toggleClass('li-hide');
            });

            var startDateString = $('#Schedule_StartDate').prop('value');
            var startDateMomentObject = moment(startDateString, "YYYY/MM/DD"); // 1st argument - string, 2nd argument - format
            var startDateObject = startDateMomentObject.toDate(); // convert moment.js object to Date object

            //Single date picker
            $('#startdateinput').daterangepicker({
                singleDatePicker: true,
                startDate: isNaN(startDateObject) ? new Date() : startDateObject,
                showDropdowns: true,
                opens: 'center', drops: 'up',
                locale: {
                    format: 'DD-MM-YYYY',
                    firstDay: 1
                }
            },

                function (start, end, label) {
                    $('#Schedule_StartDate').prop('value', start.format('YYYY/MM/DD'));
                });


            $('#startdateinput').on('apply.daterangepicker', function (ev, picker) {
                $('#Schedule_StartDate').val(picker.startDate.format('YYYY/MM/DD'));

                postrecurrency(null);
            });

            if (isNaN(startDateObject)) {
                $('#startdateinput').prop('value', '');
                $('#Schedule_StartDate').prop('value', '');
            }

            var endDateString = $('#Schedule_EndDate').prop('value');
            var endDateMomentObject = moment(endDateString, "YYYY/MM/DD"); // 1st argument - string, 2nd argument - format
            var endDateObject = endDateMomentObject.toDate(); // convert moment.js object to Date object

            //Single date picker
            $('#enddateinput').daterangepicker({
                singleDatePicker: true,
                startDate: isNaN(endDateObject) ? new Date() : endDateObject,
                showDropdowns: true,
                opens: 'center', drops: 'up',
                locale: {
                    format: 'DD-MM-YYYY',
                    firstDay: 1
                }
            },

                function (start, end, label) {
                    $('#Schedule_EndDate').prop('value', start.format('YYYY/MM/DD'));
                });


            $('#enddateinput').on('apply.daterangepicker', function (ev, picker) {
                $('#Schedule_EndDate').val(picker.startDate.format('YYYY/MM/DD'));

                postrecurrency(null);
            });

            if (isNaN(endDateObject)) {
                $('#enddateinput').prop('value', '');
                $('#Schedule_EndDate').prop('value', '');
            }

            var dateString = $('#Schedule_Date').prop('value');
            var dateMomentObject = moment(dateString, "YYYY/MM/DD"); // 1st argument - string, 2nd argument - format
            var dateObject = dateMomentObject.toDate(); // convert moment.js object to Date object

            //Re-apply the date to find the day for the shifts if a date is present
            if (!isNaN(dateObject)) {
                setonlyonceshiftfromdate(dateObject, false);
                $('#Schedule_Date').prop('value', dateMomentObject.format('YYYY/MM/DD'));
            }

            //Single date picker
            $('#fromdate').daterangepicker({
                singleDatePicker: true,
                startDate: isNaN(dateObject) ? new Date() : dateObject,
                showDropdowns: true,
                opens: 'center', drops: 'up',
                locale: {
                    format: 'DD-MM-YYYY',
                    firstDay: 1
                }
            },

                function (start, end, label) {
                    $('#Schedule_StartDate').prop('value', start.format('YYYY/MM/DD'));
                    $('#Schedule_Date').prop('value', start.format('YYYY/MM/DD'));
                    // show the right shift(day)
                    setonlyonceshiftfromdate(start);
                });


            $('#fromdate').on('apply.daterangepicker', function (ev, picker) {
                $('#Schedule_StartDate').val(picker.startDate.format('YYYY/MM/DD'));
                $('#Schedule_Date').val(picker.startDate.format('YYYY/MM/DD'));

                postrecurrency(null);
            });

            // The post handler needs to be last in order as handlers fire in order of binding
            $(document).on('change', 'form#recurrence-form input, form#recurrence-form select', function () {
                postrecurrency(null);
            });

            // First time post so there is always a recurrency setting
            postrecurrency(null);

            // END Recurrency

            $('#instructions').hide();
            $("#instructionlist").sortable({
                placeholder: "ui-state-highlight",
                cancel: ".add-button",
                delay: 250,
                opacity: 0.6,
                tolerance: "pointer",
                forcePlaceholderSize: true,
                start: function (e, ui) {
                    $(this).attr('data-previndex', ui.item.index());
                },
                stop: function (ev, ui) {
                    var prevItem = $(ui.item.prev()[0]);
                    if (prevItem.hasClass("add-button"))
                        $(this).sortable("cancel");
                },
                update: function (e, ui) {
                    var newIndex = ui.item.index();
                    var oldIndex = $(this).attr('data-previndex');
                    $.utils.arrayMove(ezgolist.tmpl.Steps, oldIndex, newIndex);
                    $(this).removeAttr('data-previndex');
                }
            });

        });

        function downloadPdf(id) {
            if (id == 0) {
                id = ezgolist.tmpl.Id;
                if (id == 0) {
                    toastr.warning('Something went wrong. Please reload the template and try again.');
                    return;
                }
            }

            @if (Model.ApplicationSettings.Features.AnalyticsEnabled.HasValue && Model.ApplicationSettings.Features.AnalyticsEnabled.Value)
            {
                @:dataEntry = ezgoAnalytics.dataSpanStart("generate pdf", "task");
            }

            var newtab = window.open('/pdf/render/2/' + id, "_blank");//, "noopener noreferrer")

            @if (Model.ApplicationSettings.Features.AnalyticsEnabled.HasValue && Model.ApplicationSettings.Features.AnalyticsEnabled.Value)
            {
                @:newtab.addEventListener("unload", function () { ezgoAnalytics.dataSpanEnd(dataEntry); });
            }
                                                        }

        function reindexAllProperties() {
            let counter = 0;
            var props = [];

            $('[data-selector="property"]:visible').each(function () {
                let currentIndex = $(this).attr('data-index');

                var prop = ezgoprops._template.Properties.find(prop => prop.PropertyId == +$(this).attr('data-propid') && prop.Index == ((+$(this).attr('data-index'))));
                props.push(prop);

                if (counter != currentIndex) {
                    $(this).attr('data-index', counter);
                }
                counter = counter + 1;
            });

            //reindex properties
            for (let i = 0; i < props.length; i++) {
                props[i].Index = i;
            }

            ezgoprops._template.Properties = props;
        };

        $('#valueProps').sortable({
            items: "li:not(.ui-state-disabled)"
        });

        $("#valueProps li").disableSelection();

        $('#valueProps').on('sortupdate', function (event, ui) { reindexAllProperties(); });

        function noClick(event, element) {
            event.stopPropagation;
        }

        $(document).ready(function () { if (('#txtTemplateName') != null) { setTimeout(function () { $('#txtTemplateName').focus(); }, 500); } });
    </script>
}