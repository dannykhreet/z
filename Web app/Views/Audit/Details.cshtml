@model WebApp.ViewModels.AuditViewModel
@{
    var tz = User.FindFirst(System.Security.Claims.ClaimTypes.Country)?.Value ?? "Europe/Amsterdam";
    TimeZoneInfo timezone = TZConvert.EzFindTimeZoneInfoById(tz);
    Layout = "_Layout_template";
    ViewData["Title"] = Model?.CmsLanguage.GetValue(LanguageKeys.Audit.AuditDetailsTitle, "Audit details") ?? "Audit details";
    var picture = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, Model.CurrentAudit.Picture);
    if (string.IsNullOrEmpty(Model.CurrentAudit.Picture))
    {
        picture = @"/assets/img/normal_unavailable_image.png";
    }
}

@section CSS{
<style>
    #instructions {
    top: 0px;
    position: absolute;
    z-index: 3;
    }

    label[disabled] {
    pointer-events: none;
    }

    .card {
    margin-bottom: 0px !important;
    }

    .customArrow {
    width: 100%;
    position: absolute;
    height: 0px;
    width: 0px;
    display: block;
    transition: top 200ms;
    border-bottom: 20px #93C54B solid;
    border-left: 20px transparent solid;
    border-right: 20px transparent solid;
    margin-top: -21px;
    }

    .pencil-action {
    height: 45px;
    width: 45px;
    margin-top: 15px;
    margin-right: 15px;
    font-size: 25px;
    color: #364c59;
    cursor: pointer;
    }

    .pencil-action svg {
    margin-top: 3px;
    margin-left: 11px;
    }

    .modal {
    padding: 0 !important;
    }

    .value-placeholder {
    height: 70px;
    border: 1px dashed #fff;
    width: 115px;
    margin: 10px 15px 0px 0px;
    cursor: pointer;
    }

    .value-placeholder span {
    font-weight: 700;
    font-size: 1.2rem;
    }

    .value-placeholder.active {
    border: solid 1px silver;
    background-color: lightgray;
    }

    .paperclip {
    height: 160px;
    background-color: #8ea968;
    text-align: center;
    color: #fff;
    }

    .paperclip i {
    margin-top: 25px;
    }

    .paperclip i::after {
    display: block;
    font-size: 26px;
    font-style: normal;
    font-weight: 600;
    }

    .addclip {
    height: 130px;
    text-align: center;
    color: #93C54B;
    cursor: pointer;
    }

    .addclip:hover {
    border: dashed 1px #93C54B;
    background-color: #93c54b1f;
    border-radius: 10px;
    }

    .addclip i {
    margin-top: 30px;
    }

    .addclip i::after {
    display: block;
    font-size: 26px;
    font-style: normal;
    font-weight: 600;
    }

    .addvalue {
    height: 70px;
    text-align: center;
    color: #93C54B;
    cursor: pointer;
    width: 115px;
    }

    .addvalue i {
    margin-top: 20px;
    }

    .addvalue i::after {
    display: block;
    font-size: 26px;
    font-style: normal;
    font-weight: 600;
    }

    .nav-pills .nav-link.active, .nav-pills .show > .nav-link {
    color: #fff;
    background-color: #93C54B;
    }

    .nav-pills .nav-link:not(.active):hover {
    color: #93C54B;
    }

    @@media print {
    .pagebreak {
    page-break-after: always !important;
    break-after: always !important;
    }

    #mainCol {
    display: block !important;
    position: relative !important;
    width: auto !important;
    height: auto !important;
    overflow: visible !important;
    margin-left: 0 !important;
    }

    .content-wrapper {
    background-color: #fff !important;
    }
    }

    .itemlist .card {
    width: 12rem;
    }

    .itemlist .card .card-body {
    font-size: 9.5pt;
    color: #6c757d !important;
    }

    .itemlist .card .card-body p {
    padding-bottom: 0px;
    }

    .itemlist .card:hover {
    box-shadow: 0 .5rem 1rem rgba(0,0,0,.15) !important;
    }

    v.list-inline-item {
    padding: 5px;
    }

    .controls {
    position: absolute;
    bottom: 0px;
    margin: 15px;
    }

    .main-image-pencil {
    background: #93c54b;
    width: 35px;
    height: 35px;
    margin: 10px;
    opacity: 0.8;
    z-index: 1;
    color: #fff;
    border: solid 1px #333333 !important;
    cursor: pointer;
    }

    .main-image-pencil i {
    width: 35px;
    height: 33px;
    position: relative;
    display: flex;
    }

    .main-image-pencil:hover {
    border: solid 1px #fff !important;
    }

    .itemlist .pencil {
    background: #333333;
    width: 35px;
    height: 35px;
    margin: 10px;
    opacity: 0.8;
    z-index: 1;
    position: absolute;
    left: 70px;
    top: 105px;
    color: #fff;
    border: solid 1px #333333 !important;
    cursor: pointer;
    }

    .itemlist .pencil i {
    width: 35px;
    height: 33px;
    position: relative;
    display: flex;
    }

    .itemlist .pencil:hover {
    border: solid 1px #fff !important;
    }

    .itemlist .ui-state-highlight {
    height: 240px;
    line-height: 1.2em;
    width: 12rem;
    margin-right: 22px;
    background-color: rgba(241,241,241,0.52) !important;
    border: dashed 1px rgb(191,191,191);
    margin-top: 6px;
    }

    .itemlist .valuePropHolder {
    width: 100px;
    height: 60px;
    border-radius: 6px;
    float: left;
    margin-right: 18px;
    border: 1px solid rgb(214,214,214);
    }

    .itemlist .card-link {
    position: relative;
    display: flex;
    height: 160px;
    margin: -1px;
    border: solid 1px rgba(0,0,0,0);
    }

    .itemlist .card-link img {
    object-fit: cover;
    width: 100%;
    height: 160px;
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
    }

    #editStepModalContent img.main-img {
    border-radius: 5px;
    border: solid 1px #ced4da;
    }

    #editStepModalContent2 img.main-img {
    border-radius: 5px;
    border: solid 1px #ced4da;
    }

    .btn-light:not(:disabled):not(.disabled).active, .btn-light:not(:disabled):not(.disabled):active, .show > .btn-light.dropdown-toggle {
    color: #fff !important;
    background-color: #93C54B;
    border-color: #d3d9df;
    }

    .tpl {
    display: none;
    }

    .list-group-item:last-child {
    margin-bottom: 0;
    border-bottom-right-radius: 0rem;
    border-bottom-left-radius: 0rem;
    }

    .popover {
    border: 0;
    box-shadow: rgba(0, 0, 0, 0.125) 0px 0px 1px 0px, rgba(0, 0, 0, 0.2) 0px 1px 3px 0px;
    }

    .custom-control-input:checked ~ .custom-control-label::before,
    .custom-control-input:indeterminate ~ .custom-control-label::before {
    background-color: #93C54B;
    border-color: #93c54b1f;
    }

    .custom-control-input:checked ~ .custom-control-label::before {
    color: #fff;
    border-color: #93c54b1f;
    background-color: #93C54B;
    box-shadow: none;
    }

    div.custom-control-right {
    padding-right: 24px;
    padding-left: 0;
    margin-left: 0;
    margin-right: 0;
    }

    div.custom-control-right .custom-control-label::after {
    right: -1.5rem;
    left: auto;
    }

    div.custom-control-right .custom-control-label::before {
    right: -2.35rem;
    left: auto;
    }
    
        .btn-light.disabled.active {
            color: #fff !important;
            background-color: #93C54B;
            border-color: #d3d9df;
            opacity: .65;
            box-shadow: none;
            cursor: not-allowed;
        }
</style>
}

<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                @if (Model.SharedTemplateId > 0)
                {
                    <a asp-controller="inbox" asp-action="index"><i class="fa fa-arrow-left"></i> @(Model?.CmsLanguage?.GetValue(LanguageKeys.Shared.NavBackToInboxTitle, "Back to inbox") ?? "Back to inbox")</a>
                } 
                else
                {
                    <a asp-controller="audit" asp-action="index"><i class="fa fa-arrow-left"></i> @(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.NavBackTitle, "Back to audit overview") ?? "Back to audit overview")</a>
                }
                <h1>@(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.OverviewTitle, "Audit details") ?? "Audit details")</h1>
            </div>

            @{
                var deleteButtonTitle = "";
                if(Model.ConnectedTaskTemplateIds != null && Model.ConnectedTaskTemplateIds.Count > 0)
                {
                    deleteButtonTitle = "Can't delete Audit Template because it is connected to Task Template(s).";
                }
            }

            <div class="col-sm-6 d-flex  flex-row-reverse">
                <button id="btnSaveTemplate" class="btn btn-ezgo btn-sm mr-2 shadow-sm mt-auto" onclick="ezgolist.save()" data-tracking="enabled" data-tracking-name="save">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.BtnSave, "Save") ?? "Save")</button>
                <form id="frmDelete" method="post" action='/audit/delete/@Model?.CurrentAudit?.Id' class="mt-auto">
                    <button type="button" id="btnDeleteTemplate" class="btn btn-danger btn-sm mr-2 shadow-sm mt-auto" 
                    title="@deleteButtonTitle"
                    @(Model.CurrentAudit.Id == 0 || (Model.ConnectedTaskTemplateIds != null && Model.ConnectedTaskTemplateIds.Count > 0) ? "disabled=\"disabled\"" : "") 
                    onclick="ezgolist.delete()" data-tracking="enabled" data-tracking-name="delete">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.BtnDelete, "Delete") ?? "Delete")</button>
                </form>

                <form id="frmDuplicate" method="post" action='/audit/duplicate/@Model?.CurrentAudit?.Id' class="mt-auto">
                    <button type="button" id="btnDuplicateTemplate" class="btn btn-ezgo btn-sm btn-outline mr-2 shadow-sm mt-auto btn-disabled-during-changes" onclick="ezgolist.duplicate()" data-tracking="enabled" data-tracking-name="duplicate">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.BtnDuplicate, "Duplicate") ?? "Duplicate")</button>
                </form>

                @if (Model.ApplicationSettings?.Features?.TemplateSharingEnabled == true)
                {
                    <button id="btnShareTemplate" data-type="audit" data-templateid="@Model.CurrentAudit.Id" class="btn btn-ezgo btn-sm mr-2 shadow-sm mt-auto btn-disabled-during-changes" onclick="$('#template-share-modal').modal('show')">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Shared.ShareButtonTitle, "Share") ?? "Share")</button>
                }                

                @if(Model.SharedTemplateId > 0)
                {
                    <button class="btn btn-ezgo btn-sm btn-outline mr-2 shadow-sm mt-auto" disabled="disabled"><i class="fa fa-print"></i></button>
                }
                else
                {
                    <button class="btn btn-ezgo btn-sm btn-outline mr-2 shadow-sm mt-auto btn-disabled-during-changes" @(Model.CurrentAudit.Id == 0 ? "disabled=\"disabled\"" : "") onclick="window.open('/pdf/viewer/audittemplate/@(Model.CurrentAudit.Id)', '_blank', 'toolbar=no,top=10,left=10,width=' + (screen.availWidth-10) + ',height=' + (screen.availHeight-10) + '');" data-tracking="enabled" data-tracking-name="create pdf"><i class="fa fa-print"></i></button>
                }

                @if (Model.ApplicationSettings != null && Model.ApplicationSettings.Features != null && Model.ApplicationSettings.Features.QRCode.Value)
                {
                    <button id="btnGenerateQRCode" disabled="disabled" data-areaid="@Model.CurrentAudit.AreaId" data-type="audit" data-templateid="@Model.CurrentAudit.Id" class="btn btn-ezgo btn-sm mr-2 shadow-sm mt-auto" onclick="generateQRCode(this)">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Shared.GenerateQRCode, "Generate QR Code") ?? "Generate QR Code")</button>
                }

                
                @if (Model.EnableJsonExtraction) //enable json extraction, for now 
                {
                    <partial name="~/Views/Shared/_extraction_data.cshtml" model="Model.ExtractionData" />
                }
            </div>
        </div>
    </div>
</section>

<section class="content">
    <div style="height:calc(100vh - 175px);overflow:auto;">
        <div class="container-fluid">
            <div id="mainCol" class="row pt-1" style="height:calc(100vh - 180px);overflow:auto;">
                <div class="col-md-12">
                    <div class="col-12 p-0 pb-3">
                        <div id="fileSizeAlert-template" class="alert alert-danger d-none">
                            @(Model?.CmsLanguage.GetValue(LanguageKeys.FrameWork.FileSizeTooBig, "File size for this media file is too big!") ?? "File size for this media file is too big!")
                            <button type="button" class="close" onclick="$(this).closest('div.alert').hide()" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>

                        <div class="row card-group">
                            <div class="col-sm-4 col-md-5">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div id="templateDropZone" data-drop="true" class="card h-100" style="width:100%;height:238px;display:flex;border-radius: 5px;">
                                            <a href="/images/media-loading.gif" data-href="@picture" data-fancybox="items" data-caption="">
                                                <img id="TemplateImage" src="/images/media-loading.gif" data-src="@picture" style="width:100%;object-fit: cover; object-position: center; height:24.5rem;border-radius: 5px;" class="img-fluid" alt="..."  >
                                            </a>

                                            <div class="controls d-print-none" style="position:absolute;bottom:0px;">
                                                <input class="d-none" type="file" id="uploaderTemplate" accept="image/*" name="photo" onchange="ezgolist.previewFileEx(this);" onclick="this.value=null" data-preview="#TemplateImage" data-templateid="0" data-type="template" required>
                                                <a href="#" onclick="$('#uploaderTemplate').trigger('click'); return false;">
                                                    <div class="border rounded-circle float-right d-lg-flex justify-content-lg-center shadow main-image-pencil">
                                                        <i class="fa fa-paperclip d-lg-flex justify-content-center align-items-center align-content-center" style="font-size: 20px;"></i>
                                                    </div>
                                                </a>

                                                <a href="#" data-selector="deletemedia" data-type="template">
                                                    <div class="border rounded-circle float-left d-lg-flex justify-content-lg-center shadow main-image-pencil">
                                                        <i class="fa fa-trash d-lg-flex justify-content-center align-items-center align-content-center" style="font-size: 20px;"></i>
                                                    </div>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-sm-8 col-md-7">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <small data-type="cid" class="card-subtitle mb-2 text-muted">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.AuditId, "Audit ID") ?? "Audit ID"): </small>
                                        <div style="float:right">
                                            <small id="changedOn" class="card-text text-muted">
                                                @if (Model.CurrentAudit != null && Model.CurrentAudit.ModifiedAt != null)
                                                {
                                                    @((Model?.CmsLanguage?.GetValue(LanguageKeys.Auditing.LastModifiedAt, "Last modified on ") ?? "Last modified on ") + Model.CurrentAudit.ModifiedAt)
                                                }
                                            </small>
                                        </div>

                                        <div class="row mx-0">
                                            @if (Model != null && Model.ApplicationSettings != null && Model.ApplicationSettings.Features != null && Model.ApplicationSettings.Features.RequiredProof.Value)
                                            {
                                                <div class="col px-0">
                                                    <input type="text" class="form-control form-control-sm" maxlength="240" id="txtTemplateName" name="txtTemplateName" onblur="ezgolist.setDetails(this)" placeholder="@(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.TemplateNamePlaceholder, "Enter a title for this audit") ?? "Enter a title for this audit")" />
                                                </div>

                                                <div class="col-auto pl-2">
                                                    <div class="custom-control custom-switch">
                                                        <input type="checkbox" class="custom-control-input" id="enablePictureProofForAllItems">
                                                        <label style="font-weight: 400" class="custom-control-label card-text text-muted" for="enablePictureProofForAllItems">@(Model?.CmsLanguage?.GetValue(LanguageKeys.PictureProof.PictureProofTitle, "Picture Proof") ?? "Picture Proof")</label>
                                                    </div>
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="col-12 px-0">
                                                    <input type="text" class="form-control form-control-sm" maxlength="240" id="txtTemplateName" name="txtTemplateName" onblur="ezgolist.setDetails(this)" placeholder="@(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.TemplateNamePlaceholder, "Enter a title for this audit") ?? "Enter a title for this audit")" />
                                                </div>
                                            }
                                        </div>

                                        <div class="row pt-3">
                                            <div class="col-md-12 col-lg-12">
                                                <span class="card-text text-muted">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.SelectRoleTitle, "Select a role for this audit") ?? "Select a role for this audit")</span>
                                                <div class="btn-group btn-group-sm btn-group-toggle pt-1" data-toggle="buttons" style="display:flex;">
                                                    <label class="btn btn-light text-muted" style="flex:1;">
                                                        <input type="radio" name="role" id="role1" value="basic" onclick="ezgolist.setDetails(this)"> @(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.OptionBasic, "Basic user") ?? "Basic user")
                                                    </label>

                                                    <label class="btn btn-light text-muted" style="flex:1;">
                                                        <input type="radio" name="role" id="role2" value="shift_leader" onclick="ezgolist.setDetails(this)"> @(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.OptionShiftleader, "Shift leader") ?? "Shift leader")
                                                    </label>

                                                    <label class="btn btn-light text-muted" style="flex:1;">
                                                        <input type="radio" name="role" id="role3" value="manager" onclick="ezgolist.setDetails(this)"> @(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.OptionManager, "Manager") ?? "Manager")
                                                    </label>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row pt-3">
                                            <div class="col-md-12 col-lg-12">
                                                <span class="card-text text-muted">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.SelectSignatureTitle, "How many signatures are required at the end?") ?? "How many signatures are required at the end?")</span>
                                                <div class="btn-group btn-group-sm btn-group-toggle pt-1" data-toggle="buttons" style="display:flex;">
                                                    <label class="btn btn-light text-muted" style="flex:1;">
                                                        <input type="radio" name="signature" id="signature1" value="none" onclick="ezgolist.setDetails(this)"> @(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.OptionNone, "None") ?? "None")
                                                    </label>

                                                    <label class="btn btn-light text-muted" style="flex:1;">
                                                        <input type="radio" name="signature" id="signature2" value="single" onclick="ezgolist.setDetails(this)"> @(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.OptionOneSignature, "One signature") ?? "One signature")
                                                    </label>

                                                    <label class="btn btn-light text-muted" style="flex:1;">
                                                        <input type="radio" name="signature" id="signature3" value="double" onclick="ezgolist.setDetails(this)"> @(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.OptionTwoSignature, "Two signatures") ?? "Two signatures")
                                                    </label>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row pt-3">
                                            <div class="col-md-12 col-lg-12">
                                                <span id="scoringTitle" class="card-text text-muted">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.ScoringTitle, "Scoring System") ?? "Scoring System")</span>
                                                <div id="scoringControls" class="btn-group btn-group-sm btn-group-toggle" data-toggle="buttons" style="display:flex;">
                                                    <label class="btn btn-light text-muted" style="flex:1;">
                                                        <input type="radio" name="score" id="score1" value="thumbs" onclick="$('#scoreRangeSliderCon').addClass('d-none');ezgolist.setDetails(this)"> @(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.ScoringThumbsTitle, "Thumbs") ?? "Thumbs")
                                                    </label>

                                                    <label class="btn btn-light text-muted" style="flex:1;">
                                                        <input type="radio" name="score" id="score2" value="score" onclick="$('#scoreRangeSliderCon').removeClass('d-none');ezgolist.setDetails(this)">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.ScoringCustomTitle, "Custom scoring") ?? "Custom scoring")
                                                    </label>
                                                </div>

                                                <div id="scoreRangeSliderCon" class="mt-2 d-none">
                                                    <input type="text" data-disabled="true" class="js-range-slider" id="ScoreRangeSlider" name="my_range" value="" />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TAGS -->                    
                    @if (Model.ApplicationSettings.Features?.TagsEnabled == true)
                    {
                        <div class="col-12 p-0 pb-3" data-item="steps-view">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">@(Model.CmsLanguage?.GetValue(LanguageKeys.Tags.TagsMainTitle, "Tags") ?? "Tags")</h3>
                                </div>

                                <div class="card-body px-3 pb-3 pt-0">
                                    <partial name="_tags_block" model="Model.Tags" />
                                </div>
                            </div>
                        </div>
                    }

                    <!-- AUDIT ITEMS -->
                    <div class="col-12 p-0 pb-3" data-item="steps-view">
                        <div class="card">
                            <div class="card-header h5">
                                @(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.ItemsTitle, "Audit items") ?? "Audit items")
                            </div>

                            <div class="card-body p-3">
                                <ul id="itemlist" class="list-inline card-group pt3 itemlist"></ul>
                            </div>
                        </div>
                    </div>

                    <!-- AREAS -->
                    <div class="col-12 p-0 d-none">
                        <div class="card">
                            <div class="card-header h5">
                                @(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.AreaTitle, "Areas") ?? "Areas")
                            </div>

                            <div class="card-body p-0">
                                <div id="areas" class="d-flex clearfix" style="height:229px;">
                                    <partial name="~/Views/Config/_workingareas.cshtml" model="@Model.Areas" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 p-0 pb-3">
                        <div class="card">
                            <div class="card-header h5">
                                @(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.AreaTitle, "Areas") ?? "Areas")
                                <span id="areaprintlist"></span>
                            </div>

                            <div class="card-body p-0 d-print-none" style="overflow-x:auto;" id="areasScrollDiv">
                                <div id="areascard" class="d-flex clearfix" style="height:231px;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- OPEN FIELDS -->
                    @if (Model.ApplicationSettings.Features.AuditsPropertyEnabled.HasValue && Model.ApplicationSettings.Features.AuditsPropertyEnabled.Value)
                    {
                        <div class="col-12 p-0 pb-3">
                            <div class="card">
                                <div class="card-header h5">
                                    <div class="row">
                                        <div class="col-sm-6">@(Model?.CmsLanguage.GetValue(LanguageKeys.Audit.HeaderOpenFields, "Open fields") ?? "Open fields")</div>
                                        <div class="col-sm-6 d-flex flex-row-reverse"></div>
                                    </div>
                                </div>

                                <div class="card-body p-3 d-print-none" style="overflow-x:auto;">
                                    <div id="openfieldscard" class="d-flex clearfix">
                                        <div id="openfieldscard" class="d-flex clearfix">
                                            <div style="margin:5px;" id="openfields_container">
                                                <ul id="openfieldslist" class="list-inline card-group pt3 itemlist ui-sortable">
                                                    <li class="list-inline-item pb-3 d-print-none" data-containertype="add_open_field_container">
                                                        <div class="card h-100 shadow-sm" style="min-height: 100px; border: 1px solid #edebeb;" data-action="add_open_field">
                                                            <div class="card-body p-0 bigbutton-plus d-flex justify-content-center text-center addclip h-100">
                                                                <div class="h-100" style="color:#93C54B"><i class="fa fa-plus-circle fa-2x"></i><div>@(Model?.CmsLanguage.GetValue(LanguageKeys.Audit.AddOpenField, "Add open field") ?? "Add open field")</div></div>
                                                            </div>
                                                        </div>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Completed audits -->
                    @if(Model.CurrentAudit.Id > 0)
                    {
                        <div class="col-12 p-0 pb-3">
                            <div class="card">
                                <div class="card-header h5">
                                    <div class="row">
                                        <div class="col-sm-6">
                                            @(Model?.CmsLanguage.GetValue(LanguageKeys.Dashboard.StatsAuditCompletedTitle, "Completed audits") ?? "Completed audits")
                                        </div>
                                        <div class="col-sm-6"></div>
                                    </div>
                                </div>

                                <div class="card-body p-3" style="overflow-x:auto">
                                    <div class="row">
                                        @if (Model.CompletedAudits != null && Model.CompletedAudits.Count > 0)
                                        {
                                            var forLoopMaxI = Model.CompletedAudits.Count > 5 ? 5 : Model.CompletedAudits.Count;                                        
                                            for (int i = 0; i < forLoopMaxI; i++)
                                            {
                                                if (Model.CompletedAudits[i].Tasks != null)
                                                {
                                                    if (Model.CompletedAudits[i].ScoreType == "thumbs")
                                                    {
                                                        //ok, not ok, skipped
                                                        //example: conic-gradient( rgb(30, 215, 96) 0deg 120deg, rgb(237, 85, 84) 120deg 240deg, rgb(244, 194, 81) 240deg 360deg);
                                                        var totalCount = Model.CompletedAudits[i].Tasks.Count();

                                                        var okCount = Model.CompletedAudits[i].Tasks.Where(t => t.Status.ToLower() == "ok").Count();
                                                        var notOkCount = Model.CompletedAudits[i].Tasks.Where(t => t.Status.ToLower() == "not ok").Count();
                                                        var skippedCount = Model.CompletedAudits[i].Tasks.Where(t => t.Status.ToLower() == "skipped").Count();

                                                        var totalWeight = (Model.CurrentAudit.TaskTemplates != null && Model.CurrentAudit.TaskTemplates.Count > 0) ? Convert.ToDecimal(Model.CurrentAudit.TaskTemplates.Sum(t => t.Weight)) : Convert.ToDecimal(0);

                                                        var okTasks = Model.CompletedAudits[i].Tasks.Where(t => t.Status.ToLower() == "ok").ToList();
                                                        var okWeight = 0.0m;
                                                        if (okTasks.Count > 0)
                                                        {
                                                            if(Model.CurrentAudit.TaskTemplates != null && Model.CurrentAudit.TaskTemplates.Count > 0) {
                                                                foreach (var okTask in okTasks)
                                                                {
                                                                    var okTemplate = Model.CurrentAudit.TaskTemplates.Where(t => t.Id == okTask.TemplateId).FirstOrDefault();
                                                                    okWeight += Math.Round(okTemplate == null ? 1 : okTemplate.Weight, 2);
                                                                }
                                                            }

                                                        }

                                                        var notOkTasks = Model.CompletedAudits[i].Tasks.Where(t => t.Status.ToLower() == "not ok").ToList();
                                                        var notOkWeight = 0.0m;
                                                        if (notOkTasks.Count > 0)
                                                        {
                                                            if (Model.CurrentAudit.TaskTemplates != null && Model.CurrentAudit.TaskTemplates.Count > 0) { 
                                                                foreach (var notOkTask in notOkTasks)
                                                                {
                                                                    var notOkTemplate = Model.CurrentAudit.TaskTemplates.Where(t => t.Id == notOkTask.TemplateId).FirstOrDefault();
                                                                    notOkWeight += Math.Round(notOkTemplate == null ? 1 : notOkTemplate.Weight, 2);
                                                                }
                                                            }
                                                        }

                                                        var skippedTasks = Model.CompletedAudits[i].Tasks.Where(t => t.Status.ToLower() == "skipped").ToList();
                                                        var skippedWeight = 0.0m;
                                                        if (skippedTasks.Count > 0)
                                                        {
                                                            if (Model.CurrentAudit.TaskTemplates != null && Model.CurrentAudit.TaskTemplates.Count > 0)
                                                            {
                                                                foreach (var skippedTask in skippedTasks)
                                                                {
                                                                    var skippedTemplate = Model.CurrentAudit.TaskTemplates.Where(t => t.Id == skippedTask.TemplateId).FirstOrDefault();
                                                                    skippedWeight += Math.Round(skippedTemplate == null ? 1 : skippedTemplate.Weight, 2);
                                                                }
                                                            }

                                                        }

                                                        var testWeight = okWeight+notOkWeight+skippedWeight;
                                                        if (totalWeight <= testWeight)
                                                        {
                                                            totalWeight = testWeight;
                                                        }

                                                        var backgroundStyle = "conic-gradient(";
                                                        var backgroundStyles = new List<string>();
                                                        var lastAngle = 0m;

                                                        if(totalWeight > 0) {
                                                            if (okCount > 0)
                                                            {
                                                                var okDegrees = 360m * okWeight / totalWeight;
                                                                backgroundStyles.Add($"rgb(30, 215, 96) {Math.Round(lastAngle, 0)}deg {Math.Round(lastAngle + okDegrees, 0)}deg");
                                                                lastAngle += okDegrees;
                                                            }

                                                            if (notOkCount > 0)
                                                            {
                                                                var notOkDegrees = 360m * notOkWeight / totalWeight;
                                                                backgroundStyles.Add($"rgb(237, 85, 84) {Math.Round(lastAngle, 0)}deg {Math.Round(lastAngle + notOkDegrees, 0)}deg");
                                                                lastAngle += notOkDegrees;
                                                            }

                                                            if (skippedCount > 0)
                                                            {
                                                                var skippedDegrees = 360m * skippedWeight / totalWeight;
                                                                backgroundStyles.Add($"rgb(244, 194, 81) {Math.Round(lastAngle, 0)}deg {Math.Round(lastAngle + skippedDegrees, 0)}deg");
                                                                lastAngle += skippedDegrees;
                                                            }
                                                        }


                                                        backgroundStyle += string.Join(", ", backgroundStyles);
                                                        backgroundStyle += ");";

                                                        <style>
                                                            .completed-audit-donut-@i {
                                                            display: block;
                                                            vertical-align: middle;
                                                            border-radius: 100%;
                                                            width: 60px;
                                                            height: 60px;
                                                            position: absolute;
                                                            top: 50%;
                                                            left: 50%;
                                                            transform: translate(-50%, -50%);
                                                            background: @backgroundStyle;
                                                            font-size: 14px;
                                                            }

                                                            .completed-audit-donut-@i::after {
                                                            content: '@Model.CompletedAudits[i].TotalScore%';
                                                            display: flex;
                                                            align-items: center;
                                                            justify-content: center;
                                                            position: absolute;
                                                            width: 35px;
                                                            height: 35px;
                                                            background: rgb(241, 243, 240);
                                                            border-radius: 50%;
                                                            top: 50%;
                                                            left: 50%;
                                                            transform: translate(-50%, -50%);
                                                            }
                                                        </style>

                                                        <div class="col-sm-2 p-1">
                                                            <a href="/report/audit/completed?templateId=@Model.CurrentAudit.Id&auditId=@Model.CompletedAudits[i].Id" style="color: black; ">
                                                                <div class="m-1 p-2" style="background-color: rgb(241, 243, 240); border-radius: 10px; height: 100%">
                                                                    <div class="row" style="height: 100px">
                                                                        <div class="col-12">
                                                                            <div class="completed-audit-donut-@i"></div>
                                                                        </div>
                                                                    </div>

                                                                    <div class="row">
                                                                        <div class="col-12">
                                                                            <strong>@Model.CompletedAudits[i].Name</strong>
                                                                        </div>
                                                                    </div>

                                                                    @if (Model.CompletedAudits[i].Signatures != null && Model.CompletedAudits[i].Signatures.Count > 0)
                                                                    {
                                                                        <div class="row">
                                                                            <div class="col-12">
                                                                                @(
                                                                Model?.CmsLanguage?.GetValue(LanguageKeys.Dashboard.CompletedBy, "Completed by") ?? "Completed by"
                                                                ): @Model.CompletedAudits[i].Signatures?[0].SignedBy
                                                                            </div>
                                                                        </div>

                                                                        <div class="row">
                                                                            <div class="col-12">
                                                                                @{
                                                                                    DateTime SignedDate = TimeZoneInfo.ConvertTime(Model.CompletedAudits[i].Signatures[0].SignedAt.Value, timezone);
                                                                                }
                                                                                @SignedDate.ToLocaleFullDateShortTimeString(Model.Locale)
                                                                            </div>
                                                                        </div>
                                                                    }
                                                                </div>
                                                            </a>
                                                        </div>
                                                    }
                                                    else if(Model.CompletedAudits[i].ScoreType == "score")
                                                    {

                                                        //ok, not ok, skipped
                                                        //example: conic-gradient( rgb(30, 215, 96) 0deg 120deg, rgb(237, 85, 84) 120deg 240deg, rgb(244, 194, 81) 240deg 360deg);
                                                        //example: conic-gradient(scorecolorcalculatorColor 0deg 180deg, )
                                                        var scoreDegrees = Convert.ToInt32(Math.Round(360.0d * (Model.CompletedAudits[i].TotalScore / 100.0d), 0));

                                                        var backgroundStyle = "conic-gradient(";

                                                        if (scoreDegrees > 0)
                                                        {
                                                            var color = Model.PercentageScoreColorCalculator.GetColor(Model.CompletedAudits[i].TotalScore);
                                                            var rgbColor = "lightgray";
                                                            if(color == "bg-red")
                                                            {
                                                                rgbColor = "rgb(237, 85, 84)";
                                                            }
                                                            else if (color == "bg-warning")
                                                            {
                                                                rgbColor = "rgb(244, 194, 81)";
                                                            }
                                                            else if(color == "bg-green")
                                                            {
                                                                rgbColor = "rgb(30, 215, 96)";
                                                            }
                                                            backgroundStyle += $"{rgbColor} 0deg {scoreDegrees}deg, lightgray {scoreDegrees}deg 360deg";
                                                            backgroundStyle += ");";
                                                        }
                                                        else
                                                        {
                                                            backgroundStyle = "conic-gradient(lightgray 0deg 360deg)";
                                                        }

                                                        <style>
                                                            .completed-audit-donut-@i {
                                                            display: block;
                                                            vertical-align: middle;
                                                            border-radius: 100%;
                                                            width: 60px;
                                                            height: 60px;
                                                            position: absolute;
                                                            top: 50%;
                                                            left: 50%;
                                                            transform: translate(-50%, -50%);
                                                            background: @backgroundStyle;
                                                            font-size: 14px;
                                                            }

                                                            .completed-audit-donut-@i::after {
                                                            content: '@Model.CompletedAudits[i].TotalScore%';
                                                            display: flex;
                                                            align-items: center;
                                                            justify-content: center;
                                                            position: absolute;
                                                            width: 35px;
                                                            height: 35px;
                                                            background: rgb(241, 243, 240);
                                                            border-radius: 50%;
                                                            top: 50%;
                                                            left: 50%;
                                                            transform: translate(-50%, -50%);
                                                            }
                                                        </style>

                                                        <div class="col-sm-2 p-1">
                                                            <a href="/report/audit/completed?templateId=@Model.CurrentAudit.Id&auditId=@Model.CompletedAudits[i].Id" style="color: black; ">
                                                                <div class="m-1 p-2" style="background-color: rgb(241, 243, 240); border-radius: 10px; height: 100%">
                                                                    <div class="row" style="height: 100px">
                                                                        <div class="col-12">
                                                                            <div class="completed-audit-donut-@i"></div>
                                                                        </div>
                                                                    </div>

                                                                    <div class="row">
                                                                        <div class="col-12">
                                                                            <strong>@Model.CompletedAudits[i].Name</strong>
                                                                        </div>
                                                                    </div>

                                                                    @if (Model.CompletedAudits[i].Signatures != null && Model.CompletedAudits[i].Signatures.Count > 0)
                                                                    {
                                                                        <div class="row">
                                                                            <div class="col-12">
                                                                                @(Model?.CmsLanguage?.GetValue(LanguageKeys.Dashboard.CompletedBy, "Completed by") ?? "Completed by"): @Model.CompletedAudits[i].Signatures?[0].SignedBy
                                                                            </div>
                                                                        </div>

                                                                        <div class="row">
                                                                            <div class="col-12">
                                                                                @{
                                                                                    DateTime SignedDate = TimeZoneInfo.ConvertTime(Model.CompletedAudits[i].Signatures[0].SignedAt.Value, timezone);
                                                                                }
                                                                                @SignedDate.ToLocaleFullDateShortTimeString(Model.Locale)
                                                                            </div>
                                                                        </div>
                                                                    }
                                                                </div>
                                                            </a>
                                                        </div>
                                                    }
                                                }
                                            }
                                            //more audits div 
                                            <div class="col-sm-2 p-1">
                                                <a href="/report/audit/completed?templateId=@Model.CurrentAudit.Id">
                                                    <div class="m-1 p-3" style="background-color: rgb(163, 193, 97); border-radius: 10px; height: 100%; color: white">
                                                        <div class="row" style="height: 100px; text-align: center">
                                                            <div class="col-12" style="font-size: 50px">
                                                                <i class="fa-solid fa-clock-rotate-left"></i>
                                                            </div>
                                                        </div>

                                                        <div class="row" style="text-align: center; font-size: 17px">
                                                            <div class="col-12">
                                                                <strong>@(Model?.CmsLanguage.GetValue(LanguageKeys.LastCompletedItems.LastCompleted, "Last completed") ?? "Last completed")</strong>
                                                                <br />
                                                                @(Model?.CmsLanguage.GetValue(LanguageKeys.LastCompletedItems.Audits, "audits") ?? "audits")
                                                            </div>
                                                        </div>
                                                    </div>
                                                </a>
                                            </div>
                                        }
                                        else if(Model.CurrentAudit.Id > 0)
                                        {
                                            <div class="col-10">@(Model?.CmsLanguage.GetValue(LanguageKeys.LastCompletedItems.NoCompletedAuditsFound, "No completed audits found") ?? "No completed audits found")</div>
                                            <div class="col-2 p-1">
                                                <a href="/report/audit/completed">
                                                    <div class="m-1 p-3" style="background-color: rgb(163, 193, 97); border-radius: 10px; height: 100%; color: white">
                                                        <div class="row" style="height: 100px; text-align: center">
                                                            <div class="col-12" style="font-size: 50px">
                                                                <i class="fa-solid fa-clock-rotate-left"></i>
                                                            </div>
                                                        </div>
                                                        <div class="row" style="text-align: center; font-size: 17px">
                                                            <div class="col-12">
                                                                <strong>@(Model?.CmsLanguage.GetValue(LanguageKeys.LastCompletedItems.LastCompleted, "Last completed") ?? "Last completed")</strong>
                                                                <br />
                                                                @(Model?.CmsLanguage.GetValue(LanguageKeys.LastCompletedItems.Audits, "audits") ?? "audits")
                                                            </div>
                                                        </div>
                                                    </div>
                                                </a>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</section>

<partial name="~/Views/Shared/_auditing_history.cshtml" model="@(new AuditingLogViewModel { ItemType="audit",TemplateId=Model.CurrentAudit.Id, EnablingAuditing = Model.EnablingAuditing})" />

@if (Model.ApplicationSettings.Features.ChecklistsPropertyEnabled.HasValue && Model.ApplicationSettings.Features.ChecklistsPropertyEnabled.Value)
{
    <partial name="~/Views/Shared/_dialogOpenFields.cshtml" model="Model" />
}

@if (Model.ApplicationSettings?.Features?.TemplateSharingEnabled == true)
{
    <partial name="~/Views/Shared/_template_sharing_modal.cshtml" model="@(new TemplateSharingViewModel{ CmsLanguage = Model.CmsLanguage, Companies = Model.CompaniesInHolding })" />
}

<!-- Modal -->
<div role="dialog" tabindex="-1" class="modal fade h-100" id="editTemplateStepModal">
    <div class="modal-dialog modal-xl modal-dialog-scrollable h-100" role="document">
        <div class="modal-content" id="editStepModalContent">
            <partial name="_steps_list_new.cshtml" model="Model" />
        </div>
    </div>
</div>

<!-- Modal -->
<div role="dialog" tabindex="-1" class="modal fade h-100" data-backdrop="static" id="editTemplateStepDetailModal">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered" role="document">
        <div class="modal-content" id="editStepModalContent2">
            <div class="modal-header">
                <h4 class="modal-title">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.InstructionTitle, "Instruction") ?? "Instruction") (1/3)</h4>
            </div>

            <div class="modal-body">
                <div id="fileSizeAlert-instruction" class="alert alert-danger d-none">
                    @(Model?.CmsLanguage.GetValue(LanguageKeys.FrameWork.FileSizeTooBig, "File size for this media file is too big!") ?? "File size for this media file is too big!")
                    <button type="button" class="close" onclick="$(this).closest('div.alert').hide()" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <div class="row">
                    <div id="instructionDropZone" data-drop="true" class="col-12">
                        <img id="stepImage" @*crossorigin="anonymous"*@ src="@Constants.General.ImageUnavailableUrl" style="width:100%;object-fit: cover; object-position: center; height:20rem;border-radius: 5px;" class="img-fluid w-100"  />
                        <div class="controls" style="position:absolute;bottom:0px;">
                            <input class="d-none" type="file" id="uploaderItemStep" accept="video/*,image/*" name="photo" onchange="ezgolist.previewFileEx(this);" onclick="this.value=null" data-preview="#stepImage" data-templateid="0" data-templatestepid="0" data-type="instruction" required>
                            <a href="#" onclick="$('#uploaderItemStep').trigger('click'); return false;">
                                <div class="border rounded-circle float-right d-lg-flex justify-content-lg-center shadow main-image-pencil">
                                    <i class="fa fa-paperclip d-lg-flex justify-content-center align-items-center align-content-center" style="font-size: 20px;"></i>
                                </div>
                            </a>

                            <a href="#" data-selector="deletemedia" data-type="step">
                                <div class="border rounded-circle float-left d-lg-flex justify-content-lg-center shadow main-image-pencil">
                                    <i class="fa fa-trash d-lg-flex justify-content-center align-items-center align-content-center" style="font-size: 20px;"></i>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <div class="form-group w-100">
                            <textarea id="txtStepDescription" class="form-control-sm form-control" placeholder="@(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.InstructionDescPlaceholder, "Enter a description for the instruction...") ?? "Enter a description for the instruction...")"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <input type="hidden" id="currentTemplateItemStepId" />
                <button id="btnDeleteStep" class="btn btn-danger btn-sm mr-auto" type="button" data-stepid="0" onclick="ezgolist.deleteItemStep()">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.DialogDelete, "Delete") ?? "Delete")</button>
                <button id="btnPreviousStep" class="btn btn-light" type="button" onclick="ezgolist.previousTemplateStep()">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.InstructionPrevStep, "previous step") ?? "previous step")</button>
                <button type="button" class="btn btn-ezgo btn-sm" data-bs-dismiss="modal">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.DialogClose, "close") ?? "close")</button>
                <button id="btnNextStep" class="btn btn-light" type="button" onclick="ezgolist.nextTemplateStep()">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.DialogNextStep, "next step") ?? "next step")</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="AddWorkInstructionModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="exampleModalLongTitle">@(Model?.CmsLanguage.GetValue(LanguageKeys.Audit.AvailableWorkInstrucitons, "Available workinstructions") ?? "Available workinstructions")</h4>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body">
                <div class="row m-1"><input type="text" id="searchworkinstructions" name="searchworkinstructions" placeholder="@(Model?.CmsLanguage.GetValue(LanguageKeys.Audit.SearchPlaceholder, "Search") ?? "Search")" class="form-control" data-action="search_workinstructions" /></div>
                <div id="AddWorkInstructionModalBody">
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal" data-action="close">@(Model?.CmsLanguage.GetValue(LanguageKeys.Audit.BtnClose, "Close") ?? "Close")</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="QRCodeModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered " role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="exampleModalLongTitle">QR Code</h4>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body" style="display: flex; justify-content: center">
                <div id="QRCodeModalBody">
                </div>
            </div>

            <div class="modal-footer">
                <a class="btn btn-ezgo btn-sm btn-outline mr-2 shadow-sm mt-auto" onclick="printQRCode()"><i class="fa fa-print"></i></a>
                <button class="btn btn-ezgo btn-sm btn-outline mr-2 shadow-sm mt-auto" onclick="downloadQRCode()"><i class="fas fa-download"></i></button>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal" data-action="close">@(Model?.CmsLanguage.GetValue(LanguageKeys.Checklist.BtnClose, "Close") ?? "Close")</button>
            </div>
        </div>
    </div>
</div>

@if (Model.TaskTemplateAttachmentsEnabled)
{
    <!-- Modal add link to audit item -->
    <div class="modal" id="AddAuditItemLinkAttachmentModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        @(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.ItemAddLinkModalTitle, "Add link to audit item") ?? "Add link to audit item")
                    </h5>
                    <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>@(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.ItemAddLinkModalInsertLinkHere, "Insert link here: ") ?? "Insert link here: ")</p>
                    <input id="AddAuditItemLinkAttachmentInput" class="form-control form-control-sm" type="url" placeholder="https://www.ezfactory.nl/" required />
                    <div id="AuditItemLinkAttachmentInvalidError" style="display: none">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.ItemAddLinkModalValidationError, "The URL that you entered is invalid.") ?? "The URL that you entered is invalid.")</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-ezgo" onclick="ezgolist.addLinkAttachmentToAuditItem()">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.ItemAddLinkModalSaveChanges, "Save changes") ?? "Save changes")</button>
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.ItemAddLinkModalClose, "Close") ?? "Close")</button>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script src="/js/ezgolist.js"></script>
    <script src="/js/ezgoprops.js"></script>
    <script src="/js/ezgoUtils.js"></script>
    @if (Model.ApplicationSettings.Features.AnalyticsEnabled.HasValue && Model.ApplicationSettings.Features.AnalyticsEnabled.Value)
    {
        <script src="~/js/analytics.js"></script>
        <script>ezgoAnalytics.init("audit")</script>
    }
    <script type="text/javascript" src="/js/qr-code-styling.js"></script>

    <script>
        ezgolist.workInstructionsEnabled = @(Json.Serialize(Model.ApplicationSettings.Features.WorkInstructions != null && Model.ApplicationSettings.Features.WorkInstructions.Value));
        ezgolist.taskTemplateAttachmentsEnabled = @(Json.Serialize(Model.TaskTemplateAttachmentsEnabled));
        ezgolist._isNewTemplate = @(Json.Serialize(Model.IsNewTemplate));
        ezgolist.currentWorkInstructionTemplates = @Html.Raw(Model.WorkInstructions.ToJsonFromObject());
        ezgolist.sharedTemplateId = @(Model.SharedTemplateId);
        ezgolist.getListUrl = @(Model.SharedTemplateId > 0 ? Html.Raw("'/audit/getsharedtemplate/'") : Html.Raw("'/audit/gettemplate/'"));
        ezgolist.placeholderImageUrl = '@(Constants.General.ImageUnavailableUrl)';
        ezgolist.mediaUrl = '@(string.IsNullOrEmpty(Model.ApplicationSettings?.MediaLocations?.ImageMediaBaseUri) ? Constants.General.MediaUrl : Model.ApplicationSettings?.MediaLocations?.ImageMediaBaseUri)';
        ezgolist.language = {
            listtype: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.ItemsTitle, "Audit item") ?? "Audit item")))',
            listtypeId: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.AuditId, "audit ID") ?? "audit ID")))',
            addItem: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.InstructionAddItem, "Add audit item").Replace("{{listtype}}", "audit") ?? "Add audit item")))',
            addItemLower: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.InstructionAddItemLower, "add item") ?? "add item")))',
            nextItem: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.InstructionNextItem, "next item") ?? "next item")))',
            addpdf: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.ItemAddPdf, "Add PDF") ?? "Add PDF")))',
            addlink: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.ItemAddLink, "Add link") ?? "Add link")))',
            assignButton: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.Checklist.AssignButton, "Assign") ?? "Assign")))',
            addinstruction: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.AddInstruction, "Add instruction") ?? "Add instruction")))',
            addworkinstruction: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.AddWorkInstruction, "Add workinstruction") ?? "Add workinstruction")))',
            addStep: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.DialogAddStep, "add step") ?? "add step")))',
            nextStep: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.DialogNextStep, "next step") ?? "next step")))',
            scoringsystem: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.ScoringTitle, "Scoring system") ?? "Scoring system")))',
            scoringdisabled: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.ScoringDisabledTitle, "disabled, has completed audits") ?? "disabled, has completed audits")))',
            confirmationleavemessage: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.ConfirmationLeaveMessage, "It looks like you have been editing something.If you leave before saving, your changes will be lost.") ?? "It looks like you have been editing something.If you leave before saving, your changes will be lost.")))',
            ppEnable: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.PictureProof.Enable, "Enable") ?? "Enable")))',
            ppDisable: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.PictureProof.Disable, "Disable") ?? "Disable")))',
            ppForAllItems: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.PictureProof.PictureProofForAllItems, "picture proof for all items?") ?? "picture proof for all items?")))',
            instructionCounterLabel: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.EzgoList.ItemCounterLabel, "Instruction") ?? "Instruction")))',
            sharingSuccess: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.Shared.SharingSuccess, "picture proof for all items?") ?? "picture proof for all items?")))',
            sharingFailed: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.Shared.SharingFailed, "picture proof for all items?") ?? "picture proof for all items?")))',
            
            optionYes: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage.GetValue(LanguageKeys.Action.OptionYes, "Yes") ?? "Yes")))',
            optionNo: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage.GetValue(LanguageKeys.Action.OptionNo, "No") ?? "No")))',

            deleteAuditItem: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.EzgoList.DeleteAuditItem, "Delete audit item?") ?? "Delete audit item?")))',
            deleteChecklistItem: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.EzgoList.DeleteChecklistItem, "Delete checklist item?") ?? "Delete checklist item?")))',
            deleteWorkInstructionItem: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.EzgoList.DeleteWorkInstructionItem, "Delete workinstruction item?") ?? "Delete workinstruction item?")))',

            deleteAuditInstruction: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.EzgoList.DeleteAuditItemInstruction, "Delete instruction from this audit item?") ?? "Delete instruction from this audit item?")))',
            deleteChecklistInstruction: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.EzgoList.DeleteChecklistItemInstruction, "Delete instruction from this checklist item?") ?? "Delete instruction from this checklist item?")))',
            deleteTaskInstruction: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.EzgoList.DeleteTaskInstruction, "Delete instruction from this task?") ?? "Delete instruction from this task?")))',

            deleteAuditTemplate: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.EzgoList.DeleteAuditTemplate, "Delete this audit template?") ?? "Delete this audit template?")))',
            deleteChecklistTemplate: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.EzgoList.DeleteChecklistTemplate, "Delete this checklist template?") ?? "Delete this checklist template?")))',
            deleteSkillAssessmentTemplate: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.EzgoList.DeleteSkillAssessmentTemplate, "Delete this skillassessment template?") ?? "Delete this skillassessment template?")))',
            deleteTaskTemplate: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.EzgoList.DeleteTaskTemplate, "Delete this task template?") ?? "Delete this task template?")))',
            deleteWorkInstructionTemplate: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.EzgoList.DeleteWorkInstructionTemplate, "Delete this workinstruction template?") ?? "Delete this workinstruction template?")))'
        };

        ezgolist.init(
            @Model.CurrentAudit.Id,
            @Model.CurrentAudit.CompanyId,
            'audit'
        );

        ezgoprops.language = {
            addproperty: '@(Html.Raw(EZGO.CMS.LIB.Utils.StringParsers.EscapeForJavaScript(Model?.CmsLanguage?.GetValue(LanguageKeys.Audit.BtnAddProperty, "Add property") ?? "Add property")))'
        };

        ezgoprops.init({
            proptype: 'audit',
            templateid: @Model.CurrentAudit.Id,
            propertiesEnabled: @(Model.ApplicationSettings != null && Model.ApplicationSettings.Features != null && Model.ApplicationSettings.Features.AuditsPropertyValueRegistrationEnabled.HasValue ? Model.ApplicationSettings.Features.AuditsPropertyValueRegistrationEnabled.Value.ToString().ToLower() : false.ToString().ToLower()),
        });

        $('body').on('ezgolistChanged', function (e) {
            if (ezgolist._hasChanged) {
                $('.btn-disabled-during-changes').attr('disabled', 'disabled')
            }
            else {
                $('.btn-disabled-during-changes').removeAttr('disabled');
            }
        });

        function printChecklist() {
            var t = $('#itemlist li:gt(15)').append('<div style="height:170px;page-break-after: always !important;page-break: always !important;" class="pagebreak"></div>');
            var result = $('ul.list-group li.active').map(function (i, opt) {
                return $(opt).text();
            }).toArray().join(' -> ');
            $("#mainCol").animate({ scrollTop: $('#mainCol').prop("scrollHeight") }, 1000);
            $('#areaprintlist').text(': ' + result);
            $('#mainCol').css('height', 'auto !important');
            $('.content-wrapper').removeClass('main-bg-color');
            $('.main-footer').hide();
            setTimeout(function () {
                window.print();
                t.remove();
                $('.content-wrapper').addClass('main-bg-color');
                $('#mainCol').css('height', 'height:calc(100vh - 175px)');
                $('#areaprintlist').text('');
                $('#mainCol').scrollTop(0);
            }, 1000);
        }

        function downloadQRCode() {
            let downloadLink = document.createElement('a');
            downloadLink.setAttribute('target', '_blank');
            downloadLink.setAttribute('download', 'QRCode.png');
            let canvas = $('#QRCodeModalBody').find('canvas')[0];
            canvas.toBlob(function (blob) {
                let url = URL.createObjectURL(blob);
                downloadLink.setAttribute('href', url);
                downloadLink.click();
            });
        }

        function printQRCode() {
            var canvas = $('#QRCodeModalBody').find('canvas')[0];

            canvas.toBlob(function (blob) {
                var mywindow = window.open('', 'PRINT', 'height=400,width=600');
                mywindow.document.write('<html><head><title>' + document.title + '</title>');
                mywindow.document.write('</head><body >');
                mywindow.document.write(document.getElementById('QRCodeModalBody').innerHTML);
                mywindow.document.write(`<iframe src="${URL.createObjectURL(blob)}" frameborder="0" style="border:0; top:0px; left:0px; bottom:0px; right:0px; width:400px; height:400px;" ></iframe>`);
                mywindow.document.write('<div>EZ-GO QR-code for Audit Template @(Model.CurrentAudit.Name) with ID @(Model.CurrentAudit.Id)</div>');
                mywindow.document.write('<div>Powered by www.ezfactory.nl</div>');
                mywindow.document.write();
                mywindow.document.write("</body></html>");
                mywindow.document.close(); // necessary for IE >= 10
                mywindow.focus(); // necessary for IE >= 10*/
                mywindow.print();
                mywindow.close();
            });
            return true;
        }

        $('document').ready(function () {
            $('#instructions').hide();
            $("#itemlist").sortable({
                placeholder: "ui-state-highlight",
                cancel: ".add-button",
                delay: 250,
                opacity: 0.6,
                tolerance: "pointer",
                forcePlaceholderSize: true,
                start: function (e, ui) {
                    $(this).attr('data-previndex', ui.item.index());
                },
                stop: function (ev, ui) {
                    var prevItem = $(ui.item.prev()[0]);
                    if (prevItem.hasClass("add-button"))
                        $(this).sortable("cancel");
                },
                update: function (e, ui) {
                    var newIndex = ui.item.index();
                    var oldIndex = $(this).attr('data-previndex');
                    $.utils.arrayMove(ezgolist.tmpl.TaskTemplates, oldIndex, newIndex);
                    $(this).removeAttr('data-previndex');
                }
            });

            $("#instructionlist").sortable({
                placeholder: "ui-state-highlight",
                cancel: ".add-button",
                delay: 250,
                opacity: 0.6,
                tolerance: "pointer",
                forcePlaceholderSize: true,
                start: function (e, ui) {
                    $(this).attr('data-previndex', ui.item.index());
                },
                stop: function (ev, ui) {
                    var prevItem = $(ui.item.prev()[0]);
                    if (prevItem.hasClass("add-button"))
                        $(this).sortable("cancel");
                },
                update: function (e, ui) {

                    var newIndex = ui.item.index();
                    var oldIndex = $(this).attr('data-previndex');
                    var templateIndex = ezgolist.tmpl.TaskTemplates.findIndex((obj => obj.Id == ezgolist._currentTemplateId));
                    $.utils.arrayMove(ezgolist.tmpl.TaskTemplates[templateIndex].Steps, oldIndex, newIndex);
                    $(this).removeAttr('data-previndex');
                }
            });
        });

        function downloadPdf(id) {
            if (id == 0) {
                id = ezgolist.tmpl.Id;
                if (id == 0)
                {
                    toastr.warning('Something went wrong. Please reload the template and try again.');
                    return;
                }
            }
            @if (Model.ApplicationSettings.Features.AnalyticsEnabled.HasValue && Model.ApplicationSettings.Features.AnalyticsEnabled.Value)
            {
                @:dataEntry = ezgoAnalytics.dataSpanStart("generate pdf");
            }

            var newtab = window.open('/pdf/render/4/'+id, "_blank");

            @if (Model.ApplicationSettings.Features.AnalyticsEnabled.HasValue && Model.ApplicationSettings.Features.AnalyticsEnabled.Value)
            {
                @:newtab.addEventListener("unload", function () { ezgoAnalytics.dataSpanEnd(dataEntry); });
            }
        }
    </script>

    <script>
        function reindexAllProperties() {
            let counter = 0;
            var props = [];

            $('[data-selector="property"]:visible').each(function () {
                let currentIndex = $(this).attr('data-index');
                var prop = ezgoprops._template.Properties.find(prop => prop.PropertyId == +$(this).attr('data-propid') && prop.Index == ((+$(this).attr('data-index'))));
                props.push(prop);

                if (counter != currentIndex) {
                    $(this).attr('data-index', counter);
                }

                counter = counter + 1;
            });

            //reindex properties
            for (let i = 0; i < props.length; i++) {
                props[i].Index = i;
            }

            ezgoprops._template.Properties = props;
        };

        $('#valueProps').sortable({
            items: "li:not(.ui-state-sorting-disabled)",
            placeholder: 'value-placeholder'
        });

        $("#valueProps li").disableSelection();

        $('#valueProps').on('sortupdate', function (event, ui) { reindexAllProperties(); });
    </script>

    <script>
        function generateQRCode(e) {
            $('#QRCodeModalBody').html('');
            $.ajax({
                type: "POST",
                url: '/bookmark/createorretrieve/1/7/' + ezgolist.tmpl.Id,
                data: '',
                contentType: 'application/json; charset=utf-8',
                success: function (data) {
                    const qrCode = new QRCodeStyling({
                        "width": 400,
                        "height": 400,
                        "data": `{"guid":"${data.guid.replaceAll('-', '')}", "bookmarkDate":"${data.bookmarkDate}"}`,
                        "margin": 10,
                        "type": "canvas",
                        "qrOptions": {
                            "typeNumber": "0",
                            "mode": "Byte",
                            "errorCorrectionLevel": "H"
                        },
                        "imageOptions": {
                            "hideBackgroundDots": false,
                            "imageSize": 0.6,
                            "margin": 0
                        },
                        "dotsOptions": {
                            "type": "classy",
                            "color": "#000000",
                            "gradient": {
                                "type": "linear",
                                "rotation": 0,
                                "colorStops": [{
                                    "offset": 0,
                                    "color": "#0e3152"
                                }, {
                                    "offset": 1,
                                    "color": "#144e70"
                                }
                                ]
                            }
                        },
                        "backgroundOptions": {
                            "color": "#ffffff"
                        },
                        "image": "/assets/img/QRCodeLogo.png",
                        "dotsOptionsHelper": {
                            "colorType": {
                                "single": true,
                                "gradient": false
                            },
                            "gradient": {
                                "linear": true,
                                "radial": false,
                                "color1": "#6a1a4c",
                                "color2": "#6a1a4c",
                                "rotation": "0"
                            }
                        },
                        "cornersSquareOptions": {
                            "type": "dot",
                            "color": "#103a5b"
                        },
                        "cornersSquareOptionsHelper": {
                            "colorType": {
                                "single": true,
                                "gradient": false
                            },
                            "gradient": {
                                "linear": true,
                                "radial": false,
                                "color1": "#000000",
                                "color2": "#000000",
                                "rotation": "0"
                            }
                        },
                        "cornersDotOptions": {
                            "type": "dot",
                            "color": "#103a5b",
                            "gradient": null
                        },
                        "cornersDotOptionsHelper": {
                            "colorType": {
                                "single": true,
                                "gradient": false
                            },
                            "gradient": {
                                "linear": true,
                                "radial": false,
                                "color1": "#000000",
                                "color2": "#000000",
                                "rotation": "0"
                            }
                        },
                        "backgroundOptionsHelper": {
                            "colorType": {
                                "single": true,
                                "gradient": false
                            },
                            "gradient": {
                                "linear": true,
                                "radial": false,
                                "color1": "#ffffff",
                                "color2": "#ffffff",
                                "rotation": "0"
                            }
                        }
                    });

                    qrCode.append(document.getElementById("QRCodeModalBody"));
                    $('#QRCodeModal').modal('show');
                },
                error: function (ex) {
                }
            });
        }
    </script>
}