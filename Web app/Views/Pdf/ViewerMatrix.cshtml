@model WebApp.ViewModels.SkillsViewModel
@using WebApp.Logic

@{
    Layout = null;
}
<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Skills matrix</title>
    <link rel="stylesheet" href="/plugins/fontawesome-pro-6.5.2-web/css/all.min.css" />
    <link rel="stylesheet" href="/dist/css/adminlte.min.css" />

    <script src="~/lib/dom-to-image/dom-to-image.js"></script>

    <link rel="stylesheet" href="~/css/ezgo.css" />
    <link rel="stylesheet" href="/css/pdf.css" />
    <style>
        #instructions {
            /*height: 0px;*/
            top: 0px;
            position: absolute;
            /*background: lime;*/
            z-index: 3;
        }

        .card{
            margin-bottom: 0px !important;
        }
        .customArrow {
            width: 100%;
            position: absolute;
            /*z-index: 99998;*/
            height: 0px;
            width: 0px;
            display: block;
            transition: top 200ms;
            border-bottom: 20px #93C54B solid;
            border-left: 20px transparent solid;
            border-right: 20px transparent solid;
            margin-top: -21px;
        }

        .pencil-action {
            height: 45px;
            width: 45px;
            margin-top: 15px;
            margin-right: 15px;
            font-size: 25px;
            color: #364c59;
            cursor: pointer;
        }

            .pencil-action svg {
                margin-top: 3px;
                margin-left: 11px;
            }

        .modal {
            padding: 0 !important;
        }

            .modal .modal-dialog {
                @*width: 100% !important;*@
                @*max-width: none;*@
                @*height: 100%;*@
                @*padding: 15px;*@
                @*margin: 0;*@
            }

        .value-placeholder {
            height: 70px;
            border: 1px dashed #fff;
            width: 115px;
            margin: 10px 15px 0px 0px;
            cursor: pointer;
        }

        .value-placeholder span{
            font-weight:700;
            font-size: 1.2rem;
        }
        .value-placeholder.active{
            border: solid 1px silver;
            background-color:lightgray;
        }

        .paperclip {
            height: 160px;
            background-color: #8ea968;
            text-align: center;
            color: #fff;
        }
        .paperclip i{
            margin-top:25px;
        }
        .paperclip i::after {
            display: block;
            font-size: 26px;
            font-style: normal;
            font-weight: 600;

        }

        .addclip {
            height: 130px;
            text-align: center;
            color: #93C54B;
            cursor: pointer;
        }

            .addclip:hover {
                border: dashed 1px #93C54B;
                background-color: #93c54b1f;
            }

            .addclip i {
                margin-top: 39px;
            }

                .addclip i::after {
                    display: block;
                    font-size: 26px;
                    font-style: normal;
                    font-weight: 600;
                }

        .addvalue {
            height: 70px;
            text-align: center;
            color: #93C54B;
            cursor: pointer;
            width: 115px;
        }

            @*.addvalue:hover {
                border: dashed 1px #93C54B;
                background-color: #93c54b1f;
            }*@

            .addvalue i {
                margin-top: 20px;
            }

                .addvalue i::after {
                    display: block;
                    font-size: 26px;
                    font-style: normal;
                    font-weight: 600;
                }

        .nav-pills .nav-link.active, .nav-pills .show > .nav-link {
            color: #fff;
            background-color: #93C54B;
        }

        .nav-pills .nav-link:not(.active):hover {
            color: #93C54B;
        }

        ::-webkit-scrollbar {
            -webkit-appearance: none;
            width: 10px;
            height: 10px !important;
        }
    </style>

    <style>

    .itemlist .card {
        width: 12rem;
    }

        .itemlist .card .card-body {
            font-size: 9.5pt;
            color: #6c757d !important;
        }

            .itemlist .card .card-body p {
                padding-bottom: 0px;
            }

        .itemlist .card:hover {
            box-shadow: 0 .5rem 1rem rgba(0,0,0,.15) !important;
        }

    v.list-inline-item {
        padding: 5px;
    }

    .controls {
        position: absolute;
        bottom: 0px;
        margin: 15px;
    }

    .main-image-pencil {
        background: #93c54b;
        width: 35px;
        height: 35px;
        margin: 10px;
        opacity: 0.8;
        z-index: 1;
        color: #fff;
        border: solid 1px #333333 !important;
        cursor: pointer;
    }

        .main-image-pencil i {
            width: 35px;
            height: 33px;
            position: relative;
            display: flex;
        }

        .main-image-pencil:hover {
            border: solid 1px #fff !important;
        }

    .itemlist .pencil {
        background: #333333;
        width: 35px;
        height: 35px;
        margin: 10px;
        opacity: 0.8;
        z-index: 1;
        position: absolute;
        left: 70px;
        top: 105px;
        color: #fff;
        border: solid 1px #333333 !important;
        cursor: pointer;
    }

        .itemlist .pencil i {
            width: 35px;
            height: 33px;
            position: relative;
            display: flex;
        }

        .itemlist .pencil:hover {
            border: solid 1px #fff !important;
        }

    .itemlist .ui-state-highlight {
        height: 240px;
        line-height: 1.2em;
        width: 12rem;
        margin-right: 22px;
        background-color: rgba(241,241,241,0.52) !important;
        border: dashed 1px rgb(191,191,191);
        margin-top: 6px;
    }

    .itemlist .valuePropHolder {
        width: 100px;
        height: 60px;
        border-radius: 6px;
        float: left;
        margin-right: 18px;
        border: 1px solid rgb(214,214,214);
    }

    .itemlist .card-link {
        position: relative;
        display: flex;
        height: 160px;
        margin: -1px;
        border: solid 1px rgba(0,0,0,0);
    }

        .itemlist .card-link img {
            object-fit: cover;
            width: 100%;
            height: 160px;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }

    .btn-light:not(:disabled):not(.disabled).active, .btn-light:not(:disabled):not(.disabled):active, .show > .btn-light.dropdown-toggle {
        color: #fff !important;
        background-color: #93C54B;
        border-color: #d3d9df;
    }

    .tpl {
        display: none;
    }
    .list-group-item:last-child {
        margin-bottom: 0;
        border-bottom-right-radius: 0rem;
        border-bottom-left-radius: 0rem;
    }

    @@media print {
        .pagebreak {
            @*clear: both !important;*@
            page-break-after: always !important;
            break-after: always !important;
        }

        #mainCol {
            display: block !important;
            position: relative !important;
            width: auto !important;
            height: auto !important;
            overflow: visible !important;
            margin-left: 0 !important;
        }

        .content-wrapper{
            background-color: #fff !important;
        }
    }
    </style>

    <style>
        .dropdown-item.active, .dropdown-item:active {
            color: #fff;
            text-decoration: none;
            background-color: #93C54B;
        }

        .form-group {
            margin-bottom: 0.5rem;
        }

        .nav-pills .nav-link.active, .nav-pills .show > .nav-link {
            color: #fff;
            background-color: #93C54B;
        }
    </style>

    <style>
        #valueProps {
            list-style-type: none;
            padding: 0px;
        }

            #valueProps li {
                float: left;
                margin-right: 15px;
                cursor: pointer;
                border: solid 1px #ced4da;
                border-radius: 3px;
            }

                #valueProps li:hover {
                    box-shadow: 0 .5rem 1rem rgba(0,0,0,.15) !important;
                    border: dashed 1px #93C54B;
                    background-color: #93c54b1f;
                }

                #valueProps li .bigbutton {
                    width: 135px;
                    height: 85px;
                    align-content: center;
                    position: relative;
                }

                #valueProps li .bigbutton-plus {
                    width: 135px;
                    height: 85px;
                    align-content: center;
                }

                #valueProps li .bigbutton div {
                    text-align: center;
                }

                #valueProps li .x-btn {
                    position: absolute;
                    background: red;
                    color: #fff !important;
                    top: -10px;
                    right: -10px;
                    width: 24px;
                    height: 24px;
                    border-radius: 50%;
                    font-size: 12px;
                }

                    #valueProps li .x-btn i {
                        margin-top: 6px;
                    }

                #valueProps li .bigbutton div:nth-child(2) {
                    text-align: center;
                    font-size: 13px;
                    line-height: 20px;
                    color: #6c757d !important;
                    padding-top: 2px;
                }

                #valueProps li .bigbutton div:nth-child(3) {
                    text-align: center;
                    font-size: 20px;
                    line-height: 20px;
                    top: 49%;
                    left: 50%;
                    transform: translate(-50%,-49%);
                    position: absolute;
                    width: 100%;
                    word-wrap: break-word !important;
                }

                #valueProps li .bigbutton div:nth-child(4) {
                    text-align: center;
                    font-size: 13px;
                    line-height: 20px;
                    color: #6c757d !important;
                    position: absolute;
                    bottom: 0px;
                    width: 100%;
                    padding-bottom: 2px;
                }

                #valueProps li.active {
                    box-shadow: 0 .5rem 1rem rgba(0,0,0,.15) !important;
                    border: solid 1px #93C54B;
                    background-color: #93c54b1f;
                }
    </style>

    <style>

        #ChangeSkillOrderModal .changeSkillOrderSkill {
            border: solid 1px transparent;
            border-radius: 10px;
            background-color: #FFF;
        }

            #ChangeSkillOrderModal .changeSkillOrderSkill:hover {
                border: solid 1px #93c54b;
                box-shadow: 0 .425rem .75rem rgba(0,0,0,.075) !important;
                color: #93c54b !important;
            }

        .noselect {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            cursor: pointer;
        }


        img {
            vertical-align: middle;
            border-style: none;
            display: inline-block;
        }
    </style>
    <!-- Button styles -->
    <style>
        .btn-ezgo, .btn-ezgo:hover, .btn-ezgo:active, .btn-ezgo:visited {
            background-color: #93C54B !important;
            color: #fff !important;
        }

            .btn-ezgo:hover, .btn-outline-ezgo:hover {
                filter: brightness(.95);
            }
    </style>

    <link rel="stylesheet" href="/css/matrix/matrix.css" />
    <link rel="stylesheet" href="/css/matrix/matrix-hover.css" />
    <link rel="stylesheet" href="/css/matrix/matrix-buttons.css" />


</head>
<body>
    <div style="width: fit-content; padding: 1rem 2rem 2rem 1rem">
        <div id="generateMatrixImageInfo">
            @(Model?.CmsLanguage?.GetValue(LanguageKeys.Pdf.GeneratingSkillsMatrixImage, "Generating skills matrix image...") ?? "Generating skills matrix image...")</div>
        <button id="downloadMatrix" style="display: none" class="btn btn-ezgo btn-sm mr-2 shadow-sm mt-auto" onclick="downloadMatrixImage()">
            @(Model?.CmsLanguage?.GetValue(LanguageKeys.Pdf.DownloadGeneratedMatrixImage, "Download generated matrix image") ?? "Download generated matrix image")</button>
    </div>
    <div id="matrixWrapper" style="width: fit-content; padding: 1rem 2rem 2rem 1rem">
    <div class="row" style="width: fit-content">
        @{ 
            var now = DateTime.UtcNow;

            var tz = User.FindFirst(System.Security.Claims.ClaimTypes.Country)?.Value ?? "Europe/Amsterdam";
            TimeZoneInfo timezone = TZConvert.EzFindTimeZoneInfoById(tz);
            DateTime currentDateTime = TimeZoneInfo.ConvertTime(now, timezone);

        }
        <div class="col-12 ml-2">
            <h1>@Model.CurrentSkillsMatrix.Name</h1>
            <h6>@Model.CurrentSkillsMatrix.Description</h6>
            <h7>@currentDateTime</h7>
        </div>
    </div>
    <section id="contentDiv" class="content" style="width: fit-content">

        <div id="matrixBody" style="width: fit-content;height: 100%; overflow: visible; position: relative">
            @if (Model.CurrentSkillsMatrix.NumberOfMandatorySkills == 0 && Model.CurrentSkillsMatrix.NumberOfOperationalSkills == 0)
            {
                <div>@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.NumberOfOperationalSkillsTitle, "Please select or create one or more mandatory / operational skills.") ?? "Please select or create one or more mandatory / operational skills.")</div>
            }
            @if (Model.CurrentSkillsMatrix.NumberOfUserGroups == 0)
            {
                <div>@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.NumberOfUserGroupsTitle, "Please select or create one or more user groups.") ?? "Please select or create one or more user groups.")</div>
            }

            @{
                int colspan = 5;
            }
            <!-- Matrix display (User Groups and User Skills both added!) -->
            @if (Model.CurrentSkillsMatrix.NumberOfUserGroups != 0 && (Model.CurrentSkillsMatrix.NumberOfMandatorySkills != 0 || Model.CurrentSkillsMatrix.NumberOfOperationalSkills != 0))
            {

                <table>
                    <tr>
                        <td rowspan="1" colspan="3" id="matrixSpacer2"></td>
                        @{
                            int rowspan = (Model.CurrentSkillsMatrix.MandatorySkills != null ? Model.CurrentSkillsMatrix.MandatorySkills.Count() : 0) +
                                          (Model.CurrentSkillsMatrix.OperationalSkills != null ? Model.CurrentSkillsMatrix.OperationalSkills.Count() : 0) + 11;
                            int endCellPos = 0;
                            var endClass = "";

                            foreach (var usergroup in Model.CurrentSkillsMatrix.UserGroups)
                            {

                                <td class="rowtitle" colspan="@(usergroup.Users.Count())"><span>@(usergroup.Name)</span></td>
                                <td rowspan="@rowspan"></td>
                            }
                        }
                    </tr>
                    <tr class="text-center">
                        <td></td>
                        <td style="vertical-align: bottom; padding: 0">
                            <div>
                                <span style="width: 35px; display: inline-block; line-height: 35px" class="vertical">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.MatrixGoalTitle, "Goal") ?? "Goal")</span>
                                <span style="width: 35px; display: inline-block; line-height: 35px" class="vertical">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.MatrixResultTitle, "Result") ?? "Result")</span>
                                <span style="width: 35px; display: inline-block; line-height: 35px" class="vertical">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.MatrixDeltaTitle, "Delta") ?? "Delta")</span>
                            </div>
                        </td>
                        <td id="matrixSpacer1"></td>
                        @{
                            int collspan = 5;
                        }

                        @if (Model.CurrentSkillsMatrix.UserGroups != null)
                        {
                            @foreach (var usergroup in Model.CurrentSkillsMatrix.UserGroups)
                            {
                                collspan++;
                                
                                @if (usergroup.Users.Count == 0)
                                {
                                    <td style="background: #ffffff"></td>
                                }
                                else
                                {
                                    foreach (var userprofile in usergroup.Users)
                                    {
                                        collspan++;
                                        endCellPos++;
                                        if (endCellPos == usergroup.Users.Count())
                                        {
                                            endClass = "user-title-endcell";
                                        }

                                        <td class="user-title @endClass" style="border-left: 1px solid rgb(210,210,210); cursor: pointer" data-containertype="user" data-id="@userprofile.Id" onclick="matrix.showUserSkillValuesModal(@Model.CurrentSkillsMatrix.Id, @userprofile.UserProfileId, '@Html.Raw(userprofile.LastName), @Html.Raw(userprofile.FirstName)')">
                                            <div><span class="d-inline vertical" data-containertype="username" data-id="@userprofile.Id">@(string.Format("{0} {1}", userprofile.FirstName, userprofile.LastName))</span></div>

                                            @if (string.IsNullOrEmpty(userprofile.Picture) || userprofile.Picture == "emptyprofile")
                                            {
                                                <div class="imageWrapper" style="width: 100%; height: 48px !important; border-radius: 50% !important; ">
                                                    <img class="user-img" style="width: 48px !important; height: 48px !important; border-radius: 50% !important; " loading="lazy" src="/images/user-placeholder.jpg">
                                                </div>
                                            }
                                            else
                                            {
                                                var userImg = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, userprofile.Picture);
                                                var base64userImg = await Model.MediaService.GetMediaAsBase64(userImg);
                                                <div class="imageWrapper" style="width: 100%; height: 48px !important; border-radius: 50% !important; ">
                                                    <img class="user-img" style="width: 48px !important; height: 48px !important; border-radius: 50% !important; " loading="lazy" src="@base64userImg">
                                                </div>
                                            }

                                        </td>
                                    }
                                }
                            }
                        }

                    </tr>
                    <tr>
                        <td colspan="@collspan"></td>
                    </tr>
                    @{
                        bool isHeader = true;
                    }
                    @if (Model.CurrentSkillsMatrix.MandatorySkills != null && Model.ApplicationSettings.Features.SkillMatrixMandatorySkills != null && Model.ApplicationSettings.Features.SkillMatrixMandatorySkills.Value)
                    {
                        @foreach (var skillset in Model.CurrentSkillsMatrix.MandatorySkills.OrderBy(s => s.Index))
                        {
                            <tr class="skillsrow" data-containertype="mandatory_skill_row">
                                @if (isHeader)
                                {
                                    <td class="rowtitle" rowspan="@Model.CurrentSkillsMatrix.MandatorySkills.Count()"><span class="vertical">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.MandatorySkillsTitle, "Mandatory skills") ?? "Mandatory skills")</span></td>
                                    isHeader = false;
                                }

                                <td class="goalcell">
                                    <div class="goaldiv"><div class="matrix-tooltip"><span data-containertype="goal_value">@skillset.Goal</span><span class="tooltiptext shadow">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.MatrixGoalValue, "Goal of mandatory skills") ?? "Goal of mandatory skills")</span></div><div class="matrix-tooltip"><span data-containertype="result_value">@skillset.Result</span><span class="tooltiptext shadow">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.MatrixResultValue, "Result of mandatory skills") ?? "Result of mandatory skills")</span></div><div class="matrix-tooltip"><span data-containertype="difference_value">@skillset.GoalResultDifference</span><span class="tooltiptext shadow">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.MatrixDifferenceValue, "Difference between goal and result") ?? "Difference between goal and result")</span></div></div>
                                </td>
                                <td class="endcell skillcell matrixmandatoryskill">
                                    <div>@skillset.Name</div>
                                    <small>@skillset.Description</small>
                                </td>
                                @foreach (var usergroup in Model.CurrentSkillsMatrix.UserGroups)
                                {
                                    endCellPos = 0;
                                    endClass = "";
                                    
                                    @if (usergroup.Users.Count == 0)
                                    {
                                        <td style="background: #ffffff"></td>
                                    }
                                    else {
                                    foreach (var userprofile in usergroup.Users)
                                    {
                                        endCellPos++;
                                        endClass = "";
                                        if (endCellPos == usergroup.Users.Count())
                                        {
                                            endClass += "buttonendcell ";
                                        }
                                        if (endCellPos == 1)
                                        {
                                            endClass += "buttonstartcell ";
                                        }
                                        decimal score = -1;
                                        @if (skillset.Values != null)
                                        {
                                            var found = skillset.Values.Where(m => m.UserId.Equals(userprofile.UserProfileId));
                                            if (found != null && found.Any())
                                            {
                                                score = found.FirstOrDefault().Score;
                                            }
                                        }
                                        switch (score)
                                        {
                                            case 0:
                                                <td class="buttoncell @endClass" data-containertype="value"><button class="btn circlebtn" type="button" data-popup="thumbs" data-value="0" data-userid="@userprofile.UserProfileId" data-usergroupid="@usergroup.Id" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice"></button></td>
                                                break;
                                            case 1:
                                                <td class="buttoncell @endClass" data-containertype="value"><button class="btn circlebtn btn-red thumbsdown" type="button" data-popup="thumbs" data-value="1" data-userid="@userprofile.UserProfileId" data-usergroupid="@usergroup.Id" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice"></button></td>
                                                break;
                                            case 2:
                                                <td class="buttoncell @endClass" data-containertype="value"><button class="btn circlebtn btn-green thumbsup" type="button" data-popup="thumbs" data-value="2" data-userid="@userprofile.UserProfileId" data-usergroupid="@usergroup.Id" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice"></button></td>
                                                break;
                                            case 5:
                                                <td class="buttoncell @endClass" data-containertype="value"><button class="btn circlebtn btn-orange warning" type="button" data-popup="thumbs" data-value="5" data-userid="@userprofile.UserProfileId" data-usergroupid="@usergroup.Id" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice"></button></td>
                                                break;
                                            default:
                                                <td class="buttoncell @endClass" data-containertype="value"><button class="btn circlebtn" type="button" data-popup="thumbs" data-userid="@userprofile.UserProfileId" data-usergroupid="@usergroup.Id" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice"></button></td>
                                                break;
                                        }
                                    }
                                    }
                                }

                            </tr>
                        }
                    }
                    <tr class="spacerow">
                        <td colspan="@collspan"></td>
                    </tr>
                    @{
                        isHeader = true;
                    }
                    @if (Model.CurrentSkillsMatrix.OperationalSkills != null && Model.ApplicationSettings.Features.SkillMatrixOperationalSkills != null && Model.ApplicationSettings.Features.SkillMatrixOperationalSkills.Value)
                    {
                        @foreach (var skillset in Model.CurrentSkillsMatrix.OperationalSkills.OrderBy(s => s.Index))
                        {
                            <tr class="skillsrow" data-containertype="operational_skill_row">
                                @if (isHeader)
                                {
                                    <td class="rowtitle" rowspan="@Model.CurrentSkillsMatrix.OperationalSkills.Count()"><span class="vertical">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.OperationalSkills, "Operational skills") ?? "Operational skills")</span></td>
                                    isHeader = false;
                                }

                                <td class="goalcell">
                                    <div class="goaldiv"><div data-containertype="goal_value">@skillset.Goal</div><div data-containertype="result_value">@skillset.Result</div><div data-containertype="difference_value">@skillset.GoalResultDifference</div></div>
                                </td>
                                <td class="endcell skillcell matrixoperationalskill">
                                    <div class="matrix-tooltip">
                                        <div>@skillset.Name</div>
                                        <small>@skillset.Description</small>
                                        <span class="tooltiptext shadow">@skillset.Name - @skillset.SkillAssessmentName</span>
                                    </div>
                                </td>

                                @foreach (var usergroup in Model.CurrentSkillsMatrix.UserGroups)
                                {
                                    endCellPos = 0;
                                    endClass = "";
                                    @if (usergroup.Users.Count == 0)
                                    {
                                        <td style="background: #ffffff"></td>
                                    }
                                    else {
                                        foreach (var userprofile in usergroup.Users)
                                        {
                                            endCellPos++;
                                            endClass = "";
                                            if (endCellPos == usergroup.Users.Count())
                                            {
                                                endClass += "buttonendcell ";
                                            }
                                            if (endCellPos == 1)
                                            {
                                                endClass += "buttonstartcell ";
                                            }
                                            int score = -1;
                                            decimal decimalScore = -1;
                                            bool expired = false;
                                            bool almostExpired = false;
                                            @if (skillset.Values != null)
                                            {
                                                var found = skillset.Values?
                                                .Where(m => m.UserId.Equals(userprofile.UserProfileId))
                                                .OrderByDescending(s => s.ValueDate)
                                                .ToList();

                                                if (found != null && found.Any())
                                                {
                                                    var firstFound = found.FirstOrDefault();

                                                    if (firstFound != null)
                                                    {
                                                        decimalScore = firstFound.Score;
                                                        // Round according to your setting
                                                        score = Model.ApplicationSettings?.Features?.EnableMatrixScoreStandard == true
                                                                        ? (int)Math.Round(decimalScore, MidpointRounding.AwayFromZero)  // Standard rounding
                                                                        : (int)Math.Floor(decimalScore);                                // Always round down
                                                    

                                                        if (score != 0 && skillset.ExpiryInDays.HasValue && firstFound.ValueDate != DateTime.MinValue)
                                                        {
                                                            if (firstFound.ValueDate.AddDays(skillset.ExpiryInDays.Value) < DateTime.UtcNow)
                                                            {
                                                                expired = true;
                                                            }
                                                            else if (skillset.NotificationWindowInDays.HasValue && ((skillset.NotificationWindowInDays.Value > skillset.ExpiryInDays.Value) || (firstFound.ValueDate.AddDays(skillset.ExpiryInDays.Value - skillset.NotificationWindowInDays.Value) < DateTime.UtcNow)))
                                                            {
                                                                almostExpired = true;
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        if (!expired && !almostExpired)
                                        {
                                            switch (score)
                                            {
                                                case 0:
                                                    <td class="buttoncell @endClass" data-containertype="value"><button class="btn circlebtn" style="font-size:22px !important;" type="button" data-popup="score" data-userid="@userprofile.UserProfileId" data-usergroupid="@usergroup.Id" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice"></button></td>
                                                    break;
                                                case 1:
                                                    <td class="buttoncell @endClass" data-containertype="value"><button class="btn circlebtn btn-red" style="font-size:22px !important;" type="button" data-popup="score" data-userid="@userprofile.UserProfileId" data-usergroupid="@usergroup.Id" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice" data-value="@score">@score</button></td>
                                                    break;
                                                case 2:
                                                    <td class="buttoncell @endClass" data-containertype="value"><button class="btn circlebtn btn-orangered" style="font-size:22px !important;" type="button" data-popup="score" data-userid="@userprofile.UserProfileId" data-usergroupid="@usergroup.Id" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice" data-value="@score">@score</button></td>
                                                    break;
                                                case 3:
                                                    <td class="buttoncell @endClass" data-containertype="value"><button class="btn circlebtn btn-orange" style="font-size:22px !important;" type="button" data-popup="score" data-userid="@userprofile.UserProfileId" data-usergroupid="@usergroup.Id" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice" data-value="@score">@score</button></td>
                                                    break;
                                                case 4:
                                                    <td class="buttoncell @endClass" data-containertype="value"><button class="btn circlebtn btn-orangegreen" style="font-size:22px !important;" type="button" data-popup="score" data-userid="@userprofile.UserProfileId" data-usergroupid="@usergroup.Id" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice" data-value="@score">@score</button></td>
                                                    break;
                                                case 5:
                                                    <td class="buttoncell @endClass" data-containertype="value"><button class="btn circlebtn btn-green" style="font-size:22px !important;" type="button" data-popup="score" data-userid="@userprofile.UserProfileId" data-usergroupid="@usergroup.Id" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice" data-value="@score">@score</button></td>
                                                    break;
                                                default:
                                                    <td class="buttoncell @endClass" data-containertype="value"><button class="btn circlebtn" style="font-size:22px !important;" type="button" data-popup="score" data-userid="@userprofile.UserProfileId" data-usergroupid="@usergroup.Id" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice"></button></td>
                                                    break;
                                            }
                                        }
                                                else if (almostExpired && !expired)
                                            {
                                                //almostExpired skill value so view triangle instead of score
                                                switch (score)
                                                {
                                                    case 0:
                                                            <td class="buttoncell @endClass" data-containertype="value">
                                                                <div style="position: relative; display: inline-block">
                                                                    <button class="btn circlebtn" style="font-size:22px !important;" type="button" data-popup="score" data-userid="@userprofile.UserProfileId" data-usergroupid="@usergroup.Id" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice"></button>
                                                                    <div title="Operational almost expired" class="circlebtn btn-orange" style="position: absolute; border: 1px solid #ffa500; height: 19px; width: 19px; right: -2px; bottom: -2px; border-radius: 19px; float: right; font-size: 19px; background: url(/images/icons/v2/warning.png) center / 10px no-repeat, #FFF0D4;"></div>
                                                                </div>
                                                            </td>
                                                        break;
                                                    case 1:
                                                            <td class="buttoncell @endClass" data-containertype="value">
                                                                <div style="position: relative; display: inline-block">
                                                                    <button class="btn circlebtn btn-red" style="font-size:22px !important;" type="button" data-popup="score" data-userid="@userprofile.UserProfileId" data-usergroupid="@usergroup.Id" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice" data-value="@score">@score</button>
                                                                    <div title="Operational almost expired" class="circlebtn btn-orange" style="position: absolute; border: 1px solid #ffa500; height: 19px; width: 19px; right: -2px; bottom: -2px; border-radius: 19px; float: right; font-size: 19px; background: url(/images/icons/v2/warning.png) center / 10px no-repeat, #FFF0D4;"></div>
                                                                </div>
                                                            </td>
                                                        break;
                                                    case 2:
                                                            <td class="buttoncell @endClass" data-containertype="value">
                                                                <div style="position: relative; display: inline-block">
                                                                    <button class="btn circlebtn btn-orangered" style="font-size:22px !important;" type="button" data-popup="score" data-userid="@userprofile.UserProfileId" data-usergroupid="@usergroup.Id" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice" data-value="@score">@score</button>
                                                                    <div title="Operational almost expired" class="circlebtn btn-orange" style="position: absolute; border: 1px solid #ffa500; height: 19px; width: 19px; right: -2px; bottom: -2px; border-radius: 19px; float: right; font-size: 19px; background: url(/images/icons/v2/warning.png) center / 10px no-repeat, #FFF0D4;"></div>
                                                                </div>
                                                            </td>
                                                        break;
                                                    case 3:
                                                            <td class="buttoncell @endClass" data-containertype="value">
                                                                <div style="position: relative; display: inline-block">
                                                                    <button class="btn circlebtn btn-orange" style="font-size:22px !important;" type="button" data-popup="score" data-userid="@userprofile.UserProfileId" data-usergroupid="@usergroup.Id" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice" data-value="@score">@score</button>
                                                                    <div title="Operational almost expired" class="circlebtn btn-orange" style="position: absolute; border: 1px solid #ffa500; height: 19px; width: 19px; right: -2px; bottom: -2px; border-radius: 19px; float: right; font-size: 19px; background: url(/images/icons/v2/warning.png) center / 10px no-repeat, #FFF0D4;"></div>
                                                                </div>
                                                            </td>
                                                        break;
                                                    case 4:
                                                            <td class="buttoncell @endClass" data-containertype="value">
                                                                <div style="position: relative; display: inline-block">
                                                                    <button class="btn circlebtn btn-orangegreen" style="font-size:22px !important;" type="button" data-popup="score" data-userid="@userprofile.UserProfileId" data-usergroupid="@usergroup.Id" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice" data-value="@score">@score</button>
                                                                    <div title="Operational almost expired" class="circlebtn btn-orange" style="position: absolute; border: 1px solid #ffa500; height: 19px; width: 19px; right: -2px; bottom: -2px; border-radius: 19px; float: right; font-size: 19px; background: url(/images/icons/v2/warning.png) center / 10px no-repeat, #FFF0D4;"></div>
                                                                </div>
                                                            </td>
                                                        break;
                                                    case 5:
                                                            <td class="buttoncell @endClass" data-containertype="value">
                                                                <div style="position: relative; display: inline-block">
                                                                    <button class="btn circlebtn btn-green" style="font-size:22px !important;" type="button" data-popup="score" data-userid="@userprofile.UserProfileId" data-usergroupid="@usergroup.Id" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice" data-value="@score">@score</button>
                                                                    <div title="Operational almost expired" class="circlebtn btn-orange" style="position: absolute; border: 1px solid #ffa500; height: 19px; width: 19px; right: -2px; bottom: -2px; border-radius: 19px; float: right; font-size: 19px; background: url(/images/icons/v2/warning.png) center / 10px no-repeat, #FFF0D4;"></div>
                                                                </div>
                                                            </td>
                                                        break;
                                                    default:
                                                            <td class="buttoncell @endClass" data-containertype="value">
                                                                <div style="position: relative; display: inline-block">
                                                                    <button class="btn circlebtn" style="font-size:22px !important;" type="button" data-popup="score" data-userid="@userprofile.UserProfileId" data-usergroupid="@usergroup.Id" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice"></button>
                                                                    <div title="Operational almost expired" class="circlebtn btn-orange" style="position: absolute; border: 1px solid #ffa500; height: 19px; width: 19px; right: -2px; bottom: -2px; border-radius: 19px; float: right; font-size: 19px; background: url(/images/icons/v2/warning.png) center / 10px no-repeat, #FFF0D4;"></div>
                                                                </div>
                                                            </td>
                                                        break;
                                                }
                                            }
                                        else
                                        {
                                             //expired skill value so view triangle instead of score
                                            switch (score)
                                            {
                                                case 0:
                                                    <td class="buttoncell" data-containertype="value">
                                                        <div style="position: relative; display: inline-block">
                                                            <button class="btn circlebtn" style="font-size:22px !important;" type="button" data-popup="score" data-userid="@userprofile.UserProfileId" data-usergroupid="@usergroup.Id" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice"></button>
                                                            <div title="Operational skill expired" class="circlebtn btn-orange" style="position: absolute; border: 1px solid #ffa500; height: 19px; width: 19px; right: -2px; bottom: -2px; border-radius: 19px; float: right; font-size: 19px; background: url(/images/icons/v2/warning.png) center / 10px no-repeat, #FFFFFF;"></div>
                                                        </div>
                                                    </td>
                                                    break;
                                                case 1:
                                                    <td class="buttoncell" data-containertype="value">
                                                        <div style="position: relative; display: inline-block">
                                                            <button class="btn circlebtn btn-red" style="font-size:22px !important;" type="button" data-popup="score" data-userid="@userprofile.UserProfileId" data-usergroupid="@usergroup.Id" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice" data-value="@score">@score</button>
                                                            <div title="Operational skill expired" class="circlebtn btn-orange" style="position: absolute; border: 1px solid #ffa500; height: 19px; width: 19px; right: -2px; bottom: -2px; border-radius: 19px; float: right; font-size: 19px; background: url(/images/icons/v2/warning.png) center / 10px no-repeat, #FFFFFF;"></div>
                                                        </div>
                                                    </td>
                                                    break;
                                                case 2:
                                                    <td class="buttoncell" data-containertype="value">
                                                        <div style="position: relative; display: inline-block">
                                                            <button class="btn circlebtn btn-orangered" style="font-size:22px !important;" type="button" data-popup="score" data-userid="@userprofile.UserProfileId" data-usergroupid="@usergroup.Id" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice" data-value="@score">@score</button>
                                                            <div title="Operational skill expired" class="circlebtn btn-orange" style="position: absolute; border: 1px solid #ffa500; height: 19px; width: 19px; right: -2px; bottom: -2px; border-radius: 19px; float: right; font-size: 19px; background: url(/images/icons/v2/warning.png) center / 10px no-repeat, #FFFFFF;"></div>
                                                        </div>
                                                    </td>
                                                    break;
                                                case 3:
                                                    <td class="buttoncell" data-containertype="value">
                                                        <div style="position: relative; display: inline-block">
                                                            <button class="btn circlebtn btn-orange" style="font-size:22px !important;" type="button" data-popup="score" data-userid="@userprofile.UserProfileId" data-usergroupid="@usergroup.Id" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice" data-value="@score">@score</button>
                                                            <div title="Operational skill expired" class="circlebtn btn-orange" style="position: absolute; border: 1px solid #ffa500; height: 19px; width: 19px; right: -2px; bottom: -2px; border-radius: 19px; float: right; font-size: 19px; background: url(/images/icons/v2/warning.png) center / 10px no-repeat, #FFFFFF;"></div>
                                                        </div>
                                                    </td>
                                                    break;
                                                case 4:
                                                    <td class="buttoncell" data-containertype="value">
                                                        <div style="position: relative; display: inline-block">
                                                            <button class="btn circlebtn btn-orangegreen" style="font-size:22px !important;" type="button" data-popup="score" data-userid="@userprofile.UserProfileId" data-usergroupid="@usergroup.Id" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice" data-value="@score">@score</button>
                                                            <div title="Operational skill expired" class="circlebtn btn-orange" style="position: absolute; border: 1px solid #ffa500; height: 19px; width: 19px; right: -2px; bottom: -2px; border-radius: 19px; float: right; font-size: 19px; background: url(/images/icons/v2/warning.png) center / 10px no-repeat, #FFFFFF;"></div>
                                                        </div>
                                                    </td>
                                                    break;
                                                case 5:
                                                    <td class="buttoncell" data-containertype="value">
                                                        <div style="position: relative; display: inline-block">
                                                            <button class="btn circlebtn btn-green" style="font-size:22px !important;" type="button" data-popup="score" data-userid="@userprofile.UserProfileId" data-usergroupid="@usergroup.Id" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice" data-value="@score">@score</button>
                                                            <div title="Operational skill expired" class="circlebtn btn-orange" style="position: absolute; border: 1px solid #ffa500; height: 19px; width: 19px; right: -2px; bottom: -2px; border-radius: 19px; float: right; font-size: 19px; background: url(/images/icons/v2/warning.png) center / 10px no-repeat, #FFFFFF;"></div>
                                                        </div>
                                                    </td>
                                                    break;
                                                default:
                                                    <td class="buttoncell" data-containertype="value">
                                                        <div style="position: relative; display: inline-block">
                                                            <button class="btn circlebtn" style="font-size:22px !important;" type="button" data-popup="score" data-userid="@userprofile.UserProfileId" data-usergroupid="@usergroup.Id" data-skillid="@skillset.UserSkillId" data-actiontype="user_value_choice"></button>
                                                            <div title="Operational skill expired" class="circlebtn btn-orange" style="position: absolute; border: 1px solid #ffa500; height: 19px; width: 19px; right: -2px; bottom: -2px; border-radius: 19px; float: right; font-size: 19px; background: url(/images/icons/v2/warning.png) center / 10px no-repeat, #FFFFFF;"></div>
                                                        </div>
                                                    </td>
                                                    break;
                                            }
                                        }
                                    }
                                    }
                                }

                            </tr>
                        }
                    }
                    <tr class="spacerow">
                        <td colspan="@collspan">
                        </td>
                    </tr>

                    @{
                        isHeader = true;
                    }
                    @if (Model.CurrentSkillsMatrix.OperationalBehaviours != null && Model.ApplicationSettings.Features.SkillMatrixOperationalBehaviour != null && Model.ApplicationSettings.Features.SkillMatrixOperationalBehaviour.Value)
                    {
                        //score range for the operational behaviour metrics
                        double[] operationalBehaviourRanges = { 0.2, 0.6, 1.0, 1.2 };
                        //score range for act of deviations metric (percentage of thumbs down with action or comment by user)
                        double[] actOnDeviationsRanges = { 0.2, 0.4, 0.6, 0.8 };
                        double[] OBRanges;
                        
                        @foreach (var skillset in Model.CurrentSkillsMatrix.OperationalBehaviours.OrderBy(s => s.TechnicalUid))
                        {
                            <tr class="skillsrow operationalbehaviour" style="position: relative; page-break-inside: avoid">
                                @if (isHeader)
                                {
                                    <td class="rowtitle" rowspan="@Model.CurrentSkillsMatrix.OperationalBehaviours.Count()"><span class="vertical">@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.OperationalBehavior, "Operational behavior") ?? "Operational behavior")</span></td>
                                    isHeader = false;
                                }

                                <td class="goalcell"></td>
                                <td class="endcell skillcell matrixoperationalbehaviour" title="@skillset.Name">
                                    <div>@skillset.Name</div>
                                    <small>@skillset.Description</small>
                                </td>
                                @foreach (var usergroup in Model.CurrentSkillsMatrix.UserGroups)
                                {
                                    var peopleTechnicalUid = skillset.TechnicalUid.Substring(0, 6) + "PEOPLE_" + skillset.TechnicalUid.Substring(6, skillset.TechnicalUid.Length - 6);
                                    var total = Model.CurrentSkillsMatrix.MatrixTotals.Where(m => m.TechnicalUid == skillset.TechnicalUid).FirstOrDefault();
                                    var totalPeople = Model.CurrentSkillsMatrix.MatrixTotals.Where(m => m.TechnicalUid == (peopleTechnicalUid)).FirstOrDefault();

                                    @if (usergroup.Users.Count == 0)
                                    {
                                        <td style="background: #ffffff"></td>
                                    }
                                    else {
                                        foreach (var userprofile in usergroup.Users)
                                        {
                                            var score = -1;
                                            double valueCalculatedScore = -1;
                                            @if (skillset.Values != null)
                                            {
                                                var found = skillset.Values.Where(m => m.UserId.Equals(userprofile.UserProfileId));
                                                if (found != null && found.Any())
                                                {
                                                    score = found.FirstOrDefault().ScoreOrNumber;
                                                }
                                            }

                                            //calculate score
                                            if(score > 0) {
                                                valueCalculatedScore = (score / ((double)(total?.Values.FirstOrDefault().ScoreOrNumber ?? 1.0d) / (double)(totalPeople?.Values.FirstOrDefault().ScoreOrNumber ?? 1.0d)));

                                                if (skillset.TechnicalUid == "S5_NR_ACT_ON_DEVIATIONS")
                                                {
                                                    valueCalculatedScore /= 100.0d;
                                                }
                                            }
                                            else
                                            {
                                                valueCalculatedScore = 0;
                                            }


                                            if (skillset.TechnicalUid == "S5_NR_ACT_ON_DEVIATIONS")
                                            {
                                                OBRanges = actOnDeviationsRanges;
                                            }
                                            else
                                            {
                                                OBRanges = operationalBehaviourRanges;
                                            }

                                            if (valueCalculatedScore > OBRanges[3])
                                            {
                                                <td class="buttoncell"><button style="cursor: default; " class="btn circlebtn king" type="button" data-popup="grade" title="@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.CircleBtnKingTitle, "The King with score") ?? "The King with score"): @score"></button></td>
                                            }
                                            else if (valueCalculatedScore <= OBRanges[3] && valueCalculatedScore > OBRanges[2])
                                            {
                                                <td class="buttoncell"><button style="cursor: default; " class="btn circlebtn champion" type="button" data-popup="grade" title="@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.CircleBtnChampionTitle, "Champion with score") ?? "Champion with score"): @score"></button></td>
                                            }
                                            else if (valueCalculatedScore <= OBRanges[2] && valueCalculatedScore > OBRanges[1])
                                            {
                                                <td class="buttoncell"><button style="cursor: default; " class="btn circlebtn spoton" type="button" data-popup="grade" title="@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.CircleBtnSpotOnTitle, "Spot On with score") ?? "Spot On with score"): @score"></button></td>
                                            }
                                            else if (valueCalculatedScore <= OBRanges[1] && valueCalculatedScore > OBRanges[0])
                                            {
                                                <td class="buttoncell"><button style="cursor: default; " class="btn circlebtn risingstar" type="button" data-popup="grade" title="@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.CircleBtnRisingStarTitle, "Rising Star with score") ?? "Rising Star with score"): @score"></button></td>
                                            }
                                            else if (valueCalculatedScore <= OBRanges[0] && valueCalculatedScore > 0)
                                            {
                                                <td class="buttoncell"><button style="cursor: default; " class="btn circlebtn powerup" type="button" data-popup="grade" title="@(Model?.CmsLanguage?.GetValue(LanguageKeys.Skills.CircleBtnPowerUpTitle, "Power Up with score") ?? "Power Up with score"): @score"></button></td>
                                            }
                                            else
                                            {
                                                <td class="buttoncell"><div style="cursor: default;" class="btn circlebtn" type="button" data-popup="grade" title="@(score == -1 ? "No score or data available." : string.Concat("Score: ", score))"></div></td>
                                            }
                                        }
                                    }
                                }

                            </tr>
                        }
                    }
                    <tr class="spacerow">
                        <td colspan="@collspan"></td>
                    </tr>

                </table>
            }

        </div>
    </section>
    </div>
    <script>
        var matrixExporter = {
            matrixName: '@((Model != null && Model.CurrentSkillsMatrix != null) ? Model.CurrentSkillsMatrix.Name : "")',
            downloadLinkElement: {}
        };

        domtoimage.toBlob(document.getElementById('matrixWrapper'), { bgcolor: '#FFFFFF'})
        .then(function (blob) {
            var dataUrl = URL.createObjectURL(blob)

            var link = document.createElement('a');
            link.download = 'EZ-GO Skills Matrix "' + matrixExporter.matrixName + '", ' + new Date().toISOString() + '.png';
            link.href = dataUrl;
            link.target = "_blank";

            matrixExporter.downloadLinkElement = link;
            document.getElementById('generateMatrixImageInfo').style.display = 'none';
            document.getElementById('downloadMatrix').style.display = 'block';
            //window.close();
        })
        .catch(function (error) {
            console.log(error);
        });
        
        function downloadMatrixImage() {
            matrixExporter.downloadLinkElement.click();
        }
        
    </script>
</body>
</html>