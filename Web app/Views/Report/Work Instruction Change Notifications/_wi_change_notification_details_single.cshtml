@model WebApp.ViewModels.WorkInstructionChangeNotificationViewModel
@using WebApp.Models.Checklist
@using System.Text
@{
    var tz = User.FindFirst(System.Security.Claims.ClaimTypes.Country)?.Value ?? "Europe/Amsterdam";
    TimeZoneInfo timezone = TZConvert.EzFindTimeZoneInfoById(tz);

    string getIconColor(string state)
    {
        switch (state.ToLower())
        {
            case "ok":
                return "bg-green";
            case "not ok":
                return "bg-red";
            case "skipped":
                return "bg-warning";
            default:
                return "bg-lightGray";
        }
    }

    string getIcon(string state)
    {
        switch (state.ToLower())
        {
            case "ok":
                return "fa-thumbs-up status-icon";
            case "not ok":
                return "fa-thumbs-down status-icon";
            case "skipped":
                return "fa-forward status-icon";
            default:
                return "fa-question";
        }
    }
}

<div class="card h-100">
    <div class="card-header pb-1 pl-3">
        <h5 style="color: #90C345">@Model.WorkInstruction.Name</h5>
    </div>

    <div class="card-body p-3" style="height:calc(100vh - 377px);overflow-y: scroll;">

        @{
            DateTime ModifiedAtDate = TimeZoneInfo.ConvertTime(Model.ChangeNotification.ModifiedAt.Value, timezone);
        }

        <div class="row">
            <div class="col">
                <p class="mb-1 modifiedByText">@Model.ModifiedTextValue <strong>@ModifiedAtDate.ToLocaleFullDateShortTimeString(Model.Locale)</strong> @Model.ByTextValue <strong>@Model.ChangeNotification.ModifiedBy</strong></p>
            </div>
        </div>
        <div class="py-2">
            <div class="row">
                <div class="col">
                    <partial name="_wi_changed_table.cshtml" model="Model" />
                </div>
            </div>
        </div>
        @if(!string.IsNullOrEmpty(Model.ChangeNotification.NotificationComment))
        {
            <h5>@(Model.CmsLanguage.GetValue(LanguageKeys.WiChangeNotification.NoteToChangeLabel, "Note to change") ?? "Note to change")</h5>
            <p class="p-2" style="border: 1px solid black; border-radius: 5px">@Model.ChangeNotification.NotificationComment</p>
        }

        @if (Model.ChangeNotification.NotificationViewedStats != null && Model.ChangeNotification.NotificationViewedStats.Count() > 0)
        {
            <h5>@(Model.CmsLanguage.GetValue(LanguageKeys.WiChangeNotification.UsersThatHaveConfirmedThisChangeValueLabel, "Users that have confirmed viewing these changes") ?? "Users that have confirmed viewing these changes")</h5>
            @foreach (var notificationViewedStat in Model.ChangeNotification.NotificationViewedStats)
            {
                DateTime ViewedAtDate = TimeZoneInfo.ConvertTime(notificationViewedStat.ViewedAt.Value, timezone);

                var viewedByPicture = WebApp.Logic.Constants.General.ImageUnavailableUrl;
                if (!string.IsNullOrEmpty(notificationViewedStat.ViewedUser.Picture))
                {
                    viewedByPicture = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, notificationViewedStat.ViewedUser.Picture);
                }
                <div class="row py-2">
                    <div class="col-auto">
                        <img class="viewedByPicture" src="/images/media-loading.gif" data-src="@viewedByPicture" />
                    </div>
                    <div class="col" style="display: flex; align-self: center">
                        <div>@notificationViewedStat.ViewedUser.Name&nbsp;<strong>@(Model.CmsLanguage.GetValue(LanguageKeys.WiChangeNotification.SeenOnLabel, "Seen on") ?? "Seen on")</strong>&nbsp;@ViewedAtDate.ToLocaleFullDateShortTimeString(Model.Locale)</div>
                    </div>
                </div>
            }
        }
    </div>


    <div class="card-footer p-0 pt-1 pb-3 text-center" style="background-color: transparent;">
        <div class="row">
            <div class="col">
                &nbsp;
            </div>
            <div class="col-auto">
                <span class="float-right m-3">
                    <a href="javascript:void(0);" onclick="window.open('/pdf/viewer/wichangenotification/@(Model.ChangeNotification.Id)', '_blank', 'toolbar=no,top=10,left=10,width=' + (screen.availWidth-10) + ',height=' + (screen.availHeight-10) + '');" class="btn btn-sm btn-ezgo mt-3 float-right"><i class="fa fa-print"></i></a>
                </span>
            </div>
        </div>
    </div>
