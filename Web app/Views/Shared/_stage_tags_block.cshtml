@model WebApp.ViewModels.TagsViewModel
@using WebApp.ViewModels
@{
    Dictionary<string, string> CmsLanguage = Model?.CmsLanguage ?? new Dictionary<string, string>();
}

<style>
    .width-available {
        width: 100%;
        width: -moz-available;
        width: -webkit-fill-available;
    }

    .tag-row::-webkit-scrollbar {
        height: 10px !important;
    }

    .group-column {
        background-color: #ededed;
        min-width: 12em;
        width: 15%;
        line-height: 1.2em;
    }

        .group-column:nth-child(2n+1) {
            background-color: #f5f5f5;
        }

    .main-tag {
        background-color: rgba(180, 180, 180, 0.1);
    }

    .tag-height {
        line-height: 1.2em;
        height: 3em;
        display: flex;
        align-content: center;
        align-items: center;
        overflow: hidden;
        word-break: break-word;
    }

    .tag-span {
        text-align: center;
        display: block;
        max-height: 2.4em;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .expand-bg {
        background-color: #e7e7e7;
    }

    .hidden {
        display: none;
    }
</style>

@if (Model.TagGroups?.Count > 0)
{
    <div class="row flex-nowrap m-0">
        <div class="row m-0 flex-nowrap tag-row width-available" style="overflow-x: scroll">
            @foreach (var group in Model.TagGroups)
            {
                <div id="tag-list" class="column group-column width-available">
                    @foreach (var tag in group.Tags)
                    {
                        <div class="@(tag.Guid == group.Tags[0].Guid ? "main-tag":"sub-tag-s hidden") tag-overflow p-2">
                            <div id="@("s"+tag.Id)" class="btn width-available tag-height btn-outline-ezgo stage-tag" onclick="toggleStageTagStyle(@tag.Id)">
                                <i class="nav-icon my-auto mx-1 @(!String.IsNullOrEmpty(group.Tags[0].IconStyle) ? "fa-" + group.Tags[0].IconStyle : "fa-solid") @(!String.IsNullOrEmpty(group.Tags[0].IconName) ? "fa-" + group.Tags[0].IconName : "fa-question")" style="float:left;"></i>
                                <span class="width-available tag-span">@tag.Name</span>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>

        <div class="column" style="float:right; display:inline-block">
            <div class="expand-bg p-2">
                <div class="btn btn-ezgo" style="height:3em; display:flex; align-content:center; align-items:center" onclick="toggleStageSubTags()">
                    <i id="expand-button-s" class="fa-solid fa-angles-down"></i>
                </div>
            </div>
        </div>
    </div>
}

<script>
    function toggleStageTagStyle(tagId) {
        ezgolist._hasChanged = true;
        var element = document.getElementById("s" + tagId);
        element.classList.toggle("btn-ezgo");
        element.classList.toggle("btn-outline-ezgo");
        element.classList.toggle("selected-tag");
        var stageId = parseInt(document.getElementById("currentStageTemplateId").value);
        var template = ezgolist.tmpl.StageTemplates.find(x => x.Id == stageId);
        var templateIndex = ezgolist.tmpl.StageTemplates.indexOf(template);
        var index = -1;
        if (ezgolist.tmpl.StageTemplates[templateIndex].Tags !== undefined) {
            var tag = ezgolist.tmpl.StageTemplates[templateIndex].Tags.find(x => x.Id == tagId);
            index = ezgolist.tmpl.StageTemplates[templateIndex].Tags.indexOf(tag);
        } else {
            ezgolist.tmpl.StageTemplates[templateIndex].Tags = new Array();
        }

        if (index > -1) {
            ezgolist.tmpl.StageTemplates[templateIndex].Tags.splice(index, 1);
        } else {
            ezgolist.tmpl.StageTemplates[templateIndex].Tags.push({
                Id: tagId
            });
        }
    }

    function toggleStageSubTags() {
        var elements = document.getElementsByClassName("sub-tag-s")
        elements.forEach(toggleStageSubTag)
        var button = document.getElementById("expand-button-s")
        button.classList.toggle("fa-angles-up")
        button.classList.toggle("fa-angles-down")
    }

    function toggleStageSubTag(stage) {
        stage.classList.toggle("hidden")
    }
</script>
