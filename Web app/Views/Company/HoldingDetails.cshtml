@model WebApp.ViewModels.HoldingViewModel
@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    Layout = "_Layout_template";

    var picture = "/assets/img/normal_unavailable_image.png";
    if (Model != null && Model.Holding != null && !string.IsNullOrEmpty(Model.Holding.Picture))
    {
        picture = WebApp.Helpers.MediaHelpers.GetMediaImageUrl(Model.ApplicationSettings, Model.Holding.Picture);
        if (string.IsNullOrEmpty(Model.Holding.Picture))
        {
            picture = @"/assets/img/normal_unavailable_image.png";
        }
    };
}

<style>
    #generate_service_user:hover { background-color: orange;}
</style>

<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <a href="/company/holding/overview"><i class="fa fa-arrow-left"></i>Back to holdings</a>
                <h1>Holding</h1>
            </div>
            <div class="col-sm-6 d-flex flex-row-reverse">
                <button class="btn btn-ezgo btn-sm mr-2 shadow-sm mt-auto" onclick="holding.save()">@(Model?.CmsLanguage.GetValue(LanguageKeys.Company.BtnSave, "Save") ?? "Save")</button>
            </div>
        </div>
    </div><!-- /.container-fluid -->
</section>

<section class="content">
    <div class="row pt-1" style="height:calc(100vh - 175px);overflow:auto;">
        <div class="col-lg-12">
            <div class="col-12 p-0 pb-3">
                <div class="row card-group">
                    <div class="col-sm-4 col-md-2">
                        <div class="card h-100" style="width:100%;height:238px;display:flex;border-radius: 5px;">
                            <div class="card-body">
                                <div style="text-align: center;">
                                    <div style="text-align: center; align-content: center;">
                                        <div style="display: inline-flex; position:relative; align-self: center; ">
                                            <img src="/images/media-loading.gif" data-src="@picture" id="company_image" class="" style="width:100%"  />
                                            <div class="controls d-print-none" style="position:absolute;bottom:0px;">
                                                <input class="d-none" type="file" id="uploaderTemplate" accept="image/*" name="photo" onchange="holding.previewFile(this);" data-preview="#company_image" data-type="image" required="">
                                                <a href="#" onclick="$('#uploaderTemplate').trigger('click'); return false;">
                                                    <div class="border rounded-circle float-right d-lg-flex justify-content-lg-center shadow main-image-pencil" style="background-color:#FFFFFF;margin-left:4px; margin-bottom:6px; height:20px; width:20px;">
                                                        <i class="fa fa-paperclip d-lg-flex justify-content-center align-items-center align-content-center" style="font-size: 14px;"></i>
                                                    </div>
                                                </a>
                                                <a href="#" data-selector="deletemedia" data-type="template" onclick="holding.removeFile(this);" data-preview="#company_image">
                                                    <div class="border rounded-circle float-left d-lg-flex justify-content-lg-center shadow main-image-pencil" style="background-color:#FFFFFF;margin-left:28px; margin-bottom:6px; height:20px; width:20px;">
                                                        <i class="fa fa-trash d-lg-flex justify-content-center align-items-center align-content-center" style="font-size: 14px;"></i>
                                                    </div>
                                                </a>
                                                <video id="dialogVideo" controls="" style="display:none;">
                                                </video>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-8 col-md-10">
                        <div class="card h-100">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col pb-2">
                                        <label for="holding_name">@(Model?.CmsLanguage.GetValue(LanguageKeys.Company.CompanyName, "Name") ?? "Name")</label>
                                        <input type="text" class="form-control" id="holding_name" name="holding_name" maxlength="200" value="@Model?.Holding?.Name" />
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col pb-2">
                                        <label for="holding_description">@(Model?.CmsLanguage.GetValue(LanguageKeys.Company.CompanyDescription, "Description") ?? "Description")</label>
                                        <textarea class="form-control" id="holding_description" name="holding_description">@Model?.Holding?.Description</textarea>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col pb-2">
                                        <label for="holding_security_guid" title="Enter the security GUID as saved with the selected holding.">Security GUID</label>
                                        <input type="text" class="form-control" id="holding_security_guid" name="company_holding_security_guid" maxlength="200" value="@Model?.Holding?.SecurityGUID" title="Enter the security GUID as saved with the selected holding." />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 p-0 pb-3">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Holding settings</h3>
                    </div>
                    <div class="card-body p-3">
                        <div class="card-header">
                            <h3 class="card-title" style="border-bottom:1px solid #C0C0C0">Datawarehouse & Reporting Pack</h3>
                        </div>
                        <div class="card">
                            <div class="card-body">
                                @if (Model.HoldingId > 0)
                                {
                                    <div class="row">
                                        <div class="col pb-2">
                                            <label for="company_datawarehouse_holding_user">Datawarehouse holding account</label>
                                            <br />
                                            <div><span id="company_datawarehouse_holding_user">@(Model.DatawarehouseHoldingUser != null ? Model.DatawarehouseHoldingUser.Username : "There is no datawarehouse connection based on a possible holding.")</span> </div>
                                        </div>
                                    </div>
                                    @if (Model.DatawarehouseHoldingUser != null)
                                    {
                                        <div class="row">
                                            <div class="col pb-2">
                                                <div style="position:relative" title="Available modules">
                                                    @foreach (string module in Model.DatawarehouseHoldingUser.Modules.Split(","))
                                                    {
                                                        <div style="display:inline-block; padding:2px; margin-top:2px;" class="badge badge-secondary"><span style=" font-weight:bolder;font-size:10px;margin:2px;">@module</span></div>

                                                    }
                                                </div>

                                            </div>
                                        </div>
                                    }
                                }
                            </div>
                        </div>

                        <div class="card-header">
                            <h3 class="card-title" style="border-bottom:1px solid #C0C0C0">Connectors</h3>
                        </div>
                        <div class="card">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col pb-2">
                                        <label for="holding_sappmnotificationoptions">SAP PM notification options (JSON)</label><br />
                                        <input type="text" class="form-control" id="holding_sappmnotificationoptions" name="holding_sappmnotificationoptions" title="SAP PM notification options (JSON)" value="@Model?.Holding?.SapPmNotificationOptions" />
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col pb-2">
                                        <label for="holding_sap_pm_authorization_url">SAP PM authorization URL</label><br />
                                        <input type="text" class="form-control" id="holding_sap_pm_authorization_url" name="holding_sap_pm_authorization_url" title="SAP PM authorization URL" value="@Model?.Holding?.SapPmAuthorizationUrl" />
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col pb-2">
                                        <label for="holding_sap_pm_location_url">SAP PM location URL</label><br />
                                        <input type="text" class="form-control" id="holding_sap_pm_location_url" name="holding_sap_pm_location_url" title="SAP PM location URL" value="@Model?.Holding?.SapPmFunctionalLocationUrl" />
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col pb-2">
                                        <label for="holding_sap_pm_notification_url">SAP PM notification URL</label><br />
                                        <input type="text" class="form-control" id="holding_sap_pm_notification_url" name="holding_sap_pm_notification_url" title="SAP PM notification URL" value="@Model?.Holding?.SapPmNotificationUrl" />
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col pb-2">

                                        <label for="holding_sap_pm_timezone">SAP PM @(Model?.CmsLanguage.GetValue(LanguageKeys.Company.CompanyTimezoneTitle, "Timezone") ?? "Timezone")</label>
                                        <select id="holding_sap_pm_timezone" class="form-control" data-resource-id="1">
                                            <option value="" title="@(Model?.CmsLanguage.GetValue(LanguageKeys.Company.NoCompanyTimezoneSelectedTitle, "No company timezone selected, therefor will default to UTC.") ?? "No company timezone selected, therefor will default to UTC.")">@(Model?.CmsLanguage.GetValue(LanguageKeys.Company.OptionNoCompanyTimezoneSelected, "No company timezone selected") ?? "No company timezone selected")</option>
                                            @if (Model.Timezones != null)
                                            {
                                                @foreach (EZGO.Api.Models.Settings.DatabaseTimezoneItem item in Model.Timezones)
                                                {
                                                    @if (Model.Holding != null && Model.Holding.SapPmTimezone == item.Name)
                                                    {
                                                        <option value="@item.Name" selected title="@item.Name (@item.Abbrivation) - @item.UtcOffset @(item.IsDayLightSavingsTime ? "Daylight Savings Time" : "")">@item.Name (@item.UtcOffset)</option>
                                                    }
                                                    else
                                                    {
                                                        <option value="@item.Name" title="@item.Name (@item.Abbrivation) - @item.UtcOffset @(item.IsDayLightSavingsTime ? "Daylight Savings Time" : "")">@item.Name (@item.UtcOffset)</option>
                                                    }

                                                }
                                            }
                                        </select>

                                    </div>
                                </div>
                            </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 p-0 pb-3">
                <div class="card">
                    <div class="card-header">
                        <div class="row">
                            <div class="col col-6"><h3 class="card-title">Companies</h3></div>
                            <div class="col col-6" style="text-align:right;padding-right:0px;margin-right:0px;"><a class="btn btn-ezgo btn-sm mr-2 shadow-sm mt-auto" onclick="document.getElementById('company_choice_container').style.display='block'"><i class="fa-solid fa-plus"></i></a></div>
                        </div> 
                    </div>

                    <div class="card-body">
                        <div data-containertype="holding_companies">
                            @if (Model?.HoldingId > 0)
                            {
                                @foreach (var comp in Model.Companies.Where(y => y.HoldingId.HasValue && y.HoldingId.Value == Model.HoldingId).OrderBy(x => x.Name))
                                {
                                    <div class="row">
                                        <input type="checkbox" id="chk_company_@comp.Id" name="chk_company_selected" checked class="form-check" value="@comp.Id"/><label for="chk_company_@comp.Id" style="margin-top: 6px;margin-left:5px;">@comp.Name (@comp.Id)</label>
                                    </div>
                                }
                            }
                        </div> 
                        <div data-containertype="company_choice" style="display:none;" id="company_choice_container">
                            @foreach (var comp in Model.Companies.Where(y => !y.HoldingId.HasValue).OrderBy(x => x.Name))
                            {
                                <div class="row">
                                    <input type="checkbox" id="chk_company_@comp.Id" name="chk_company_selected" class="form-check" value="@comp.Id" /><label for="chk_company_@comp.Id" style="margin-top: 6px; margin-left:5px;">@comp.Name (@comp.Id)</label>
                                </div>
                            }
                        </div>
                      
                    </div>
                </div>
            </div>
        </div>
    </div>
    <input type="hidden" name="holding_id" id="holding_id" value="@Model.HoldingId" />
</section>


@section Scripts{
    <script src="/js/ezgoUtils.js"></script>
    <script>
        var holding = {
            _mediaarray: [],
            _mediapath: '@(string.IsNullOrEmpty(Model.ApplicationSettings?.MediaLocations?.ImageMediaBaseUri) ? Constants.General.MediaUrl : Model.ApplicationSettings?.MediaLocations?.ImageMediaBaseUri)',
            tempImage: null,
            tempImageType: null,
            defaultImage: '/assets/img/normal_unavailable_image.png',
            init: function() {
                
            },
            createHolding: function() {
                let holdingItem = {};
                holdingItem.Id = $('#holding_id').val() != null && $('#holding_id').val() != '' ? parseInt($('#holding_id').val()) : 0;
                holdingItem.Name = $('#holding_name').val();
                holdingItem.Description = $('#holding_description').val();
                holdingItem.SecurityGUID = $('#holding_security_guid').val();
                holdingItem.SapPmNotificationOptions = $('#holding_sappmnotificationoptions').val();
                holdingItem.SapPmAuthorizationUrl = $('#holding_sap_pm_authorization_url').val();
                holdingItem.SapPmFunctionalLocationUrl = $('#holding_sap_pm_location_url').val();
                holdingItem.SapPmNotificationUrl = $('#holding_sap_pm_notification_url').val();
                holdingItem.SapPmTimezone = $('#holding_sap_pm_timezone').val();
                holdingItem.Picture = $('#company_image').data('src');
                holdingItem.CompanyRelations = [];
                $('[name="chk_company_selected"]:checked').each(function() { let relation = {}; relation.CompanyId = parseInt(this.value); holdingItem.CompanyRelations.push(relation);});
                holdingItem.Picture = holding.fixImage(holdingItem.Picture);
                console.log(holdingItem);
                return holdingItem;
            },
            fixImage: function (imageUrl) {
                let imageout = '';
                if (imageUrl.includes('unavailable') || imageUrl.startsWith('blob:') || imageUrl.startsWith('/assets/img/')) {
                    return imageout;
                } else {
                    imageout = imageUrl.replace(holding._mediapath, '');
                    return imageout;
                }
            },
            initHandlers: function() {

            },
            previewFile: async function (input) {
                var maxSizeMB = 0.3;

                const options = {
                    maxWidthOrHeight: 480,
                    useWebWorker: true,
                    maxIteration: 1
                };

                var previewElement = $(input).data('preview');
                var compressedFile = event.target.files[0];

                if (compressedFile != undefined && compressedFile !== null) {
                    //First only resize image
                    compressedFile = await imageCompression(compressedFile, options);
                    //console.log(`Successfully compressed file to ${compressedFile.size / 1024} KB.`);

                    //Then compress image if necessary
                    while (compressedFile.size / 1024 / 1024 > maxSizeMB) {
                        options.maxSizeMB = maxSizeMB;
                        compressedFile = await imageCompression(compressedFile, options);
                        //console.log(`Successfully compressed file to ${compressedFile.size / 1024} KB.`);
                    }

                    var ext = compressedFile.name.split('.').pop();
                    var fileReader = new FileReader();
                    fileReader.onload = function () {
                        var url = URL.createObjectURL(compressedFile, { oneTimeOnly: true });
                        holding.tempImage = url;
                        holding.tempImageType = ext;
                        $(previewElement).attr("src", url).parent('a').attr('href', url);
                    };
                    fileReader.readAsDataURL(compressedFile);
                }
            },
            removeFile: function (rmbutton) {
                var previewElement = $(rmbutton).attr('data-preview');
                holding.tempImage = null;//reset image to null
                holding.tempImageType = null; //reset image type to null
                $(previewElement).attr('src', holding.defaultImage); //reset to default image
                $('#company_image').data('src', holding.defaultImage); //reset to default image
            },
            save: async function () {
                toastr.remove();
                $('body').toggleClass('loaded');

                await holding.saveMedia(); //save media if there is media

                let holdingItem = holding.createHolding();
                //console.log(newCompany);

                $.ajax({
                    type: "POST",
                    url: '/company/holding/save',
                    data: JSON.stringify(holdingItem),
                    success: function (data) {
                        $('body').toggleClass('loaded');
                        toastr.success('Holding saved');
                        setTimeout(() => {
                            location.href = '/company/holding/overview';
                        }, 1000);

                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        $('body').toggleClass('loaded');
                        toastr.error(JSON.parse(jqXHR.responseText) + ' (' + jqXHR.status + ')');
                    },
                    contentType: "application/json; charset=utf-8"
                });
            },
            saveMedia: async function () {
                let output = null;
                if (holding.tempImage != null) {
                    if (String(holding.tempImage).startsWith('blob:') || String(holding.tempImage).startsWith('data:')) {
                        var url = holding.tempImage;
                        var ext = '.' + holding.tempImageType;
                        holding._mediaarray.push({ type: 'company', url: url, ext: ext, delay: 1000, kind: 'pic' });
                    }

                    //array, but only 1 item will be filled.
                    if (holding._mediaarray != null && holding._mediaarray.length > 0) {
                        //uploading media
                        const tasks = holding._mediaarray.map(holding.uploadMedia);
                        const results = await Promise.all(tasks);
                        results.forEach(x => output = x);
                        holding._mediaarray = []; //reset media array;
                    }
                }
                return output;
            },
            uploadMedia: async function (spec) {

                let blob = await fetch(spec.url).then(
                    r => r.blob()
                );
                var file = new File([blob], $.utils.createUUID() + spec.ext);
                var formData = new FormData();
                formData.append("file", file);
                formData.append("filekind", spec.kind);
                formData.append("itemtype", spec.type);

                return fetch('/holding/details/upload', {
                    method: 'POST',
                    body: formData,
                })
                    .then(response => (response.text()))
                    .then(path => {
                        var returnedPath = String(path).replaceAll('"', '');
                        $('#company_image').data('src', holding._mediapath + returnedPath);
                        $('#Picture').val(returnedPath);

                    })
                    .then(text => `Fetched ${spec.url}, and got back ${text}`);
            }

        };
        
        holding.init();
         ezgomediafetcher.preloadImagesAndVideos();
    </script>


    @*<script src="/js/ezgoUtils.js"></script>
     @if (Model.Holdings != null)
    {
        <script>
            var holdingCollection = JSON.parse('@Html.Raw(Model.Holdings.ToJsonFromObject())');
        </script>

    }
    else
    {
        <script>
            var holdingCollection = {};
        </script>
    }
    <script>
        var company = {
            _mediaarray: [],
            _mediapath: '@(string.IsNullOrEmpty(Model.ApplicationSettings?.MediaLocations?.ImageMediaBaseUri) ? Constants.General.MediaUrl : Model.ApplicationSettings?.MediaLocations?.ImageMediaBaseUri)',
            tempImage: null,
            tempImageType: null,
            defaultImage: '/assets/img/normal_unavailable_image.png',
            createCompany: function () {
                let changedCompany = {
                    Description: $('#company_description').val(),
                    Picture: $('#company_image').data('src'),
                    Name: $('#company_name').val(),
                    Id: parseInt($('#company_id').val()),
                    ManagerId: parseInt($('#company_manager').val()),
                    CompanySettings: {
                        CompanyId: parseInt($('#company_id').val()),
                        Locale: $('#company_language').val(),
                        TimeZone: $('#company_timezone').val(),
                        Country: $('#company_country').val(),
                        Coords: $('#company_coords').val(),
                        MapsJson: $('#company_mapuris').val(),
                        TierLevel: $('#company_tier').val(),
                        EnableTaskGeneration: $('#company_taskgeneration').is(':checked'),
                        EnableDataWarehouse: $('#company_datawarehouse').is(':checked'),
                        EnableWorkInstructionChangesNotifications: $('#company_wichangednotifications').is(':checked'),
                        SapPmCompanyId: $('#company_sappmcompanyid').val(),
                        SapPmNotificationOptions: $('#company_sappmnotificationoptions').val(),
                        SapPmAuthorizationUrl: $('#company_sap_pm_authorization_url').val(),
                        SapPmFunctionalLocationUrl: $('#company_sap_pm_location_url').val(),
                        SapPmNotificationUrl: $('#company_sap_pm_notification_url').val()
                    }
                }

                if ($('#company_holding').val() !== '') {
                    changedCompany.HoldingId = parseInt($('#company_holding').val());
                    changedCompany.HoldingCompanySecurityGUID = $('#company_holding_security_guid').val();
                    if ($('#company_holdingunit').val() != null) {
                        changedCompany.HoldingUnitIds = [];
                        let ids = $('#company_holdingunit').val();
                        for (let i = 0; i < ids.length; i++) {
                            changedCompany.HoldingUnitIds.push(parseInt(ids[i]));
                        }
                    } else {
                        changedCompany.HoldingUnitIds = [];
                    }

                }

                changedCompany.Picture = company.fixImage(changedCompany.Picture);

                return changedCompany;
            },
            fixImage: function (imageUrl) {
                let imageout = '';
                if (imageUrl.includes('unavailable') || imageUrl.startsWith('blob:') || imageUrl.startsWith('/assets/img/')) {
                    return imageout;
                } else {
                    imageout = imageUrl.replace(company._mediapath, '');
                    return imageout;
                }
            },
            init: function () {
                company.initHandlers();
                company.initDropDowns();
                company.initSettingValues();
            },
            initHandlers: function () {
                $('#company_holding').on('change', function () {
                    company.setAndSetHoldingUnitSelect($('#company_holding').val());
                });
                $('#generate_service_user').on('click', function () {
                    company.setAndRetrieveNewServiceAccount($('#company_id').val())
                });
                $('#company_mapuri_apple,#company_mapuri_google,#company_mapuri_openstreet').on('change', function () {
                    company.setMapEmbed();
                    company.setMapUriJson();
                });
                 $('#company_coords').on('change', function () {
                    company.setMapEmbed();
                    company.convertLatLonToMapUrls($(this).val());
                    company.setMapUriJson();
                });
                $('#btn_edit_maps_uris').on('click', function() {
                    $('#company_coords_edit_element').show();
                });
                $('[data-type="map_button"]').on('click', function() {
                    company.openMaps($(this).attr('data-kind'));
                });
            },
            initDropDowns: function () {
                if ($('#company_holding').val() != null && $('#company_holding').val() !== '' && $('#company_holdingunit').val() != null) {
                    let currentSelectedUnits = $('#company_holdingunit').val();
                    $('#company_holding').trigger('change');

                    $('#company_holdingunit option').each(function (index, item) {
                        //console.log(item);
                        if (currentSelectedUnits.includes($(item).attr('value'))) {
                            $(item).attr('selected', true);
                        }
                    });
                }
            },
            initSettingValues: function () {
                $('#company_taskgeneration').prop('checked', @(Model.CompanySettings.EnableTaskGeneration.ToString().ToLower()));
                $('#company_datawarehouse').prop('checked', @(Model.CompanySettings.EnableDataWarehouse.ToString().ToLower()));
                $('#company_wichangednotifications').prop('checked', @(Model.CompanySettings.EnableWorkInstructionChangesNotifications.ToString().ToLower()));
                $("#company_timezone").val('@(Model.CompanySettings.TimeZone)').change();
                $("#company_language").val('@(Model.CompanySettings.Locale)').change();
                $("#company_tier").val('@(Model.CompanySettings.TierLevel)').change();
                $("#company_sappmcompanyid").val('@(Model.CompanySettings.SapPmCompanyId)');
                $("#company_sappmnotificationoptions").val('@(Html.Raw(Model.CompanySettings.SapPmNotificationOptions))');
                $("#company_sap_pm_authorization_url").val('@(Html.Raw(Model.CompanySettings.SapPmAuthorizationUrl))');
                $("#company_sap_pm_location_url").val('@(Html.Raw(Model.CompanySettings.SapPmFunctionalLocationUrl))');
                $("#company_sap_pm_notification_url").val('@(Html.Raw(Model.CompanySettings.SapPmNotificationUrl))');


                $('#company_mapuris').val('@(Html.Raw(Model.CompanySettings.MapsJson))');
                company.setMapEmbed();
                if($('#company_mapuris').val() != null && $('#company_mapuris').val() != '') {
                    company.setMapUris(); //prefill map uris for ez navigation
                }
                if($('#company_coords').val() != null && $('#company_coords').val() != '') {
                    if($('#company_mapuris').val() == null || $('#company_mapuris').val() == '') {
                        company.convertLatLonToMapUrls($('#company_coords').val());//if no map uris, try to convert
                        company.setMapUriJson(); //create json from possibly generated items
                    }
                }
            },
            previewFile: async function (input) {
                var maxSizeMB = 0.3;

                const options = {
                    maxWidthOrHeight: 480,
                    useWebWorker: true,
                    maxIteration: 1
                };

                var previewElement = $(input).data('preview');
                var compressedFile = event.target.files[0];

                if (compressedFile != undefined && compressedFile !== null) {
                    //First only resize image
                    compressedFile = await imageCompression(compressedFile, options);
                    //console.log(`Successfully compressed file to ${compressedFile.size / 1024} KB.`);

                    //Then compress image if necessary
                    while (compressedFile.size / 1024 / 1024 > maxSizeMB) {
                        options.maxSizeMB = maxSizeMB;
                        compressedFile = await imageCompression(compressedFile, options);
                        //console.log(`Successfully compressed file to ${compressedFile.size / 1024} KB.`);
                    }

                    var ext = compressedFile.name.split('.').pop();
                    var fileReader = new FileReader();
                    fileReader.onload = function () {
                        var url = URL.createObjectURL(compressedFile, { oneTimeOnly: true });
                        company.tempImage = url;
                        company.tempImageType = ext;
                        $(previewElement).attr("src", url).parent('a').attr('href', url);
                    };
                    fileReader.readAsDataURL(compressedFile);
                }
            },
            removeFile: function (rmbutton) {
                var previewElement = $(rmbutton).attr('data-preview');
                company.tempImage = null;//reset image to null
                company.tempImageType = null; //reset image type to null
                $(previewElement).attr('src', company.defaultImage); //reset to default image
                $('#company_image').data('src', company.defaultImage); //reset to default image
            },
            save: async function () {
                toastr.remove();
                $('body').toggleClass('loaded');

                await company.saveMedia(); //save media if there is media

                let newCompany = company.createCompany();
                //console.log(newCompany);

                $.ajax({
                    type: "POST",
                    url: '/company/save',
                    data: JSON.stringify(newCompany),
                    success: function (data) {
                        $('body').toggleClass('loaded');
                        toastr.success('@(Model?.CmsLanguage.GetValue(LanguageKeys.Company.CompanySaved, "Company Saved") ?? "Company Saved")');
                        setTimeout(() => {
                            location.href = '/company';
                        }, 1000);

                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        $('body').toggleClass('loaded');
                        toastr.error(JSON.parse(jqXHR.responseText) + ' (' + jqXHR.status + ')');
                    },
                    contentType: "application/json; charset=utf-8"
                });
            },
            saveMedia: async function () {
                let output = null;
                if (company.tempImage != null) {
                    if (String(company.tempImage).startsWith('blob:') || String(company.tempImage).startsWith('data:')) {
                        var url = company.tempImage;
                        var ext = '.' + company.tempImageType;
                        company._mediaarray.push({ type: 'company', url: url, ext: ext, delay: 1000, kind: 'pic' });
                    }

                    //array, but only 1 item will be filled.
                    if (company._mediaarray != null && company._mediaarray.length > 0) {
                        //uploading media
                        const tasks = company._mediaarray.map(company.uploadMedia);
                        const results = await Promise.all(tasks);
                        results.forEach(x => output = x);
                        company._mediaarray = []; //reset media array;
                    }
                }
                return output;
            },
            setAndSetHoldingUnitSelect: function (selectedId) {
                if (holdingCollection != null && typeof selectedId !== 'undefined' && selectedId != null) {
                    for (let i = 0; i < holdingCollection.length; i++) {
                        if (holdingCollection[i].Id.toString() === selectedId.toString()) {
                            var foundItem = holdingCollection[i];
                            if (typeof foundItem.HoldingUnits !== 'undefined' && foundItem.HoldingUnits != null) {
                                company.setHoldingUnitSelectOptions(foundItem.HoldingUnits);
                            }
                        }
                    }
                }
            },
            setHoldingUnitSelectOptions: function (holdingUnits, possibleParentName) {
                if (typeof possibleParentName === 'undefined' || possibleParentName == null) { $('#company_holdingunit option').remove(); };
                if (typeof holdingUnits !== 'undefined' && holdingUnits != null) {
                    for (let ii = 0; ii < holdingUnits.length; ii++) {
                        let holdingUnit = holdingUnits[ii];
                        $('#company_holdingunit').append($('<option>', {
                            value: holdingUnit.Id,
                            text: typeof possibleParentName !== 'undefined' ? possibleParentName + ' -> ' + holdingUnit.Name : holdingUnit.Name
                        }));
                        if (typeof holdingUnit.HoldingUnits !== 'undefined' && holdingUnit.HoldingUnits != null) {
                            company.setHoldingUnitSelectOptions(holdingUnit.HoldingUnits, possibleParentName == null ? holdingUnit.Name : possibleParentName + ' -> ' + holdingUnit.Name);
                        }
                    }
                }
            },
            setAndRetrieveNewServiceAccount(companyid) {
                $('#saved_user_name').text('');
                toastr.remove();
                $('body').toggleClass('loaded');

                $.ajax({
                    type: "POST",
                    url: '/company/createserviceuser',
                    data: JSON.stringify(companyid),
                    success: function (data) {
                        $('body').toggleClass('loaded');
                        toastr.success('user created');
                        $('#saved_user_name').text(data);
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        $('body').toggleClass('loaded');
                        toastr.error(JSON.parse(jqXHR.responseText) + ' (' + jqXHR.status + ')');
                    },
                    contentType: "application/json; charset=utf-8"
                });
            },
            setMapUriJson: function() {
                let uriElements = $('[data-type="map_uri"]');
                if(uriElements != null) {
                    let col = [];
                    $(uriElements).each(function() {
                        if($(this).val() != '' && $(this).val() != null) {
                            col.push($(this).val());
                        }
                    });
                    if(col.length>0) {
                        $('#company_mapuris').val(JSON.stringify(col));
                    }
                }
            },
            setMapEmbed: function() {
                let coords = $('#company_coords').val();
                let mapurl = $('#company_mapuri_openstreet').val();
                let embedurl = '';

                //if coords available, then use these, else try to parse openstreet map uri if available.
                if(coords != undefined && coords != '') {
                    embedurl = company.setCoordMappedChart(coords);
                } else if (mapurl != undefined && mapurl != '') {
                    embedurl = company.setOSUrlMappedChart(mapurl);
                }
                if(embedurl != '') {
                    $('#os_map').attr('src',embedurl);
                    $('#company_coords_edit_maps').show();
                } else {
                    $('#company_coords_edit_maps').hide();
                };
            },
            setMapUris: function() {
                if($('#company_mapuris').val() != undefined && $('#company_mapuris').val() != null && $('#company_mapuris').val() != '') {
                    try {
                        let colUris = JSON.parse($('#company_mapuris').val());
                        if(colUris.length > 0) {
                            for (let iu = 0; iu < colUris.length; iu++) {
                                if(colUris[iu].includes('apple')) {
                                    $('#company_mapuri_apple').val(colUris[iu]);
                                };
                                if(colUris[iu].includes('google')) {
                                    $('#company_mapuri_google').val(colUris[iu]);
                                };
                                if(colUris[iu].includes('openstreetmap')) {
                                    $('#company_mapuri_openstreet').val(colUris[iu]);
                                };
                            }
                        }
                    } catch (error) { console.log(error);}
                }
            },
            setCoordMappedChart: function(coords) {
                if(coords != undefined && coords != '') {
                    let osmUrl = company.convertLatLonToEmbed(coords);
                    if(osmUrl != null) {
                        return osmUrl;
                    } else {
                        return '';
                    }
                }
            },
            setOSUrlMappedChart: function(mapurl) {
                if(mapurl != undefined && mapurl != '') {
                    let osmUrl = company.convertOsmUrlToEmbed(mapurl);
                    if(osmUrl != null) {
                        return osmUrl;
                    } else {
                        return '';
                    }
                }
            },
            uploadMedia: async function (spec) {

                let blob = await fetch(spec.url).then(
                    r => r.blob()
                );
                var file = new File([blob], $.utils.createUUID() + spec.ext);
                var formData = new FormData();
                formData.append("file", file);
                formData.append("filekind", spec.kind);
                formData.append("itemtype", spec.type);

                return fetch('/company/details/upload', {
                    method: 'POST',
                    body: formData,
                })
                    .then(response => (response.text()))
                    .then(path => {
                        var returnedPath = String(path).replaceAll('"', '');
                        $('#company_image').data('src', company._mediapath + returnedPath);
                        $('#Picture').val(returnedPath);

                    })
                    .then(text => `Fetched ${spec.url}, and got back ${text}`);
            }, 
            convertOsmUrlToEmbed: function(osmUrl) {
                try {
                       const url = new URL(osmUrl);
                    const hash = url.hash;
                    const match = hash.match(/#map=(\d+)\/([\d.]+)\/([\d.]+)/);

                    if (!match) {
                        throw new Error("Invalid OpenStreetMap URL format.");
                    }

                    const zoom = parseInt(match[1]);
                    const lat = parseFloat(match[2]);
                    const lon = parseFloat(match[3]);

                    const delta = 0.01; // Adjust for bounding box size
                    const bbox = [
                        lon - delta,
                        lat - delta,
                        lon + delta,
                        lat + delta
                    ].map(coord => coord.toFixed(4)).join(',');

                    return `https://www.openstreetmap.org/export/embed.html?bbox=${bbox}&layer=mapnik&marker=${lat},${lon}`;
                } catch(error) {
                    console.log(error);
                }
                return '';
            },
            convertLatLonToEmbed: function(latLonStr) {
                try {
                    const [latStr, lonStr] = latLonStr.split(',');
                    const lat = parseFloat(latStr.trim());
                    const lon = parseFloat(lonStr.trim());

                    if (isNaN(lat) || isNaN(lon)) {
                        throw new Error("Invalid latitude or longitude.");
                    }

                    const delta = 0.01; // Adjust for bounding box size
                    const bbox = [
                        lon - delta,
                        lat - delta,
                        lon + delta,
                        lat + delta
                    ].map(coord => coord.toFixed(4)).join(',');

                    return `https://www.openstreetmap.org/export/embed.html?bbox=${bbox}&layer=mapnik&marker=${lat},${lon}`;
                } catch (error) {
                    console.log(error);
                }
                return '';
            },
            convertLatLonToGoogleMapsUrl : function(latLongStr) {
                try {
                    const parts = latLongStr.split(',');
                    if (parts.length !== 2) {
                        return 'Invalid input. Please provide a comma-separated latitude and longitude.';
                    }

                    const latitude = parts[0].trim();
                    const longitude = parts[1].trim();

                    return `https://www.google.com/maps?q=${latitude},${longitude}`;
                } catch (error) {
                    console.log(error);
                }
                return '';
            },
            convertLatLonToAppleMapsUrl : function(latLongStr) {
                try {
                    const parts = latLongStr.split(',');
                    if (parts.length !== 2) {
                        return 'Invalid input. Please provide a comma-separated latitude and longitude.';
                    }

                    const latitude = parts[0].trim();
                    const longitude = parts[1].trim();

                    return `https://maps.apple.com/?ll=${latitude},${longitude}`;
                } catch (error) {
                    console.log(error);
                }
                return '';
            },
            convertLatLonToOpenStreetMapsUrl : function(latLongStr) {
                try {
                    const parts = latLongStr.split(',');
                    if (parts.length !== 2) {
                        return 'Invalid input. Please provide a comma-separated latitude and longitude.';
                    }

                    const latitude = parts[0].trim();
                    const longitude = parts[1].trim();

                    return `https://www.openstreetmap.org/?mlat=${latitude}&mlon=${longitude}#map=15/${latitude}/${longitude}`;
                } catch (error) {
                    console.log(error);
                }
                return '';
            },
            convertLatLonToMapUrls: function(latLongStr) {
                if(latLongStr != undefined && latLongStr != null && latLongStr != '') {
                    if($('#company_mapuri_apple').val() == '') { $('#company_mapuri_apple').val(company.convertLatLonToAppleMapsUrl(latLongStr)) };
                    if($('#company_mapuri_google').val() == '') { $('#company_mapuri_google').val(company.convertLatLonToGoogleMapsUrl(latLongStr)) };
                    if($('#company_mapuri_openstreet').val() == '') { $('#company_mapuri_openstreet').val(company.convertLatLonToOpenStreetMapsUrl(latLongStr)); };
                }
            },
            openMaps: function(mapskind) {
                if(mapskind != null) {
                    let uri = $('[data-type="map_uri"][data-kind="' + mapskind + '"]').val();
                    if(uri != undefined && uri != null && uri != '' && uri.includes('https')) {
                        window.open(uri, "_blank");
                    } else {
                         toastr.warning(mapskind + ' maps not available, please make sure maps url are correctly added.');
                    }
                }
            }
        }

        company.init();
        ezgomediafetcher.preloadImagesAndVideos(); 
    </script>*@


}