@using EZGO.Maui.Core.Classes;
@using EZGO.Maui.Core.Models;
@using EZGO.Maui.Core.Models.Audits;
@using System.Linq;
@using EZGO.Api.Models.Basic;
@using EZGO.Maui.Core.Models.Tasks
@using EZGO.Api.Models.Enumerations
@using EZGO.Maui.Core.Extensions;
@using EZGO.Maui.Core.Models.Actions;
@using EZGO.Api.Models;
@using EZGO.Maui.Core.PdfTemplates;
@model AuditsModel
@{
    var hasScore = (ScoreTypeEnum)Enum.Parse(typeof(ScoreTypeEnum), Model.ScoreType ?? "thumbs", true) == ScoreTypeEnum.Score;
    var calculator = Model.ScoreColorCalculator;
    var RedColor = ResourceHelper.GetApplicationResource<Color>("RedColor").ToHtmlString();
    var GreenColor = ResourceHelper.GetApplicationResource<Color>("GreenColor").ToHtmlString();
    var SkippedColor = ResourceHelper.GetApplicationResource<Color>("SkippedColor").ToHtmlString();
    var dir = Settings.IsRightToLeftLanguage ? "rtl" : "ltr";

    void GetIconAndColor(TasksTaskModel task, out string icon, out string color)
    {
        switch (task.Status.ToLower())
        {
            case "ok":
                icon = hasScore ? task.Score.ToString() : "thumb_up";
                color = GreenColor;
                break;

            case "skipped":
                icon = "fast_forward";
                color = SkippedColor;
                break;
            default:
                icon = hasScore ? task.Score.ToString() : "thumb_down";
                color = RedColor;
                break;
        }
        if (hasScore && task.Status != "skipped")
        {
            color = calculator.GetColor(task.Score ?? 0).ToHtmlString();
        }
    }

    string GetTagBackgroundColor(string colorCode)
    {
        var color = "#D3D3D3";
        if (!colorCode.IsNullOrEmpty())
        {
            if (colorCode.StartsWith("#"))
                color = colorCode;
            else
                color = "#" + colorCode;
        }
        return color;
    }

    string GetIconClass(string iconStyle)
    {
        if (iconStyle == "solid")
            return "iconSolid";

        return "iconRegular";
    }
}
<!DOCTYPE html>
<html lang="en" dir="@dir">
<head>
    <meta charset="UTF-8" />
    <style type="text/css" media="print">
        @@page {
            size: auto; /* auto is the initial value */
            margin: 0mm; /* this affects the margin in the printer settings */
        }

        * {
            -webkit-print-color-adjust: exact !important; /* needed for fixing issues with colors on ios */
        }

        html {
            background-color: #FFFFFF;
            margin: 0px; /* this affects the margin on the html before sending to printer */
        }

        body {
            margin: 0mm; /* margin you want for the content */
        }
    </style>
    <style type="text/css">
        @@font-face {
            font-family: 'Material Icons';
            font-style: normal;
            font-weight: 400;
            src: url('MaterialIcons-Regular.ttf');
        }

        .material-icons {
            font-family: 'Material Icons';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-feature-settings: 'liga';
            -webkit-font-smoothing: antialiased;
            color: white;
        }

        @@font-face {
            font-family: Roboto-Regular;
            src: url("Roboto-Regular.ttf");
        }

        @@font-face {
            font-family: Roboto-Regular;
            src: url("Roboto-Bold.ttf");
            font-weight: bold;
        }

        @@font-face {
            font-family: Font-Awesome-Regular;
            font-style: normal;
            font-weight: 400;
            src: url('fa_pro_regular_400.otf');
        }

        @@font-face {
            font-family: Font-Awesome-Solid;
            font-style: normal;
            font-weight: 900;
            src: url('fa_pro_solid_900.otf');
        }

        .tagIcon {
            font-style: normal;
            overflow: hidden;
            white-space: nowrap;
            width: 35px;
            padding: 3px 6px;
        }

        .iconSolid {
            font-family: Font-Awesome-Solid;
        }

        .iconRegular {
            font-family: Font-Awesome-Regular;
        }

        html, body {
            font-family: Roboto-Regular;
            margin: 0px;
            padding: 0px;
            height: auto;
            width: 100%;
        }

            body > *:not(table) {
                margin-left: 40px;
                margin-right: 40px;
            }

        .no-padding {
            padding: 0px !important;
        }

        body {
            width: 100%;
        }

        table {
            border-spacing: 0;
            table-layout: auto;
        }

        .id {
            padding-left: 0 10px 0 10px;
        }

        .status-icon-box {
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
        }

        .camera-icon-box-small {
            border-radius: 50%;
            width: 10px;
            height: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            position: relative;
            left: 20px;
            top: 5px;
            border: 1px solid;
            border-color: white;
        }

        .ok {
            background-color: #1ed760;
        }

        .not-ok {
            background-color: red;
        }

        .skip {
            background-color: #EB7D16;
        }

        .break-before {
            page-break-before: always;
        }

        .break-after {
            page-break-after: always;
        }

        td {
            font-size: 12px;
            padding: 0px 5px;
        }

        hr {
            height: 2px;
            background-color: #ccc;
            border: 0px;
        }

        tr {
            padding-right: 5px;
        }

        th span {
            font-size: 10px;
        }

        .page-title {
            color: #A9A9A9;
            font-size: 10px;
        }

        .stripe {
            background-color: #eee;
        }

        #signatures div:not(:first-child) {
            margin-left: 50px;
        }

        .action-pictures-box img {
            margin-right: .5em;
        }

        .action-pictures-box {
            display: flex;
            flex-flow: row wrap;
            justify-items: flex-start;
            align-items: center;
            background: #eee;
            height: 120px;
        }

        .grid-container {
            display: flex;
        }

        .grid-item {
            padding-left: 10px;
        }

        img {
            object-fit: cover;
        }

        .value-item {
            padding-left: 10px;
        }

        .value-style {
            display: flex;
            align-items: center;
            word-wrap: break-word;
            background: white;
            height: 30px;
        }

        .bold {
            font-weight: bold;
        }

        .wrap-content {
            word-break: break-all;
            width: 100%;
        }

        .tagsList {
            display: flex;
            flex-wrap: wrap;
        }

        .tagItem {
            margin-right: 10px;
            margin-bottom: 10px;
            height: 20px;
            width: 115px;
            display: flex;
            align-items: center;
            color: white;
        }

        span.text {
            font-size: 8px;
            padding-right: 10px;
        }

        img.icon {
            width: 15px;
            height: 15px;
            padding-right: 5px;
        }
    </style>
</head>
<body>
    <div>
        <h2 class="wrap-content">@Model.Name</h2>

        <p class="wrap-content"><strong>@(TranslateExtension.GetValueFromDictionary("SIDEBAR_TITLE_AUDIT")):</strong> @Model.Name</p>

        <p class="wrap-content"><strong>@(TranslateExtension.GetValueFromDictionary("GENERATE_PDF_DATE_AND_TIME")):</strong> @(Model.LocalSignedAt.ToString(PdfConstants.GetDateTimeFormat(), null))</p>

        @if (Model.Tags != null && Model.Tags.Any())
        {
            <p class="wrap-content">
                <strong>@(TranslateExtension.GetValueFromDictionary("BASE_TEXT_TAGS")):</strong>
                <tr>
                    <td class="no-padding"></td>
                    <td class="no-padding">
                        <div class="tagsList">
                            @foreach (var tag in Model.Tags)
                            {
                                var backgroundColor = GetTagBackgroundColor(tag.ColorCode);
                                <div class="tagItem" style="background-color: @backgroundColor;">
                                    @if (!tag.IconName.IsNullOrEmpty())
                                    {
                                        <i class="tagIcon @GetIconClass(tag.IconStyle)">@tag.IconName</i>
                                    }
                                    <span class="text">@tag.Name</span>
                                </div>
                            }
                        </div>
                    </td>
                </tr>
            </p>
        }
    </div>

    @if (Model.OpenFieldsProperties != null && Model.OpenFieldsProperties.Count() > 0)
    {
        <hr />

        <div>
            @for (int openFieldIndex = 0; openFieldIndex < Model.OpenFieldsPropertyUserValues.Count(); openFieldIndex++)
            {
                var property = Model.OpenFieldsProperties[openFieldIndex];
                var title = property.TitleDisplay;
                var isRequired = property.IsRequired;

                var fieldValue = Model.OpenFieldsPropertyUserValues[openFieldIndex].GetFieldValue();
                fieldValue ??= string.Empty;

                <p class="wrap-content">
                    <strong>
                        @if (isRequired)
                        {
                            <span style="color:red">*</span>
                        }
                        @title :
                    </strong>
                    @fieldValue
                </p>
            }
        </div>
    }

    <table style="width: 100%; padding-top: 10px;" class="striped">
        <thead>
            <tr>
                <th>&nbsp;</th>
                <th style="text-align: left;"><span style="color:#A9A9A9;"><span style="font-weight: 400;">@(TranslateExtension.GetValueFromDictionary("GENERATE_PDF_TABLE_CHECKS_COLLUMN_NAME"))</span></span></th>
                <th>&nbsp;</th>
                <th style="text-align: left; padding-left: 5px; padding-right: 5px;"><span style="color:#A9A9A9;"><span style="font-weight: 400;">@(TranslateExtension.GetValueFromDictionary("GENERATE_PDF_REMARK"))</span></span></th>
                <th style="text-align: left;"><span style="color:#A9A9A9;"><span style="font-weight: 400;">@(TranslateExtension.GetValueFromDictionary("GENERATE_PDF_STATUS"))</span></span></th>
            </tr>
            <tr class="no-padding">
                <th colspan="9" class="no-padding">
                    <hr />
                </th>
            </tr>
        </thead>
        <tbody>
            @{ var i = 0; }
            @foreach (var task in Model.Tasks)
            {
                <tr>
                <tr class="@(i % 2 == 0 ? "stripe" : "")">
                    <td class="id" style="text-align: center; height:80px; width: 40px; font-size:12px">@(i + 1)</td>
                    @{
                        var imageUrl = @ImageHelpers.GetFullImageUrlFromName(task.Picture);
                        GetIconAndColor(task, out var icon, out var colorHex);
                    }
                    <td style="vertical-align: central;"><img alt="placeholder" src="@imageUrl" style="height: 60px; width: 60px; vertical-align: central;" /></td>
                    <td style="font-size: 12px; text-align:left; justify-content:start">
                        <p class="wrap-content" style="margin: 5px">@task.Name</p>
                        <p class="wrap-content" style="margin: 5px">@task.PropertyValuesString</p>
                    </td>
                    <td>
                        @if (task.HasCommentsOrActions)
                        {
                            <div class="status-icon-box skip">
                                <i class="material-icons" style="text-align: center; font-size: 15px;">flash_on</i>
                            </div>
                        }
                    </td>
                    <td style="vertical-align: central;">
                        <div>
                            @if (task.HasPictureProof)
                            {
                                <div class="camera-icon-box-small" style="background-color: @colorHex;">
                                    <i class="material-icons" style="text-align: center; font-size: 8px;">photo_camera</i>
                                </div>
                            }
                            <div class="status-icon-box" style="background-color: @colorHex;">
                                @if (hasScore && task.Status != "skipped")
                                {
                                    <span style="text-align: center; font-size: 15px;">@icon</span>
                                }
                                else
                                {
                                    <i class="material-icons" style="text-align: center; font-size: 15px;">@icon</i>
                                }
                            </div>
                        </div>
                    </td>
                </tr>
                @if (task.Tags != null && task.Tags.Any())
                {
                    <tr class="@(i % 2 == 0 ? "stripe" : "")">
                        <td colspan="10">
                            <div class="tagsList">
                                @foreach (var tag in task.Tags)
                                {
                                    var backgroundColor = GetTagBackgroundColor(tag.ColorCode);
                                    <div class="tagItem" style="background-color: @backgroundColor;">
                                        @if (!tag.IconName.IsNullOrEmpty())
                                        {
                                            <i class="tagIcon @GetIconClass(tag.IconStyle)">@tag.IconName</i>
                                        }
                                        <span class="text">@tag.Name</span>
                                    </div>
                                }
                            </div>
                        </td>
                    </tr>
                }
                </tr>
                i++;
            }
        </tbody>
    </table>
    <p style="text-align: right; font-size: 12px; padding-right: 10px;">@(TranslateExtension.GetValueFromDictionary("GENERATE_PDF_TABLE_AUDIT_SCORE_TITLE")) @(Model.TotalScore)%</p><br><br>

    @{
        var actionsAndComments = Model.Tasks.Select((task, i) => new { task, i })
            .Where(x => x.task.HasCommentsOrActions && ((x.task.Actions != null && x.task.Actions.Count != 0) || (x.task.Comments != null && x.task.Comments.Count != 0)));
    }
    @if (actionsAndComments.Any())
    {
        <div class="break-before"></div>
    }
    @foreach (var items in actionsAndComments)
    {
        var actions = items.task.Actions ??= new List<ActionsModel>();
        var comments = items.task.Comments ??= new List<Comment>(); ;
        <table style="width: 100%;">
            <thead>
                <tr>
                    <th>&nbsp;</th>
                    <th>&nbsp;</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <th>
                    </th>
                    <th style="text-align: left;">
                        <span class="page-title" style="font-weight: 300">@TranslateExtension.GetValueFromDictionary("GENERATE_PDF_TABLE_COMMENTS_ACTIONS_TITLE")</span>
                    </th>
                </tr>
                @foreach (var action in actions)
                {
                    <tr>
                        <th colspan="9">
                            <hr />
                        </th>
                    </tr>
                    <tr>
                        @if (action == actions.First())
                        {
                            <td style="vertical-align: top; text-align: right;"><p>@(items.i + 1)</p></td>
                        }
                        else
                        {
                            <td></td>
                        }
                        @{
                            var resources = new List<string>();

                            var assignedUsers = action.AssignedUsers.Select(a => a.Name);
                            var assignedAreas = action.AssignedAreas.Select(a => a.Name);

                            resources.AddRange(assignedUsers);
                            resources.AddRange(assignedAreas);
                        }
                        <td style="text-align: left;">
                            <p class="wrap-content"><strong>@(TranslateExtension.GetValueFromDictionary("GENERATE_PDF_COMMENT")):</strong> @action.Comment</p>
                            <p class="wrap-content"><strong>@(TranslateExtension.GetValueFromDictionary("ACTION_SCREEN_TITLE")):</strong> @action.Description</p>
                            <p><strong>@(TranslateExtension.GetValueFromDictionary("ACTION_RESOURCES_EDITED")):</strong> @string.Join(", ", resources) </p>
                            <p><strong>@(TranslateExtension.GetValueFromDictionary("GENERATE_PDF_CREATED")):</strong> @(Settings.ConvertDateTimeToLocal(action.CreatedAt)?.ToString(PdfConstants.GetDateTimeFormat(), null)), @action.CreatedBy</p>
                            <p><strong>@(TranslateExtension.GetValueFromDictionary("ACTIONS_SCREEN_DUE_DATE")):</strong> @(Settings.ConvertDateTimeToLocal(action.DueDate)?.ToString(PdfConstants.GetDateFormat(), null))</p>
                            <p><strong>@(TranslateExtension.GetValueFromDictionary("GENERATE_PDF_PICTURES")):</strong></p>
                        </td>
                    </tr>
                    if (action.Images != null && action.Images.Any())
                    {
                        <tr>
                            <td style="background: #eee" class="no-padding"></td>
                            <td class="no-padding">
                                <div class="action-pictures-box no-padding">
                                    @foreach (var image in action.Images)
                                    {
                                        <img src="@ImageHelpers.GetFullImageUrlFromName(image)" style="height:90px; width:90px;" />
                                    }
                                </div>
                            </td>
                        </tr>
                    }

                    if (action.Tags != null && action.Tags.Any())
                    {
                        <tr>
                            <td class="no-padding"></td>
                            <td class="no-padding">
                                <div class="tagsList">
                                    @foreach (var tag in action.Tags)
                                    {
                                        var backgroundColor = GetTagBackgroundColor(tag.ColorCode);
                                        <div class="tagItem" style="background-color: @backgroundColor;">
                                            @if (!tag.IconName.IsNullOrEmpty())
                                            {
                                                <i class="tagIcon @GetIconClass(tag.IconStyle)">@tag.IconName</i>
                                            }
                                            <span class="text">@tag.Name</span>
                                        </div>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                }
                @foreach (var comment in comments)
                {
                    <tr>
                        <th colspan="9">
                            <hr />
                        </th>
                    </tr>
                    <tr>
                        @if (actions.Count() == 0 && comment == comments.First())
                        {
                            <td style="vertical-align: top; text-align: right;"><p>@(items.i + 1)</p></td>
                        }
                        else
                        {
                            <td></td>
                        }
                        <td style="text-align: left;">
                            <p><strong>@(TranslateExtension.GetValueFromDictionary("GENERATE_PDF_COMMENT")):</strong> @comment.CommentText</p>
                            <p><strong>@(TranslateExtension.GetValueFromDictionary("GENERATE_PDF_CREATED")):</strong> @(Settings.ConvertDateTimeToLocal(comment.CommentDate)?.ToString(PdfConstants.GetDateTimeFormat(), null)), @comment.CreatedBy</p>
                            <p><strong>@(TranslateExtension.GetValueFromDictionary("GENERATE_PDF_PICTURES")):</strong></p>
                        </td>
                    </tr>
                    if (comment.Attachments != null && comment.Attachments.Any())
                    {
                        <tr>
                            <td style="background: #eee" class="no-padding"></td>
                            <td class="no-padding">
                                <div class="action-pictures-box no-padding">
                                    @foreach (var image in comment.Attachments)
                                    {
                                        <img src="@ImageHelpers.GetFullImageUrlFromName(image)" style="height:90px; width:90px;" />
                                    }
                                </div>
                            </td>
                        </tr>
                    }

                    if (comment.Tags != null && comment.Tags.Any())
                    {
                        <tr>
                            <td class="no-padding"></td>
                            <td class="no-padding">
                                <div class="tagsList">
                                    @foreach (var tag in comment.Tags)
                                    {
                                        var backgroundColor = GetTagBackgroundColor(tag.ColorCode);
                                        <div class="tagItem" style="background-color: @backgroundColor;">
                                            @if (!tag.IconName.IsNullOrEmpty())
                                            {
                                                <i class="tagIcon @GetIconClass(tag.IconStyle)">@tag.IconName</i>
                                            }
                                            <span class="text">@tag.Name</span>
                                        </div>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                }
                <tr class="no-padding">
                    <td colspan="4" class="no-padding">
                        <hr class="no-padding" />
                    </td>
                </tr>
            </tbody>
        </table>
    }


    @{
        var pictureProofTasks = Model.Tasks.Select((task, i) => new { task, i })
            .Where(x => x.task.HasPictureProof && x.task.PictureProofMediaItems.Count > 0);
    }
    @if (pictureProofTasks.Any())
    {
        <div class="break-before"></div>
    }
    @foreach (var items in pictureProofTasks)
    {
        var pictureProof = items.task.PictureProofMediaItems ??= new List<MediaItem>();
        <table style="width: 100%;">
            <thead>
                <tr>
                    <th>&nbsp;</th>
                    <th>&nbsp;</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <th>
                    </th>
                    <th style="text-align: left;">
                        <span class="page-title" style="font-weight: 300">@TranslateExtension.GetValueFromDictionary("GENERATE_PDF_TABLE_PICTURE_PROOF_TITLE")</span>
                    </th>
                </tr>
                <tr>
                    <th colspan="9">
                        <hr />
                    </th>
                </tr>
                <tr>
                    <td style="vertical-align: top; text-align: right;"><p>@(items.i + 1)</p></td>
                    <td style="text-align: left;">
                        <p><strong>@(TranslateExtension.GetValueFromDictionary("GENERATE_PDF_CREATED")):</strong> @pictureProof.First().CreatedAt.ToString(PdfConstants.GetDateTimeFormat(), null)</p>
                        <p><strong>@(TranslateExtension.GetValueFromDictionary("GENERATE_PDF_PICTURES")):</strong></p>
                    </td>
                </tr>
                @if (pictureProof.Count() > 0)
                {
                    <tr>
                        <td style="background: #eee" class="no-padding"></td>
                        <td class="no-padding">
                            <div class="action-pictures-box no-padding">
                                @foreach (var image in pictureProof)
                                {
                                    <img src="@ImageHelpers.GetFullImageUrlFromName(image.PictureUrl)" style="height:90px; width:90px;" />
                                }
                            </div>
                        </td>
                    </tr>
                }
                <tr class="no-padding">
                    <td colspan="4" class="no-padding">
                        <hr class="no-padding" />
                    </td>
                </tr>
            </tbody>
        </table>
    }





    <table style="width: 100%; padding:20px; page-break-inside: avoid">
        <tbody>
            <tr>
                <td>&nbsp;</td>
                @foreach (var signature in (Model.Signatures ?? new List<SignatureModel>()))
                {
                    <td style="text-align: center;">
                        @signature.SignedBy
                    </td>
                }

            </tr>
            <tr>
                <td><span style="color:#A9A9A9;">EZ-GO Audit Report</span></td>
                @foreach (var signature in (Model.Signatures ?? new List<SignatureModel>()))
                {
                    // Audits that don't require signature still have a signature object, just without an image
                    if (!string.IsNullOrEmpty(signature.SignatureImage))
                    {
                        var signatureUrl = @ImageHelpers.GetFullImageUrlFromName(signature.SignatureImage);

                        <td><img alt="afbeelding" src="@signatureUrl" height="100" style="display:block; margin: auto" /></td>
                    }
                }
            </tr>
        </tbody>
    </table>

</body>
</html>