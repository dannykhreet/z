@using EZGO.Maui.Core.Models;
@using EZGO.Maui.Core.Models.Assessments;
@using EZGO.Maui.Core.Converter;
@using EZGO.Maui.Core.Classes;
@using System.Linq;
@using EZGO.Api.Models.Basic;
@using EZGO.Maui.Core.Models.Tasks
@using EZGO.Api.Models.Enumerations
@using EZGO.Maui.Core.Extensions;
@using EZGO.Maui.Core.Models.Actions;
@using EZGO.Api.Models;
@using EZGO.Maui.Core.PdfTemplates;
@model AssessmentsModel

@{
    var RedColor = ResourceHelper.GetApplicationResource<Color>("RedColor").ToHtmlString();
    var GreenColor = ResourceHelper.GetApplicationResource<Color>("GreenColor").ToHtmlString();
    var SkippedColor = ResourceHelper.GetApplicationResource<Color>("SkippedColor").ToHtmlString();
    var dir = Settings.IsRightToLeftLanguage ? "rtl" : "ltr";
    var scoreColorCalculator = new InstructionScoreToColorConverter();

    void GetIconAndColor(BasicAssessmentInstructionItemModel instruction, out string icon, out string color)
    {
        icon = instruction.Score.ToString();

        switch (instruction.Score)
        {
            case 5:
                color = GreenColor;
                break;
            case 4:
                color = GreenColor;
                break;
            case 3:
                color = SkippedColor;
                break;
            case 2:
                color = SkippedColor;
                break;
            case 1:
                color = RedColor;
                break;
            case 0:
                color = RedColor;
                break;
            default:
                color = SkippedColor;
                break;
        }
    }

    string GetTagBackgroundColor(string colorCode)
    {
        var color = "#D3D3D3";
        if (!colorCode.IsNullOrEmpty())
        {
            if (colorCode.StartsWith("#"))
                color = colorCode;
            else
                color = "#" + colorCode;
        }
        return color;
    }

    string GetIconClass(string iconStyle)
    {
        if (iconStyle == "solid")
            return "iconSolid";

        return "iconRegular";
    }
}

<!DOCTYPE html>
<html lang="en" dir="@dir">
<head>
    <meta charset="UTF-8" />
    <style type="text/css" media="print">
        @@page {
            size: auto; /* auto is the initial value */
            margin: 0mm; /* this affects the margin in the printer settings */
        }

        * {
            -webkit-print-color-adjust: exact !important; /* needed for fixing issues with colors on ios */
        }

        html {
            background-color: #FFFFFF;
            margin: 0px; /* this affects the margin on the html before sending to printer */
        }

        body {
            margin: 0mm; /* margin you want for the content */
        }
    </style>
    <style type="text/css">
        @@font-face {
            font-family: 'Material Icons';
            font-style: normal;
            font-weight: 400;
            src: url('MaterialIcons-Regular.ttf');
        }

        .material-icons {
            font-family: 'Material Icons';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-feature-settings: 'liga';
            -webkit-font-smoothing: antialiased;
            color: white;
        }

        @@font-face {
            font-family: Roboto-Regular;
            src: url("Roboto-Regular.ttf");
        }

        @@font-face {
            font-family: Roboto-Regular;
            src: url("Roboto-Bold.ttf");
            font-weight: bold;
        }

        @@font-face {
            font-family: Font-Awesome-Regular;
            font-style: normal;
            font-weight: 400;
            src: url('fa_pro_regular_400.otf');
        }

        @@font-face {
            font-family: Font-Awesome-Solid;
            font-style: normal;
            font-weight: 900;
            src: url('fa_pro_solid_900.otf');
        }

        .tagIcon {
            font-style: normal;
            overflow: hidden;
            white-space: nowrap;
            width: 35px;
            padding: 3px 6px;
        }

        .iconSolid {
            font-family: Font-Awesome-Solid;
        }

        .iconRegular {
            font-family: Font-Awesome-Regular;
        }

        .tagsList {
            display: flex;
            flex-wrap: wrap;
        }

        .tagItem {
            margin-right: 10px;
            margin-bottom: 10px;
            height: 20px;
            width: 115px;
            display: flex;
            align-items: center;
            color: white;
        }

        html, body {
            font-family: Roboto-Regular;
            margin: 0px;
            padding: 0px;
            height: auto;
            width: 100%;
        }

            body > *:not(table) {
                margin-left: 40px;
                margin-right: 40px;
            }

        .no-padding {
            padding: 0px !important;
        }

        body {
            width: 100%;
        }

        table {
            border-spacing: 0;
            table-layout: auto;
        }

        .id {
            padding-left: 0 10px 0 10px;
        }

        .status-icon-box {
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
        }

        .camera-icon-box-small {
            border-radius: 50%;
            width: 10px;
            height: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            position: relative;
            left: 20px;
            top: 5px;
            border: 1px solid;
            border-color: white;
        }

        .ok {
            background-color: #1ed760;
        }

        .not-ok {
            background-color: red;
        }

        .skip {
            background-color: #EB7D16;
        }

        .break-before {
            page-break-before: always;
        }

        .break-after {
            page-break-after: always;
        }

        td {
            font-size: 12px;
            padding: 0px 5px;
        }

        hr {
            height: 2px;
            background-color: #ccc;
            border: 0px;
        }

        tr {
            padding-right: 5px;
        }

        th span {
            font-size: 10px;
        }

        .page-title {
            color: #A9A9A9;
            font-size: 10px;
        }

        .stripe {
            background-color: #eee;
        }

        #signatures div:not(:first-child) {
            margin-left: 50px;
        }

        .action-pictures-box img {
            margin-right: .5em;
        }

        .action-pictures-box {
            display: flex;
            flex-flow: row wrap;
            justify-items: flex-start;
            align-items: center;
            background: #eee;
            height: 120px;
        }

        .grid-container {
            display: flex;
        }

        .grid-item {
            padding-left: 10px;
        }

        img {
            object-fit: cover;
        }

        .value-item {
            padding-left: 10px;
        }

        .value-style {
            display: flex;
            align-items: center;
            word-wrap: break-word;
            background: white;
            height: 30px;
        }

        .bold {
            font-weight: bold;
        }

        span.text {
            font-size: 8px;
            padding-right: 10px;
        }

        .wrap-content {
            word-break: break-all;
            width: 100%;
        }
    </style>
</head>
<body>
    <div>
        <h2 class="wrap-content">@Model.Name</h2>
        <p class="wrap-content"><strong>@(TranslateExtension.GetValueFromDictionary("GENERATE_PDF_DATE_AND_TIME")):</strong> @(Model.LocalCompletedAt.ToString(PdfConstants.GetDateTimeFormat(), null))</p>

        @if (Model.Tags != null && Model.Tags.Any())
        {
            <p class="wrap-content">
                <strong>@(TranslateExtension.GetValueFromDictionary("BASE_TEXT_TAGS")):</strong>
                <tr>
                    <td class="no-padding"></td>
                    <td class="no-padding">
                        <div class="tagsList">
                            @foreach (var tag in Model.Tags)
                            {
                                var backgroundColor = GetTagBackgroundColor(tag.ColorCode);
                                <div class="tagItem" style="background-color: @backgroundColor;">
                                    @if (!tag.IconName.IsNullOrEmpty())
                                    {
                                        <i class="tagIcon @GetIconClass(tag.IconStyle)">@tag.IconName</i>
                                    }
                                    <span class="text">@tag.Name</span>
                                </div>
                            }
                        </div>
                    </td>
                </tr>
            </p>
        }
    </div>

    @{ var i = 0; }
    @foreach (var skillInstructions in Model.SkillInstructions)
    {
        <div>
            <h3>@skillInstructions.Name</h3>
            @if (skillInstructions.Tags != null && skillInstructions.Tags.Any())
            {
                <p class="wrap-content">
                    <h4>@(TranslateExtension.GetValueFromDictionary("BASE_TEXT_TAGS")):</h4>
                    <div class="tagsList">
                        @foreach (var tag in skillInstructions.Tags)
                        {
                            var backgroundColor = GetTagBackgroundColor(tag.ColorCode);
                            <div class="tagItem" style="background-color: @backgroundColor;">
                                @if (!tag.IconName.IsNullOrEmpty())
                                {
                                    <i class="tagIcon @GetIconClass(tag.IconStyle)">@tag.IconName</i>
                                }
                                <span class="text">@tag.Name</span>
                            </div>
                        }
                    </div>
                </p>
            }

            <table style="width: 100%; padding-top: 10px;" class="striped">
                <thead>
                    <tr>
                        <th>&nbsp;</th>
                        <th style="text-align: left;"><span style="color:#A9A9A9;"><span style="font-weight: 400;">@(TranslateExtension.GetValueFromDictionary("INSTRUCTIONS_SCREEN_TITLE"))</span></span></th>
                        <th>&nbsp;</th>
                        <th style="text-align: left;"><span style="color:#A9A9A9;"><span style="font-weight: 400;">@(TranslateExtension.GetValueFromDictionary("AUDIT_SCORE_TEXT").Replace(":", ""))</span></span></th>
                    </tr>
                    <tr class="no-padding">
                        <th colspan="9" class="no-padding">
                            <hr />
                        </th>
                    </tr>
                </thead>
                <tbody>
                    @{ var k = 0; }
                    @foreach (var item in skillInstructions.InstructionItems)
                    {
                        <tr class="@(k % 2 == 0 ? "stripe" : "")">
                            <td class="id" style="text-align: center; height:80px; width: 40px; font-size:12px">@(k + 1)</td>
                            @{
                                var imageUrl = @ImageHelpers.GetFullImageUrlFromName(item.Picture);
                                GetIconAndColor(item, out var icon, out var colorHex);
                            }
                            <td style="vertical-align: central;"><img alt="placeholder" src="@imageUrl" style="height: 60px; width: 60px; vertical-align: central;" /></td>
                            <td style="font-size: 12px; text-align:left; justify-content:start; width:80%;">
                                <p style="margin: 5px">@item.Name</p>
                            </td>
                            <td style="vertical-align: central;">
                                <div class="status-icon-box" style="background-color: @colorHex;">
                                    <span style="text-align: center; font-size: 15px;">@icon</span>
                                </div>
                            </td>
                        </tr>
                        k++;
                    }
                </tbody>
            </table>
            <p style="text-align: right; font-size: 12px; padding-right: 10px;">@(TranslateExtension.GetValueFromDictionary("AVARAGE_SCORE")) @(skillInstructions.AverageScoreString)%</p><br><br>
        </div>
    }
    <hr />
    <div>
        <p style="text-align: right; font-size: 12px; padding-right: 10px;">@(TranslateExtension.GetValueFromDictionary("AVARAGE_SCORE")) @(Model.AverageScoreString)%</p><br><br>
    </div>
    <table style="width: 100%; padding:20px; page-break-inside: avoid">
        <tbody>
            @if (Model.Signatures?.Count > 0)
            {
                <tr>
                    <td>&nbsp;</td>
                    @foreach (var signature in (Model.Signatures ?? new List<SignatureModel>()))
                    {
                        <td style="text-align: center;">
                            @signature.SignedBy
                        </td>
                    }

                </tr>
                <tr>
                    <td><span style="color:#A9A9A9;">EZ-GO Assessment Report</span></td>
                    @foreach (var signature in (Model.Signatures ?? new List<SignatureModel>()))
                    {
                        if (!string.IsNullOrEmpty(signature.SignatureImage))
                        {
                            var signatureUrl = @ImageHelpers.GetFullImageUrlFromName(signature.SignatureImage);

                            <td><img alt="afbeelding" src="@signatureUrl" height="100" style="display:block; margin: auto" /></td>
                        }
                    }
                </tr>
            }
            else
            {
                <tr>
                    <td style="font-size: 12px; text-align:left; justify-content:start">
                        <span class="bold">@(TranslateExtension.GetValueFromDictionary("ASSESSEE")):</span> @(Model.CompletedFor)
                    </td>
                </tr>
                <tr>
                    <td style="font-size: 12px; text-align:left; justify-content:start">
                        <span class="bold">@(TranslateExtension.GetValueFromDictionary("ASSESSOR")):</span> @(Model.Assessor)
                    </td>
                </tr>
            }

        </tbody>
    </table>
</body>
</html>
