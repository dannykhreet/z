using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Threading.Tasks;
using EEZGO.Api.Utils.Data;
using EZGO.Api.Data.Enumerations;
using EZGO.Api.Interfaces.Data;
using EZGO.Api.Interfaces.FlattenDataManagers;
using EZGO.Api.Interfaces.Managers;
using EZGO.Api.Interfaces.Settings;
using EZGO.Api.Interfaces.Utils;
using EZGO.Api.Logic.Base;
using EZGO.Api.Logic.FlattenManagers;
using EZGO.Api.Logic.Generation;
using EZGO.Api.Logic.Helpers;
using EZGO.Api.Models;
using EZGO.Api.Models.Basic;
using EZGO.Api.Models.Enumerations;
using EZGO.Api.Models.Filters;
using EZGO.Api.Models.General;
using EZGO.Api.Models.PropertyValue;
using EZGO.Api.Models.Relations;
using EZGO.Api.Models.Reports;
using EZGO.Api.Models.Stats;
using EZGO.Api.Models.Tags;
using EZGO.Api.Models.WorkInstructions;
using EZGO.Api.Settings;
using EZGO.Api.Settings.Helpers;
using EZGO.Api.Utils.Cache;
using EZGO.Api.Utils.Converters;
using EZGO.Api.Utils.Data;
using EZGO.Api.Utils.Json;
using EZGO.Api.Utils.Mappers;
using Microsoft.Extensions.Caching.Memory;
using Microsoft.Extensions.Logging;
using Npgsql;

//TODO sort methods, rename all append methods in same structure.

namespace EZGO.Api.Logic.Managers
{
    /// <summary>
    /// TaskManager; The TaskManager contains all logic for retrieving and setting Tasks (TasksTask), TaskTemplates, TaskRecurrencies and TaskTemplateSteps.
    /// Tasks are used as Tasks, Audit Items and Checklist items. 
    /// There are multiple kind of tasks. Depending on type these need to be execute in the app on a certain date. 
    /// Tasks are generated by the TaskGeneration process and located in the tasks_task table. 
    /// Tasks are based on a TaskTemplate. 
    /// NOTE! this manager due to its size needs to be split up in the future.
    /// </summary>
    public class TaskManager : BaseManager<TaskManager>, ITaskManager
    {
        #region - properties -
        private string culture;
        public string Culture
        {
            get { return culture; }
            set { culture = _tagManager.Culture = value; }
        }
        #endregion

        #region - privates -
        private readonly IMemoryCache _cache;
        private readonly IDatabaseAccessHelper _manager;
        private readonly IActionManager _actionManager;
        private readonly IAreaManager _areaManager;
        private readonly IAreaBasicManager _areaBasicManager;
        private readonly IDataAuditing _dataAuditing;
        private readonly IUserAccessManager _userAccessManager;
        private readonly IConfigurationHelper _configurationHelper;
        private readonly IPropertyValueManager _propertyValueManager;
        private readonly IWorkInstructionManager _workInstructionManager;
        private readonly ITaskGenerationManager _taskGenerationManager;
        private readonly ITagManager _tagManager;
        private readonly IUserManager _userManager;
        private readonly IGeneralManager _generalManager;
        private readonly IFlattenTaskManager _flattenTaskManager;
        private readonly IShiftManager _shiftManager;
        private readonly ICompanyManager _companyManager;
        private readonly ITranslationManager _translationManager;
        #endregion

        #region - constructor(s) -
        public TaskManager(IDatabaseAccessHelper manager, IFlattenTaskManager flattenTaskManager, IGeneralManager generalManager, ITagManager tagManager, IUserManager userManager, IPropertyValueManager propertyValueManager, IWorkInstructionManager workInstructionManager, IActionManager actionManager, IAreaManager areaManager, IAreaBasicManager areaBasicManager, ITaskGenerationManager taskGenerationManager, IDataAuditing dataAuditing, IConfigurationHelper configurationHelper, IUserAccessManager userAccessManager, ILogger<TaskManager> logger, IMemoryCache memoryCache, IShiftManager shiftManager, ICompanyManager companyManager, ITranslationManager translationManager) : base(logger)
        {
            _cache = memoryCache;
            _manager = manager;
            _actionManager = actionManager;
            _areaManager = areaManager;
            _areaBasicManager = areaBasicManager;
            _dataAuditing = dataAuditing;
            _userAccessManager = userAccessManager;
            _configurationHelper = configurationHelper;
            _propertyValueManager = propertyValueManager;
            _workInstructionManager = workInstructionManager;
            _taskGenerationManager = taskGenerationManager;
            _tagManager = tagManager;
            _userManager = userManager;
            _generalManager = generalManager;
            _flattenTaskManager = flattenTaskManager;
            _shiftManager = shiftManager;
            _companyManager = companyManager;
            _translationManager = translationManager;
        }
        #endregion

        #region - public methods Tasks -
        /// <summary>
        /// GetTasksAsync; Get tasks of a company. Tasks's are based on the [tasks_task] table in the database.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="timestamp">TimeStamp, for getting all tasks where the timestamp is between start date and end date of a task.</param>
        /// <param name="filters">Filters that can be used for filtering the data. Depending on implementation, filters can be done within the stored procedures or afterwards.</param>
        /// <param name="include">Include parameter can be used for including extra data, based on includes enum.</param>
        /// <returns>A list of tasks. </returns>
        public async Task<List<TasksTask>> GetTasksAsync(int companyId, int? userId = null, DateTime? timestamp = null, DateTime? starttimestamp = null, DateTime? endtimestamp = null, TaskFilters? filters = null, string include = null)
        {
            if (timestamp == null || timestamp.Value == DateTime.MinValue)
            {
                timestamp = DateTime.Now;
            }

            var output = new List<TasksTask>();
            string language = Culture;
            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));

                var useV2 = await _generalManager.GetSettingResourceByKey("TECH_TASK_RETRIEVAL_V2");
                var sp = "get_tasks";
                if (useV2?.Value?.Equals("ON") == true)
                {
                    sp = "get_tasks_v2";
                }

                if (starttimestamp.HasValue && starttimestamp.Value > DateTime.MinValue && endtimestamp.HasValue && endtimestamp.Value > DateTime.MinValue)
                {
                    sp = "get_tasks_by_start_end_date";
                    parameters.Add(new NpgsqlParameter("@_starttimestamp", starttimestamp));
                    parameters.Add(new NpgsqlParameter("@_endtimestamp", endtimestamp));
                }
                else
                {
                    parameters.Add(new NpgsqlParameter("@_timestamp", timestamp));
                }

                if (filters.HasValue)
                {
                    if (filters.Value.Limit.HasValue && filters.Value.Limit.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_limit", filters.Value.Limit.Value));
                    }

                    if (filters.Value.Offset.HasValue && filters.Value.Offset.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_offset", filters.Value.Offset.Value));
                    }

                    if (filters.Value.AreaId.HasValue && filters.Value.AreaId.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_areaid", filters.Value.AreaId.Value));
                    }

                    if (filters.Value.AllowedOnly.HasValue && filters.Value.AllowedOnly.Value && userId.HasValue && userId > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_userid", userId.Value));
                    }

                    if (filters.Value.TagIds != null && filters.Value.TagIds.Length > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_tagids", filters.Value.TagIds));
                    }
                }

                using (dr = await _manager.GetDataReader(sp, commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        var task = CreateOrFillTaskFromReader(dr);
                        output.Add(task);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTasksAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            if (filters.HasValue && filters.Value.HasFilters())
            {
                output = (await FilterTasks(companyId: companyId, userId: userId, filters: filters.Value, nonFilteredCollection: output)).ToList();
            }

            if (output.Count > 0)
            {
                output = await AppendCompletedDeeplinkIdToTasks(companyId: companyId, tasks: output); //no include needed for backwards compatibility
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Steps.ToString().ToLower())) output = await AppendStepsTaskAsync(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.PropertyUserValues.ToString().ToLower())) output = await AppendPropertyUserValuesToTasks(tasks: output, companyId: companyId, include: include);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertyValues.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.Properties.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.PropertyDetails.ToString().ToLower()))) output = await AppendTemplatePropertiesToTasks(tasks: output, companyId: companyId, isActive: true, include: include);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.InstructionRelations.ToString().ToLower())) output = await AppendWorkInstructionRelations(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.PictureProof.ToString().ToLower())) output = await AppendPictureProof(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Tags.ToString().ToLower())) output = await AppendTagsToTasksAsync(tasks: output, companyId: companyId, fromTemplates: true);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.UserInformation.ToString().ToLower()))) output = await AppendUserInformationToTasksAsync(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Language.ToString().ToLower())) output = await AppendTranslationsToTasksAsync(tasks: output, companyId: companyId, language);
                if (await _generalManager.GetHasAccessToFeatureByCompany(companyId: companyId, featurekey: "TECH_FLATTEN_DATA"))
                {
                    output = await ApplyTemplateVersionToTasks(output, companyId, include);
                }
                //based on task.AreaId so this has to be done after ApplyTemplateVersionToTasks since the AreaId may change based on historic data
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.AreaPaths.ToString().ToLower())) output = await AppendAreaPathsToTasksAsync(tasks: output, companyId: companyId, addAreaPath: include.Split(",").Contains(IncludesEnum.AreaPaths.ToString().ToLower()), addAreaPathIds: include.Split(",").Contains(IncludesEnum.AreaPathIds.ToString().ToLower()));
            }

            return output;
        }

        private async Task<List<TasksTask>> ApplyTemplateVersionToTasks(List<TasksTask> tasks, int companyId, string include = null)
        {
            //cache versioned templates based on template id and version
            Dictionary<KeyValuePair<int, string>, TaskTemplate> VersionedTasksCache = new();
            foreach (TasksTask task in tasks)
            {
                if (!string.IsNullOrEmpty(task.Version) && task.Version != await _flattenTaskManager.RetrieveLatestAvailableVersion(task.TemplateId, companyId))
                {
                    TaskTemplate versionedTemplate = null;
                    KeyValuePair<int, string> TemplateIdVersionPair = new(task.TemplateId, task.Version);

                    if (VersionedTasksCache.ContainsKey(TemplateIdVersionPair))
                    {
                        //get correct version of template from cache if it is already present
                        versionedTemplate = VersionedTasksCache.GetValueOrDefault(TemplateIdVersionPair);
                    }
                    else
                    {
                        //retrieve the correct version of the template from the database and add it to the cache
                        versionedTemplate = await _flattenTaskManager.RetrieveFlattenData(templateId: task.TemplateId, companyId: companyId, version: task.Version);
                        VersionedTasksCache.Add(TemplateIdVersionPair, versionedTemplate);
                    }

                    if (versionedTemplate != null)
                        task.ApplyTemplateVersion(versionedTemplate, include);
                    else
                        _logger.LogWarning($"ApplyTemplateVersionToTasks(); Template version not applied because requested version wasn't found. TaskTemplateId: {task.TemplateId}, version: {task.Version}");
                }
            }
            return tasks;
        }

        /// <summary>
        /// GetTasksSplitByTypeAsync;
        /// </summary>
        /// <param name="companyId"></param>
        /// <param name="userId"></param>
        /// <param name="timestamp"></param>
        /// <param name="starttimestamp"></param>
        /// <param name="endtimestamp"></param>
        /// <param name="filters"></param>
        /// <param name="include"></param>
        /// <returns></returns>
        public async Task<List<TasksTask>> GetTasksSplitByTypeAsync(int companyId, int userId, DateTime? timestamp = null, DateTime? starttimestamp = null, DateTime? endtimestamp = null, TaskFilters? filters = null, string include = null)
        {
            var output = new List<TasksTask>();
            string language = Culture;
            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));
                var sp = "get_tasks_g4_v3";

                if (starttimestamp.HasValue && starttimestamp.Value > DateTime.MinValue && endtimestamp.HasValue && endtimestamp.Value > DateTime.MinValue)
                {
                    parameters.Add(new NpgsqlParameter("@_starttimestamp", starttimestamp));
                    parameters.Add(new NpgsqlParameter("@_endtimestamp", endtimestamp));
                }

                if (timestamp.HasValue && timestamp.Value > DateTime.MinValue)
                {
                    parameters.Add(new NpgsqlParameter("@_timestamp", timestamp));
                }

                if (filters.HasValue)
                {
                    parameters.AddRange(GetNpgsqlParametersFromTaskFilter(filters.Value, userId));
                    
                    if(filters.Value.Limit.HasValue && filters.Value.Limit.Value > 0)
                        parameters.Add(new NpgsqlParameter("@_limit", filters.Value.Limit.Value));

                    if (filters.Value.Offset.HasValue && filters.Value.Offset.Value > 0)
                        parameters.Add(new NpgsqlParameter("@_offset", filters.Value.Offset.Value));
                }

                using (dr = await _manager.GetDataReader(sp, commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        var task = CreateOrFillTaskFromReader(dr);
                        output.Add(task);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTasksSplitByTypeAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            if (filters.Value.RemoveOverDueTasks)
            {
                List<TasksTask> overdueTasks = await GetTasksOverdueAsync(companyId: companyId, userId: userId, timestamp: filters.Value.Timestamp, filters: filters);

                output.RemoveAll(x => overdueTasks.FirstOrDefault(y => x.TemplateId == y.TemplateId) != null);
            }


            if (filters.Value.DeduplicatedForDisplay)
            {
                //remove shift tasks outside of current shift
                Shift shift = await _shiftManager.GetShiftByTimestampAsync(companyId: companyId, timestamp: null);
                output.RemoveAll(x => x.ShiftId != shift.Id && x.ShiftId != null);

                ////Find overdue tasks
                //List<TasksTask> pastTasks = output.FindAll(x =>  x.ShiftId == null && x.DueAt < filters.Value.Timestamp);
                ////Remove overdue tasks
                //output.RemoveAll(x =>  pastTasks.Contains(x));
                ////remove future tasks that have an overdue task
                //output.RemoveAll(x => pastTasks.FirstOrDefault(y => x.TemplateId == y.TemplateId && x.StartDate >= filters.Value.Timestamp) != null);

                //remove tasks with more than one future occurence in the output. Keep only the task with the first startdate
                foreach (TasksTask task in output.FindAll(x => x.ShiftId == null))
                {
                    output.RemoveAll(x => x.TemplateId == task.TemplateId && x.StartAt > task.StartAt);
                }
            }

            if (output.Count > 0)
            {
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Steps.ToString().ToLower())) output = await AppendStepsTaskAsync(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.PropertyUserValues.ToString().ToLower())) output = await AppendPropertyUserValuesToTasks(tasks: output, companyId: companyId, include: include);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertyValues.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.Properties.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.PropertyDetails.ToString().ToLower()))) output = await AppendTemplatePropertiesToTasks(tasks: output, companyId: companyId, isActive: true, include: include);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.InstructionRelations.ToString().ToLower())) output = await AppendWorkInstructionRelations(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.PictureProof.ToString().ToLower())) output = await AppendPictureProof(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Tags.ToString().ToLower())) output = await AppendTagsToTasksAsync(tasks: output, companyId: companyId, fromTemplates: true);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.UserInformation.ToString().ToLower()))) output = await AppendUserInformationToTasksAsync(tasks: output, companyId: companyId);

                if (await _generalManager.GetHasAccessToFeatureByCompany(companyId: companyId, featurekey: "TECH_FLATTEN_DATA"))
                {
                    output = await ApplyTemplateVersionToTasks(output, companyId, include);
                }
                //based on task.AreaId so this has to be done after ApplyTemplateVersionToTasks since the AreaId may change based on historic data
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.AreaPaths.ToString().ToLower())) output = await AppendAreaPathsToTasksAsync(tasks: output, companyId: companyId, addAreaPath: include.Split(",").Contains(IncludesEnum.AreaPaths.ToString().ToLower()), addAreaPathIds: include.Split(",").Contains(IncludesEnum.AreaPathIds.ToString().ToLower()));
                
                output = await ReplacePropertiesWithPropertiesGen4(output, companyId: companyId); //party uses template data for properties, so this also needs to happen after ApplyTemplateVersionToTasks
            }

            return output;
        }

        public async Task<TasksWithMetaData> GetTasksGen4Async(int companyId, int userId, Gen4TaskFilters filters, string include = null)
        {
            var sp = "get_tasks_g4_v3";
            if (filters.Timespan == TaskTimeSpanEnum.Overdue)
            {
                sp = "get_tasks_overdue_g4";
            }

            TasksWithMetaData output = new TasksWithMetaData();
            output.Data = new List<TasksTask>();

            NpgsqlDataReader dr = null;

            //Collect parameters
            filters = await EnrichGen4TaskFilter(companyId: companyId, filters: filters);
            List<NpgsqlParameter> parameters = GetNpgsqlParametersFromGen4TaskFilter(companyId: companyId, filters: filters, timestamp: await _companyManager.GetCompanyLocalTime(companyId));

            try
            {

                using (dr = await _manager.GetDataReader(sp, commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        output.Data.Add(CreateOrFillTaskFromReader(dr));
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTasksGen4Async(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }


            if (output.Data.Count > 0)
            {
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Steps.ToString().ToLower())) output.Data = await AppendStepsTaskAsync(tasks: output.Data, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.PropertyUserValues.ToString().ToLower())) output.Data = await AppendPropertyUserValuesToTasks(tasks: output.Data, companyId: companyId, include: include);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertyValues.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.Properties.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.PropertyDetails.ToString().ToLower()))) output.Data = await AppendTemplatePropertiesToTasks(tasks: output.Data, companyId: companyId, isActive: true, include: include);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.InstructionRelations.ToString().ToLower())) output.Data = await AppendWorkInstructionRelations(tasks: output.Data, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.PictureProof.ToString().ToLower())) output.Data = await AppendPictureProof(tasks: output.Data, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Tags.ToString().ToLower())) output.Data = await AppendTagsToTasksAsync(tasks: output.Data, companyId: companyId, fromTemplates: true);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.UserInformation.ToString().ToLower()))) output.Data = await AppendUserInformationToTasksAsync(tasks: output.Data, companyId: companyId);

                if (await _generalManager.GetHasAccessToFeatureByCompany(companyId: companyId, featurekey: "TECH_FLATTEN_DATA"))
                {
                    output.Data = await ApplyTemplateVersionToTasks(output.Data, companyId, include);
                }
                //based on task.AreaId so this has to be done after ApplyTemplateVersionToTasks since the AreaId may change based on historic data
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.AreaPaths.ToString().ToLower())) output.Data = await AppendAreaPathsToTasksAsync(tasks: output.Data, companyId: companyId, addAreaPath: include.Split(",").Contains(IncludesEnum.AreaPaths.ToString().ToLower()), addAreaPathIds: include.Split(",").Contains(IncludesEnum.AreaPathIds.ToString().ToLower()));

                output.Data = await ReplacePropertiesWithPropertiesGen4(output.Data, companyId: companyId); //party uses template data for properties, so this also needs to happen after ApplyTemplateVersionToTasks
            }

            output.Meta = new TasksMetaData();
            if (filters.Timespan != TaskTimeSpanEnum.Overdue)
            {
                output.Meta.Start = filters.StartTimestamp.Value;
                output.Meta.End = filters.EndTimestamp.Value;
            }

            filters.Statuses = null;

            output.Meta.Counts = await GetFilteredTaskCount(companyId: companyId, filters: filters);

            return output;
        }

        public async Task<List<TasksTaskStatus>> GetTaskStatusHistoryAsync(int companyId, int taskId)
        {
            List<TasksTaskStatus> result = new List<TasksTaskStatus>();
            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = _manager.GetBaseParameters(companyId);
                parameters.Add(new NpgsqlParameter("@_taskid", taskId));

                string sp = "get_task_status_history_gen4";

                using (dr = await _manager.GetDataReader(sp, commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        var taskStatus = CreateOrFillTaskStatusFromReader(dr);
                        result.Add(taskStatus);
                    }
                }

            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTaskStatusHistoryAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(Settings.ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            return result;
        }


        /// <summary>
        /// GetTasksByDayAsync;
        /// </summary>
        /// <param name="companyId"></param>
        /// <param name="userId"></param>
        /// <param name="timestamp"></param>
        /// <param name="filters"></param>
        /// <param name="include"></param>
        /// <returns></returns>
        public async Task<List<TasksTask>> GetTasksByDayAsync(int companyId, int userId, DateTime timestamp, TaskFilters? filters = null, string include = null)
        {
            var output = new List<TasksTask>();
            string language = Culture;
            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));
                parameters.Add(new NpgsqlParameter("@_timestamp", timestamp.Date));

                var sp = "get_tasks_related_to_day_gen4";



                if (filters.HasValue)
                {
                    if (filters.Value.EndTimestamp.HasValue && filters.Value.EndTimestamp > DateTime.MinValue)
                    {
                        parameters.Add(new NpgsqlParameter("@_timestampend", filters.Value.EndTimestamp));
                    }
                    if (filters.Value.Limit.HasValue && filters.Value.Limit.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_limit", filters.Value.Limit.Value));
                    }

                    if (filters.Value.Offset.HasValue && filters.Value.Offset.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_offset", filters.Value.Offset.Value));
                    }

                    if (filters.Value.AreaId.HasValue && filters.Value.AreaId.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_areaid", filters.Value.AreaId.Value));
                    }

                    if (filters.Value.Statuses != null && filters.Value.Statuses.Count > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_statuses", filters.Value.Statuses.Select(status => status.ToString().ToLower()).ToArray()));
                    }

                    if (filters.Value.AllowedOnly.HasValue && filters.Value.AllowedOnly.Value && userId > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_userid", userId));
                    }

                    if (filters.Value.TagIds != null && filters.Value.TagIds.Length > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_tagids", filters.Value.TagIds));
                    }

                    if (!string.IsNullOrEmpty(filters.Value.FilterText))
                    {
                        parameters.Add(new NpgsqlParameter("@_filtertext", filters.Value.FilterText.ToString()));
                    }
                }

                using (dr = await _manager.GetDataReader(sp, commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        var task = CreateOrFillTaskFromReader(dr);
                        output.Add(task);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTasksByDayAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);              
            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            if (output.Count > 0)
            {
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Steps.ToString().ToLower())) output = await AppendStepsTaskAsync(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.AreaPaths.ToString().ToLower())) output = await AppendAreaPathsToTasksAsync(tasks: output, companyId: companyId, addAreaPath: include.Split(",").Contains(IncludesEnum.AreaPaths.ToString().ToLower()), addAreaPathIds: include.Split(",").Contains(IncludesEnum.AreaPathIds.ToString().ToLower()));
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.PropertyUserValues.ToString().ToLower())) output = await AppendPropertyUserValuesToTasks(tasks: output, companyId: companyId, include: include);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertyValues.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.Properties.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.PropertyDetails.ToString().ToLower()))) output = await AppendTemplatePropertiesToTasks(tasks: output, companyId: companyId, isActive: true, include: include);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.InstructionRelations.ToString().ToLower())) output = await AppendWorkInstructionRelations(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.PictureProof.ToString().ToLower())) output = await AppendPictureProof(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Tags.ToString().ToLower())) output = await AppendTagsToTasksAsync(tasks: output, companyId: companyId, fromTemplates: true);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.UserInformation.ToString().ToLower()))) output = await AppendUserInformationToTasksAsync(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Language.ToString().ToLower())) output = await AppendTranslationsToTasksAsync(tasks: output, companyId: companyId, language);

                output = await ReplacePropertiesWithPropertiesGen4(output, companyId);
            }

            return output;
        }

        /// <summary>
        /// GetTasksOverdueAsync; Get all overdue tasks for a certain timestamp.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="timestamp">TimeStamp, for getting all tasks where the timestamp is between start date and end date of a task.</param>
        /// <param name="filters">Filters that can be used for filtering the data. Depending on implementation, filters can be done within the stored procedures or afterwards.</param>
        /// <param name="include">Include items, currently Steps and AreaPaths area available.</param>
        /// <returns>List of tasks objects.</returns>
        public async Task<List<TasksTask>> GetTasksOverdueAsync(int companyId, int? userId = null, DateTime? timestamp = null, TaskFilters? filters = null, string include = null)
        {
            if (timestamp == null || timestamp.Value == DateTime.MinValue)
            {
                timestamp = DateTime.Now;
            }

            var output = new List<TasksTask>();
            string language = Culture;
            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));
                parameters.Add(new NpgsqlParameter("@_timestamp", timestamp));

                if (filters.HasValue)
                {
                    if (filters.Value.AreaId.HasValue)
                    {
                        parameters.Add(new NpgsqlParameter("@_areaid", filters.Value.AreaId.Value));
                    }

                    if (filters.Value.AllowedOnly.HasValue && filters.Value.AllowedOnly.Value && userId.HasValue)
                    {
                        parameters.Add(new NpgsqlParameter("@_userid", userId.Value));
                    }
                    
                    if (filters.Value.TagIds != null && filters.Value.TagIds.Length > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_tagids", filters.Value.TagIds));
                    }
                }

                var sp = "get_tasks_overdue";

                using (dr = await _manager.GetDataReader(sp, commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        var task = CreateOrFillTaskFromReader(dr);
                        output.Add(task);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTasksOverdueAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            if (filters.HasValue && filters.Value.HasFilters())
            {
                output = (await FilterOverdueTasks(companyId: companyId, userId: userId, filters: filters.Value, nonFilteredCollection: output)).ToList();
            }

            if (output.Count > 0)
            {
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Steps.ToString().ToLower())) output = await AppendStepsTaskAsync(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertyUserValues.ToString().ToLower()))) output = await AppendPropertyUserValuesToTasks(tasks: output, companyId: companyId, include: include);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertyValues.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.Properties.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.PropertyDetails.ToString().ToLower()))) output = await AppendTemplatePropertiesToTasks(tasks: output, companyId: companyId, isActive: true, include: include);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.InstructionRelations.ToString().ToLower()))) output = await AppendWorkInstructionRelations(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.PictureProof.ToString().ToLower())) output = await AppendPictureProof(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Tags.ToString().ToLower())) output = await AppendTagsToTasksAsync(tasks: output, companyId: companyId, fromTemplates: true);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.UserInformation.ToString().ToLower()))) output = await AppendUserInformationToTasksAsync(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Language.ToString().ToLower())) output = await AppendTranslationsToTasksAsync(tasks: output, companyId: companyId, language);

            

                if (await _generalManager.GetHasAccessToFeatureByCompany(companyId: companyId, featurekey: "TECH_FLATTEN_DATA"))
                {
                    output = await ApplyTemplateVersionToTasks(output, companyId, include);
                }
                //based on task.AreaId so this has to be done after ApplyTemplateVersionToTasks since the AreaId may change based on historic data
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.AreaPaths.ToString().ToLower())) output = await AppendAreaPathsToTasksAsync(tasks: output, companyId: companyId, addAreaPath: include.Split(",").Contains(IncludesEnum.AreaPaths.ToString().ToLower()), addAreaPathIds: include.Split(",").Contains(IncludesEnum.AreaPathIds.ToString().ToLower()));
            }

            return output;
        }

        /// <summary>
        /// GetTasksRelatedToPreviousShiftAsync; Get tasks by shift, this will return all tasks for a specific previous shift id based on timestamp; All other filters will be implemented as is (same as tasks calls);
        /// Besided the current shift also the items that should be done within this shift (month, week, onetimeonly) and tasks finished within this shift will be returned.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="userId">UserId (DB: profile_user.id)</param>
        /// <param name="timestamp">TimeStamp, for getting all tasks where the timestamp is between start date and end date of a task.</param>
        /// <param name="filters">Filters that can be used for filtering the data. Depending on implementation, filters can be done within the stored procedures or afterwards.</param>
        /// <param name="include">Include items, currently Steps and AreaPaths area available.</param>
        /// <returns></returns>
        public async Task<List<TasksTask>> GetTasksRelatedToPreviousShiftAsync(int companyId, int? userId = null, DateTime? timestamp = null, TaskFilters? filters = null, string include = null)
        {
            if (timestamp == null || timestamp.Value == DateTime.MinValue)
            {
                timestamp = DateTime.Now;
            }

            var output = new List<TasksTask>();
            string language = Culture;
            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));
                parameters.Add(new NpgsqlParameter("@_timestamp", timestamp));

                if (filters.HasValue)
                {
                    if (filters.Value.Limit.HasValue && filters.Value.Limit.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_limit", filters.Value.Limit.Value));
                    }

                    if (filters.Value.Offset.HasValue && filters.Value.Offset.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_offset", filters.Value.Offset.Value));
                    }

                    if (filters.Value.AreaId.HasValue && filters.Value.AreaId.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_areaid", filters.Value.AreaId.Value));
                    }

                    if (filters.Value.AllowedOnly.HasValue && filters.Value.AllowedOnly.Value && userId.HasValue && userId > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_userid", userId.Value));
                    }

                    if (filters.Value.TagIds != null && filters.Value.TagIds.Length > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_tagids", filters.Value.TagIds));
                    }
                }

                //TODO activate
                var sp = "get_tasks_related_to_previous_shift_times";

                using (dr = await _manager.GetDataReader(sp, commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        var task = CreateOrFillTaskFromReader(dr);
                        output.Add(task);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTasksRelatedToPreviousShiftAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            if (filters.HasValue && filters.Value.HasFilters())
            {
                output = (await FilterTasks(companyId: companyId, userId: userId, filters: filters.Value, nonFilteredCollection: output)).ToList();
            }

            if (output.Count > 0)
            {
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Steps.ToString().ToLower())) output = await AppendStepsTaskAsync(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertyUserValues.ToString().ToLower()))) output = await AppendPropertyUserValuesToTasks(tasks: output, companyId: companyId, include: include);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertyValues.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.Properties.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.PropertyDetails.ToString().ToLower()))) output = await AppendTemplatePropertiesToTasks(tasks: output, companyId: companyId, include: include);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.InstructionRelations.ToString().ToLower()))) output = await AppendWorkInstructionRelations(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.PictureProof.ToString().ToLower())) output = await AppendPictureProof(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Tags.ToString().ToLower())) output = await AppendTagsToTasksAsync(tasks: output, companyId: companyId, fromTemplates: true);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.UserInformation.ToString().ToLower()))) output = await AppendUserInformationToTasksAsync(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Language.ToString().ToLower())) output = await AppendTranslationsToTasksAsync(tasks: output, companyId: companyId, language);
                if (await _generalManager.GetHasAccessToFeatureByCompany(companyId: companyId, featurekey: "TECH_FLATTEN_DATA"))
                {
                    output = await ApplyTemplateVersionToTasks(output, companyId, include);
                }
                //based on task.AreaId so this has to be done after ApplyTemplateVersionToTasks since the AreaId may change based on historic data
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.AreaPaths.ToString().ToLower())) output = await AppendAreaPathsToTasksAsync(tasks: output, companyId: companyId);
            }

            return output;
        }

        /// <summary>
        /// GetTasksRelatedToShiftAsync; Get tasks by shift, this will return all tasks for a specific shift based on timespan; All other filters will be implemented as is (same as tasks calls);
        /// Besided the current shift also the items that should be done within this shift (month, week, onetimeonly) and tasks finished within this shift will be returned.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="userId">UserId (DB: profile_user.id)</param>
        /// <param name="timestamp">TimeStamp, for getting all tasks where the timestamp is between start date and end date of a task.</param>
        /// <param name="filters">Filters that can be used for filtering the data. Depending on implementation, filters can be done within the stored procedures or afterwards.</param>
        /// <param name="include">Include items, currently Steps and AreaPaths area available.</param>
        /// <returns></returns>
        public async Task<List<TasksTask>> GetTasksRelatedToShiftAsync(int companyId, int? userId = null, DateTime? timestamp = null, TaskFilters? filters = null, string include = null)
        {
            if (timestamp == null || timestamp.Value == DateTime.MinValue)
            {
                timestamp = DateTime.Now;
            }

            var output = new List<TasksTask>();
            string language = Culture;
            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));
                parameters.Add(new NpgsqlParameter("@_timestamp", timestamp));

                if (filters.HasValue)
                {
                    if (!string.IsNullOrEmpty(filters.Value.FilterText))
                    {
                        parameters.Add(new NpgsqlParameter("@_filtertext", filters.Value.FilterText));
                    }

                    if (filters.Value.Limit.HasValue && filters.Value.Limit.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_limit", filters.Value.Limit.Value));
                    }

                    if (filters.Value.Offset.HasValue && filters.Value.Offset.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_offset", filters.Value.Offset.Value));
                    }

                    if (filters.Value.AreaId.HasValue && filters.Value.AreaId.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_areaid", filters.Value.AreaId.Value));
                    }

                    if (filters.Value.AllowedOnly.HasValue && filters.Value.AllowedOnly.Value && userId.HasValue && userId > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_userid", userId.Value));
                    }

                    if (filters.Value.TagIds != null && filters.Value.TagIds.Length > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_tagids", filters.Value.TagIds));
                    }
                }

                var sp = "get_tasks_related_to_shift_times";

                using (dr = await _manager.GetDataReader(sp, commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        var task = CreateOrFillTaskFromReader(dr);
                        output.Add(task);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTasksRelatedToShiftAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            if (filters.HasValue && filters.Value.HasFilters())
            {
                output = (await FilterTasks(companyId: companyId, userId: userId, filters: filters.Value, nonFilteredCollection: output)).ToList();
            }

            if (output.Count > 0)
            {
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Steps.ToString().ToLower())) output = await AppendStepsTaskAsync(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertyUserValues.ToString().ToLower()))) output = await AppendPropertyUserValuesToTasks(tasks: output, companyId: companyId, include: include);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertyValues.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.Properties.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.PropertyDetails.ToString().ToLower()))) output = await AppendTemplatePropertiesToTasks(tasks: output, companyId: companyId, include: include);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.InstructionRelations.ToString().ToLower()))) output = await AppendWorkInstructionRelations(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.PictureProof.ToString().ToLower())) output = await AppendPictureProof(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Tags.ToString().ToLower())) output = await AppendTagsToTasksAsync(tasks: output, companyId: companyId, fromTemplates: true);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.UserInformation.ToString().ToLower()))) output = await AppendUserInformationToTasksAsync(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Language.ToString().ToLower())) output = await AppendTranslationsToTasksAsync(tasks: output, companyId: companyId, language);
                if (await _generalManager.GetHasAccessToFeatureByCompany(companyId: companyId, featurekey: "TECH_FLATTEN_DATA"))
                {
                    output = await ApplyTemplateVersionToTasks(output, companyId, include);
                }
                //based on task.AreaId so this has to be done after ApplyTemplateVersionToTasks since the AreaId may change based on historic data
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.AreaPaths.ToString().ToLower())) output = await AppendAreaPathsToTasksAsync(tasks: output, companyId: companyId);
            }

            return output;
        }

        /// <summary>
        /// GetTasksYesterdayAsync; Get tasks based on the day before the timestamp, this will return all tasks for a specific shifts for this day and also the items that should be done on this day (month, week, onetime only) and tasks finished on this day will be returned.
        /// All other filters will be implemented as is (same as tasks calls);
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="userId">UserId (DB: profile_user.id)</param>
        /// <param name="timestamp">TimeStamp, for getting all tasks where the timestamp is between start date and end date of a task.</param>
        /// <param name="filters">Filters that can be used for filtering the data. Depending on implementation, filters can be done within the stored procedures or afterwards.</param>
        /// <param name="include">Include items, currently Steps and AreaPaths area available.</param>
        /// <returns></returns>
        public async Task<List<TasksTask>> GetTasksYesterdayAsync(int companyId, int? userId = null, DateTime? timestamp = null, TaskFilters? filters = null, string include = null)
        {
            if (timestamp == null || timestamp.Value == DateTime.MinValue)
            {
                timestamp = DateTime.Now;
            }

            var output = new List<TasksTask>();
            string language = Culture;

            var cacheKey = CacheHelpers.GenerateCacheKey(CacheSettings.CacheKeyTasksYesterday, companyId,
                                             "timestamp", timestamp.Value.ToString("dd-MM-yyyy"),
                                             "filters.limit", filters.Value.Limit.HasValue ? filters.Value.Limit.Value.ToString() : "-",
                                             "filters.offset", filters.Value.Offset.HasValue ? filters.Value.Offset.Value.ToString() : "-",
                                             "filters.areaid", filters.Value.AreaId.HasValue ? filters.Value.AreaId.Value.ToString() : "-",
                                             "filters.allowedonly", filters.Value.AllowedOnly.HasValue ? filters.Value.AllowedOnly.Value.ToString() : "-",
                                             "filters.recurrencytype", filters.Value.RecurrencyType.HasValue ? filters.Value.RecurrencyType.Value.ToString() : "-",
                                             "filters.recurrencyid", filters.Value.RecurrencyId.HasValue ? filters.Value.RecurrencyId.Value.ToString() : "-",
                                             "filters.templateid", filters.Value.TemplateId.HasValue ? filters.Value.TemplateId.Value.ToString() : "-",
                                             "filters.shiftid", filters.Value.ShiftId.HasValue ? filters.Value.ShiftId.Value.ToString() : "-",
                                             "filters.status", filters.Value.Status.HasValue ? filters.Value.Status.Value.ToString() : "-",
                                             "filters.iscompleted", filters.Value.IsCompleted.HasValue ? filters.Value.IsCompleted.Value.ToString() : "-",
                                             "filters.tagids", (filters.Value.TagIds != null && filters.Value.TagIds.Length > 0) ? filters.Value.TagIds.ToString() : "-",
                                             "userid", userId.HasValue ? userId.Value.ToString() : "-",
                                             "include", string.IsNullOrEmpty(include) ? "" : include.ToString()
                                             );

            if (_cache.TryGetValue(cacheKey, out output))
            {
                if (output != null && output.Any() && output.Count > 0 && output.Where(x => x.CompanyId == companyId).Any()) return output;
            }

            NpgsqlDataReader dr = null;

            try
            {
                if (output == null) output = new List<TasksTask>();
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));
                parameters.Add(new NpgsqlParameter("@_timestamp", timestamp));

                if (filters.HasValue)
                {
                    if (!string.IsNullOrEmpty(filters.Value.FilterText))
                    {
                        parameters.Add(new NpgsqlParameter("@_filtertext", filters.Value.FilterText));
                    }

                    if (filters.Value.Limit.HasValue && filters.Value.Limit.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_limit", filters.Value.Limit.Value));
                    }

                    if (filters.Value.Offset.HasValue && filters.Value.Offset.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_offset", filters.Value.Offset.Value));
                    }

                    if (filters.Value.AreaId.HasValue && filters.Value.AreaId.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_areaid", filters.Value.AreaId.Value));
                    }

                    if (filters.Value.AllowedOnly.HasValue && filters.Value.AllowedOnly.Value && userId.HasValue && userId > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_userid", userId.Value));
                    }

                    if (filters.Value.TagIds != null && filters.Value.TagIds.Length > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_tagids", filters.Value.TagIds));
                    }
                }

                var sp = "get_tasks_related_to_yesterday";

                using (dr = await _manager.GetDataReader(sp, commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        var task = CreateOrFillTaskFromReader(dr);
                        output.Add(task);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTasksYesterdayAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            if (filters.HasValue && filters.Value.HasFilters())
            {
                output = (await FilterTasks(companyId: companyId, userId: userId, filters: filters.Value, nonFilteredCollection: output)).ToList();
            }

            if (output.Count > 0)
            {
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Steps.ToString().ToLower())) output = await AppendStepsTaskAsync(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertyUserValues.ToString().ToLower()))) output = await AppendPropertyUserValuesToTasks(tasks: output, companyId: companyId, include: include);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertyValues.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.Properties.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.PropertyDetails.ToString().ToLower()))) output = await AppendTemplatePropertiesToTasks(tasks: output, companyId: companyId, include: include);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.InstructionRelations.ToString().ToLower()))) output = await AppendWorkInstructionRelations(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.PictureProof.ToString().ToLower())) output = await AppendPictureProof(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Tags.ToString().ToLower())) output = await AppendTagsToTasksAsync(tasks: output, companyId: companyId, fromTemplates: true);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.UserInformation.ToString().ToLower()))) output = await AppendUserInformationToTasksAsync(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Language.ToString().ToLower())) output = await AppendTranslationsToTasksAsync(tasks: output, companyId: companyId, language);
                if (await _generalManager.GetHasAccessToFeatureByCompany(companyId: companyId, featurekey: "TECH_FLATTEN_DATA"))
                {
                    output = await ApplyTemplateVersionToTasks(output, companyId, include);
                }
                //based on task.AreaId so this has to be done after ApplyTemplateVersionToTasks since the AreaId may change based on historic data
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.AreaPaths.ToString().ToLower())) output = await AppendAreaPathsToTasksAsync(tasks: output, companyId: companyId);
            }

            _cache.Set(cacheKey, output, new MemoryCacheEntryOptions() { AbsoluteExpirationRelativeToNow = TimeSpan.FromSeconds(CacheSettings.CacheTimeDefaultInSeconds) });

            return output;
        }

        /// <summary>
        /// GetTasksPeriodAsync; Get tasks based on the day before the timestamp, this will return all tasks for a specific shifts for this day and also the items that should be done on this day (month, week, onetime only) and tasks finished on this day will be returned.
        /// All other filters will be implemented as is (same as tasks calls);
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="userId">UserId (DB: profile_user.id)</param>
        /// <param name="from">DateTime value to get data from period</param>
        /// <param name="to">DateTime value to get data to period</param>
        /// <param name="filters">Filters that can be used for filtering the data. Depending on implementation, filters can be done within the stored procedures or afterwards.</param>
        /// <param name="include">Include items, currently Steps and AreaPaths area available.</param>
        /// <returns></returns>
        public async Task<List<TasksTask>> GetTasksPeriodAsync(int companyId, int? userId = null, DateTime? from = null, DateTime? to = null, TaskFilters? filters = null, string include = null)
        {
            var output = new List<TasksTask>();
            string language = Culture;
            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));
                parameters.Add(new NpgsqlParameter("@_from", from));
                parameters.Add(new NpgsqlParameter("@_to", to));

                if (filters.HasValue)
                {
                    if (filters.Value.Limit.HasValue && filters.Value.Limit.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_limit", filters.Value.Limit.Value));
                    }

                    if (filters.Value.Offset.HasValue && filters.Value.Offset.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_offset", filters.Value.Offset.Value));
                    }

                    if (filters.Value.AreaId.HasValue && filters.Value.AreaId.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_areaid", filters.Value.AreaId.Value));
                    }

                    if (filters.Value.AllowedOnly.HasValue && filters.Value.AllowedOnly.Value && userId.HasValue && userId > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_userid", userId.Value));
                    }

                    if (filters.Value.TagIds != null && filters.Value.TagIds.Length > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_tagids", filters.Value.TagIds));
                    }

                    if (filters.Value.TemplateId.HasValue && filters.Value.TemplateId > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_templateid", filters.Value.TemplateId));
                    }
                }

                var sp = "get_task_details_from_to";

                using (dr = await _manager.GetDataReader(sp, commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        var task = CreateOrFillTaskFromReader(dr);
                        output.Add(task);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTasksPeriodAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            if (filters.HasValue && filters.Value.HasFilters())
            {
                output = (await FilterTasks(companyId: companyId, userId: userId, filters: filters.Value, nonFilteredCollection: output)).ToList();
            }

            if (output.Count > 0)
            {
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Steps.ToString().ToLower())) output = await AppendStepsTaskAsync(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertyUserValues.ToString().ToLower()))) output = await AppendPropertyUserValuesToTasks(tasks: output, companyId: companyId, include: include);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertyValues.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.Properties.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.PropertyDetails.ToString().ToLower()))) output = await AppendTemplatePropertiesToTasks(tasks: output, companyId: companyId, include: include);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.InstructionRelations.ToString().ToLower()))) output = await AppendWorkInstructionRelations(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.PictureProof.ToString().ToLower())) output = await AppendPictureProof(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Tags.ToString().ToLower())) output = await AppendTagsToTasksAsync(tasks: output, companyId: companyId, fromTemplates: true);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.UserInformation.ToString().ToLower()))) output = await AppendUserInformationToTasksAsync(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Language.ToString().ToLower())) output = await AppendTranslationsToTasksAsync(tasks: output, companyId: companyId, language);
                if (await _generalManager.GetHasAccessToFeatureByCompany(companyId: companyId, featurekey: "TECH_FLATTEN_DATA"))
                {
                    output = await ApplyTemplateVersionToTasks(output, companyId, include);
                }
                //based on task.AreaId so this has to be done after ApplyTemplateVersionToTasks since the AreaId may change based on historic data
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.AreaPaths.ToString().ToLower())) output = await AppendAreaPathsToTasksAsync(tasks: output, companyId: companyId);
            }

            return output;
        }

        /// <summary>
        /// GetTasksLastWeekAsync; Get tasks based on the week before the timestamp, this will return all tasks for a specific shifts for this day and also the items that should be done on this day (month, week, onetime only) and tasks finished on this day will be returned.
        /// All other filters will be implemented as is (same as tasks calls);
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="userId">UserId (DB: profile_user.id)</param>
        /// <param name="timestamp">TimeStamp, for getting all tasks where the timestamp is between start date and end date of a task.</param>
        /// <param name="filters">Filters that can be used for filtering the data. Depending on implementation, filters can be done within the stored procedures or afterwards.</param>
        /// <param name="include">Include items, currently Steps and AreaPaths area available.</param>
        /// <returns></returns>
        public async Task<List<TasksTask>> GetTasksLastWeekAsync(int companyId, int? userId = null, DateTime? timestamp = null, TaskFilters? filters = null, string include = null)
        {
            if (timestamp == null || timestamp.Value == DateTime.MinValue)
            {
                timestamp = DateTime.Now;
            }

            var output = new List<TasksTask>();
            string language = Culture;

            var cacheKey = CacheHelpers.GenerateCacheKey(CacheSettings.CacheKeyTasksWeekly, companyId,
                                                         "timestamp", timestamp.Value.ToString("dd-MM-yyyy"),
                                                         "filters.limit", filters.Value.Limit.HasValue ? filters.Value.Limit.Value.ToString() : "-",
                                                         "filters.offset", filters.Value.Offset.HasValue ? filters.Value.Offset.Value.ToString() : "-",
                                                         "filters.areaid", filters.Value.AreaId.HasValue ? filters.Value.AreaId.Value.ToString() : "-",
                                                         "filters.allowedonly", filters.Value.AllowedOnly.HasValue ? filters.Value.AllowedOnly.Value.ToString() : "-",
                                                         "filters.recurrencytype", filters.Value.RecurrencyType.HasValue ? filters.Value.RecurrencyType.Value.ToString() : "-",
                                                         "filters.recurrencyid", filters.Value.RecurrencyId.HasValue ? filters.Value.RecurrencyId.Value.ToString() : "-",
                                                         "filters.templateid", filters.Value.TemplateId.HasValue ? filters.Value.TemplateId.Value.ToString() : "-",
                                                         "filters.shiftid", filters.Value.ShiftId.HasValue ? filters.Value.ShiftId.Value.ToString() : "-",
                                                         "filters.status", filters.Value.Status.HasValue ? filters.Value.Status.Value.ToString() : "-",
                                                         "filters.iscompleted", filters.Value.IsCompleted.HasValue ? filters.Value.IsCompleted.Value.ToString() : "-",
                                                         "filters.tagids", (filters.Value.TagIds != null && filters.Value.TagIds.Length > 0) ? filters.Value.TagIds.ToString() : "-",
                                                         "userid", userId.HasValue ? userId.Value.ToString() : "-",
                                                         "include", string.IsNullOrEmpty(include) ? "" : include.ToString()
                                                         );


            if (_cache.TryGetValue(cacheKey, out output))
            {
                if (output != null && output.Any() && output.Count > 0 && output.Where(x => x.CompanyId == companyId).Any()) return output;
            }

            NpgsqlDataReader dr = null;

            try
            {
                if (output == null) output = new List<TasksTask>();
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));
                parameters.Add(new NpgsqlParameter("@_timestamp", timestamp));

                if (filters.HasValue)
                {
                    if (!string.IsNullOrEmpty(filters.Value.FilterText))
                    {
                        parameters.Add(new NpgsqlParameter("@_filtertext", filters.Value.FilterText));
                    }

                    if (filters.Value.Limit.HasValue && filters.Value.Limit.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_limit", filters.Value.Limit.Value));
                    }

                    if (filters.Value.Offset.HasValue && filters.Value.Offset.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_offset", filters.Value.Offset.Value));
                    }

                    if (filters.Value.AreaId.HasValue && filters.Value.AreaId.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_areaid", filters.Value.AreaId.Value));
                    }

                    if (filters.Value.AllowedOnly.HasValue && filters.Value.AllowedOnly.Value && userId.HasValue && userId > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_userid", userId.Value));
                    }

                    if (filters.Value.TagIds != null && filters.Value.TagIds.Length > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_tagids", filters.Value.TagIds));
                    }
                }

                var sp = "get_tasks_related_to_lastweek";

                using (dr = await _manager.GetDataReader(sp, commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        var task = CreateOrFillTaskFromReader(dr);
                        output.Add(task);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTasksLastWeekAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);

            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            if (filters.HasValue && filters.Value.HasFilters())
            {
                output = (await FilterTasks(companyId: companyId, userId: userId, filters: filters.Value, nonFilteredCollection: output)).ToList();
            }

            if (output.Count > 0)
            {
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Steps.ToString().ToLower())) output = await AppendStepsTaskAsync(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertyUserValues.ToString().ToLower()))) output = await AppendPropertyUserValuesToTasks(tasks: output, companyId: companyId, include: include);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertyValues.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.Properties.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.PropertyDetails.ToString().ToLower()))) output = await AppendTemplatePropertiesToTasks(tasks: output, companyId: companyId, include: include);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.InstructionRelations.ToString().ToLower()))) output = await AppendWorkInstructionRelations(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.PictureProof.ToString().ToLower())) output = await AppendPictureProof(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Tags.ToString().ToLower())) output = await AppendTagsToTasksAsync(tasks: output, companyId: companyId, fromTemplates: true);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.UserInformation.ToString().ToLower()))) output = await AppendUserInformationToTasksAsync(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Language.ToString().ToLower())) output = await AppendTranslationsToTasksAsync(tasks: output, companyId: companyId, language);
                if (await _generalManager.GetHasAccessToFeatureByCompany(companyId: companyId, featurekey: "TECH_FLATTEN_DATA"))
                {
                    output = await ApplyTemplateVersionToTasks(output, companyId, include);
                }
                //based on task.AreaId so this has to be done after ApplyTemplateVersionToTasks since the AreaId may change based on historic data
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.AreaPaths.ToString().ToLower())) output = await AppendAreaPathsToTasksAsync(tasks: output, companyId: companyId);
            }

            _cache.Set(cacheKey, output, new MemoryCacheEntryOptions() { AbsoluteExpirationRelativeToNow = TimeSpan.FromSeconds(CacheSettings.CacheTimeDefaultInSeconds) });

            return output;
        }

        /// <summary>
        /// GetTasksActionsAsync; Get all tasks that are directly connected to an action.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="filters">Filters that can be used for filtering the data. Depending on implementation, filters can be done within the stored procedures or afterwards.</param>
        /// <param name="include">Include items, currently Steps and AreaPaths area available.</param>
        /// <returns>List of tasks.</returns>
        public async Task<List<TasksTask>> GetTasksActionsAsync(int companyId, int? userId = null, TaskFilters? filters = null, string include = null)
        {
            var output = new List<TasksTask>();
            string language = Culture;
            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));

                if (filters.Value.TagIds != null && filters.Value.TagIds.Length > 0)
                {
                    parameters.Add(new NpgsqlParameter("@_tagids", filters.Value.TagIds));
                }

                var sp = "get_tasks_with_actions";

                using (dr = await _manager.GetDataReader(sp, commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        var task = CreateOrFillTaskFromReader(dr);
                        output.Add(task);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTasksActionsAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            if (filters.HasValue && filters.Value.HasFilters())
            {
                output = (await FilterTasksOther(companyId: companyId, userId: userId, filters: filters.Value, nonFilteredCollection: output)).ToList();
            }

            if (output.Count > 0)
            {
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Steps.ToString().ToLower())) output = await AppendStepsTaskAsync(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertyUserValues.ToString().ToLower()))) output = await AppendPropertyUserValuesToTasks(tasks: output, companyId: companyId, include: include);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertyValues.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.Properties.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.PropertyDetails.ToString().ToLower()))) output = await AppendTemplatePropertiesToTasks(tasks: output, companyId: companyId, include: include);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.InstructionRelations.ToString().ToLower()))) output = await AppendWorkInstructionRelations(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.PictureProof.ToString().ToLower())) output = await AppendPictureProof(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Tags.ToString().ToLower())) output = await AppendTagsToTasksAsync(tasks: output, companyId: companyId, fromTemplates: true);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.UserInformation.ToString().ToLower()))) output = await AppendUserInformationToTasksAsync(tasks: output, companyId: companyId);

                if (await _generalManager.GetHasAccessToFeatureByCompany(companyId: companyId, featurekey: "TECH_FLATTEN_DATA"))
                {
                    output = await ApplyTemplateVersionToTasks(output, companyId, include);
                }
                //based on task.AreaId so this has to be done after ApplyTemplateVersionToTasks since the AreaId may change based on historic data
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.AreaPaths.ToString().ToLower())) output = await AppendAreaPathsToTasksAsync(tasks: output, companyId: companyId);
            }

            return output;
        }

        public async Task<List<TasksTask>> GetTasksAuditActionsAsync(int companyId, int? userId = null, TaskFilters? filters = null, string include = null)
        {
            var output = new List<TasksTask>();
            string language = Culture;
            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));

                if (filters.Value.TagIds != null && filters.Value.TagIds.Length > 0)
                {
                    parameters.Add(new NpgsqlParameter("@_tagids", filters.Value.TagIds));
                }

                var sp = "get_tasks_audits_with_actions";

                using (dr = await _manager.GetDataReader(sp, commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        var task = CreateOrFillTaskFromReader(dr);
                        output.Add(task);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetAuditTasksActionsAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            if (filters.HasValue && filters.Value.HasFilters())
            {
                output = (await FilterTasksOther(companyId: companyId, userId: userId, filters: filters.Value, nonFilteredCollection: output)).ToList();
            }

            if (output.Count > 0)
            {
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Steps.ToString().ToLower())) output = await AppendStepsTaskAsync(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertyUserValues.ToString().ToLower()))) output = await AppendPropertyUserValuesToTasks(tasks: output, companyId: companyId, include: include);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertyValues.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.Properties.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.PropertyDetails.ToString().ToLower()))) output = await AppendTemplatePropertiesToTasks(tasks: output, companyId: companyId, include: include);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.InstructionRelations.ToString().ToLower()))) output = await AppendWorkInstructionRelations(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.PictureProof.ToString().ToLower())) output = await AppendPictureProof(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Tags.ToString().ToLower())) output = await AppendTagsToTasksAsync(tasks: output, companyId: companyId, fromTemplates: true);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.UserInformation.ToString().ToLower()))) output = await AppendUserInformationToTasksAsync(tasks: output, companyId: companyId);

                if (await _generalManager.GetHasAccessToFeatureByCompany(companyId: companyId, featurekey: "TECH_FLATTEN_DATA"))
                {
                    output = await ApplyTemplateVersionToTasks(output, companyId, include);
                }
                //based on task.AreaId so this has to be done after ApplyTemplateVersionToTasks since the AreaId may change based on historic data
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.AreaPaths.ToString().ToLower())) output = await AppendAreaPathsToTasksAsync(tasks: output, companyId: companyId);
            }

            return output;
        }

        public async Task<List<TasksTask>> GetTasksChecklistActionsAsync(int companyId, int? userId = null, TaskFilters? filters = null, string include = null)
        {
            var output = new List<TasksTask>();
            string language = Culture;
            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));

                if (filters.Value.TagIds != null && filters.Value.TagIds.Length > 0)
                {
                    parameters.Add(new NpgsqlParameter("@_tagids", filters.Value.TagIds));
                }

                var sp = "get_tasks_checklists_with_actions";

                using (dr = await _manager.GetDataReader(sp, commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        var task = CreateOrFillTaskFromReader(dr);
                        output.Add(task);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetChecklistTasksActionsAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            if (filters.HasValue && filters.Value.HasFilters())
            {
                output = (await FilterTasksOther(companyId: companyId, userId: userId, filters: filters.Value, nonFilteredCollection: output)).ToList();
            }

            if (output.Count > 0)
            {
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Steps.ToString().ToLower())) output = await AppendStepsTaskAsync(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertyUserValues.ToString().ToLower()))) output = await AppendPropertyUserValuesToTasks(tasks: output, companyId: companyId, include: include);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertyValues.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.Properties.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.PropertyDetails.ToString().ToLower()))) output = await AppendTemplatePropertiesToTasks(tasks: output, companyId: companyId, include: include);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.InstructionRelations.ToString().ToLower()))) output = await AppendWorkInstructionRelations(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.PictureProof.ToString().ToLower())) output = await AppendPictureProof(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Tags.ToString().ToLower())) output = await AppendTagsToTasksAsync(tasks: output, companyId: companyId, fromTemplates: true);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.UserInformation.ToString().ToLower()))) output = await AppendUserInformationToTasksAsync(tasks: output, companyId: companyId);

                if (await _generalManager.GetHasAccessToFeatureByCompany(companyId: companyId, featurekey: "TECH_FLATTEN_DATA"))
                {
                    output = await ApplyTemplateVersionToTasks(output, companyId, include);
                }
                //based on task.AreaId so this has to be done after ApplyTemplateVersionToTasks since the AreaId may change based on historic data
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.AreaPaths.ToString().ToLower())) output = await AppendAreaPathsToTasksAsync(tasks: output, companyId: companyId);
            }

            return output;
        }

        /// <summary>
        /// GetTasksCommentsAsync; Get tasks based on if they are attached to comments.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="userId">UserId (DB: profiles_user.id)</param>
        /// <param name="filters">Filters that can be used for filtering the data. Depending on implementation, filters can be done within the stored procedures or afterwards.</param>
        /// <param name="include">Include parameter can be used for including extra data, based on includes enum.</param>
        /// <returns>List of tasks.</returns>
        public async Task<List<TasksTask>> GetTasksCommentsAsync(int companyId, int? userId = null, TaskFilters? filters = null, string include = null)
        {
            var output = new List<TasksTask>();

            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));

                if (filters.Value.TagIds != null && filters.Value.TagIds.Length > 0)
                {
                    parameters.Add(new NpgsqlParameter("@_tagids", filters.Value.TagIds));
                }

                var sp = "get_tasks_with_comments";

                using (dr = await _manager.GetDataReader(sp, commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        var task = CreateOrFillTaskFromReader(dr);
                        output.Add(task);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTasksCommentsAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            if (filters.HasValue && filters.Value.HasFilters())
            {
                output = (await FilterTasksOther(companyId: companyId, userId: userId, filters: filters.Value, nonFilteredCollection: output)).ToList();
            }

            if (output.Count > 0)
            {
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Steps.ToString().ToLower())) output = await AppendStepsTaskAsync(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertyUserValues.ToString().ToLower()))) output = await AppendPropertyUserValuesToTasks(tasks: output, companyId: companyId, include: include);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertyValues.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.Properties.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.PropertyDetails.ToString().ToLower()))) output = await AppendTemplatePropertiesToTasks(tasks: output, companyId: companyId, include: include);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.InstructionRelations.ToString().ToLower()))) output = await AppendWorkInstructionRelations(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.PictureProof.ToString().ToLower())) output = await AppendPictureProof(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Tags.ToString().ToLower())) output = await AppendTagsToTasksAsync(tasks: output, companyId: companyId, fromTemplates: true);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.UserInformation.ToString().ToLower()))) output = await AppendUserInformationToTasksAsync(tasks: output, companyId: companyId);

                if (await _generalManager.GetHasAccessToFeatureByCompany(companyId: companyId, featurekey: "TECH_FLATTEN_DATA"))
                {
                    output = await ApplyTemplateVersionToTasks(output, companyId, include);
                }
                //based on task.AreaId so this has to be done after ApplyTemplateVersionToTasks since the AreaId may change based on historic data
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.AreaPaths.ToString().ToLower())) output = await AppendAreaPathsToTasksAsync(tasks: output, companyId: companyId);
            }

            return output;
        }

        public async Task<List<TasksTask>> GetTasksAuditCommentsAsync(int companyId, int? userId = null, TaskFilters? filters = null, string include = null)
        {
            var output = new List<TasksTask>();
            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));

                if (filters.Value.TagIds != null && filters.Value.TagIds.Length > 0)
                {
                    parameters.Add(new NpgsqlParameter("@_tagids", filters.Value.TagIds));
                }

                var sp = "get_tasks_audits_with_comments";

                using (dr = await _manager.GetDataReader(sp, commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        var task = CreateOrFillTaskFromReader(dr);
                        output.Add(task);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetAuditTasksCommentsAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            if (filters.HasValue && filters.Value.HasFilters())
            {
                output = (await FilterTasksOther(companyId: companyId, userId: userId, filters: filters.Value, nonFilteredCollection: output)).ToList();
            }

            if (output.Count > 0)
            {
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Steps.ToString().ToLower())) output = await AppendStepsTaskAsync(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertyUserValues.ToString().ToLower()))) output = await AppendPropertyUserValuesToTasks(tasks: output, companyId: companyId, include: include);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertyValues.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.Properties.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.PropertyDetails.ToString().ToLower()))) output = await AppendTemplatePropertiesToTasks(tasks: output, companyId: companyId, include: include);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.InstructionRelations.ToString().ToLower()))) output = await AppendWorkInstructionRelations(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.PictureProof.ToString().ToLower())) output = await AppendPictureProof(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Tags.ToString().ToLower())) output = await AppendTagsToTasksAsync(tasks: output, companyId: companyId, fromTemplates: true);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.UserInformation.ToString().ToLower()))) output = await AppendUserInformationToTasksAsync(tasks: output, companyId: companyId);

                if (await _generalManager.GetHasAccessToFeatureByCompany(companyId: companyId, featurekey: "TECH_FLATTEN_DATA"))
                {
                    output = await ApplyTemplateVersionToTasks(output, companyId, include);
                }
                //based on task.AreaId so this has to be done after ApplyTemplateVersionToTasks since the AreaId may change based on historic data
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.AreaPaths.ToString().ToLower())) output = await AppendAreaPathsToTasksAsync(tasks: output, companyId: companyId);
            }

            return output;
        }

        public async Task<List<TasksTask>> GetTasksChecklistCommentsAsync(int companyId, int? userId = null, TaskFilters? filters = null, string include = null)
        {
            var output = new List<TasksTask>();
            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));

                if (filters.Value.TagIds != null && filters.Value.TagIds.Length > 0)
                {
                    parameters.Add(new NpgsqlParameter("@_tagids", filters.Value.TagIds));
                }

                var sp = "get_tasks_checklists_with_comments";

                using (dr = await _manager.GetDataReader(sp, commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        var task = CreateOrFillTaskFromReader(dr);
                        output.Add(task);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetChecklistTasksCommentsAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            if (filters.HasValue && filters.Value.HasFilters())
            {
                output = (await FilterTasksOther(companyId: companyId, userId: userId, filters: filters.Value, nonFilteredCollection: output)).ToList();
            }

            if (output.Count > 0)
            {
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Steps.ToString().ToLower())) output = await AppendStepsTaskAsync(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertyUserValues.ToString().ToLower()))) output = await AppendPropertyUserValuesToTasks(tasks: output, companyId: companyId, include: include);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertyValues.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.Properties.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.PropertyDetails.ToString().ToLower()))) output = await AppendTemplatePropertiesToTasks(tasks: output, companyId: companyId, include: include);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.InstructionRelations.ToString().ToLower()))) output = await AppendWorkInstructionRelations(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.PictureProof.ToString().ToLower())) output = await AppendPictureProof(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Tags.ToString().ToLower())) output = await AppendTagsToTasksAsync(tasks: output, companyId: companyId, fromTemplates: true);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.UserInformation.ToString().ToLower()))) output = await AppendUserInformationToTasksAsync(tasks: output, companyId: companyId);

                if (await _generalManager.GetHasAccessToFeatureByCompany(companyId: companyId, featurekey: "TECH_FLATTEN_DATA"))
                {
                    output = await ApplyTemplateVersionToTasks(output, companyId, include);
                }
                //based on task.AreaId so this has to be done after ApplyTemplateVersionToTasks since the AreaId may change based on historic data
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.AreaPaths.ToString().ToLower())) output = await AppendAreaPathsToTasksAsync(tasks: output, companyId: companyId);
            }

            return output;
        }


        /// <summary>
        /// GetTasksByAuditIdAsync; Get a list of tasks based on AuditId;
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="auditId">Audit (DB: audits_audit.id)</param>
        /// <returns>A list of TasksTaks objects.</returns>
        public async Task<List<TasksTask>> GetTasksByAuditIdAsync(int companyId, int auditId, string include = null, ConnectionKind connectionKind = ConnectionKind.Reader)
        {
            var output = new List<TasksTask>();
            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));
                parameters.Add(new NpgsqlParameter("@_auditid", auditId));

                using (dr = await _manager.GetDataReader("get_tasks_by_audit", commandType: CommandType.StoredProcedure, parameters: parameters, connectionKind: connectionKind))
                {
                    while (await dr.ReadAsync())
                    {
                        var task = CreateOrFillTaskFromReader(dr);
                        output.Add(task);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTasksByAuditAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            if (output.Count > 0)
            {
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Tags.ToString().ToLower())) output = await AppendTagsToTasksAsync(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.PropertyUserValues.ToString().ToLower())) output = await AppendPropertyUserValuesToTasks(tasks: output, companyId: companyId, include: include, connectionKind: connectionKind);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertyValues.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.Properties.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.PropertyDetails.ToString().ToLower()))) output = await AppendTemplatePropertiesToTasks(tasks: output, companyId: companyId, include: include, connectionKind: connectionKind);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.PictureProof.ToString().ToLower())) output = await AppendPictureProof(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.UserInformation.ToString().ToLower()))) output = await AppendUserInformationToTasksAsync(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertiesGen4.ToString().ToLower()))) output = await ReplacePropertiesWithPropertiesGen4(output, companyId);
            }

            return output;
        }

        /// <summary>
        /// GetTaskTemplatesByAuditTemplateIdAsync;  Get a list of tasks based on AuditId;
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="auditTemplateId">AuditTemplateId (DB: audits_audittemplates.id)</param>
        /// <returns>A list of tasks</returns>
        public async Task<List<TaskTemplate>> GetTaskTemplatesByAuditTemplateIdAsync(int companyId, int auditTemplateId, string include = null)
        {
            var output = new List<TaskTemplate>();
            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));
                parameters.Add(new NpgsqlParameter("@_audittemplateid", auditTemplateId));

                using (dr = await _manager.GetDataReader("get_tasktemplates_by_audittemplate", commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        var tasktemplate = CreateOrFillTaskTemplateFromReader(dr);
                        output.Add(tasktemplate);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTaskTemplatesByAuditTemplateIdAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            //TODO add more includes?
            if (output.Count > 0)
            {
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Tags.ToString().ToLower())) output = await AppendTagsToTaskTemplatesAsync(taskTemplates: output, companyId: companyId);
            }

            return output;
        }

        /// <summary>
        /// GetTasksByChecklistIdAsync; Get a list of tasks based on the ChecklistId; Can be used for getting the tasks that are displayed with a checklist.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="checklistId">AuditTemplateId (DB: checklists_checklist.id)</param>
        /// <returns>List of task objects.</returns>
        public async Task<List<TasksTask>> GetTasksByChecklistIdAsync(int companyId, int checklistId, int? checklistTemplateId = null, string include = null, ConnectionKind connectionKind = ConnectionKind.Reader)
        {
            var output = new List<TasksTask>();
            NpgsqlDataReader dr = null;
            string language = Culture;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));
                parameters.Add(new NpgsqlParameter("@_checklistid", checklistId));

                using (dr = await _manager.GetDataReader("get_tasks_by_checklist", commandType: CommandType.StoredProcedure, parameters: parameters, connectionKind: connectionKind))
                {
                    while (await dr.ReadAsync())
                    {
                        var task = CreateOrFillTaskFromReader(dr);
                        output.Add(task);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTasksByChecklistIdAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }
            //TODO add more includes?
            if (output.Count > 0)
            {
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Steps.ToString().ToLower())) output = await AppendStepsTaskAsync(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.AreaPaths.ToString().ToLower())) output = await AppendAreaPathsToTasksAsync(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertyUserValues.ToString().ToLower()))) output = await AppendPropertyUserValuesToTasks(tasks: output, companyId: companyId, include: include, connectionKind: connectionKind);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertyValues.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.Properties.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.PropertyDetails.ToString().ToLower()))) output = await AppendTemplatePropertiesToTasks(tasks: output, companyId: companyId, include: include, connectionKind: connectionKind);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.InstructionRelations.ToString().ToLower()))) output = await AppendWorkInstructionRelations(tasks: output, checklistTemplateId: checklistTemplateId, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.PictureProof.ToString().ToLower())) output = await AppendPictureProof(tasks: output, companyId: companyId, connectionKind: connectionKind);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Tags.ToString().ToLower())) output = await AppendTagsToTasksAsync(tasks: output, companyId: companyId, fromTemplates: true);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.UserInformation.ToString().ToLower()))) output = await AppendUserInformationToTasksAsync(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertiesGen4.ToString().ToLower()))) output = await ReplacePropertiesWithPropertiesGen4(output, companyId);
            }

            return output;
        }

        /// <summary>
        /// GetTaskAsync; Get specific task with includes.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="taskId">TaskId (DB: tasks_task.id)</param>
        /// <param name="include">Include items, following are available: Steps, Actions</param>
        /// <returns>List of tasks</returns>
        public async Task<TasksTask> GetTaskAsync(int companyId, int taskId, string include = null)
        {
            var task = new TasksTask();
            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));
                parameters.Add(new NpgsqlParameter("@_id", taskId));

                using (dr = await _manager.GetDataReader("get_task", commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        CreateOrFillTaskFromReader(dr, task: task);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTaskAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            

            //TODO Add properties include?
            if (task.Id > 0)
            {
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Steps.ToString().ToLower())) task.Steps = await GetTaskTemplateStepsByTaskTemplateIdAsync(companyId: companyId, taskTemplateId: task.TemplateId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Actions.ToString().ToLower())) task.Actions = await _actionManager.GetActionsByTaskIdAsync(companyId: companyId, taskId: task.Id);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Properties.ToString().ToLower())) task = await AppendPropertiesToTask(task: task, companyId: companyId, include: include);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.PropertyUserValues.ToString().ToLower())) task = await AppendPropertyUserValuesToTask(task: task, companyId: companyId, include: include);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.InstructionRelations.ToString().ToLower())) task.WorkInstructionRelations = await GetWorkInstructionRelationsAsync(companyId: companyId, taskTemplateId: task.TemplateId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Instructions.ToString().ToLower())) task.WorkInstructions = await GetWorkInstructionsByTaskTemplateIdAsync(companyId: companyId, taskTemplateId: task.TemplateId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.PictureProof.ToString().ToLower())) task = await AppendPictureProof(task: task, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Tags.ToString().ToLower())) task.Tags = await _tagManager.GetTagsWithObjectAsync(companyId: companyId, objectType: ObjectTypeEnum.TaskTemplate, id: task.TemplateId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.UserInformation.ToString().ToLower())) task = await AppendUserInformationToTaskAsync(task: task, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertiesGen4.ToString().ToLower()))) task = (await ReplacePropertiesWithPropertiesGen4(new List<TasksTask>{task}, companyId)).First();


                if (!string.IsNullOrEmpty(task.Version) && task.Version != await _flattenTaskManager.RetrieveLatestAvailableVersion(task.TemplateId, companyId) && await _generalManager.GetHasAccessToFeatureByCompany(companyId: companyId, featurekey: "TECH_FLATTEN_DATA"))
                {
                    task = await ApplyTemplateVersionToTask(task, companyId, include);
                }

                return task;
            }
            return null;
        }

        private async Task<TasksTask> ApplyTemplateVersionToTask(TasksTask task, int companyId, string include = null)
        {
            //fill all template related data from the retrieved versioned template
            TaskTemplate versionedTemplate = await _flattenTaskManager.RetrieveFlattenData(templateId: task.TemplateId, companyId: companyId, version: task.Version);
            if (versionedTemplate != null)
                task.ApplyTemplateVersion(versionedTemplate, include);
            else
                _logger.LogWarning($"ApplyTemplateVersionToTask; Template version not applied because requested version wasn't found. TaskTemplateId: {task.TemplateId}, version: {task.Version}");
            return task;
        }

        public async Task<bool> SetTaskVersionAsync(int companyId, int userId, int taskId, string version)
        {
            var original = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.tasks_task.ToString(), taskId);

            List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
            parameters.Add(new NpgsqlParameter("@_id", taskId));
            parameters.Add(new NpgsqlParameter("@_companyid", companyId));
            parameters.Add(new NpgsqlParameter("@_version", version));
            var rowsaffected = Convert.ToInt32(await _manager.ExecuteScalarAsync("change_task_version", parameters: parameters, commandType: CommandType.StoredProcedure));

            if (rowsaffected > 0)
            {
                var mutated = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.tasks_task.ToString(), taskId);
                await _dataAuditing.WriteDataAudit(original: original, mutated: mutated, Models.Enumerations.TableNames.tasks_task.ToString(), objectId: taskId, userId: userId, companyId: companyId, description: "Changed task version.");

            }

            return (rowsaffected > 0);
        }

        /// <summary>
        /// GetAvailableTaskTemplateVersionsForTaskAsync; Retrieve all available versions connected to the template of a given task
        /// </summary>
        /// <param name="companyId">The companyid of the task and task template</param>
        /// <param name="taskId">The id of the task (NOTE: THIS IS NOT THE TEMPLATE ID)</param>
        /// <returns></returns>
        public async Task<List<string>> GetAvailableTaskTemplateVersionsForTaskAsync(int companyId, int taskId)
        {
            var output = new List<string>();
            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));
                parameters.Add(new NpgsqlParameter("@_taskid", taskId));

                using (dr = await _manager.GetDataReader("get_all_tasktemplate_versions_for_task", commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        if (dr.HasColumn("version"))
                        {
                            var version = Convert.ToString(dr["version"]);
                            output.Add(version);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetAvailableTaskTemplateVersionsForTaskAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(Settings.ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            return output;
        }

        /// <summary>
        /// GetTasksStatusAsync; Get a list of status items for a task.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="timestamp">TimeStamp, for getting all tasks where the timestamp is between start date and end date of a task.</param>
        /// <returns>Return a list of task status items.</returns>
        public async Task<List<TaskStatusBasic>> GetTasksStatusAsync(int companyId, DateTime timestamp, TaskFilters? filters = null)
        {
            var output = new List<TaskStatusBasic>();
            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));
                parameters.Add(new NpgsqlParameter("@_timestamp", timestamp));
                if (filters.HasValue && filters.Value.AreaId.HasValue && filters.Value.AreaId.Value > 0)
                {
                    parameters.Add(new NpgsqlParameter("@_areaid", filters.Value.AreaId.Value));
                }

                if (filters.Value.TagIds != null && filters.Value.TagIds.Length > 0)
                {
                    parameters.Add(new NpgsqlParameter("@_tagids", filters.Value.TagIds));
                }

                using (dr = await _manager.GetDataReader("get_tasks_statusses", commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        var task = CreateOrFillTaskBasicFromReader(dr);
                        output.Add(task);
                    }
                }
                foreach (var task in output)
                {
                    if (task.HasPictureProof)
                    {
                        await AppendPictureProof(companyId, task);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTasksStatusAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);


            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            return output;
        }

        /// <summary>
        /// GetTasksStatisticsRelatedToPeriodAsync; Get tasks statistics between the from and to, this will return all tasks statistics for a specific period.
        /// All other filters will be implemented as is (same as tasks calls);
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="userId">UserId (DB: profile_user.id)</param>
        /// <param name="timestamp">TimeStamp, for getting all tasks where the timestamp is between start date and end date of a task.</param>
        /// <param name="filters">Filters that can be used for filtering the data. Depending on implementation, filters can be done within the stored procedures or afterwards.</param>
        /// <param name="include">Include items, currently Steps and AreaPaths area available.</param>
        /// <returns></returns>
        public async Task<List<TaskStatistics>> GetTasksStatisticsRelatedToPeriodAsync(int companyId, int? userId = null, DateTime? from = null, DateTime? to = null, TaskFilters? filters = null, string include = null)
        {
            var output = new List<TaskStatistics>();

            List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();

            NpgsqlDataReader dr = null;

            parameters.Add(new NpgsqlParameter("@_companyid", companyId));
            parameters.Add(new NpgsqlParameter("@_from", from));
            parameters.Add(new NpgsqlParameter("@_to", to));

            if (filters != null)
            {
                if (filters.Value.AreaId.HasValue)
                {
                    parameters.Add(new NpgsqlParameter("@_areaid", filters.Value.AreaId.Value));
                }

                if (filters.Value.TagIds != null && filters.Value.TagIds.Length > 0)
                {
                    parameters.Add(new NpgsqlParameter("@_tagids", filters.Value.TagIds));
                }

                if (filters.Value.TemplateId.HasValue)
                {
                    parameters.Add(new NpgsqlParameter("@_templateid", filters.Value.TemplateId));
                }
            }
            using (dr = await _manager.GetDataReader("get_task_statistics_from_to", commandType: CommandType.StoredProcedure, parameters: parameters))
            {
                while (await dr.ReadAsync())
                {
                    var status = new TaskStatistics();

                    status.Status = dr["status"].ToString();
                    status.Count = Convert.ToInt32(dr["count"]);
                    output.Add(status);
                }
            }

            return output;
        }

        /// <summary>
        /// GetTasksExendedDataAsync; Get tasks with extended data. 
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="timestamp">TimeStamp, for getting all tasks where the TimesTamp is between start date and end date of a task.</param>
        /// <param name="filters">Filters used to filter out a specific set of tasks</param>
        /// <returns>A list of TaskExtendedData basic items.</returns>
        public async Task<List<TaskExtendedDataBasic>> GetTasksExendedDataAsync(int companyId, DateTime timestamp, TaskFilters? filters = null)
        {
            var output = new List<TaskExtendedDataBasic>();

            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));
                parameters.Add(new NpgsqlParameter("@_timestamp", timestamp));
                if (filters.HasValue && filters.Value.AreaId.HasValue && filters.Value.AreaId.Value > 0)
                {
                    parameters.Add(new NpgsqlParameter("@_areaid", filters.Value.AreaId.Value));
                }

                if (filters.Value.TagIds != null && filters.Value.TagIds.Length > 0)
                {
                    parameters.Add(new NpgsqlParameter("@_tagids", filters.Value.TagIds));
                }

                using (dr = await _manager.GetDataReader("get_tasks_extended_data", commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        var taskExtendedData = CreateOrFillTaskExtendedDataBasicFromReader(dr);
                        output.Add(taskExtendedData);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTasksExendedDataAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            //TODO refactor
            if (output.Count > 0)
            {
                var props = await GetTasksPropertyUserValuesAsync(companyId, timestamp, filters);
                if (props != null && props.Count > 0)
                {
                    foreach (var item in output)
                    {
                        var uservalues = props.Where(x => x.TaskId == item.TaskId);
                        if (uservalues != null && uservalues.Any())
                        {
                            item.PropertyUserValues = uservalues.ToList();
                        }
                    }
                }

                output.RemoveAll(x => x.PropertyUserValues == null && !x.TimeRealizedById.HasValue && !x.TimeTaken.HasValue && x.CompletedDeeplinkId == null);
            }

            return output;
        }

        /// <summary>
        /// GetTasksPropertyUserValuesAsync; Get property user values of tasks
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="timestamp">TimeStamp to be used for retrieving the items.</param>
        /// <param name="filters">Possible filters to be used while retrieving the data.</param>
        /// <returns>A list of TaskPropertyUserValueBasic items.</returns>
        public async Task<List<TaskPropertyUserValueBasic>> GetTasksPropertyUserValuesAsync(int companyId, DateTime timestamp, TaskFilters? filters = null)
        {
            var output = new List<TaskPropertyUserValueBasic>();

            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));
                parameters.Add(new NpgsqlParameter("@_timestamp", timestamp));
                if (filters.HasValue && filters.Value.AreaId.HasValue && filters.Value.AreaId.Value > 0)
                {
                    parameters.Add(new NpgsqlParameter("@_areaid", filters.Value.AreaId.Value));
                }

                using (dr = await _manager.GetDataReader("get_tasks_properties_user_data", commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        var taskProperties = CreateOrFillTaskPropertyUserValueBasicFromReader(dr);
                        output.Add(taskProperties);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTasksPropertyUserValuesAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            return output;
        }

        /// <summary>
        /// GetTasksHistoryAsync; Get history of task updates related to status.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="timestamp">TimeStamp, for getting all tasks where the timestamp is between start date and end date of a task.</param>
        /// <returns>Return a list of task status items.</returns>
        public async Task<List<TaskStatusBasic>> GetTasksHistoryAsync(int companyId, DateTime timestamp, TaskFilters? filters = null)
        {
            var output = new List<TaskStatusBasic>();

            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));
                parameters.Add(new NpgsqlParameter("@_timestamp", timestamp));
                if (filters.HasValue && filters.Value.AreaId.HasValue && filters.Value.AreaId.Value > 0)
                {
                    parameters.Add(new NpgsqlParameter("@_areaid", filters.Value.AreaId.Value));
                }

                if (filters.Value.TagIds != null && filters.Value.TagIds.Length > 0)
                {
                    parameters.Add(new NpgsqlParameter("@_tagids", filters.Value.TagIds));
                }

                using (dr = await _manager.GetDataReader("get_tasks_history", commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        var task = CreateOrFillTaskBasicFromReader(dr);
                        output.Add(task);
                    }
                }


            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTasksHistoryAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);

            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            return output;
        }

        /// <summary>
        /// GetTasksHistoryAsync; Get history of task updates related to status but only return the first history item of each task.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="timestamp">TimeStamp, for getting all tasks where the timestamp is between start date and end date of a task.</param>
        /// <returns>Return a list of task status items.</returns>
        public async Task<List<TaskStatusBasic>> GetTasksHistoryFirstsAsync(int companyId, DateTime timestamp, TaskFilters? filters = null)
        {
            var output = new List<TaskStatusBasic>();
            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));
                parameters.Add(new NpgsqlParameter("@_timestamp", timestamp));
                if (filters.HasValue && filters.Value.AreaId.HasValue && filters.Value.AreaId.Value > 0)
                {
                    parameters.Add(new NpgsqlParameter("@_areaid", filters.Value.AreaId.Value));
                }

                if (filters.Value.TagIds != null && filters.Value.TagIds.Length > 0)
                {
                    parameters.Add(new NpgsqlParameter("@_tagids", filters.Value.TagIds));
                }

                using (dr = await _manager.GetDataReader("get_tasks_history_firsts", commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        var task = CreateOrFillTaskBasicFromReader(dr);
                        output.Add(task);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTasksHistoryFirstsAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);

            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            return output;
        }

        /// <summary>
        /// Retrieves task statistics for a specific company, user, and area, including counts for various time periods
        /// such as the current shift, day, week, and overdue tasks.
        /// </summary>
        /// <remarks>This method calculates task statistics based on the current date and time, using
        /// predefined time spans such as shifts, days, and weeks. It also includes overdue task counts.</remarks>
        /// <param name="companyId">The unique identifier of the company for which the task statistics are retrieved.</param>
        /// <param name="userId">The unique identifier of the user requesting the task statistics.</param>
        /// <param name="areaid">The unique identifier of the area for which the task statistics are retrieved.</param>
        /// <returns>A <see cref="Task{TaskStatisticsOverview}"/> representing the asynchronous operation. The result contains an
        /// overview of task statistics, including counts for the current and previous shifts, today, yesterday, this
        /// week, the previous week, and overdue tasks.</returns>
        public async Task<TaskStatisticsOverview> GetTaskLandingPageStats(int companyId, int userId, int areaid)
        {
            TaskStatisticsOverview result = new TaskStatisticsOverview();

            ShiftDayWeekTimestamps times = await _shiftManager.GetShiftDayWeekTimesByTimestamp(companyId: companyId, await _companyManager.GetCompanyLocalTime(companyId: companyId));
            Gen4TaskFilters filter;

            if (times.ShiftStart != null)
            {
                //get counts for this shift
                filter = new Gen4TaskFilters()
                {
                    AreaId = areaid,
                    Timespan = TaskTimeSpanEnum.Shift
                };
                result.ThisShift = await GetFilteredTaskCount(companyId: companyId, filters: filter);

                //get counts for previous shift
                filter = new Gen4TaskFilters()
                {
                    AreaId = areaid,
                    Timespan = TaskTimeSpanEnum.Shift,
                    Offset = -1
                };
                result.PreviousShift = await GetFilteredTaskCount(companyId: companyId, filters: filter);
            }

            //get count for today
            filter = new Gen4TaskFilters()
            {
                AreaId = areaid,
                Timespan = TaskTimeSpanEnum.Day,
                ShiftDayWeekTimestamps = times
            };
            result.Today = await GetFilteredTaskCount(companyId: companyId, filters: filter);
            //get count for yesterday
            filter = new Gen4TaskFilters()

            {
                AreaId = areaid,
                Timespan = TaskTimeSpanEnum.Day,
                Offset = -1
            };
            result.Yesterday = await GetFilteredTaskCount(companyId: companyId, filters: filter);

            //get count for this week
            filter = new Gen4TaskFilters()
            {
                AreaId = areaid,
                Timespan = TaskTimeSpanEnum.Week,
                ShiftDayWeekTimestamps = times
            };
            result.ThisWeek = await GetFilteredTaskCount(companyId: companyId, filters: filter);
            //get count for previous week
            filter = new Gen4TaskFilters()
            {
                AreaId = areaid,
                Timespan = TaskTimeSpanEnum.Week,
                Offset = -1
            };
            result.PreviousWeek = await GetFilteredTaskCount(companyId: companyId, filters: filter);

            //get count for overdue
            filter = new Gen4TaskFilters()
            {
                AreaId = areaid,
                Timespan = TaskTimeSpanEnum.Overdue,
                ShiftDayWeekTimestamps = times
            };
            result.Overdue = await GetFilteredTaskCount(companyId: companyId, filters: filter);

            return result;
        }

        public async Task<TaskCountStatsCompletion> GetFilteredTaskCount(int companyId, Gen4TaskFilters filters)
        {
            TaskCountStatsCompletion result = new TaskCountStatsCompletion();
            NpgsqlDataReader dr = null;

            var sp = "get_tasks_counts_g4_v3";
            if (filters.Timespan == TaskTimeSpanEnum.Overdue)
            {
                sp = "get_tasks_overdue_count_g4";
            }

            filters = await EnrichGen4TaskFilter(companyId: companyId, filters: filters);
            filters.Limit = null;
            filters.Offset = null;
            List<NpgsqlParameter> parameters = GetNpgsqlParametersFromGen4TaskFilter(companyId: companyId, filters: filters, timestamp: await _companyManager.GetCompanyLocalTime(companyId));

            try
            {

                using (dr = await _manager.GetDataReader(sp, commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        result = CreateOrFillTaskCountFromReader(dr, result);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetFilteredTaskCount(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);

            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            return result;
        }

        private TaskCountStatsCompletion CreateOrFillTaskCountFromReader(NpgsqlDataReader dr, TaskCountStatsCompletion stats = null)
        {
            stats ??= new TaskCountStatsCompletion();

            stats.TodoCount = Convert.ToInt32(dr["todo_count"]);
            stats.OkCount = Convert.ToInt32(dr["ok_count"]);
            stats.NotOkCount = Convert.ToInt32(dr["notok_count"]);
            stats.SkippedCount = Convert.ToInt32(dr["skipped_count"]);
            stats.TotalCount = Convert.ToInt32(dr["total_count"]);

            return stats;
        }



        /// <summary>
        /// AddTaskAsync; Add tasks to database.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="task">Task object containing all data of adding a task.</param>
        /// <returns>Id of newly generated task.</returns>
        public async Task<int> AddTaskAsync(int companyId, TasksTask task, int userId, int possibleOwnerId)
        {
            List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();

            parameters.AddRange(GetNpgsqlParametersFromTask(task: task, companyId: task.CompanyId));

            var possibleId = Convert.ToInt32(await _manager.ExecuteScalarAsync("add_task", parameters: parameters, commandType: CommandType.StoredProcedure));

            if (possibleId > 0)
            {
                task.Tags = await _tagManager.GetTagsWithObjectAsync(companyId: companyId, ObjectTypeEnum.TaskTemplate, id: task.TemplateId);
                await _tagManager.UpdateTagsOnObjectAsync(objectType: ObjectTypeEnum.Task, id: possibleId, tags: task.Tags, companyId: companyId, userId: userId);
            }

            if (task.PropertyUserValues != null && possibleId > 0)
            {
                var result = await AddChangeTaskPropertyUserValue(companyId: companyId, taskId: possibleId, userId: userId, task.PropertyUserValues);
            }

            if (task.PropertiesGen4 != null && possibleId > 0)
            {
                foreach (PropertyDTO property in task.PropertiesGen4)
                {
                    if (property?.UserValue != null)
                    {
                        property.UserValue.TaskId = possibleId;
                        var result = await _propertyValueManager.AddPropertyUserValueAsync(companyId: companyId, property: property, userId: userId);
                    }

                }
            }

            if (task.PictureProof != null && task.PictureProof.Media != null && task.PictureProof.Media.Count > 0 && possibleId > 0)
            {
                var possibleSignedByIdOfTask = (task.Signature != null && task.Signature.SignedById.HasValue && task.Signature.SignedById > 0 ? task.Signature.SignedById.Value : possibleOwnerId); //check if task is signed specifically, then use signed by task user.
                var result = await AddChangeTaskPictureProof(companyId: companyId, taskId: possibleId, userId: userId, possibleOwnerId: possibleSignedByIdOfTask, task.PictureProof);
            }

            if (possibleId > 0)
            {
                var mutated = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.tasks_task.ToString(), possibleId);
                await _dataAuditing.WriteDataAudit(original: string.Empty, mutated: mutated, Models.Enumerations.TableNames.tasks_task.ToString(), objectId: possibleId, userId: userId, companyId: companyId, description: "Added task.");
            }

            return possibleId;
        }

        /// <summary>
        /// ChangeTaskAsync; Change task
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="taskId">TaskId of task to be changed (DB: tasks_task.id)</param>
        /// <param name="task">Task object containing all data the task that needs to be changed.</param>
        /// <returns>true/false depending on update outcome.</returns>
        public async Task<bool> ChangeTaskAsync(int companyId, int taskId, TasksTask task, int userId, int possibleOwnerId)
        {
            var original = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.tasks_task.ToString(), taskId);

            List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();

            parameters.AddRange(GetNpgsqlParametersFromTask(task: task, companyId: companyId, taskId: taskId));

            var rowseffected = Convert.ToInt32(await _manager.ExecuteScalarAsync("change_task", parameters: parameters, commandType: CommandType.StoredProcedure));

            if (task.PropertyUserValues != null)
            {
                var result = await AddChangeTaskPropertyUserValue(companyId: companyId, taskId: taskId, userId: userId, task.PropertyUserValues);
            }

            if (task.PropertiesGen4 != null)
            {
                var result = await AddChangeTaskPropertyUserValue(companyId: companyId, taskId: taskId, userId: userId, task.PropertiesGen4);
            }

            if (task.PictureProof != null && task.PictureProof.Media != null && task.PictureProof.Media.Count > 0)
            {
                var possibleSignedByIdOfTask = (task.Signature != null && task.Signature.SignedById.HasValue && task.Signature.SignedById > 0 ? task.Signature.SignedById.Value : possibleOwnerId); //check if task is signed specifically, then use signed by task user.
                var result = await AddChangeTaskPictureProof(companyId: companyId, taskId: taskId, userId: userId, possibleOwnerId: possibleSignedByIdOfTask, task.PictureProof);
            }

            if (rowseffected > 0)
            {
                var mutated = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.tasks_task.ToString(), taskId);
                await _dataAuditing.WriteDataAudit(original: original, mutated: mutated, Models.Enumerations.TableNames.tasks_task.ToString(), objectId: taskId, userId: userId, companyId: companyId, description: "Changed task.");
            }

            return (rowseffected > 0);
        }

        /// <summary>
        /// ChangeTaskStatusAsync; Change task
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="taskId">TaskId of task to be changed (DB: tasks_task.id)</param>
        /// <param name="task">Task object containing all data the task that needs to be changed.</param>
        /// <returns>true/false depending on update outcome.</returns>
        public async Task<bool> ChangeTaskStatusAsync(int companyId, int taskId, TasksTask task, int userId)
        {
            var original = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.tasks_task.ToString(), taskId);

            //todo refactor
            if (task.Signature == null)
            {
                var forcedSignature = new Signature() { SignedAt = DateTime.Now, SignedById = userId };
                task.Signature = forcedSignature;
            }

            List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();

            parameters.AddRange(GetNpgsqlParametersFromTaskStatus(task: task, companyId: companyId, taskId: taskId));

            var rowseffected = Convert.ToInt32(await _manager.ExecuteScalarAsync("change_task_status", parameters: parameters, commandType: CommandType.StoredProcedure));

            if (task.PropertyUserValues != null)
            {
                var result = await AddChangeTaskPropertyUserValue(companyId: companyId, taskId: taskId, userId: userId, task.PropertyUserValues);
            }

            if (task.PictureProof != null && task.PictureProof.Media != null && task.PictureProof.Media.Count > 0)
            {
                var result = await AddChangeTaskPictureProof(companyId: companyId, taskId: taskId, userId: userId, possibleOwnerId: (task.Signature != null && task.Signature.SignedById.HasValue ? task.Signature.SignedById.Value : 0), task.PictureProof);
            }

            if (rowseffected > 0)
            {
                var mutated = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.tasks_task.ToString(), taskId);
                await _dataAuditing.WriteDataAudit(original: original, mutated: mutated, Models.Enumerations.TableNames.tasks_task.ToString(), objectId: taskId, userId: userId, companyId: companyId, description: "Changed task.");
            }

            return (rowseffected > 0);
        }

        /// <summary>
        /// ChangeTaskPictureProofAsync; Change task picture proof
        /// </summary>
        /// <param name="companyId">The Id of the company</param>
        /// <param name="taskId">TaskId of task picture proof to be changed</param>
        /// <param name="pictureProof">Task picture proof to be changed</param>
        /// <param name="userId">The id of the user</param>
        /// <returns></returns>
        public async Task<bool> ChangeTaskPictureProofAsync(int companyId, int taskId, PictureProof pictureProof, int userId, int possibleOwnerId)
        {
            return await AddChangeTaskPictureProof(companyId: companyId, taskId: taskId, userId: userId, possibleOwnerId: possibleOwnerId, pictureProof: pictureProof);
        }

        /// <summary>
        /// ChangeTaskPropertyUserValuesAsync; Change task
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="taskId">TaskId of task to be changed (DB: tasks_task.id)</param>
        /// <param name="task">Task object containing all data the task that needs to be changed.</param>
        /// <returns>true/false depending on update outcome.</returns>
        public async Task<bool> ChangeTaskPropertyUserValuesAsync(int companyId, int taskId, List<PropertyUserValue> propertyUserValues, int userId)
        {
            var result = await AddChangeTaskPropertyUserValue(companyId: companyId, taskId: taskId, userId: userId, propertyUserValues);
            if (result)
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));
                parameters.Add(new NpgsqlParameter("@_id", taskId));
                var rowseffected = Convert.ToInt32(await _manager.ExecuteScalarAsync("set_task_modified", parameters: parameters, commandType: CommandType.StoredProcedure));
            }

            return result;
        }

        /// <summary>
        /// SetTaskActiveAsync; Set Task active/inactive based on TaskId.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="taskId">taskId (DB: tasks_task.id)</param>
        /// <param name="isActive">true / false -> default true is selected, for setting a Task to inactive, set parameter to false.</param>
        /// <returns>true / false depending on outcome. If more then 1 row is updated, true is returned in all other cases false.</returns>
        public async Task<bool> SetTaskActiveAsync(int companyId, int userId, int taskId, bool isActive = true)
        {
            var original = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.tasks_task.ToString(), taskId);

            List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
            parameters.Add(new NpgsqlParameter("@_companyid", companyId));
            parameters.Add(new NpgsqlParameter("@_id", taskId));
            parameters.Add(new NpgsqlParameter("@_active", isActive));
            var rowseffected = Convert.ToInt32(await _manager.ExecuteScalarAsync("set_task_active", parameters: parameters, commandType: CommandType.StoredProcedure));

            if (rowseffected > 0)
            {
                var mutated = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.tasks_task.ToString(), taskId);
                await _dataAuditing.WriteDataAudit(original: original, mutated: mutated, Models.Enumerations.TableNames.tasks_task.ToString(), objectId: taskId, userId: userId, companyId: companyId, description: "Changed task activity status.");

            }

            return (rowseffected > 0);
        }

        /// <summary>
        /// SetTaskStatusAsync; Update the Task status based on a status, signed by and the TaskId.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="taskId">taskId (DB: tasks_task.id)</param>
        /// <param name="signBasic"></param>
        /// <returns>true / false depending on outcome. If more then 1 row is updated, true is returned in all other cases false.</returns>
        public async Task<bool> SetTaskStatusSignAsync(int companyId, int taskId, int userId, SignBasic signBasic)
        {
            //TODO refactore, picture proof related items needs own methods and be called from this one. This exact part is the same within multuple methods. 
            //TODO methods must handle 1 thing, not multiple 
            var original = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.tasks_task.ToString(), taskId);

            var spName = "set_task_status";

            List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
            parameters.Add(new NpgsqlParameter("@_companyid", companyId));
            parameters.Add(new NpgsqlParameter("@_id", taskId));
            parameters.Add(new NpgsqlParameter("@_status", signBasic.Status.ToDatabaseString()));
            parameters.Add(new NpgsqlParameter("@_signedatutc", (signBasic.SignedAtUtc != DateTime.MinValue ? new DateTime(signBasic.SignedAtUtc.Ticks) : new DateTime(DateTime.Now.ToUniversalTime().Ticks))));
            parameters.Add(new NpgsqlParameter("@_userid", (signBasic.SignedById > 0 ? signBasic.SignedById : userId)));

            if (!string.IsNullOrEmpty(signBasic.Version) && await _generalManager.GetHasAccessToFeatureByCompany(companyId: companyId, featurekey: "TECH_FLATTEN_DATA"))
            {
                parameters.Add(new NpgsqlParameter("@_version", signBasic.Version.ToString()));
                spName = "set_task_status_and_version";
            }

            var rowseffected = Convert.ToInt32(await _manager.ExecuteScalarAsync(spName, parameters: parameters, commandType: CommandType.StoredProcedure));

            if (rowseffected > 0)
            {
                var mutated = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.tasks_task.ToString(), taskId);
                await _dataAuditing.WriteDataAudit(original: original, mutated: mutated, Models.Enumerations.TableNames.tasks_task.ToString(), objectId: taskId, userId: userId, companyId: companyId, description: "Sign task.");

            }

            await _taskGenerationManager.GenerateSpecificTemplateBasedOnTask(companyId: companyId, taskId: taskId); //check if generation needs to be done based on template type

            //TODO move to own method see also SetTaskStatusAsync
            if (signBasic.Status == TaskStatusEnum.Skipped || signBasic.Status == TaskStatusEnum.Todo)
            {
                //get task picture proof
                //if it exists, set picture proof inactive
                PictureProof pp = null;
                //get picture proof
                List<NpgsqlParameter> getPPParameters = new List<NpgsqlParameter>();
                getPPParameters.Add(new NpgsqlParameter("@_companyid", companyId));
                getPPParameters.Add(new NpgsqlParameter("@_taskid", taskId));
                using (var dr = await _manager.GetDataReader("get_picture_proof", commandType: CommandType.StoredProcedure, parameters: getPPParameters))
                {
                    while (await dr.ReadAsync())
                    {
                        pp = await CreateOrFillPictureProofFromReader(dr);
                    }
                }

                if (pp != null)
                {
                    var originalPictureProof = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.picture_proof.ToString(), pp.Id);

                    List<NpgsqlParameter> setPPActiveParameters = new List<NpgsqlParameter>();
                    setPPActiveParameters.Add(new NpgsqlParameter("@_id", pp.Id));
                    setPPActiveParameters.Add(new NpgsqlParameter("@_companyid", companyId));
                    setPPActiveParameters.Add(new NpgsqlParameter("@_active", false));
                    var rowsaffected = await _manager.ExecuteScalarAsync("set_picture_proof_active", parameters: setPPActiveParameters, commandType: CommandType.StoredProcedure);

                    if (rowsaffected != null)
                    {
                        var mutatedPictureProof = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.picture_proof.ToString(), pp.Id);
                        await _dataAuditing.WriteDataAudit(original: originalPictureProof, mutated: mutatedPictureProof, Models.Enumerations.TableNames.picture_proof.ToString(), objectId: pp.Id, userId: userId, companyId: companyId, description: "Changed task picture proof active state.");
                    }
                }
            }
            return (rowseffected > 0);
        }

        /// <summary>
        /// SetTaskStatusAsync; Set task status async.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="taskId">taskId (DB: tasks_task.id)</param>
        /// <param name="userId">UserId of the user that is initiating the update. (DB: userprofile.id)</param>
        /// <param name="status">Status enum used for update. If empy, TODO will be used.</param>
        /// <returns>true / false depending on outcome. If more then 1 row is updated, true is returned in all other cases false.</returns>
        public async Task<bool> SetTaskStatusAsync(int companyId, int taskId, int userId, TaskStatusEnum status = TaskStatusEnum.Todo)
        {
            try
            {
                var original = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.tasks_task.ToString(), taskId);

                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));
                parameters.Add(new NpgsqlParameter("@_id", taskId));
                parameters.Add(new NpgsqlParameter("@_userid", userId));
                parameters.Add(new NpgsqlParameter("@_status", status.ToDatabaseString()));
                var rowseffected = await _manager.ExecuteScalarAsync("set_task_status", parameters: parameters, commandType: CommandType.StoredProcedure);

                if (Convert.ToInt32(rowseffected) > 0)
                {
                    var mutated = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.tasks_task.ToString(), taskId);
                    await _dataAuditing.WriteDataAudit(original: original, mutated: mutated, Models.Enumerations.TableNames.tasks_task.ToString(), objectId: taskId, userId: userId, companyId: companyId, description: "Changed task status.");
                }

                await _taskGenerationManager.GenerateSpecificTemplateBasedOnTask(companyId: companyId, taskId: taskId);//check if generation needs to be done based on template type

                //TODO move to own method!! 
                if (status == TaskStatusEnum.Skipped || status == TaskStatusEnum.Todo)
                {
                    //get task picture proof
                    //if it exists, set picture proof inactive
                    PictureProof pp = null;
                    //get picture proof
                    List<NpgsqlParameter> getPPParameters = new List<NpgsqlParameter>();
                    getPPParameters.Add(new NpgsqlParameter("@_companyid", companyId));
                    getPPParameters.Add(new NpgsqlParameter("@_taskid", taskId));
                    using (var dr = await _manager.GetDataReader("get_picture_proof", commandType: CommandType.StoredProcedure, parameters: getPPParameters))
                    {
                        while (await dr.ReadAsync())
                        {
                            pp = await CreateOrFillPictureProofFromReader(dr);
                        }
                    }

                    if (pp != null)
                    {
                        var originalPictureProof = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.picture_proof.ToString(), pp.Id);

                        List<NpgsqlParameter> setPPActiveParameters = new List<NpgsqlParameter>();
                        setPPActiveParameters.Add(new NpgsqlParameter("@_id", pp.Id));
                        setPPActiveParameters.Add(new NpgsqlParameter("@_companyid", companyId));
                        setPPActiveParameters.Add(new NpgsqlParameter("@_active", false));
                        var rowsaffected = await _manager.ExecuteScalarAsync("set_picture_proof_active", parameters: setPPActiveParameters, commandType: CommandType.StoredProcedure);

                        if (rowsaffected != null)
                        {
                            var mutatedPictureProof = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.picture_proof.ToString(), pp.Id);
                            await _dataAuditing.WriteDataAudit(original: originalPictureProof, mutated: mutatedPictureProof, Models.Enumerations.TableNames.picture_proof.ToString(), objectId: pp.Id, userId: userId, companyId: companyId, description: "Changed task picture proof active state.");
                        }
                    }
                }

                return (Convert.ToInt32(rowseffected) > 0);
            } catch(Exception ex) {                 
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.SetTaskStatusAsync(): ", ex.Message));
                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
            }

            return false;
        }

        /// <summary>
        /// setTaskCompletedFromChecklistIfAllowed; set task status done if no picture proof is needed and all required properties have been set
        /// </summary>
        /// <param name="companyId"></param>
        /// <param name="userId"></param>
        /// <param name="taskId"></param>
        /// <returns></returns>
        public async Task<bool> setTaskCompletedFromChecklistIfAllowed(int companyId, int userId, int taskId)
        {
            TasksTask original = await GetTaskAsync(companyId: companyId, taskId: taskId, include: "items,steps,properties,propertydetails,propertyuservalues,propertyvalues");

            if(original != null)
            {
                //Check if picture proof is needed
                TaskTemplate taskTemplate = await GetTaskTemplateAsync(companyId, original.TemplateId);
                if (taskTemplate != null) {
                    if (taskTemplate.HasPictureProof)
                    {
                        //Task won't be completed automatically because it requires photoproof
                        return false;
                    }

                    //check if all required properties have been set
                    List<PropertyTaskTemplate> properties = await _propertyValueManager.GetPropertiesTaskTemplateAsync(companyId, taskTemplate.Id);

                    //Loop through all required properties
                    foreach (PropertyTaskTemplate property in properties.FindAll(p => (bool)p.IsRequired))
                    {
                        //Find properties that have no corresponding value set
                        if (original.PropertyUserValues.Count(v => v.PropertyId == property.PropertyId) == 0)
                        {
                            //Task won't be completed automatically because there's required properties without values
                            return false;
                        }
                    }
                }

                return await SetTaskStatusAsync(companyId: companyId, userId: userId, taskId: taskId, status: TaskStatusEnum.Ok);
            } else
            {
                return false; //Task not found, return false
            }
            
        }


        /// <summary>
        /// SetTaskStatusWithReasonAsync; Set task status with reason async.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="taskId">taskId (DB: tasks_task.id)</param>
        /// <param name="userId">UserId of the user that is initiating the update. (DB: userprofile.id)</param>
        /// <param name="status">Status enum used for update. If empy, TODO will be used.</param>
        /// <param name="comment">Comment used for update</param>
        /// <returns>true / false depending on outcome. If more then 1 row is updated, true is returned in all other cases false.</returns>
        public async Task<bool> SetTaskStatusWithReasonAsync(int companyId, int taskId, int userId, TaskStatusEnum status, string comment, DateTime signedAtUtc)
        {
            var original = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.tasks_task.ToString(), taskId);

            List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
            parameters.Add(new NpgsqlParameter("@_companyid", companyId));
            parameters.Add(new NpgsqlParameter("@_id", taskId));
            parameters.Add(new NpgsqlParameter("@_userid", userId));
            parameters.Add(new NpgsqlParameter("@_status", status.ToDatabaseString()));
            parameters.Add(new NpgsqlParameter("@_comment", comment));
            parameters.Add(new NpgsqlParameter("@_signedatutc", new DateTime(signedAtUtc.Ticks)));
            var rowseffected = await _manager.ExecuteScalarAsync("set_task_status_with_reason", parameters: parameters, commandType: CommandType.StoredProcedure);

            if (Convert.ToInt32(rowseffected) > 0)
            {
                var mutated = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.tasks_task.ToString(), taskId);
                await _dataAuditing.WriteDataAudit(original: original, mutated: mutated, Models.Enumerations.TableNames.tasks_task.ToString(), objectId: taskId, userId: userId, companyId: companyId, description: "Changed task status with reason.");
            }

            await _taskGenerationManager.GenerateSpecificTemplateBasedOnTask(companyId: companyId, taskId: taskId); //check if generation needs to be done based on template type

            return (Convert.ToInt32(rowseffected) > 0);
        }

        /// <summary>
        /// SetTaskStatussesWithReasonAsync; Set task statusses with reason async.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="userId">UserId of the user that is initiating the update. (DB: userprofile.id)</param>
        /// <param name="multiTaskStatus">Configuration for statusses to be set. </param>
        /// <returns>true / false depending on outcome. If more then 1 row is updated, true is returned in all other cases false.</returns>
        public async Task<bool> SetTaskStatussesWithReasonAsync(int companyId, int userId, MultiTaskStatusWithReason multiTaskStatus)
        {
            var result = true;
            foreach (var taskId in multiTaskStatus.TaskIds)
            {
                result &= await SetTaskStatusWithReasonAsync(companyId, taskId, userId, (TaskStatusEnum)multiTaskStatus.Status, multiTaskStatus.Comment, multiTaskStatus.SignedAtUtc);
            }
            return result;
        }

        /// <summary>
        /// SetTaskRealizedAsync; Set relized time for specific task
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="taskId">taskId (DB: tasks_task.id)</param>
        /// <param name="realizedById">UserId of the user that is initiating the update. (DB: userprofile.id)</param>
        /// <param name="timeRealized">Time realized in minutes.</param>
        /// <returns></returns>
        public async Task<bool> SetTaskRealizedAsync(int companyId, int taskId, int realizedById, int timeRealized)
        {
            var original = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.tasks_task.ToString(), taskId);

            List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
            parameters.Add(new NpgsqlParameter("@_companyid", companyId));
            parameters.Add(new NpgsqlParameter("@_id", taskId));
            parameters.Add(new NpgsqlParameter("@_realizedbyid", realizedById));
            parameters.Add(new NpgsqlParameter("@_timerealized", timeRealized));
            var rowseffected = await _manager.ExecuteScalarAsync("set_task_realizedtime", parameters: parameters, commandType: CommandType.StoredProcedure);

            if (Convert.ToInt32(rowseffected) > 0)
            {
                var mutated = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.tasks_task.ToString(), taskId);
                await _dataAuditing.WriteDataAudit(original: original, mutated: mutated, Models.Enumerations.TableNames.tasks_task.ToString(), objectId: taskId, userId: realizedById, companyId: companyId, description: "Changed task realized time.");
            }

            return (Convert.ToInt32(rowseffected) > 0);
        }
        #endregion

        #region - public methods TaskTemplates -
        /// <summary>
        /// GetTaskTemplatesAsync; Get a list of TaskTemplates with a company.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="filters">Filter object, containing certain filters.</param>
        /// <param name="include">Include; comma seperated string containing certain extra information references that need to be included.</param>
        /// <returns>A list of TaskTemplate objects.</returns>
        public async Task<List<TaskTemplate>> GetTaskTemplatesAsync(int companyId, int? userId = null, TaskFilters? filters = null, string include = null)
        {
            var output = new List<TaskTemplate>();
            string language = Culture;
            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));

                if (filters.HasValue)
                {
                    if (filters.Value.Limit.HasValue && filters.Value.Limit.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_limit", filters.Value.Limit.Value));
                    }

                    if (filters.Value.Offset.HasValue && filters.Value.Offset.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_offset", filters.Value.Offset.Value));
                    }

                    if (filters.Value.Timestamp.HasValue && filters.Value.Timestamp.Value > DateTime.MinValue)
                    {
                        parameters.Add(new NpgsqlParameter("@_timestamp", filters.Value.Timestamp.Value));
                    }

                    if (filters.Value.AllowedOnly.HasValue && filters.Value.AllowedOnly.Value && userId.HasValue && userId > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_userid", userId.Value));
                    }

                    if (filters.Value.TagIds != null && filters.Value.TagIds.Length > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_tagids", filters.Value.TagIds));
                    }

                    //roles filter
                    if (filters.Value.Roles != null && filters.Value.Roles.Count > 0)
                    {
                        var rolesFilterValue = new List<string>();

                        foreach (var role in filters.Value.Roles)
                        {
                            if (role == RoleTypeEnum.Basic)
                            {
                                rolesFilterValue.Add("basic");
                            }
                            else if (role == RoleTypeEnum.ShiftLeader)
                            {
                                rolesFilterValue.Add("shift_leader");
                            }
                            else if (role == RoleTypeEnum.Manager)
                            {
                                rolesFilterValue.Add("manager");
                            }
                        }

                        parameters.Add(new NpgsqlParameter("@_roles", rolesFilterValue.ToArray()));
                    }

                    //area id filter (multi)
                    if (filters.Value.AreaIds != null && filters.Value.AreaIds.Length > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_areaids", filters.Value.AreaIds));
                    }
                    else if (filters.Value.AreaId.HasValue) //area id filter single select (backwards compatibility)
                    {
                        int[] areaIds = {(int)filters.Value.AreaId};
                        parameters.Add(new NpgsqlParameter("@_areaids", areaIds));
                    }

                    //recurrency type filter (multi select)
                    if (filters.Value.RecurrencyTypes != null && filters.Value.RecurrencyTypes.Count > 0)
                    {
                        var recurrencyTypesFilterValue = new List<string>();

                        foreach (var recurrencyType in filters.Value.RecurrencyTypes)
                        {
                            recurrencyTypesFilterValue.Add(recurrencyType.ToDatabaseString());
                        }

                        parameters.Add(new NpgsqlParameter("@_recurrencytypes", recurrencyTypesFilterValue.ToArray()));
                    }
                    else if (filters.Value.RecurrencyType.HasValue) //recurrency type fitler single select (backwards compatible reasons)
                    {
                        var recurrencyTypesFilterValue = new List<string>();
                        recurrencyTypesFilterValue.Add(filters.Value.RecurrencyType.Value.ToDatabaseString());
                        parameters.Add(new NpgsqlParameter("@_recurrencytypes", recurrencyTypesFilterValue.ToArray()));
                    }

                    //filtertext
                    if (!string.IsNullOrEmpty(filters.Value.FilterText))
                    {
                        parameters.Add(new NpgsqlParameter("@_filtertext", filters.Value.FilterText));
                    }

                    //tasktype
                    if (filters.Value.TaskType.HasValue)
                    {
                        if (filters.Value.TaskType.Value == TaskTypeEnum.Task)
                        {
                            parameters.Add(new NpgsqlParameter("@_tasktype", "task"));
                        }
                        else if (filters.Value.TaskType.Value == TaskTypeEnum.Checklist)
                        {
                            parameters.Add(new NpgsqlParameter("@_tasktype", "checklist"));
                        }
                        else if (filters.Value.TaskType.Value == TaskTypeEnum.Audit)
                        {
                            parameters.Add(new NpgsqlParameter("@_tasktype", "audit"));
                        }
                    }

                    //instructions added
                    if (filters.Value.InstructionsAdded != null)
                    {
                        parameters.Add(new NpgsqlParameter("@_instructionsadded", filters.Value.InstructionsAdded));
                    }

                    //photos added
                    if (filters.Value.ImagesAdded != null)
                    {
                        parameters.Add(new NpgsqlParameter("@_imagesadded", filters.Value.ImagesAdded));
                    }

                    //videos added
                    if (filters.Value.VideosAdded != null)
                    {
                        parameters.Add(new NpgsqlParameter("@_videosadded", filters.Value.VideosAdded));
                    }
                }

                using (dr = await _manager.GetDataReader("get_tasktemplates_v3", commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        var tasktemplate = CreateOrFillTaskTemplateFromReader(dr);
                        output.Add(tasktemplate);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTaskTemplatesAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);

            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            if (output.Count > 0)
            {
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.AreaPaths.ToString().ToLower())) output = await AppendAreaPathsToTaskTemplatesAsync(tasktemplates: output, companyId: companyId, addAreaPath: include.Split(",").Contains(IncludesEnum.AreaPaths.ToString().ToLower()), addAreaPathIds: include.Split(",").Contains(IncludesEnum.AreaPathIds.ToString().ToLower()));
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Steps.ToString().ToLower())) output = await AppendStepsToTaskTemplatesAsync(tasktemplates: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.Recurrency.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.RecurrencyShifts.ToString().ToLower()))) output = await AppendRecurrencyToTaskTemplatesAsync(tasktemplates: output, includeShifts: include.Split(",").Contains(IncludesEnum.RecurrencyShifts.ToString().ToLower()), companyId: companyId);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertyValues.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.Properties.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.PropertyDetails.ToString().ToLower()))) output = await AppendTemplatePropertiesToTaskTemplates(taskstemplates: output, companyId: companyId, include: include);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.InstructionRelations.ToString().ToLower()))) output = await AppendWorkInstructionRelations(taskTemplates: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Tags.ToString().ToLower())) output = await AppendTagsToTaskTemplatesAsync(taskTemplates: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.Language.ToString().ToLower()))) output = await AppendTranslationsToTaskTemplatesAsync(companyId: companyId, taskTemplates: output, language);

            }

            return output;
        }

        /// <summary>
        /// GetTaskTemplatesCountsAsync; Get coutns based on GetTaskTemplates parameters, seperate SP for generation counts. 
        /// </summary>
        /// <param name="companyId">CompanyId</param>
        /// <param name="userId">UserId</param>
        /// <param name="filters">Filters, same as TaskTemplates retrieval</param>
        /// <param name="include">Same as TaskTemplate retrieval, not specifically used.</param>
        /// <returns></returns>
        public async Task<TaskTemplateCountStatistics> GetTaskTemplatesCountsAsync(int companyId, int? userId = null, TaskFilters? filters = null, string include = null)
        {
            var output = new TaskTemplateCountStatistics();
            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));

                if (filters.HasValue)
                {
                    if (filters.Value.Limit.HasValue && filters.Value.Limit.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_limit", filters.Value.Limit.Value));
                    }

                    if (filters.Value.Offset.HasValue && filters.Value.Offset.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_offset", filters.Value.Offset.Value));
                    }

                    if (filters.Value.AreaId.HasValue && filters.Value.AreaId.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_areaid", filters.Value.AreaId.Value));
                    }

                    if (filters.Value.Timestamp.HasValue && filters.Value.Timestamp.Value > DateTime.MinValue)
                    {
                        parameters.Add(new NpgsqlParameter("@_timestamp", filters.Value.Timestamp.Value));
                    }

                    if (filters.Value.AllowedOnly.HasValue && filters.Value.AllowedOnly.Value && userId.HasValue && userId > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_userid", userId.Value));
                    }

                    if (filters.Value.TagIds != null && filters.Value.TagIds.Length > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_tagids", filters.Value.TagIds));
                    }

                    //roles filter
                    if (filters.Value.Roles != null && filters.Value.Roles.Count > 0)
                    {
                        var rolesFilterValue = new List<string>();

                        foreach (var role in filters.Value.Roles)
                        {
                            if (role == RoleTypeEnum.Basic)
                            {
                                rolesFilterValue.Add("basic");
                            }
                            else if (role == RoleTypeEnum.ShiftLeader)
                            {
                                rolesFilterValue.Add("shift_leader");
                            }
                            else if (role == RoleTypeEnum.Manager)
                            {
                                rolesFilterValue.Add("manager");
                            }
                        }

                        parameters.Add(new NpgsqlParameter("@_roles", rolesFilterValue.ToArray()));
                    }

                    //recurrency type filter (multi select)
                    if (filters.Value.RecurrencyTypes != null && filters.Value.RecurrencyTypes.Count > 0)
                    {
                        var recurrencyTypesFilterValue = new List<string>();

                        foreach (var recurrencyType in filters.Value.RecurrencyTypes)
                        {
                            recurrencyTypesFilterValue.Add(recurrencyType.ToDatabaseString());
                        }

                        parameters.Add(new NpgsqlParameter("@_recurrencytypes", recurrencyTypesFilterValue.ToArray()));
                    }
                    else if (filters.Value.RecurrencyType.HasValue) //recurrency type fitler single select (backwards compatible reasons)
                    {
                        var recurrencyTypesFilterValue = new List<string>();
                        recurrencyTypesFilterValue.Add(filters.Value.RecurrencyType.Value.ToDatabaseString());
                        parameters.Add(new NpgsqlParameter("@_recurrencytypes", recurrencyTypesFilterValue.ToArray()));
                    }

                    //filtertext
                    if (!string.IsNullOrEmpty(filters.Value.FilterText))
                    {
                        parameters.Add(new NpgsqlParameter("@_filtertext", filters.Value.FilterText));
                    }

                    //tasktype
                    if (filters.Value.TaskType.HasValue)
                    {
                        if (filters.Value.TaskType.Value == TaskTypeEnum.Task)
                        {
                            parameters.Add(new NpgsqlParameter("@_tasktype", "task"));
                        }
                        else if (filters.Value.TaskType.Value == TaskTypeEnum.Checklist)
                        {
                            parameters.Add(new NpgsqlParameter("@_tasktype", "checklist"));
                        }
                        else if (filters.Value.TaskType.Value == TaskTypeEnum.Audit)
                        {
                            parameters.Add(new NpgsqlParameter("@_tasktype", "audit"));
                        }
                    }

                    //instructions added
                    if (filters.Value.InstructionsAdded != null)
                    {
                        parameters.Add(new NpgsqlParameter("@_instructionsadded", filters.Value.InstructionsAdded));
                    }

                    //photos added
                    if (filters.Value.ImagesAdded != null)
                    {
                        parameters.Add(new NpgsqlParameter("@_imagesadded", filters.Value.ImagesAdded));
                    }

                    //videos added
                    if (filters.Value.VideosAdded != null)
                    {
                        parameters.Add(new NpgsqlParameter("@_videosadded", filters.Value.VideosAdded));
                    }
                }

                using (dr = await _manager.GetDataReader("get_tasktemplates_v2_counts", commandType: System.Data.CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        var tasktemplateCounts = CreateOrFillTaskTemplateCountsFromReader(dr);
                        if(tasktemplateCounts != null)
                        {
                            output = tasktemplateCounts;
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTaskTemplatesCountsAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(Settings.ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);

            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            return output;
        }

        /// <summary>
        /// GetTaskTemplatesActionsAsync; Get all tasktemplates that are linked to a action.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="filters">Filter object, containing certain filters.</param>
        /// <param name="include">Include; comma seperated string containing certain extra information references that need to be included.</param>
        /// <returns>A list of TaskTemplate objects.</returns>
        public async Task<List<TaskTemplate>> GetTaskTemplatesActionsAsync(int companyId, int? userId = null, TaskFilters? filters = null, string include = null)
        {
            var output = new List<TaskTemplate>();
            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));

                if (filters.HasValue)
                {
                    if (filters.Value.Limit.HasValue && filters.Value.Limit.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_limit", filters.Value.Limit.Value));
                    }

                    if (filters.Value.Offset.HasValue && filters.Value.Offset.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_offset", filters.Value.Offset.Value));
                    }

                    if (filters.Value.Timestamp.HasValue && filters.Value.Timestamp.Value > DateTime.MinValue)
                    {
                        parameters.Add(new NpgsqlParameter("@_timestamp", filters.Value.Timestamp.Value));
                    }

                    if (filters.Value.TagIds != null && filters.Value.TagIds.Length > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_tagids", filters.Value.TagIds));
                    }
                }

                using (dr = await _manager.GetDataReader("get_tasktemplates_with_actions", commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        var tasktemplate = CreateOrFillTaskTemplateFromReader(dr);
                        output.Add(tasktemplate);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTaskTemplatesActionsAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);

            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            if (filters.HasValue && filters.Value.HasFilters())
            {
                output = (await FilterTemplates(companyId: companyId, userId: userId, filters: filters.Value, nonFilteredCollection: output)).ToList();

            }

            if (output.Count > 0)
            {
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.AreaPaths.ToString().ToLower())) output = await AppendAreaPathsToTaskTemplatesAsync(tasktemplates: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Tags.ToString().ToLower())) output = await AppendTagsToTaskTemplatesAsync(taskTemplates: output, companyId: companyId);
            }

            return output;
        }


        /// <summary>
        /// GetTaskTemplateAsync; Get task template based on the task template id
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="taskTemplateId">TaskTemplateId (DB: tasks_tasktemplate.id)</param>
        /// <param name="include">Include parameter can be used for including extra data, based on includes enum.</param>
        /// <returns>A TaskTemplate object.</returns>
        public async Task<TaskTemplate> GetTaskTemplateAsync(int companyId, int taskTemplateId, string include = null, ConnectionKind connectionKind = ConnectionKind.Reader)
        {
            var tasktemplate = new TaskTemplate();
            string language = Culture;
            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));
                parameters.Add(new NpgsqlParameter("@_id", taskTemplateId));

                using (dr = await _manager.GetDataReader("get_tasktemplate", commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        CreateOrFillTaskTemplateFromReader(dr, tasktemplate: tasktemplate);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTaskTemplateAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            if (tasktemplate.Id > 0)
            {
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Steps.ToString().ToLower())) tasktemplate.Steps = await GetTaskTemplateStepsByTaskTemplateIdAsync(companyId: companyId, taskTemplateId: tasktemplate.Id);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Actions.ToString().ToLower())) tasktemplate.Actions = await _actionManager.GetActionsByTaskTemplateIdAsync(companyId: companyId, taskTemplateId: tasktemplate.Id);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.Recurrency.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.RecurrencyShifts.ToString().ToLower()))) tasktemplate = await AppendRecurrencyToTaskTemplateAsync(tasktemplate: tasktemplate, includeShifts: include.Split(",").Contains(IncludesEnum.RecurrencyShifts.ToString().ToLower()), companyId: companyId);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertyValues.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.Properties.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.PropertyDetails.ToString().ToLower()))) tasktemplate = await AppendTemplatePropertiesToTaskTemplate(taskstemplate: tasktemplate, companyId: companyId, include: include);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.InstructionRelations.ToString().ToLower())) tasktemplate.WorkInstructionRelations = await GetWorkInstructionRelationsAsync(companyId: companyId, taskTemplateId: tasktemplate.Id);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Instructions.ToString().ToLower())) tasktemplate.WorkInstructions = await GetWorkInstructionsByTaskTemplateIdAsync(companyId: companyId, taskTemplateId: tasktemplate.Id);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Tags.ToString().ToLower())) tasktemplate.Tags = await _tagManager.GetTagsWithObjectAsync(companyId: companyId, objectType: ObjectTypeEnum.TaskTemplate, id: tasktemplate.Id);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Language.ToString().ToLower()))
                {
                    var tempList = new List<TaskTemplate> { tasktemplate };
                    tempList = await AppendTranslationsToTaskTemplatesAsync(companyId, tempList, language);
                    tasktemplate = tempList.First();
                }
                return tasktemplate;
            }
            return null;
        }

        /// <summary>
        /// GetTaskTemplatesByChecklistTemplateIdAsync; Get a list of task templates based on the parent checklist template id
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="checklistTemplateId">ChecklistTemplateId (DB: checklist_checklisttemplate.id)</param>
        /// <returns>A list of specific TaskTemplates.</returns>
        public async Task<List<TaskTemplate>> GetTaskTemplatesByChecklistTemplateIdAsync(int companyId, int checklistTemplateId, string include = null, ConnectionKind connectionKind = ConnectionKind.Reader)
        {
            var output = new List<TaskTemplate>();
            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));
                parameters.Add(new NpgsqlParameter("@_checklisttemplateid", checklistTemplateId));

                using (dr = await _manager.GetDataReader("get_tasktemplates_by_checklisttemplate", commandType: CommandType.StoredProcedure, parameters: parameters, connectionKind: connectionKind))
                {
                    while (await dr.ReadAsync())
                    {
                        var tasktemplate = CreateOrFillTaskTemplateFromReader(dr);
                        output.Add(tasktemplate);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTaskTemplatesByChecklistTemplateIdAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            if (output.Count > 0)
            {
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Tags.ToString().ToLower())) output = await AppendTagsToTaskTemplatesAsync(taskTemplates: output, companyId: companyId, connectionKind: connectionKind);
            }

            return output;
        }

        /// <summary>
        /// GetShiftRelationsWithTaskTemplatesAsync(); Get a list of TaskTemplateRelationShift containing all the relevant relation data for a TaskTemplate - CompanyShift relation.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <returns>List of TaskTemplateRelationShift objects</returns>
        public async Task<List<TaskTemplateRelationShift>> GetShiftRelationsWithTaskTemplatesAsync(int companyId)
        {
            var output = new List<TaskTemplateRelationShift>();
            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));

                string sp = "get_shifts_with_tasktemplates";

                using (dr = await _manager.GetDataReader(sp, commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        TaskTemplateRelationShift shiftrelation = new TaskTemplateRelationShift();
                        shiftrelation.Day = Convert.ToInt32(dr["day"]);
                        shiftrelation.End = dr["end"].ToString();
                        shiftrelation.ShiftId = Convert.ToInt32(dr["shift_id"]);
                        shiftrelation.Start = dr["start"].ToString();
                        shiftrelation.TaskTemplateId = Convert.ToInt32(dr["tasktemplate_id"]);

                        output.Add(shiftrelation);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("AreaManager.GetShiftRelationsWithTaskTemplatesAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            return output;
        }

        /// <summary>
        /// AddTaskTemplateAsync; Add a TaskTemplate, if recurrences, steps are also supplied these will also be created.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="taskTemplate">TaskTemplate object containing all relevant data.</param>
        /// <returns>possible id.</returns>
        public async Task<int> AddTaskTemplateAsync(int companyId, int userId, TaskTemplate taskTemplate)
        {
            if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_BACKWARDS_COMPATIBILITY_CONFIG_KEY)) taskTemplate = await ForceBackwardCompatibilityForTemplate(template: taskTemplate);

            List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();

            parameters.AddRange(GetNpgsqlParametersFromTaskTemplate(taskTemplate: taskTemplate, companyId: taskTemplate.CompanyId));

            var possibleId = Convert.ToInt32(await _manager.ExecuteScalarAsync("add_tasktemplate", parameters: parameters, commandType: CommandType.StoredProcedure));

            if (possibleId > 0)
            {
                taskTemplate.Id = possibleId;

                if (taskTemplate.Tags != null && taskTemplate.Tags.Count > 0)
                {
                    await _tagManager.UpdateTagsOnObjectAsync(ObjectTypeEnum.TaskTemplate, possibleId, taskTemplate.Tags, companyId, userId);
                }

                //add recurrency
                if (taskTemplate.Recurrency != null)
                {
                    taskTemplate.Recurrency.TemplateId = possibleId;
                    var recurrencyId = await AddTaskRecurrencyAsync(companyId: companyId, userId: userId, taskRecurrency: taskTemplate.Recurrency);
                }

                //add steps
                if (taskTemplate.Steps != null)
                {
                    var stepsNr = await AddChangeStepsAsync(companyId: companyId, userId: userId, templateId: possibleId, steps: taskTemplate.Steps);
                }

                //Add checklist template relation if needed
                if (taskTemplate.ChecklistTemplateId.HasValue && taskTemplate.ChecklistTemplateId.Value > 0)
                {
                    var relationchecklist = await SetTaskTemplateChecklistTemplateRelation(companyId: companyId, taskTemplateId: possibleId, checklistTemplateId: taskTemplate.ChecklistTemplateId.Value);
                }

                //Add audit template relation if needed
                if (taskTemplate.AuditTemplateId.HasValue && taskTemplate.AuditTemplateId.Value > 0)
                {
                    var relationaudit = await SetTaskTemplateAuditTemplateRelation(companyId: companyId, taskTemplateId: possibleId, auditTemplateId: taskTemplate.AuditTemplateId.Value);
                }

                if (taskTemplate.Properties != null && taskTemplate.Properties.Count > 0)
                {
                    var propNr = await AddChangeTaskTemplatePropertiesAsync(companyId: companyId, userId: userId, templateId: possibleId, templateProperties: taskTemplate.Properties);
                }

                if (taskTemplate.WorkInstructionRelations != null && taskTemplate.WorkInstructionRelations.Count > 0)
                {
                    var relationNr = await AddChangeWorkInstructionRelationsAsync(companyId: companyId, userId: userId, templateId: possibleId, templateWorkInstructionRelations: taskTemplate.WorkInstructionRelations, checklistTemplateId: taskTemplate.ChecklistTemplateId, auditTemplateId: taskTemplate.AuditTemplateId);
                }

                var mutated = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.tasks_tasktemplate.ToString(), possibleId);
                await _dataAuditing.WriteDataAudit(original: string.Empty, mutated: mutated, Models.Enumerations.TableNames.tasks_tasktemplate.ToString(), objectId: possibleId, userId: userId, companyId: companyId, description: "Added tasktemplate.");

            }

            return Convert.ToInt32(possibleId);
        }

        /// <summary>
        /// ChangeTaskTemplateAsync; Change a task template item
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="taskTemplateId">TaskTemplateId (DB: tasks_tasktemplate.id)</param>
        /// <param name="taskTemplate">TaskTemplate object containing al relevant data.</param>
        /// <returns>true/false depending on outcome.</returns>
        public async Task<bool> ChangeTaskTemplateAsync(int companyId, int userId, int taskTemplateId, TaskTemplate taskTemplate)
        {
            var original = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.tasks_tasktemplate.ToString(), taskTemplateId);

            List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();

            parameters.AddRange(GetNpgsqlParametersFromTaskTemplate(taskTemplate: taskTemplate, companyId: companyId, taskTemplateId: taskTemplateId));

            var rowseffected = await _manager.ExecuteScalarAsync("change_tasktemplate", parameters: parameters, commandType: CommandType.StoredProcedure);

            if (Convert.ToInt32(rowseffected) > 0)
            {
                taskTemplate.Tags ??= new();
                await _tagManager.UpdateTagsOnObjectAsync(ObjectTypeEnum.TaskTemplate, taskTemplateId, taskTemplate.Tags, companyId, userId);

                //change recurrency
                if (taskTemplate.Recurrency != null)
                {
                    var rowseffectedrecurrency = await ChangeTaskRecurrencyAsync(companyId: companyId, userId: userId, taskRecurrencyId: taskTemplate.Recurrency.Id, taskRecurrency: taskTemplate.Recurrency);
                }

                ////add steps
                if (taskTemplate.Steps != null)
                {
                    var rowseffectedsteps = await AddChangeStepsAsync(companyId: companyId, userId: userId, templateId: taskTemplateId, steps: taskTemplate.Steps);
                }

                //Add checklist template relation if needed
                if (taskTemplate.ChecklistTemplateId.HasValue && taskTemplate.ChecklistTemplateId.Value > 0)
                {
                    var relationchecklist = await SetTaskTemplateChecklistTemplateRelation(companyId: companyId, taskTemplateId: taskTemplateId, checklistTemplateId: taskTemplate.ChecklistTemplateId.Value);
                }

                //Add audit template relation if needed
                if (taskTemplate.AuditTemplateId.HasValue && taskTemplate.AuditTemplateId.Value > 0)
                {
                    var relationaudit = await SetTaskTemplateAuditTemplateRelation(companyId: companyId, taskTemplateId: taskTemplateId, auditTemplateId: taskTemplate.AuditTemplateId.Value);
                }

                if (taskTemplate.Properties != null)
                {
                    var propNr = await AddChangeTaskTemplatePropertiesAsync(companyId: companyId, userId: userId, templateId: taskTemplateId, templateProperties: taskTemplate.Properties);
                }

                if (taskTemplate.WorkInstructionRelations != null)
                {
                    var relationNr = await AddChangeWorkInstructionRelationsAsync(companyId: companyId, userId: userId, templateId: taskTemplateId, templateWorkInstructionRelations: taskTemplate.WorkInstructionRelations, checklistTemplateId: taskTemplate.ChecklistTemplateId, auditTemplateId: taskTemplate.AuditTemplateId);
                }
            }

            if (Convert.ToInt32(rowseffected) > 0)
            {
                var mutated = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.tasks_tasktemplate.ToString(), taskTemplateId);
                await _dataAuditing.WriteDataAudit(original: original, mutated: mutated, Models.Enumerations.TableNames.tasks_tasktemplate.ToString(), objectId: taskTemplateId, userId: userId, companyId: companyId, description: "Changed tasktemplate.");
            }

            return (Convert.ToInt32(rowseffected) > 0);
        }

        /// <summary>
        /// SetTaskTemplateActiveAsync; Set TaskTemplate active/inactive based on TaskTemplateId.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="taskTemplateId">TemplateId (DB: tasks_tasktemplate.id)</param>
        /// <param name="isActive">true / false -> default true is selected, for setting a TaskTemplate to inactive, set parameter to false.</param>
        /// <returns>true / false depending on outcome. If more then 1 row is updated, true is returned in all other cases false.</returns>
        public async Task<bool> SetTaskTemplateActiveAsync(int companyId, int userId, int taskTemplateId, bool isActive = true)
        {
            var original = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.tasks_tasktemplate.ToString(), taskTemplateId);

            List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
            parameters.Add(new NpgsqlParameter("@_companyid", companyId));
            parameters.Add(new NpgsqlParameter("@_id", taskTemplateId));
            parameters.Add(new NpgsqlParameter("@_active", isActive));
            var rowseffected = await _manager.ExecuteScalarAsync("set_tasktemplate_active", parameters: parameters, commandType: CommandType.StoredProcedure);

            if (Convert.ToInt32(rowseffected) > 0)
            {
                var mutated = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.tasks_tasktemplate.ToString(), taskTemplateId);
                await _dataAuditing.WriteDataAudit(original: original, mutated: mutated, Models.Enumerations.TableNames.tasks_tasktemplate.ToString(), objectId: taskTemplateId, userId: userId, companyId: companyId, description: "Changed tasktemplate active state.");
            }

            return (Convert.ToInt32(rowseffected) > 0);
        }

        /// <summary>
        /// SetTaskTemplateDerivativeInActiveAsync; 
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="userId"></param>
        /// <param name="taskTemplateId">TemplateId (DB: tasks_tasktemplate.id)</param>
        /// <returns>true / false depending on outcome. </returns>
        public async Task<bool> SetTaskTemplateDerivativeInActiveAsync(int companyId, int userId, int taskTemplateId)
        {
            await SetTaskTemplateStepsInActiveAsync(companyId: companyId, userId: userId, taskTemplateId: taskTemplateId);
            await SetTaskTemplateRecurrencyInActiveAsync(companyId: companyId, userId: userId, taskTemplateId: taskTemplateId);
            await SetTaskTemplateTasksInActiveAsync(companyId: companyId, userId: userId, taskTemplateId: taskTemplateId, fromDate: DateTime.Now);

            return true;
        }

        private async Task<bool> SetTaskTemplateRecurrencyInActiveAsync(int companyId, int userId, int taskTemplateId)
        {
            List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
            parameters.Add(new NpgsqlParameter("@_companyid", companyId));
            parameters.Add(new NpgsqlParameter("@_templateid", taskTemplateId));
            parameters.Add(new NpgsqlParameter("@_active", false));
            var rowseffected = await _manager.ExecuteScalarAsync("set_tasktemplate_recurrency_active", parameters: parameters, commandType: CommandType.StoredProcedure);

            return (Convert.ToInt32(rowseffected) > 0);
        }

        private async Task<bool> SetTaskTemplateStepsInActiveAsync(int companyId, int userId, int taskTemplateId)
        {
            List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
            parameters.Add(new NpgsqlParameter("@_companyid", companyId));
            parameters.Add(new NpgsqlParameter("@_templateid", taskTemplateId));
            parameters.Add(new NpgsqlParameter("@_active", false));
            var rowseffected = await _manager.ExecuteScalarAsync("set_tasktemplate_steps_active", parameters: parameters, commandType: CommandType.StoredProcedure);

            return (Convert.ToInt32(rowseffected) > 0);
        }

        private async Task<bool> SetTaskTemplateTasksInActiveAsync(int companyId, int userId, int taskTemplateId, DateTime fromDate)
        {

            List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
            parameters.Add(new NpgsqlParameter("@_companyid", companyId));
            parameters.Add(new NpgsqlParameter("@_templateid", taskTemplateId));
            parameters.Add(new NpgsqlParameter("@_active", false));
            parameters.Add(new NpgsqlParameter("@_fromdate", DateTime.Now));
            var rowseffected = await _manager.ExecuteScalarAsync("set_tasktemplate_tasks_active", parameters: parameters, commandType: CommandType.StoredProcedure);

            return (Convert.ToInt32(rowseffected) > 0);
        }
        #endregion

        #region - public methods TaskRecurrency -
        /// <summary>
        /// GetTaskRecurrenciesAsync; Get a list of task recurrency objects. These objects can only be used with TaskTemplates.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="filters">Filters to be used for filtering a set of data.</param>
        /// <returns>A list of recurrency objects.</returns>
        public async Task<List<TaskRecurrency>> GetTaskRecurrenciesAsync(int companyId, TaskFilters? filters = null, string include = null)
        {
            var output = new List<TaskRecurrency>();

            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));

                using (dr = await _manager.GetDataReader("get_taskrecurrencies", commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        var taskrecurrency = CreateOrFillTaskRecurrencyFromReader(dr);
                        output.Add(taskrecurrency);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTaskRecurrenciesAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            if (filters.HasValue && filters.Value.HasFilters())
            {
                output = (await FilterRecurrencies(companyId: companyId, filters: filters.Value, nonFilteredCollection: output)).ToList();
            }

            if (output.Count > 0)
            {
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.RecurrencyShifts.ToString().ToLower())) output = await AppendShiftsToTaskTaskRecurrenciesAsync(taskrecurrencies: output, companyId: companyId);
            }

            return output;
        }

        /// <summary>
        /// GetTaskRecurrencyAsync; Get a specific recurrenty object based on recurrency id
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="taskRecurrencyId">RecurruncyId (DB: tasks_taskrecurrency.id)</param>
        /// <returns>TaskRecurrency object.</returns>
        public async Task<TaskRecurrency> GetTaskRecurrencyAsync(int companyId, int taskRecurrencyId)
        {
            var taskrecurrency = new TaskRecurrency();

            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));
                parameters.Add(new NpgsqlParameter("@_id", taskRecurrencyId));

                using (dr = await _manager.GetDataReader("get_taskrecurrency", commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {

                        CreateOrFillTaskRecurrencyFromReader(dr, taskrecurrency: taskrecurrency);

                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTaskRecurrencyAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            if (taskrecurrency.Id > 0)
            {
                return taskrecurrency;
            }
            return null;
        }

        /// <summary>
        /// AddTaskRecurrencyAsync; Add a task recurrency object to the database.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="taskRecurrency">taskRecurrency containing all information.</param>
        /// <returns>possible id.</returns>
        public async Task<int> AddTaskRecurrencyAsync(int companyId, int userId, TaskRecurrency taskRecurrency)
        {
            List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();

            parameters.AddRange(GetNpgsqlParametersFromTaskRecurrency(taskRecurrency: taskRecurrency, companyId: taskRecurrency.CompanyId));

            var possibleId = Convert.ToInt32(await _manager.ExecuteScalarAsync("add_taskrecurrency", parameters: parameters, commandType: CommandType.StoredProcedure));

            if (possibleId > 0 && taskRecurrency.Shifts != null && taskRecurrency.Shifts.Any())
            {
                if (taskRecurrency.RecurrencyType == RecurrencyTypeEnum.NoRecurrency.ToDatabaseString())
                {
                    await AddShiftsToOneTimeOnlyTaskRecurrencyAsync(companyId: companyId, userId: userId, taskRecurrencyId: possibleId, shiftIds: taskRecurrency.Shifts);
                }
                else //if (taskRecurrency.RecurrencyType == RecurrencyTypeEnum.Shifts.ToDatabaseString())
                {
                    await AddShiftsToTaskRecurrencyAsync(companyId: companyId, userId: userId, taskRecurrencyId: possibleId, shiftIds: taskRecurrency.Shifts);
                }

            }

            if (possibleId > 0)
            {
                var mutated = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.tasks_taskrecurrency.ToString(), possibleId);
                await _dataAuditing.WriteDataAudit(original: string.Empty, mutated: mutated, Models.Enumerations.TableNames.tasks_taskrecurrency.ToString(), objectId: possibleId, userId: userId, companyId: companyId, description: "Added task recurrency.");
            }

            return possibleId;
        }

        /// <summary>
        /// ChangeTaskRecurrencyAsync; Change task recurrency object.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="taskRecurrencyId">TaskRecurrencyID (DB: tasks_taskrecurrncy.id)</param>
        /// <param name="taskRecurrency">TaskRecurrency containing all information.</param>
        /// <returns>true/false depending on outcome.</returns>
        public async Task<bool> ChangeTaskRecurrencyAsync(int companyId, int userId, int taskRecurrencyId, TaskRecurrency taskRecurrency)
        {
            var original = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.tasks_taskrecurrency.ToString(), taskRecurrencyId);

            List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();

            parameters.AddRange(GetNpgsqlParametersFromTaskRecurrency(taskRecurrency: taskRecurrency, companyId: companyId, taskRecurrencyId: taskRecurrencyId));

            var rowseffected = await _manager.ExecuteScalarAsync("change_taskrecurrency", parameters: parameters, commandType: CommandType.StoredProcedure);

            if (taskRecurrency.RecurrencyType == RecurrencyTypeEnum.NoRecurrency.ToDatabaseString())
            {
                if (Convert.ToInt32(rowseffected) > 0 && taskRecurrencyId > 0)
                {
                    await AddShiftsToOneTimeOnlyTaskRecurrencyAsync(companyId: companyId, userId: userId, taskRecurrencyId: taskRecurrencyId, shiftIds: taskRecurrency.Shifts);
                }
            }
            else
            {
                if (Convert.ToInt32(rowseffected) > 0 && taskRecurrencyId > 0 && taskRecurrency.Shifts != null && taskRecurrency.Shifts.Any())
                {
                    await AddShiftsToTaskRecurrencyAsync(companyId: companyId, userId: userId, taskRecurrencyId: taskRecurrencyId, shiftIds: taskRecurrency.Shifts);
                }

            }



            if (Convert.ToInt32(rowseffected) > 0)
            {
                var mutated = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.tasks_taskrecurrency.ToString(), taskRecurrencyId);
                await _dataAuditing.WriteDataAudit(original: original, mutated: mutated, Models.Enumerations.TableNames.tasks_taskrecurrency.ToString(), objectId: taskRecurrencyId, userId: userId, companyId: companyId, description: "Changed task recurrency.");
            }

            return (Convert.ToInt32(rowseffected) > 0);
        }

        /// <summary>
        /// SetTaskRecurrencyActiveAsync; Set TaskRecurrency active/inactive based on TaskRecurrencyId.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="taskRecurrencyId">TaskRecurrencyId (DB: tasks_taskrecurrency.id)</param>
        /// <param name="isActive">true / false -> default true is selected, for setting a TaskRecurrency to inactive, set parameter to false.</param>
        /// <returns>true / false depending on outcome. If more then 1 row is updated, true is returned in all other cases false.</returns>
        public async Task<bool> SetTaskRecurrencyActiveAsync(int companyId, int userId, int taskRecurrencyId, bool isActive = true)
        {
            var original = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.tasks_taskrecurrency.ToString(), taskRecurrencyId);

            List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
            parameters.Add(new NpgsqlParameter("@_companyid", companyId));
            parameters.Add(new NpgsqlParameter("@_id", taskRecurrencyId));
            parameters.Add(new NpgsqlParameter("@_active", isActive));
            var rowseffected = await _manager.ExecuteScalarAsync("set_taskrecurrency_active", parameters: parameters, commandType: CommandType.StoredProcedure);

            if (Convert.ToInt32(rowseffected) > 0)
            {
                var mutated = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.tasks_taskrecurrency.ToString(), taskRecurrencyId);
                await _dataAuditing.WriteDataAudit(original: original, mutated: mutated, Models.Enumerations.TableNames.tasks_taskrecurrency.ToString(), objectId: taskRecurrencyId, userId: userId, companyId: companyId, description: "Changed task recurrency active state.");
            }

            return (Convert.ToInt32(rowseffected) > 0);
        }
        #endregion

        #region - public methods TaskTemplateSTeps -
        /// <summary>
        /// GetTaskTemplateStepsAsync; Get steps collection. Steps can only be used with TaskTemplates.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <returns>List of step items.</returns>
        public async Task<List<Step>> GetTaskTemplateStepsAsync(int companyId, int? userId = null, TaskFilters? filters = null, List<int> taskTemplateIds = null, ConnectionKind connectionKind = ConnectionKind.Reader)
        {
            var output = new List<Step>();

            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>
                {
                    new("@_companyid", companyId)
                };
                if (taskTemplateIds != null) parameters.Add(new NpgsqlParameter("@_tasktemplateids", taskTemplateIds));

                using (dr = await _manager.GetDataReader("get_tasktemplatesteps", commandType: CommandType.StoredProcedure, parameters: parameters, connectionKind: connectionKind))
                {
                    while (await dr.ReadAsync())
                    {
                        var tasktemplatestep = CreateOrFillStepFromReader(dr);
                        output.Add(tasktemplatestep);
                    }
                }


            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTaskTemplateStepsAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            if (filters.HasValue && filters.Value.HasFilters())
            {
                output = (await FilterSteps(companyId: companyId, filters: filters.Value, nonFilteredCollection: output)).ToList();
            }

            return output;
        }

        /// <summary>
        /// GetTaskTemplateStepsWithAuditsAsync; Get specific steps that are based on a TaskTemplate item that is located with a Audit (AuditItem)
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="userId">UserId (DB: profiles_user.id)</param>
        /// <param name="filters">Filter object list based on certain filters.</param>
        /// <returns>List of step objects for use with audits.</returns>
        public async Task<List<Step>> GetTaskTemplateStepsWithAuditsAsync(int companyId, int? userId = null, TaskFilters? filters = null)
        {
            var output = new List<Step>();

            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));

                if (filters.HasValue)
                {
                    if (filters.Value.Limit.HasValue && filters.Value.Limit.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_limit", filters.Value.Limit.Value));
                    }

                    if (filters.Value.Offset.HasValue && filters.Value.Offset.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_offset", filters.Value.Offset.Value));
                    }

                    if (filters.Value.AreaId.HasValue && filters.Value.AreaId.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_areaid", filters.Value.AreaId.Value));
                    }

                    if (filters.Value.Timestamp.HasValue && filters.Value.Timestamp.Value > DateTime.MinValue)
                    {
                        parameters.Add(new NpgsqlParameter("@_timestamp", filters.Value.Timestamp.Value));
                    }

                    if (filters.Value.AllowedOnly.HasValue && filters.Value.AllowedOnly.Value && userId.HasValue && userId > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_userid", userId.Value));
                    }
                }

                using (dr = await _manager.GetDataReader("get_tasktemplatesteps_with_audittemplates", commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        var tasktemplatestep = CreateOrFillStepFromReader(dr);
                        output.Add(tasktemplatestep);
                    }
                }


            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTaskTemplateStepsWithAuditsAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);


            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            return output;
        }

        /// <summary>
        /// GetTaskTemplateStepsWithChecklistsAsync; Get specific steps that are based on a TaskTemplate item that is located with a Checklist (ChecklistItem)
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="userId">UserId (DB: profiles_user.id)</param>
        /// <param name="filters">Filter object list based on certain filters.</param>
        /// <returns>List of steps for use with checklists</returns>
        public async Task<List<Step>> GetTaskTemplateStepsWithChecklistsAsync(int companyId, int? userId = null, TaskFilters? filters = null, ConnectionKind connectionKind = ConnectionKind.Reader)
        {
            var output = new List<Step>();

            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));

                if (filters.HasValue)
                {
                    if (filters.Value.Limit.HasValue && filters.Value.Limit.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_limit", filters.Value.Limit.Value));
                    }

                    if (filters.Value.Offset.HasValue && filters.Value.Offset.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_offset", filters.Value.Offset.Value));
                    }

                    if (filters.Value.AreaId.HasValue && filters.Value.AreaId.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_areaid", filters.Value.AreaId.Value));
                    }

                    if (filters.Value.Timestamp.HasValue && filters.Value.Timestamp.Value > DateTime.MinValue)
                    {
                        parameters.Add(new NpgsqlParameter("@_timestamp", filters.Value.Timestamp.Value));
                    }

                    if (filters.Value.AllowedOnly.HasValue && filters.Value.AllowedOnly.Value && userId.HasValue && userId > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_userid", userId.Value));
                    }
                }

                using (dr = await _manager.GetDataReader("get_tasktemplatesteps_with_checklisttemplates", commandType: CommandType.StoredProcedure, parameters: parameters, connectionKind: connectionKind))
                {
                    while (await dr.ReadAsync())
                    {
                        var tasktemplatestep = CreateOrFillStepFromReader(dr);
                        output.Add(tasktemplatestep);
                    }
                }


            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTaskTemplateStepsWithChecklistsAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);


            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            return output;
        }

        /// <summary>
        /// GetTaskTemplateStepAsync; Get a specific Step with a task template.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="stepId">StepId (DB: tasks_tasktemplatestep.id)</param>
        /// <returns>A step object.</returns>
        public async Task<Step> GetTaskTemplateStepAsync(int companyId, int stepId)
        {
            var step = new Step();

            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));
                parameters.Add(new NpgsqlParameter("@_id", stepId));

                using (dr = await _manager.GetDataReader("get_tasktemplatestep", commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        CreateOrFillStepFromReader(dr, step: step);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTaskTemplateAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            if (step.Id > 0)
            {
                return step;
            }
            return null;
        }
        /// <summary>
        /// GetTaskTemplateStepsByTaskTemplateIdAsync; Get task template steps based on a specific task template id.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="taskTemplateId">TaskTemplateId (DB: tasks_tasktemplate.id)</param>
        /// <returns>A list of task template steps.</returns>
        public async Task<List<Step>> GetTaskTemplateStepsByTaskTemplateIdAsync(int companyId, int taskTemplateId)
        {
            var output = new List<Step>();

            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));
                parameters.Add(new NpgsqlParameter("@_tasktemplateid", taskTemplateId));

                using (dr = await _manager.GetDataReader("get_tasktemplatesteps_by_tasktemplate", commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        var step = CreateOrFillStepFromReader(dr);
                        output.Add(step);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTaskTemplateStepsByTaskTemplateIdAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            return output;
        }
        /// <summary>
        /// AddTaskTemplateStepAsync; Add a task template step to the database.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="step">Step object containing all data for a step.</param>
        /// <returns>possible inserted step id</returns>
        public async Task<int> AddTaskTemplateStepAsync(int companyId, int userId, Step step)
        {
            List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();

            parameters.AddRange(GetNpgsqlParametersFromStep(step: step, companyId: companyId));

            var possibleId = Convert.ToInt32(await _manager.ExecuteScalarAsync("add_tasktemplatestep", parameters: parameters, commandType: CommandType.StoredProcedure));

            if (possibleId > 0)
            {
                var mutated = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.tasks_tasktemplatestep.ToString(), possibleId);
                await _dataAuditing.WriteDataAudit(original: string.Empty, mutated: mutated, Models.Enumerations.TableNames.tasks_tasktemplatestep.ToString(), objectId: possibleId, userId: userId, companyId: companyId, description: "Added tasktemplate step.");
            }

            return possibleId;
        }

        /// <summary>
        /// ChangeTaskTemplateStepAsync; Changes a specific template step.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="stepId">StepId (DB: tasks_tasktemplatestep.id)</param>
        /// <param name="step">Step object containing all data for a step.</param>
        /// <returns>true/false depending on outcome.</returns>
        public async Task<bool> ChangeTaskTemplateStepAsync(int companyId, int userId, int stepId, Step step)
        {
            var original = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.tasks_tasktemplatestep.ToString(), stepId);

            List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();

            parameters.AddRange(GetNpgsqlParametersFromStep(step: step, companyId: companyId, stepId: stepId));

            var rowseffected = await _manager.ExecuteScalarAsync("change_tasktemplatestep", parameters: parameters, commandType: CommandType.StoredProcedure);

            if (Convert.ToInt32(rowseffected) > 0)
            {
                var mutated = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.tasks_tasktemplatestep.ToString(), stepId);
                await _dataAuditing.WriteDataAudit(original: original, mutated: mutated, Models.Enumerations.TableNames.tasks_tasktemplatestep.ToString(), objectId: stepId, userId: userId, companyId: companyId, description: "Changed tasktemplate step.");
            }

            return (Convert.ToInt32(rowseffected) > 0);
        }

        /// <summary>
        /// SetTaskTemplateStepActiveAsync; Set step active/inactive
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="stepId">StepId (DB: tasks_tasktemplatestep.id)</param>
        /// <param name="isActive">true/false</param>
        /// <returns>true/false depending on outcome.</returns>
        public async Task<bool> SetTaskTemplateStepActiveAsync(int companyId, int userId, int stepId, bool isActive = true)
        {
            var original = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.tasks_tasktemplatestep.ToString(), stepId);

            List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
            parameters.Add(new NpgsqlParameter("@_companyid", companyId));
            parameters.Add(new NpgsqlParameter("@_id", stepId));
            parameters.Add(new NpgsqlParameter("@_active", isActive));
            var rowseffected = await _manager.ExecuteScalarAsync("set_tasktemplatestep_active", parameters: parameters, commandType: CommandType.StoredProcedure);

            if (Convert.ToInt32(rowseffected) > 0)
            {
                var mutated = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.tasks_tasktemplatestep.ToString(), stepId);
                await _dataAuditing.WriteDataAudit(original: original, mutated: mutated, Models.Enumerations.TableNames.tasks_tasktemplatestep.ToString(), objectId: stepId, userId: userId, companyId: companyId, description: "Changed tasktemplate step active state.");
            }

            return (Convert.ToInt32(rowseffected) > 0);
        }

        #endregion

        #region - public methods specific Task collections -
        /// <summary>
        /// GetTasksWithAudits; Get Tasks with Audits, depending on input the Tasks collection is filtered on audit id's
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="userId">UserId (DB: profile_user.id)</param>
        /// <param name="include">Include parameter, comma separated string, based on the includes enum. Used for including extra data. </param>
        /// <param name="filters">Filters for filtering a certain set of data.</param> 
        /// <returns>A list of Tasks</returns>
        public async Task<List<TasksTask>> GetTasksWithAuditsAsync(int companyId, List<int> auditIds, int? userId = null, TaskFilters? filters = null, string include = null)
        {
            var output = new List<TasksTask>();

            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));


                if (auditIds != null && auditIds.Count > 0)
                {
                    parameters.Add(new NpgsqlParameter("@_auditids", auditIds));
                }

                if (filters.HasValue)
                {
                    if (filters.Value.Limit.HasValue && filters.Value.Limit.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_limit", filters.Value.Limit.Value));
                    }

                    if (filters.Value.Offset.HasValue && filters.Value.Offset.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_offset", filters.Value.Offset.Value));
                    }

                    if (filters.Value.AreaId.HasValue && filters.Value.AreaId.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_areaid", filters.Value.AreaId.Value));
                    }

                    if (filters.Value.Timestamp.HasValue && filters.Value.Timestamp.Value > DateTime.MinValue)
                    {
                        parameters.Add(new NpgsqlParameter("@_timestamp", filters.Value.Timestamp.Value));
                    }

                    if (filters.Value.StartTimestamp.HasValue && filters.Value.StartTimestamp.Value > DateTime.MinValue)
                    {
                        parameters.Add(new NpgsqlParameter("@_starttimestamp", filters.Value.StartTimestamp.Value));
                    }

                    if (filters.Value.EndTimestamp.HasValue && filters.Value.EndTimestamp.Value > DateTime.MinValue)
                    {
                        parameters.Add(new NpgsqlParameter("@_endtimestamp", filters.Value.EndTimestamp.Value));
                    }

                    if (filters.Value.IsCompleted.HasValue)
                    {
                        parameters.Add(new NpgsqlParameter("@_iscomplete", filters.Value.IsCompleted.Value));
                    }

                    if (filters.Value.AllowedOnly.HasValue && filters.Value.AllowedOnly.Value && userId.HasValue && userId > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_userid", userId.Value));
                    }

                    if (filters.Value.TemplateId.HasValue && filters.Value.TemplateId.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_templateid", filters.Value.TemplateId.Value));
                    }

                    if (filters.Value.TimespanType.HasValue)
                    {
                        parameters.Add(new NpgsqlParameter("@_timespanindays", (int)filters.Value.TimespanType.Value));
                    }
                }

                using (dr = await _manager.GetDataReader("get_tasks_with_audits", commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        var task = CreateOrFillTaskFromReader(dr);
                        output.Add(task);
                    }
                }


            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTasksWithAudits(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);


            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            if (output != null && output.Count > 0)
            {
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertyUserValues.ToString().ToLower()))) output = await AppendPropertyUserValuesToTasks(tasks: output, companyId: companyId, include: include);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.Properties.ToString().ToLower()))) output = await AppendTemplatePropertiesToTasks(tasks: output, companyId: companyId, include: include);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.PictureProof.ToString().ToLower())) output = await AppendPictureProof(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Tags.ToString().ToLower())) output = await AppendTagsToTasksAsync(tasks: output, companyId: companyId);
            }

            return output;
        }

        /// <summary>
        /// GetTasksWithAudits; Get Tasks with Checklists, depending on input the Tasks collection is filtered on checklist id's
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="userId">UserId (DB: profile_user.id)</param>
        /// <param name="include">Include parameter, comma separated string, based on the includes enum. Used for including extra data. </param>
        /// <param name="filters">Filters for filtering a certain set of data.</param> 
        /// <returns>A list of Tasks</returns>
        public async Task<List<TasksTask>> GetTasksWithChecklistsAsync(int companyId, List<int> checklistIds, List<int> checklistTemplateIds, int? userId = null, TaskFilters? filters = null, string include = null, ConnectionKind connectionKind = ConnectionKind.Reader)
        {
            var output = new List<TasksTask>();

            NpgsqlDataReader dr = null;


            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));

                if (checklistIds != null && checklistIds.Count > 0)
                {
                    parameters.Add(new NpgsqlParameter("@_checklistids", checklistIds));
                }

                if (filters.HasValue)
                {
                    if (filters.Value.Limit.HasValue && filters.Value.Limit.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_limit", filters.Value.Limit.Value));
                    }

                    if (filters.Value.Offset.HasValue && filters.Value.Offset.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_offset", filters.Value.Offset.Value));
                    }

                    if (filters.Value.AreaId.HasValue && filters.Value.AreaId.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_areaid", filters.Value.AreaId.Value));
                    }

                    if (filters.Value.Timestamp.HasValue && filters.Value.Timestamp.Value > DateTime.MinValue)
                    {
                        parameters.Add(new NpgsqlParameter("@_timestamp", filters.Value.Timestamp.Value));
                    }


                    if (filters.Value.StartTimestamp.HasValue && filters.Value.StartTimestamp.Value > DateTime.MinValue)
                    {
                        parameters.Add(new NpgsqlParameter("@_starttimestamp", filters.Value.StartTimestamp.Value));
                    }

                    if (filters.Value.EndTimestamp.HasValue && filters.Value.EndTimestamp.Value > DateTime.MinValue)
                    {
                        parameters.Add(new NpgsqlParameter("@_endtimestamp", filters.Value.EndTimestamp.Value));
                    }

                    if (filters.Value.IsCompleted.HasValue)
                    {
                        parameters.Add(new NpgsqlParameter("@_iscomplete", filters.Value.IsCompleted.Value));
                    }

                    if (filters.Value.AllowedOnly.HasValue && filters.Value.AllowedOnly.Value && userId.HasValue && userId > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_userid", userId.Value));
                    }

                    if (filters.Value.TemplateId.HasValue && filters.Value.TemplateId.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_templateid", filters.Value.TemplateId.Value));
                    }

                    if (filters.Value.TimespanType.HasValue)
                    {
                        parameters.Add(new NpgsqlParameter("@_timespanindays", (int)filters.Value.TimespanType.Value));
                    }
                }

                using (dr = await _manager.GetDataReader("get_tasks_with_checklists", commandType: CommandType.StoredProcedure, parameters: parameters, connectionKind: connectionKind))
                {
                    while (await dr.ReadAsync())
                    {
                        var task = CreateOrFillTaskFromReader(dr);
                        output.Add(task);
                    }
                }


            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTasksWithChecklists(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);


            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            if (output != null && output.Count > 0)
            {
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Steps.ToString().ToLower())) output = await AppendStepsTaskAsync(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.AreaPaths.ToString().ToLower())) output = await AppendAreaPathsToTasksAsync(tasks: output, companyId: companyId, addAreaPath: include.Split(",").Contains(IncludesEnum.AreaPaths.ToString().ToLower()), addAreaPathIds: include.Split(",").Contains(IncludesEnum.AreaPathIds.ToString().ToLower()));
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.PropertyUserValues.ToString().ToLower())) output = await AppendPropertyUserValuesToTasks(tasks: output, companyId: companyId, include: include);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertyValues.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.Properties.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.PropertyDetails.ToString().ToLower()))) output = await AppendTemplatePropertiesToTasks(tasks: output, companyId: companyId, include: include);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.InstructionRelations.ToString().ToLower())) output = await AppendWorkInstructionRelations(tasks: output, companyId: companyId, checklistTemplateIds: checklistTemplateIds);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.PictureProof.ToString().ToLower())) output = await AppendPictureProof(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Tags.ToString().ToLower())) output = await AppendTagsToTasksAsync(tasks: output, companyId: companyId, fromTemplates: true);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.UserInformation.ToString().ToLower()))) output = await AppendUserInformationToTasksAsync(tasks: output, companyId: companyId);
            }

            return output;
        }
        #endregion

        #region - public methods specific TaskTemplate collections -
        /// <summary>
        /// GetTasksTemplatesWithAuditTemplatesAsync; Get TaskTemplates with AuditTemplates, depending on input the Tasks collection is filtered on AuditTemplate id's
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="userId">UserId (DB: profile_user.id)</param>
        /// <param name="filters">Filters for filtering a certain set of data.</param> 
        /// <returns>A list of TaskTemplate</returns>
        public async Task<List<TaskTemplate>> GetTasksTemplatesWithAuditTemplatesAsync(int companyId, int? userId = null, TaskFilters? filters = null, string include = null)
        {
            var output = new List<TaskTemplate>();

            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));

                if (filters.HasValue)
                {
                    if (filters.Value.Limit.HasValue && filters.Value.Limit.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_limit", filters.Value.Limit.Value));
                    }

                    if (filters.Value.Offset.HasValue && filters.Value.Offset.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_offset", filters.Value.Offset.Value));
                    }

                    if (filters.Value.AreaId.HasValue && filters.Value.AreaId.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_areaid", filters.Value.AreaId.Value));
                    }

                    if (filters.Value.Timestamp.HasValue && filters.Value.Timestamp.Value > DateTime.MinValue)
                    {
                        parameters.Add(new NpgsqlParameter("@_timestamp", filters.Value.Timestamp.Value));
                    }

                    if (filters.Value.AllowedOnly.HasValue && filters.Value.AllowedOnly.Value && userId.HasValue && userId > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_userid", userId.Value));
                    }
                }

                using (dr = await _manager.GetDataReader("get_tasktemplates_with_audittemplates", commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        var task = CreateOrFillTaskTemplateFromReader(dr);
                        output.Add(task);
                    }
                }


            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTasksTemplatesWithAuditTemplates(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            if (output.Count > 0)
            {
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Tags.ToString().ToLower())) output = await AppendTagsToTaskTemplatesAsync(taskTemplates: output, companyId: companyId);
            }

            return output;
        }

        /// <summary>
        /// GetTasksTemplatesWithAuditTemplatesAsync; Get TaskTemplates with AuditTemplates, depending on input the Tasks collection is filtered on AuditTemplate id's
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="userId">UserId (DB: profile_user.id)</param>
        /// <param name="filters">Filters for filtering a certain set of data.</param> 
        /// <returns>A list of TaskTemplate</returns>
        public async Task<List<TaskTemplate>> GetTasksTemplatesWithAuditTemplatesAsync(int companyId, List<int> auditIds = null, int? userId = null, TaskFilters? filters = null, string include = null)
        {
            var output = new List<TaskTemplate>();

            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));

                if (auditIds != null && auditIds.Count > 0)
                {
                    parameters.Add(new NpgsqlParameter("@_auditids", auditIds));
                }
                else
                {
                    parameters.Add(new NpgsqlParameter("@_auditids", DBNull.Value));
                }

                if (filters.HasValue)
                {
                    if (filters.Value.Limit.HasValue && filters.Value.Limit.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_limit", filters.Value.Limit.Value));
                    }

                    if (filters.Value.Offset.HasValue && filters.Value.Offset.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_offset", filters.Value.Offset.Value));
                    }

                    if (filters.Value.AreaId.HasValue && filters.Value.AreaId.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_areaid", filters.Value.AreaId.Value));
                    }

                    if (filters.Value.Timestamp.HasValue && filters.Value.Timestamp.Value > DateTime.MinValue)
                    {
                        parameters.Add(new NpgsqlParameter("@_timestamp", filters.Value.Timestamp.Value));
                    }

                    if (filters.Value.AllowedOnly.HasValue && filters.Value.AllowedOnly.Value && userId.HasValue && userId > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_userid", userId.Value));
                    }
                }

                using (dr = await _manager.GetDataReader("get_tasktemplates_with_audittemplates", commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        var task = CreateOrFillTaskTemplateFromReader(dr);
                        output.Add(task);
                    }
                }


            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTasksTemplatesWithAuditTemplates(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            if (output.Count > 0)
            {
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Tags.ToString().ToLower())) output = await AppendTagsToTaskTemplatesAsync(taskTemplates: output, companyId: companyId);
            }

            return output;
        }

        /// <summary>
        /// GetTasksTemplatesWithChecklistTemplatesAsync; Get TaskTemplates with ChecklistTemplates, depending on input the Tasks collection is filtered on ChecklistTemplate id's
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="userId">UserId (DB: profile_user.id)</param>
        /// <param name="filters">Filters for filtering a certain set of data.</param> 
        /// <returns>A list of TaskTemplates</returns>
        public async Task<List<TaskTemplate>> GetTasksTemplatesWithChecklistTemplatesAsync(int companyId, int? userId = null, TaskFilters? filters = null, string include = null)
        {
            var output = new List<TaskTemplate>();

            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));

                if (filters.HasValue)
                {
                    if (filters.Value.Limit.HasValue && filters.Value.Limit.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_limit", filters.Value.Limit.Value));
                    }

                    if (filters.Value.Offset.HasValue && filters.Value.Offset.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_offset", filters.Value.Offset.Value));
                    }

                    if (filters.Value.AreaId.HasValue && filters.Value.AreaId.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_areaid", filters.Value.AreaId.Value));
                    }

                    if (filters.Value.Timestamp.HasValue && filters.Value.Timestamp.Value > DateTime.MinValue)
                    {
                        parameters.Add(new NpgsqlParameter("@_timestamp", filters.Value.Timestamp.Value));
                    }

                    if (filters.Value.AllowedOnly.HasValue && filters.Value.AllowedOnly.Value && userId.HasValue && userId > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_userid", userId.Value));
                    }
                }

                using (dr = await _manager.GetDataReader("get_tasktemplates_with_checklisttemplates", commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        var task = CreateOrFillTaskTemplateFromReader(dr);
                        output.Add(task);
                    }
                }


            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTasksTemplatesWithChecklistTemplates(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);


            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            if (output.Count > 0)
            {
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Tags.ToString().ToLower())) output = await AppendTagsToTaskTemplatesAsync(taskTemplates: output, companyId: companyId);
            }

            return output;
        }

        /// <summary>
        /// GetTasksTemplatesWithChecklistTemplatesAsync; Get TaskTemplates with ChecklistTemplates, depending on input the Tasks collection is filtered on ChecklistTemplate id's
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="userId">UserId (DB: profile_user.id)</param>
        /// <param name="filters">Filters for filtering a certain set of data.</param> 
        /// <returns>A list of TaskTemplates</returns>
        public async Task<List<TaskTemplate>> GetTasksTemplatesWithChecklistTemplatesAsync(int companyId, List<int> checklistIds, int? userId = null, TaskFilters? filters = null, string include = null)
        {
            var output = new List<TaskTemplate>();

            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));

                if (checklistIds != null && checklistIds.Count > 0)
                {
                    parameters.Add(new NpgsqlParameter("@_checklistids", checklistIds));
                }
                else
                {
                    parameters.Add(new NpgsqlParameter("@_checklistids", DBNull.Value));
                }

                if (filters.HasValue)
                {
                    if (filters.Value.Limit.HasValue && filters.Value.Limit.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_limit", filters.Value.Limit.Value));
                    }

                    if (filters.Value.Offset.HasValue && filters.Value.Offset.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_offset", filters.Value.Offset.Value));
                    }

                    if (filters.Value.AreaId.HasValue && filters.Value.AreaId.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_areaid", filters.Value.AreaId.Value));
                    }

                    if (filters.Value.Timestamp.HasValue && filters.Value.Timestamp.Value > DateTime.MinValue)
                    {
                        parameters.Add(new NpgsqlParameter("@_timestamp", filters.Value.Timestamp.Value));
                    }

                    if (filters.Value.AllowedOnly.HasValue && filters.Value.AllowedOnly.Value && userId.HasValue && userId > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_userid", userId.Value));
                    }
                }

                using (dr = await _manager.GetDataReader("get_tasktemplates_with_checklisttemplates", commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        var task = CreateOrFillTaskTemplateFromReader(dr);
                        output.Add(task);
                    }
                }


            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTasksTemplatesWithChecklistTemplates(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);


            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            if (output.Count > 0)
            {
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Tags.ToString().ToLower())) output = await AppendTagsToTaskTemplatesAsync(taskTemplates: output, companyId: companyId);
            }

            return output;
        }

        /// <summary>
        /// SetTemplateIndices; Set template index.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="userId">UserId (DB: profiles_user.id)</param>
        /// <param name="templateIndices">Template index items (position)</param>
        /// <returns>true/false depending on outcome</returns>
        public async Task<bool> SetTemplateIndices(int companyId, int userId, List<IndexItem> templateIndices)
        {
            if (templateIndices != null && templateIndices.Count > 0)
            {
                foreach (var item in templateIndices)
                {
                    var parameters = new List<NpgsqlParameter>();
                    parameters.Add(new NpgsqlParameter("@_companyid", companyId));
                    parameters.Add(new NpgsqlParameter("@_index", item.Index));
                    parameters.Add(new NpgsqlParameter("@_id", item.Id));

                    var output = await _manager.ExecuteScalarAsync("set_tasktemplate_index", parameters);
                }

                return true;
            }
            return false;
        }
        #endregion

        #region - private methods Filter Tasks -
        /// <summary>
        /// FilterTasks; FilterTasks is the primary filter method for filtering tasks, within this method the specific filters are determined based on the supplied TaskFilters object.
        /// Filtering is done based on cascading filters, meaning, the first filter is applied, which results in a filtered collection.
        /// On that filtered collection the second filter is applied which results in a filtered-filtered collection.
        /// This will continue until all filters are applied.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="filters">TaskFilters, depending on the values certain filters will be applies.</param>
        /// <param name="nonFilteredCollection">List of non filtered Tasks objects.</param>
        /// <returns>A filtered list of Tasks objects.</returns>
        private async Task<IList<TasksTask>> FilterTasks(int companyId, TaskFilters filters, IList<TasksTask> nonFilteredCollection, int? userId = null)
        {
            var filtered = nonFilteredCollection;
            if (filters.RecurrencyType.HasValue)
            {
                filtered = await FilterTasksOnRecurrencyType(recurrencyType: filters.RecurrencyType.Value, tasks: filtered);
            }

            if (filters.RecurrencyId.HasValue)
            {
                filtered = await FilterTasksOnRecurrency(recurrencyId: filters.RecurrencyId.Value, tasks: filtered);
            }
            if (filters.TemplateId.HasValue)
            {
                filtered = await FilterTasksOnTemplate(templateId: filters.TemplateId.Value, tasks: filtered);
            }
            if (filters.ShiftId.HasValue)
            {
                filtered = await FilterTasksOnShift(shiftId: filters.ShiftId.Value, tasks: filtered);
            }
            if (filters.Status.HasValue)
            {
                filtered = await FilterTasksOnStatus(status: filters.Status.Value, tasks: filtered);
            }
            if (filters.IsCompleted.HasValue)
            {
                filtered = await FilterTasksIsCompleted(isCompleted: filters.IsCompleted.Value, tasks: filtered);
            }

            return filtered;
        }

        /// <summary>
        /// FilterTasks; FilterTasks is the primary filter method for filtering tasks, within this method the specific filters are determined based on the supplied TaskFilters object.
        /// Filtering is done based on cascading filters, meaning, the first filter is applied, which results in a filtered collection.
        /// On that filtered collection the second filter is applied which results in a filtered-filtered collection.
        /// This will continue until all filters are applied.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="filters">TaskFilters, depending on the values certain filters will be applies.</param>
        /// <param name="nonFilteredCollection">List of non filtered Tasks objects.</param>
        /// <returns>A filtered list of Tasks objects.</returns>
        private async Task<IList<TasksTask>> FilterTasksOther(int companyId, TaskFilters filters, IList<TasksTask> nonFilteredCollection, int? userId = null)
        {
            var filtered = nonFilteredCollection;
            if (filters.AreaId.HasValue)
            {
                if (filters.FilterAreaType.HasValue)
                {
                    filtered = await FilterTasksOnArea(companyId: companyId, areaId: filters.AreaId.Value, filterType: filters.FilterAreaType.Value, tasks: filtered);
                }
                else
                {
                    filtered = await FilterTasksOnArea(areaId: filters.AreaId.Value, tasks: filtered);
                }
            }

            if (filters.RecurrencyType.HasValue)
            {
                filtered = await FilterTasksOnRecurrencyType(recurrencyType: filters.RecurrencyType.Value, tasks: filtered);
            }

            if (filters.RecurrencyId.HasValue)
            {
                filtered = await FilterTasksOnRecurrency(recurrencyId: filters.RecurrencyId.Value, tasks: filtered);
            }
            if (filters.TemplateId.HasValue)
            {
                filtered = await FilterTasksOnTemplate(templateId: filters.TemplateId.Value, tasks: filtered);
            }
            if (filters.ShiftId.HasValue)
            {
                filtered = await FilterTasksOnShift(shiftId: filters.ShiftId.Value, tasks: filtered);
            }
            if (filters.Status.HasValue)
            {
                filtered = await FilterTasksOnStatus(status: filters.Status.Value, tasks: filtered);
            }
            if (filters.IsCompleted.HasValue)
            {
                filtered = await FilterTasksIsCompleted(isCompleted: filters.IsCompleted.Value, tasks: filtered);
            }
            if (filters.AllowedOnly.HasValue && filters.AllowedOnly.Value)
            {
                filtered = await FilterTasksAllowedOnly(companyId: companyId, userId: userId.Value, tasks: filtered);
            }
            if (filters.Limit.HasValue && filtered.Count > filters.Limit && filters.Limit != 0)
            {
                filtered = filtered.Take(filters.Limit.Value).ToList();
            }

            return filtered;
        }

        /// <summary>
        /// FilterOverdueTasks; filters for overdue specific.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="filters">TaskFilters, depending on the values certain filters will be applies.</param>
        /// <param name="nonFilteredCollection">List of non filtered Tasks objects.</param>
        /// <param name="userId">UserId (DB: profiles_user.id)</param>
        /// <returns></returns>
        private async Task<IList<TasksTask>> FilterOverdueTasks(int companyId, TaskFilters filters, IList<TasksTask> nonFilteredCollection, int? userId = null)
        {
            var filtered = nonFilteredCollection;

            if (filters.RecurrencyType.HasValue)
            {
                filtered = await FilterTasksOnRecurrencyType(recurrencyType: filters.RecurrencyType.Value, tasks: filtered);
            }

            if (filters.RecurrencyId.HasValue)
            {
                filtered = await FilterTasksOnRecurrency(recurrencyId: filters.RecurrencyId.Value, tasks: filtered);
            }
            if (filters.TemplateId.HasValue)
            {
                filtered = await FilterTasksOnTemplate(templateId: filters.TemplateId.Value, tasks: filtered);
            }
            if (filters.ShiftId.HasValue)
            {
                filtered = await FilterTasksOnShift(shiftId: filters.ShiftId.Value, tasks: filtered);
            }
            if (filters.Status.HasValue)
            {
                filtered = await FilterTasksOnStatus(status: filters.Status.Value, tasks: filtered);
            }
            if (filters.IsCompleted.HasValue)
            {
                filtered = await FilterTasksIsCompleted(isCompleted: filters.IsCompleted.Value, tasks: filtered);
            }
            if (filters.Limit.HasValue && filtered.Count > filters.Limit && filters.Limit != 0)
            {
                filtered = filtered.Take(filters.Limit.Value).ToList();
            }

            return filtered;
        }

        /// <summary>
        /// FilterTasksOnArea; Filter a Tasks collection on AreaId and a FilterAreaType. Depending on type a recursive filter is being used based on the children of a Area.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="areaId">AreaId ( DB: tasks_tasktemplate.area_id)</param>
        /// <param name="filterType">FilterAreaTypeEnum, type based on Single, RootToLeaf and LeafToRoot filtering.</param>
        /// <param name="tasks">Collection of items to be filtered.</param>
        /// <returns>A filtered list of Tasks objects.</returns>
        private async Task<IList<TasksTask>> FilterTasksOnArea(int companyId, int areaId, FilterAreaTypeEnum filterType, IList<TasksTask> tasks)
        {
            var areas = await _areaBasicManager.GetAreasBasicByStartAreaAsync(companyId: companyId, areaId: areaId, areaFilterType: filterType);
            if (areas == null || areas.Count == 0)
            {
                areas.Add(new Models.Basic.AreaBasic() { Id = areaId, Name = "" });
            }
            tasks = tasks.Where(x => x.AreaId.HasValue && areas.Select(a => a.Id).Contains(x.AreaId.Value)).ToList();
            await Task.CompletedTask;
            return tasks;
        }

        /// <summary>
        /// FilterTasksOnArea; Filter a Tasks collection on AreaId.
        /// </summary>
        /// <param name="areaId">AreaId ( DB: tasks_tasktemplate.area_id)</param>
        /// <param name="tasks">Collection of items to be filtered.</param>
        /// <returns>A filtered list of Tasks objects.</returns>
        private async Task<IList<TasksTask>> FilterTasksOnArea(int areaId, IList<TasksTask> tasks)
        {

            tasks = tasks.Where(x => x.AreaId == areaId).ToList();
            await Task.CompletedTask; //used for making method async executable.
            return tasks;
        }

        /// <summary>
        /// FilterTasksOnShift; Filter a Tasks collection on ShiftId.
        /// </summary>
        /// <param name="shiftId">ShiftId ( DB: tasks_task.shift_id)</param>
        /// <param name="tasks">Collection of items to be filtered.</param>
        /// <returns>A filtered set of items.</returns>
        private async Task<IList<TasksTask>> FilterTasksOnShift(int shiftId, IList<TasksTask> tasks)
        {

            tasks = tasks.Where(x => x.ShiftId == shiftId).ToList();
            await Task.CompletedTask; //used for making method async executable.
            return tasks;
        }

        /// <summary>
        /// FilterTasksOnTemplate;
        /// </summary>
        /// <param name="templateId"></param>
        /// <param name="tasks">Collection of items to be filtered.</param>
        /// <returns>A filtered list of Tasks objects.</returns>
        private async Task<IList<TasksTask>> FilterTasksOnTemplate(int templateId, IList<TasksTask> tasks)
        {

            tasks = tasks.Where(x => x.TemplateId == templateId).ToList();
            await Task.CompletedTask; //used for making method async executable.
            return tasks;
        }

        /// <summary>
        /// FilterTasksOnRecurrency; Filters Task on RecurrencyId (TaskRecurrency.Id)
        /// </summary>
        /// <param name="recurrencyId">RecurrencyId of a Task</param>
        /// <param name="tasks">Collection of items to be filtered.</param>
        /// <returns>A filtered list of Tasks objects.</returns>
        private async Task<IList<TasksTask>> FilterTasksOnRecurrency(int recurrencyId, IList<TasksTask> tasks)
        {

            tasks = tasks.Where(x => x.RecurrencyId == recurrencyId).ToList();
            await Task.CompletedTask; //used for making method async executable.
            return tasks;
        }

        /// <summary>
        /// FilterTasksOnStatus; Filters Tasks based on the TaskStatusEnum enumerator.
        /// </summary>
        /// <param name="status">Status based on TaskStatusEnum</param>
        /// <param name="tasks">Collection of items to be filtered.</param>
        /// <returns>A filtered list of Tasks objects.</returns>
        private async Task<IList<TasksTask>> FilterTasksOnStatus(TaskStatusEnum status, IList<TasksTask> tasks)
        {
            tasks = tasks.Where(x => x.Status == status.ToString().ToLower()).ToList();
            await Task.CompletedTask; //used for making method async executable.
            return tasks;
        }

        /// <summary>
        /// FilterTasksOnRecurrencyType; Filter a Tasks collection on RecurrencyType (enum)
        /// </summary>
        /// <param name="recurrencyType">RecurrencyType (based on enum); Week, Month, Shifts, No Occurance</param>
        /// <param name="tasks"></param>
        /// <returns></returns>
        private async Task<IList<TasksTask>> FilterTasksOnRecurrencyType(RecurrencyTypeEnum recurrencyType, IList<TasksTask> tasks)
        {
            tasks = tasks.Where(x => x.RecurrencyType == recurrencyType.ToString().ToLower()).ToList();
            await Task.CompletedTask; //used for making method async executable.
            return tasks;
        }

        /// <summary>
        /// FilterTasksAllowedOnly; Filter a checklist collection based on the audits where a user should have access to.
        /// </summary>
        /// <param name="companyId">CompanyId of user (DB: companies.id)</param>
        /// <param name="userId">UserId of user (DB: profiles_user.id)</param>
        /// <param name="tasks"></param>
        /// <returns>A filtered set of items.</returns>
        private async Task<IList<TasksTask>> FilterTasksAllowedOnly(int companyId, int userId, IList<TasksTask> tasks)
        {
            var allowedTemplates = await _userAccessManager.GetAllowedTaskTemplateIdsWithUserAsync(companyId: companyId, userId: userId);

            tasks = tasks.Where(x => allowedTemplates.Contains(x.TemplateId)).ToList();

            await Task.CompletedTask; //used for making method async executable.

            return tasks;
        }

        /// <summary>
        /// FilterTasksIsCompleted; Filter completed items from tasks (or not completed items if false)
        /// </summary>
        private async Task<IList<TasksTask>> FilterTasksIsCompleted(bool isCompleted, IList<TasksTask> tasks)
        {
            tasks = tasks.Where(x => isCompleted ? x.Status != "todo" : x.Status == "todo").ToList();

            await Task.CompletedTask; //used for making method async executable.

            return tasks;
        }
        #endregion

        #region - private methods Filter TaskTemplates -
        /// <summary>
        /// FilterTemplates; FilterTemplates is the primary filter method for filtering templates, within this method the specific filters are determined based on the supplied TaskFilters object.
        /// Filtering is done based on cascading filters, meaning, the first filter is applied, which results in a filtered collection.
        /// On that filtered collection the second filter is applied which results in a filtered-filtered collection.
        /// This will continue until all filters are applied.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="filters">TaskFilters, depending on the values certain filters will be applies.</param>
        /// <param name="nonFilteredCollection">List of non filtered TaskTemplate objects.</param>
        /// <returns>A filtered list of TaskTemplate objects.</returns>
        private async Task<IList<TaskTemplate>> FilterTemplates(int companyId, TaskFilters filters, IList<TaskTemplate> nonFilteredCollection, int? userId = null)
        {
            var filtered = nonFilteredCollection;

            if (filters.Role.HasValue)
            {
                filtered = await FilterTemplatesOnRole(role: filters.Role.Value, templates: filtered);
            }
            if (filters.TaskType.HasValue)
            {
                filtered = await FilterTemplatesOnTaskType(taskType: filters.TaskType.Value, templates: filtered);
            }
            if (filters.RecurrencyType.HasValue)
            {
                filtered = await FilterTemplatesOnRecurrencyType(recurrencyType: filters.RecurrencyType.Value, templates: filtered);
            }

            return filtered;
        }

        /// <summary>
        /// FilterTemplatesOnArea; Filter a TaskTemplate collection on AreaId.
        /// </summary>
        /// <param name="areaId">AreaId ( DB: tasks_tasktemplate.area_id)</param>
        /// <param name="templates">Collection of items to be filtered.</param>
        /// <returns>A filtered set of items.</returns>
        private async Task<IList<TaskTemplate>> FilterTemplatesOnArea(int areaId, IList<TaskTemplate> templates)
        {

            templates = templates.Where(x => x.AreaId == areaId).ToList();
            await Task.CompletedTask; //used for making method async executable.
            return templates;
        }

        /// <summary>
        /// FilterTemplatesOnArea; Filter a TaskTemplate collection on AreaId and a FilterAreaType. Depending on type a recursive filter is being used based on the children of a Area.
        /// </summary>
        /// <param name="areaId">AreaId ( DB: tasks_tasktemplate.area_id)</param>
        /// <param name="filterType">FilterAreaTypeEnum, type based on Single, RootToLeaf and LeafToRoot filtering.</param>
        /// <param name="templates">Collection of items to be filtered.</param>
        /// <returns>A filtered set of items.</returns>
        private async Task<IList<TaskTemplate>> FilterTemplatesOnArea(int companyId, int areaId, FilterAreaTypeEnum filterType, IList<TaskTemplate> templates)
        {
            var areas = await _areaBasicManager.GetAreasBasicByStartAreaAsync(companyId: companyId, areaId: areaId, areaFilterType: filterType);
            if (areas == null || areas.Count == 0)
            {
                areas.Add(new Models.Basic.AreaBasic() { Id = areaId, Name = "" });
            }
            //get data
            templates = templates.Where(x => x.AreaId.HasValue && areas.Select(a => a.Id).Contains(x.AreaId.Value)).ToList();
            await Task.CompletedTask;
            return templates;
            // return nonFilteredCollection;
        }

        /// <summary>
        /// FilterTemplatesOnRole; Filter a TaskTemplate collection on Role.
        /// </summary>
        /// <param name="role">Role ( DB: tasks_tasktemplate.role)</param>
        /// <param name="templates">Collection of items to be filtered.</param>
        /// <returns>A filtered set of items.</returns>
        private async Task<IList<TaskTemplate>> FilterTemplatesOnRole(RoleTypeEnum role, IList<TaskTemplate> templates)
        {

            templates = templates.Where(x => x.Role == role.ToString().ToLower()).ToList();
            await Task.CompletedTask; //used for making method async executable.
            return templates;
        }

        /// <summary>
        /// FilterTemplatesOnTaskType; Filter a TaskTemplate collection on TaskType.
        /// </summary>
        /// <param name="taskType">TaskType ( DB: tasks_tasktemplate.type)</param>
        /// <param name="templates">Collection of items to be filtered.</param>
        /// <returns>A filtered set of items.</returns>
        private async Task<IList<TaskTemplate>> FilterTemplatesOnTaskType(TaskTypeEnum taskType, IList<TaskTemplate> templates)
        {
            templates = templates.Where(x => x.Type == taskType.ToString().ToLower()).ToList();
            await Task.CompletedTask; //used for making method async executable.
            return templates;
        }

        /// <summary>
        /// FilterTemplatesOnRecurrencyType; Filter a TaskTemplate on a recurrencytype.
        /// </summary>
        /// <param name="taskType">TaskType ( DB: tasks_tasktemplate.type)</param>
        /// <param name="templates">Collection of items to be filtered.</param>
        /// <returns>A filtered set of items.</returns>
        private async Task<IList<TaskTemplate>> FilterTemplatesOnRecurrencyType(RecurrencyTypeEnum recurrencyType, IList<TaskTemplate> templates)
        {
            templates = templates.Where(x => x.RecurrencyType == recurrencyType.ToDatabaseString()).ToList();
            await Task.CompletedTask; //used for making method async executable.
            return templates;
        }

        #endregion

        #region - private methods Filter TaskRecurrencies -
        /// <summary>
        /// FilterRecurrencies; FilterRecurrencies is the primary filter method for filtering recurrencies, within this method the specific filters are determined based on the supplied TaskFilters object.
        /// Filtering is done based on cascading filters, meaning, the first filter is applied, which results in a filtered collection.
        /// On that filtered collection the second filter is applied which results in a filtered-filtered collection.
        /// This will continue until all filters are applied.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="filters">TaskFilters, depending on the values certain filters will be applies.</param>
        /// <param name="nonFilteredCollection">List of non filtered TaskRecurrency objects.</param>
        /// <returns>A filtered list of TaskRecurrency objects.</returns>
        private async Task<IList<TaskRecurrency>> FilterRecurrencies(int companyId, TaskFilters filters, IList<TaskRecurrency> nonFilteredCollection)
        {
            var filtered = nonFilteredCollection;
            if (filters.AreaId.HasValue)
            {
                if (filters.FilterAreaType.HasValue)
                {
                    filtered = await FilterRecurrenciesOnArea(companyId: companyId, areaId: filters.AreaId.Value, filterType: filters.FilterAreaType.Value, recurrencies: filtered);
                }
                else
                {
                    filtered = await FilterRecurrenciesOnArea(areaId: filters.AreaId.Value, recurrencies: filtered);
                }
            }
            if (filters.MonthRecurrencyType.HasValue)
            {
                filtered = await FilterRecurrenciesOnMonthRecurrencyType(monthRecurrencyType: filters.MonthRecurrencyType.Value, recurrencies: filtered);
            }
            if (filters.RecurrencyType.HasValue)
            {
                filtered = await FilterRecurrenciesOnRecurrencyType(recurrencyType: filters.RecurrencyType.Value, recurrencies: filtered);
            }
            if (filters.TemplateId.HasValue)
            {
                filtered = await FilterRecurrenciesOnTemplateId(templateId: filters.TemplateId.Value, recurrencies: filtered);
            }
            if (filters.ShiftId.HasValue)
            {
                filtered = await FilterRecurrenciesOnShiftId(shiftId: filters.ShiftId.Value, recurrencies: filtered);
            }
            if (filters.Weekdays != null && filters.Weekdays.Count > 0)
            {
                filtered = await FilterRecurrenciesOnWeekdays(weekdays: filters.Weekdays, recurrencies: filtered);
            }
            if (filters.Limit.HasValue && filtered.Count > filters.Limit && filters.Limit != 0)
            {
                filtered = filtered.Take(filters.Limit.Value).ToList();
            }
            return filtered;
        }

        /// <summary>
        /// FilterRecurrenciesOnArea; Filter a TaskRecurrency collection on AreaId.
        /// </summary>
        /// <param name="areaId">AreaId ( DB: tasks_taskrecurrency.area_id)</param>
        /// <param name="recurrencies">Collection of items to be filtered.</param>
        /// <returns>A filtered set of items.</returns>
        private async Task<IList<TaskRecurrency>> FilterRecurrenciesOnArea(int areaId, IList<TaskRecurrency> recurrencies)
        {

            recurrencies = recurrencies.Where(x => x.AreaId == areaId).ToList();
            await Task.CompletedTask; //used for making method async executable.
            return recurrencies;
        }

        /// <summary>
        /// FilterRecurrenciesOnArea; Filter a TaskRecurrency collection on AreaId and a FilterAreaType. Depending on type a recursive filter is being used based on the children of a Area.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="areaId">AreaId ( DB: tasks_taskrecurrency.area_id)</param>
        /// <param name="filterType">FilterAreaTypeEnum, type based on Single, RootToLeaf and LeafToRoot filtering.</param>
        /// <param name="recurrencies">Collection of items to be filtered.</param>
        /// <returns>A filtered set of items.</returns>
        private async Task<IList<TaskRecurrency>> FilterRecurrenciesOnArea(int companyId, int areaId, FilterAreaTypeEnum filterType, IList<TaskRecurrency> recurrencies)
        {
            var areas = await _areaBasicManager.GetAreasBasicByStartAreaAsync(companyId: companyId, areaId: areaId, areaFilterType: filterType);
            if (areas == null || areas.Count == 0)
            {
                areas.Add(new Models.Basic.AreaBasic() { Id = areaId, Name = "" });
            }
            //get data
            recurrencies = recurrencies.Where(x => areas.Select(a => a.Id).Contains(x.AreaId)).ToList();
            await Task.CompletedTask;
            return recurrencies;
        }

        /// <summary>
        /// FilterRecurrenciesOnShiftId; Filter a TaskRecurrency collection on ShiftsId.
        /// </summary>
        /// <param name="shiftId">ShiftId ( DB: tasks_taskrecurrency.shift_id)</param>
        /// <param name="recurrencies">Collection of items to be filtered.</param>
        /// <returns>A filtered set of items.</returns>
        private async Task<IList<TaskRecurrency>> FilterRecurrenciesOnShiftId(int shiftId, IList<TaskRecurrency> recurrencies)
        {
            recurrencies = recurrencies.Where(x => x.ShiftId == shiftId).ToList();
            await Task.CompletedTask; //make method execute in async flow.
            return recurrencies;
        }

        /// <summary>
        /// FilterRecurrenciesOnTemplateId; Filter a TaskRecurrency collection on TemplateId.
        /// </summary>
        /// <param name="templateId">TemplateId ( DB: tasks_taskrecurrency.template_id)</param>
        /// <param name="recurrencies">Collection of items to be filtered.</param>
        /// <returns>A filtered set of items.</returns>
        private async Task<IList<TaskRecurrency>> FilterRecurrenciesOnTemplateId(int templateId, IList<TaskRecurrency> recurrencies)
        {
            recurrencies = recurrencies.Where(x => x.TemplateId == templateId).ToList();
            await Task.CompletedTask; //make method execute in async flow.
            return recurrencies;
        }

        /// <summary>
        /// FilterRecurrenciesOnRecurrencyType; Filter a TaskRecurrency collection on RecurrencyType.
        /// </summary>
        /// <param name="recurrencyType">RecurrencyType ( DB: tasks_taskrecurrency.type)</param>
        /// <param name="recurrencies">Collection of items to be filtered.</param>
        /// <returns>A filtered set of items.</returns>
        private async Task<IList<TaskRecurrency>> FilterRecurrenciesOnRecurrencyType(RecurrencyTypeEnum recurrencyType, IList<TaskRecurrency> recurrencies)
        {
            recurrencies = recurrencies.Where(x => x.RecurrencyType == recurrencyType.ToString().ToLower()).ToList();
            await Task.CompletedTask; //make method execute in async flow.
            return recurrencies;
        }

        /// <summary>
        /// FilterRecurrenciesOnMonthRecurrencyType; Filter a TaskRecurrency collection on MonthRecurrencyType.
        /// </summary>
        /// <param name="monthRecurrencyType">MonthRecurrencyType ( DB: tasks_taskrecurrency.month_recurrency)</param>
        /// <param name="recurrencies">Collection of items to be filtered.</param>
        /// <returns>A filtered set of items.</returns>
        private async Task<IList<TaskRecurrency>> FilterRecurrenciesOnMonthRecurrencyType(MonthRecurrencyTypeEnum monthRecurrencyType, IList<TaskRecurrency> recurrencies)
        {
            recurrencies = recurrencies.Where(x => x.Schedule.MonthRecurrencyType == monthRecurrencyType.ToString().ToLower()).ToList();
            await Task.CompletedTask; //make method execute in async flow.
            return recurrencies;
        }

        /// <summary>
        /// FilterRecurrenciesOnWeekdays; Filter a TaskRecurrency collection on Weekday values.
        /// </summary>
        /// <param name="weekdays">Weekdays ( DB: tasks_taskrecurrency.weekday0 ~ weekday6)</param>
        /// <param name="recurrencies">Collection of items to be filtered.</param>
        /// <returns>A filtered set of items.</returns>
        private async Task<IList<TaskRecurrency>> FilterRecurrenciesOnWeekdays(List<int> weekdays, IList<TaskRecurrency> recurrencies)
        {
            //TODO switch to while structure
            foreach (int i in weekdays)
            {
                //Note! based on switch. This will be faster than recursive component model querying through the code.
                switch (i)
                {
                    case 0:
                        recurrencies = recurrencies.Where(x => x.Schedule.Weekday0 == true).ToList();
                        break;
                    case 1:
                        recurrencies = recurrencies.Where(x => x.Schedule.Weekday1 == true).ToList();
                        break;
                    case 2:
                        recurrencies = recurrencies.Where(x => x.Schedule.Weekday2 == true).ToList();
                        break;
                    case 3:
                        recurrencies = recurrencies.Where(x => x.Schedule.Weekday3 == true).ToList();
                        break;
                    case 4:
                        recurrencies = recurrencies.Where(x => x.Schedule.Weekday4 == true).ToList();
                        break;
                    case 5:
                        recurrencies = recurrencies.Where(x => x.Schedule.Weekday5 == true).ToList();
                        break;
                    case 6:
                        recurrencies = recurrencies.Where(x => x.Schedule.Weekday6 == true).ToList();
                        break;

                }
            }
            await Task.CompletedTask; //make method execute in async flow.
            return recurrencies;
        }
        #endregion

        #region - private methods Filter Steps -
        /// <summary>
        /// FilterSteps; Filter steps.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="filters">TaskFilters, depending on the values certain filters will be applies.</param>
        /// <param name="nonFilteredCollection">List of non filtered Steps objects.</param>
        /// <returns>List of steps</returns>
        private async Task<IList<Step>> FilterSteps(int companyId, TaskFilters filters, IList<Step> nonFilteredCollection)
        {
            var filtered = nonFilteredCollection;

            if (filters.Limit.HasValue && filtered.Count > filters.Limit && filters.Limit != 0)
            {
                filtered = filtered.Take(filters.Limit.Value).ToList();
            }
            await Task.CompletedTask;
            return filtered;
        }
        #endregion

        #region - private methods Tasks -
        /// <summary>
        /// CreateOrFillTaskFromReader; creates and fills a TasksTask object from a DataReader.
        /// NOTE! intended for use with the action comment stored procedures within the database.
        /// </summary>
        /// <param name="dr">DataReader containing the relevant data.</param>
        /// <param name="task">TaskTasks object that is going to be filled. If object is not supplied it will be created.</param>
        /// <returns>A filled TasksTask object.</returns>
        private TasksTask CreateOrFillTaskFromReader(NpgsqlDataReader dr, TasksTask task = null)
        {
            if (task == null) task = new TasksTask();

            task.Id = Convert.ToInt32(dr["id"]);
            task.CompanyId = Convert.ToInt32(dr["company_id"]);
            if (dr["deviance"] != DBNull.Value)
            {
                task.Deviance = Convert.ToInt32(dr["deviance"]);
            }
            if (dr["due_at"] != DBNull.Value)
            {
                task.DueAt = Convert.ToDateTime(dr["due_at"]);
            }
            if (dr["end_date"] != DBNull.Value)
            {
                task.EndDate = Convert.ToDateTime(dr["end_date"]);
            }
            if (dr["start_date"] != DBNull.Value)
            {
                task.StartDate = Convert.ToDateTime(dr["start_date"]);
            }
            if (dr["max_score"] != DBNull.Value)
            {
                task.MaxScore = Convert.ToInt32(dr["max_score"]);
            }
            if (dr["area_id"] != DBNull.Value)
            {
                task.AreaId = Convert.ToInt32(dr["area_id"]);
            }
            if (dr["recurrency_id"] != DBNull.Value)
            {
                task.RecurrencyId = Convert.ToInt32(dr["recurrency_id"]);
            }
            if (dr["score"] != DBNull.Value)
            {
                task.Score = Convert.ToInt32(dr["score"]);
            }
            if (dr["shift_id"] != DBNull.Value)
            {
                task.ShiftId = Convert.ToInt32(dr["shift_id"]);
            }
            if (dr["start_at"] != DBNull.Value)
            {
                task.StartAt = Convert.ToDateTime(dr["start_at"]);
            }
            task.Status = dr["status"].ToString();
            task.TemplateId = Convert.ToInt32(dr["template_id"]);
            task.Name = dr["name"].ToString();
            if (dr["description"] != DBNull.Value && !string.IsNullOrEmpty(dr["description"].ToString()))
            {
                task.Description = dr["description"].ToString();
            }
            if (dr["picture"] != DBNull.Value && !string.IsNullOrEmpty(dr["picture"].ToString()))
            {
                task.Picture = dr["picture"].ToString();
            }
            if (dr["recurrency_type"] != DBNull.Value && !string.IsNullOrEmpty(dr["recurrency_type"].ToString()))
            {
                task.RecurrencyType = dr["recurrency_type"].ToString();
            }
            if (dr["type"] != DBNull.Value && !string.IsNullOrEmpty(dr["type"].ToString()))
            {
                task.TaskType = dr["type"].ToString();
            }
            if (dr["total_score"] != DBNull.Value)
            {
                task.TotalScore = Convert.ToInt32(dr["total_score"]);
            }
            if (dr["signed_at"] != DBNull.Value && dr["signed_by_id"] != DBNull.Value)
            {
                task.Signature = new Signature() { SignedAt = Convert.ToDateTime(dr["signed_at"]), SignedById = Convert.ToInt32(dr["signed_by_id"]) };
                if (dr.HasColumn("signed_by"))
                {
                    if (dr["signed_by"] != DBNull.Value)
                    {
                        task.Signature.SignedBy = dr["signed_by"].ToString();
                    }
                }
            }
            if (dr.HasColumn("index"))
            {
                if (dr["index"] != DBNull.Value)
                {
                    task.Index = Convert.ToInt32(dr["index"]);
                }
            }
            if (dr["created_at"] != DBNull.Value)
            {
                task.CreatedAt = Convert.ToDateTime(dr["created_at"]);
            }
            if (dr["modified_at"] != DBNull.Value)
            {
                task.ModifiedAt = Convert.ToDateTime(dr["modified_at"]);
            }
            if (dr.HasColumn("audit_id"))
            {
                task.AuditId = Convert.ToInt32(dr["audit_id"]);
            }
            if (dr.HasColumn("checklist_id"))
            {
                task.ChecklistId = Convert.ToInt32(dr["checklist_id"]);
            }
            if (dr.HasColumn("planned_time"))
            {
                if (dr["planned_time"] != DBNull.Value)
                {
                    task.PlannedTime = Convert.ToInt32(dr["planned_time"]);
                }
            }
            if (dr.HasColumn("time_realized_by_id"))
            {
                if (dr["time_realized_by_id"] != DBNull.Value)
                {
                    task.TimeRealizedById = Convert.ToInt32(dr["time_realized_by_id"]);
                }
            }
            if (dr.HasColumn("time_realized_by"))
            {
                if (dr["time_realized_by"] != DBNull.Value)
                {
                    task.TimeRealizedBy = dr["time_realized_by"].ToString();
                }
            }
            if (dr.HasColumn("time_taken"))
            {
                if (dr["time_taken"] != DBNull.Value)
                {
                    task.TimeTaken = Convert.ToInt32(dr["time_taken"]);
                }
            }
            if (dr.HasColumn("actionnr"))
            {
                if (dr["actionnr"] != DBNull.Value)
                {
                    task.ActionsCount = Convert.ToInt32(dr["actionnr"]);
                }
            }
            if(dr.HasColumn("open_template_actionnr"))
            {
                if (dr["open_template_actionnr"] != DBNull.Value)
                {
                    task.OpenTemplateActionsCount = Convert.ToInt32(dr["open_template_actionnr"]);
                }
            }
            if (dr.HasColumn("commentnr"))
            {
                if (dr["commentnr"] != DBNull.Value)
                {
                    task.CommentCount = Convert.ToInt32(dr["commentnr"]);
                }
            }
            if (dr.HasColumn("deeplink_id"))
            {
                if (dr["deeplink_id"] != DBNull.Value)
                {
                    task.DeepLinkId = Convert.ToInt32(dr["deeplink_id"]);
                }
            }
            if (dr.HasColumn("deeplink_to"))
            {
                if (dr["deeplink_to"] != DBNull.Value && !string.IsNullOrEmpty(dr["deeplink_to"].ToString()))
                {
                    task.DeepLinkTo = dr["deeplink_to"].ToString();
                }
            }

            if (dr.HasColumn("deeplink_configuration"))
            {
                if (dr["deeplink_configuration"] != DBNull.Value)
                {
                    try
                    {
                        DeepLinkConfiguration deepLinkConfiguration = dr["deeplink_configuration"].ToString().ToObjectFromJson<DeepLinkConfiguration>();
                        List<DeepLink> deepLinks = deepLinkConfiguration.DeepLinks;
                        if (deepLinks != null && deepLinks.Count > 0 && deepLinks[0].DeepLinkId == task.DeepLinkId && deepLinks[0].DeepLinkTo.Equals(task.DeepLinkTo))
                            task.DeepLinkCompletionIsRequired = deepLinks[0].IsRequired;
                    }
                    catch (Exception ex)
                    {
                        _logger.LogError(exception: ex, message: string.Concat("TaskDataManager.CreateOrFillTaskFromReader(): ", ex.Message));
                    }
                }
            }

            if (dr.HasColumn("deeplink_completed_id"))
            {
                if (dr["deeplink_completed_id"] != DBNull.Value)
                {
                    task.CompletedDeeplinkId = Convert.ToInt32(dr["deeplink_completed_id"]);
                }
            }

            if (dr.HasColumn("description_file"))
            {
                if (dr["description_file"] != DBNull.Value && !string.IsNullOrEmpty(dr["description_file"].ToString()))
                {
                    task.DescriptionFile = dr["description_file"].ToString();
                }
            }
            if (dr.HasColumn("machine_status"))
            {
                if (dr["machine_status"] != DBNull.Value && !string.IsNullOrEmpty(dr["machine_status"].ToString()))
                {
                    task.MachineStatus = dr["machine_status"].ToString();
                }
            }
            if (dr.HasColumn("video"))
            {
                if (dr["video"] != DBNull.Value && !string.IsNullOrEmpty(dr["video"].ToString()))
                {
                    task.Video = dr["video"].ToString();
                }
            }
            if (dr.HasColumn("video_thumbnail"))
            {
                if (dr["video_thumbnail"] != DBNull.Value && !string.IsNullOrEmpty(dr["video_thumbnail"].ToString()))
                {
                    task.VideoThumbnail = dr["video_thumbnail"].ToString();
                }
            }

            if (dr.HasColumn("has_picture_proof"))
            {
                if (dr["has_picture_proof"] != DBNull.Value)
                {
                    task.HasPictureProof = Convert.ToBoolean(dr["has_picture_proof"]);
                }
            }

            if (dr.HasColumn("comment"))
            {
                if (dr["comment"] != DBNull.Value && !string.IsNullOrEmpty(dr["comment"].ToString()))
                {
                    task.Comment = dr["comment"].ToString();
                }
            }

            if (dr.HasColumn("attachments"))
            {
                if (dr["attachments"] != DBNull.Value && !string.IsNullOrEmpty(dr["attachments"].ToString()))
                {
                    task.Attachments = dr["attachments"].ToString().ToObjectFromJson<List<Attachment>>();
                }
            }

            if (dr.HasColumn("version"))
            {
                if (dr["version"] != DBNull.Value && !string.IsNullOrEmpty(dr["version"].ToString()))
                {
                    task.Version = dr["version"].ToString();
                }
            }

            return task;
        }

        /// <summary>
        /// CreateOrFillTaskBasicFromReader; Create a basic task item from a datareader row.
        /// </summary>
        /// <param name="dr">DataReader containing the relevant data.</param>
        /// <param name="task">TaskStatusBasic object that is going to be filled. If object is not supplied it will be created.</param>
        /// <returns>A filled TaskStatusBasic object.</returns>
        private TaskStatusBasic CreateOrFillTaskBasicFromReader(NpgsqlDataReader dr, TaskStatusBasic task = null)
        {
            if (task == null) task = new TaskStatusBasic();

            task.TaskId = Convert.ToInt32(dr["id"]);
            if (dr["signed_at"] != DBNull.Value)
            {
                task.SignedAt = Convert.ToDateTime(dr["signed_at"]);
            }
            if (dr["signed_by_id"] != DBNull.Value)
            {
                task.SignedById = Convert.ToInt32(dr["signed_by_id"]);
            }
            if (dr.HasColumn("signed_by") && dr["signed_by"] != DBNull.Value && !string.IsNullOrEmpty(dr["signed_by"].ToString()))
            {
                task.SignedBy = dr["signed_by"].ToString();
            }

            task.Status = dr["status"].ToString();
            task.TaskTemplateId = Convert.ToInt32(dr["template_id"]);

            if (dr.HasColumn("has_picture_proof"))
            {
                if (dr["has_picture_proof"] != DBNull.Value)
                {
                    task.HasPictureProof = Convert.ToBoolean(dr["has_picture_proof"]);
                }
            }

            if (dr.HasColumn("comment"))
            {
                if (dr["comment"] != DBNull.Value)
                {
                    task.Comment = Convert.ToString(dr["comment"]);
                }
            }
            return task;
        }

        /// <summary>
        /// CreateOrFillTaskExtendedDataBasicFromReader; creates and fills a task basic  object from a DataReader.
        /// NOTE! intended for use with the task basic stored procedures within the database.
        /// </summary>
        /// <param name="dr">DataReader containing the relevant data.</param>
        /// <param name="taskExtendedData">TaskExtendedDataBasic object, if not supplied it will be created.</param>
        /// <returns>TaskExtendedDataBasic object.</returns>
        private TaskExtendedDataBasic CreateOrFillTaskExtendedDataBasicFromReader(NpgsqlDataReader dr, TaskExtendedDataBasic taskExtendedData = null)
        {
            if (taskExtendedData == null) taskExtendedData = new TaskExtendedDataBasic();

            taskExtendedData.TaskId = Convert.ToInt32(dr["id"]);

            if (dr["time_realized_by_id"] != DBNull.Value)
            {
                taskExtendedData.TimeRealizedById = Convert.ToInt32(dr["time_realized_by_id"]);
            }

            if (dr["time_taken"] != DBNull.Value)
            {
                taskExtendedData.TimeTaken = Convert.ToInt32(dr["time_taken"]);
            }


            if (dr["time_realized_by"] != DBNull.Value)
            {
                if (!string.IsNullOrEmpty(dr["time_realized_by"].ToString().Trim()))
                {
                    taskExtendedData.TimeRealizedBy = dr["time_realized_by"].ToString();
                }
            }

            if (dr.HasColumn("deeplink_completed_id"))
            {
                if (dr["deeplink_completed_id"] != DBNull.Value)
                {
                    taskExtendedData.CompletedDeeplinkId = Convert.ToInt32(dr["deeplink_completed_id"]);
                }
            }

            return taskExtendedData;
        }

        /// <summary>
        /// CreateOrFillTaskPropertyUserValueBasicFromReader; creates and fills a checklist template property object from a DataReader.
        /// NOTE! intended for use with the checklist template property stored procedures within the database.
        /// </summary>
        /// <param name="dr">DataReader containing the relevant data.</param>
        /// <param name="taskProperty">TaskPropertyUserValueBasic object, will be created if not supplied.</param>
        /// <returns>TaskPropertyUserValueBasic containing all data</returns>
        private TaskPropertyUserValueBasic CreateOrFillTaskPropertyUserValueBasicFromReader(NpgsqlDataReader dr, TaskPropertyUserValueBasic taskProperty = null)
        {
            if (taskProperty == null) taskProperty = new TaskPropertyUserValueBasic();

            taskProperty.Id = Convert.ToInt32(dr["id"]);
            taskProperty.TemplatePropertyId = Convert.ToInt32(dr["template_property_id"]);
            taskProperty.PropertyId = Convert.ToInt32(dr["property_id"]);
            taskProperty.TaskId = Convert.ToInt32(dr["task_id"]);
            taskProperty.CompanyId = Convert.ToInt32(dr["company_id"]);
            taskProperty.UserId = Convert.ToInt32(dr["user_id"]);

            if (dr["modified_by"] != DBNull.Value)
            {
                if (!string.IsNullOrEmpty(dr["modified_by"].ToString().Trim()))
                {
                    taskProperty.ModifiedBy = dr["modified_by"].ToString();
                }
            }

            if (dr["value_bool"] != DBNull.Value)
            {
                taskProperty.UserValueBool = Convert.ToBoolean(dr["value_bool"]);
            }

            if (dr["value_int"] != DBNull.Value)
            {
                taskProperty.UserValueInt = Convert.ToInt32(dr["value_int"]);
            }

            if (dr["value_string"] != DBNull.Value)
            {
                taskProperty.UserValueString = dr["value_string"].ToString();
            }

            if (dr["value_decimal"] != DBNull.Value)
            {
                taskProperty.UserValueDecimal = Convert.ToDecimal(dr["value_decimal"]);
            }

            if (dr["value_time"] != DBNull.Value)
            {
                taskProperty.UserValueTime = dr["value_time"].ToString(); //TODO check
            }

            if (dr["value_date"] != DBNull.Value)
            {
                taskProperty.UserValueDate = Convert.ToDateTime(dr["value_date"]); //TODO check
            }

            if (dr["created_at"] != DBNull.Value)
            {
                taskProperty.CreatedAt = Convert.ToDateTime(dr["created_at"]); //TODO check
            }

            if (dr["modified_at"] != DBNull.Value)
            {
                taskProperty.ModifiedAt = Convert.ToDateTime(dr["modified_at"]); //TODO check
            }

            return taskProperty;
        }

        private TasksTaskStatus CreateOrFillTaskStatusFromReader(NpgsqlDataReader dr, TasksTaskStatus tasksStatus = null)
        {
            tasksStatus ??= new TasksTaskStatus();
            tasksStatus.Status = Enum.Parse<TaskStatusEnum>(value: Convert.ToString(dr["taskstatus"]).Replace(" ", ""), ignoreCase: true);
            tasksStatus.SignedAt = Convert.ToDateTime(dr["signedat"]);
            tasksStatus.SignedById = Convert.ToInt32(dr["signedbyid"]);
            tasksStatus.SignedBy = Convert.ToString(dr["signedby"]);

            return tasksStatus;
        }

        private TaskCountStatistics CreateOrFillTaskCountStatisticsFromReader(NpgsqlDataReader dr, TaskCountStatistics stats = null)
        {
            stats ??= new TaskCountStatistics();

            switch (dr["value"].ToString().ToLower())
            {
                case "total":
                    stats.TotalCount = Convert.ToInt32(dr["occurrences"]);
                    break;
                //state counts
                case "todo":
                    stats.TodoCount = Convert.ToInt32(dr["occurrences"]);
                    break;
                case "skipped":
                    stats.SkippedCount = Convert.ToInt32(dr["occurrences"]);
                    break;
                case "notok":
                    stats.NotOkCount = Convert.ToInt32(dr["occurrences"]);
                    break;
                case "ok":
                    stats.OkCount = Convert.ToInt32(dr["occurrences"]);
                    break;
                //recurrency type counts
                case "no recurrency":
                    stats.OneTimeOnlyCount = Convert.ToInt32(dr["occurrences"]);
                    break;
                case "week":
                    stats.WeeklyTasksCount = Convert.ToInt32(dr["occurrences"]);
                    break;
                case "month":
                    stats.MonthlyTaskCount = Convert.ToInt32(dr["occurrences"]);
                    break;
                case "shifts":
                    stats.ShiftCount = Convert.ToInt32(dr["occurrences"]);
                    break;
                case "periodday":
                    stats.DailyPeriodCount = Convert.ToInt32(dr["occurrences"]);
                    break;
                case "dynamicday":
                    stats.DailyDynamicCount = Convert.ToInt32(dr["occurrences"]);
                    break;
            }
            return stats;
        }

        /// <summary>
        /// GetNpgsqlParametersFromTask; Creates a list of NpgsqlParameters, and fills it based on the supplied TasksTask object.
        /// NOTE! intended for use with the action stored procedures within the database.
        /// </summary>
        /// <param name="task"></param>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="taskId">TaskId (DB: tasks_task.id)</param>
        /// <returns></returns>
        private List<NpgsqlParameter> GetNpgsqlParametersFromTask(TasksTask task, int companyId, int taskId = 0)
        {
            List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
            if (taskId > 0) parameters.Add(new NpgsqlParameter("@_id", taskId));

            parameters.Add(new NpgsqlParameter("@_companyid", companyId));
            parameters.Add(new NpgsqlParameter("@_status", task.Status));
            parameters.Add(new NpgsqlParameter("@_templateid", task.TemplateId));
            if (task.Comment != null)
            {
                parameters.Add(new NpgsqlParameter("@_comment", task.Comment));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_comment", DBNull.Value));
            }
            if (task.RecurrencyId != null)
            {
                parameters.Add(new NpgsqlParameter("@_recurrencyid", task.RecurrencyId));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_recurrencyid", DBNull.Value));
            }
            if (task.Score != null)
            {
                parameters.Add(new NpgsqlParameter("@_score", task.Score));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_score", DBNull.Value));
            }
            if (task.EndDate != null)
            {
                var endDateParameter = new NpgsqlParameter("@_enddate", DbType.Date);
                endDateParameter.Value = task.EndDate.Value.Date;
                parameters.Add(endDateParameter);
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_enddate", DBNull.Value));
            }
            if (task.StartDate != null)
            {
                var startDateParameter = new NpgsqlParameter("@_startdate", DbType.Date);
                startDateParameter.Value = task.StartDate.Value.Date;
                parameters.Add(startDateParameter);
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_startdate", DBNull.Value));
            }
            if (task.ShiftId != null)
            {
                parameters.Add(new NpgsqlParameter("@_shiftid", task.ShiftId));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_shiftid", DBNull.Value));
            }
            if (task.Deviance != null)
            {
                parameters.Add(new NpgsqlParameter("@_deviance", task.Deviance));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_deviance", DBNull.Value));
            }
            if (task.MaxScore != null)
            {
                parameters.Add(new NpgsqlParameter("@_maxscore", task.MaxScore));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_maxscore", DBNull.Value));
            }
            if (task.TotalScore != null)
            {
                parameters.Add(new NpgsqlParameter("@_totalscore", task.TotalScore));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_totalscore", DBNull.Value));
            }
            if (task.DueAt != null)
            {
                parameters.Add(new NpgsqlParameter("@_dueat", task.DueAt));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_dueat", DBNull.Value));
            }

            if (task.StartAt != null)
            {
                parameters.Add(new NpgsqlParameter("@_startat", task.StartAt));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_startat", DBNull.Value));
            }

            if (task.TimeRealizedById != null)
            {
                parameters.Add(new NpgsqlParameter("@_time_realized_by_id", task.TimeRealizedById));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_time_realized_by_id", DBNull.Value));
            }

            if (task.TimeTaken != null)
            {
                parameters.Add(new NpgsqlParameter("@_time_taken", task.TimeTaken));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_time_taken", DBNull.Value));
            }

            var signature = task.Signature;


            if (task.Signature != null && signature.SignedAt != null && signature.SignedAt != DateTime.MinValue)
            {
                parameters.Add(new NpgsqlParameter("@_signedat", signature.SignedAt));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_signedat", DBNull.Value));
            }
            if (task.Signature != null && signature.SignedById != null && signature.SignedById > 0)
            {
                parameters.Add(new NpgsqlParameter("@_signedbyid", signature.SignedById));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_signedbyid", DBNull.Value));
            }

            //if(task.DeepLinkId.HasValue && !string.IsNullOrEmpty(task.DeepLinkTo))
            //{
            //    DeepLinkConfiguration deepLinkConfig = new()
            //    {
            //        DeepLinks = new() { new DeepLink { DeepLinkId = task.DeepLinkId.Value, DeepLinkTo = task.DeepLinkTo, IsRequired = task.DeepLinkCompletionIsRequired == true } }  
            //    };
            //    parameters.Add(new NpgsqlParameter("@_deeplink_config", deepLinkConfig.ToJsonFromObject()));
            //}

            return parameters;
        }

        /// <summary>
        /// GetNpgsqlParametersFromChecklistTemplateProperty; Creates a list of NpgsqlParameters, and fills it based on the supplied task object.
        /// NOTE! intended for use with the tasks stored procedures within the database.
        /// </summary>
        /// <param name="task">Task object containing all data.</param>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="taskId">TaskId (DB: tasks_task.id)</param>
        /// <returns>List of NpgsqlParameter</returns>
        private List<NpgsqlParameter> GetNpgsqlParametersFromTaskStatus(TasksTask task, int companyId, int taskId = 0)
        {
            List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
            if (taskId != 0)
            {
                parameters.Add(new NpgsqlParameter("@_id", taskId));
            }
            parameters.Add(new NpgsqlParameter("@_companyid", companyId));
            parameters.Add(new NpgsqlParameter("@_status", task.Status));

            var signature = task.Signature;
            if (task.Signature != null && signature.SignedAt != null && signature.SignedAt != DateTime.MinValue)
            {
                parameters.Add(new NpgsqlParameter("@_signedat", signature.SignedAt));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_signedat", DBNull.Value));
            }
            if (task.Signature != null && signature.SignedById != null && signature.SignedById > 0)
            {
                parameters.Add(new NpgsqlParameter("@_signedbyid", signature.SignedById));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_signedbyid", DBNull.Value));
            }

            return parameters;
        }

        /// <summary>
        /// AppendTaskStepsAsync; Append tasks to task objects.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="tasks">Collection of tasks.</param>
        /// <returns>The list of tasks, appended with Steps.</returns>
        private async Task<List<TasksTask>> AppendStepsTaskAsync(int companyId, List<TasksTask> tasks)
        {
            List<int> taskTemplateIds = tasks.Select(t => t.TemplateId).ToList();
            var steps = await GetTaskTemplateStepsAsync(companyId: companyId, taskTemplateIds: taskTemplateIds);
            if (steps != null && steps.Count > 0)
            {
                foreach (var item in tasks)
                {
                    item.Steps = steps.Where(x => x.TaskTemplateId == item.TemplateId).ToList();
                }
            }

            return tasks;
        }


        /// <summary>
        /// AppendAreaPathsToTasksAsync; Add the AreaPath to the Task. (used for CMS purposes);
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="tasks">List of tasks.</param>
        /// <returns>Tasks including area full path. </returns>
        private async Task<List<TasksTask>> AppendAreaPathsToTasksAsync(int companyId, List<TasksTask> tasks, bool addAreaPath = true, bool addAreaPathIds = false)
        {

            var areas = await _areaManager.GetAreasAsync(companyId: companyId, maxLevel: 99, useTreeview: false);
            if (areas != null && areas.Count > 0)
            {
                foreach (var task in tasks)
                {
                    var area = areas?.Where(x => x.Id == task.AreaId)?.FirstOrDefault();
                    if (area != null)
                    {
                        if (addAreaPath) task.AreaPath = area.FullDisplayName;
                        if (addAreaPathIds) task.AreaPathIds = area.FullDisplayIds;
                    }
                }
            }
            return tasks;
        }

        /// <summary>
        /// AppendPropertyUserValuesToTasks; Append property user values to tasks.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="tasks">Tasks that need to be updated.</param>
        /// <param name="include">Include parameter can be used for including extra data, based on includes enum.</param>
        /// <returns>List of updated tasks.</returns>
        private async Task<List<TasksTask>> AppendPropertyUserValuesToTasks(int companyId, List<TasksTask> tasks, string include = null, ConnectionKind connectionKind = ConnectionKind.Reader)
        {
            List<long> taskIds = tasks.Select(x => x.Id).ToList();
            var properties = await _propertyValueManager.GetPropertyUserValuesWithTasks(companyId: companyId, taskIds: taskIds, include: include, connectionKind: connectionKind);
            foreach (var task in tasks)
            {
                if (include.Split(",").Contains(IncludesEnum.PropertyValues.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.Properties.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.PropertyDetails.ToString().ToLower()))
                {
                    task.PropertyUserValues = properties.Where(x => x.TaskId == task.Id && PropertySettings.BasicAndSpecificProperties.ToList().Contains(x.PropertyGroupId.Value)).ToList();
                }
            }

            return tasks;
        }

        /// <summary>
        /// AppendPropertyUserValuesToTask; Append property user values to a specific task.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="task">Task object that where user values need to be added</param>
        /// <param name="include">Include parameter can be used for including extra data, based on includes enum.</param>
        /// <returns></returns>
        private async Task<TasksTask> AppendPropertyUserValuesToTask(int companyId, TasksTask task, string include = null)
        {
            //TODO make more efficient
            List<long> taskIdList = new() { task.Id };
            var properties = await _propertyValueManager.GetPropertyUserValuesWithTasks(companyId: companyId, taskIds: taskIdList, include: include);
            if (include.Split(",").Contains(IncludesEnum.PropertyValues.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.Properties.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.PropertyDetails.ToString().ToLower()))
            {
                task.PropertyUserValues = properties.Where(x => x.TaskId == task.Id && PropertySettings.BasicAndSpecificProperties.ToList().Contains(x.PropertyGroupId.Value)).ToList();
            }

            return task;
        }

        private async Task<TasksTask> AppendPropertiesToTask(TasksTask task, int companyId, string include)
        {
            var properties = await _propertyValueManager.GetPropertiesTaskTemplateAsync(companyId: companyId, taskTemplateId: task.TemplateId, include: include);
            task.Properties = properties;

            foreach (var property in task.Properties)
            {
                property.TaskTemplateId = task.TemplateId; //force template id (normally should be filled)
            }

            return task;
        }


        /// <summary>
        /// AddChangeTaskPropertyUserValue; Add or Change task property user value. Depening on propertyUserValue.Id > 0 is determined if a update or insert needs to be done.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="taskId">TaskId (DB: tasks_task.id)</param>
        /// <param name="userId">UserId (DB: profiles_user.id)</param>
        /// <param name="propertyUserValues">List of property user values to be updated or inserted.</param>
        /// <returns>true/false depending on outcome.</returns>
        private async Task<bool> AddChangeTaskPropertyUserValue(int companyId, int taskId, int userId, List<PropertyUserValue> propertyUserValues)
        {
            var existingPropertyUserValues = await _propertyValueManager.GetPropertyUserValuesByTaskId(companyId: companyId, taskId: taskId);

            if (propertyUserValues != null && propertyUserValues.Count > 0)
            {
                foreach (PropertyUserValue propertyUserValue in propertyUserValues)
                {
                    var foundProperty = existingPropertyUserValues.Where(p => p.TemplatePropertyId == propertyUserValue.TemplatePropertyId).FirstOrDefault();
                    if (foundProperty != null)
                    {
                        propertyUserValue.Id = foundProperty.Id;
                    }

                    if (propertyUserValue.Id > 0)
                    {
                        propertyUserValue.TaskId = taskId;
                        var resultChange = await _propertyValueManager.ChangePropertyUserValueAsync(companyId: companyId, propertyValue: propertyUserValue, propertyUserValueId: propertyUserValue.Id, userId: userId);
                    }
                    else
                    {
                        propertyUserValue.TaskId = taskId;
                        var resultAdd = await _propertyValueManager.AddPropertyUserValueAsync(companyId: companyId, propertyValue: propertyUserValue, userId: userId);
                    }
                }
            }
            return true;
        }

        /// <summary>
        /// AddChangeTaskPropertyUserValue; Add or Change task property user value. Depening on propertyUserValue.Id > 0 is determined if a update or insert needs to be done.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="taskId">TaskId (DB: tasks_task.id)</param>
        /// <param name="userId">UserId (DB: profiles_user.id)</param>
        /// <param name="propertyUserValues">List of property user values to be updated or inserted.</param>
        /// <returns>true/false depending on outcome.</returns>
        private async Task<bool> AddChangeTaskPropertyUserValue(int companyId, int taskId, int userId, List<PropertyDTO> propertyUserValues)
        {
            var existingPropertyUserValues = await _propertyValueManager.GetPropertyUserValuesByTaskId(companyId: companyId, taskId: taskId);

            if (propertyUserValues != null && propertyUserValues.Count > 0)
            {
                foreach (PropertyDTO property in propertyUserValues)
                {
                    var foundProperty = existingPropertyUserValues.Where(p => p.TemplatePropertyId == property.PropertyTemplate.Id).FirstOrDefault();
                    if (foundProperty != null)
                    {
                        property.UserValue.Id = foundProperty.Id;
                    }

                    property.UserValue.TaskId = taskId;
                    if (property.UserValue.Id > 0)
                    {                        
                        var resultChange = await _propertyValueManager.ChangePropertyUserValueAsync(companyId: companyId, propertyUserValueId: (int)property.UserValue.Id, userId: userId, property: property);
                    }
                    else
                    {             
                        var resultAdd = await _propertyValueManager.AddPropertyUserValueAsync(companyId: companyId, userId: userId, property: property);
                    }
                }
            }
            return true;
        }

        /// <summary>
        /// AddChangeTaskPictureProof; Add or Change task picture proof. 
        /// If picture proof already exists, nothing regarding picture proof will change.
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="taskId">TaskId (DB: tasks_task.id)</param>
        /// <param name="userId">UserId (DB: profiles_user.id)</param>
        /// <param name="possibleOwnerId">PossibleOwnerId (DB: profiles_user.id)</param>
        /// <param name="pictureProof">Picture proof to be updated or inserted.</param>
        /// <returns>true/false depending on outcome.</returns>
        private async Task<bool> AddChangeTaskPictureProof(int companyId, int taskId, int userId, int possibleOwnerId, PictureProof pictureProof)
        {
            //TODO reactor, handles add and change functionality, these both need seperate logic and called within this method. 

            PictureProof pp = null;
            //get picture proof
            List<NpgsqlParameter> getPPParameters = new List<NpgsqlParameter>();
            getPPParameters.Add(new NpgsqlParameter("@_companyid", companyId));
            getPPParameters.Add(new NpgsqlParameter("@_taskid", taskId));
            using (var dr = await _manager.GetDataReader("get_picture_proof", commandType: CommandType.StoredProcedure, parameters: getPPParameters))
            {
                while (await dr.ReadAsync())
                {
                    pp = await CreateOrFillPictureProofFromReader(dr);
                }
            }
            //turn pictureproof media into json for add/update call
            var pictureProofMedia = pictureProof.Media.ToJsonFromObject();

            //if picture proof exists, change existing picture proof
            if (pp != null)
            {
                var original = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.picture_proof.ToString(), pp.Id);

                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_id", pp.Id));
                parameters.Add(new NpgsqlParameter("@_taskid", taskId));
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));
                parameters.Add(new NpgsqlParameter("@_media", pictureProofMedia));
                parameters.Add(new NpgsqlParameter("@_prooftakenutc", new DateTime(pictureProof.ProofTakenUtc.Ticks)));
                parameters.Add(new NpgsqlParameter("@_prooftakenbyuserid", pictureProof.ProofTakenByUserId > 0 ? pictureProof.ProofTakenByUserId : (possibleOwnerId > 0 ? possibleOwnerId : userId)));

                if (!string.IsNullOrEmpty(pictureProof.Description))
                {
                    parameters.Add(new NpgsqlParameter("@_description", pictureProof.Description));
                }

                //add new picture proof to database
                var id = Convert.ToInt32(await _manager.ExecuteScalarAsync("change_picture_proof", parameters: parameters, commandType: CommandType.StoredProcedure));

                var mutated = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.picture_proof.ToString(), pp.Id);
                await _dataAuditing.WriteDataAudit(original: original, mutated: mutated, Models.Enumerations.TableNames.picture_proof.ToString(), objectId: pp.Id, userId: userId, companyId: companyId, description: "Changed task picture proof.");

                return id > 0;
            }
            else
            {
                //if it doesnt exist, add new picture proof
                //"public"."add_picture_proof"("_taskid" int4, "_media" varchar, "_prooftakenutc" timestamp, "_companyid" int4, "_prooftakenbyuserid" int4, "_description" text=NULL::text)
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_taskid", taskId));
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));
                parameters.Add(new NpgsqlParameter("@_media", pictureProofMedia));
                parameters.Add(new NpgsqlParameter("@_prooftakenutc", new DateTime(pictureProof.ProofTakenUtc.Ticks)));
                parameters.Add(new NpgsqlParameter("@_prooftakenbyuserid", pictureProof.ProofTakenByUserId > 0 ? pictureProof.ProofTakenByUserId : (possibleOwnerId > 0 ? possibleOwnerId : userId)));

                if (!string.IsNullOrEmpty(pictureProof.Description))
                {
                    parameters.Add(new NpgsqlParameter("@_description", pictureProof.Description));
                }

                //add new picture proof to database
                var id = Convert.ToInt32(await _manager.ExecuteScalarAsync("add_picture_proof", parameters: parameters, commandType: CommandType.StoredProcedure));

                var mutated = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.picture_proof.ToString(), id);
                await _dataAuditing.WriteDataAudit(original: string.Empty, mutated: mutated, Models.Enumerations.TableNames.picture_proof.ToString(), objectId: id, userId: userId, companyId: companyId, description: "Added task picture proof.");

                return id > 0;
            }

        }

        /// <summary>
        /// AppendUserInformationToTasks; Append firstname, lastname combinations to objects with tasks which are separately stored. (e.g. modified_by_id etc).
        /// </summary>
        /// <param name="companyId">CompanyId of all users that need to be retrieved.</param>
        /// <param name="tasks">Tasks that need to be amended with data</param>
        /// <returns>return updated audits</returns>
        private async Task<List<TasksTask>> AppendUserInformationToTasksAsync(int companyId, List<TasksTask> tasks)
        {
            var possibleUsers = await _userManager.GetUserProfilesAsync(companyId: companyId);
            if (possibleUsers != null && tasks != null)
            {
                foreach (var task in tasks)
                {
                    if (task.PropertyUserValues != null)
                    {
                        foreach (var prop in task.PropertyUserValues)
                        {
                            if (prop.UserId > 0)
                            {
                                var possibleUser = possibleUsers.FirstOrDefault(x => x.Id == prop.UserId);
                                if (possibleUser != null)
                                {
                                    prop.ModifiedBy = string.Concat(possibleUser.FirstName, " ", possibleUser.LastName);
                                }
                            }
                        }
                    }
                }
            }

            return tasks;
        }

        /// <summary>
        /// 
        /// </summary>
        /// <param name="tasks"></param>
        /// <param name="companyId"></param>
        /// <param name="language"></param>
        /// <returns></returns>
        private async Task<List<TasksTask>> AppendTranslationsToTasksAsync(List<TasksTask> tasks, int companyId, string language)
        {
            if (string.IsNullOrEmpty(language) || tasks == null || !tasks.Any())
                return tasks;

            foreach (var task in tasks)
            {
                var translation = await _translationManager.GetTranslationAsync(
                    task.TemplateId,
                    companyId,
                    language,
                    "public.get_tasktemplate_translations",
                    task);

            }

            return tasks;
        }

        /// <summary>
        /// AppendUserInformationToTaskAsync; Append firstname, lastname combinations to objects with task which are separately stored. (e.g. modified_by_id etc).
        /// </summary>
        /// <param name="companyId">CompanyId of all users that need to be retrieved.</param>
        /// <param name="task">Task that need to be amended with data</param>
        /// <returns>return updated audit</returns>
        private async Task<TasksTask> AppendUserInformationToTaskAsync(int companyId, TasksTask task)
        {
            var possibleUsers = await _userManager.GetUserProfilesAsync(companyId: companyId);
            if (possibleUsers != null && task != null)
            {
                if (task.PropertyUserValues != null)
                {
                    foreach (var prop in task.PropertyUserValues)
                    {
                        if (prop.UserId > 0)
                        {
                            var possibleUser = possibleUsers.FirstOrDefault(x => x.Id == prop.UserId);
                            if (possibleUser != null)
                            {
                                prop.ModifiedBy = string.Concat(possibleUser.FirstName, " ", possibleUser.LastName);
                            }
                        }
                    }
                }
            }
            return task;
        }

        /// <summary>
        /// Gets the completed deeplink id for every task if it exists
        /// Linked audit or checklist needs to be completed and active for it to count
        /// </summary>
        /// <param name="companyId">company id</param>
        /// <param name="tasks">list of tasks to get the completed deeplink id for</param>
        /// <returns>List of tasks with the completed deeplink id set if available</returns>
        private async Task<List<TasksTask>> AppendCompletedDeeplinkIdToTasks(int companyId, List<TasksTask> tasks)
        {
            var output = new List<UserProfile>();

            try
            {
                List<NpgsqlParameter> parameters = new()
                {
                    new NpgsqlParameter("@_companyid", companyId),
                    new NpgsqlParameter("@_ids", tasks.Select(x => x.Id).ToArray())
                };

                using NpgsqlDataReader dr = await _manager.GetDataReader("get_tasks_completed_deeplink_id", commandType: System.Data.CommandType.StoredProcedure, parameters: parameters);

                while (await dr.ReadAsync())
                {
                    long taskId = Convert.ToInt32(dr["task_id"]);
                    int completedDeepLinkId = Convert.ToInt32(dr["completed_deeplink_id"]);
                    tasks.First(x => x.Id == taskId).CompletedDeeplinkId = completedDeepLinkId;
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.AppendCompletedDeeplinkIdToTasks(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
            }

            return tasks;
        }

        private List<NpgsqlParameter> GetNpgsqlParametersFromTaskFilter(TaskFilters filters, int userId)
        {
            List<NpgsqlParameter> result = new List<NpgsqlParameter>();

            if (filters.AreaId.HasValue && filters.AreaId.Value > 0)
            {
                result.Add(new NpgsqlParameter("@_areaid", filters.AreaId.Value));
            }

            if (filters.ShiftId.HasValue && filters.ShiftId.Value > 0)
            {
                result.Add(new NpgsqlParameter("@_shiftid", filters.ShiftId.Value));
            }

            if (filters.TemplateId.HasValue && filters.TemplateId.Value > 0)
            {
                result.Add(new NpgsqlParameter("@_templateid", filters.TemplateId.Value));
            }

            if (filters.Statuses != null && filters.Statuses.Count > 0)
            {
                result.Add(new NpgsqlParameter("@_statuses", filters.Statuses.Select(status => status.ToString().ToLower()).ToArray()));
            }

            if (filters.RecurrencyTypes != null && filters.RecurrencyTypes.Count > 0)
            {
                result.Add(new NpgsqlParameter("@_types", filters.RecurrencyTypes.Select(type => type.ToString().ToLower()).ToArray()));
            }

            if (filters.AllowedOnly.HasValue && filters.AllowedOnly.Value && userId > 0)
            {
                result.Add(new NpgsqlParameter("@_userid", userId));
            }

            if (filters.TagIds != null && filters.TagIds.Length > 0)
            {
                result.Add(new NpgsqlParameter("@_tagids", filters.TagIds));
            }

            if (!string.IsNullOrEmpty(filters.FilterText))
            {
                result.Add(new NpgsqlParameter("@_filtertext", filters.FilterText.ToString()));
            }

            return result;
        }

        /// <summary>
        /// Enriches the provided <see cref="Gen4TaskFilters"/> object with additional data based on the specified time
        /// span and company context.
        /// </summary>
        /// <remarks>The method updates the <paramref name="filters"/> object based on the specified <see
        /// cref="TaskTimeSpanEnum"/> value in the <c>Timespan</c> property.  Depending on the time span, the method
        /// retrieves and sets the appropriate start and end timestamps, and may also populate recurrence types. <list
        /// type="bullet"> <item><description>If the time span is <see cref="TaskTimeSpanEnum.Shift"/>, the method
        /// retrieves shift timestamps.</description></item> <item><description>If the time span is <see
        /// cref="TaskTimeSpanEnum.Day"/>, the method retrieves day-level timestamps.</description></item>
        /// <item><description>If the time span is <see cref="TaskTimeSpanEnum.Week"/>, the method retrieves week-level
        /// timestamps and sets default recurrence types.</description></item> <item><description>If the time span is
        /// <see cref="TaskTimeSpanEnum.Overdue"/>, the method retrieves the current day-level
        /// timestamps.</description></item> </list></remarks>
        /// <param name="companyId">The unique identifier of the company for which the filters are being enriched.</param>
        /// <param name="filters">The <see cref="Gen4TaskFilters"/> object to be enriched. This object may be modified to include additional
        /// timestamps and recurrence types.</param>
        /// <returns>A task that represents the asynchronous operation. The task result contains the enriched <see
        /// cref="Gen4TaskFilters"/> object with updated timestamps and recurrence types, if applicable.</returns>
        private async Task<Gen4TaskFilters> EnrichGen4TaskFilter(int companyId, Gen4TaskFilters filters)
        {
            

            if (filters.Timespan.HasValue)
            {
                switch (filters.Timespan.Value)
                {
                    case TaskTimeSpanEnum.Shift:
                        filters.ShiftTimestamps ??= await _shiftManager.GetShiftTimestampsByOffsetAsync(companyId: companyId, timestamp: null, shiftOffset: filters.TimespanOffset);
                        filters.StartTimestamp = filters.ShiftTimestamps.Start;
                        filters.EndTimestamp = filters.ShiftTimestamps.End;
                        break;
                    case TaskTimeSpanEnum.Day:
                        filters.ShiftDayWeekTimestamps ??= await _shiftManager.GetShiftDayWeekTimesByTimestamp(companyId: companyId, (await _companyManager.GetCompanyLocalTime(companyId)).AddDays(filters.TimespanOffset));
                        filters.StartTimestamp = filters.ShiftDayWeekTimestamps.DayStart;
                        filters.EndTimestamp = filters.ShiftDayWeekTimestamps.DayEnd;
                        break;
                    case TaskTimeSpanEnum.Week:
                        filters.ShiftDayWeekTimestamps ??= await _shiftManager.GetShiftDayWeekTimesByTimestamp(companyId: companyId, (await _companyManager.GetCompanyLocalTime(companyId)).AddDays(filters.TimespanOffset * 7));
                        filters.StartTimestamp = filters.ShiftDayWeekTimestamps.WeekStart;
                        filters.EndTimestamp = filters.ShiftDayWeekTimestamps.WeekEnd;
                        filters.RecurrencyTypes ??= new List<RecurrencyTypeEnum>(){RecurrencyTypeEnum.Week,
                                                                                           RecurrencyTypeEnum.Month,
                                                                                           RecurrencyTypeEnum.DynamicDay,
                                                                                           RecurrencyTypeEnum.PeriodDay};
                        break;
                    case TaskTimeSpanEnum.Overdue:
                        filters.ShiftDayWeekTimestamps ??= await _shiftManager.GetShiftDayWeekTimesByTimestamp(companyId: companyId, timestamp: null);
                        break;
                }
            }
            return filters;
        }

        /// <summary>
        /// Generates a list of <see cref="NpgsqlParameter"/> objects based on the specified company ID and task filter
        /// criteria.
        /// </summary>
        /// <remarks>This method constructs a parameterized query by mapping the properties of the
        /// <paramref name="filters"/> object to  corresponding database parameters. It includes required filters such
        /// as area ID, optional filters like text search  and tags, and additional parameters for pagination (limit and
        /// offset).   Special handling is applied for time-based filters, including support for specific time spans
        /// such as overdue tasks.</remarks>
        /// <param name="companyId">The unique identifier of the company for which the parameters are being generated.</param>
        /// <param name="filters">An instance of <see cref="Gen4TaskFilters"/> containing the filtering criteria for the task query.</param>
        /// <returns>A list of <see cref="NpgsqlParameter"/> objects representing the parameters to be used in a database query.</returns>
        private List<NpgsqlParameter> GetNpgsqlParametersFromGen4TaskFilter(int companyId, Gen4TaskFilters filters, DateTime timestamp)
        {
            List<NpgsqlParameter> result = _manager.GetBaseParameters(companyId);

            //timestamp and recurrence filters
            result.Add(new NpgsqlParameter("@_timestamp", timestamp));

            if (!filters.Timespan.HasValue)
            {
                result.Add(new NpgsqlParameter("@_starttimestamp", filters.StartTimestamp));
                result.Add(new NpgsqlParameter("@_endtimestamp", filters.EndTimestamp));
            }
            else if(filters.Timespan.Value == TaskTimeSpanEnum.Overdue)
            {
                result.Add(new NpgsqlParameter("@_todaystart", filters.ShiftDayWeekTimestamps.DayStart));
                result.Add(new NpgsqlParameter("@_todayend", filters.ShiftDayWeekTimestamps.DayEnd));
                result.Add(new NpgsqlParameter("@_weekend", filters.ShiftDayWeekTimestamps.WeekEnd));

                //overdue sp doesn't take the allowduplicate flag, so force to null
                filters.AllowDuplicateTaskInstances = null;
            }
            else
            {
                result.Add(new NpgsqlParameter("@_starttimestamp", filters.StartTimestamp));
                result.Add(new NpgsqlParameter("@_endtimestamp", filters.EndTimestamp));
            }

            //required filters
            result.Add(new NpgsqlParameter("@_areaid", filters.AreaId));

            //optional filters
            if (!string.IsNullOrEmpty(filters.FilterText))
            {
                result.Add(new NpgsqlParameter("@_filtertext", filters.FilterText));
            }
            if (filters.TagIds != null && filters.TagIds.Length > 0)
            {
                result.Add(new NpgsqlParameter("@_tagids", filters.TagIds));
            }
            if (filters.Statuses != null && filters.Statuses.Count > 0)
            {
                result.Add(new NpgsqlParameter("@_statuses", filters.Statuses.Select(status => status.ToString().ToLower()).ToArray()));
            }
            if (filters.RecurrencyTypes != null && filters.RecurrencyTypes.Count > 0)
            {
                result.Add(new NpgsqlParameter("@_types", filters.RecurrencyTypes.Select(type => type.ToString().ToLower()).ToArray()));
            }
            if (filters.AllowDuplicateTaskInstances != null)
            {
                result.Add(new NpgsqlParameter("@_allowduplicatetaskinstances", filters.AllowDuplicateTaskInstances));
            }

            //limit and offset
            if (filters.Limit.HasValue)
            {
                result.Add(new NpgsqlParameter("@_limit", filters.Limit.Value));
            }
            if (filters.Offset.HasValue)
            {
                result.Add(new NpgsqlParameter("@_offset", filters.Offset.Value));
            }

            return result;
        }

        #endregion

        #region - private methods TaskTemplate -
        /// <summary>
        /// CreateOrFillTaskTemplateFromReader; creates and fills a TaskTemplate object from a DataReader.
        /// NOTE! intended for use with the action comment stored procedures within the database.
        /// </summary>
        /// <param name="dr">DataReader containing the relevant data.</param>
        /// <param name="tasktemplate"></param>
        /// <returns>TaskTemplate containing all information.</returns>
        private TaskTemplate CreateOrFillTaskTemplateFromReader(NpgsqlDataReader dr, TaskTemplate tasktemplate = null)
        {
            if (tasktemplate == null) tasktemplate = new TaskTemplate();

            tasktemplate.Id = Convert.ToInt32(dr["id"]);

            if (dr["area_id"] != DBNull.Value)
            {
                tasktemplate.AreaId = Convert.ToInt32(dr["area_id"]);
            }

            tasktemplate.CompanyId = Convert.ToInt32(dr["company_id"]);

            if (dr["description"] != DBNull.Value && !string.IsNullOrEmpty(dr["description"].ToString()))
            {
                tasktemplate.Description = dr["description"].ToString();
            }

            if (dr["description_file"] != DBNull.Value && !string.IsNullOrEmpty(dr["description_file"].ToString()))
            {
                tasktemplate.DescriptionFile = dr["description_file"].ToString();
            }

            if (dr["machine_status"] != DBNull.Value && !string.IsNullOrEmpty(dr["machine_status"].ToString()))
            {
                tasktemplate.MachineStatus = dr["machine_status"].ToString();
            }

            tasktemplate.Name = dr["name"].ToString();

            if (dr["picture"] != DBNull.Value && !string.IsNullOrEmpty(dr["picture"].ToString()))
            {
                tasktemplate.Picture = dr["picture"].ToString();
            }

            if (dr["planned_time"] != DBNull.Value)
            {
                tasktemplate.PlannedTime = Convert.ToInt32(dr["planned_time"]);
            }

            if (dr["role"] != DBNull.Value)
            {
                tasktemplate.Role = dr["role"].ToString();
            }
            tasktemplate.Type = dr["type"].ToString();

            if (dr["video"] != DBNull.Value && !string.IsNullOrEmpty(dr["video"].ToString()))
            {
                tasktemplate.Video = dr["video"].ToString();
            }

            if (dr["video_thumbnail"] != DBNull.Value && !string.IsNullOrEmpty(dr["video_thumbnail"].ToString()))
            {
                tasktemplate.VideoThumbnail = dr["video_thumbnail"].ToString();
            }

            tasktemplate.Weight = Convert.ToDecimal(dr["weight"]);

            if (dr.HasColumn("index"))
            {
                if (dr["index"] != DBNull.Value)
                {
                    tasktemplate.Index = Convert.ToInt32(dr["index"]);
                }
            }

            if (dr.HasColumn("actionnr"))
            {
                if (dr["actionnr"] != DBNull.Value)
                {
                    tasktemplate.ActionsCount = Convert.ToInt32(dr["actionnr"]);
                }
            }

            if (dr.HasColumn("stepnr"))
            {
                if (dr["stepnr"] != DBNull.Value)
                {
                    tasktemplate.StepsCount = Convert.ToInt32(dr["stepnr"]);
                }
            }

            if (dr.HasColumn("audittemplate_id"))
            {
                if (dr["audittemplate_id"] != DBNull.Value)
                {
                    tasktemplate.AuditTemplateId = Convert.ToInt32(dr["audittemplate_id"]);
                }
            }

            if (dr.HasColumn("checklisttemplate_id"))
            {
                if (dr["checklisttemplate_id"] != DBNull.Value)
                {
                    tasktemplate.ChecklistTemplateId = Convert.ToInt32(dr["checklisttemplate_id"]);
                }
            }

            if (dr.HasColumn("deeplink_id"))
            {
                if (dr["deeplink_id"] != DBNull.Value)
                {
                    tasktemplate.DeepLinkId = Convert.ToInt32(dr["deeplink_id"]);
                }
            }

            if (dr.HasColumn("deeplink_to"))
            {
                if (dr["deeplink_to"] != DBNull.Value && !string.IsNullOrEmpty(dr["deeplink_to"].ToString()))
                {
                    tasktemplate.DeepLinkTo = dr["deeplink_to"].ToString();
                }
            }

            if (dr.HasColumn("deeplink_configuration"))
            {
                if (dr["deeplink_configuration"] != DBNull.Value)
                {
                    try
                    {
                        DeepLinkConfiguration deepLinkConfiguration = dr["deeplink_configuration"].ToString().ToObjectFromJson<DeepLinkConfiguration>();
                        List<DeepLink> deepLinks = deepLinkConfiguration.DeepLinks;
                        if (deepLinks.Count > 0 && deepLinks[0].DeepLinkId == tasktemplate.DeepLinkId && deepLinks[0].DeepLinkTo.Equals(tasktemplate.DeepLinkTo))
                            tasktemplate.DeepLinkCompletionIsRequired = deepLinks[0].IsRequired;
                    }
                    catch (Exception ex)
                    {
                        _logger.LogError(exception: ex, message: string.Concat("TaskDataManager.CreateOrFillTaskTemplateFromReader(): ", ex.Message));
                    }
                }
            }

            if (dr.HasColumn("recurrency_type"))
            {
                if (dr["recurrency_type"] != DBNull.Value && !string.IsNullOrEmpty(dr["recurrency_type"].ToString()))
                {
                    tasktemplate.RecurrencyType = dr["recurrency_type"].ToString();
                }
            }

            if (dr.HasColumn("has_derived_items"))
            {
                if (dr["has_derived_items"] != DBNull.Value)
                {
                    tasktemplate.HasDerivedItems = Convert.ToBoolean(dr["has_derived_items"]);
                }
            }

            if (dr.HasColumn("has_picture_proof"))
            {
                if (dr["has_picture_proof"] != DBNull.Value)
                {
                    tasktemplate.HasPictureProof = Convert.ToBoolean(dr["has_picture_proof"]);
                }
            }

            if (dr.HasColumn("modified_at"))
            {
                if (dr["modified_at"] != DBNull.Value)
                {
                    tasktemplate.ModifiedAt = Convert.ToDateTime(dr["modified_at"]);
                }
            }

            if (dr.HasColumn("attachments"))
            {
                var attachmentsJson = Convert.ToString(dr["attachments"] ?? "");
                if (attachmentsJson == "")
                {
                    tasktemplate.Attachments = new List<Attachment>();
                }
                else
                {
                    tasktemplate.Attachments = Convert.ToString(dr["attachments"] ?? "").ToObjectFromJson<List<Attachment>>();
                }
            }

            if (dr.HasColumn("version"))
            {
                if (dr["version"] != DBNull.Value)
                {
                    tasktemplate.Version = Convert.ToString(dr["version"]);
                }
            }

            return tasktemplate;
        }

        private TaskTemplateCountStatistics CreateOrFillTaskTemplateCountsFromReader(NpgsqlDataReader dr, TaskTemplateCountStatistics tasktemplatecount = null)
        {
            if (tasktemplatecount == null) tasktemplatecount = new TaskTemplateCountStatistics();

            tasktemplatecount.TotalCount = Convert.ToInt32(dr["total_count"]);

            return tasktemplatecount;
        }

        /// <summary>
        /// GetNpgsqlParametersFromTaskTemplate; Creates a list of NpgsqlParameters, and fills it based on the supplied TaskTemplate object.
        /// NOTE! intended for use with the action stored procedures within the database.
        /// </summary>
        /// <param name="taskTemplate">TaskTemplate object containing all information.</param>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="taskTemplateId">TaskTemplateId (DB: tasks_tasktemplate.id)</param>
        /// <returns>List of NpgsqlParameter items</returns>
        private List<NpgsqlParameter> GetNpgsqlParametersFromTaskTemplate(TaskTemplate taskTemplate, int companyId, int taskTemplateId = 0)
        {
            List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
            if (taskTemplateId > 0) parameters.Add(new NpgsqlParameter("@_id", taskTemplateId));

            parameters.Add(new NpgsqlParameter("@_companyid", companyId));
            parameters.Add(new NpgsqlParameter("@_name", taskTemplate.Name));
            if (taskTemplate.AreaId.HasValue)
            {
                parameters.Add(new NpgsqlParameter("@_areaid", taskTemplate.AreaId));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_areaid", DBNull.Value));
            }

            if (!string.IsNullOrEmpty(taskTemplate.Picture))
            {
                parameters.Add(new NpgsqlParameter("@_picture", taskTemplate.Picture));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_picture", DBNull.Value));
            }

            if (!string.IsNullOrEmpty(taskTemplate.Description))
            {
                parameters.Add(new NpgsqlParameter("@_description", taskTemplate.Description));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_description", DBNull.Value));
            }

            if (!string.IsNullOrEmpty(taskTemplate.DescriptionFile))
            {
                if (taskTemplate.Attachments == null)
                {
                    taskTemplate.Attachments = new List<Attachment>();
                }
                var uriParts = taskTemplate.DescriptionFile.Split('/');
                var filename = uriParts.Last();

                var found = taskTemplate.Attachments.Where(t => t.Uri == taskTemplate.DescriptionFile).FirstOrDefault();
                if (found == null || taskTemplate.Attachments.Count != 1)
                {
                    taskTemplate.Attachments = new List<Attachment>() {
                        new Attachment()
                        {
                            FileName = filename,
                            FileType = "application/pdf",
                            FileExtension = ".pdf",
                            Uri = taskTemplate.DescriptionFile,
                            AttachmentType = "Pdf",
                            Size = null,
                            LastModified = DateTime.UtcNow
                        }
                    };
                }
                parameters.Add(new NpgsqlParameter("@_descriptionfile", taskTemplate.DescriptionFile));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_descriptionfile", DBNull.Value));
            }

            parameters.Add(new NpgsqlParameter("@_type", taskTemplate.Type));
            if (taskTemplate.Role != null)
            {
                parameters.Add(new NpgsqlParameter("@_role", taskTemplate.Role));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_role", DBNull.Value));
            }
            if (taskTemplate.Index.HasValue)
            {
                parameters.Add(new NpgsqlParameter("@_index", taskTemplate.Index.Value));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_index", Convert.ToInt32(0))); //default to 0 (zero)
            }

            parameters.Add(new NpgsqlParameter("@_weight", taskTemplate.Weight));
            if (taskTemplate.Video != null)
            {
                parameters.Add(new NpgsqlParameter("@_video", taskTemplate.Video));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_video", DBNull.Value));
            }
            if (taskTemplate.VideoThumbnail != null)
            {
                parameters.Add(new NpgsqlParameter("@_videothumbnail", taskTemplate.VideoThumbnail));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_videothumbnail", DBNull.Value));
            }

            if (taskTemplate.MachineStatus != null)
            {
                parameters.Add(new NpgsqlParameter("@_machinestatus", taskTemplate.MachineStatus));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_machinestatus", DBNull.Value));
            }

            if (taskTemplate.PlannedTime.HasValue)
            {
                parameters.Add(new NpgsqlParameter("@_plannedtime", taskTemplate.PlannedTime.Value));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_plannedtime", DBNull.Value));
            }

            if (taskTemplate.DeepLinkId.HasValue)
            {
                parameters.Add(new NpgsqlParameter("@_deeplinkid", taskTemplate.DeepLinkId.Value));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_deeplinkid", DBNull.Value));
                parameters.Add(new NpgsqlParameter("@_deeplink_configuration", DBNull.Value));
            }

            if (taskTemplate.DeepLinkTo != null)
            {
                parameters.Add(new NpgsqlParameter("@_deeplinkto", taskTemplate.DeepLinkTo));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_deeplinkto", DBNull.Value));
            }

            if (taskTemplate.DeepLinkCompletionIsRequired.HasValue && taskTemplate.DeepLinkId.HasValue && !string.IsNullOrEmpty(taskTemplate.DeepLinkTo))
            {
                parameters.Add(new NpgsqlParameter("@_deeplink_configuration", new DeepLinkConfiguration { DeepLinks = new List<DeepLink> { new DeepLink { DeepLinkId = taskTemplate.DeepLinkId.Value, DeepLinkTo = taskTemplate.DeepLinkTo, IsRequired = taskTemplate.DeepLinkCompletionIsRequired.Value } } }.ToJsonFromObject()));
            }

            parameters.Add(new NpgsqlParameter("@_has_picture_proof", taskTemplate.HasPictureProof));

            if (taskTemplate.Attachments != null && taskTemplate.Attachments.Count > 0)
            {
                parameters.Add(new NpgsqlParameter("@_attachments", taskTemplate.Attachments.ToJsonFromObject()));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_attachments", DBNull.Value));
            }
            return parameters;
        }

        /// <summary>
        /// AppendTagsToTaskTemplatesAsync; append tags to TaskTemplate collection.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="taskTemplates">Collection of TaskTemplate</param>
        /// <returns>Collection of TaskTemplate</returns>
        private async Task<List<TaskTemplate>> AppendTagsToTaskTemplatesAsync(int companyId, List<TaskTemplate> taskTemplates, ConnectionKind connectionKind = ConnectionKind.Reader)
        {
            var allTagsOnTaskTemplates = await _tagManager.GetTagRelationsByObjectTypeAsync(companyId: companyId, objectType: ObjectTypeEnum.TaskTemplate, connectionKind: connectionKind);
            if (allTagsOnTaskTemplates != null)
            {
                foreach (var taskTemplate in taskTemplates)
                {
                    var tagsOnThisTaskTemplate = allTagsOnTaskTemplates.Where(t => t.ObjectId == taskTemplate.Id).ToList();
                    if (tagsOnThisTaskTemplate != null && tagsOnThisTaskTemplate.Count > 0)
                    {
                        taskTemplate.Tags ??= new List<Models.Tags.Tag>();
                        taskTemplate.Tags.AddRange(tagsOnThisTaskTemplate);
                    }

                }
            }

            return taskTemplates;
        }

        /// <summary>
        /// Iterates through tasks templates to replace the name and descriptions with the corresponding tranlslated ones.
        /// </summary>
        /// <param name="companyId"></param>
        /// <param name="auditTemplates"></param>
        /// <param name="language"></param>
        /// <returns></returns>
        private async Task<List<TaskTemplate>> AppendTranslationsToTaskTemplatesAsync(int companyId, List<TaskTemplate> taskTemplates, string language)
        {
            if (string.IsNullOrEmpty(language) || taskTemplates == null || !taskTemplates.Any())
                return taskTemplates;

            foreach (var tasktemplate in taskTemplates)
            {
                var translation = await _translationManager.GetTranslationAsync(
                    tasktemplate.Id,
                    companyId,
                    language,
                    "public.get_tasktemplate_translations",
                    tasktemplate);

            }

            return taskTemplates;
        }

        /// <summary>
        /// AppendTagsToTasksAsync; append tags to TasksTask collection.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="tasks">Collection of TasksTask</param>
        /// <param name="fromTemplates">Get the tags from the templates instead of from the objects</param>
        /// <returns>Collection of TasksTask</returns>
        private async Task<List<TasksTask>> AppendTagsToTasksAsync(int companyId, List<TasksTask> tasks, bool fromTemplates = false)
        {
            ObjectTypeEnum objectType = fromTemplates ? ObjectTypeEnum.TaskTemplate : ObjectTypeEnum.Task;

            var allTagsOnTasks = await _tagManager.GetTagRelationsByObjectTypeAsync(companyId: companyId, objectType: objectType);
            if (allTagsOnTasks != null)
            {
                foreach (var task in tasks)
                {

                    var tagsOnThisTask = allTagsOnTasks.Where(t => t.ObjectId == (fromTemplates ? task.TemplateId : task.Id)).ToList();

                    if (tagsOnThisTask != null && tagsOnThisTask.Count > 0)
                    {
                        task.Tags ??= new List<Models.Tags.Tag>();
                        task.Tags.AddRange(tagsOnThisTask);
                    }

                }
            }

            return tasks;
        }

        /// <summary>
        /// AppendAreaPathsToTaskTemplatesAsync; Add the AreaPath to the TaskTemplate. (used for CMS purposes);
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="tasks">List of taskstemplates.</param>
        /// <returns>Tasks including area full path. </returns>
        private async Task<List<TaskTemplate>> AppendAreaPathsToTaskTemplatesAsync(int companyId, List<TaskTemplate> tasktemplates, bool addAreaPath = true, bool addAreaPathIds = false)
        {

            var areas = await _areaManager.GetAreasAsync(companyId: companyId, maxLevel: 99, useTreeview: false);
            if (areas != null && areas.Count > 0)
            {
                foreach (var tasktemplate in tasktemplates)
                {
                    var area = areas?.Where(x => x.Id == tasktemplate.AreaId)?.FirstOrDefault();
                    if (addAreaPath) tasktemplate.AreaPath = area?.FullDisplayName;
                    if (addAreaPathIds) tasktemplate.AreaPathIds = area?.FullDisplayIds;
                }
            }
            return tasktemplates;
        }

        /// <summary>
        /// AppendStepsToTaskTemplatesAsync; Append tasks to task objects.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="tasks">Collection of tasks.</param>
        /// <returns>The list of tasks, appended with Steps.</returns>
        private async Task<List<TaskTemplate>> AppendStepsToTaskTemplatesAsync(int companyId, List<TaskTemplate> tasktemplates)
        {
            if (tasktemplates == null || tasktemplates.Count == 0)
                return tasktemplates;

            List<int> taskTemplateIds = tasktemplates.Select(t => t.Id).ToList();
            var steps = await GetTaskTemplateStepsAsync(companyId: companyId, taskTemplateIds: taskTemplateIds);
            if (steps != null && steps.Count > 0)
            {
                foreach (var item in tasktemplates)
                {
                    item.Steps = steps.Where(x => x.TaskTemplateId == item.Id).ToList();
                }
            }

            return tasktemplates;
        }

        /// <summary>
        /// AppendRecurrencyToTaskTemplatesAsync; Append recurrencies to templates.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="tasks">List of taskstemplates.</param>
        /// <returns>List of tasktemplates with shifts.</returns>
        private async Task<List<TaskTemplate>> AppendRecurrencyToTaskTemplatesAsync(int companyId, bool includeShifts, List<TaskTemplate> tasktemplates)
        {
            List<TaskRecurrency> recurrencies = await GetTaskRecurrenciesAsync(companyId: companyId, include: includeShifts ? IncludesEnum.RecurrencyShifts.ToString().ToLower() : "");
            if (recurrencies != null && recurrencies.Count > 0)
            {
                foreach (var tasktemplate in tasktemplates)
                {
                    tasktemplate.Recurrency = recurrencies?.Where(x => x.TemplateId == tasktemplate.Id)?.FirstOrDefault();
                }
            }
            return tasktemplates;
        }

        /// <summary>
        /// AppendRecurrencyToTaskTemplateAsync; Append recurrencies to a single template.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="tasks">List of taskstemplates.</param>
        /// <returns>List of tasktemplates with shifts.</returns>
        private async Task<TaskTemplate> AppendRecurrencyToTaskTemplateAsync(int companyId, bool includeShifts, TaskTemplate tasktemplate)
        {
            List<TaskRecurrency> recurrencies = await GetTaskRecurrenciesAsync(companyId: companyId, include: includeShifts ? IncludesEnum.RecurrencyShifts.ToString().ToLower() : "");
            if (recurrencies != null && recurrencies.Count > 0)
            {
                tasktemplate.Recurrency = recurrencies?.Where(x => x.TemplateId == tasktemplate.Id)?.FirstOrDefault();
            }
            return tasktemplate;
        }

        /// <summary>
        /// AppendShiftsToTaskTaskRecurrenciesAsync; Append shifts to recurrencies.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="tasks">List of TasksTemplates.</param>
        /// <returns>List of TaskRecurrency with shifts.</returns>
        private async Task<List<TaskRecurrency>> AppendShiftsToTaskTaskRecurrenciesAsync(int companyId, List<TaskRecurrency> taskrecurrencies)
        {
            List<TaskRecurrencyRelationShift> shifts = await GetShiftRelationsWithTaskRecurrenciesAsync(companyId: companyId);

            if (shifts != null && shifts.Count > 0)
            {
                foreach (var taskrecurrency in taskrecurrencies)
                {
                    taskrecurrency.Shifts = shifts?.Where(x => x.TaskRecurrencyId == taskrecurrency.Id)?.Select(y => y.ShiftId)?.ToList();
                }
            }
            return taskrecurrencies;
        }

        #endregion

        #region - private methods TaskRecurrencies -
        /// <summary>
        /// CreateOrFillTaskRecurrencyFromReader; creates and fills a TaskRecurrency object from a DataReader.
        /// NOTE! intended for use with the action comment stored procedures within the database.
        /// </summary>
        /// <param name="dr">DataReader containing the relevant data.</param>
        /// <param name="taskrecurrency"></param>
        /// <returns></returns>
        private TaskRecurrency CreateOrFillTaskRecurrencyFromReader(NpgsqlDataReader dr, TaskRecurrency taskrecurrency = null)
        {
            if (taskrecurrency == null) taskrecurrency = new TaskRecurrency();

            taskrecurrency.Id = Convert.ToInt32(dr["id"]);
            taskrecurrency.AreaId = Convert.ToInt32(dr["area_id"]);
            taskrecurrency.CompanyId = Convert.ToInt32(dr["company_id"]);
            if (dr["shift_id"] != DBNull.Value)
            {
                taskrecurrency.ShiftId = Convert.ToInt32(dr["shift_id"]);
            }
            taskrecurrency.RecurrencyType = dr["type"].ToString();
            taskrecurrency.TemplateId = Convert.ToInt32(dr["template_id"]);
            var schedule = new Schedule();

            if (dr["date"] != DBNull.Value)
            {
                schedule.Date = Convert.ToDateTime(dr["date"]);
            }
            if (dr["day"] != DBNull.Value)
            {
                schedule.Day = Convert.ToInt32(dr["day"]);
            }
            if (dr["week"] != DBNull.Value)
            {
                schedule.Week = Convert.ToInt32(dr["week"]);
            }
            if (dr["month"] != DBNull.Value)
            {
                schedule.Month = Convert.ToInt32(dr["month"]);
            }
            if (dr["is_once_per_month"] != DBNull.Value)
            {
                schedule.IsOncePerMonth = Convert.ToBoolean(dr["is_once_per_month"]);
            }
            if (dr["is_once_per_week"] != DBNull.Value)
            {
                schedule.IsOncePerWeek = Convert.ToBoolean(dr["is_once_per_week"]);
            }
            if (dr["month_recurrency"] != DBNull.Value)
            {
                schedule.MonthRecurrencyType = dr["month_recurrency"].ToString();
            }
            if (dr["weekday"] != DBNull.Value)
            {
                schedule.WeekDay = Convert.ToInt32(dr["weekday"]);
            }
            if (dr["weekday_number"] != DBNull.Value)
            {
                schedule.WeekDayNumber = Convert.ToInt32(dr["weekday_number"]);
            }
            if (dr["weekday0"] != DBNull.Value)
            {
                schedule.Weekday0 = Convert.ToBoolean(dr["weekday0"]);
            }
            if (dr["weekday1"] != DBNull.Value)
            {
                schedule.Weekday1 = Convert.ToBoolean(dr["weekday1"]);
            }
            if (dr["weekday2"] != DBNull.Value)
            {
                schedule.Weekday2 = Convert.ToBoolean(dr["weekday2"]);
            }
            if (dr["weekday3"] != DBNull.Value)
            {
                schedule.Weekday3 = Convert.ToBoolean(dr["weekday3"]);
            }
            if (dr["weekday4"] != DBNull.Value)
            {
                schedule.Weekday4 = Convert.ToBoolean(dr["weekday4"]);
            }
            if (dr["weekday5"] != DBNull.Value)
            {
                schedule.Weekday5 = Convert.ToBoolean(dr["weekday5"]);
            }
            if (dr["weekday6"] != DBNull.Value)
            {
                schedule.Weekday6 = Convert.ToBoolean(dr["weekday6"]);
            }
            if (dr["start_date"] != DBNull.Value)
            {
                schedule.StartDate = Convert.ToDateTime(dr["start_date"]);
            }
            if (dr["end_date"] != DBNull.Value)
            {
                schedule.EndDate = Convert.ToDateTime(dr["end_date"]);
            }
            if (dr.HasColumn("hour") && dr["hour"] != DBNull.Value)
            {
                schedule.Hour = Convert.ToInt32(dr["hour"]);
            }
            if (dr.HasColumn("minute") && dr["minute"] != DBNull.Value)
            {
                schedule.Minute = Convert.ToInt32(dr["minute"]);
            }

            taskrecurrency.Schedule = schedule;

            return taskrecurrency;
        }

        /// <summary>
        /// GetNpgsqlParametersFromTaskRecurrency; Creates a list of NpgsqlParameters, and fills it based on the supplied TaskRecurrency object.
        /// NOTE! intended for use with the action stored procedures within the database.
        /// </summary>
        /// <param name="taskRecurrency">TaskRecurrency containing all information.</param>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="taskRecurrencyId">TaskRecurrencyId (DB: tasks_tasktemplaterecurrency.id)</param>
        /// <returns>List of NpgsqlParameter</returns>
        private List<NpgsqlParameter> GetNpgsqlParametersFromTaskRecurrency(TaskRecurrency taskRecurrency, int companyId, int taskRecurrencyId = 0)
        {
            List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
            if (taskRecurrencyId > 0) parameters.Add(new NpgsqlParameter("@_id", taskRecurrencyId));
            parameters.Add(new NpgsqlParameter("@_companyid", companyId));
            parameters.Add(new NpgsqlParameter("@_type", taskRecurrency.RecurrencyType));

            if (taskRecurrency.Schedule != null && taskRecurrency.Schedule.Date.HasValue)
            {
                var dateParameter = new NpgsqlParameter("@_date", DbType.Date);
                dateParameter.Value = taskRecurrency.Schedule.Date;
                parameters.Add(dateParameter);
                //parameters.Add(new NpgsqlParameter("@_date", taskRecurrency.Schedule.Date));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_date", DBNull.Value));
            }
            if (taskRecurrency.Schedule != null && taskRecurrency.Schedule.Week.HasValue)
            {
                parameters.Add(new NpgsqlParameter("@_week", taskRecurrency.Schedule.Week));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_week", DBNull.Value));
            }
            if (taskRecurrency.Schedule != null && taskRecurrency.Schedule.Day.HasValue)
            {
                parameters.Add(new NpgsqlParameter("@_day", taskRecurrency.Schedule.Day));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_day", DBNull.Value));
            }
            if (taskRecurrency.Schedule != null && taskRecurrency.Schedule.Month.HasValue)
            {
                parameters.Add(new NpgsqlParameter("@_month", taskRecurrency.Schedule.Month));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_month", DBNull.Value));
            }

            if (taskRecurrency.ShiftId.HasValue)
            {
                parameters.Add(new NpgsqlParameter("@_shiftid", taskRecurrency.ShiftId));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_shiftid", DBNull.Value));
            }
            parameters.Add(new NpgsqlParameter("@_templateid", taskRecurrency.TemplateId));
            parameters.Add(new NpgsqlParameter("@_areaid", taskRecurrency.AreaId));
            if (taskRecurrency.Schedule != null && taskRecurrency.Schedule.EndDate.HasValue)
            {
                var dateParameter = new NpgsqlParameter("@_enddate", DbType.Date);
                dateParameter.Value = taskRecurrency.Schedule.EndDate.Value.Date;
                parameters.Add(dateParameter);
                //parameters.Add(new NpgsqlParameter("@_enddate", taskRecurrency.Schedule.EndDate));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_enddate", DBNull.Value));
            }
            if (taskRecurrency.Schedule != null && taskRecurrency.Schedule.StartDate.HasValue)
            {
                var startDateParameter = new NpgsqlParameter("@_startdate", DbType.Date);
                startDateParameter.Value = taskRecurrency.Schedule.StartDate.Value.Date;
                parameters.Add(startDateParameter);
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_startdate", DBNull.Value));
            }
            if (taskRecurrency.Schedule != null && taskRecurrency.Schedule.Weekday0.HasValue)
            {
                parameters.Add(new NpgsqlParameter("@_weekday0", taskRecurrency.Schedule.Weekday0));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_weekday0", DBNull.Value));
            }
            if (taskRecurrency.Schedule != null && taskRecurrency.Schedule.Weekday1.HasValue)
            {
                parameters.Add(new NpgsqlParameter("@_weekday1", taskRecurrency.Schedule.Weekday1));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_weekday1", DBNull.Value));
            }
            if (taskRecurrency.Schedule != null && taskRecurrency.Schedule.Weekday2.HasValue)
            {
                parameters.Add(new NpgsqlParameter("@_weekday2", taskRecurrency.Schedule.Weekday2));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_weekday2", DBNull.Value));
            }
            if (taskRecurrency.Schedule != null && taskRecurrency.Schedule.Weekday3.HasValue)
            {
                parameters.Add(new NpgsqlParameter("@_weekday3", taskRecurrency.Schedule.Weekday3));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_weekday3", DBNull.Value));
            }
            if (taskRecurrency.Schedule != null && taskRecurrency.Schedule.Weekday4.HasValue)
            {
                parameters.Add(new NpgsqlParameter("@_weekday4", taskRecurrency.Schedule.Weekday4));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_weekday4", DBNull.Value));
            }
            if (taskRecurrency.Schedule != null && taskRecurrency.Schedule.Weekday5.HasValue)
            {
                parameters.Add(new NpgsqlParameter("@_weekday5", taskRecurrency.Schedule.Weekday5));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_weekday5", DBNull.Value));
            }
            if (taskRecurrency.Schedule != null && taskRecurrency.Schedule.Weekday6.HasValue)
            {
                parameters.Add(new NpgsqlParameter("@_weekday6", taskRecurrency.Schedule.Weekday6));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_weekday6", DBNull.Value));
            }
            if (taskRecurrency.Schedule != null && !string.IsNullOrEmpty(taskRecurrency.Schedule.MonthRecurrencyType))
            {
                parameters.Add(new NpgsqlParameter("@_monthrecurrency", taskRecurrency.Schedule.MonthRecurrencyType));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_monthrecurrency", DBNull.Value));
            }
            if (taskRecurrency.Schedule != null && taskRecurrency.Schedule.WeekDay.HasValue)
            {
                parameters.Add(new NpgsqlParameter("@_weekday", taskRecurrency.Schedule.WeekDay));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_weekday", DBNull.Value));
            }
            if (taskRecurrency.Schedule != null && taskRecurrency.Schedule.WeekDayNumber.HasValue)
            {
                parameters.Add(new NpgsqlParameter("@_weekdaynumber", taskRecurrency.Schedule.WeekDayNumber));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_weekdaynumber", DBNull.Value));
            }
            if (taskRecurrency.Schedule != null && taskRecurrency.Schedule.IsOncePerMonth.HasValue)
            {
                parameters.Add(new NpgsqlParameter("@_isoncepermonth", taskRecurrency.Schedule.IsOncePerMonth));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_isoncepermonth", DBNull.Value));
            }
            if (taskRecurrency.Schedule != null && taskRecurrency.Schedule.IsOncePerWeek.HasValue)
            {
                parameters.Add(new NpgsqlParameter("@_isonceperweek", taskRecurrency.Schedule.IsOncePerWeek));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_isonceperweek", DBNull.Value));
            }
            if (taskRecurrency.Schedule != null && taskRecurrency.LastSignedAt.HasValue)
            {
                var dateParameter = new NpgsqlParameter("@_lastsignedat", DbType.Date);
                dateParameter.Value = taskRecurrency.LastSignedAt.Value.Date;
                parameters.Add(dateParameter);
                //parameters.Add(new NpgsqlParameter("@_lastsignedat", taskRecurrency.LastSignedAt));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_lastsignedat", DBNull.Value));
            }

            return parameters;
        }

        /// <summary>
        /// GetShiftRelationsWithTaskRecurrenciesAsync; Get a list of relation objects for further processing.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <returns>A list of TaskRecurrencyRelationShift objects.</returns>
        private async Task<List<TaskRecurrencyRelationShift>> GetShiftRelationsWithTaskRecurrenciesAsync(int companyId)
        {
            var output = new List<TaskRecurrencyRelationShift>();

            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));

                string sp = "get_recurrency_shift_ids";

                using (dr = await _manager.GetDataReader(sp, commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        TaskRecurrencyRelationShift shiftrelation = new TaskRecurrencyRelationShift();

                        shiftrelation.ShiftId = Convert.ToInt32(dr["shift_id"]);
                        shiftrelation.TaskRecurrencyId = Convert.ToInt32(dr["id"]);

                        output.Add(shiftrelation);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetShiftRelationsWithTaskRecurrenciesAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            return output;
        }

        /// <summary>
        /// GetShiftIdsWithTaskRecurrency; Get taskrecurrencyIds from database for use within other data related methods.
        /// </summary>
        /// <param name="taskRecurrencyId">Id of the recurrency</param>
        /// <returns>A List of IDs</returns>
        private async Task<List<int>> GetShiftIdsWithTaskRecurrency(int companyId, int taskRecurrencyId)
        {
            var output = new List<int>();

            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));
                parameters.Add(new NpgsqlParameter("@_taskrecurrencyid", taskRecurrencyId));

                string sp = "get_recurrency_shift_ids_by_id";

                using (dr = await _manager.GetDataReader(sp, commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        output.Add(Convert.ToInt32(dr["shift_id"]));
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetShiftIdsWithTaskRecurrency(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            return output;
        }

        /// <summary>
        /// AddShiftsToOneTimeOnlyTaskRecurrency; Add shift record to one time only recurrency
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="taskRecurrencyId">TaskRecurrncyId (DB: tasks_taskrecurrency.id)</param>
        /// <param name="shiftIds">ShiftId (company_shifts.id) a list of items that need to be added.</param>
        /// <returns></returns>
        private async Task<bool> AddShiftsToOneTimeOnlyTaskRecurrencyAsync(int companyId, int userId, int taskRecurrencyId, List<int> shiftIds)
        {
            if (taskRecurrencyId > 0)
            {
                var original = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.tasks_taskrecurrency_one_time_shifts.ToString(), Models.Enumerations.TableFields.taskrecurrency_id.ToString(), taskRecurrencyId);

                if (taskRecurrencyId > 0 && shiftIds != null && shiftIds.Any() && shiftIds.Count > 0)
                {
                    //get shifts
                    var ids = await GetShiftIdsWithTaskRecurrency(companyId: companyId, taskRecurrencyId: taskRecurrencyId);
                    //check if there is a difference, if so add all shifts
                    //- if count differs
                    //- if ids contains items that are not in the shift list
                    //- if shift list contains items that are not in the ids list.
                    if (ids == null || ids.Count != shiftIds.Count || ids.Where(x => !shiftIds.Contains(x)).Any() || shiftIds.Where(x => !ids.Contains(x)).Any())
                    {
                        //clear shifts
                        await ClearShiftsFromRecurrency(companyId: companyId, taskRecurrencyId: taskRecurrencyId);
                        //add shifts
                        foreach (var id in shiftIds)
                        {
                            await AddShiftToTaskRecurrencyOneTimeOnly(taskRecurrencyId: taskRecurrencyId, shiftId: id);
                        }
                    }


                }
                else
                {
                    //no shifts selected so remove
                    if (taskRecurrencyId > 0 && ((shiftIds == null) || (shiftIds.Count == 0)))
                    {
                        //clear shifts
                        await ClearShiftsFromRecurrency(companyId: companyId, taskRecurrencyId: taskRecurrencyId);
                    }
                }

                var mutated = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.tasks_taskrecurrency_one_time_shifts.ToString(), Models.Enumerations.TableFields.taskrecurrency_id.ToString(), taskRecurrencyId);
                await _dataAuditing.WriteDataAudit(original: original, mutated: mutated, Models.Enumerations.TableNames.tasks_taskrecurrency_one_time_shifts.ToString(), objectId: taskRecurrencyId, userId: userId, companyId: companyId, description: "Changed recurrency shift relation collection.");


            }

            return false;
        }

        /// <summary>
        /// AddShiftsTaskRecurrency; Add shifts to a recurrency.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="taskRecurrencyId"></param>
        /// <param name="shiftIds"></param>
        /// <returns>true/false depending on outcome.</returns>
        private async Task<bool> AddShiftsToTaskRecurrencyAsync(int companyId, int userId, int taskRecurrencyId, List<int> shiftIds)
        {
            if (taskRecurrencyId > 0)
            {
                var original = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.tasks_taskrecurrency_shifts.ToString(), Models.Enumerations.TableFields.taskrecurrency_id.ToString(), taskRecurrencyId);

                if (taskRecurrencyId > 0 && shiftIds != null && shiftIds.Any())
                {
                    //get shifts
                    var ids = await GetShiftIdsWithTaskRecurrency(companyId: companyId, taskRecurrencyId: taskRecurrencyId);
                    //check if there is a difference, if so add all shifts
                    //- if count differs
                    //- if ids contains items that are not in the shift list
                    //- if shift list contains items that are not in the ids list.
                    if (ids == null || ids.Count != shiftIds.Count || ids.Where(x => !shiftIds.Contains(x)).Any() || shiftIds.Where(x => !ids.Contains(x)).Any())
                    {
                        //clear shifts
                        await ClearShiftsFromRecurrency(companyId: companyId, taskRecurrencyId: taskRecurrencyId);
                        //add shifts
                        foreach (var id in shiftIds)
                        {
                            await AddShiftToTaskRecurrencyShifts(taskRecurrencyId: taskRecurrencyId, shiftId: id);
                        }

                    }
                }

                var mutated = await _manager.GetDataRowAsJson(Models.Enumerations.TableNames.tasks_taskrecurrency_shifts.ToString(), Models.Enumerations.TableFields.taskrecurrency_id.ToString(), taskRecurrencyId);
                await _dataAuditing.WriteDataAudit(original: original, mutated: mutated, Models.Enumerations.TableNames.tasks_taskrecurrency_shifts.ToString(), objectId: taskRecurrencyId, userId: userId, companyId: companyId, description: "Changed recurrency shift relation collection.");

            }

            return false;
        }

        /// <summary>
        /// AddShiftToTaskRecurrencyShifts; Add a shift to a recurrency. Based on type the recurrency_one_time_only_shifts or recurrency_shifts tables will be updated.
        /// </summary>
        /// <param name="taskRecurrencyId">TaskRecurrencyId (DB: tasks_taskrecurrncy.id)</param>
        /// <param name="shiftId">ShiftId (DB: companies_shifts.id)</param>
        /// <returns>true/false depending on outcome.</returns>
        private async Task<bool> AddShiftToTaskRecurrencyShifts(int taskRecurrencyId, int shiftId)
        {
            List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
            parameters.Add(new NpgsqlParameter("@_recurrencyid", taskRecurrencyId));
            parameters.Add(new NpgsqlParameter("@_shiftid", shiftId));
            var rowseffected = await _manager.ExecuteScalarAsync("add_taskrecurrencyshift_shifts", parameters: parameters, commandType: CommandType.StoredProcedure);

            return (Convert.ToInt32(rowseffected) > 0);
        }

        /// <summary>
        /// AddShiftToTaskRecurrencyOneTimeOnly; Add a shift to a recurrency. Based on type the recurrency_one_time_only_shifts or recurrency_shifts tables will be updated.
        /// </summary>
        /// <param name="taskRecurrencyId">TaskRecurrencyId (DB: tasks_taskrecurrncy.id)</param>
        /// <param name="shiftId">ShiftId (DB: companies_shifts.id)</param>
        /// <returns>true/false depending on outcome.</returns>
        private async Task<bool> AddShiftToTaskRecurrencyOneTimeOnly(int taskRecurrencyId, int shiftId)
        {
            List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
            parameters.Add(new NpgsqlParameter("@_recurrencyid", taskRecurrencyId));
            parameters.Add(new NpgsqlParameter("@_shiftid", shiftId));
            var rowseffected = await _manager.ExecuteScalarAsync("add_taskrecurrencyshift_onetimeonly", parameters: parameters, commandType: CommandType.StoredProcedure);

            return (Convert.ToInt32(rowseffected) > 0);
        }

        /// <summary>
        /// ClearShifts; Clear shifts from task recurrency.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="taskRecurrencyId">TaskRecurrencyId (DB: tasks_taskrecurrncy.id)</param>
        /// <returns>true/false depending on outcome.</returns>
        private async Task<bool> ClearShiftsFromRecurrency(int companyId, int taskRecurrencyId)
        {
            List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
            parameters.Add(new NpgsqlParameter("@_companyid", companyId));
            parameters.Add(new NpgsqlParameter("@_recurrencyid", taskRecurrencyId));
            var rowseffected = await _manager.ExecuteScalarAsync("remove_taskrecurrency_shifts", parameters: parameters, commandType: CommandType.StoredProcedure);

            return (Convert.ToInt32(rowseffected) > 0);
        }
        #endregion

        #region - private methods Steps -
        /// <summary>
        /// CreateOrFillStepFromReader; creates and fills a Step object from a DataReader.
        /// NOTE! intended for use with the action comment stored procedures within the database.
        /// </summary>
        /// <param name="dr">DataReader containing the relevant data.</param>
        /// <param name="step">Step object that is going to be filled. If object is not supplied it will be created.</param>
        /// <returns>A filled Step object.</returns>
        private Step CreateOrFillStepFromReader(NpgsqlDataReader dr, Step step = null)
        {
            if (step == null) step = new Step();

            step.Id = Convert.ToInt32(dr["id"]);
            step.TaskTemplateId = Convert.ToInt32(dr["template_id"]);
            if (dr.HasColumn("index"))
            {
                step.Index = Convert.ToInt32(dr["index"]);
            }
            if (dr["picture"] != DBNull.Value && !string.IsNullOrEmpty(dr["picture"].ToString()))
            {
                step.Picture = step.Picture = dr["picture"].ToString();
            }

            if (dr["description"] != DBNull.Value && !string.IsNullOrEmpty(dr["description"].ToString()))
            {
                step.Description = dr["description"].ToString();
            }

            if (dr["video"] != DBNull.Value && !string.IsNullOrEmpty(dr["video"].ToString()))
            {
                step.Video = dr["video"].ToString();
            }

            if (dr["video_thumbnail"] != DBNull.Value && !string.IsNullOrEmpty(dr["video_thumbnail"].ToString()))
            {
                step.VideoThumbnail = dr["video_thumbnail"].ToString();
            }

            return step;
        }


        /// <summary>
        /// GetNpgsqlParametersFromStep; Creates a list of NpgsqlParameters, and fills it based on the supplied step object.
        /// NOTE! intended for use with the step stored procedures within the database.
        /// </summary>
        /// <param name="step">Step containing all information</param>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="stepId">StepId (DB: tasks_tasktemplatestep.id)</param>
        /// <returns></returns>
        private List<NpgsqlParameter> GetNpgsqlParametersFromStep(Step step, int companyId, int stepId = 0)
        {
            List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();


            if (stepId > 0) parameters.Add(new NpgsqlParameter("@_id", stepId));
            //id, index, description, picture, template_id, video, video_thumbnail

            parameters.Add(new NpgsqlParameter("@_index", step.Index));

            if (!string.IsNullOrEmpty(step.Description))
            {
                parameters.Add(new NpgsqlParameter("@_description", step.Description));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_description", DBNull.Value));
            }

            if (!string.IsNullOrEmpty(step.Picture))
            {
                parameters.Add(new NpgsqlParameter("@_picture", step.Picture));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_picture", DBNull.Value));
            }


            parameters.Add(new NpgsqlParameter("@_templateid", step.TaskTemplateId));


            if (!string.IsNullOrEmpty(step.Video))
            {
                parameters.Add(new NpgsqlParameter("@_video", step.Video));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_video", DBNull.Value));
            }

            if (!string.IsNullOrEmpty(step.VideoThumbnail))
            {
                parameters.Add(new NpgsqlParameter("@_videothumbnail", step.VideoThumbnail));
            }
            else
            {
                parameters.Add(new NpgsqlParameter("@_videothumbnail", DBNull.Value));
            }
            parameters.Add(new NpgsqlParameter("@_companyid", companyId));

            return parameters;
        }

        /// <summary>
        /// AddChangeStepsAsync; Add an or change entire collection of steps to an template.
        /// Updates and new steps can be mixed, based on step.id will be determent if its an update or insert.
        /// </summary>
        /// <param name="companyId">CompanyId (companies_company.id DB)</param>
        /// <param name="templateId">TaskTemplateId where the steps need to be added.</param>
        /// <param name="steps">Collection of steps.</param>
        /// <returns>.....</returns>
        private async Task<int> AddChangeStepsAsync(int companyId, int userId, int templateId, List<Step> steps)
        {
            if (steps != null)
            {
                //TODO maybe create method for getting only ids.
                var currentSteps = await GetTaskTemplateStepsByTaskTemplateIdAsync(companyId: companyId, taskTemplateId: templateId); //get current steps in db;
                var stepsids = steps.Select(x => x.Id).ToList();

                if (stepsids == null || stepsids.Count == 0)
                {
                    stepsids.Add(0); //default to 0 to remove all steps.
                }

                //clear all steps that aren't in the current collection anymore.
                if (currentSteps != null && currentSteps.Count > 0)
                {
                    foreach (Step step in currentSteps.Where(x => x.Id > 0 && !stepsids.Contains(x.Id)))
                    {
                        await SetTaskTemplateStepActiveAsync(companyId: companyId, userId: userId, stepId: step.Id, isActive: false);
                    }
                }

                //add new or change all steps that remain.
                foreach (Step step in steps)
                {
                    if (step.Id > 0)
                    {
                        await ChangeTaskTemplateStepAsync(companyId: companyId, userId: userId, stepId: step.Id, step: step);
                    }
                    else
                    {
                        if (step.TaskTemplateId <= 0) step.TaskTemplateId = templateId; //make sure to add the templateid if not supplied with the step
                        await AddTaskTemplateStepAsync(companyId: companyId, userId: userId, step: step);
                    }
                }
            }

            return 0;
        }

        #endregion

        #region - public methods TaskTemplate Properties -

        /// <summary>
        /// AddChangeTaskTemplatePropertiesAsync; Add or change properties with a tasktemplate
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="userId">UserId (DB: profiles_user.id)</param>
        /// <param name="templateId">TemplateId (DB: tasks_tasktemplate.id)</param>
        /// <param name=""></param>
        /// <returns>....</returns>
        public async Task<int> AddChangeTaskTemplatePropertiesAsync(int companyId, int userId, int templateId, List<PropertyTaskTemplate> templateProperties)
        {
            //TODO add output nr (total of mutations)
            if (templateProperties != null)
            {
                //Get all current properties
                var currentProperties = await _propertyValueManager.GetTaskTemplateProperties(companyId: companyId, taskTemplateId: templateId);
                var propIds = templateProperties.Select(x => x.Id).ToList(); //Get all new ids that are coming from templateProperties collection.

                if (currentProperties != null && currentProperties.Count > 0)
                {
                    foreach (var prop in currentProperties.Where(x => x.Id > 0 && !propIds.Contains(x.Id)))
                    {
                        //check all properties against the supplied ids, if not in the supplied ids, start removing them. (set to inactive)
                        await _propertyValueManager.RemoveTaskTemplatePropertyAsync(companyId: companyId, userId: userId, taskTemplatePropertyId: prop.Id);
                    }
                }

                //Add or Change all properties that are supplied.
                foreach (PropertyTaskTemplate taskTemplateProperty in templateProperties)
                {
                    if (taskTemplateProperty.Id > 0)
                    {
                        await ChangeTaskTemplatePropertyAsync(companyId: companyId, userId: userId, taskTemplatePropertyId: taskTemplateProperty.Id, templateproperty: taskTemplateProperty);
                    }
                    else
                    {
                        if (taskTemplateProperty.TaskTemplateId <= 0) taskTemplateProperty.TaskTemplateId = templateId; //make sure to add the templateid if not supplied with the property
                        await AddTaskTemplatePropertyAsync(companyId: companyId, userId: userId, templateproperty: taskTemplateProperty);
                    }
                }

            }

            return 0;
        }

        #endregion

        #region - private methods TaskTemplate Properties -
        /// <summary>
        /// AppendTemplatePropertiesToTasks; Add properties to tasks (based on the template)
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="tasks">List of tasks objects.</param>
        /// <param name="include">Include parameter, comma seperated string, based on the includes enum. Used for including extra data. </param>
        /// <param name="connectionKind">Connection used based on connection kind. If needed connection type can be overruled (e.g. after update or insert, use writer seeing the API is faster than the DB sync).</param>
        /// <returns></returns>
        private async Task<List<TasksTask>> AppendTemplatePropertiesToTasks(int companyId, List<TasksTask> tasks, string include = null, bool? isActive = null, ConnectionKind connectionKind = ConnectionKind.Reader)
        {
            List<int> taskTemplateIds = tasks.Select(t => t.TemplateId).Distinct().ToList();
            var properties = await _propertyValueManager.GetPropertiesTaskTemplatesAsync(companyId: companyId, taskTemplateIds: taskTemplateIds, include: include, connectionKind: connectionKind);
            foreach (var task in tasks)
            {
                if (include.Split(",").Contains(IncludesEnum.PropertyValues.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.Properties.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.PropertyDetails.ToString().ToLower()))
                {
                    task.Properties = properties.Where(x => x.TaskTemplateId == task.TemplateId && PropertySettings.BasicAndSpecificProperties.ToList().Contains(x.PropertyGroupId.Value)).ToList();
                    if (isActive.HasValue && isActive.Value)
                    {
                        task.Properties = task.Properties.Where(p => p.IsActive).ToList();
                    }

                    //filter properties on the ones that are actually filled in or active
                    var uservaluesPropertyIds = task.PropertyUserValues.Select(p => p.PropertyId).ToList();
                    var uservaluesTemplatePropertyIds = task.PropertyUserValues.Select(p => p.TemplatePropertyId).ToList();
                    if (uservaluesPropertyIds != null && uservaluesPropertyIds.Count > 0 && uservaluesTemplatePropertyIds != null && uservaluesTemplatePropertyIds.Count > 0)
                    {
                        task.Properties = task.Properties.Where(p => (uservaluesPropertyIds.Contains(p.PropertyId) && uservaluesTemplatePropertyIds.Contains(p.Id)) || p.IsActive == true).ToList();
                    }
                }

                if (task.Properties != null)
                {
                    foreach (var item in task.Properties)
                    {
                        item.TaskTemplateId = task.TemplateId; //force template id (normally should be filled)
                    }

                    task.Properties = task.Properties.OrderBy(property => property.Index).ToList();
                }
            }

            return tasks;
        }

        /// <summary>
        /// AppendTemplatePropertiesToTaskTemplates; Append template property to task template.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="taskstemplates">TaskTemplates collection.</param>
        /// <param name="include">Include parameter can be used for including extra data, based on includes enum.</param>
        /// <returns>List of TaskTemplate objects.</returns>
        private async Task<List<TaskTemplate>> AppendTemplatePropertiesToTaskTemplates(int companyId, List<TaskTemplate> taskstemplates, string include = null)
        {
            List<int> taskTemplateIds = taskstemplates.Select(t => t.Id).ToList();
            var properties = await _propertyValueManager.GetPropertiesTaskTemplatesAsync(companyId: companyId, taskTemplateIds: taskTemplateIds, include: include);
            foreach (var tasktemplate in taskstemplates)
            {
                if (include.Split(",").Contains(IncludesEnum.PropertyValues.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.Properties.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.PropertyDetails.ToString().ToLower()))
                {
                    tasktemplate.Properties = properties.Where(x => x.TaskTemplateId == tasktemplate.Id && x.IsActive && PropertySettings.BasicAndSpecificProperties.ToList().Contains(x.PropertyGroupId.Value)).ToList();
                }
                foreach (var item in tasktemplate.Properties)
                {
                    item.TaskTemplateId = tasktemplate.Id; //force template id (normally should be filled)
                }
            }

            return taskstemplates;
        }

        /// <summary>
        /// AppendTemplatePropertiesToTaskTemplate; Append template properties to a specific task template.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="taskstemplate">TaskTemplate to be updated.</param>
        /// <param name="include">Include parameter can be used for including extra data, based on includes enum.</param>
        /// <returns>Updated TaskTemplate object.</returns>
        private async Task<TaskTemplate> AppendTemplatePropertiesToTaskTemplate(int companyId, TaskTemplate taskstemplate, string include = null)
        {
            var properties = await _propertyValueManager.GetPropertiesTaskTemplateAsync(companyId: companyId, taskTemplateId: taskstemplate.Id, include: include);
            if (include.Split(",").Contains(IncludesEnum.PropertyValues.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.Properties.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.PropertyDetails.ToString().ToLower()))
            {
                taskstemplate.Properties = properties.Where(x => x.TaskTemplateId == taskstemplate.Id && x.IsActive && PropertySettings.BasicAndSpecificProperties.ToList().Contains(x.PropertyGroupId.Value)).ToList();
            }

            foreach (var item in taskstemplate.Properties)
            {
                item.TaskTemplateId = taskstemplate.Id; //force template id (normally should be filled)
            }

            return taskstemplate;
        }


        /// <summary>
        /// AddTaskTemplatePropertyAsync; Add Tasks Template Property to the database. (DB: tasks_tasktemplate_property)
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="userId">UserId (DB: profiles_user.id)</param>
        /// <param name="templateproperty">TaskTemplate object to be added</param>
        /// <returns>int possible property id</returns>
        private async Task<int> AddTaskTemplatePropertyAsync(int companyId, int userId, PropertyTaskTemplate templateproperty)
        {
            return await _propertyValueManager.AddTaskTemplatePropertyAsync(companyId: companyId, userId: userId, templateProperty: templateproperty);
        }

        /// <summary>
        /// ChangeTaskTemplatePropertyAsync; Change Task Template PRoperties int the database  (DB: tasks_tasktemplate_property)
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="userId">UserId (DB: profiles_user.id)</param>
        /// <param name="taskTemplatePropertyId">TasksTemplatePRopertyId (DB: tasks_tasktemplate_properties.id)</param>
        /// <param name="templateproperty">TaskTemplate Property to be added.</param>
        /// <returns>int updated rows</returns>
        private async Task<int> ChangeTaskTemplatePropertyAsync(int companyId, int userId, int taskTemplatePropertyId, PropertyTaskTemplate templateproperty)
        {
            return await _propertyValueManager.ChangeTaskTemplatePropertyAsync(companyId: companyId, userId: userId, taskTemplatePropertyId: taskTemplatePropertyId, templateProperty: templateproperty); ;
        }
        #endregion

        #region - gen4 TaskFilters -
        /// <summary>
        /// Creates and returns a set of task filters based on the specified parameters.
        /// </summary>
        /// <remarks>This method constructs a <see cref="Gen4TaskFilters"/> object based on the provided
        /// parameters. If <paramref name="statusIds"/> or <paramref name="tagIds"/> are null or empty, the
        /// corresponding filters are not applied. The <paramref name="limit"/> parameter is capped at a predefined
        /// maximum value.</remarks>
        /// <param name="timestamp">The reference timestamp used for filtering tasks.</param>
        /// <param name="timespanType">The type of timespan to apply for filtering tasks. Can be null.</param>
        /// <param name="timespanOffset">The offset, in units of the specified timespan type, to apply. Defaults to 0 if null.</param>
        /// <param name="startTimestamp">The start timestamp for the filtering range. Can be null.</param>
        /// <param name="endTimestamp">The end timestamp for the filtering range. Can be null.</param>
        /// <param name="areaId">The identifier of the area to filter tasks by.</param>
        /// <param name="filtertext">A text string used to filter tasks by matching against task properties.</param>
        /// <param name="statusIds">A comma-separated list of status IDs to filter tasks by. Can be null or empty.</param>
        /// <param name="tagIds">A comma-separated list of tag IDs to filter tasks by. Can be null or empty.</param>
        /// <param name="limit">The maximum number of tasks to return. Defaults to a predefined maximum if null.</param>
        /// <param name="offset">The number of tasks to skip before returning results. Defaults to 0 if null.</param>
        /// <returns>A <see cref="Gen4TaskFilters"/> object containing the specified filtering criteria.</returns>
        public Gen4TaskFilters GetTaskFilters(TaskTimeSpanEnum? timespanType, int? timespanOffset, DateTime? startTimestamp, DateTime? endTimestamp, int areaId, string filtertext, string statusIds, string tagIds, bool? allowDuplicateTaskInstances, int? limit, int? offset)
        {
            Gen4TaskFilters result = new Gen4TaskFilters()
            {
                StartTimestamp = startTimestamp,
                EndTimestamp = endTimestamp,
                Timespan = timespanType,
                TimespanOffset = timespanOffset ?? 0,
                AreaId = areaId,
                FilterText = filtertext,
                Statuses = string.IsNullOrEmpty(statusIds) ? null : statusIds.Split(",").Select(id => (TaskStatusEnum)Convert.ToInt32(id)).ToList<TaskStatusEnum>(),
                TagIds = string.IsNullOrEmpty(tagIds) ? null : tagIds.Split(",").Select(id => Convert.ToInt32(id)).ToArray(),
                Limit = limit ?? ApiSettings.DEFAULT_MAX_NUMBER_OF_TASK_RETURN_ITEMS,
                Offset = offset ?? 0,
                AllowDuplicateTaskInstances = allowDuplicateTaskInstances
            };

            return result;
        }

        #endregion

        #region - gen4 properties -
        /// <summary>
        /// Converts the Properties and PropertyUserValues fields to the new PropertiesGen4 field
        /// The Properties and PropertyUserValues fields will be removed at the end of the conversion
        /// </summary>
        /// <param name="tasks">The complete list of tasks to convert the properties for</param>
        /// <returns>Updated list of TasksTasks</returns>
        private async Task<List<TasksTask>> ReplacePropertiesWithPropertiesGen4(List<TasksTask> tasks, int companyId)
        {
            //List of users is only needed when there are property user values
            List<UserBasic> users = null;
            if (tasks.FindAll(t => t.PropertyUserValues != null).Any())
            {
                users = await _userManager.GetUsersBasicAsync(companyId: companyId);
            }

            foreach (TasksTask task in tasks)
            {
                if (task.Properties != null && task.Properties.Any())
                {
                    task.PropertiesGen4 = task.Properties.ToPropertyDTOList(propertyUserValues: task.PropertyUserValues, userList: users);
                    task.Properties = null;
                    task.PropertyUserValues = null;
                }
            }
            return tasks;
        }
        #endregion

        #region - public methods TaskTemplate Checklist/Audit relations -
        /// <summary>
        /// SetTaskTemplateChecklistTemplateRelation; Set a relation between checklisttemplates and taskstemplates (for checklisttemplate.items)
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="taskTemplateId">TaskTemplateId (DB: tasks_tasktemplate.id)</param>
        /// <param name="checklistTemplateId">ChecklistTemplateId (DB: checklists_checklisttemplate.id)</param>
        /// <returns>true/false depending on outcome.</returns>
        public async Task<bool> SetTaskTemplateChecklistTemplateRelation(int companyId, int taskTemplateId, int checklistTemplateId)
        {
            //"set_tasktemplate_checklistrelation"("_companyid" int4, "_tasktemplateid" int4, "_checklisttemplateid" int4)
            List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
            parameters.Add(new NpgsqlParameter("@_companyid", companyId));
            parameters.Add(new NpgsqlParameter("@_tasktemplateid", taskTemplateId));
            parameters.Add(new NpgsqlParameter("@_checklisttemplateid", checklistTemplateId));
            var rowseffected = await _manager.ExecuteScalarAsync("set_tasktemplate_checklistrelation", parameters: parameters, commandType: CommandType.StoredProcedure);
            return (Convert.ToInt32(rowseffected) > 0);
        }

        /// <summary>
        /// SetTaskTemplateAuditTemplateRelation; Set a relation between audittemplates and tasktemplates (for audittemplate.items)
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="taskTemplateId">TaskTemplateId (DB: tasks_tasktemplate.id)</param>
        /// <param name="auditTemplateId">AuditTemplateId (DB: audits_audittemplate.id)</param>
        /// <returns>true/false depending on outcome.</returns>
        public async Task<bool> SetTaskTemplateAuditTemplateRelation(int companyId, int taskTemplateId, int auditTemplateId)
        {
            //"set_tasktemplate_auditrelation"("_companyid" int4, "_tasktemplateid" int4, "_audittemplateid" int4)
            List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
            parameters.Add(new NpgsqlParameter("@_companyid", companyId));
            parameters.Add(new NpgsqlParameter("@_tasktemplateid", taskTemplateId));
            parameters.Add(new NpgsqlParameter("@_audittemplateid", auditTemplateId));
            var rowseffected = await _manager.ExecuteScalarAsync("set_tasktemplate_auditrelation", parameters: parameters, commandType: CommandType.StoredProcedure);
            return (Convert.ToInt32(rowseffected) > 0);

        }

        #endregion

        #region - Latests -
        /// <summary>
        /// GetLatestTasks; Get latest tasks based on a limit sorded by data.
        /// </summary>
        /// <param name="companyId">CompanyId (DB: companies_company.id)</param>
        /// <param name="limit">Number of items to be returned.</param>
        /// <returns>List of TaskTasks objects.</returns>
        public async Task<List<TasksTask>> GetLatestTasks(int companyId, int limit, int offset = 0, int templateId = 0, string include = null)
        {
            var output = new List<TasksTask>();
            string language = Culture;
            NpgsqlDataReader dr = null;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));
                parameters.Add(new NpgsqlParameter("@_limit", limit));

                parameters.Add(new NpgsqlParameter("@_offset", offset));

                if (templateId > 0)
                {
                    parameters.Add(new NpgsqlParameter("@_templateid", templateId));
                }

                using (dr = await _manager.GetDataReader("get_tasks_latest", commandType: CommandType.StoredProcedure, parameters: parameters))
                {
                    while (await dr.ReadAsync())
                    {
                        var task = CreateOrFillTaskFromReader(dr);
                        output.Add(task);
                    }
                }

            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetLatestTasks(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
            }
            finally
            {
                if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
            }

            if (output.Count > 0)
            {
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.Steps.ToString().ToLower())) output = await AppendStepsTaskAsync(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.PropertyUserValues.ToString().ToLower())) output = await AppendPropertyUserValuesToTasks(tasks: output, companyId: companyId, include: include);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.PropertyValues.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.Properties.ToString().ToLower()) || include.Split(",").Contains(IncludesEnum.PropertyDetails.ToString().ToLower()))) output = await AppendTemplatePropertiesToTasks(tasks: output, companyId: companyId, include: include);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.InstructionRelations.ToString().ToLower())) output = await AppendWorkInstructionRelations(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.PictureProof.ToString().ToLower())) output = await AppendPictureProof(tasks: output, companyId: companyId);
                if (!string.IsNullOrEmpty(include) && (include.Split(",").Contains(IncludesEnum.Language.ToString().ToLower()))) output = await AppendTranslationsToTasksAsync(tasks: output, companyId: companyId, language);

                if (await _generalManager.GetHasAccessToFeatureByCompany(companyId: companyId, featurekey: "TECH_FLATTEN_DATA"))
                {
                    output = await ApplyTemplateVersionToTasks(output, companyId, include);
                }
                //based on task.AreaId so this has to be done after ApplyTemplateVersionToTasks since the AreaId may change based on historic data
                if (!string.IsNullOrEmpty(include) && include.Split(",").Contains(IncludesEnum.AreaPaths.ToString().ToLower())) output = await AppendAreaPathsToTasksAsync(tasks: output, companyId: companyId, addAreaPath: include.Split(",").Contains(IncludesEnum.AreaPaths.ToString().ToLower()), addAreaPathIds: include.Split(",").Contains(IncludesEnum.AreaPathIds.ToString().ToLower()));
            }

            return output;
        }

        /// <summary>
        /// GetTaskTemplatePreviousTaskCountAsync();
        /// </summary>
        /// <param name="companyId"></param>
        /// <param name="taskTemplateId"></param>
        /// <returns></returns>
        public async Task<int> GetTaskTemplatePreviousTaskCountAsync(int companyId, int taskTemplateId)
        {
            int output = 0;

            try
            {
                List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                parameters.Add(new NpgsqlParameter("@_companyid", companyId));
                parameters.Add(new NpgsqlParameter("@_templateid", taskTemplateId));

                output = (int)await _manager.ExecuteScalarAsync("get_tasktemplate_previous_task_count", commandType: CommandType.StoredProcedure, parameters: parameters);
            }
            catch (Exception ex)
            {
                _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetTaskTemplatePreviousTaskCountAsync(): ", ex.Message));

                if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
            }
            finally
            {

            }

            return output;
        }
        #endregion

        #region - WorkInstruction -
        private async Task<List<TaskTemplate>> AppendWorkInstructionRelations(int companyId, List<TaskTemplate> taskTemplates)
        {
            var workInstructionRelations = await GetWorkInstructionRelationsAsync(companyId: companyId); //make retrieval more efficient not based on all
            if (workInstructionRelations != null && workInstructionRelations.Any())
            {
                foreach (var taskTemplate in taskTemplates)
                {
                    var possibleWorkInstructionRelation = workInstructionRelations.Where(x => x.TaskTemplateId == taskTemplate.Id).ToList();
                    if (possibleWorkInstructionRelation != null && possibleWorkInstructionRelation.Any()) taskTemplate.WorkInstructionRelations = possibleWorkInstructionRelation;
                }
            }

            return taskTemplates;
        }

        private async Task<List<TasksTask>> AppendWorkInstructionRelations(int companyId, List<TasksTask> tasks)
        {
            var workInstructionRelations = await GetWorkInstructionRelationsAsync(companyId: companyId); //make retrieval more efficient not based on all
            if (workInstructionRelations != null && workInstructionRelations.Any())
            {
                foreach (var task in tasks)
                {
                    var possibleWorkInstructionRelation = workInstructionRelations.Where(x => x.TaskTemplateId == task.TemplateId).ToList();
                    if (possibleWorkInstructionRelation != null && possibleWorkInstructionRelation.Any()) task.WorkInstructionRelations = possibleWorkInstructionRelation;
                }
            }
            return tasks;
        }

        private async Task<List<TasksTask>> AppendWorkInstructionRelations(int companyId, List<TasksTask> tasks, int? checklistTemplateId)
        {
            var workInstructionRelations = await GetWorkInstructionRelationsAsync(companyId: companyId, checklistTemplateId: checklistTemplateId); //make retrieval more efficient not based on all
            if (workInstructionRelations != null && workInstructionRelations.Any())
            {
                foreach (var task in tasks)
                {
                    var possibleWorkInstructionRelation = workInstructionRelations.Where(x => x.TaskTemplateId == task.TemplateId).ToList();
                    if (possibleWorkInstructionRelation != null && possibleWorkInstructionRelation.Any()) task.WorkInstructionRelations = possibleWorkInstructionRelation;
                }
            }
            return tasks;
        }

        private async Task<List<TasksTask>> AppendWorkInstructionRelations(int companyId, List<TasksTask> tasks, List<int> checklistTemplateIds)
        {
            var workInstructionRelations = await GetWorkInstructionRelationsAsync(companyId: companyId, checklistTemplateIds: checklistTemplateIds); //make retrieval more efficient not based on all
            if (workInstructionRelations != null && workInstructionRelations.Any())
            {
                foreach (var task in tasks)
                {
                    var possibleWorkInstructionRelation = workInstructionRelations.Where(x => x.TaskTemplateId == task.TemplateId).ToList();
                    if (possibleWorkInstructionRelation != null && possibleWorkInstructionRelation.Any()) task.WorkInstructionRelations = possibleWorkInstructionRelation;
                }
            }
            return tasks;
        }

        private async Task<List<TasksTask>> AppendPictureProof(int companyId, List<TasksTask> tasks, ConnectionKind connectionKind = ConnectionKind.Reader)
        {
            NpgsqlDataReader dr = null;
            List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();

            parameters.Add(new NpgsqlParameter("@_companyid", companyId));
            parameters.Add(new NpgsqlParameter("@_taskids", tasks.Select(t => t.Id).ToArray()));

            //get picture proof for companyId and taskId
            using (dr = await _manager.GetDataReader("get_picture_proofs", commandType: CommandType.StoredProcedure, parameters: parameters, connectionKind: connectionKind))
            {
                while (await dr.ReadAsync())
                {
                    var taskId = Convert.ToInt32(dr["task_id"]);

                    var task = tasks.Where(t => t.Id == taskId).FirstOrDefault();
                    if ((task.Status == "todo" || task.Status == "skipped") && task.Score == null)
                    {
                        continue;
                    }
                    task.PictureProof = await CreateOrFillPictureProofFromReader(dr);
                }
            }
            //set pictureproof property of task
            return tasks;
        }
        private async Task<TasksTask> AppendPictureProof(int companyId, TasksTask task)
        {
            NpgsqlDataReader dr = null;
            List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();

            parameters.Add(new NpgsqlParameter("@_companyid", companyId));
            parameters.Add(new NpgsqlParameter("@_taskid", task.Id));

            //get picture proof for companyId and taskId
            using (dr = await _manager.GetDataReader("get_picture_proof", commandType: CommandType.StoredProcedure, parameters: parameters))
            {
                while (await dr.ReadAsync())
                {
                    task.PictureProof = await CreateOrFillPictureProofFromReader(dr);
                }
            }
            //set pictureproof property of task
            return task;
        }
        private async Task<TaskStatusBasic> AppendPictureProof(int companyId, TaskStatusBasic task)
        {
            NpgsqlDataReader dr = null;
            List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();

            parameters.Add(new NpgsqlParameter("@_companyid", companyId));
            parameters.Add(new NpgsqlParameter("@_taskid", task.TaskId));

            //get picture proof for companyId and taskId
            using (dr = await _manager.GetDataReader("get_picture_proof", commandType: CommandType.StoredProcedure, parameters: parameters))
            {
                while (await dr.ReadAsync())
                {
                    task.PictureProof = await CreateOrFillPictureProofFromReader(dr);
                }
            }
            //set pictureproof property of task
            return task;
        }
        private async Task<List<TaskTemplateRelationWorkInstructionTemplate>> GetWorkInstructionRelationsAsync(int companyId, int? taskTemplateId = null, int? auditTemplateId = null, int? checklistTemplateId = null)
        {
            if (companyId > 0)
            {
                //TODO replace
                var output = new List<TaskTemplateRelationWorkInstructionTemplate>();

                NpgsqlDataReader dr = null;

                try
                {
                    //"get_workinstruction_tasktemplate_relations"("_companyid" int4, "_tasktemplateid" int4=0, "_workinstructiontemplateid" int4=0)
                    //"id" int4, "company_id" int4, "workinstruction_template_id" int4, "tasktemplate_id" int4, "index" int4, "name" varchar, "media" text
                    List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                    parameters.Add(new NpgsqlParameter("@_companyid", companyId));
                    if (taskTemplateId.HasValue) parameters.Add(new NpgsqlParameter("@_tasktemplateid", taskTemplateId));

                    string storedProcedure = "get_workinstruction_tasktemplate_relations";

                    //NOTE only for use when retrieving certain data; for use with retrieving for display please make use of functionality within the audittemplate managers.
                    //TODO: optimize, maybe move to specific functionality within audit manager..
                    if (auditTemplateId.HasValue && auditTemplateId.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_audittemplateid", auditTemplateId));
                        storedProcedure = "get_workinstruction_audit_item_relations";
                    }

                    //NOTE only for use when retrieving certain data; for use with retrieving for display please make use of functionality within the checklisttemplate managers.
                    //TODO: optimize, maybe move to specific functionality within checklist manager..
                    if (checklistTemplateId.HasValue && checklistTemplateId.Value > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_checklisttemplateid", checklistTemplateId));
                        storedProcedure = "get_workinstruction_checklist_item_relations";
                    }


                    using (dr = await _manager.GetDataReader(storedProcedure, commandType: CommandType.StoredProcedure, parameters: parameters))
                    {
                        while (await dr.ReadAsync())
                        {
                            var item = new TaskTemplateRelationWorkInstructionTemplate();

                            item.Id = Convert.ToInt32(dr["id"]);
                            item.Name = dr["name"].ToString();
                            item.Index = Convert.ToInt32(dr["index"]);
                            item.TaskTemplateId = Convert.ToInt32(dr["tasktemplate_id"]);
                            item.WorkInstructionTemplateId = Convert.ToInt32(dr["workinstruction_template_id"]);

                            if (dr.HasColumn("media") && dr["media"] != DBNull.Value && !string.IsNullOrEmpty(dr["media"].ToString()))
                            {
                                if (dr["media"].ToString().Contains("[") || dr["media"].ToString().Contains("{")) //make sure it contains json
                                {
                                    var list = dr["media"].ToString().ToObjectFromJson<List<string>>();
                                    if (list != null)
                                    {
                                        item.Media = list;
                                    }
                                }
                                else
                                { //if not; handle as single string and add to collection
                                    item.Media = new List<string>();
                                    item.Media.Add(dr["media"].ToString());
                                }
                            }



                            output.Add(item);

                        }
                    }
                }
                catch (Exception ex)
                {
                    _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetWorkInstructionRelationsAsync(): ", ex.Message));

                    if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
                }
                finally
                {
                    if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
                }

                return output;
            }
            return null;
        }
        private async Task<List<TaskTemplateRelationWorkInstructionTemplate>> GetWorkInstructionRelationsAsync(int companyId, List<int> checklistTemplateIds)
        {
            if (companyId > 0)
            {
                //TODO replace
                var output = new List<TaskTemplateRelationWorkInstructionTemplate>();

                NpgsqlDataReader dr = null;

                try
                {
                    //"get_workinstruction_tasktemplate_relations"("_companyid" int4, "_tasktemplateid" int4=0, "_workinstructiontemplateid" int4=0)
                    //"id" int4, "company_id" int4, "workinstruction_template_id" int4, "tasktemplate_id" int4, "index" int4, "name" varchar, "media" text
                    List<NpgsqlParameter> parameters = new List<NpgsqlParameter>();
                    parameters.Add(new NpgsqlParameter("@_companyid", companyId));

                    string storedProcedure = "get_workinstruction_checklisttemplates_relations";

                    if (checklistTemplateIds != null && checklistTemplateIds.Count > 0)
                    {
                        parameters.Add(new NpgsqlParameter("@_checklisttemplateids", checklistTemplateIds));
                    }

                    using (dr = await _manager.GetDataReader(storedProcedure, commandType: CommandType.StoredProcedure, parameters: parameters))
                    {
                        while (await dr.ReadAsync())
                        {
                            var item = new TaskTemplateRelationWorkInstructionTemplate();

                            item.Id = Convert.ToInt32(dr["id"]);
                            item.Name = dr["name"].ToString();
                            item.Index = Convert.ToInt32(dr["index"]);
                            item.TaskTemplateId = Convert.ToInt32(dr["tasktemplate_id"]);
                            item.WorkInstructionTemplateId = Convert.ToInt32(dr["workinstruction_template_id"]);

                            if (dr.HasColumn("media") && dr["media"] != DBNull.Value && !string.IsNullOrEmpty(dr["media"].ToString()))
                            {
                                if (dr["media"].ToString().Contains("[") || dr["media"].ToString().Contains("{")) //make sure it contains json
                                {
                                    var list = dr["media"].ToString().ToObjectFromJson<List<string>>();
                                    if (list != null)
                                    {
                                        item.Media = list;
                                    }
                                }
                                else
                                { //if not; handle as single string and add to collection
                                    item.Media = new List<string>();
                                    item.Media.Add(dr["media"].ToString());
                                }
                            }



                            output.Add(item);

                        }
                    }
                }
                catch (Exception ex)
                {
                    _logger.LogError(exception: ex, message: string.Concat("TaskManager.GetWorkInstructionRelationsAsync(): ", ex.Message));

                    if (_configurationHelper.GetValueAsBool(ApiSettings.ENABLE_ELASTIC_SEARCH_IN_LOGIC_TRACE_CONFIG_KEY)) this.Exceptions.Add(ex);
                }
                finally
                {
                    if (dr != null) { if (!dr.IsClosed) await dr.CloseAsync(); await dr.DisposeAsync(); }
                }

                return output;
            }
            return null;
        }

        private async Task<List<WorkInstructionTemplate>> GetWorkInstructionsByTaskTemplateIdAsync(int companyId, int taskTemplateId)
        {
            if (companyId > 0 && taskTemplateId > 0)
            {
                var workInstructionRelations = await GetWorkInstructionRelationsAsync(companyId: companyId, taskTemplateId: taskTemplateId);

                if (workInstructionRelations != null && workInstructionRelations.Any())
                {
                    var output = new List<WorkInstructionTemplate>();
                    //TODO replace functionality with more efficient setting. 

                    foreach (var workInstructionRelation in workInstructionRelations)
                    {
                        var workInstructionTemplate = await _workInstructionManager.GetWorkInstructionTemplateAsync(companyId: companyId, workInstructionTemplateId: workInstructionRelation.WorkInstructionTemplateId, include: "items");
                        if (workInstructionTemplate.Id > 0)
                        {
                            output.Add(workInstructionTemplate);
                        }
                    }

                    return output;
                }
            }
            return null;
        }

        private async Task<PictureProof> CreateOrFillPictureProofFromReader(NpgsqlDataReader dr)
        {
            var taskId = Convert.ToInt32(dr["task_id"]);

            var pictureProof = new PictureProof();

            pictureProof.Id = Convert.ToInt32(dr["id"]);
            pictureProof.Description = dr["description"].ToString();
            DateTime pictureProofDateTime = Convert.ToDateTime(dr["proof_taken_utc"]);
            pictureProof.ProofTakenUtc = DateTime.SpecifyKind(pictureProofDateTime, DateTimeKind.Utc);
            pictureProof.ProofTakenByUserId = Convert.ToInt32(dr["proof_taken_by_userid"]);
            pictureProof.CreatedAt = Convert.ToDateTime(dr["created_at"]);
            pictureProof.ModifiedAt = Convert.ToDateTime(dr["modified_at"]);
            pictureProof.Media = Convert.ToString(dr["media"]).ToObjectFromJson<List<PictureProofMedia>>();
            foreach (var pictureProofMedia in pictureProof.Media)
            {
                pictureProofMedia.PictureTakenUtc = DateTime.SpecifyKind(pictureProofMedia.PictureTakenUtc, DateTimeKind.Utc);
            }

            await Task.CompletedTask;

            return pictureProof;
        }

        private async Task<int> AddChangeWorkInstructionRelationsAsync(int companyId, int userId, int templateId, List<TaskTemplateRelationWorkInstructionTemplate> templateWorkInstructionRelations, int? checklistTemplateId = null, int? auditTemplateId = null)
        {

            if (templateId > 0)
            {
                string table = Models.Enumerations.TableNames.workinstruction_template_tasktemplate.ToString();
                string relationtype = "tasktemplate";

                if (checklistTemplateId.HasValue)
                {
                    table = Models.Enumerations.TableNames.workinstruction_template_checklisttemplate_item.ToString();
                    relationtype = "checklisttemplate item";
                }

                if (auditTemplateId.HasValue)
                {
                    table = Models.Enumerations.TableNames.workinstruction_template_audittemplate_item.ToString();
                    relationtype = "audittemplate item";
                }

                var original = await _manager.GetDataRowAsJson(table, Models.Enumerations.TableFields.tasktemplate_id.ToString(), templateId);


                //TODO add output nr (total of mutations)
                if (templateWorkInstructionRelations != null)
                {
                    var currentTemplateWorkInstructions = await GetWorkInstructionRelationsAsync(companyId: companyId, taskTemplateId: templateId, auditTemplateId: auditTemplateId, checklistTemplateId: checklistTemplateId);
                    var ids = templateWorkInstructionRelations.Select(x => x.Id).ToList();
                    if (currentTemplateWorkInstructions != null && currentTemplateWorkInstructions.Count > 0)
                    {
                        foreach (var instructionRelation in currentTemplateWorkInstructions.Where(x => x.Id > 0 && !ids.Contains(x.Id)))
                        {
                            await _workInstructionManager.RemoveTaskTemplateWorkInstructionRelation(companyId: companyId, taskTemplateWorkInstructionRelationId: instructionRelation.Id, taskTemplateId: templateId, auditTemplateId: auditTemplateId, checklistTemplateId: checklistTemplateId);
                        }
                    }

                    foreach (var instructionRelation in templateWorkInstructionRelations)
                    {
                        if (instructionRelation.Id > 0)
                        {
                            await _workInstructionManager.ChangeTaskTemplateWorkInstructionRelationAsync(companyId: companyId, userId: userId, workInstructionRelationId: instructionRelation.Id, workInstructionRelation: instructionRelation);
                        }
                        else
                        {
                            if (instructionRelation.TaskTemplateId <= 0) instructionRelation.TaskTemplateId = templateId;
                            if (instructionRelation.ChecklistTemplateId <= 0 && checklistTemplateId.HasValue) instructionRelation.ChecklistTemplateId = checklistTemplateId.Value;
                            if (instructionRelation.AuditTemplateId <= 0 && auditTemplateId.HasValue) instructionRelation.AuditTemplateId = auditTemplateId.Value;

                            await _workInstructionManager.AddTaskTemplateWorkInstructionRelationAsync(companyId: companyId, userId: userId, workInstructionRelation: instructionRelation);

                        }
                    }
                }

                var mutated = await _manager.GetDataRowAsJson(table, Models.Enumerations.TableFields.tasktemplate_id.ToString(), templateId);
                await _dataAuditing.WriteDataAudit(original: original, mutated: mutated, table, objectId: templateId, userId: userId, companyId: companyId, description: string.Concat("Changed ", relationtype, " workinstructiontemplate relation collection."));

            }


            return 0;
        }
        #endregion

        #region - backwards compatibility methods -
        /// <summary>
        /// ForceBackwardCompatibilityForTemplate; Force default settings for backwards compatibility. It will add extra (incorrect!) data to the database.
        /// This is needed for the whyllow IOS app and the older management portals.
        /// </summary>
        /// <param name="template">TaskTemplate object to be converted</param>
        /// <returns>Updated TaskTemplate object.</returns>
        public async Task<TaskTemplate> ForceBackwardCompatibilityForTemplate(TaskTemplate template)
        {
            if (template.Recurrency != null)
            {
                template.Recurrency = await ForceBackwardCompatibilityForRecurrency(template.Recurrency);
            }

            if (string.IsNullOrEmpty(template.MachineStatus)) template.MachineStatus = MachineStatusTypeEnum.NotApplicable.ToDatabaseString();
            if (string.IsNullOrEmpty(template.Role)) template.Role = RoleTypeEnum.Basic.ToDatabaseString();

            await Task.CompletedTask;

            return template;
        }

        /// <summary>
        /// ForceBackwardCompatibilityForRecurrency; Force default settings for backwards compatibility. It will add extra (incorrect!) data to the database.
        /// This is needed for the whyllow IOS app and the older management portals.
        /// </summary>
        /// <param name="recurrency">TaskRecurrency object to be converted</param>
        /// <returns>Updated TaskRecurrency object.</returns>
        public async Task<TaskRecurrency> ForceBackwardCompatibilityForRecurrency(TaskRecurrency recurrency)
        {
            if (recurrency.Schedule != null)
            {
                if (!recurrency.Schedule.Day.HasValue) recurrency.Schedule.Day = 1;
                if (!recurrency.Schedule.Week.HasValue) recurrency.Schedule.Week = 1;
                if (!recurrency.Schedule.Month.HasValue) recurrency.Schedule.Month = 1;
                if (!recurrency.Schedule.WeekDay.HasValue && recurrency.Schedule.MonthRecurrencyType == MonthRecurrencyTypeEnum.DayOfMonth.ToDatabaseString()) recurrency.Schedule.WeekDay = 1;
                if (!recurrency.Schedule.WeekDayNumber.HasValue && recurrency.Schedule.MonthRecurrencyType == MonthRecurrencyTypeEnum.DayOfMonth.ToDatabaseString()) recurrency.Schedule.WeekDayNumber = 1;
                if (!recurrency.Schedule.IsOncePerMonth.HasValue) recurrency.Schedule.IsOncePerMonth = false;
                if (!recurrency.Schedule.IsOncePerWeek.HasValue) recurrency.Schedule.IsOncePerWeek = false;
                if (!recurrency.Schedule.Weekday0.HasValue) recurrency.Schedule.Weekday0 = false;
                if (!recurrency.Schedule.Weekday1.HasValue) recurrency.Schedule.Weekday1 = false;
                if (!recurrency.Schedule.Weekday2.HasValue) recurrency.Schedule.Weekday2 = false;
                if (!recurrency.Schedule.Weekday3.HasValue) recurrency.Schedule.Weekday3 = false;
                if (!recurrency.Schedule.Weekday4.HasValue) recurrency.Schedule.Weekday4 = false;
                if (!recurrency.Schedule.Weekday5.HasValue) recurrency.Schedule.Weekday5 = false;
                if (!recurrency.Schedule.Weekday6.HasValue) recurrency.Schedule.Weekday6 = false;
            }
            await Task.CompletedTask;

            return recurrency;
        }
        #endregion

        #region - logging / error handling -
        public new List<Exception> GetPossibleExceptions()
        {
            var listEx = new List<Exception>();
            try
            {
                listEx.AddRange(this.Exceptions);
                listEx.AddRange(_actionManager.GetPossibleExceptions());
                listEx.AddRange(_areaManager.GetPossibleExceptions());
                listEx.AddRange(_userAccessManager.GetPossibleExceptions());
                listEx.AddRange(_propertyValueManager.GetPossibleExceptions());
                listEx.AddRange(_workInstructionManager.GetPossibleExceptions());
                listEx.AddRange(_tagManager.GetPossibleExceptions());
                listEx.AddRange(_userManager.GetPossibleExceptions());
                listEx.AddRange(_generalManager.GetPossibleExceptions());
                listEx.AddRange(_flattenTaskManager.GetPossibleExceptions());
                listEx.AddRange(_shiftManager.GetPossibleExceptions());
            }
            catch (Exception ex)
            {
                //error occurs with errors, return only this error
                listEx.Add(ex);
            }
            return listEx;
        }
        #endregion

    }
}
